var Se=Object.defineProperty;var Me=(r,t,e)=>t in r?Se(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var m=(r,t,e)=>Me(r,typeof t!="symbol"?t+"":t,e);import*as a from"three";import{GLTFLoader as xe}from"three/addons/loaders/GLTFLoader.js";import{dyno as w,SparkRenderer as ke,SplatMesh as Pe}from"@sparkjsdev/spark";import{VRButton as Ce}from"three/addons/webxr/VRButton.js";import{XRControllerModelFactory as Te}from"three/addons/webxr/XRControllerModelFactory.js";import{XRHandModelFactory as Re}from"three/addons/webxr/XRHandModelFactory.js";import{OrbitControls as Ee}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as Ie,CSS2DObject as Ae}from"three/addons/renderers/CSS2DRenderer.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class Fe{constructor(t,e){this.camera=t,this.domElement=e,this.target=new a.Vector3,this.yaw=0,this.pitch=0,this.distance=5,this.minDistance=1,this.maxDistance=10,this.enableDamping=!0,this.dampingFactor=.1,this.targetYaw=0,this.targetPitch=0,this.targetDistance=5,this.maxPolarAngle=Math.PI,this.minPolarAngle=0,this.enablePan=!1,this.enabled=!0,this.isRotating=!1,this.isZooming=!1,this.mouseStart=new a.Vector2,this.mouseCurrent=new a.Vector2,this.rotateSpeed=1,this.zoomSpeed=1,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onWheel=this.onWheel.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.domElement.addEventListener("mousedown",this.onMouseDown),this.domElement.addEventListener("wheel",this.onWheel),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.syncFromCamera()}syncFromCamera(){const t=new a.Vector3().subVectors(this.camera.position,this.target);this.distance=t.length(),this.targetDistance=this.distance;const e=Math.sqrt(t.x*t.x+t.z*t.z);this.yaw=Math.atan2(t.x,t.z),this.pitch=Math.atan2(e,t.y),this.targetYaw=this.yaw,this.targetPitch=this.pitch}rotateLeft(t){this.targetYaw+=t}rotateUp(t){this.targetPitch-=t,this.targetPitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this.targetPitch))}dolly(t){t<0?this.targetDistance/=Math.pow(.95,this.zoomSpeed):t>0&&(this.targetDistance*=Math.pow(.95,this.zoomSpeed)),this.targetDistance=Math.max(this.minDistance,Math.min(this.maxDistance,this.targetDistance))}onMouseDown(t){this.enabled&&t.button===0&&(this.isRotating=!0,this.mouseStart.set(t.clientX,t.clientY),this.mouseCurrent.set(t.clientX,t.clientY),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp))}onMouseMove(t){if(this.isRotating){this.mouseCurrent.set(t.clientX,t.clientY);const e=this.mouseCurrent.x-this.mouseStart.x,i=this.mouseCurrent.y-this.mouseStart.y,s=2*Math.PI*e/this.domElement.clientHeight*this.rotateSpeed,o=2*Math.PI*i/this.domElement.clientHeight*this.rotateSpeed;this.rotateLeft(-s),this.rotateUp(-o),this.mouseStart.copy(this.mouseCurrent)}}onMouseUp(t){t.button===0&&(this.isRotating=!1,document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp))}onWheel(t){this.enabled&&(t.preventDefault(),this.dolly(t.deltaY))}onContextMenu(t){t.preventDefault()}update(){this.enableDamping?(this.yaw+=(this.targetYaw-this.yaw)*this.dampingFactor,this.pitch+=(this.targetPitch-this.pitch)*this.dampingFactor,this.distance+=(this.targetDistance-this.distance)*this.dampingFactor):(this.yaw=this.targetYaw,this.pitch=this.targetPitch,this.distance=this.targetDistance);const t=new a.Vector3(this.distance*Math.sin(this.pitch)*Math.sin(this.yaw),this.distance*Math.cos(this.pitch),this.distance*Math.sin(this.pitch)*Math.cos(this.yaw));return this.camera.position.copy(this.target).add(t),this.camera.lookAt(this.target),!0}getAzimuthalAngle(){return this.yaw}getPolarAngle(){return this.pitch}dispose(){this.domElement.removeEventListener("mousedown",this.onMouseDown),this.domElement.removeEventListener("wheel",this.onWheel),this.domElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}reset(){this.yaw=0,this.pitch=Math.PI/4,this.distance=5,this.targetYaw=this.yaw,this.targetPitch=this.pitch,this.targetDistance=this.distance}saveState(){this.savedYaw=this.yaw,this.savedPitch=this.pitch,this.savedDistance=this.distance}}const xt="w",ht="a",bt="s",dt="d",Bt="shift",Dt=" ",$t="p";class De{constructor(t=!1){m(this,"map",new Map);console.log("KeyDisplay: isMobile =",t);const e=this.createKeyDiv(xt,t),i=this.createKeyDiv(ht,t),s=this.createKeyDiv(bt,t),o=this.createKeyDiv(dt,t),n=this.createKeyDiv(Bt,t),l=this.createKeyDiv("SPACE",t),c=this.createKeyDiv($t,t);this.map.set(xt,e),this.map.set(ht,i),this.map.set(bt,s),this.map.set(dt,o),this.map.set(Bt,n),this.map.set(Dt,l),this.map.set($t,c),document.body.appendChild(e),document.body.appendChild(i),document.body.appendChild(s),document.body.appendChild(o),document.body.appendChild(n),document.body.appendChild(l),document.body.appendChild(c),this.updatePosition()}createKeyDiv(t,e=!1){const i=document.createElement("div");return i.style.position="absolute",i.style.padding="8px 12px",i.style.minWidth="40px",i.style.textAlign="center",i.style.fontFamily="'Courier New', monospace",i.style.fontSize="16px",i.style.fontWeight="bold",i.style.color="#333",i.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",i.style.border="1px solid #999",i.style.borderRadius="4px",i.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",i.style.transition="all 0.1s ease",i.style.userSelect="none",i.style.opacity="0.6",i.textContent=t.toUpperCase(),e&&(i.style.display="none"),i}updatePosition(){this.map.get(xt).style.top=`${window.innerHeight-80-45}px`,this.map.get(xt).style.left="168px",this.map.get(ht).style.top=`${window.innerHeight-80}px`,this.map.get(ht).style.left="100px",this.map.get(bt).style.top=`${window.innerHeight-80}px`,this.map.get(bt).style.left="168px",this.map.get(dt).style.top=`${window.innerHeight-80}px`,this.map.get(dt).style.left=`${100+68*2}px`,this.map.get(Bt).style.top=`${window.innerHeight-80}px`,this.map.get(Bt).style.left="21px",this.map.get(Dt).style.top=`${window.innerHeight-80}px`,this.map.get(Dt).style.left=`${100+68*3+15}px`,this.map.get($t).style.top=`${window.innerHeight-80}px`,this.map.get($t).style.left=`${100+68*4+15*2}px`}down(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #00ff00, #00cc00)",e.style.color="#000",e.style.boxShadow="0 1px 2px rgba(0,0,0,0.3), inset 0 2px 4px rgba(0,0,0,0.2)",e.style.transform="translateY(2px)",e.style.opacity="1")}up(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",e.style.color="#333",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",e.style.transform="translateY(0)",e.style.opacity="0.6")}}class Le{constructor(t,e,i,s,o,n,l,c=null,d=1){m(this,"currentAction");m(this,"toggleRun",!0);m(this,"walkVelocity",2);m(this,"runVelocity",5);m(this,"jumpForce",8);m(this,"gravity",-20);m(this,"maxFallSpeed",-50);m(this,"jumpCooldownDuration",.3);m(this,"characterHeightOffset",0);m(this,"maxHeight",null);m(this,"verticalVelocity",0);m(this,"isGrounded",!0);m(this,"jumpCooldown",0);m(this,"timeInAir",0);m(this,"airTimeThreshold",.4);m(this,"isJetpackActive",!1);m(this,"jetpackThrust",25);m(this,"jetpackTransitionDuration",.3);m(this,"jetpackTransitionTimer",0);m(this,"inertiaVelocityX",0);m(this,"inertiaVelocityZ",0);m(this,"hasInertia",!1);m(this,"raycaster",new a.Raycaster);m(this,"groundMeshes",[]);m(this,"rayOrigin",new a.Vector3);m(this,"rayDirection",new a.Vector3(0,-1,0));m(this,"forwardRaycaster",new a.Raycaster);m(this,"ceilingRaycaster",new a.Raycaster);m(this,"forwardGroundRaycaster",new a.Raycaster);m(this,"forwardCollisionDistance",.5);m(this,"ceilingCollisionDistance",2.5);m(this,"maxSlopeAngle",Math.PI/3);m(this,"maxStepHeight",.5);m(this,"tempCollisionVector",new a.Vector3);m(this,"tempCollisionNormal",new a.Vector3);m(this,"tempSlideVector",new a.Vector3);m(this,"walkDirection",new a.Vector3);m(this,"rotateAngle",new a.Vector3(0,1,0));m(this,"rotateQuaternion",new a.Quaternion);m(this,"fadeDuration",.2);m(this,"updateCameraTargetOffset",new a.Vector3);m(this,"cameraMode","third-person");m(this,"firstPersonPitch",0);m(this,"firstPersonYaw",0);m(this,"firstPersonHeadHeight",1.6);m(this,"targetOffsetY",1);this.model=t,this.mixer=e,this.animationsMap=i,this.orbitControl=s,this.camera=o,this.currentAction=n,l&&(this.groundMeshes=Array.isArray(l)?l:[l]),this.maxHeight=c,console.log(`[CharacterControls] maxHeight set to: ${this.maxHeight===null?"null (unlimited)":this.maxHeight.toFixed(2)}`),this.targetOffsetY=d,this.animationsMap.forEach((u,f)=>{f===n&&u.play()})}switchRunToggle(){this.toggleRun=!this.toggleRun}getGroundedState(){return this.isGrounded}getCurrentAction(){return this.currentAction}getJetpackActive(){return this.isJetpackActive}getGroundDistance(){const t=this.getGroundInfo();return Math.max(0,this.model.position.y-t.height)}getPosition(){return{x:this.model.position.x,y:this.model.position.y,z:this.model.position.z}}getMovementState(){return this.isJetpackActive&&!this.isGrounded?"jetpack":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?"idle":this.currentAction==="Run"?"run":this.currentAction==="Walk"?"walk":"idle"}setCameraMode(t){this.cameraMode=t,console.log(`CharacterControls: Camera mode set to ${t}`)}setFirstPersonRotation(t,e){this.firstPersonPitch=t,this.firstPersonYaw=e}placeOnGround(){const t=this.getGroundInfo();this.model.position.y=t.height+this.characterHeightOffset,console.log(`Character placed on ground at Y: ${this.model.position.y.toFixed(2)}`)}getGroundInfo(){if(this.groundMeshes.length===0)return{height:0,normal:null};this.rayOrigin.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.raycaster.set(this.rayOrigin,this.rayDirection);const t=this.raycaster.intersectObjects(this.groundMeshes,!0);if(t.length>0){const e=t[0];let i=null;if(e.face&&e.object){i=e.face.normal.clone();const s=new a.Matrix3().getNormalMatrix(e.object.matrixWorld);i.applyMatrix3(s).normalize()}return{height:e.point.y,normal:i}}return{height:-100,normal:null}}checkForwardCollision(t){if(this.groundMeshes.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.forwardRaycaster.set(this.tempCollisionVector,t),this.forwardRaycaster.far=this.forwardCollisionDistance;const e=this.forwardRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0],s=i.face?i.face.normal.clone():new a.Vector3(0,1,0);if(i.object&&i.face){const l=new a.Matrix3().getNormalMatrix(i.object.matrixWorld);s.applyMatrix3(l).normalize()}const o=s.dot(new a.Vector3(0,1,0)),n=o>=.5;return{hit:!0,point:i.point,normal:s,distance:i.distance,isWalkable:n,surfaceAngle:Math.acos(Math.abs(o))*(180/Math.PI)}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}checkCeilingCollision(){if(this.groundMeshes.length===0)return{hit:!1,height:1/0,distance:1/0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y,this.model.position.z);const t=new a.Vector3(0,1,0);this.ceilingRaycaster.set(this.tempCollisionVector,t),this.ceilingRaycaster.far=this.ceilingCollisionDistance;const e=this.ceilingRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0];return{hit:!0,height:i.point.y,distance:i.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardGround(t,e){if(this.groundMeshes.length===0)return{exists:!1,height:-100,normal:null,isWalkable:!1};const i=this.model.position.x+t.x*e,s=this.model.position.z+t.z*e;this.tempCollisionVector.set(i,this.model.position.y+10,s);const o=new a.Vector3(0,-1,0);this.forwardGroundRaycaster.set(this.tempCollisionVector,o);const n=this.forwardGroundRaycaster.intersectObjects(this.groundMeshes,!0);if(n.length>0){const l=n[0],c=l.point.y,d=l.face?l.face.normal:new a.Vector3(0,1,0),u=this.getGroundInfo().height,f=c-u,p=Math.acos(Math.abs(d.y)),x=p<=this.maxSlopeAngle||Math.abs(f)<=this.maxStepHeight;return{exists:!0,height:c,normal:d,isWalkable:x,slopeAngle:p,heightDifference:f}}return{exists:!1,height:-100,normal:null,isWalkable:!1}}update(t,e){if(this.jumpCooldown>0&&(this.jumpCooldown-=t),e[Dt]&&this.isGrounded&&this.jumpCooldown<=0&&(this.verticalVelocity=this.jumpForce,this.isGrounded=!1,this.jumpCooldown=this.jumpCooldownDuration),e[Dt]&&!this.isGrounded&&this.timeInAir>this.airTimeThreshold?(this.isJetpackActive||(this.isJetpackActive=!0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0),this.verticalVelocity+=this.jetpackThrust*t):this.isJetpackActive&&(this.isJetpackActive=!1,this.jetpackTransitionTimer=this.jetpackTransitionDuration,(this.inertiaVelocityX!==0||this.inertiaVelocityZ!==0)&&(this.hasInertia=!0)),this.jetpackTransitionTimer>0){const p=this.jetpackTransitionTimer/this.jetpackTransitionDuration;this.verticalVelocity+=this.jetpackThrust*p*t,this.jetpackTransitionTimer-=t}this.verticalVelocity+=this.gravity*t,this.verticalVelocity<this.maxFallSpeed&&(this.verticalVelocity=this.maxFallSpeed);const i=this.getGroundInfo(),s=i.height,o=this.model.position.y;if(this.model.position.y+=this.verticalVelocity*t,this.verticalVelocity>0){const p=this.checkCeilingCollision();if(p.hit){const x=p.height-this.characterHeightOffset;this.model.position.y>x&&(this.model.position.y=x,this.verticalVelocity=0)}}this.maxHeight!==null&&this.model.position.y>this.maxHeight&&(console.log(`[Height Cap] Enforcing ceiling: position.y=${this.model.position.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),this.model.position.y=this.maxHeight,this.verticalVelocity=0);const l=this.model.position.y-this.characterHeightOffset-s;let c=!0;if(i.normal&&(c=i.normal.dot(new a.Vector3(0,1,0))>=.5),l<=0&&c?(this.model.position.y=s+this.characterHeightOffset,this.verticalVelocity=0,this.isGrounded=!0,this.timeInAir=0,this.isJetpackActive&&(this.isJetpackActive=!1),this.jetpackTransitionTimer=0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0):(this.isGrounded=!1,this.timeInAir+=t),this.cameraMode==="first-person")this.camera.position.y=this.model.position.y+this.firstPersonHeadHeight;else{const p=this.model.position.y-o;this.camera.position.y+=p}const d=Ge.some(p=>e[p]===!0);let u="";if(this.isJetpackActive&&!this.isGrounded?u="TPose":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?u="Idle":d&&this.toggleRun?u="Run":d?u="Walk":u="Idle",this.currentAction!==u){const p=this.animationsMap.get(u),x=this.animationsMap.get(this.currentAction);x&&p&&(x.fadeOut(this.fadeDuration),p.reset().fadeIn(this.fadeDuration).play(),this.currentAction=u)}this.mixer.update(t);const f=this.isGrounded||this.timeInAir<=this.airTimeThreshold;if(this.isJetpackActive&&!d&&(this.inertiaVelocityX=0,this.inertiaVelocityZ=0),d&&(f||this.isJetpackActive)){let p;this.cameraMode==="first-person"?p=this.firstPersonYaw:p=Math.atan2(this.camera.position.x-this.model.position.x,this.camera.position.z-this.model.position.z);const x=this.directionOffset(e);this.rotateQuaternion.setFromAxisAngle(this.rotateAngle,p+x),this.model.quaternion.rotateTowards(this.rotateQuaternion,.2),this.camera.getWorldDirection(this.walkDirection),this.walkDirection.y=0,this.walkDirection.normalize(),this.walkDirection.applyAxisAngle(this.rotateAngle,x);const P=this.toggleRun?this.runVelocity:this.walkVelocity;let v=this.walkDirection.x*P*t,C=this.walkDirection.z*P*t;this.isGrounded||(this.inertiaVelocityX=this.walkDirection.x*P,this.inertiaVelocityZ=this.walkDirection.z*P,this.hasInertia=!0);let V=!1,D=null;if(this.isGrounded){const I=Math.sqrt(v*v+C*C),L=this.checkForwardGround(this.walkDirection,I);L.isWalkable||(V=!0,L.normal?D=L.normal.clone():D=new a.Vector3(-this.walkDirection.x,0,-this.walkDirection.z).normalize())}const R=this.checkForwardCollision(this.walkDirection);if(R.hit||V){let I;R.hit?I=R.normal.clone():I=D.clone(),R.hit&&!R.isWalkable&&(I.y=0,I.normalize());const tt=this.tempSlideVector.set(v,0,C).dot(I);if(tt<0){const K=v-tt*I.x,ut=C-tt*I.z;v=K,C=ut}}this.model.position.x+=v,this.model.position.z+=C,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=v,this.camera.position.z+=C)}else if(this.hasInertia&&!this.isGrounded&&!this.isJetpackActive){let p=this.inertiaVelocityX*t,x=this.inertiaVelocityZ*t;const P=new a.Vector3(this.inertiaVelocityX,0,this.inertiaVelocityZ).normalize(),v=this.checkForwardCollision(P);if(v.hit){const C=v.normal.clone();v.isWalkable||(C.y=0,C.normalize());const D=this.tempSlideVector.set(p,0,x).dot(C);if(D<0){const R=p-D*C.x,I=x-D*C.z;p=R,x=I}}this.model.position.x+=p,this.model.position.z+=x,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=p,this.camera.position.z+=x)}if(this.cameraMode==="first-person"){this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z,this.model.rotation.y=this.firstPersonYaw,this.camera.rotation.order="YXZ",this.camera.rotation.y=this.firstPersonYaw,this.camera.rotation.x=this.firstPersonPitch,this.camera.rotation.z=0;const p=new a.Vector3;this.camera.getWorldDirection(p),this.updateCameraTargetOffset.copy(this.camera.position).add(p),this.orbitControl.target.copy(this.updateCameraTargetOffset)}else{const x=new a.Vector3(0,this.targetOffsetY,0).clone().applyQuaternion(this.model.quaternion);this.updateCameraTargetOffset.x=this.model.position.x+x.x,this.updateCameraTargetOffset.y=this.model.position.y+x.y,this.updateCameraTargetOffset.z=this.model.position.z+x.z,this.orbitControl.target.copy(this.updateCameraTargetOffset)}}directionOffset(t){let e=0;return t[xt]?t[ht]?e=Math.PI/4:t[dt]&&(e=-Math.PI/4):t[bt]?t[ht]?e=Math.PI/4+Math.PI/2:t[dt]?e=-Math.PI/4-Math.PI/2:e=Math.PI:t[ht]?e=Math.PI/2:t[dt]&&(e=-Math.PI/2),e}updateVRPhysics(t,e,i,s,o,n,l,c,d){const u=t.clone();if(c&&(e.y+=this.jetpackThrust*s),d>0){const v=d/this.jetpackTransitionDuration;e.y+=this.jetpackThrust*v*s,d-=s}if(e.y+=this.gravity*s,e.y<this.maxFallSpeed&&(e.y=this.maxFallSpeed),u.y+=e.y*s,e.y>0){const v=this.checkCeilingCollisionAtPosition(u,o);if(v.hit){const C=v.height;u.y>C&&(u.y=C,e.y=0)}}this.maxHeight!==null&&u.y>this.maxHeight&&(console.log(`[Height Cap VR] Enforcing ceiling: position.y=${u.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),u.y=this.maxHeight,e.y=0);const f=this.getGroundInfoAtPosition(u,o),p=f.height;let x=!0;if(f.normal&&(x=f.normal.dot(new a.Vector3(0,1,0))>=.5),u.y-p<=0&&x?(u.y=p,e.y=0,n=!0,l=0,c&&(c=!1),d=0):(n=!1,l+=s),i&&i.lengthSq()>0){let v=i.x,C=i.z;const V=i.clone().normalize(),D=this.checkForwardCollisionAtPosition(u,V,o);if(D.hit){const R=D.normal.clone();D.isWalkable||(R.y=0,R.normalize());const L=new a.Vector3(v,0,C).dot(R);L<0&&(v=v-L*R.x,C=C-L*R.z)}u.x+=v,u.z+=C}return{newPosition:u,velocity:e,isGrounded:n,airTime:l,jetpackActive:c,jetpackTransitionTimer:d}}getGroundInfoAtPosition(t,e){if(!e||e.length===0)return{height:0,normal:null};const i=Math.max(t.y+10,100),s=new a.Vector3(t.x,i,t.z),o=new a.Vector3(0,-1,0),n=new a.Raycaster;n.set(s,o);const l=n.intersectObjects(e,!0);if(l.length>0){const c=l[0];let d=null;if(c.face&&c.object){d=c.face.normal.clone();const u=new a.Matrix3().getNormalMatrix(c.object.matrixWorld);d.applyMatrix3(u).normalize()}return{height:c.point.y,normal:d}}return{height:-100,normal:null}}checkCeilingCollisionAtPosition(t,e){if(!e||e.length===0)return{hit:!1,height:1/0,distance:1/0};const i=new a.Vector3(t.x,t.y+1,t.z),s=new a.Vector3(0,1,0),o=new a.Raycaster;o.set(i,s),o.far=this.ceilingCollisionDistance;const n=o.intersectObjects(e,!0);if(n.length>0){const l=n[0];return{hit:!0,height:l.point.y,distance:l.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardCollisionAtPosition(t,e,i){if(!i||i.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};const s=new a.Vector3(t.x,t.y+1,t.z),o=new a.Raycaster;o.set(s,e),o.far=this.forwardCollisionDistance;const n=o.intersectObjects(i,!0);if(n.length>0){const l=n[0],c=l.face?l.face.normal.clone():new a.Vector3(0,1,0);if(l.object&&l.face){const f=new a.Matrix3().getNormalMatrix(l.object.matrixWorld);c.applyMatrix3(f).normalize()}const u=c.dot(new a.Vector3(0,1,0))>=.5;return{hit:!0,point:l.point,normal:c,distance:l.distance,isWalkable:u}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}}const Ge=[xt,ht,bt,dt];class Ve{constructor(){this.base=null,this.thumb=null,this.active=!1,this.originX=0,this.originY=0,this.currentX=0,this.currentY=0,this.maxDistance=40,this.deadzone=.15,this.createElements()}createElements(){this.base=document.createElement("div"),this.base.id="joystick-base",this.base.style.display="none",document.body.appendChild(this.base),this.thumb=document.createElement("div"),this.thumb.id="joystick-thumb",this.base.appendChild(this.thumb)}show(t,e){this.active=!0,this.originX=t,this.originY=e,this.currentX=t,this.currentY=e,this.base.style.left=`${t}px`,this.base.style.top=`${e}px`,this.base.style.display="block",this.thumb.style.transform="translate(0px, 0px)",requestAnimationFrame(()=>{this.base.style.opacity="1"})}update(t,e){if(!this.active)return;this.currentX=t,this.currentY=e;let i=t-this.originX,s=e-this.originY;if(Math.sqrt(i*i+s*s)>this.maxDistance){const n=Math.atan2(s,i);i=Math.cos(n)*this.maxDistance,s=Math.sin(n)*this.maxDistance}this.thumb.style.transform=`translate(${i}px, ${s}px)`}hide(){this.active=!1,this.base.style.opacity="0",setTimeout(()=>{this.active||(this.base.style.display="none")},200)}getDirection(){if(!this.active)return{angle:0,magnitude:0};const t=this.currentX-this.originX,e=this.currentY-this.originY,i=Math.sqrt(t*t+e*e),s=Math.min(i/this.maxDistance,1);return s<this.deadzone?{angle:0,magnitude:0}:{angle:Math.atan2(e,t),magnitude:s}}getKeys(){const{angle:t,magnitude:e}=this.getDirection();if(e===0)return{w:!1,a:!1,s:!1,d:!1};let i=t*180/Math.PI;i<0&&(i+=360);const s={w:!1,a:!1,s:!1,d:!1};return i>=337.5||i<22.5?s.d=!0:i>=22.5&&i<67.5?(s.d=!0,s.w=!0):i>=67.5&&i<112.5?s.s=!0:i>=112.5&&i<157.5?(s.a=!0,s.s=!0):i>=157.5&&i<202.5?s.a=!0:i>=202.5&&i<247.5?(s.a=!0,s.w=!0):i>=247.5&&i<292.5?s.w=!0:i>=292.5&&i<337.5&&(s.d=!0,s.w=!0),s}isActive(){return this.active}}class ze{constructor(t,e){this.keysPressed=t,this.orbitControls=e,this.joystick=new Ve,this.activeTouchId=null,this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.touchLastX=0,this.touchLastY=0,this.touchHasMoved=!1,this.longPressThreshold=400,this.movementThreshold=10,this.jetpackActive=!1,this.orbitControlsEnabled=!0,this.cameraMode="third-person",this.firstPersonCallback=null,this.isPaintMode=!1,this.paintCallback=null,this.paintEndCallback=null,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.setupEventListeners(),this.startUpdateLoop()}setupEventListeners(){document.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),document.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1}),document.addEventListener("contextmenu",this.handleContextMenu,{passive:!1})}handleTouchStart(t){const e=t.target;if(e&&(e.tagName==="BUTTON"||e.tagName==="SELECT"||e.tagName==="INPUT"||e.tagName==="A"||e.closest("button")||e.closest("select")||e.closest("input")))return;const i=t.changedTouches[0],s=Date.now();this.activeTouchId!==null||this.joystick.isActive()||(this.activeTouchId=i.identifier,this.touchStartTime=s,this.touchStartX=i.clientX,this.touchStartY=i.clientY,this.touchLastX=i.clientX,this.touchLastY=i.clientY,this.touchHasMoved=!1,t.preventDefault())}handleTouchMove(t){let e=null;for(let n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===this.activeTouchId){e=t.changedTouches[n];break}if(!e)return;if(t.preventDefault(),this.joystick.isActive()){this.joystick.update(e.clientX,e.clientY);return}const i=e.clientX-this.touchStartX,s=e.clientY-this.touchStartY;if(Math.sqrt(i*i+s*s)>this.movementThreshold&&(this.touchHasMoved=!0),this.touchHasMoved){const n=e.clientX-this.touchLastX,l=e.clientY-this.touchLastY;this.isPaintMode&&this.paintCallback?this.paintCallback(e.clientX,e.clientY):this.handleCameraRotation(n,l)}this.touchLastX=e.clientX,this.touchLastY=e.clientY}handleTouchEnd(t){for(let e=0;e<t.changedTouches.length;e++)if(t.changedTouches[e].identifier===this.activeTouchId){this.joystick.isActive()&&this.deactivateJoystick(),this.isPaintMode&&this.paintEndCallback&&this.paintEndCallback(),this.activeTouchId=null,this.touchHasMoved=!1;break}}handleCameraRotation(t,e){this.cameraMode==="first-person"?this.firstPersonCallback&&this.firstPersonCallback(t,e):this.orbitControls&&(this.orbitControls.rotateLeft(-t*.005),this.orbitControls.rotateUp(-e*.005),this.orbitControls.update())}activateJoystick(t,e){this.joystick.show(t,e),this.orbitControls&&(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1),console.log("Virtual joystick activated")}deactivateJoystick(){this.joystick.hide(),this.keysPressed.w=!1,this.keysPressed.a=!1,this.keysPressed.s=!1,this.keysPressed.d=!1,this.orbitControls&&this.orbitControlsEnabled&&(this.orbitControls.enabled=!0),console.log("Virtual joystick deactivated")}activateJetpack(){this.jetpackActive=!0,this.keysPressed[" "]=!0,console.log("Jetpack mode activated")}deactivateJetpack(){this.jetpackActive=!1,this.keysPressed[" "]=!1,console.log("Jetpack mode deactivated")}startUpdateLoop(){const t=()=>{if(this.joystick.isActive()){const e=this.joystick.getKeys();this.keysPressed.w=e.w,this.keysPressed.a=e.a,this.keysPressed.s=e.s,this.keysPressed.d=e.d}this.activeTouchId!==null&&!this.joystick.isActive()&&!this.touchHasMoved&&Date.now()-this.touchStartTime>=this.longPressThreshold&&this.activateJoystick(this.touchStartX,this.touchStartY),requestAnimationFrame(t)};t()}setCameraMode(t){this.cameraMode=t,console.log(`TouchControls: Camera mode set to ${t}`)}setFirstPersonCallback(t){this.firstPersonCallback=t}setPaintMode(t){this.isPaintMode=t,this.orbitControls&&(t?(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1):this.orbitControls.enabled=this.orbitControlsEnabled),console.log(`TouchControls: Paint mode ${t?"ON":"OFF"}`)}setPaintCallback(t){this.paintCallback=t}setPaintEndCallback(t){this.paintEndCallback=t}handleContextMenu(t){return t.preventDefault(),!1}disable(){document.removeEventListener("touchstart",this.handleTouchStart),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("touchcancel",this.handleTouchEnd),document.removeEventListener("contextmenu",this.handleContextMenu),this.joystick.isActive()&&this.deactivateJoystick(),console.log("Touch controls disabled")}}async function He(){try{const r=await fetch("models/scenes.json");if(!r.ok)throw new Error(`Failed to load scenes manifest: ${r.statusText}`);const t=await r.json();return console.log("Scenes manifest loaded:",t),t}catch(r){throw console.error("Error loading scenes manifest:",r),r}}async function Oe(r){try{const t=await fetch(r);if(!t.ok)throw new Error(`Failed to load scene config from ${r}: ${t.statusText}`);const e=await t.json();return Be(e),console.log(`Scene config loaded: ${e.name}`,e),e}catch(t){throw console.error(`Error loading scene config from ${r}:`,t),t}}function Be(r){const t=["name","assets","transform","character","camera","lighting","scene"];for(const e of t)if(!(e in r))throw new Error(`Scene config missing required field: ${e}`);if(!r.assets.splatFile||!r.assets.collisionFile||!r.assets.characterFile)throw new Error("Scene config missing required asset files");if(typeof r.transform.scale!="number")throw new Error("Scene config: transform.scale must be a number");console.log("Scene config validation passed")}function te(r){return r.scenes.map(t=>({id:t.id,name:t.name,description:t.description||"",latitude:t.latitude||0,longitude:t.longitude||0,thumbnail:t.thumbnail||"models/thumbnails/placeholder.jpg"}))}function $e(r){var t;return r.defaultScene||((t=r.scenes[0])==null?void 0:t.id)||"StoneHenge"}function Ne(r,t){const e=r.scenes.find(i=>i.id===t);return e?e.config:null}class je{constructor(t,e,i={}){this.context=t,this.destination=e,this.buffer=null,this.source=null,this.gainNode=this.context.createGain(),this.gainNode.gain.value=i.initialGain!==void 0?i.initialGain:0,this.gainNode.connect(this.destination),this.isPlaying=!1}setBuffer(t){this.buffer=t}start(){if(!(this.isPlaying||!this.buffer)){this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.gainNode);try{this.source.start(),this.isPlaying=!0}catch(t){console.warn("LoopedTrack start failed:",t)}}}stop(){if(this.isPlaying){try{this.source.stop()}catch{}try{this.source.disconnect()}catch{}this.source=null,this.isPlaying=!1}}dispose(){this.stop();try{this.gainNode.disconnect()}catch{}this.gainNode=null}}class Xe{constructor(t={},e=!1){m(this,"isMobile",!1);m(this,"audioContext",null);m(this,"masterGain",null);m(this,"oneShotGain",null);m(this,"tracks",{background:null,walking:null,running:null,jetpack:null});m(this,"buffers",{background:null,walking:null,running:null,jetpack:null,magicReveal:null});m(this,"backgroundMusicEnabled",!0);m(this,"movementSoundsEnabled",!0);m(this,"backgroundMusicVolume",.3);m(this,"walkingSoundVolume",.25);m(this,"runningSoundVolume",.15);m(this,"jetpackVolume",.5);m(this,"magicRevealVolume",.6);m(this,"fadeSpeed",2);m(this,"backgroundMusicTarget",0);m(this,"walkingSoundTarget",0);m(this,"runningSoundTarget",0);m(this,"jetpackTarget",0);m(this,"currentMovementState","idle");m(this,"previousMovementState","idle");m(this,"audioUnlocked",!1);m(this,"loopedSoundsStarted",!1);m(this,"preloadPromise",null);this.config=t,this.isMobile=e,this.ensureContext(),this.setupGraph(),this.preloadPromise=this.preloadAll().then(()=>{console.log("Audio buffers preloaded")}).catch(i=>{console.warn("Audio preload failed:",i)}),console.log("AudioManager (Web Audio) initialized with config:",t,"mobile:",e)}ensureContext(){if(this.audioContext)return this.audioContext;const t=window.AudioContext||window.webkitAudioContext;return this.audioContext=new t,this.audioContext}setupGraph(){if(this.masterGain)return;const t=this.ensureContext();this.masterGain=t.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(t.destination),this.oneShotGain=t.createGain(),this.oneShotGain.gain.value=this.magicRevealVolume,this.oneShotGain.connect(this.masterGain)}async preloadAll(){const t=[];this.config.backgroundMusic&&!this.buffers.background&&t.push(this.loadBuffer(this.config.backgroundMusic,"background").then(e=>this.buffers.background=e).catch(e=>console.warn("Failed to load background:",e))),this.config.runningSound&&!this.buffers.running&&t.push(this.loadBuffer(this.config.runningSound,"running").then(e=>this.buffers.running=e).catch(e=>console.warn("Failed to load running:",e))),this.config.jetpackSound&&!this.buffers.jetpack&&t.push(this.loadBuffer(this.config.jetpackSound,"jetpack").then(e=>this.buffers.jetpack=e).catch(e=>console.warn("Failed to load jetpack:",e))),!this.isMobile&&this.config.walkingSound&&!this.buffers.walking&&t.push(this.loadBuffer(this.config.walkingSound,"walking").then(e=>this.buffers.walking=e).catch(e=>console.warn("Failed to load walking:",e))),this.config.magicReveal&&!this.buffers.magicReveal&&t.push(this.loadBuffer(this.config.magicReveal,"magicReveal").then(e=>this.buffers.magicReveal=e).catch(e=>console.warn("Failed to load magicReveal:",e))),t.length>0?(console.log(`Loading ${t.length} audio buffers...`),await Promise.allSettled(t),console.log("Audio preload complete (some may have failed)")):console.log("All audio buffers already loaded")}async loadBuffer(t){const e=this.ensureContext(),s=await(await fetch(t)).arrayBuffer();return await new Promise((o,n)=>{try{const l=e.decodeAudioData(s);l&&typeof l.then=="function"?l.then(o).catch(c=>{try{e.decodeAudioData(s,o,n)}catch(d){n(d)}}):e.decodeAudioData(s,o,n)}catch{try{e.decodeAudioData(s,o,n)}catch(c){n(c)}}})}async unlockAudio(){if(this.audioUnlocked){console.log("Audio already unlocked");return}if(this.isMobile){try{if(this.audioContext&&this.audioContext.state!=="closed")try{await this.audioContext.close()}catch{}}catch{}const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.masterGain=null,this.oneShotGain=null,this.tracks={background:null,walking:null,running:null,jetpack:null},this.setupGraph()}const t=this.ensureContext();try{await t.resume()}catch(e){console.warn("AudioContext resume failed:",e)}try{await this.preloadAll()}catch(e){console.warn("Continuing without all audio buffers:",e)}this.startOrCreateTrack("background",this.buffers.background),this.isMobile||this.startOrCreateTrack("walking",this.buffers.walking),this.startOrCreateTrack("running",this.buffers.running),this.startOrCreateTrack("jetpack",this.buffers.jetpack),this.audioUnlocked=!0,this.loopedSoundsStarted=!0,console.log("âœ“ Web Audio unlocked, looped tracks running at gain 0")}startOrCreateTrack(t,e){e&&(this.tracks[t]||(this.tracks[t]=new je(this.audioContext,this.masterGain,{initialGain:0}),this.tracks[t].setBuffer(e)),this.tracks[t].start())}playMagicReveal(t=0){if(!this.buffers.magicReveal)return;const e=()=>{try{const i=this.audioContext.createBufferSource(),s=this.audioContext.createGain();s.gain.value=this.magicRevealVolume,i.buffer=this.buffers.magicReveal,i.connect(s).connect(this.masterGain),i.start(),i.onended=()=>{try{i.disconnect()}catch{}try{s.disconnect()}catch{}}}catch(i){console.warn("Magic reveal play failed:",i)}};t>0?setTimeout(e,t*1e3):e()}startBackgroundMusic(){this.backgroundMusicEnabled&&(this.backgroundMusicTarget=this.backgroundMusicVolume,console.log("Background music fading in"))}stopBackgroundMusic(){this.backgroundMusicTarget=0,console.log("Background music fading out")}updateMovementSounds(t){if(this.previousMovementState=this.currentMovementState,this.currentMovementState=t,this.previousMovementState!==this.currentMovementState&&console.log(`Movement state changed: ${this.previousMovementState} -> ${t}`),!this.movementSoundsEnabled){this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0;return}t==="walk"?(this.isMobile?this.walkingSoundTarget=0:this.walkingSoundTarget=this.walkingSoundVolume,this.runningSoundTarget=0,this.jetpackTarget=0):t==="run"?(this.walkingSoundTarget=0,this.runningSoundTarget=this.runningSoundVolume,this.jetpackTarget=0):t==="jetpack"?(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=this.jetpackVolume):(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0)}update(t){this.rampGainTo("background",this.backgroundMusicTarget,t),this.isMobile||this.rampGainTo("walking",this.walkingSoundTarget,t),this.rampGainTo("running",this.runningSoundTarget,t),this.rampGainTo("jetpack",this.jetpackTarget,t)}rampGainTo(t,e,i){const s=this.tracks[t];if(!s||!s.gainNode)return;const o=s.gainNode.gain.value;if(o===e)return;const n=this.fadeSpeed*i,l=o<e?Math.min(e,o+n):Math.max(e,o-n),c=this.audioContext.currentTime;try{s.gainNode.gain.cancelScheduledValues(c),s.gainNode.gain.setValueAtTime(o,c),s.gainNode.gain.linearRampToValueAtTime(l,c+.05)}catch{s.gainNode.gain.value=l}}toggleBackgroundMusic(){this.backgroundMusicEnabled=!this.backgroundMusicEnabled,this.backgroundMusicEnabled?this.startBackgroundMusic():this.stopBackgroundMusic(),console.log("Background music:",this.backgroundMusicEnabled?"ON":"OFF")}toggleMovementSounds(){this.movementSoundsEnabled=!this.movementSoundsEnabled,this.movementSoundsEnabled||(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0),console.log("Movement sounds:",this.movementSoundsEnabled?"ON":"OFF")}setMasterVolume(t){const e=Math.max(0,Math.min(1,t));this.backgroundMusicVolume=e*.3,this.walkingSoundVolume=e*.25,this.runningSoundVolume=e*.15,this.jetpackVolume=e*.5,this.oneShotGain&&(this.oneShotGain.gain.value=this.magicRevealVolume*e),console.log("Master volume set to:",e)}dispose(){Object.values(this.tracks).forEach(t=>{t&&t.dispose()}),this.tracks={background:null,walking:null,running:null,jetpack:null};try{this.oneShotGain&&this.oneShotGain.disconnect()}catch{}try{this.masterGain&&this.masterGain.disconnect()}catch{}try{this.audioContext.suspend()}catch{}console.log("AudioManager (Web Audio) disposed")}}class Je{constructor(t,e,i,s){this.renderer=t,this.camera=e,this.scene=i,this.sceneConfig=s,this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.xrConfig=(s==null?void 0:s.xr)||{enabled:!0,referenceSpaceType:"local-floor",referenceSpaceOrigin:{position:{x:0,y:0,z:0},rotation:{y:0}},userHeight:1.6},this.vrVelocity=new a.Vector3,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1,this.jetpackTransitionTimer=0,this.moveSpeed=5,this.runSpeedMultiplier=2,this.isRunning=!1,this.teleportTarget=null,this.teleportReticle=null,this.isTeleporting=!1,this.characterControls=null,this.orbitControls=null,this.xrControllers=null,this.xrHands=null,this.gaussianSplat=null,this.worldOffset=new a.Vector3,this.yRotation=0,this.xRotation=0,this.actualReferenceOrigin=null,this.characterPosition=new a.Vector3,this.init()}async init(){if(!this.xrConfig.enabled){console.log("XR disabled in scene config");return}this.renderer.xr.enabled=!0,await this.createVRButton(),this.renderer.xr.addEventListener("sessionstart",this.onSessionStart.bind(this)),this.renderer.xr.addEventListener("sessionend",this.onSessionEnd.bind(this)),this.createTeleportReticle(),console.log("XRManager initialized",this.xrConfig)}async createVRButton(){if(!navigator.xr){console.log("WebXR not available, VR button hidden");return}try{if(!await navigator.xr.isSessionSupported("immersive-vr")){console.log("immersive-vr not supported, VR button hidden");return}const e=Ce.createButton(this.renderer);e.style.position="fixed",e.style.bottom="90px",e.style.right="30px",e.style.zIndex="1000",document.body.appendChild(e),this.vrButton=e,console.log("WebXR available, VR button shown")}catch(t){console.warn("Error checking WebXR support:",t)}}createTeleportReticle(){const t=new a.RingGeometry(.2,.25,32),e=new a.MeshBasicMaterial({color:65280,side:a.DoubleSide,transparent:!0,opacity:.8});this.teleportReticle=new a.Mesh(t,e),this.teleportReticle.rotation.x=-Math.PI/2,this.teleportReticle.visible=!1,this.scene.add(this.teleportReticle)}async onSessionStart(){var t,e,i;if(console.log("XR session starting..."),this.session=this.renderer.xr.getSession(),this.isXRActive=!0,this.gaussianSplat){this.gaussianSplat.visible=!0,console.log("Gaussian splat visibility ensured for VR mode:",this.gaussianSplat.visible);let s=this.gaussianSplat.parent,o=0;for(;s&&o<5;)console.log(`  Parent ${o}:`,s.type||s.constructor.name),s=s.parent,o++}else console.warn("Gaussian splat reference not set in XRManager");try{const s=this.xrConfig.referenceSpaceType||"local-floor";try{this.localSpace=await this.session.requestReferenceSpace(s),console.log(`XR reference space type: ${s}`)}catch{console.warn(`${s} not supported, falling back to 'local'`),this.localSpace=await this.session.requestReferenceSpace("local")}const o=((e=(t=this.sceneConfig)==null?void 0:t.character)==null?void 0:e.spawn)||{},n=o.position||{x:0,y:"auto",z:40},l=o.rotation||{y:0},c=n.x,d=n.z,u=((i=this.characterControls)==null?void 0:i.groundMeshes)||[];let f=0;if(u.length>0&&this.characterControls){const P=new a.Vector3(c,1e3,d);f=this.characterControls.getGroundInfoAtPosition(P,u).height,f<-50?(console.warn(`No ground found at XR spawn (${c}, ${d}), using Y=0`),f=0):console.log(`Ground height at XR spawn (${c}, ${d}): ${f.toFixed(2)}`)}const p=this.xrConfig.userHeight||1.6,x={x:c,y:f,z:d};this.actualReferenceOrigin={position:x,rotation:l,userHeight:p},this.characterPosition.set(x.x,x.y,x.z),this.setReferenceSpaceOrigin(x,l),console.log("XR reference space initialized at:",x),console.log("Character position (play space center):",this.characterPosition)}catch(s){console.error("Failed to request reference space:",s)}this.orbitControls&&(this.orbitControls.enabled=!1),this.hideNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!1),this.xrControllers&&this.xrControllers.enable(),this.xrHands&&this.xrHands.enable(),this.vrVelocity.set(0,0,0),this.worldOffset.set(0,0,0),this.yRotation=0,this.xRotation=0,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1}onSessionEnd(){console.log("XR session ended"),this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.actualReferenceOrigin=null,this.characterPosition.set(0,0,0),this.orbitControls&&(this.orbitControls.enabled=!0),this.showNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!0),this.xrControllers&&this.xrControllers.disable(),this.xrHands&&this.xrHands.disable(),this.teleportReticle.visible=!1}setReferenceSpaceOrigin(t,e){if(!this.localSpace)return;const i=t||{x:0,y:0,z:0},s=e||{y:0},o=new a.PerspectiveCamera;o.position.set(i.x,i.y,i.z),o.rotation.order="YXZ",o.rotation.y=s.y*(Math.PI/180),o.updateMatrixWorld();const n=o.quaternion,l=new XRRigidTransform({x:i.x,y:i.y,z:i.z},{x:n.x,y:n.y,z:n.z,w:n.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(l.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace),this.worldOffset.set(0,0,0)}updateReferenceSpaceByOffset(t){if(!this.currentReferenceSpace||!this.localSpace)return;this.worldOffset.add(t);const e=this.actualReferenceOrigin||this.xrConfig.referenceSpaceOrigin,i=e.position||{x:0,y:0,z:0},s=e.rotation||{y:0},o={x:i.x+this.worldOffset.x,y:i.y+this.worldOffset.y,z:i.z+this.worldOffset.z},n=new a.PerspectiveCamera;n.position.set(o.x,o.y,o.z),n.rotation.order="YXZ",n.rotation.y=s.y*(Math.PI/180)+this.yRotation,n.rotation.x=this.xRotation,n.updateMatrixWorld();const l=n.quaternion,c=new XRRigidTransform({x:o.x,y:o.y,z:o.z},{x:l.x,y:l.y,z:l.z,w:l.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(c.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace)}teleportTo(t){if(!this.isXRActive)return;const e=t.clone(),i=new a.Vector3().subVectors(e,this.characterPosition);this.characterPosition.copy(e),this.updateReferenceSpaceByOffset(i),console.log("Teleported to ground:",t,"character at feet:",e)}updateTeleportTarget(t){t?(this.teleportReticle.position.copy(t),this.teleportReticle.visible=!0,this.teleportTarget=t.clone()):(this.teleportReticle.visible=!1,this.teleportTarget=null)}executeTeleport(){this.teleportTarget&&(this.teleportTo(this.teleportTarget),this.teleportReticle.visible=!1,this.teleportTarget=null)}handleThumbstickMovement(t,e){if(!this.isXRActive||t.lengthSq()<.01)return;const i=this.renderer.xr.getCamera(),s=new a.Vector3(0,0,-1),o=new a.Vector3(1,0,0),n=Math.atan2(i.matrixWorld.elements[8],i.matrixWorld.elements[10]);s.applyAxisAngle(new a.Vector3(0,1,0),n),o.applyAxisAngle(new a.Vector3(0,1,0),n);const l=new a.Vector3().addScaledVector(s,-t.y).addScaledVector(o,t.x);l.y=0,l.normalize();const c=this.moveSpeed*(this.isRunning?this.runSpeedMultiplier:1);return l.multiplyScalar(c*e)}handleThumbstickRotation(t,e){if(!this.isXRActive||!t)return;const i=2,s=.15,o=Math.PI/2-.1;let n=!1;if(Math.abs(t.x)>s){const l=-t.x*i*e;this.yRotation+=l,n=!0}if(Math.abs(t.y)>s){const l=-t.y*i*e;this.xRotation+=l,this.xRotation=Math.max(-o,Math.min(o,this.xRotation)),n=!0}n&&this.updateReferenceSpaceByOffset(new a.Vector3)}updateVRPhysics(t,e){if(!this.isXRActive||!this.characterControls)return;const i=this.characterPosition.clone();let s=new a.Vector3;if(this.xrControllers){const l=this.xrControllers.getThumbstickAxes();l&&(s=this.handleThumbstickMovement(l,t)||new a.Vector3);const c=this.xrControllers.getRightThumbstickAxes();c&&this.handleThumbstickRotation(c,t)}const o=this.characterControls.updateVRPhysics(i,this.vrVelocity,s,t,e,this.isGrounded,this.airTime,this.jetpackActive,this.jetpackTransitionTimer);this.vrVelocity.copy(o.velocity),this.isGrounded=o.isGrounded,this.airTime=o.airTime,this.jetpackActive=o.jetpackActive,this.jetpackTransitionTimer=o.jetpackTransitionTimer;const n=new a.Vector3().subVectors(o.newPosition,i);n.lengthSq()>1e-4&&(this.characterPosition.copy(o.newPosition),this.updateReferenceSpaceByOffset(n),Math.random()<.01&&console.log("VR Physics:",{characterY:this.characterPosition.y.toFixed(2),deltaY:n.y.toFixed(3),isGrounded:o.isGrounded,velocity:this.vrVelocity.y.toFixed(2)}))}update(t,e){this.isXRActive&&(this.updateVRPhysics(t,e),this.xrControllers&&this.xrControllers.update(t),this.xrHands&&this.xrHands.update())}hideNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="none");const e=document.getElementById("camera-toggle");e&&(e.style.display="none");const i=document.getElementById("key-display");i&&(i.style.display="none")}showNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="block");const e=document.getElementById("camera-toggle");e&&(e.style.display="block");const i=document.getElementById("key-display");i&&(i.style.display="block")}getIsXRActive(){return this.isXRActive}getXRCamera(){return this.isXRActive?this.renderer.xr.getCamera():null}onJumpPressed(){this.isGrounded&&(this.vrVelocity.y=this.characterControls.jumpForce,this.isGrounded=!1,this.airTime=0)}onJetpackPressed(t){this.airTime>.4&&(this.jetpackActive=t)}onRunToggle(){this.isRunning=!this.isRunning,console.log("Run mode:",this.isRunning?"ON":"OFF")}onResetPitch(){this.xRotation=0,console.log("Camera pitch reset to flat (0 degrees)"),this.updateReferenceSpaceByOffset(new a.Vector3)}dispose(){this.vrButton&&this.vrButton.parentNode&&this.vrButton.parentNode.removeChild(this.vrButton),this.teleportReticle&&(this.scene.remove(this.teleportReticle),this.teleportReticle.geometry.dispose(),this.teleportReticle.material.dispose()),this.renderer.xr.removeEventListener("sessionstart",this.onSessionStart),this.renderer.xr.removeEventListener("sessionend",this.onSessionEnd)}}class qe{constructor(t,e,i){this.renderer=t,this.scene=e,this.xrManager=i,this.controller0=null,this.controller1=null,this.controllerGrip0=null,this.controllerGrip1=null,this.controllerModelFactory=new Te,this.rayLine0=null,this.rayLine1=null,this.leftThumbstickAxes=new a.Vector2,this.rightThumbstickAxes=new a.Vector2,this.thumbstickAxes=new a.Vector2,this.isSelectPressed=!1,this.isSqueezePressed=!1,this.squeezeHoldTime=0,this.buttonAPressed=!1,this.buttonBPressed=!1,this.rightStickPressed=!1,this.buttonACooldown=0,this.buttonBCooldown=0,this.rightStickCooldown=0,this.buttonCooldownDuration=.3,this.isPaintMode=!1,this.colorPalette=null,this.paletteColors=[{name:"Red",hex:16711680},{name:"Orange",hex:16746496},{name:"Yellow",hex:16776960},{name:"Green",hex:65280},{name:"Cyan",hex:65535},{name:"Blue",hex:255},{name:"Purple",hex:8913151},{name:"Magenta",hex:16711935},{name:"White",hex:16777215},{name:"Gray",hex:8421504},{name:"Black",hex:0},{name:"Brown",hex:9127187}],this.currentColorIndex=4,this.raycaster=new a.Raycaster,this.groundMeshes=[],this.isEnabled=!1}init(){this.controller0=this.renderer.xr.getController(0),this.controller0.addEventListener("selectstart",this.onSelectStart.bind(this,0)),this.controller0.addEventListener("selectend",this.onSelectEnd.bind(this,0)),this.controller0.addEventListener("squeezestart",this.onSqueezeStart.bind(this,0)),this.controller0.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,0)),this.scene.add(this.controller0),this.controller1=this.renderer.xr.getController(1),this.controller1.addEventListener("selectstart",this.onSelectStart.bind(this,1)),this.controller1.addEventListener("selectend",this.onSelectEnd.bind(this,1)),this.controller1.addEventListener("squeezestart",this.onSqueezeStart.bind(this,1)),this.controller1.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,1)),this.scene.add(this.controller1),this.controllerGrip0=this.renderer.xr.getControllerGrip(0),this.controllerGrip0.add(this.controllerModelFactory.createControllerModel(this.controllerGrip0)),this.scene.add(this.controllerGrip0),this.controllerGrip1=this.renderer.xr.getControllerGrip(1),this.controllerGrip1.add(this.controllerModelFactory.createControllerModel(this.controllerGrip1)),this.scene.add(this.controllerGrip1),this.rayLine0=this.createRayLine(),this.controller0.add(this.rayLine0),this.rayLine1=this.createRayLine(),this.controller1.add(this.rayLine1),console.log("XR Controllers initialized")}createRayLine(){const t=new a.BufferGeometry,e=new Float32Array([0,0,0,0,0,-5]);t.setAttribute("position",new a.BufferAttribute(e,3));const i=new a.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.6}),s=new a.Line(t,i);return s.visible=!1,s}enable(){this.isEnabled=!0,this.controller0||this.init()}disable(){this.isEnabled=!1,this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1)}onSelectStart(t,e){console.log(`Controller ${t} select start - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!0;const i=t===0?this.rayLine0:this.rayLine1;i&&(i.visible=!0,i.material.color.setHex(65280)),this.isPaintMode?(console.log("Paint mode active - setting isDragging to true"),this.isDragging=!0):console.log("NOT in paint mode - will teleport on release")}onSelectEnd(t,e){console.log(`Controller ${t} select end - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!1;const i=t===0?this.rayLine0:this.rayLine1;if(i&&(i.visible=!1),this.isPaintMode){if(console.log("Paint mode - checking color selection"),this.checkColorSelection(t)){console.log("Color selected from palette");return}console.log("Stopping paint (isDragging = false)"),this.isDragging=!1}else console.log("NOT in paint mode - executing teleport"),this.xrManager.executeTeleport()}onSqueezeStart(t,e){console.log(`Controller ${t} squeeze start`),this.isSqueezePressed=!0,this.squeezeHoldTime=0,this.xrManager.onJumpPressed()}onSqueezeEnd(t,e){console.log(`Controller ${t} squeeze end`),this.isSqueezePressed=!1,this.xrManager.onJetpackPressed(!1)}getThumbstickAxes(){const t=this.renderer.xr.getSession();if(!t)return null;this.leftThumbstickAxes.set(0,0),this.rightThumbstickAxes.set(0,0);for(const e of t.inputSources)if(e.gamepad&&e.handedness){const i=e.gamepad,s=e.handedness==="left";if(i.axes.length>=4){const o=i.axes[2],n=i.axes[3];s?this.leftThumbstickAxes.set(o,n):this.rightThumbstickAxes.set(o,n)}i.buttons.length>4&&i.buttons[4].pressed?!this.buttonAPressed&&this.buttonACooldown<=0&&(this.buttonAPressed=!0,this.buttonACooldown=this.buttonCooldownDuration,this.xrManager.onRunToggle()):this.buttonAPressed=!1,i.buttons.length>5&&i.buttons[5].pressed?!this.buttonBPressed&&this.buttonBCooldown<=0?(this.buttonBPressed=!0,this.buttonBCooldown=this.buttonCooldownDuration,console.log(`B/Y button pressed - toggling paint mode (cooldown: ${this.buttonCooldownDuration}s)`),this.togglePaintMode()):this.buttonBCooldown>0:this.buttonBPressed=!1,!s&&i.buttons.length>3&&i.buttons[3].pressed?!this.rightStickPressed&&this.rightStickCooldown<=0&&(this.rightStickPressed=!0,this.rightStickCooldown=this.buttonCooldownDuration,console.log("Right stick pressed - resetting camera pitch to flat"),this.xrManager.onResetPitch()):s||(this.rightStickPressed=!1)}return this.leftThumbstickAxes.lengthSq()>.01?(this.thumbstickAxes.copy(this.leftThumbstickAxes),this.thumbstickAxes):(this.thumbstickAxes.set(0,0),this.thumbstickAxes)}getRightThumbstickAxes(){return this.rightThumbstickAxes}togglePaintMode(){this.isPaintMode=!this.isPaintMode,this.isPaintMode?(console.log("VR Paint mode: ON"),this.showColorPalette(),this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1),this.xrManager.updateTeleportTarget(null)):(console.log("VR Paint mode: OFF"),this.hideColorPalette())}createColorPalette(){this.colorPalette=new a.Group;const t=new a.SphereGeometry(.03,16,16),e=.08;this.paletteColors.forEach((i,s)=>{const o=new a.MeshBasicMaterial({color:i.hex}),n=new a.Mesh(t,o),l=Math.floor(s/3),c=s%3;n.position.set(c*e-e,-l*e,0),n.userData={isColorPicker:!0,colorIndex:s,colorHex:i.hex,colorName:i.name},this.colorPalette.add(n)}),this.colorPalette.position.set(.15,0,-.3),this.colorPalette.visible=!1,this.controller1&&this.controller1.add(this.colorPalette),console.log("VR color palette created")}showColorPalette(){this.colorPalette||this.createColorPalette(),this.colorPalette&&(this.colorPalette.visible=!0)}hideColorPalette(){this.colorPalette&&(this.colorPalette.visible=!1)}checkColorSelection(t){if(!this.isPaintMode||!this.colorPalette||!this.colorPalette.visible)return!1;const e=t===0?this.controller0:this.controller1;if(!e)return!1;const i=new a.Matrix4;i.identity().extractRotation(e.matrixWorld),this.raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(i);const s=this.raycaster.intersectObjects(this.colorPalette.children,!1);if(s.length>0){const o=s[0].object;if(o.userData.isColorPicker)return this.currentColorIndex=o.userData.colorIndex,console.log(`Selected color: ${o.userData.colorName}`),o.scale.set(1.3,1.3,1.3),setTimeout(()=>{o.scale.set(1,1,1)},200),!0}return!1}getRayForPainting(t){if(!this.isPaintMode)return null;const e=t===0?this.controller0:this.controller1;if(!e)return null;const i=new a.Matrix4;i.identity().extractRotation(e.matrixWorld);const s=new a.Vector3;s.setFromMatrixPosition(e.matrixWorld);const o=new a.Vector3(0,0,-1);return o.applyMatrix4(i).normalize(),{origin:s,direction:o}}raycastForTeleport(t){if(!t||this.groundMeshes.length===0)return null;const e=new a.Matrix4;e.identity().extractRotation(t.matrixWorld);const i=this.raycaster;i.ray.origin.setFromMatrixPosition(t.matrixWorld),i.ray.direction.set(0,0,-1).applyMatrix4(e);const s=i.intersectObjects(this.groundMeshes,!1);return s.length>0?s[0].point:null}update(t){if(this.isEnabled){if(this.isSqueezePressed?(this.squeezeHoldTime+=t,this.squeezeHoldTime>.4&&this.xrManager.onJetpackPressed(!0)):this.squeezeHoldTime=0,this.buttonACooldown>0&&(this.buttonACooldown-=t),this.buttonBCooldown>0&&(this.buttonBCooldown-=t),this.rightStickCooldown>0&&(this.rightStickCooldown-=t),this.isSelectPressed&&!this.isPaintMode){const e=this.raycastForTeleport(this.controller0);this.xrManager.updateTeleportTarget(e),this.rayLine0&&this.rayLine0.material.color.setHex(e?65280:16711680)}else this.xrManager.updateTeleportTarget(null);this.getThumbstickAxes()}}setGroundMeshes(t){this.groundMeshes=t}dispose(){this.rayLine0&&(this.rayLine0.geometry.dispose(),this.rayLine0.material.dispose()),this.rayLine1&&(this.rayLine1.geometry.dispose(),this.rayLine1.material.dispose()),this.controller0&&(this.controller0.removeEventListener("selectstart",this.onSelectStart),this.controller0.removeEventListener("selectend",this.onSelectEnd),this.controller0.removeEventListener("squeezestart",this.onSqueezeStart),this.controller0.removeEventListener("squeezeend",this.onSqueezeEnd)),this.controller1&&(this.controller1.removeEventListener("selectstart",this.onSelectStart),this.controller1.removeEventListener("selectend",this.onSelectEnd),this.controller1.removeEventListener("squeezestart",this.onSqueezeStart),this.controller1.removeEventListener("squeezeend",this.onSqueezeEnd))}}class We{constructor(t,e,i){this.renderer=t,this.scene=e,this.characterModel=i,this.hand0=null,this.hand1=null,this.handModelFactory=new Re,this.rightHandMesh=null,this.leftHandMesh=null,this.rightHandFallback=null,this.leftHandFallback=null,this.isEnabled=!1,this.handInputState={left:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null},right:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null}}}init(){this.hand0=this.renderer.xr.getHand(0),this.hand1=this.renderer.xr.getHand(1);try{this.rightHandMesh=this.handModelFactory.createHandModel(this.hand0,"mesh"),this.hand0.add(this.rightHandMesh),this.scene.add(this.hand0)}catch{console.warn("Hand tracking model 0 not available, using fallback")}try{this.leftHandMesh=this.handModelFactory.createHandModel(this.hand1,"mesh"),this.hand1.add(this.leftHandMesh),this.scene.add(this.hand1)}catch{console.warn("Hand tracking model 1 not available, using fallback")}this.createFallbackHands(),console.log("XR Hands initialized")}createFallbackHands(){const t=new a.Group,e=new a.SphereGeometry(.04,16,16),i=new a.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),s=new a.Mesh(e,i);t.add(s);const o=new a.CylinderGeometry(.01,.01,.08,8),n=new a.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),l=new a.Mesh(o,n);l.position.set(0,0,-.06),l.rotation.x=Math.PI/2,t.add(l);const c=new a.SphereGeometry(.012,8,8),d=new a.Mesh(c,n);d.position.set(0,0,-.1),t.add(d),this.rightHandFallback=t,this.rightHandFallback.visible=!1,this.scene.add(this.rightHandFallback);const u=t.clone();this.leftHandFallback=u,this.leftHandFallback.visible=!1,this.scene.add(this.leftHandFallback)}enable(){this.isEnabled=!0,this.hand0||this.init(),this.updateFallbackVisibility()}disable(){this.isEnabled=!1,this.rightHandFallback&&(this.rightHandFallback.visible=!1),this.leftHandFallback&&(this.leftHandFallback.visible=!1)}updateFallbackVisibility(){if(!this.isEnabled)return;const t=this.renderer.xr.getSession();if(!t)return;let e=!1;for(const i of t.inputSources)if(i.hand){e=!0;break}this.rightHandFallback&&(this.rightHandFallback.visible=this.isEnabled&&!e),this.leftHandFallback&&(this.leftHandFallback.visible=this.isEnabled&&!e)}update(){if(this.isEnabled){if(this.updateFallbackVisibility(),this.rightHandFallback&&this.rightHandFallback.visible){const t=this.renderer.xr.getController(0);t&&(this.rightHandFallback.position.copy(t.position),this.rightHandFallback.quaternion.copy(t.quaternion))}if(this.leftHandFallback&&this.leftHandFallback.visible){const t=this.renderer.xr.getController(1);t&&(this.leftHandFallback.position.copy(t.position),this.leftHandFallback.quaternion.copy(t.quaternion))}}}animateGrip(t,e){const i=t===0?this.rightHandFallback:this.leftHandFallback;if(!i||!i.visible)return;const s=i.children[1];s&&(s.scale.y=1-e*.3)}getJointPosition(t,e){if(!t)return null;const i=t.get(e);if(!i)return null;const s=this.renderer.xr.getFrame(),o=this.renderer.xr.getReferenceSpace();if(!s||!o)return null;const n=s.getJointPose(i,o);return n?new a.Vector3().setFromMatrixPosition(new a.Matrix4().fromArray(n.transform.matrix)):null}getPinchDistance(t){const e=this.getJointPosition(t,"thumb-tip"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:e.distanceTo(i)}getPointingDirection(t){const e=this.getJointPosition(t,"wrist"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:new a.Vector3().subVectors(i,e).normalize()}getPalmNormal(t){if(!t)return null;const e=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(!e||!i)return null;const s=t.get("wrist");if(!s)return null;const o=e.getJointPose(s,i);if(!o)return null;const n=new a.Matrix4().fromArray(o.transform.matrix),l=new a.Vector3(0,1,0);return l.applyMatrix4(n),l.sub(new a.Vector3().setFromMatrixPosition(n)),l.normalize()}resetGestureState(t){t!=="left"&&t!=="right"||(this.handInputState[t]={isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null})}resetAllGestureStates(){this.resetGestureState("left"),this.resetGestureState("right")}dispose(){this.resetAllGestureStates(),this.rightHandFallback&&(this.scene.remove(this.rightHandFallback),this.rightHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.leftHandFallback&&(this.scene.remove(this.leftHandFallback),this.leftHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.hand0&&this.scene.remove(this.hand0),this.hand1&&this.scene.remove(this.hand1)}}const Ye=.015,Qe=300,Ue=500,_e=.003,Nt=.3,Ke=.6,Ze=600,M={IDLE:"idle",PAINTING:"painting",MOVING:"moving",JETPACK:"jetpack",MOVING_JETPACK:"moving_jetpack",TELEPORTING:"teleporting"};class ti{constructor(t,e,i=null){this.xrHands=t,this.xrManager=e,this.wristPalette=i,this.mode=M.IDLE,this.activePainterHand=null,this.paintModeEnabled=!1,this.isTeleporting=!1,this.callbacks={onPaintStart:null,onPaintDrag:null,onPaintEnd:null,onMovementStart:null,onMovementUpdate:null,onMovementEnd:null,onJetpackStart:null,onJetpackEnd:null,onColorSelect:null,onTeleportStart:null,onTeleportUpdate:null,onTeleportEnd:null,onTogglePaintMode:null},this.selectedColorIndex=6,console.log("GestureDetector initialized with proven LDIPlayer patterns")}setWristPalette(t){this.wristPalette=t}update(t,e){if(t){for(const i of t.inputSources)if(i.hand){const s=i.hand,o=i.handedness;if(o!=="left"&&o!=="right")continue;this.updateHandGestures(s,o,e)}this.updateMode(e)}}updateHandGestures(t,e,i){const s=this.xrHands.handInputState[e],o=this.xrHands.getPinchDistance(t);if(o===null)return;const n=performance.now();if(o<Ye)if(s.isPinching)this.onPinchSustain(t,e,s,i);else{s.isPinching=!0,s.pinchStartTime=n;const l=this.xrHands.getJointPosition(t,"index-finger-tip");l&&(s.dragStartPosition={x:l.x,y:l.y,z:l.z}),this.onPinchStart(t,e,i)}else if(s.isPinching){const l=n-s.pinchStartTime;this.onPinchRelease(t,e,s,l,n),s.isPinching=!1,s.dragStartPosition=null}}onPinchStart(t,e,i){console.log(`${e} pinch start`),this.mode,M.IDLE}onPinchSustain(t,e,i,s){const o=this.xrHands.getJointPosition(t,"index-finger-tip");if(!o||!i.dragStartPosition)return;const n=o.x-i.dragStartPosition.x,l=o.y-i.dragStartPosition.y,c=o.z-i.dragStartPosition.z,d=Math.sqrt(n*n+l*l+c*c);if(e==="left"&&!this.paintModeEnabled){const u=this.xrHands.getJointPosition(t,"wrist");if(u&&o){const f=u.clone(),p=new a.Vector3().subVectors(o,u).normalize();this.isTeleporting?this.callbacks.onTeleportUpdate&&this.callbacks.onTeleportUpdate(f,p):(this.isTeleporting=!0,this.mode=M.TELEPORTING,console.log("LEFT hand teleportation started"),this.callbacks.onTeleportStart&&this.callbacks.onTeleportStart(f,p))}return}d>_e&&(this.mode===M.IDLE&&this.paintModeEnabled&&this.activePainterHand===null&&this.startPainting(t,e),this.mode===M.PAINTING&&this.activePainterHand===e&&this.updatePainting(t,e))}onPinchRelease(t,e,i,s,o){if(console.log(`${e} pinch release (duration: ${s}ms)`),e==="left"&&this.isTeleporting){const n=this.xrHands.getJointPosition(t,"wrist"),l=this.xrHands.getJointPosition(t,"index-finger-tip");if(n&&l){const c=n.clone(),d=new a.Vector3().subVectors(l,n).normalize();console.log("LEFT hand teleportation executed"),this.callbacks.onTeleportEnd&&this.callbacks.onTeleportEnd(c,d)}this.isTeleporting=!1,this.mode=M.IDLE;return}s<Qe?(o-i.lastTapTime<Ue?(i.tapCount++,console.log(`${e} double-tap detected (count: ${i.tapCount})`),this.onDoubleTap(e)):(i.tapCount=1,console.log(`${e} tap 1/2`),this.onSingleTap(t,e)),i.lastTapTime=o):(console.log(`${e} hold/drag end (duration: ${s}ms)`),this.mode===M.PAINTING&&this.activePainterHand===e&&this.endPainting(e),this.mode===M.JETPACK&&e==="right"&&this.endJetpack(e))}onSingleTap(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(!i||!s)return;const o=i.clone(),n=new a.Vector3().subVectors(s,i).normalize();if(this.wristPalette&&this.wristPalette.checkToggleButtonHover(o,n)){const l=this.wristPalette.togglePaintMode();this.paintModeEnabled=l,this.callbacks.onTogglePaintMode&&this.callbacks.onTogglePaintMode(l),console.log(`Paint mode toggled via wrist button: ${l?"ON":"OFF"}`);return}if(this.paintModeEnabled&&this.callbacks.onColorSelect){this.callbacks.onColorSelect(o,n);return}}onDoubleTap(t){console.log(`${t} double-tap action`)}startPainting(t,e){this.mode=M.PAINTING,this.activePainterHand=e;const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&s){const o=i.clone(),n=new a.Vector3().subVectors(s,i).normalize();console.log(`Painting started with ${e} hand`),this.callbacks.onPaintStart&&this.callbacks.onPaintStart(e,o,n)}}updatePainting(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&s){const o=i.clone(),n=new a.Vector3().subVectors(s,i).normalize();this.callbacks.onPaintDrag&&this.callbacks.onPaintDrag(e,o,n)}}endPainting(t){console.log(`Painting ended with ${t} hand`),this.mode=M.IDLE,this.activePainterHand=null,this.callbacks.onPaintEnd&&this.callbacks.onPaintEnd(t)}startJetpack(t){this.mode===M.MOVING?this.mode=M.MOVING_JETPACK:this.mode=M.JETPACK,console.log(`Jetpack started with ${t} hand`),this.callbacks.onJetpackStart&&this.callbacks.onJetpackStart(t)}endJetpack(t){console.log(`Jetpack ended with ${t} hand`),this.mode===M.MOVING_JETPACK?this.mode=M.MOVING:this.mode=M.IDLE,this.callbacks.onJetpackEnd&&this.callbacks.onJetpackEnd(t)}updateMode(t){this.mode!==M.PAINTING&&this.checkMovementGesture(t),this.mode!==M.PAINTING&&this.checkJetpackGesture()}checkMovementGesture(t){const e=this.xrManager.renderer.xr.getSession();if(!e){console.log("[Movement] No XR session");return}let i=null;for(const l of e.inputSources)if(l.hand&&l.handedness==="left"){i=l.hand;break}if(!i){console.log("[Movement] No left hand found");return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getJointPosition(i,"index-finger-tip");if(!s||!o||!t){console.log("[Movement] Missing joint positions - wrist:",!!s,"indexTip:",!!o,"camera:",!!t);return}const n=s.distanceTo(t);if(console.log(`[Movement] Extension distance: ${n.toFixed(3)}m (min: ${Nt}m)`),n>=Nt){const l=new a.Vector3().subVectors(o,s).normalize();l.y=0,l.normalize();const c=Math.min((n-Nt)/(Ke-Nt),1);if(console.log(`[Movement] Hand extended! Speed: ${c.toFixed(2)}, Mode: ${this.mode}`),this.mode===M.IDLE||this.mode===M.JETPACK){const d=this.mode===M.JETPACK?M.MOVING_JETPACK:M.MOVING;this.mode=d,console.log(`[Movement] Started - New mode: ${d}`),this.callbacks.onMovementStart&&this.callbacks.onMovementStart(l,c)}else(this.mode===M.MOVING||this.mode===M.MOVING_JETPACK)&&this.callbacks.onMovementUpdate&&this.callbacks.onMovementUpdate(l,c)}else console.log("[Movement] Hand not extended enough"),this.mode===M.MOVING?(this.mode=M.IDLE,console.log("[Movement] Ended - Mode: IDLE"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd()):this.mode===M.MOVING_JETPACK&&(this.mode=M.JETPACK,console.log("[Movement] Ended - Mode: JETPACK"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd())}checkJetpackGesture(){const t=this.xrHands.handInputState.right,e=performance.now();if(!(this.mode===M.TELEPORTING||this.mode===M.PAINTING)&&t.isPinching){const i=e-t.pinchStartTime;i>=Ze&&this.mode!==M.JETPACK&&this.mode!==M.MOVING_JETPACK&&(console.log(`RIGHT hand jetpack activated (hold duration: ${i}ms)`),this.startJetpack("right"))}}isLeftPalmFacingUser(t){const e=this.xrManager.renderer.xr.getSession();if(!e)return!1;let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i)return!1;const s=this.xrHands.getPalmNormal(i),o=this.xrHands.getJointPosition(i,"wrist");if(!s||!o||!t)return!1;const n=new a.Vector3().subVectors(t,o).normalize();return s.dot(n)>.5}reset(){this.mode=M.IDLE,this.activePainterHand=null,this.xrHands.resetAllGestureStates(),console.log("GestureDetector reset")}on(t,e){this.callbacks.hasOwnProperty("on"+t.charAt(0).toUpperCase()+t.slice(1))&&(this.callbacks["on"+t.charAt(0).toUpperCase()+t.slice(1)]=e)}}class ei{constructor(t,e){this.scene=t,this.xrHands=e,this.colors=[{hex:16711680,name:"Red"},{hex:16746496,name:"Orange"},{hex:16776960,name:"Yellow"},{hex:65280,name:"Green"},{hex:65535,name:"Cyan"},{hex:255,name:"Blue"},{hex:8913151,name:"Purple"},{hex:16711935,name:"Magenta"},{hex:16777215,name:"White"},{hex:8947848,name:"Gray"},{hex:0,name:"Black"},{hex:8930304,name:"Brown"}],this.spheres=[],this.selectedIndex=6,this.hoveredIndex=-1,this.toggleButton=null,this.toggleButtonHovered=!1,this.paintModeEnabled=!1,this.paletteGroup=null,this.isVisible=!1,this.sphereRadius=.015,this.arcRadius=.12,this.arcSpan=Math.PI/2,this.rows=3,this.cols=4,this.createPalette()}createPalette(){this.paletteGroup=new a.Group,this.paletteGroup.visible=!1;let t=0;for(let l=0;l<this.rows;l++)for(let c=0;c<this.cols&&!(t>=this.colors.length);c++){const d=this.colors[t],u=new a.SphereGeometry(this.sphereRadius,16,16),f=new a.MeshStandardMaterial({color:d.hex,roughness:.3,metalness:.1,emissive:d.hex,emissiveIntensity:.2}),p=new a.Mesh(u,f),x=(c/(this.cols-1)-.5)*this.arcSpan,P=(l-(this.rows-1)/2)*(this.sphereRadius*3);p.position.x=Math.sin(x)*this.arcRadius,p.position.y=P,p.position.z=-Math.cos(x)*this.arcRadius,p.userData.colorIndex=t,p.userData.colorHex=d.hex,p.userData.colorName=d.name,this.spheres.push(p),this.paletteGroup.add(p),t++}const e=new a.RingGeometry(this.sphereRadius*1.2,this.sphereRadius*1.5,32),i=new a.MeshBasicMaterial({color:16777215,side:a.DoubleSide,transparent:!0,opacity:.8});this.selectionRing=new a.Mesh(e,i),this.selectionRing.visible=!1,this.paletteGroup.add(this.selectionRing);const s=this.sphereRadius*2.5,o=new a.SphereGeometry(s,16,16),n=new a.MeshStandardMaterial({color:16711680,roughness:.3,metalness:.1,emissive:16711680,emissiveIntensity:.3});this.toggleButton=new a.Mesh(o,n),this.toggleButton.position.set(0,this.sphereRadius*6,0),this.toggleButton.userData.isToggleButton=!0,this.paletteGroup.add(this.toggleButton),this.scene.add(this.paletteGroup),console.log("WristPalette created with",this.colors.length,"colors and toggle button")}update(t){const e=this.xrHands.renderer.xr.getSession();if(!e){this.hide();return}let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i){this.hide();return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getPalmNormal(i);if(!s||!o||!t){this.hide();return}const n=new a.Vector3().subVectors(t,s).normalize();if(o.dot(n)>.5){this.show(),this.paletteGroup.position.copy(s),this.paletteGroup.lookAt(t);const c=new a.Vector3().subVectors(t,s).normalize();this.paletteGroup.position.add(c.multiplyScalar(.05))}else this.hide()}checkHover(t,e){if(!this.isVisible)return null;const s=new a.Raycaster(t,e).intersectObjects(this.spheres);if(s.length>0){const o=s[0].object.userData.colorIndex;return this.setHovered(o),o}else return this.setHovered(-1),null}checkToggleButtonHover(t,e){if(!this.isVisible||!this.toggleButton)return!1;const o=new a.Raycaster(t,e).intersectObject(this.toggleButton).length>0;return o!==this.toggleButtonHovered&&(this.toggleButtonHovered=o,this.toggleButton&&(o?(this.toggleButton.scale.set(1.2,1.2,1.2),this.toggleButton.material.emissiveIntensity=.6):(this.toggleButton.scale.set(1,1,1),this.toggleButton.material.emissiveIntensity=.3))),o}togglePaintMode(){if(this.paintModeEnabled=!this.paintModeEnabled,this.toggleButton){const t=this.paintModeEnabled?65280:16711680;this.toggleButton.material.color.setHex(t),this.toggleButton.material.emissive.setHex(t),this.toggleButton.scale.set(1.4,1.4,1.4),setTimeout(()=>{this.toggleButton.scale.set(1,1,1)},100)}return console.log(`Paint mode toggled: ${this.paintModeEnabled?"ON":"OFF"}`),this.paintModeEnabled}getPaintModeEnabled(){return this.paintModeEnabled}setHovered(t){if(this.hoveredIndex!==t){if(this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1,1,1),e.material.emissiveIntensity=.2}if(this.hoveredIndex=t,this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1.3,1.3,1.3),e.material.emissiveIntensity=.6}}}selectColor(t){if(t<0||t>=this.colors.length)return;this.selectedIndex=t,console.log("Selected color:",this.colors[t].name);const e=this.spheres[t];this.selectionRing.position.copy(e.position),this.selectionRing.lookAt(this.paletteGroup.position),this.selectionRing.visible=this.isVisible;const i=e.scale.clone();e.scale.set(1.5,1.5,1.5),setTimeout(()=>{e.scale.copy(i)},100)}getSelectedColor(){return this.colors[this.selectedIndex]}show(){if(!this.isVisible&&(this.paletteGroup.visible=!0,this.selectionRing.visible=!0,this.isVisible=!0,this.selectedIndex>=0&&this.selectedIndex<this.spheres.length)){const t=this.spheres[this.selectedIndex];this.selectionRing.position.copy(t.position),this.selectionRing.lookAt(this.paletteGroup.position)}}hide(){this.isVisible&&(this.paletteGroup.visible=!1,this.selectionRing.visible=!1,this.isVisible=!1,this.setHovered(-1))}dispose(){this.spheres.forEach(t=>{t.geometry.dispose(),t.material.dispose()}),this.selectionRing&&(this.selectionRing.geometry.dispose(),this.selectionRing.material.dispose()),this.toggleButton&&(this.toggleButton.geometry.dispose(),this.toggleButton.material.dispose()),this.paletteGroup&&this.scene.remove(this.paletteGroup)}}class ii{constructor(t){this.scene=t,this.paintRays={left:null,right:null},this.movementArrow=null,this.jetpackGlows={left:null,right:null},this.createVisuals()}createVisuals(){this.createPaintRays(),this.createMovementArrow(),this.createJetpackGlows()}createPaintRays(){const t=()=>{const e=new a.BufferGeometry,i=new Float32Array([0,0,0,0,0,-5]);e.setAttribute("position",new a.BufferAttribute(i,3));const s=new a.LineBasicMaterial({color:65280,transparent:!0,opacity:.6,linewidth:2}),o=new a.Line(e,s);return o.visible=!1,this.scene.add(o),o};this.paintRays.left=t(),this.paintRays.right=t()}createMovementArrow(){const t=new a.Group,e=new a.CylinderGeometry(.02,.02,.4,8),i=new a.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),s=new a.Mesh(e,i);s.rotation.z=-Math.PI/2,t.add(s);const o=new a.ConeGeometry(.05,.1,8),n=new a.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),l=new a.Mesh(o,n);l.rotation.z=-Math.PI/2,l.position.x=.25,t.add(l),t.visible=!1,this.scene.add(t),this.movementArrow=t}createJetpackGlows(){const t=()=>{const e=new a.SphereGeometry(.06,16,16),i=new a.MeshBasicMaterial({color:65280,transparent:!0,opacity:.5}),s=new a.Mesh(e,i);return s.visible=!1,this.scene.add(s),s};this.jetpackGlows.left=t(),this.jetpackGlows.right=t()}updatePaintRay(t,e,i,s=!0){const o=this.paintRays[t];if(o)if(s&&e&&i){o.visible=!0,o.position.copy(e);const n=new a.Vector3().copy(e).add(i.clone().multiplyScalar(5));o.lookAt(n);const l=o.geometry.attributes.position.array;l[3]=0,l[4]=0,l[5]=-5,o.geometry.attributes.position.needsUpdate=!0}else o.visible=!1}updateMovementArrow(t,e,i,s=!0){if(this.movementArrow)if(s&&t&&e&&i>0){this.movementArrow.visible=!0,this.movementArrow.position.copy(t),this.movementArrow.position.y=t.y-1.3;const o=new a.Vector3().copy(t).add(e);o.y=this.movementArrow.position.y,this.movementArrow.lookAt(o);const n=.5+i*.5;this.movementArrow.scale.set(n,n,n),this.movementArrow.children.forEach(l=>{l.material&&(l.material.opacity=.4+i*.3)})}else this.movementArrow.visible=!1}updateJetpackGlow(t,e,i=!0){const s=this.jetpackGlows[t];if(s)if(i&&e){s.visible=!0,s.position.copy(e);const o=performance.now()*.005,n=.8+Math.sin(o)*.2;s.scale.set(n,n,n),s.material.opacity=.3+Math.sin(o*2)*.2}else s.visible=!1}hidePaintRays(){this.paintRays.left.visible=!1,this.paintRays.right.visible=!1}hideMovementArrow(){this.movementArrow&&(this.movementArrow.visible=!1)}hideJetpackGlows(){this.jetpackGlows.left.visible=!1,this.jetpackGlows.right.visible=!1}hideAll(){this.hidePaintRays(),this.hideMovementArrow(),this.hideJetpackGlows()}dispose(){Object.values(this.paintRays).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))}),this.movementArrow&&(this.movementArrow.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.scene.remove(this.movementArrow)),Object.values(this.jetpackGlows).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))})}}class si{constructor(t,e,i=20,s=0){this.spark=t,this.renderer=e,this.targetFPS=i,this.initialTargetFPS=i,this.frameCount=0,this.lastTime=performance.now(),this.fps=60,this.fpsHistory=[],this.qualityPresets=[{name:"Ultra",maxStdDev:Math.sqrt(8),minPixelRadius:0,maxPixelRadius:512,minAlpha:.5/255,clipXY:2,falloff:1,stochastic:!1,sortDistance:.01,sortCoorient:.99,pixelRatio:2},{name:"High",maxStdDev:Math.sqrt(7),minPixelRadius:.3,maxPixelRadius:384,minAlpha:.7/255,clipXY:1.8,falloff:.95,stochastic:!1,sortDistance:.02,sortCoorient:.99,pixelRatio:1.5},{name:"Medium",maxStdDev:Math.sqrt(6),minPixelRadius:.5,maxPixelRadius:256,minAlpha:1/255,clipXY:1.6,falloff:.85,stochastic:!1,sortDistance:.05,sortCoorient:.97,pixelRatio:1.5},{name:"Low",maxStdDev:Math.sqrt(5),minPixelRadius:.8,maxPixelRadius:192,minAlpha:1.8/255,clipXY:1.4,falloff:.7,stochastic:!1,sortDistance:.08,sortCoorient:.96,pixelRatio:1},{name:"Potato",maxStdDev:Math.sqrt(4.5),minPixelRadius:1.2,maxPixelRadius:128,minAlpha:2.5/255,clipXY:1.2,falloff:.6,stochastic:!1,sortDistance:.15,sortCoorient:.93,pixelRatio:1}],this.currentQualityIndex=Math.min(s,this.qualityPresets.length-1),this.manualMode=!1,this.originalPixelRatio=this.renderer.getPixelRatio(),this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Initialized - Starting at ${this.getCurrentQualityName()} quality (target: ${this.targetFPS} FPS)`)}update(){this.frameCount++;const t=performance.now();if(t>=this.lastTime+1e3){this.fps=Math.round(this.frameCount*1e3/(t-this.lastTime)),this.frameCount=0,this.lastTime=t,this.fpsHistory.push(this.fps),this.fpsHistory.length>3&&this.fpsHistory.shift();const e=this.fpsHistory.reduce((i,s)=>i+s,0)/this.fpsHistory.length;this.manualMode||this.adjustQuality(e)}}adjustQuality(t){this.currentQualityIndex,t<this.targetFPS-5&&this.currentQualityIndex<this.qualityPresets.length-1&&(this.currentQualityIndex++,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] â†“ Reduced to: ${this.getCurrentQualityName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`)),t>this.targetFPS+5*2&&this.currentQualityIndex>0&&(this.currentQualityIndex--,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] â†‘ Increased to: ${this.getCurrentQualityName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`))}applyQualityPreset(t){const e=this.qualityPresets[t];this.spark.maxStdDev=e.maxStdDev,this.spark.minPixelRadius=e.minPixelRadius,this.spark.maxPixelRadius=e.maxPixelRadius,this.spark.minAlpha=e.minAlpha,this.spark.clipXY=e.clipXY,this.spark.falloff=e.falloff,this.spark.defaultView.stochastic=e.stochastic,this.spark.defaultView.sortDistance=e.sortDistance,this.spark.defaultView.sortCoorient=e.sortCoorient;const i=Math.min(this.originalPixelRatio,e.pixelRatio);this.renderer.setPixelRatio(i),console.log(`[AdaptiveQuality] Applied preset: ${e.name}`,{maxStdDev:e.maxStdDev.toFixed(2),minPixelRadius:e.minPixelRadius,stochastic:e.stochastic,pixelRatio:i.toFixed(1)})}increaseQuality(){this.currentQualityIndex>0&&(this.manualMode=!0,this.currentQualityIndex--,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Manual increase to: ${this.getCurrentQualityName()} (Adaptive DISABLED)`))}decreaseQuality(){this.currentQualityIndex<this.qualityPresets.length-1&&(this.manualMode=!0,this.currentQualityIndex++,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Manual decrease to: ${this.getCurrentQualityName()} (Adaptive DISABLED)`))}setQualityByName(t){const e=this.qualityPresets.findIndex(i=>i.name.toLowerCase()===t.toLowerCase());e!==-1&&(this.currentQualityIndex=e,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Set to: ${this.getCurrentQualityName()}`))}resumeAdaptive(){this.manualMode=!1,console.log("[AdaptiveQuality] Resumed adaptive quality adjustment"),console.log(`[AdaptiveQuality] Current quality: ${this.getCurrentQualityName()} (will adjust based on FPS)`)}setTargetFPS(t){if(t!==this.targetFPS){const e=this.targetFPS;this.targetFPS=t,this.fpsHistory=[],console.log(`[AdaptiveQuality] Target FPS changed: ${e} â†’ ${t}`)}}getFPS(){return this.fps}getCurrentQualityName(){return this.qualityPresets[this.currentQualityIndex].name}getCurrentQualityIndex(){return this.currentQualityIndex}getQualityPresets(){return this.qualityPresets.map(t=>t.name)}isManualMode(){return this.manualMode}getStats(){const t=this.qualityPresets[this.currentQualityIndex];return{fps:this.fps,qualityName:t.name,qualityIndex:this.currentQualityIndex,maxStdDev:t.maxStdDev.toFixed(2),minPixelRadius:t.minPixelRadius,stochastic:t.stochastic,pixelRatio:this.renderer.getPixelRatio().toFixed(1),targetFPS:this.targetFPS}}}class oi{constructor(){this.currentSiteId=null,this.urlParams=new URLSearchParams(window.location.search)}hasSiteParameter(){return this.urlParams.has("site")}getSiteFromURL(){return this.urlParams.get("site")}isValidSite(t,e){return!t||!e?!1:e.some(i=>i.id===t)}shouldShowGlobe(t){const e=this.getSiteFromURL();return e?this.isValidSite(e,t)?(this.currentSiteId=e,!1):(console.warn(`Invalid site parameter: ${e}. Showing globe.`),!0):!0}navigateToSite(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.location.href=i}navigateToGlobe(){window.location.href=window.location.pathname}getCurrentSiteId(){return this.currentSiteId||this.getSiteFromURL()}updateURLWithoutReload(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.history.pushState({siteId:t},"",i)}}class ni{constructor(t,e){this.container=t,this.onSiteSelected=e,this.scene=null,this.camera=null,this.renderer=null,this.labelRenderer=null,this.controls=null,this.earth=null,this.atmosphere=null,this.markers=[],this.raycaster=new a.Raycaster,this.mouse=new a.Vector2,this.hoveredMarker=null,this.animationId=null,this.isInitialized=!1}latLongToVector3(t,e,i){const s=(90-t)*(Math.PI/180),o=(e+180)*(Math.PI/180);return new a.Vector3(-i*Math.sin(s)*Math.cos(o),i*Math.cos(s),i*Math.sin(s)*Math.sin(o))}async init(t){if(this.isInitialized)return;this.scene=new a.Scene,this.scene.background=new a.Color(1296);const e=window.innerWidth/window.innerHeight;this.camera=new a.PerspectiveCamera(45,e,.1,1e3);const n=this.latLongToVector3(45,10,12);this.camera.position.copy(n),this.camera.lookAt(0,0,0),this.renderer=new a.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.labelRenderer=new Ie,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0",this.labelRenderer.domElement.style.pointerEvents="none",this.container.appendChild(this.labelRenderer.domElement);const l=new a.AmbientLight(16777215,.4);this.scene.add(l);const c=new a.DirectionalLight(16777215,.8);c.position.set(5,3,5),this.scene.add(c),await this.createEarth(),this.createAtmosphere(),this.createSiteMarkers(t),this.controls=new Ee(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.minDistance=7,this.controls.maxDistance=20,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.addEventListeners(),this.isInitialized=!0,this.animate()}async createEarth(){const t=new a.SphereGeometry(5,64,64),e=new a.TextureLoader,i=await new Promise((o,n)=>{e.load("models/textures/earth_day.jpg",o,void 0,n)}),s=new a.MeshStandardMaterial({map:i,roughness:.9,metalness:.1});this.earth=new a.Mesh(t,s),this.scene.add(this.earth)}createAtmosphere(){const t=new a.SphereGeometry(5.2,64,64),e=new a.ShaderMaterial({vertexShader:`
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
                }
            `,blending:a.AdditiveBlending,side:a.BackSide,transparent:!0});this.atmosphere=new a.Mesh(t,e),this.scene.add(this.atmosphere)}positionLabelsWithCollisionAvoidance(t,e=8,i=1.5){const s=t.map(l=>this.latLongToVector3(l.latitude,l.longitude,e)),o=50,n=.5;for(let l=0;l<o;l++){let c=!1;for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++){const f=s[d].distanceTo(s[u]);if(f<i){const p=new a.Vector3().subVectors(s[d],s[u]).normalize(),x=(i-f)*n;s[d].add(p.clone().multiplyScalar(x)),s[u].sub(p.clone().multiplyScalar(x)),c=!0}}if(s.forEach(d=>{d.normalize().multiplyScalar(e)}),!c){console.log(`Label positioning converged in ${l+1} iterations`);break}}return s}createConnectingLine(t,e){const i=[t,e],s=new a.BufferGeometry().setFromPoints(i),o=new a.LineBasicMaterial({color:16777215,opacity:.5,transparent:!0,linewidth:1});return new a.Line(s,o)}createSiteMarkers(t){const s=this.positionLabelsWithCollisionAvoidance(t,6.5);t.forEach((o,n)=>{const l=this.latLongToVector3(o.latitude,o.longitude,5.05),c=s[n],d=new a.SphereGeometry(.15,16,16),u=new a.MeshBasicMaterial({color:16737792,transparent:!0,opacity:0}),f=new a.Mesh(d,u);f.position.copy(l),f.userData={siteId:o.id,siteName:o.name},this.scene.add(f);const p=this.createLabelElement(o),x=new Ae(p);x.position.copy(c),x.userData={siteId:o.id},this.scene.add(x);const P=this.createConnectingLine(l,c);this.scene.add(P),this.markers.push({mesh:f,label:x,line:P,site:o,sitePosition:l.clone(),labelPosition:c.clone()})})}createLabelElement(t){const e=document.createElement("div");e.className="globe-site-marker",e.style.pointerEvents="auto";const i=document.createElement("div");i.className="globe-thumbnail-container",i.style.width="80px",i.style.height="80px",i.style.borderRadius="50%",i.style.border="3px solid #ff6600",i.style.marginBottom="8px",i.style.overflow="hidden",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.boxShadow="0 0 20px rgba(255, 102, 0, 0.6)",i.style.transition="border-color 0.2s ease, box-shadow 0.2s ease";const s=document.createElement("img");s.src=t.thumbnail||"models/thumbnails/placeholder.jpg",s.alt=t.name,s.style.width="120px",s.style.height="120px",s.style.objectFit="cover",s.style.display="block",i.appendChild(s);const o=document.createElement("span");return o.textContent=t.name,o.style.color="#ffffff",o.style.fontSize="14px",o.style.fontWeight="bold",o.style.textShadow="0 0 10px rgba(0, 0, 0, 0.8)",o.style.display="block",o.style.textAlign="center",e.appendChild(i),e.appendChild(o),e.style.cursor="pointer",e.style.transition="transform 0.2s ease",e.dataset.siteId=t.id,e}addEventListeners(){window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("click",this.onClick.bind(this)),window.addEventListener("touchend",this.onTouch.bind(this)),window.addEventListener("resize",this.onWindowResize.bind(this))}onMouseMove(t){var s,o;this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-(t.clientY/window.innerHeight)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(n=>n.mesh),i=this.raycaster.intersectObjects(e);if(this.hoveredMarker){const n=(s=this.markers.find(l=>l.mesh===this.hoveredMarker))==null?void 0:s.label;n&&(n.element.style.transform="scale(1)"),this.hoveredMarker=null}if(i.length>0){this.hoveredMarker=i[0].object;const n=(o=this.markers.find(l=>l.mesh===this.hoveredMarker))==null?void 0:o.label;n&&(n.element.style.transform="scale(1.2)"),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onTouch(t){const e=t.changedTouches[0],i=document.elementFromPoint(e.clientX,e.clientY);if(i&&i.closest(".globe-site-marker")){const o=i.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&(console.log("Touch site selected:",o),this.onSiteSelected(o),t.preventDefault())}}onClick(t){if(t.target.closest(".globe-site-marker")){const o=t.target.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&this.onSiteSelected(o);return}this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(s=>s.mesh),i=this.raycaster.intersectObjects(e);if(i.length>0){const s=i[0].object.userData.siteId;s&&this.onSiteSelected&&this.onSiteSelected(s)}}onWindowResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.labelRenderer.setSize(t,e)}animate(){this.animationId=requestAnimationFrame(this.animate.bind(this)),this.controls&&this.controls.update(),this.updateConnectingLines(),this.renderer&&this.scene&&this.camera&&(this.renderer.render(this.scene,this.camera),this.labelRenderer.render(this.scene,this.camera))}updateConnectingLines(){this.markers&&this.markers.forEach(t=>{if(t.line&&t.mesh&&t.label){const e=new a.Vector3;t.mesh.getWorldPosition(e);const i=t.label.position,s=t.line.geometry.attributes.position.array;s[0]=e.x,s[1]=e.y,s[2]=e.z,s[3]=i.x,s[4]=i.y,s[5]=i.z,t.line.geometry.attributes.position.needsUpdate=!0}})}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),window.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("click",this.onClick.bind(this)),window.removeEventListener("touchend",this.onTouch.bind(this)),window.removeEventListener("resize",this.onWindowResize.bind(this)),this.controls&&this.controls.dispose(),this.markers&&(this.markers.forEach(t=>{t.line&&(t.line.geometry&&t.line.geometry.dispose(),t.line.material&&t.line.material.dispose()),t.mesh&&(t.mesh.geometry&&t.mesh.geometry.dispose(),t.mesh.material&&t.mesh.material.dispose())}),this.markers=[]),this.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.renderer&&this.container.removeChild(this.renderer.domElement),this.labelRenderer&&this.container.removeChild(this.labelRenderer.domElement),this.isInitialized=!1}show(){this.container.style.display="block",setTimeout(()=>{this.container.classList.add("visible")},50)}hide(){this.container.classList.remove("visible"),setTimeout(()=>{this.container.style.display="none"},500)}}let wt=null,h=null,Mt=null,gt=null,Kt=null,J,S,E,et,T,b,H,A=null,W=null,Ft=null,z=null,rt=null,Y=null,kt=null,Pt=0,k,j,g=null,mt=1,Q=null,ct=0,ee=2500,F=null,U=null,Ct=213,Tt=37,Vt=180,zt=0,Ht=0,Rt=0,Et=0,O=0,ot=0,nt=0,at=0;const ai=new a.Clock;let he=60;const _t=w.dynoFloat(0);let Yt=0;const y={enabled:w.dynoBool(!1),brushRadius:w.dynoFloat(.05),brushDepth:w.dynoFloat(10),brushOrigin:w.dynoVec3(new a.Vector3(0,0,0)),brushDirection:w.dynoVec3(new a.Vector3(0,0,0)),brushColor:w.dynoVec3(new a.Vector3(1,0,1)),useSurface:w.dynoBool(!1),surfacePoint:w.dynoVec3(new a.Vector3(0,0,0)),surfaceRadius:w.dynoFloat(.2)},ri=.01,li=.25,ci=.1,hi=100;let X=!1,Zt=!1,_=null,ie=!1;const G=function(){const r="ontouchstart"in window||navigator.maxTouchPoints>0,t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),e=r||t;return console.log("Mobile detection:",{touch:r,userAgent:t,isMobile:e}),e}(),It={},se=new De(G);let B=null,st="third-person",it=0,Z=0,oe=!1;const de=.002,ue=.005,Qt=Math.PI/2-.1;function ae(r){for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;return r}let pt=!1,ft=0;const di=.5;let Jt=new a.Vector3,vt=new a.Vector3,qt=new a.Quaternion,Ut=new a.Quaternion,lt="third-person",jt=0;const fe=.2;let ge=!1,be=!1,Lt=!1,Gt=!1,yt=null,Xt=!1,N=null;function ui(){var i,s;J=new a.Scene;const r=((i=h==null?void 0:h.scene)==null?void 0:i.backgroundColor)||"#a8def0";J.background=new a.Color(r);const t=(h==null?void 0:h.camera)||{};S=new a.PerspectiveCamera(t.fov||60,window.innerWidth/window.innerHeight,t.near||.1,t.far||1e3),S.position.set(0,5,10),E=new a.WebGLRenderer({antialias:!1,powerPreference:"high-performance"}),E.setSize(window.innerWidth,window.innerHeight),E.setPixelRatio(G?1:Math.min(window.devicePixelRatio,2)),E.shadowMap.enabled=!0,E.shadowMap.type=a.PCFSoftShadowMap,document.body.appendChild(E.domElement),et=new ke({renderer:E,maxStdDev:Math.sqrt(G?5:7),minPixelRadius:G?.5:.3,maxPixelRadius:G?256:384,minAlpha:G?1/255:.7/255,clipXY:G?1.6:2,falloff:G?.8:.95}),J.add(et),G&&(et.defaultView.sortDistance=.05,et.defaultView.sortCoorient=.97,console.log("Mobile sorting optimizations applied")),_=new a.Raycaster,fi();const e=((s=h==null?void 0:h.camera)==null?void 0:s.orbitControls)||{};T=new Fe(S,E.domElement),T.enableDamping=e.enableDamping!==void 0?e.enableDamping:!0,T.minDistance=e.minDistance||1,T.maxDistance=e.maxDistance||5,T.enablePan=e.enablePan!==void 0?e.enablePan:!1,T.maxPolarAngle=Math.PI*(e.maxPolarAngle||.55),T.update(),G&&(B=new ze(It,T),B.setFirstPersonCallback(Ai),B.setPaintCallback(Pi),B.setPaintEndCallback(Ci),console.log("Touch controls initialized early (before character load)")),console.log("Scene initialized")}function fi(){var l,c;const r=((l=h==null?void 0:h.lighting)==null?void 0:l.ambient)||{};J.add(new a.AmbientLight(r.color||16777215,r.intensity!==void 0?r.intensity:.7));const t=((c=h==null?void 0:h.lighting)==null?void 0:c.directional)||{};U=new a.DirectionalLight(t.color||16777215,t.intensity!==void 0?t.intensity:1),U.castShadow=t.castShadow!==void 0?t.castShadow:!0;const e=t.shadowCamera||{};U.shadow.camera.top=e.top||50,U.shadow.camera.bottom=e.bottom||-50,U.shadow.camera.left=e.left||-50,U.shadow.camera.right=e.right||50,U.shadow.camera.near=e.near||.1,U.shadow.camera.far=e.far||200;const i=t.shadowMapSize,s=typeof i=="number"?i:2048,o=(i==null?void 0:i.width)||s,n=(i==null?void 0:i.height)||s;U.shadow.mapSize.width=o,U.shadow.mapSize.height=n,J.add(U),Wt()}function gi(){var e;const r=new xe,t=((e=h==null?void 0:h.assets)==null?void 0:e.collisionFile)||"models/StoneHenge-collision.glb";r.load(t,i=>{var K,ut,q,ce;let s;if(i.scene.traverse($=>{$ instanceof a.Mesh&&!s&&(s=$)}),!s){console.error("No mesh found in collision GLB file");return}const o=s,n=new a.MeshStandardMaterial({color:8421504,roughness:.8,metalness:.2,side:a.DoubleSide}),l=o.geometry;k=new a.Mesh(l,n),k.position.copy(o.position),k.rotation.copy(o.rotation),k.scale.copy(o.scale),k.applyMatrix4(i.scene.matrix),k.scale.multiplyScalar(mt),k.rotation.x+=Vt*(Math.PI/180),k.rotation.y+=zt*(Math.PI/180),k.rotation.z+=Ht*(Math.PI/180),k.position.y=0,k.receiveShadow=!0,k.castShadow=!0,k.visible=!1,J.add(k);try{l.boundingBox||l.computeBoundingBox();const $=l.boundingBox.clone();$.min.multiplyScalar(mt),$.max.multiplyScalar(mt);const Ot=new a.Vector3($.min.x,-$.max.y,$.min.z),At=new a.Vector3($.max.x,-$.min.y,$.max.z);ct=At.y,console.log(`[Collision Mesh] World bounding box (at Y=0): min.y=${Ot.y.toFixed(2)}, max.y=${At.y.toFixed(2)}`),console.log(`[Collision Mesh] maxTerrainHeight = ${ct.toFixed(2)} (highest walkable point after all transforms)`),nt=Ot.y<0?-Ot.y:0,at=At.y>0?-At.y:0,console.log(`[Height Offset Bounds] Calculated from worldBBox: min.y=${Ot.y.toFixed(2)}, max.y=${At.y.toFixed(2)}`),console.log(`[Height Offset Bounds] Range: ${at.toFixed(2)} to ${nt.toFixed(2)} (scaled units)`)}catch($){console.error("[Collision Mesh] Failed to calculate bounds:",$),ct=100,nt=0,at=-100}ot==="max"?(O=nt,console.log(`[Height Offset] Resolved "max" to ${O.toFixed(2)}`)):ot==="min"&&(O=at,console.log(`[Height Offset] Resolved "min" to ${O.toFixed(2)}`)),Oi(),k.position.y=O;const c=new a.PlaneGeometry(1e4,1e4),d=new a.TextureLoader,u=((ut=(K=h==null?void 0:h.assets)==null?void 0:K.textures)==null?void 0:ut.floor)||{},f=d.load(u.color||"textures/sand/Sand 002_COLOR.jpg"),p=d.load(u.normal||"textures/sand/Sand 002_NRM.jpg"),x=d.load(u.displacement||"textures/sand/Sand 002_DISP.jpg"),P=d.load(u.ao||"textures/sand/Sand 002_OCC.jpg"),v=1e3;[f,p,x,P].forEach($=>{$.wrapS=a.RepeatWrapping,$.wrapT=a.RepeatWrapping,$.repeat.set(v,v)});const C=new a.MeshStandardMaterial({map:f,normalMap:p,displacementMap:x,displacementScale:0,aoMap:P,aoMapIntensity:1,roughness:.9,metalness:0,side:a.DoubleSide});j=new a.Mesh(c,C),j.rotation.x=-Math.PI/2,j.position.y=0,j.receiveShadow=!0,j.visible=((ce=(q=h==null?void 0:h.scene)==null?void 0:q.infiniteFloor)==null?void 0:ce.visible)!==!1,J.add(j);const V=new a.WireframeGeometry(l),D=new a.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.8});N=new a.LineSegments(V,D),N.position.copy(k.position),N.rotation.copy(k.rotation),N.scale.copy(k.scale),N.visible=!1,J.add(N),console.log("Collision mesh loaded successfully (invisible, use for physics only)"),console.log("Press G to toggle collision wireframe, H to toggle Gaussian splat, R to reset Magic effect, F to toggle infinite floor, L to toggle leveling controls"),console.log("Press M to toggle background music, N to toggle movement sounds"),St(),Lt=!0;const R=document.getElementById("collision-progress-bar"),I=document.getElementById("collision-progress-text"),L=document.getElementById("start-collision-bar"),tt=document.getElementById("start-collision-text");R&&I&&(R.style.width="100%",I.textContent="100%"),L&&tt&&(L.style.width="100%",tt.textContent="100%"),re(),yi(),bi()},i=>{const s=i.total>0?Math.min(100,Math.round(i.loaded/i.total*100)):0;console.log("Collision mesh: "+s+"% loaded");const o=document.getElementById("collision-progress-bar"),n=document.getElementById("collision-progress-text"),l=document.getElementById("start-collision-bar"),c=document.getElementById("start-collision-text");o&&n&&(o.style.width=s+"%",n.textContent=s+"%"),l&&c&&(l.style.width=s+"%",c.textContent=s+"%")},i=>{console.error("Error loading collision mesh:",i)})}function St(){const r=Vt*(Math.PI/180),t=zt*(Math.PI/180),e=Ht*(Math.PI/180),i=Rt*(Math.PI/180),s=Et*(Math.PI/180),o=O;k&&(k.position.y=o,k.rotation.x=r,k.rotation.y=t,k.rotation.z=e,k.rotation.x+=i,k.rotation.z+=s),g&&(g.position.y=o,g.rotation.x=r,g.rotation.y=t,g.rotation.z=e,g.rotation.x+=i,g.rotation.z+=s),N&&(N.position.y=o,N.rotation.x=r,N.rotation.y=t,N.rotation.z=e,N.rotation.x+=i,N.rotation.z+=s),console.log(`Leveling applied: X=${Rt.toFixed(1)}Â°, Z=${Et.toFixed(1)}Â°, Height=${O.toFixed(2)}`)}function Wt(){if(!U)return;const r=Ct*Math.PI/180,t=Tt*Math.PI/180,e=100,i=e*Math.cos(t)*Math.sin(r),s=e*Math.sin(t),o=e*Math.cos(t)*Math.cos(r);U.position.set(i,s,o),console.log(`Light orientation: Azimuth=${Ct}Â°, Elevation=${Tt}Â°, Position=(${i.toFixed(1)}, ${s.toFixed(1)}, ${o.toFixed(1)})`)}function pi(){var i;const r=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},t=r.expansionRadius??ee,e=r.duration||2;return console.log(`Creating magic modifier: radius=${t.toFixed(1)}, duration=${e.toFixed(1)}s ${r.expansionRadius?"(from config)":"(auto-calculated)"}`),w.dynoBlock({gsplat:w.Gsplat},{gsplat:w.Gsplat},({gsplat:s})=>(s=new w.Dyno({inTypes:{gsplat:w.Gsplat,t:"float"},outTypes:{gsplat:w.Gsplat},globals:()=>[w.unindent(`
            // Pseudo-random hash function for noise generation
            vec3 hash(vec3 p) {
              p = fract(p * 0.3183099 + 0.1);
              p *= 17.0;
              return fract(vec3(p.x * p.y * p.z, p.x + p.y * p.z, p.x * p.y + p.z));
            }

            // 3D Perlin-style noise function
            vec3 noise(vec3 p) {
              vec3 i = floor(p);
              vec3 f = fract(p);
              f = f * f * (3.0 - 2.0 * f);

              vec3 n000 = hash(i + vec3(0,0,0));
              vec3 n100 = hash(i + vec3(1,0,0));
              vec3 n010 = hash(i + vec3(0,1,0));
              vec3 n110 = hash(i + vec3(1,1,0));
              vec3 n001 = hash(i + vec3(0,0,1));
              vec3 n101 = hash(i + vec3(1,0,1));
              vec3 n011 = hash(i + vec3(0,1,1));
              vec3 n111 = hash(i + vec3(1,1,1));

              vec3 x0 = mix(n000, n100, f.x);
              vec3 x1 = mix(n010, n110, f.x);
              vec3 x2 = mix(n001, n101, f.x);
              vec3 x3 = mix(n011, n111, f.x);

              vec3 y0 = mix(x0, x1, f.y);
              vec3 y1 = mix(x2, x3, f.y);

              return mix(y0, y1, f.z);
            }
          `)],statements:({inputs:n,outputs:l})=>w.unindentLines(`
          ${l.gsplat} = ${n.gsplat};
          float t = ${n.t};
          float s = smoothstep(0., ${e.toFixed(1)}, t) * ${t.toFixed(1)};
          vec3 scales = ${n.gsplat}.scales;
          vec3 localPos = ${n.gsplat}.center;
          float l = length(localPos.xz);

          // Magic Effect: Complex twister with noise and radial reveal (${t} unit radius in ${e} seconds)
          float border = abs(s-l-.5);
          localPos *= 1.-.2*exp(-20.*border);
          vec3 finalScales = mix(scales,vec3(0.002),smoothstep(s-.5,s,l+.5));
          ${l.gsplat}.center = localPos + .1*noise(localPos.xyz*2.+t*.5)*smoothstep(s-.5,s,l+.5);
          ${l.gsplat}.scales = finalScales;
          float at = atan(localPos.x,localPos.z)/3.1416;
          ${l.gsplat}.rgba *= step(at,t-3.1416);
          ${l.gsplat}.rgba += exp(-20.*border) + exp(-50.*abs(t-at-3.1416))*.5;
        `)}).apply({gsplat:s,t:_t}).gsplat,{gsplat:s}))}function mi(r,t,e,i,s,o,n,l,c){return w.dynoBlock({gsplat:w.Gsplat},{gsplat:w.Gsplat},({gsplat:d})=>{if(!d)throw new Error("No gsplat input");let{center:u,rgb:f}=w.splitGsplat(d).outputs;const p=w.dot(s,w.sub(u,i)),x=w.add(i,w.mul(s,p)),P=w.length(w.sub(x,u)),v=w.lessThan(P,t),C=w.length(w.sub(x,l)),V=w.lessThan(C,c),D=w.and(w.greaterThan(p,w.dynoFloat(0)),w.lessThan(p,e)),R=w.select(n,V,D),I=w.and(v,R),L=w.select(r,w.select(I,o,f),f);return d=w.combineGsplat({gsplat:d,rgb:L}),{gsplat:d}})}async function yi(){var r,t,e,i;console.log("Loading Gaussian splat...");try{const s=document.getElementById("splat-progress-bar"),o=document.getElementById("splat-progress-text"),n=document.getElementById("start-splat-bar"),l=document.getElementById("start-splat-text");s&&o&&(s.style.width="10%",o.textContent="10%"),n&&l&&(n.style.width="10%",l.textContent="10%");const c=((r=h==null?void 0:h.assets)==null?void 0:r.splatFile)||"models/StoneHenge.sog";g=new Pe({url:c}),console.log("SplatMesh created, waiting for initialization..."),s&&o&&(s.style.width="50%",o.textContent="50%"),n&&l&&(n.style.width="50%",l.textContent="50%"),await g.initialized,console.log("SplatMesh initialized successfully");const d=g.getBoundingBox(!1),u=new a.Vector3;d.getSize(u);const f=Math.max(u.x,u.y,u.z),p=u.length()/2;console.log("Splat bounding box (local space):"),console.log("  min:",d.min),console.log("  max:",d.max),console.log("  extent:",u),console.log("  max dimension:",f.toFixed(2)),console.log("  radius (center to corner):",p.toFixed(2));const x=p*mt*1.5,P=((t=h==null?void 0:h.camera)==null?void 0:t.far)||1e3,v=Math.max(x,P);S&&(S.far=v,S.updateProjectionMatrix(),console.log(`Camera far plane: config=${P}, auto=${x.toFixed(0)}, using=${v.toFixed(0)}`)),ee=Math.sqrt(u.x*u.x+u.z*u.z)/2*1.1,console.log(`Magic effect expansion radius: auto=${ee.toFixed(1)} (in splat space)`);const V=(e=h==null?void 0:h.character)==null?void 0:e.maxHeight;if(console.log(`[Height Cap Config] configMaxHeight="${V}", maxTerrainHeight=${ct.toFixed(2)}, heightOffset=${O.toFixed(2)}`),V==="auto"){const q=ct+O;Q=q*2,console.log(`[Height Cap] Set to ${Q.toFixed(2)} (auto: 2Ã— actual terrain height ${q.toFixed(2)} = 2Ã— (${ct.toFixed(2)} + ${O.toFixed(2)}))`)}else if(typeof V=="number")V<0?(Q=null,console.log(`[Height Cap] Set to NONE (unlimited) - config value: ${V}`)):(Q=V,console.log(`[Height Cap] Set to ${Q.toFixed(2)} (absolute from config)`));else{const q=ct+O;Q=q*2,console.log(`[Height Cap] Set to ${Q.toFixed(2)} (default auto: 2Ã— actual terrain height ${q.toFixed(2)} = 2Ã— (${ct.toFixed(2)} + ${O.toFixed(2)}))`)}console.log(`[Height Cap Final] maxCharacterHeight = ${Q===null?"null (unlimited)":Q.toFixed(2)}`),b&&(b.maxHeight=Q,console.log(`[Height Cap] Updated existing CharacterControls.maxHeight to ${Q===null?"null (unlimited)":Q.toFixed(2)}`)),s&&o&&(s.style.width="100%",o.textContent="100%"),n&&l&&(n.style.width="100%",l.textContent="100%"),g.scale.multiplyScalar(mt),g.rotation.x+=Vt*(Math.PI/180),g.rotation.y+=zt*(Math.PI/180),g.rotation.z+=Ht*(Math.PI/180),g.position.y=O,et.add(g),g.visible=!1,St(),Gt=!0,A&&(A.gaussianSplat=g,console.log("Gaussian splat reference set in XRManager"));const D=30,R=20,I=50,L=G?R:D,tt=G?2:0;F=new si(et,E,L,tt),F.vrTargetFPS=I,F.desktopTargetFPS=D,F.mobileTargetFPS=R,console.log("Adaptive quality system initialized");const K=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},ut=K.enabled!==!1&&(!G||K.mobileEnabled===!0);if(console.log("Magic effect config check:",{enabled:K.enabled,mobileEnabled:K.mobileEnabled,isMobile:G,shouldEnableEffect:ut}),ut)try{g.objectModifier=pi(),g.updateGenerator(),console.log(`Gaussian splat loaded with Magic effect (${G?"mobile":"desktop"}) - awaiting user interaction`),console.log("Magic effect modifier attached:",!!g.objectModifier)}catch(q){console.error("Error applying Magic effect modifier:",q),console.log("Gaussian splat loaded without Magic effect (shader compilation failed)")}else console.log(`Gaussian splat loaded without Magic effect (${G?"mobile not enabled in config":"disabled in config"})`);try{g.worldModifier=mi(y.enabled,y.brushRadius,y.brushDepth,y.brushOrigin,y.brushDirection,y.brushColor,y.useSurface,y.surfacePoint,y.surfaceRadius),g.updateGenerator(),console.log("Brush modifier applied to Gaussian splat")}catch(q){console.error("Error applying brush modifier:",q)}re()}catch(s){console.error("Error loading Gaussian splat:",s)}}async function re(){if(Xt)return;const r=document.getElementById("start-loading-bars"),t=document.getElementById("start-button");r&&(Lt&&Gt?(Xt=!0,yt&&(clearTimeout(yt),yt=null),console.log("All assets loaded, showing buttons..."),setTimeout(async()=>{r.style.display="none",t&&(t.style.display="inline-block"),console.log("Assets loaded, start button shown")},500)):yt||(console.log("Assets not fully loaded, setting fallback timeout..."),yt=setTimeout(async()=>{Lt&&Gt&&!Xt?(Xt=!0,console.log("Loading timeout: assets confirmed loaded, showing buttons"),r.style.display="none",t&&(t.style.display="inline-block")):(!Lt||!Gt)&&(console.warn("Loading timeout: assets STILL not loaded, waiting longer..."),yt=null,setTimeout(()=>re(),2e3))},1e4)))}function xi(){var r;if(ge){console.log("Magic reveal already started");return}if(ge=!0,g&&(g.visible=!0),g&&g.objectModifier?(Yt=0,_t.value=0,console.log("Magic reveal animation started by user interaction")):console.log("Gaussian splat not ready for animation, skipping magic effect"),H&&(H.startBackgroundMusic(),console.log("Background music started")),H){const e=(((r=h==null?void 0:h.scene)==null?void 0:r.magicEffect)||{}).soundDelay||0;H.playMagicReveal(e),console.log(`Magic reveal sound will play in ${e}s`)}}function bi(){var e;const r=new xe,t=((e=h==null?void 0:h.assets)==null?void 0:e.characterFile)||"models/Soldier.glb";r.load(t,i=>{var V,D,R,I;const s=i.scene;s.traverse(L=>{L.isMesh&&(L.castShadow=!0)}),J.add(s);const o=i.animations,n=new a.AnimationMixer(s),l=new Map;o.forEach(L=>{l.set(L.name,n.clipAction(L))});const c=((V=h==null?void 0:h.camera)==null?void 0:V.offsetFromCharacter)||{x:0,y:2,z:5},d=((R=(D=h==null?void 0:h.camera)==null?void 0:D.targetOffset)==null?void 0:R.y)||1;b=new Le(s,n,l,T,S,"Idle",[k,j],Q,d);const u=((I=h==null?void 0:h.character)==null?void 0:I.spawn)||{},f=u.position||{x:0,y:"auto",z:40},p=u.rotation||{y:0};s.position.x=f.x,s.position.z=f.z,s.rotation.y=p.y*(Math.PI/180),f.y==="auto"?(s.position.y=1e3,console.log(`Auto-detecting ground height at spawn position (${f.x}, ${f.z})...`),b.placeOnGround()):(s.position.y=f.y,console.log(`Character spawned at specified position (${f.x}, ${f.y}, ${f.z})`));const P=new a.Vector3(c.x,c.y,c.z).clone().applyQuaternion(s.quaternion);S.position.set(s.position.x+P.x,s.position.y+P.y,s.position.z+P.z);const C=new a.Vector3(0,d,0).clone().applyQuaternion(s.quaternion);T.target.set(s.position.x+C.x,s.position.y+C.y,s.position.z+C.z),T.syncFromCamera(),T.update(),console.log("Character loaded successfully at position:",s.position),console.log("Camera positioned at:",S.position),console.log("Character facing east (rotation Y:",s.rotation.y,")"),console.log("Available animations:",Array.from(l.keys())),G&&(b.toggleRun=!0,console.log("Mobile: run mode enabled by default")),wi()},i=>{console.log(i.loaded/i.total*100+"% loaded")},i=>{console.error("Error loading character:",i)})}function wi(){A=new Je(E,S,J,h),W=new qe(E,J,A),W.setGroundMeshes([k,j]),Ft=new We(E,J,b==null?void 0:b.model),rt=new ei(J,Ft),z=new ti(Ft,A,rt),Y=new ii(J),z.callbacks.onPaintStart=(r,t,e)=>{console.log(`Gesture paint start (${r})`),g&&(y.brushOrigin.value.copy(t),y.brushDirection.value.copy(e),y.enabled.value=!0),Y&&Y.updatePaintRay(r,t,e,!0)},z.callbacks.onPaintDrag=(r,t,e)=>{if(!g)return;y.brushOrigin.value.copy(t),y.brushDirection.value.copy(e),y.enabled.value=!0;const i=rt?rt.getSelectedColor():{hex:8913151},s=new a.Color(i.hex).convertLinearToSRGB();y.brushColor.value.x=s.r,y.brushColor.value.y=s.g,y.brushColor.value.z=s.b;const n=new a.Raycaster(t,e).intersectObjects([k,j],!0);n.length>0?(y.useSurface.value=!0,y.surfacePoint.value.copy(n[0].point)):y.useSurface.value=!1;const l=!g.splatRgba;g.splatRgba=et.getRgba({generator:g,rgba:g.splatRgba}),l?g.updateGenerator():g.updateVersion(),Y&&Y.updatePaintRay(r,t,e,!0)},z.callbacks.onPaintEnd=r=>{console.log(`Gesture paint end (${r})`),y.enabled.value=!1,Y&&Y.updatePaintRay(r,null,null,!1)},z.callbacks.onMovementStart=(r,t)=>{console.log(`Movement gesture started: speed=${t.toFixed(2)}`),kt=r.clone(),Pt=t},z.callbacks.onMovementUpdate=(r,t)=>{kt=r.clone(),Pt=t},z.callbacks.onMovementEnd=()=>{console.log("Movement gesture ended"),kt=null,Pt=0},z.callbacks.onJetpackStart=r=>{console.log(`Jetpack gesture started (${r})`),b&&b.activateJetpack()},z.callbacks.onJetpackEnd=r=>{console.log(`Jetpack gesture ended (${r})`),b&&b.deactivateJetpack()},z.callbacks.onColorSelect=(r,t)=>{if(rt){const e=rt.checkHover(r,t);e!==null&&(rt.selectColor(e),z.selectedColorIndex=e,console.log(`Color selected: index ${e}`))}},z.callbacks.onTeleportStart=(r,t)=>{if(console.log("Teleport started (LEFT hand)"),A){const i=new a.Raycaster(r,t).intersectObjects([k,j],!0);i.length>0?A.updateTeleportTarget(i[0].point):A.updateTeleportTarget(null)}},z.callbacks.onTeleportUpdate=(r,t)=>{if(A){const i=new a.Raycaster(r,t).intersectObjects([k,j],!0);i.length>0?A.updateTeleportTarget(i[0].point):A.updateTeleportTarget(null)}},z.callbacks.onTeleportEnd=(r,t)=>{console.log("Teleport executed (LEFT hand released)"),A&&A.executeTeleport()},z.callbacks.onTogglePaintMode=r=>{console.log(`Paint mode toggled via gesture: ${r?"ON":"OFF"}`),W&&(W.isPaintMode=r),g&&(y.enabled.value=r)},A.characterControls=b,A.orbitControls=T,A.xrControllers=W,A.xrHands=Ft,A.gestureDetector=z,console.log("WebXR system initialized with gesture detection")}function vi(){var t,e;const r=((e=(t=h==null?void 0:h.assets)==null?void 0:t.audio)==null?void 0:e.jetpack)||"sounds/thrusters_loopwav-14699.mp3";H=new Xe({backgroundMusic:"sounds/happy-relaxing-loop-275536.mp3",walkingSound:"sounds/walking-on-gravel-version-2-308744.mp3",runningSound:"sounds/running-on-gravel-301880.mp3",jetpackSound:r,magicReveal:"sounds/a-magical-intro-395716.mp3"},G),console.log("Audio system initialized - will start on user clicking start button")}function Si(){const r=document.getElementById("camera-icon-3rd"),t=document.getElementById("camera-icon-1st");st==="first-person"?(r&&(r.style.display="none"),t&&(t.style.display="block")):(r&&(r.style.display="block"),t&&(t.style.display="none"))}function ne(){var r,t,e;if(!b){console.log("Character not loaded yet");return}if(!pt)if(st==="third-person"){const i=b.model,s=new a.Euler;s.setFromQuaternion(i.quaternion,"YXZ"),Z=ae(s.y),it=0,Jt.copy(S.position),qt.copy(S.quaternion),vt.set(i.position.x,i.position.y+b.firstPersonHeadHeight,i.position.z),S.rotation.order="YXZ";const o=new a.Euler(it,Z,0,"YXZ");Ut.setFromEuler(o),pt=!0,ft=0,lt="first-person",console.log("Starting transition to first-person mode")}else{const i=b.model;if(i){const s=((r=h==null?void 0:h.camera)==null?void 0:r.offsetFromCharacter)||{x:0,y:2,z:5},o=((e=(t=h==null?void 0:h.camera)==null?void 0:t.targetOffset)==null?void 0:e.y)||1,n=Z,l=new a.Quaternion;l.setFromAxisAngle(new a.Vector3(0,1,0),n),i.quaternion.copy(l);const d=new a.Vector3(s.x,s.y,s.z).clone().applyQuaternion(i.quaternion);Jt.copy(S.position),qt.copy(S.quaternion),vt.set(i.position.x+d.x,i.position.y+d.y,i.position.z+d.z);const f=new a.Vector3(0,o,0).clone().applyQuaternion(l);T.target.set(i.position.x+f.x,i.position.y+f.y,i.position.z+f.z);const p=vt.distanceTo(T.target);console.log("Transition target distance:",p.toFixed(3)),console.log("WorldOffset:",d),console.log("TargetOffsetY:",o),pt=!0,ft=0,lt="third-person",console.log("Starting transition to third-person mode"),console.log("Start pos:",Jt),console.log("Start quat:",qt),console.log("Target pos (OrbitControls final):",vt),console.log("Target quat (OrbitControls final):",Ut)}}}function Mi(){const r=document.getElementById("camera-toggle-button");r&&(r.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ne()}),G&&r.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),ne()},{passive:!1}),console.log("Camera toggle button initialized"))}function ki(){const r=document.getElementById("paint-toggle-button");r&&G&&(r.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),pe()}),r.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),pe()},{passive:!1}),console.log("Paint toggle button initialized"))}function pe(){X=!X;const r=document.getElementById("paint-toggle-button");r&&(X?r.classList.add("active"):r.classList.remove("active")),B&&B.setPaintMode(X),console.log(`Mobile paint mode: ${X?"ON":"OFF"}`)}function Pi(r,t){if(!X||!g||!_)return;const e=new a.Vector3(1,0,1),i=E.domElement.getBoundingClientRect(),s=new a.Vector2;s.x=(r-i.left)/i.width*2-1,s.y=-((t-i.top)/i.height)*2+1,_.setFromCamera(s,S),y.brushOrigin.value.copy(_.ray.origin),y.brushDirection.value.copy(_.ray.direction),y.brushColor.value.copy(e);const o=_.intersectObjects([k,j],!0);o.length>0?(y.useSurface.value=!0,y.surfacePoint.value.copy(o[0].point)):y.useSurface.value=!1,y.enabled.value=!0;const n=!g.splatRgba;g.splatRgba=et.getRgba({generator:g,rgba:g.splatRgba}),n?g.updateGenerator():g.updateVersion()}function Ci(){y&&y.enabled&&(y.enabled.value=!1)}function Ti(){const r=document.getElementById("jump-jetpack-button");if(r&&G){let t=null;const e=400;r.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),It[" "]=!0,setTimeout(()=>{(!B||!B.jetpackActive)&&(It[" "]=!1)},50),t=setTimeout(()=>{B&&(B.activateJetpack(),r.classList.add("jetpack-active"))},e)},{passive:!1}),r.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),t&&(clearTimeout(t),t=null),B&&B.jetpackActive&&(B.deactivateJetpack(),r.classList.remove("jetpack-active"))},{passive:!1}),r.addEventListener("touchcancel",i=>{t&&(clearTimeout(t),t=null),B&&B.jetpackActive&&(B.deactivateJetpack(),r.classList.remove("jetpack-active"))},{passive:!1}),console.log("Jump/jetpack button initialized")}}function Ri(r){st==="first-person"&&oe&&(Z-=r.movementX*de,Z=ae(Z),it-=r.movementY*de,it=Math.max(-Qt,Math.min(Qt,it)),b&&b.setFirstPersonRotation(it,Z))}function Ei(){oe=document.pointerLockElement===E.domElement,console.log(`Pointer lock: ${oe?"LOCKED":"UNLOCKED"}`)}function Ii(){console.error("Pointer lock failed")}function we(){st==="first-person"&&!G&&!X&&E.domElement.requestPointerLock()}function ve(){document.pointerLockElement===E.domElement&&document.exitPointerLock()}function Ai(r,t){st==="first-person"&&(Z-=r*ue,Z=ae(Z),it-=t*ue,it=Math.max(-Qt,Math.min(Qt,it)),b&&b.setFirstPersonRotation(it,Z))}function Fi(){X=!X,y.enabled.value=X,g&&(g.needsUpdate=!0);const r=document.getElementById("paint-controls");r&&(X?r.classList.add("visible"):r.classList.remove("visible")),X?E.domElement.classList.add("paint-mode"):E.domElement.classList.remove("paint-mode"),X?(ve(),st==="third-person"&&(T.enabled=!1),console.log("Paint mode: ON - LEFT-click drag or CTRL+move to paint, camera rotation disabled")):(st==="first-person"?we():st==="third-person"&&(T.enabled=!0),console.log("Paint mode: OFF"))}function me(r){const t=y.brushRadius.value,e=Math.max(ri,Math.min(li,t+r));y.brushRadius.value=e,console.log(`Brush radius: ${e.toFixed(3)}`),le()}function ye(r){const t=y.brushDepth.value,e=Math.max(ci,Math.min(hi,t+r));y.brushDepth.value=e,console.log(`Brush depth: ${e.toFixed(1)}`),le()}function le(){const r=document.getElementById("brush-size-display");r&&(r.textContent=`Radius: ${y.brushRadius.value.toFixed(3)} | Depth: ${y.brushDepth.value.toFixed(1)}`)}function Di(){const r=document.getElementById("color-picker");r&&(r.addEventListener("input",t=>{const e=t.target.value,i=new a.Color(e).convertLinearToSRGB();y.brushColor.value.x=i.r,y.brushColor.value.y=i.g,y.brushColor.value.z=i.b,console.log(`Brush color changed to: ${e}`,i)}),console.log("Color picker initialized")),le()}function Li(){E.domElement.addEventListener("pointermove",r=>{if(!X||!g||!_)return;const t=new a.Vector2(r.clientX/window.innerWidth*2-1,-(r.clientY/window.innerHeight)*2+1);_.setFromCamera(t,S);const e=_.ray.direction.normalize();if(y.brushDirection.value.x=e.x,y.brushDirection.value.y=e.y,y.brushDirection.value.z=e.z,y.brushOrigin.value.x=_.ray.origin.x,y.brushOrigin.value.y=_.ray.origin.y,y.brushOrigin.value.z=_.ray.origin.z,k){const i=_.intersectObject(k,!1);if(i.length>0){const s=i[0].point;y.useSurface.value=!0,y.surfacePoint.value.x=s.x,y.surfacePoint.value.y=s.y,y.surfacePoint.value.z=s.z}else y.useSurface.value=!1}else y.useSurface.value=!1;if(g&&(g.needsUpdate=!0),(Zt||ie)&&g){const i=!g.splatRgba;g.splatRgba=et.getRgba({generator:g,rgba:g.splatRgba}),i?g.updateGenerator():g.updateVersion()}}),E.domElement.addEventListener("pointerdown",r=>{if(!X||!g||r.button!==0)return;r.preventDefault(),Zt=!0;const t=!g.splatRgba;g.splatRgba=et.getRgba({generator:g,rgba:g.splatRgba}),t?g.updateGenerator():g.updateVersion()}),E.domElement.addEventListener("pointerup",r=>{!X||r.button!==0||(Zt=!1)}),console.log("Paint controls initialized")}function Gi(){let r=!1;const t=()=>{!r&&H&&(H.startBackgroundMusic(),r=!0,console.log("Background music started on touch interaction (fallback)"),document.removeEventListener("touchstart",t))};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",e=>{var s;const i=e.key.toLowerCase();if(e.key==="Control"&&(ie=!0),It[i]=!0,se.down(i),!r&&H&&(H.startBackgroundMusic(),r=!0,console.log("Background music started on keyboard interaction (fallback)")),i==="shift"&&b&&b.switchRunToggle(),i==="g"&&N&&(N.visible=!N.visible,console.log(`Collision mesh wireframe: ${N.visible?"ON":"OFF"}`)),i==="h"&&g&&(g.visible=!g.visible,console.log(`Gaussian splat: ${g.visible?"ON":"OFF"}`)),i==="r"&&g){if(Yt=0,_t.value=0,H){const n=(((s=h==null?void 0:h.scene)==null?void 0:s.magicEffect)||{}).soundDelay||0;H.playMagicReveal(n)}console.log("Magic effect reset")}if(i==="f"&&j&&(j.visible=!j.visible,console.log(`Infinite floor: ${j.visible?"ON":"OFF"}`)),i==="l"){const o=document.getElementById("leveling-controls");if(o){o.classList.toggle("visible");const n=o.classList.contains("visible");console.log(`Leveling controls: ${n?"ON":"OFF"}`)}}i==="m"&&H&&H.toggleBackgroundMusic(),i==="n"&&H&&H.toggleMovementSounds(),i==="v"&&ne(),i==="p"&&Fi(),i==="q"&&F&&F.increaseQuality(),i==="e"&&F&&F.decreaseQuality(),i==="t"&&F&&F.resumeAdaptive(),(i==="="||i==="+")&&me(.01),(i==="-"||i==="_")&&me(-.01),i==="["&&ye(-1),i==="]"&&ye(1)}),document.addEventListener("keyup",e=>{const i=e.key.toLowerCase();e.key==="Control"&&(ie=!1),It[i]=!1,se.up(i)}),console.log("Keyboard controls initialized")}async function Vi(){const r=document.getElementById("start-button"),t=document.getElementById("start-overlay"),e=i=>{if(i.preventDefault(),i.stopPropagation(),!Lt||!Gt){console.warn("Assets not fully loaded yet, cannot start experience"),alert("Please wait for assets to finish loading...");return}console.log("Start button triggered - entering experience"),be=!0,t.classList.remove("visible"),xi(),H&&H.unlockAudio().then(()=>{console.log("Audio unlocked successfully in background")}).catch(s=>{console.error("Audio unlock failed:",s)})};r&&(r.addEventListener("click",e),G&&r.addEventListener("touchstart",e,{passive:!1})),console.log("Start button initialized")}function zi(){S.aspect=window.innerWidth/window.innerHeight,S.updateProjectionMatrix(),E.setSize(window.innerWidth,window.innerHeight),se.updatePosition()}function Hi(){var e,i,s,o;const r=ai.getDelta();if(F){F.update(),he=F.getFPS();const n=document.getElementById("debug-fps");n&&(n.textContent=he);const l=document.getElementById("debug-quality");if(l){const d=F.getCurrentQualityName(),u=F.isManualMode()?"MANUAL":"Auto";l.textContent=`${d} (${u})`}const c=document.getElementById("debug-decimation");if(c){const d=F.getCurrentQualityIndex(),u=F.getQualityPresets();c.textContent=`${d}/${u.length-1}`}}if(g&&be&&(Yt+=1/60,_t.value=Yt,g.updateVersion()),pt){if(ft+=r/di,lt==="third-person"){const c=S.position.distanceTo(T.target);console.log(`[Transition ${(ft*100).toFixed(1)}%] Pos: (${S.position.x.toFixed(3)}, ${S.position.y.toFixed(3)}, ${S.position.z.toFixed(3)}) Distance: ${c.toFixed(6)}`)}if(ft>=1){if(ft=1,S.position.copy(vt),lt==="first-person"?S.quaternion.copy(Ut):S.lookAt(T.target),pt=!1,lt==="third-person"&&(jt=fe),st=lt,st==="first-person")T.enabled=!1,b.model&&(b.model.visible=!1,b.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1,c.material.transparent=!1)})),b.setCameraMode("first-person"),b.setFirstPersonRotation(it,Z),B&&B.setCameraMode("first-person"),we(),console.log("Transition to first-person complete");else{b.model&&(b.model.visible=!0,b.model.traverse(f=>{f.isMesh&&f.material&&(f.material.opacity=1,f.material.transparent=!1)})),b.setCameraMode("third-person"),B&&B.setCameraMode("third-person"),ve();const c=b.model,d=((i=(e=h==null?void 0:h.camera)==null?void 0:e.targetOffset)==null?void 0:i.y)||1;if(c){const p=new a.Vector3(0,d,0).clone().applyQuaternion(c.quaternion);T.target.set(c.position.x+p.x,c.position.y+p.y,c.position.z+p.z),console.log("Re-synced OrbitControls target to character position:",T.target)}T.enabled=!0,T.syncFromCamera(),T.update();const u=S.position.distanceTo(T.target);console.log("Transition to third-person complete"),console.log("Final camera pos:",S.position),console.log("Final distance to target:",u.toFixed(3)),console.log("OrbitControls target:",T.target)}Si()}const n=ft,l=n<.5?2*n*n:-1+(4-2*n)*n;S.position.lerpVectors(Jt,vt,l),lt==="first-person"?S.quaternion.slerpQuaternions(qt,Ut,l):S.lookAt(T.target),b&&b.model&&(lt==="first-person"?l<.7?(b.model.visible=!0,b.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1-l,c.material.transparent=!0)})):b.model.visible=!1:(b.model.visible=!0,b.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=l,c.material.transparent=!0)})))}const t=A&&A.getIsXRActive();if(F){const n=F.targetFPS===F.vrTargetFPS;if(t&&!n)F.setTargetFPS(F.vrTargetFPS);else if(!t&&n){const l=G?F.mobileTargetFPS:F.desktopTargetFPS;F.setTargetFPS(l)}}if(t){if(A.update(r,[k,j]),z){const n=E.xr.getSession();z.update(n,S.position)}if(rt&&rt.update(S.position),kt&&Pt>0&&A){const n=((s=h==null?void 0:h.controls)==null?void 0:s.walkSpeed)||1.5,l=((o=h==null?void 0:h.controls)==null?void 0:o.runSpeed)||3,c=n+(l-n)*Pt,d=kt.clone().multiplyScalar(c*r);A.updateReferenceSpaceByOffset(d),Y&&Y.updateMovementArrow(S.position,kt,Pt,!0)}else Y&&Y.hideMovementArrow();if(Y&&z)if(z.mode==="jetpack"||z.mode==="moving_jetpack"){const l=E.xr.getSession();if(l){for(const c of l.inputSources)if(c.hand&&c.handedness==="right"){const d=Ft.getJointPosition(c.hand,"wrist");d&&Y.updateJetpackGlow("right",d,!0);break}}}else Y.hideJetpackGlows();if(W&&W.isPaintMode&&g)for(let n=0;n<2;n++){const l=W.getRayForPainting(n);if(l){console.log(`VR Paint: controller ${n} painting - isDragging: ${W.isDragging}`),y.brushOrigin.value.copy(l.origin),y.brushDirection.value.copy(l.direction);const c=W.paletteColors[W.currentColorIndex],d=new a.Color(c.hex).convertLinearToSRGB();if(y.brushColor.value.x=d.r,y.brushColor.value.y=d.g,y.brushColor.value.z=d.b,y.enabled.value=!0,W.isDragging){console.log("VR Paint: Baking paint to texture");const u=!g.splatRgba;g.splatRgba=et.getRgba({generator:g,rgba:g.splatRgba}),u?g.updateGenerator():g.updateVersion()}break}}else W&&!W.isPaintMode&&(y.enabled.value=!1);if(b){const n=document.getElementById("debug-state"),l=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist");if(n&&l&&c&&d){const u=A.isGrounded,f=A.jetpackActive;n.textContent=u?"GROUNDED":"IN AIR",n.className=u?"grounded":"in-air",l.textContent="VR Mode",c.textContent=f?"ACTIVE":"OFF",c.className=f?"jetpack-active":"",d.textContent="N/A (VR)"}}}else if(b){pt||b.update(r,It);const n=document.getElementById("debug-state"),l=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist"),u=document.getElementById("debug-position");if(n&&l&&c&&d&&u){const f=b.getGroundedState(),p=b.getCurrentAction(),x=b.getJetpackActive(),P=b.getGroundDistance(),v=b.getPosition();n.textContent=f?"GROUNDED":"IN AIR",n.className=f?"grounded":"in-air",l.textContent=p,c.textContent=x?"ACTIVE":"OFF",c.className=x?"jetpack-active":"",d.textContent=P.toFixed(1)+"m",u.textContent=`(${v.x.toFixed(1)}|${v.y.toFixed(1)}|${v.z.toFixed(1)})`}if(H){const f=b.getMovementState();H.updateMovementSounds(f)}}if(H&&H.update(r),jt>0){jt-=r;const n=S.position.distanceTo(T.target);console.log(`[Post-transition ${((fe-jt)*1e3).toFixed(0)}ms] Pos: (${S.position.x.toFixed(3)}, ${S.position.y.toFixed(3)}, ${S.position.z.toFixed(3)}) Distance: ${n.toFixed(6)} OrbitEnabled: ${T.enabled}`)}!pt&&!t&&st==="third-person"&&T.update(),E.render(J,S)}function Oi(){const r=document.getElementById("level-height-slider"),t=document.getElementById("level-height-value");r&&t&&(r.min=at.toFixed(2),r.max=nt.toFixed(2),r.value=O.toString(),t.textContent=`${O.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`,console.log(`[UI] Height slider bounds updated: [${at.toFixed(2)} to ${nt.toFixed(2)}]`))}function Bi(){const r=document.getElementById("level-x-slider"),t=document.getElementById("level-z-slider"),e=document.getElementById("level-height-slider"),i=document.getElementById("light-azimuth-slider"),s=document.getElementById("light-elevation-slider"),o=document.getElementById("level-x-value"),n=document.getElementById("level-z-value"),l=document.getElementById("level-height-value"),c=document.getElementById("light-azimuth-value"),d=document.getElementById("light-elevation-value"),u=document.getElementById("leveling-reset");e&&l&&(e.value=O.toString(),l.textContent=`${O.toFixed(2)} [calculating...]`),r&&r.addEventListener("input",f=>{Rt=parseFloat(f.target.value),o.textContent=Rt.toFixed(1)+"Â°",St()}),t&&t.addEventListener("input",f=>{Et=parseFloat(f.target.value),n.textContent=Et.toFixed(1)+"Â°",St()}),e&&e.addEventListener("input",f=>{O=parseFloat(f.target.value),l.textContent=`${O.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`,St()}),i&&i.addEventListener("input",f=>{Ct=parseFloat(f.target.value),c.textContent=Ct.toFixed(0)+"Â°",Wt()}),s&&s.addEventListener("input",f=>{Tt=parseFloat(f.target.value),d.textContent=Tt.toFixed(0)+"Â°",Wt()}),u&&u.addEventListener("click",()=>{var C,V,D,R,I,L,tt,K;const f=((V=(C=h==null?void 0:h.transform)==null?void 0:C.defaultLeveling)==null?void 0:V.x)||0,p=((R=(D=h==null?void 0:h.transform)==null?void 0:D.defaultLeveling)==null?void 0:R.z)||0;let x=0;ot==="max"?x=nt:ot==="min"?x=at:typeof ot=="number"&&(x=ot),Rt=f,Et=p,O=x,r.value=f,t.value=p,e.value=x,o.textContent=f.toFixed(1)+"Â°",n.textContent=p.toFixed(1)+"Â°",l.textContent=`${x.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`;const P=((L=(I=h==null?void 0:h.lighting)==null?void 0:I.directional)==null?void 0:L.azimuth)||213,v=((K=(tt=h==null?void 0:h.lighting)==null?void 0:tt.directional)==null?void 0:K.elevation)||37;Ct=P,Tt=v,i.value=P,s.value=v,c.textContent=P.toFixed(0)+"Â°",d.textContent=v.toFixed(0)+"Â°",St(),Wt(),console.log("All controls reset to defaults")}),console.log("Leveling controls initialized")}async function $i(){try{wt=await He();const r=te(wt),t=document.getElementById("scene-dropdown"),e=document.getElementById("start-scene-dropdown");t.innerHTML="",e&&(e.innerHTML=""),r.forEach(s=>{const o=document.createElement("option");if(o.value=s.id,o.textContent=s.name,t.appendChild(o),e){const n=document.createElement("option");n.value=s.id,n.textContent=s.name,e.appendChild(n)}});const i=$e(wt);t.value=i,e&&(e.value=i),t.addEventListener("change",async s=>{const o=s.target.value;o!==Mt&&(console.log(`Switching to scene: ${o}`),gt.navigateToSite(o))}),e&&e.addEventListener("change",async s=>{const o=s.target.value;if(o!==Mt){console.log(`Switching to scene: ${o}`),t.value=o;const l=te(wt).find(c=>c.id===o);if(l){const c=document.getElementById("start-title"),d=document.getElementById("start-description");c&&(c.textContent=l.name),d&&(d.textContent=l.description||"Prepare for an amazing journey")}gt.navigateToSite(o)}}),console.log("Scene selectors initialized")}catch(r){console.error("Failed to initialize scene selector:",r)}}function Ni(){sessionStorage.setItem("currentScene",Mt),h.transform.scale!==void 0&&(mt=h.transform.scale,console.log("Applied scale from config:",mt)),h.transform.rotation&&(Vt=h.transform.rotation.x!==void 0?h.transform.rotation.x:180,zt=h.transform.rotation.y!==void 0?h.transform.rotation.y:0,Ht=h.transform.rotation.z!==void 0?h.transform.rotation.z:0,console.log("Applied rotation from config:",Vt,zt,Ht)),h.transform.defaultLeveling&&(Rt=h.transform.defaultLeveling.x||0,Et=h.transform.defaultLeveling.z||0),h.transform.heightOffset!==void 0&&(ot=h.transform.heightOffset,typeof ot=="number"&&(O=ot),console.log(`[Config] heightOffset config value: ${ot}`)),h.lighting.directional&&(Ct=h.lighting.directional.azimuth,Tt=h.lighting.directional.elevation),console.log("Scene configuration applied to global state")}async function ji(r){console.log("Initializing globe view...");const t=document.getElementById("start-overlay");t&&(t.classList.remove("visible"),t.style.display="none");const e=document.getElementById("globe-overlay");if(!e){console.error("Globe container not found");return}Kt=new ni(e,i=>{console.log("Site selected:",i),gt.navigateToSite(i)}),await Kt.init(r),Kt.show(),console.log("Globe view initialized successfully")}async function Xi(){console.log("Initializing F1000..."),await $i(),gt=new oi;const r=te(wt);if(gt.shouldShowGlobe(r)){console.log("No valid site parameter - showing globe"),await ji(r);return}console.log("Valid site parameter found - loading site:",gt.getCurrentSiteId());let t=gt.getCurrentSiteId();const e=Ne(wt,t);h=await Oe(e),Mt=t,Ni();const i=document.getElementById("scene-dropdown");i&&(i.value=Mt);const s=document.getElementById("start-scene-dropdown");s&&(s.value=Mt);const o=document.getElementById("start-title"),n=document.getElementById("start-description");h&&o&&n&&(o.textContent=h.name||"Unknown Location",n.textContent=h.description||"Prepare for an amazing journey"),ui(),vi(),gi(),Gi(),Li(),Di(),Bi(),Vi(),Mi(),ki(),Ti(),window.addEventListener("resize",zi),document.addEventListener("mousemove",Ri),document.addEventListener("pointerlockchange",Ei),document.addEventListener("pointerlockerror",Ii),E.setAnimationLoop(Hi),console.log("F1000 initialized successfully")}Xi();
