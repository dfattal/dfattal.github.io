var ze=Object.defineProperty;var De=(a,t,e)=>t in a?ze(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var g=(a,t,e)=>De(a,typeof t!="symbol"?t+"":t,e);import*as r from"three";import{GLTFLoader as be}from"three/addons/loaders/GLTFLoader.js";import{dyno as v,SparkRenderer as Oe,SplatMesh as Ge,RgbaArray as Ve}from"@sparkjsdev/spark";import{VRButton as Be}from"three/addons/webxr/VRButton.js";import{XRControllerModelFactory as $e}from"three/addons/webxr/XRControllerModelFactory.js";import{XRHandModelFactory as He}from"three/addons/webxr/XRHandModelFactory.js";import{OrbitControls as Ne}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as je,CSS2DObject as Xe}from"three/addons/renderers/CSS2DRenderer.js";import{io as qe}from"socket.io-client";import*as Je from"three/addons/utils/SkeletonUtils.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class Ye{constructor(t,e){this.camera=t,this.domElement=e,this.target=new r.Vector3,this.yaw=0,this.pitch=0,this.distance=5,this.minDistance=1,this.maxDistance=10,this.enableDamping=!0,this.dampingFactor=.1,this.targetYaw=0,this.targetPitch=0,this.targetDistance=5,this.maxPolarAngle=Math.PI,this.minPolarAngle=0,this.enablePan=!1,this.enabled=!0,this.isRotating=!1,this.isZooming=!1,this.mouseStart=new r.Vector2,this.mouseCurrent=new r.Vector2,this.rotateSpeed=1,this.zoomSpeed=1,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onWheel=this.onWheel.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.domElement.addEventListener("mousedown",this.onMouseDown),this.domElement.addEventListener("wheel",this.onWheel),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.syncFromCamera()}syncFromCamera(){const t=new r.Vector3().subVectors(this.camera.position,this.target);this.distance=t.length(),this.targetDistance=this.distance;const e=Math.sqrt(t.x*t.x+t.z*t.z);this.yaw=Math.atan2(t.x,t.z),this.pitch=Math.atan2(e,t.y),this.targetYaw=this.yaw,this.targetPitch=this.pitch}rotateLeft(t){this.targetYaw+=t}rotateUp(t){this.targetPitch-=t,this.targetPitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this.targetPitch))}dolly(t){t<0?this.targetDistance/=Math.pow(.95,this.zoomSpeed):t>0&&(this.targetDistance*=Math.pow(.95,this.zoomSpeed)),this.targetDistance=Math.max(this.minDistance,Math.min(this.maxDistance,this.targetDistance))}onMouseDown(t){this.enabled&&t.button===0&&(this.isRotating=!0,this.mouseStart.set(t.clientX,t.clientY),this.mouseCurrent.set(t.clientX,t.clientY),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp))}onMouseMove(t){if(this.isRotating){this.mouseCurrent.set(t.clientX,t.clientY);const e=this.mouseCurrent.x-this.mouseStart.x,i=this.mouseCurrent.y-this.mouseStart.y,s=2*Math.PI*e/this.domElement.clientHeight*this.rotateSpeed,o=2*Math.PI*i/this.domElement.clientHeight*this.rotateSpeed;this.rotateLeft(-s),this.rotateUp(-o),this.mouseStart.copy(this.mouseCurrent)}}onMouseUp(t){t.button===0&&(this.isRotating=!1,document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp))}onWheel(t){this.enabled&&(t.preventDefault(),this.dolly(t.deltaY))}onContextMenu(t){t.preventDefault()}update(){this.enableDamping?(this.yaw+=(this.targetYaw-this.yaw)*this.dampingFactor,this.pitch+=(this.targetPitch-this.pitch)*this.dampingFactor,this.distance+=(this.targetDistance-this.distance)*this.dampingFactor):(this.yaw=this.targetYaw,this.pitch=this.targetPitch,this.distance=this.targetDistance);const t=new r.Vector3(this.distance*Math.sin(this.pitch)*Math.sin(this.yaw),this.distance*Math.cos(this.pitch),this.distance*Math.sin(this.pitch)*Math.cos(this.yaw));return this.camera.position.copy(this.target).add(t),this.camera.lookAt(this.target),!0}getAzimuthalAngle(){return this.yaw}getPolarAngle(){return this.pitch}dispose(){this.domElement.removeEventListener("mousedown",this.onMouseDown),this.domElement.removeEventListener("wheel",this.onWheel),this.domElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}reset(){this.yaw=0,this.pitch=Math.PI/4,this.distance=5,this.targetYaw=this.yaw,this.targetPitch=this.pitch,this.targetDistance=this.distance}saveState(){this.savedYaw=this.yaw,this.savedPitch=this.pitch,this.savedDistance=this.distance}}const kt="w",yt="a",Ct="s",bt="d",Wt="shift",Ht=" ",Ut="p";class _e{constructor(t=!1){g(this,"map",new Map);console.log("KeyDisplay: isMobile =",t);const e=this.createKeyDiv(kt,t),i=this.createKeyDiv(yt,t),s=this.createKeyDiv(Ct,t),o=this.createKeyDiv(bt,t),n=this.createKeyDiv(Wt,t),l=this.createKeyDiv("SPACE",t),c=this.createKeyDiv(Ut,t);this.map.set(kt,e),this.map.set(yt,i),this.map.set(Ct,s),this.map.set(bt,o),this.map.set(Wt,n),this.map.set(Ht,l),this.map.set(Ut,c),document.body.appendChild(e),document.body.appendChild(i),document.body.appendChild(s),document.body.appendChild(o),document.body.appendChild(n),document.body.appendChild(l),document.body.appendChild(c),this.updatePosition()}createKeyDiv(t,e=!1){const i=document.createElement("div");return i.style.position="absolute",i.style.padding="8px 12px",i.style.minWidth="40px",i.style.textAlign="center",i.style.fontFamily="'Courier New', monospace",i.style.fontSize="16px",i.style.fontWeight="bold",i.style.color="#333",i.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",i.style.border="1px solid #999",i.style.borderRadius="4px",i.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",i.style.transition="all 0.1s ease",i.style.userSelect="none",i.style.opacity="0.6",i.textContent=t.toUpperCase(),e&&(i.style.display="none"),i}updatePosition(){this.map.get(kt).style.top=`${window.innerHeight-80-45}px`,this.map.get(kt).style.left="168px",this.map.get(yt).style.top=`${window.innerHeight-80}px`,this.map.get(yt).style.left="100px",this.map.get(Ct).style.top=`${window.innerHeight-80}px`,this.map.get(Ct).style.left="168px",this.map.get(bt).style.top=`${window.innerHeight-80}px`,this.map.get(bt).style.left=`${100+68*2}px`,this.map.get(Wt).style.top=`${window.innerHeight-80}px`,this.map.get(Wt).style.left="21px",this.map.get(Ht).style.top=`${window.innerHeight-80}px`,this.map.get(Ht).style.left=`${100+68*3+15}px`,this.map.get(Ut).style.top=`${window.innerHeight-80}px`,this.map.get(Ut).style.left=`${100+68*4+15*2}px`}down(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #00ff00, #00cc00)",e.style.color="#000",e.style.boxShadow="0 1px 2px rgba(0,0,0,0.3), inset 0 2px 4px rgba(0,0,0,0.2)",e.style.transform="translateY(2px)",e.style.opacity="1")}up(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",e.style.color="#333",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",e.style.transform="translateY(0)",e.style.opacity="0.6")}}class We{constructor(t,e,i,s,o,n,l,c=null,d=1){g(this,"currentAction");g(this,"toggleRun",!0);g(this,"walkVelocity",2);g(this,"runVelocity",5);g(this,"jumpForce",8);g(this,"gravity",-20);g(this,"maxFallSpeed",-50);g(this,"jumpCooldownDuration",.3);g(this,"characterHeightOffset",0);g(this,"maxHeight",null);g(this,"verticalVelocity",0);g(this,"isGrounded",!0);g(this,"jumpCooldown",0);g(this,"timeInAir",0);g(this,"airTimeThreshold",.4);g(this,"isJetpackActive",!1);g(this,"jetpackThrust",25);g(this,"jetpackTransitionDuration",.3);g(this,"jetpackTransitionTimer",0);g(this,"inertiaVelocityX",0);g(this,"inertiaVelocityZ",0);g(this,"hasInertia",!1);g(this,"raycaster",new r.Raycaster);g(this,"groundMeshes",[]);g(this,"rayOrigin",new r.Vector3);g(this,"rayDirection",new r.Vector3(0,-1,0));g(this,"forwardRaycaster",new r.Raycaster);g(this,"ceilingRaycaster",new r.Raycaster);g(this,"forwardGroundRaycaster",new r.Raycaster);g(this,"forwardCollisionDistance",.5);g(this,"ceilingCollisionDistance",2.5);g(this,"maxSlopeAngle",Math.PI/3);g(this,"maxStepHeight",.5);g(this,"tempCollisionVector",new r.Vector3);g(this,"tempCollisionNormal",new r.Vector3);g(this,"tempSlideVector",new r.Vector3);g(this,"walkDirection",new r.Vector3);g(this,"rotateAngle",new r.Vector3(0,1,0));g(this,"rotateQuaternion",new r.Quaternion);g(this,"fadeDuration",.2);g(this,"updateCameraTargetOffset",new r.Vector3);g(this,"cameraMode","third-person");g(this,"firstPersonPitch",0);g(this,"firstPersonYaw",0);g(this,"firstPersonHeadHeight",1.6);g(this,"targetOffsetY",1);this.model=t,this.mixer=e,this.animationsMap=i,this.orbitControl=s,this.camera=o,this.currentAction=n,l&&(this.groundMeshes=Array.isArray(l)?l:[l]),this.maxHeight=c,console.log(`[CharacterControls] maxHeight set to: ${this.maxHeight===null?"null (unlimited)":this.maxHeight.toFixed(2)}`),this.targetOffsetY=d,this.animationsMap.forEach((u,f)=>{f===n&&u.play()})}switchRunToggle(){this.toggleRun=!this.toggleRun}getGroundedState(){return this.isGrounded}getCurrentAction(){return this.currentAction}getJetpackActive(){return this.isJetpackActive}getGroundDistance(){const t=this.getGroundInfo();return Math.max(0,this.model.position.y-t.height)}getPosition(){return{x:this.model.position.x,y:this.model.position.y,z:this.model.position.z}}getMovementState(){return this.isJetpackActive&&!this.isGrounded?"jetpack":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?"idle":this.currentAction==="Run"?"run":this.currentAction==="Walk"?"walk":"idle"}setCameraMode(t){this.cameraMode=t,console.log(`CharacterControls: Camera mode set to ${t}`)}setFirstPersonRotation(t,e){this.firstPersonPitch=t,this.firstPersonYaw=e}placeOnGround(){const t=this.getGroundInfo();this.model.position.y=t.height+this.characterHeightOffset,console.log(`Character placed on ground at Y: ${this.model.position.y.toFixed(2)}`)}getGroundInfo(){if(this.groundMeshes.length===0)return{height:0,normal:null};this.rayOrigin.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.raycaster.set(this.rayOrigin,this.rayDirection);const t=this.raycaster.intersectObjects(this.groundMeshes,!0);if(t.length>0){const e=t[0];let i=null;if(e.face&&e.object){i=e.face.normal.clone();const s=new r.Matrix3().getNormalMatrix(e.object.matrixWorld);i.applyMatrix3(s).normalize()}return{height:e.point.y,normal:i}}return{height:-100,normal:null}}checkForwardCollision(t){if(this.groundMeshes.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.forwardRaycaster.set(this.tempCollisionVector,t),this.forwardRaycaster.far=this.forwardCollisionDistance;const e=this.forwardRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0],s=i.face?i.face.normal.clone():new r.Vector3(0,1,0);if(i.object&&i.face){const l=new r.Matrix3().getNormalMatrix(i.object.matrixWorld);s.applyMatrix3(l).normalize()}const o=s.dot(new r.Vector3(0,1,0)),n=o>=.5;return{hit:!0,point:i.point,normal:s,distance:i.distance,isWalkable:n,surfaceAngle:Math.acos(Math.abs(o))*(180/Math.PI)}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}checkCeilingCollision(){if(this.groundMeshes.length===0)return{hit:!1,height:1/0,distance:1/0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y,this.model.position.z);const t=new r.Vector3(0,1,0);this.ceilingRaycaster.set(this.tempCollisionVector,t),this.ceilingRaycaster.far=this.ceilingCollisionDistance;const e=this.ceilingRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0];return{hit:!0,height:i.point.y,distance:i.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardGround(t,e){if(this.groundMeshes.length===0)return{exists:!1,height:-100,normal:null,isWalkable:!1};const i=this.model.position.x+t.x*e,s=this.model.position.z+t.z*e;this.tempCollisionVector.set(i,this.model.position.y+10,s);const o=new r.Vector3(0,-1,0);this.forwardGroundRaycaster.set(this.tempCollisionVector,o);const n=this.forwardGroundRaycaster.intersectObjects(this.groundMeshes,!0);if(n.length>0){const l=n[0],c=l.point.y,d=l.face?l.face.normal:new r.Vector3(0,1,0),u=this.getGroundInfo().height,f=c-u,p=Math.acos(Math.abs(d.y)),y=p<=this.maxSlopeAngle||Math.abs(f)<=this.maxStepHeight;return{exists:!0,height:c,normal:d,isWalkable:y,slopeAngle:p,heightDifference:f}}return{exists:!1,height:-100,normal:null,isWalkable:!1}}update(t,e){if(this.jumpCooldown>0&&(this.jumpCooldown-=t),e[Ht]&&this.isGrounded&&this.jumpCooldown<=0&&(this.verticalVelocity=this.jumpForce,this.isGrounded=!1,this.jumpCooldown=this.jumpCooldownDuration),e[Ht]&&!this.isGrounded&&this.timeInAir>this.airTimeThreshold?(this.isJetpackActive||(this.isJetpackActive=!0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0),this.verticalVelocity+=this.jetpackThrust*t):this.isJetpackActive&&(this.isJetpackActive=!1,this.jetpackTransitionTimer=this.jetpackTransitionDuration,(this.inertiaVelocityX!==0||this.inertiaVelocityZ!==0)&&(this.hasInertia=!0)),this.jetpackTransitionTimer>0){const p=this.jetpackTransitionTimer/this.jetpackTransitionDuration;this.verticalVelocity+=this.jetpackThrust*p*t,this.jetpackTransitionTimer-=t}this.verticalVelocity+=this.gravity*t,this.verticalVelocity<this.maxFallSpeed&&(this.verticalVelocity=this.maxFallSpeed);const i=this.getGroundInfo(),s=i.height,o=this.model.position.y;if(this.model.position.y+=this.verticalVelocity*t,this.verticalVelocity>0){const p=this.checkCeilingCollision();if(p.hit){const y=p.height-this.characterHeightOffset;this.model.position.y>y&&(this.model.position.y=y,this.verticalVelocity=0)}}this.maxHeight!==null&&this.model.position.y>this.maxHeight&&(console.log(`[Height Cap] Enforcing ceiling: position.y=${this.model.position.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),this.model.position.y=this.maxHeight,this.verticalVelocity=0);const l=this.model.position.y-this.characterHeightOffset-s;let c=!0;if(i.normal&&(c=i.normal.dot(new r.Vector3(0,1,0))>=.5),l<=0&&c?(this.model.position.y=s+this.characterHeightOffset,this.verticalVelocity=0,this.isGrounded=!0,this.timeInAir=0,this.isJetpackActive&&(this.isJetpackActive=!1),this.jetpackTransitionTimer=0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0):(this.isGrounded=!1,this.timeInAir+=t),this.cameraMode==="first-person")this.camera.position.y=this.model.position.y+this.firstPersonHeadHeight;else{const p=this.model.position.y-o;this.camera.position.y+=p}const d=Ue.some(p=>e[p]===!0);let u="";if(this.isJetpackActive&&!this.isGrounded?u="TPose":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?u="Idle":d&&this.toggleRun?u="Run":d?u="Walk":u="Idle",this.currentAction!==u){const p=this.animationsMap.get(u),y=this.animationsMap.get(this.currentAction);y&&p&&(y.fadeOut(this.fadeDuration),p.reset().fadeIn(this.fadeDuration).play(),this.currentAction=u)}this.mixer.update(t);const f=this.isGrounded||this.timeInAir<=this.airTimeThreshold;if(this.isJetpackActive&&!d&&(this.inertiaVelocityX=0,this.inertiaVelocityZ=0),d&&(f||this.isJetpackActive)){let p;this.cameraMode==="first-person"?p=this.firstPersonYaw:p=Math.atan2(this.camera.position.x-this.model.position.x,this.camera.position.z-this.model.position.z);const y=this.directionOffset(e);this.rotateQuaternion.setFromAxisAngle(this.rotateAngle,p+y),this.model.quaternion.rotateTowards(this.rotateQuaternion,.2),this.camera.getWorldDirection(this.walkDirection),this.walkDirection.y=0,this.walkDirection.normalize(),this.walkDirection.applyAxisAngle(this.rotateAngle,y);const k=this.toggleRun?this.runVelocity:this.walkVelocity;let w=this.walkDirection.x*k*t,C=this.walkDirection.z*k*t;this.isGrounded||(this.inertiaVelocityX=this.walkDirection.x*k,this.inertiaVelocityZ=this.walkDirection.z*k,this.hasInertia=!0);let O=!1,L=null;if(this.isGrounded){const A=Math.sqrt(w*w+C*C),z=this.checkForwardGround(this.walkDirection,A);z.isWalkable||(O=!0,z.normal?L=z.normal.clone():L=new r.Vector3(-this.walkDirection.x,0,-this.walkDirection.z).normalize())}const T=this.checkForwardCollision(this.walkDirection);if(T.hit||O){let A;T.hit?A=T.normal.clone():A=L.clone(),T.hit&&!T.isWalkable&&(A.y=0,A.normalize());const it=this.tempSlideVector.set(w,0,C).dot(A);if(it<0){const tt=w-it*A.x,xt=C-it*A.z;w=tt,C=xt}}this.model.position.x+=w,this.model.position.z+=C,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=w,this.camera.position.z+=C)}else if(this.hasInertia&&!this.isGrounded&&!this.isJetpackActive){let p=this.inertiaVelocityX*t,y=this.inertiaVelocityZ*t;const k=new r.Vector3(this.inertiaVelocityX,0,this.inertiaVelocityZ).normalize(),w=this.checkForwardCollision(k);if(w.hit){const C=w.normal.clone();w.isWalkable||(C.y=0,C.normalize());const L=this.tempSlideVector.set(p,0,y).dot(C);if(L<0){const T=p-L*C.x,A=y-L*C.z;p=T,y=A}}this.model.position.x+=p,this.model.position.z+=y,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=p,this.camera.position.z+=y)}if(this.cameraMode==="first-person"){this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z,this.model.rotation.y=this.firstPersonYaw,this.camera.rotation.order="YXZ",this.camera.rotation.y=this.firstPersonYaw,this.camera.rotation.x=this.firstPersonPitch,this.camera.rotation.z=0;const p=new r.Vector3;this.camera.getWorldDirection(p),this.updateCameraTargetOffset.copy(this.camera.position).add(p),this.orbitControl.target.copy(this.updateCameraTargetOffset)}else{const y=new r.Vector3(0,this.targetOffsetY,0).clone().applyQuaternion(this.model.quaternion);this.updateCameraTargetOffset.x=this.model.position.x+y.x,this.updateCameraTargetOffset.y=this.model.position.y+y.y,this.updateCameraTargetOffset.z=this.model.position.z+y.z,this.orbitControl.target.copy(this.updateCameraTargetOffset)}}directionOffset(t){let e=0;return t[kt]?t[yt]?e=Math.PI/4:t[bt]&&(e=-Math.PI/4):t[Ct]?t[yt]?e=Math.PI/4+Math.PI/2:t[bt]?e=-Math.PI/4-Math.PI/2:e=Math.PI:t[yt]?e=Math.PI/2:t[bt]&&(e=-Math.PI/2),e}updateVRPhysics(t,e,i,s,o,n,l,c,d){const u=t.clone();if(c&&(e.y+=this.jetpackThrust*s),d>0){const w=d/this.jetpackTransitionDuration;e.y+=this.jetpackThrust*w*s,d-=s}if(e.y+=this.gravity*s,e.y<this.maxFallSpeed&&(e.y=this.maxFallSpeed),u.y+=e.y*s,e.y>0){const w=this.checkCeilingCollisionAtPosition(u,o);if(w.hit){const C=w.height;u.y>C&&(u.y=C,e.y=0)}}this.maxHeight!==null&&u.y>this.maxHeight&&(console.log(`[Height Cap VR] Enforcing ceiling: position.y=${u.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),u.y=this.maxHeight,e.y=0);const f=this.getGroundInfoAtPosition(u,o),p=f.height;let y=!0;if(f.normal&&(y=f.normal.dot(new r.Vector3(0,1,0))>=.5),u.y-p<=0&&y?(u.y=p,e.y=0,n=!0,l=0,c&&(c=!1),d=0):(n=!1,l+=s),i&&i.lengthSq()>0){let w=i.x,C=i.z;const O=i.clone().normalize(),L=this.checkForwardCollisionAtPosition(u,O,o);if(L.hit){const T=L.normal.clone();L.isWalkable||(T.y=0,T.normalize());const z=new r.Vector3(w,0,C).dot(T);z<0&&(w=w-z*T.x,C=C-z*T.z)}u.x+=w,u.z+=C}return{newPosition:u,velocity:e,isGrounded:n,airTime:l,jetpackActive:c,jetpackTransitionTimer:d}}getGroundInfoAtPosition(t,e){if(!e||e.length===0)return{height:0,normal:null};const i=Math.max(t.y+10,100),s=new r.Vector3(t.x,i,t.z),o=new r.Vector3(0,-1,0),n=new r.Raycaster;n.set(s,o);const l=n.intersectObjects(e,!0);if(l.length>0){const c=l[0];let d=null;if(c.face&&c.object){d=c.face.normal.clone();const u=new r.Matrix3().getNormalMatrix(c.object.matrixWorld);d.applyMatrix3(u).normalize()}return{height:c.point.y,normal:d}}return{height:-100,normal:null}}checkCeilingCollisionAtPosition(t,e){if(!e||e.length===0)return{hit:!1,height:1/0,distance:1/0};const i=new r.Vector3(t.x,t.y+1,t.z),s=new r.Vector3(0,1,0),o=new r.Raycaster;o.set(i,s),o.far=this.ceilingCollisionDistance;const n=o.intersectObjects(e,!0);if(n.length>0){const l=n[0];return{hit:!0,height:l.point.y,distance:l.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardCollisionAtPosition(t,e,i){if(!i||i.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};const s=new r.Vector3(t.x,t.y+1,t.z),o=new r.Raycaster;o.set(s,e),o.far=this.forwardCollisionDistance;const n=o.intersectObjects(i,!0);if(n.length>0){const l=n[0],c=l.face?l.face.normal.clone():new r.Vector3(0,1,0);if(l.object&&l.face){const f=new r.Matrix3().getNormalMatrix(l.object.matrixWorld);c.applyMatrix3(f).normalize()}const u=c.dot(new r.Vector3(0,1,0))>=.5;return{hit:!0,point:l.point,normal:c,distance:l.distance,isWalkable:u}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}}const Ue=[kt,yt,Ct,bt];class Qe{constructor(){this.base=null,this.thumb=null,this.active=!1,this.originX=0,this.originY=0,this.currentX=0,this.currentY=0,this.maxDistance=40,this.deadzone=.15,this.createElements()}createElements(){this.base=document.createElement("div"),this.base.id="joystick-base",this.base.style.display="none",document.body.appendChild(this.base),this.thumb=document.createElement("div"),this.thumb.id="joystick-thumb",this.base.appendChild(this.thumb)}show(t,e){this.active=!0,this.originX=t,this.originY=e,this.currentX=t,this.currentY=e,this.base.style.left=`${t}px`,this.base.style.top=`${e}px`,this.base.style.display="block",this.thumb.style.transform="translate(0px, 0px)",requestAnimationFrame(()=>{this.base.style.opacity="1"})}update(t,e){if(!this.active)return;this.currentX=t,this.currentY=e;let i=t-this.originX,s=e-this.originY;if(Math.sqrt(i*i+s*s)>this.maxDistance){const n=Math.atan2(s,i);i=Math.cos(n)*this.maxDistance,s=Math.sin(n)*this.maxDistance}this.thumb.style.transform=`translate(${i}px, ${s}px)`}hide(){this.active=!1,this.base.style.opacity="0",setTimeout(()=>{this.active||(this.base.style.display="none")},200)}getDirection(){if(!this.active)return{angle:0,magnitude:0};const t=this.currentX-this.originX,e=this.currentY-this.originY,i=Math.sqrt(t*t+e*e),s=Math.min(i/this.maxDistance,1);return s<this.deadzone?{angle:0,magnitude:0}:{angle:Math.atan2(e,t),magnitude:s}}getKeys(){const{angle:t,magnitude:e}=this.getDirection();if(e===0)return{w:!1,a:!1,s:!1,d:!1};let i=t*180/Math.PI;i<0&&(i+=360);const s={w:!1,a:!1,s:!1,d:!1};return i>=337.5||i<22.5?s.d=!0:i>=22.5&&i<67.5?(s.d=!0,s.w=!0):i>=67.5&&i<112.5?s.s=!0:i>=112.5&&i<157.5?(s.a=!0,s.s=!0):i>=157.5&&i<202.5?s.a=!0:i>=202.5&&i<247.5?(s.a=!0,s.w=!0):i>=247.5&&i<292.5?s.w=!0:i>=292.5&&i<337.5&&(s.d=!0,s.w=!0),s}isActive(){return this.active}}class Ke{constructor(t,e){this.keysPressed=t,this.orbitControls=e,this.joystick=new Qe,this.activeTouchId=null,this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.touchLastX=0,this.touchLastY=0,this.touchHasMoved=!1,this.longPressThreshold=400,this.movementThreshold=10,this.jetpackActive=!1,this.orbitControlsEnabled=!0,this.cameraMode="third-person",this.firstPersonCallback=null,this.isPaintMode=!1,this.paintCallback=null,this.paintEndCallback=null,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.setupEventListeners(),this.startUpdateLoop()}setupEventListeners(){document.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),document.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1}),document.addEventListener("contextmenu",this.handleContextMenu,{passive:!1})}handleTouchStart(t){const e=t.target;if(e&&(e.tagName==="BUTTON"||e.tagName==="SELECT"||e.tagName==="INPUT"||e.tagName==="A"||e.closest("button")||e.closest("select")||e.closest("input")))return;const i=t.changedTouches[0],s=Date.now();this.activeTouchId!==null||this.joystick.isActive()||(this.activeTouchId=i.identifier,this.touchStartTime=s,this.touchStartX=i.clientX,this.touchStartY=i.clientY,this.touchLastX=i.clientX,this.touchLastY=i.clientY,this.touchHasMoved=!1,t.preventDefault())}handleTouchMove(t){let e=null;for(let n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===this.activeTouchId){e=t.changedTouches[n];break}if(!e)return;if(t.preventDefault(),this.joystick.isActive()){this.joystick.update(e.clientX,e.clientY);return}const i=e.clientX-this.touchStartX,s=e.clientY-this.touchStartY;if(Math.sqrt(i*i+s*s)>this.movementThreshold&&(this.touchHasMoved=!0),this.touchHasMoved){const n=e.clientX-this.touchLastX,l=e.clientY-this.touchLastY;this.isPaintMode&&this.paintCallback?this.paintCallback(e.clientX,e.clientY):this.handleCameraRotation(n,l)}this.touchLastX=e.clientX,this.touchLastY=e.clientY}handleTouchEnd(t){for(let e=0;e<t.changedTouches.length;e++)if(t.changedTouches[e].identifier===this.activeTouchId){this.joystick.isActive()&&this.deactivateJoystick(),this.isPaintMode&&this.paintEndCallback&&this.paintEndCallback(),this.activeTouchId=null,this.touchHasMoved=!1;break}}handleCameraRotation(t,e){this.cameraMode==="first-person"?this.firstPersonCallback&&this.firstPersonCallback(t,e):this.orbitControls&&(this.orbitControls.rotateLeft(-t*.005),this.orbitControls.rotateUp(-e*.005),this.orbitControls.update())}activateJoystick(t,e){this.joystick.show(t,e),this.orbitControls&&(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1),console.log("Virtual joystick activated")}deactivateJoystick(){this.joystick.hide(),this.keysPressed.w=!1,this.keysPressed.a=!1,this.keysPressed.s=!1,this.keysPressed.d=!1,this.orbitControls&&this.orbitControlsEnabled&&(this.orbitControls.enabled=!0),console.log("Virtual joystick deactivated")}activateJetpack(){this.jetpackActive=!0,this.keysPressed[" "]=!0,console.log("Jetpack mode activated")}deactivateJetpack(){this.jetpackActive=!1,this.keysPressed[" "]=!1,console.log("Jetpack mode deactivated")}startUpdateLoop(){const t=()=>{if(this.joystick.isActive()){const e=this.joystick.getKeys();this.keysPressed.w=e.w,this.keysPressed.a=e.a,this.keysPressed.s=e.s,this.keysPressed.d=e.d}this.activeTouchId!==null&&!this.joystick.isActive()&&!this.touchHasMoved&&Date.now()-this.touchStartTime>=this.longPressThreshold&&this.activateJoystick(this.touchStartX,this.touchStartY),requestAnimationFrame(t)};t()}setCameraMode(t){this.cameraMode=t,console.log(`TouchControls: Camera mode set to ${t}`)}setFirstPersonCallback(t){this.firstPersonCallback=t}setPaintMode(t){this.isPaintMode=t,this.orbitControls&&(t?(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1):this.orbitControls.enabled=this.orbitControlsEnabled),console.log(`TouchControls: Paint mode ${t?"ON":"OFF"}`)}setPaintCallback(t){this.paintCallback=t}setPaintEndCallback(t){this.paintEndCallback=t}handleContextMenu(t){return t.preventDefault(),!1}disable(){document.removeEventListener("touchstart",this.handleTouchStart),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("touchcancel",this.handleTouchEnd),document.removeEventListener("contextmenu",this.handleContextMenu),this.joystick.isActive()&&this.deactivateJoystick(),console.log("Touch controls disabled")}}async function Ze(){try{const a=await fetch("models/scenes.json");if(!a.ok)throw new Error(`Failed to load scenes manifest: ${a.statusText}`);const t=await a.json();return console.log("Scenes manifest loaded:",t),t}catch(a){throw console.error("Error loading scenes manifest:",a),a}}async function ti(a){try{const t=await fetch(a);if(!t.ok)throw new Error(`Failed to load scene config from ${a}: ${t.statusText}`);const e=await t.json();return ei(e),console.log(`Scene config loaded: ${e.name}`,e),e}catch(t){throw console.error(`Error loading scene config from ${a}:`,t),t}}function ei(a){const t=["name","assets","transform","character","camera","lighting","scene"];for(const e of t)if(!(e in a))throw new Error(`Scene config missing required field: ${e}`);if(!a.assets.splatFile||!a.assets.collisionFile||!a.assets.characterFile)throw new Error("Scene config missing required asset files");if(typeof a.transform.scale!="number")throw new Error("Scene config: transform.scale must be a number");console.log("Scene config validation passed")}function de(a){return a.scenes.map(t=>({id:t.id,name:t.name,description:t.description||"",latitude:t.latitude||0,longitude:t.longitude||0,thumbnail:t.thumbnail||"models/thumbnails/placeholder.jpg"}))}function ii(a){var t;return a.defaultScene||((t=a.scenes[0])==null?void 0:t.id)||"StoneHenge"}function si(a,t){const e=a.scenes.find(i=>i.id===t);return e?e.config:null}class oi{constructor(t,e,i={}){this.context=t,this.destination=e,this.buffer=null,this.source=null,this.gainNode=this.context.createGain(),this.gainNode.gain.value=i.initialGain!==void 0?i.initialGain:0,this.gainNode.connect(this.destination),this.isPlaying=!1}setBuffer(t){this.buffer=t}start(){if(!(this.isPlaying||!this.buffer)){this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.gainNode);try{this.source.start(),this.isPlaying=!0}catch(t){console.warn("LoopedTrack start failed:",t)}}}stop(){if(this.isPlaying){try{this.source.stop()}catch{}try{this.source.disconnect()}catch{}this.source=null,this.isPlaying=!1}}dispose(){this.stop();try{this.gainNode.disconnect()}catch{}this.gainNode=null}}class ni{constructor(t={},e=!1){g(this,"isMobile",!1);g(this,"audioContext",null);g(this,"masterGain",null);g(this,"oneShotGain",null);g(this,"tracks",{background:null,walking:null,running:null,jetpack:null});g(this,"buffers",{background:null,walking:null,running:null,jetpack:null,magicReveal:null});g(this,"backgroundMusicEnabled",!0);g(this,"movementSoundsEnabled",!0);g(this,"backgroundMusicVolume",.3);g(this,"walkingSoundVolume",.25);g(this,"runningSoundVolume",.15);g(this,"jetpackVolume",.5);g(this,"magicRevealVolume",.6);g(this,"fadeSpeed",2);g(this,"backgroundMusicTarget",0);g(this,"walkingSoundTarget",0);g(this,"runningSoundTarget",0);g(this,"jetpackTarget",0);g(this,"currentMovementState","idle");g(this,"previousMovementState","idle");g(this,"audioUnlocked",!1);g(this,"loopedSoundsStarted",!1);g(this,"preloadPromise",null);this.config=t,this.isMobile=e,this.ensureContext(),this.setupGraph(),this.preloadPromise=this.preloadAll().then(()=>{console.log("Audio buffers preloaded")}).catch(i=>{console.warn("Audio preload failed:",i)}),console.log("AudioManager (Web Audio) initialized with config:",t,"mobile:",e)}ensureContext(){if(this.audioContext)return this.audioContext;const t=window.AudioContext||window.webkitAudioContext;return this.audioContext=new t,this.audioContext}setupGraph(){if(this.masterGain)return;const t=this.ensureContext();this.masterGain=t.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(t.destination),this.oneShotGain=t.createGain(),this.oneShotGain.gain.value=this.magicRevealVolume,this.oneShotGain.connect(this.masterGain)}async preloadAll(){const t=[];this.config.backgroundMusic&&!this.buffers.background&&t.push(this.loadBuffer(this.config.backgroundMusic,"background").then(e=>this.buffers.background=e).catch(e=>console.warn("Failed to load background:",e))),this.config.runningSound&&!this.buffers.running&&t.push(this.loadBuffer(this.config.runningSound,"running").then(e=>this.buffers.running=e).catch(e=>console.warn("Failed to load running:",e))),this.config.jetpackSound&&!this.buffers.jetpack&&t.push(this.loadBuffer(this.config.jetpackSound,"jetpack").then(e=>this.buffers.jetpack=e).catch(e=>console.warn("Failed to load jetpack:",e))),!this.isMobile&&this.config.walkingSound&&!this.buffers.walking&&t.push(this.loadBuffer(this.config.walkingSound,"walking").then(e=>this.buffers.walking=e).catch(e=>console.warn("Failed to load walking:",e))),this.config.magicReveal&&!this.buffers.magicReveal&&t.push(this.loadBuffer(this.config.magicReveal,"magicReveal").then(e=>this.buffers.magicReveal=e).catch(e=>console.warn("Failed to load magicReveal:",e))),t.length>0?(console.log(`Loading ${t.length} audio buffers...`),await Promise.allSettled(t),console.log("Audio preload complete (some may have failed)")):console.log("All audio buffers already loaded")}async loadBuffer(t){const e=this.ensureContext(),s=await(await fetch(t)).arrayBuffer();return await new Promise((o,n)=>{try{const l=e.decodeAudioData(s);l&&typeof l.then=="function"?l.then(o).catch(c=>{try{e.decodeAudioData(s,o,n)}catch(d){n(d)}}):e.decodeAudioData(s,o,n)}catch{try{e.decodeAudioData(s,o,n)}catch(c){n(c)}}})}async unlockAudio(){if(this.audioUnlocked){console.log("Audio already unlocked");return}if(this.isMobile){try{if(this.audioContext&&this.audioContext.state!=="closed")try{await this.audioContext.close()}catch{}}catch{}const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.masterGain=null,this.oneShotGain=null,this.tracks={background:null,walking:null,running:null,jetpack:null},this.setupGraph()}const t=this.ensureContext();try{await t.resume()}catch(e){console.warn("AudioContext resume failed:",e)}try{await this.preloadAll()}catch(e){console.warn("Continuing without all audio buffers:",e)}this.startOrCreateTrack("background",this.buffers.background),this.isMobile||this.startOrCreateTrack("walking",this.buffers.walking),this.startOrCreateTrack("running",this.buffers.running),this.startOrCreateTrack("jetpack",this.buffers.jetpack),this.audioUnlocked=!0,this.loopedSoundsStarted=!0,console.log("âœ“ Web Audio unlocked, looped tracks running at gain 0")}startOrCreateTrack(t,e){e&&(this.tracks[t]||(this.tracks[t]=new oi(this.audioContext,this.masterGain,{initialGain:0}),this.tracks[t].setBuffer(e)),this.tracks[t].start())}playMagicReveal(t=0){if(!this.buffers.magicReveal)return;const e=()=>{try{const i=this.audioContext.createBufferSource(),s=this.audioContext.createGain();s.gain.value=this.magicRevealVolume,i.buffer=this.buffers.magicReveal,i.connect(s).connect(this.masterGain),i.start(),i.onended=()=>{try{i.disconnect()}catch{}try{s.disconnect()}catch{}}}catch(i){console.warn("Magic reveal play failed:",i)}};t>0?setTimeout(e,t*1e3):e()}startBackgroundMusic(){this.backgroundMusicEnabled&&(this.backgroundMusicTarget=this.backgroundMusicVolume,console.log("Background music fading in"))}stopBackgroundMusic(){this.backgroundMusicTarget=0,console.log("Background music fading out")}updateMovementSounds(t){if(this.previousMovementState=this.currentMovementState,this.currentMovementState=t,this.previousMovementState!==this.currentMovementState&&console.log(`Movement state changed: ${this.previousMovementState} -> ${t}`),!this.movementSoundsEnabled){this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0;return}t==="walk"?(this.isMobile?this.walkingSoundTarget=0:this.walkingSoundTarget=this.walkingSoundVolume,this.runningSoundTarget=0,this.jetpackTarget=0):t==="run"?(this.walkingSoundTarget=0,this.runningSoundTarget=this.runningSoundVolume,this.jetpackTarget=0):t==="jetpack"?(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=this.jetpackVolume):(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0)}update(t){this.rampGainTo("background",this.backgroundMusicTarget,t),this.isMobile||this.rampGainTo("walking",this.walkingSoundTarget,t),this.rampGainTo("running",this.runningSoundTarget,t),this.rampGainTo("jetpack",this.jetpackTarget,t)}rampGainTo(t,e,i){const s=this.tracks[t];if(!s||!s.gainNode)return;const o=s.gainNode.gain.value;if(o===e)return;const n=this.fadeSpeed*i,l=o<e?Math.min(e,o+n):Math.max(e,o-n),c=this.audioContext.currentTime;try{s.gainNode.gain.cancelScheduledValues(c),s.gainNode.gain.setValueAtTime(o,c),s.gainNode.gain.linearRampToValueAtTime(l,c+.05)}catch{s.gainNode.gain.value=l}}toggleBackgroundMusic(){this.backgroundMusicEnabled=!this.backgroundMusicEnabled,this.backgroundMusicEnabled?this.startBackgroundMusic():this.stopBackgroundMusic(),console.log("Background music:",this.backgroundMusicEnabled?"ON":"OFF")}toggleMovementSounds(){this.movementSoundsEnabled=!this.movementSoundsEnabled,this.movementSoundsEnabled||(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0),console.log("Movement sounds:",this.movementSoundsEnabled?"ON":"OFF")}setMasterVolume(t){const e=Math.max(0,Math.min(1,t));this.backgroundMusicVolume=e*.3,this.walkingSoundVolume=e*.25,this.runningSoundVolume=e*.15,this.jetpackVolume=e*.5,this.oneShotGain&&(this.oneShotGain.gain.value=this.magicRevealVolume*e),console.log("Master volume set to:",e)}dispose(){Object.values(this.tracks).forEach(t=>{t&&t.dispose()}),this.tracks={background:null,walking:null,running:null,jetpack:null};try{this.oneShotGain&&this.oneShotGain.disconnect()}catch{}try{this.masterGain&&this.masterGain.disconnect()}catch{}try{this.audioContext.suspend()}catch{}console.log("AudioManager (Web Audio) disposed")}}class ai{constructor(t,e,i,s){this.renderer=t,this.camera=e,this.scene=i,this.sceneConfig=s,this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.xrConfig=(s==null?void 0:s.xr)||{enabled:!0,referenceSpaceType:"local-floor",referenceSpaceOrigin:{position:{x:0,y:0,z:0},rotation:{y:0}},userHeight:1.6},this.vrVelocity=new r.Vector3,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1,this.jetpackTransitionTimer=0,this.moveSpeed=5,this.runSpeedMultiplier=2,this.isRunning=!1,this.teleportTarget=null,this.teleportReticle=null,this.isTeleporting=!1,this.characterControls=null,this.orbitControls=null,this.xrControllers=null,this.xrHands=null,this.gaussianSplat=null,this.worldOffset=new r.Vector3,this.yRotation=0,this.xRotation=0,this.actualReferenceOrigin=null,this.characterPosition=new r.Vector3,this.init()}async init(){if(!this.xrConfig.enabled){console.log("XR disabled in scene config");return}this.renderer.xr.enabled=!0,await this.createVRButton(),this.renderer.xr.addEventListener("sessionstart",this.onSessionStart.bind(this)),this.renderer.xr.addEventListener("sessionend",this.onSessionEnd.bind(this)),this.createTeleportReticle(),console.log("XRManager initialized",this.xrConfig)}async createVRButton(){if(!navigator.xr){console.log("WebXR not available, VR button hidden");return}try{if(!await navigator.xr.isSessionSupported("immersive-vr")){console.log("immersive-vr not supported, VR button hidden");return}const e=Be.createButton(this.renderer);e.style.position="fixed",e.style.bottom="90px",e.style.right="30px",e.style.zIndex="1000",document.body.appendChild(e),this.vrButton=e,console.log("WebXR available, VR button shown")}catch(t){console.warn("Error checking WebXR support:",t)}}createTeleportReticle(){const t=new r.RingGeometry(.2,.25,32),e=new r.MeshBasicMaterial({color:65280,side:r.DoubleSide,transparent:!0,opacity:.8});this.teleportReticle=new r.Mesh(t,e),this.teleportReticle.rotation.x=-Math.PI/2,this.teleportReticle.visible=!1,this.scene.add(this.teleportReticle)}async onSessionStart(){var t,e,i;if(console.log("XR session starting..."),this.session=this.renderer.xr.getSession(),this.isXRActive=!0,this.gaussianSplat){this.gaussianSplat.visible=!0,console.log("Gaussian splat visibility ensured for VR mode:",this.gaussianSplat.visible);let s=this.gaussianSplat.parent,o=0;for(;s&&o<5;)console.log(`  Parent ${o}:`,s.type||s.constructor.name),s=s.parent,o++}else console.warn("Gaussian splat reference not set in XRManager");try{const s=this.xrConfig.referenceSpaceType||"local-floor";try{this.localSpace=await this.session.requestReferenceSpace(s),console.log(`XR reference space type: ${s}`)}catch{console.warn(`${s} not supported, falling back to 'local'`),this.localSpace=await this.session.requestReferenceSpace("local")}const o=((e=(t=this.sceneConfig)==null?void 0:t.character)==null?void 0:e.spawn)||{},n=o.position||{x:0,y:"auto",z:40},l=o.rotation||{y:0},c=n.x,d=n.z,u=((i=this.characterControls)==null?void 0:i.groundMeshes)||[];let f=0;if(u.length>0&&this.characterControls){const k=new r.Vector3(c,1e3,d);f=this.characterControls.getGroundInfoAtPosition(k,u).height,f<-50?(console.warn(`No ground found at XR spawn (${c}, ${d}), using Y=0`),f=0):console.log(`Ground height at XR spawn (${c}, ${d}): ${f.toFixed(2)}`)}const p=this.xrConfig.userHeight||1.6,y={x:c,y:f,z:d};this.actualReferenceOrigin={position:y,rotation:l,userHeight:p},this.characterPosition.set(y.x,y.y,y.z),this.setReferenceSpaceOrigin(y,l),console.log("XR reference space initialized at:",y),console.log("Character position (play space center):",this.characterPosition)}catch(s){console.error("Failed to request reference space:",s)}this.orbitControls&&(this.orbitControls.enabled=!1),this.hideNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!1),this.xrControllers&&this.xrControllers.enable(),this.xrHands&&this.xrHands.enable(),this.vrVelocity.set(0,0,0),this.worldOffset.set(0,0,0),this.yRotation=0,this.xRotation=0,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1}onSessionEnd(){console.log("XR session ended"),this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.actualReferenceOrigin=null,this.characterPosition.set(0,0,0),this.orbitControls&&(this.orbitControls.enabled=!0),this.showNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!0),this.xrControllers&&this.xrControllers.disable(),this.xrHands&&this.xrHands.disable(),this.teleportReticle.visible=!1}setReferenceSpaceOrigin(t,e){if(!this.localSpace)return;const i=t||{x:0,y:0,z:0},s=e||{y:0},o=new r.PerspectiveCamera;o.position.set(i.x,i.y,i.z),o.rotation.order="YXZ",o.rotation.y=s.y*(Math.PI/180),o.updateMatrixWorld();const n=o.quaternion,l=new XRRigidTransform({x:i.x,y:i.y,z:i.z},{x:n.x,y:n.y,z:n.z,w:n.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(l.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace),this.worldOffset.set(0,0,0)}updateReferenceSpaceByOffset(t){if(!this.currentReferenceSpace||!this.localSpace)return;this.worldOffset.add(t);const e=this.actualReferenceOrigin||this.xrConfig.referenceSpaceOrigin,i=e.position||{x:0,y:0,z:0},s=e.rotation||{y:0},o={x:i.x+this.worldOffset.x,y:i.y+this.worldOffset.y,z:i.z+this.worldOffset.z},n=new r.PerspectiveCamera;n.position.set(o.x,o.y,o.z),n.rotation.order="YXZ",n.rotation.y=s.y*(Math.PI/180)+this.yRotation,n.rotation.x=this.xRotation,n.updateMatrixWorld();const l=n.quaternion,c=new XRRigidTransform({x:o.x,y:o.y,z:o.z},{x:l.x,y:l.y,z:l.z,w:l.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(c.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace)}teleportTo(t){if(!this.isXRActive)return;const e=t.clone(),i=new r.Vector3().subVectors(e,this.characterPosition);this.characterPosition.copy(e),this.updateReferenceSpaceByOffset(i),console.log("Teleported to ground:",t,"character at feet:",e)}updateTeleportTarget(t){t?(this.teleportReticle.position.copy(t),this.teleportReticle.visible=!0,this.teleportTarget=t.clone()):(this.teleportReticle.visible=!1,this.teleportTarget=null)}executeTeleport(){this.teleportTarget&&(this.teleportTo(this.teleportTarget),this.teleportReticle.visible=!1,this.teleportTarget=null)}handleThumbstickMovement(t,e){if(!this.isXRActive||t.lengthSq()<.01)return;const i=this.renderer.xr.getCamera(),s=new r.Vector3(0,0,-1),o=new r.Vector3(1,0,0),n=Math.atan2(i.matrixWorld.elements[8],i.matrixWorld.elements[10]);s.applyAxisAngle(new r.Vector3(0,1,0),n),o.applyAxisAngle(new r.Vector3(0,1,0),n);const l=new r.Vector3().addScaledVector(s,-t.y).addScaledVector(o,t.x);l.y=0,l.normalize();const c=this.moveSpeed*(this.isRunning?this.runSpeedMultiplier:1);return l.multiplyScalar(c*e)}handleThumbstickRotation(t,e){if(!this.isXRActive||!t)return;const i=2,s=.15,o=Math.PI/2-.1;let n=!1;if(Math.abs(t.x)>s){const l=-t.x*i*e;this.yRotation+=l,n=!0}if(Math.abs(t.y)>s){const l=-t.y*i*e;this.xRotation+=l,this.xRotation=Math.max(-o,Math.min(o,this.xRotation)),n=!0}n&&this.updateReferenceSpaceByOffset(new r.Vector3)}updateVRPhysics(t,e){if(!this.isXRActive||!this.characterControls)return;const i=this.characterPosition.clone();let s=new r.Vector3;if(this.xrControllers){const l=this.xrControllers.getThumbstickAxes();l&&(s=this.handleThumbstickMovement(l,t)||new r.Vector3);const c=this.xrControllers.getRightThumbstickAxes();c&&this.handleThumbstickRotation(c,t)}const o=this.characterControls.updateVRPhysics(i,this.vrVelocity,s,t,e,this.isGrounded,this.airTime,this.jetpackActive,this.jetpackTransitionTimer);this.vrVelocity.copy(o.velocity),this.isGrounded=o.isGrounded,this.airTime=o.airTime,this.jetpackActive=o.jetpackActive,this.jetpackTransitionTimer=o.jetpackTransitionTimer;const n=new r.Vector3().subVectors(o.newPosition,i);n.lengthSq()>1e-4&&(this.characterPosition.copy(o.newPosition),this.updateReferenceSpaceByOffset(n),Math.random()<.01&&console.log("VR Physics:",{characterY:this.characterPosition.y.toFixed(2),deltaY:n.y.toFixed(3),isGrounded:o.isGrounded,velocity:this.vrVelocity.y.toFixed(2)}))}update(t,e){this.isXRActive&&(this.updateVRPhysics(t,e),this.xrControllers&&this.xrControllers.update(t),this.xrHands&&this.xrHands.update())}hideNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="none");const e=document.getElementById("camera-toggle");e&&(e.style.display="none");const i=document.getElementById("key-display");i&&(i.style.display="none")}showNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="block");const e=document.getElementById("camera-toggle");e&&(e.style.display="block");const i=document.getElementById("key-display");i&&(i.style.display="block")}getIsXRActive(){return this.isXRActive}getXRCamera(){return this.isXRActive?this.renderer.xr.getCamera():null}onJumpPressed(){this.isGrounded&&(this.vrVelocity.y=this.characterControls.jumpForce,this.isGrounded=!1,this.airTime=0)}onJetpackPressed(t){this.airTime>.4&&(this.jetpackActive=t)}onRunToggle(){this.isRunning=!this.isRunning,console.log("Run mode:",this.isRunning?"ON":"OFF")}onResetPitch(){this.xRotation=0,console.log("Camera pitch reset to flat (0 degrees)"),this.updateReferenceSpaceByOffset(new r.Vector3)}dispose(){this.vrButton&&this.vrButton.parentNode&&this.vrButton.parentNode.removeChild(this.vrButton),this.teleportReticle&&(this.scene.remove(this.teleportReticle),this.teleportReticle.geometry.dispose(),this.teleportReticle.material.dispose()),this.renderer.xr.removeEventListener("sessionstart",this.onSessionStart),this.renderer.xr.removeEventListener("sessionend",this.onSessionEnd)}}class ri{constructor(t,e,i){this.renderer=t,this.scene=e,this.xrManager=i,this.controller0=null,this.controller1=null,this.controllerGrip0=null,this.controllerGrip1=null,this.controllerModelFactory=new $e,this.rayLine0=null,this.rayLine1=null,this.leftThumbstickAxes=new r.Vector2,this.rightThumbstickAxes=new r.Vector2,this.thumbstickAxes=new r.Vector2,this.isSelectPressed=!1,this.isSqueezePressed=!1,this.squeezeHoldTime=0,this.buttonAPressed=!1,this.buttonBPressed=!1,this.rightStickPressed=!1,this.buttonACooldown=0,this.buttonBCooldown=0,this.rightStickCooldown=0,this.buttonCooldownDuration=.3,this.isPaintMode=!1,this.colorPalette=null,this.paletteColors=[{name:"Red",hex:16711680},{name:"Orange",hex:16746496},{name:"Yellow",hex:16776960},{name:"Green",hex:65280},{name:"Cyan",hex:65535},{name:"Blue",hex:255},{name:"Purple",hex:8913151},{name:"Magenta",hex:16711935},{name:"White",hex:16777215},{name:"Gray",hex:8421504},{name:"Black",hex:0},{name:"Brown",hex:9127187}],this.currentColorIndex=4,this.raycaster=new r.Raycaster,this.groundMeshes=[],this.isEnabled=!1}init(){this.controller0=this.renderer.xr.getController(0),this.controller0.addEventListener("selectstart",this.onSelectStart.bind(this,0)),this.controller0.addEventListener("selectend",this.onSelectEnd.bind(this,0)),this.controller0.addEventListener("squeezestart",this.onSqueezeStart.bind(this,0)),this.controller0.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,0)),this.scene.add(this.controller0),this.controller1=this.renderer.xr.getController(1),this.controller1.addEventListener("selectstart",this.onSelectStart.bind(this,1)),this.controller1.addEventListener("selectend",this.onSelectEnd.bind(this,1)),this.controller1.addEventListener("squeezestart",this.onSqueezeStart.bind(this,1)),this.controller1.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,1)),this.scene.add(this.controller1),this.controllerGrip0=this.renderer.xr.getControllerGrip(0),this.controllerGrip0.add(this.controllerModelFactory.createControllerModel(this.controllerGrip0)),this.scene.add(this.controllerGrip0),this.controllerGrip1=this.renderer.xr.getControllerGrip(1),this.controllerGrip1.add(this.controllerModelFactory.createControllerModel(this.controllerGrip1)),this.scene.add(this.controllerGrip1),this.rayLine0=this.createRayLine(),this.controller0.add(this.rayLine0),this.rayLine1=this.createRayLine(),this.controller1.add(this.rayLine1),console.log("XR Controllers initialized")}createRayLine(){const t=new r.BufferGeometry,e=new Float32Array([0,0,0,0,0,-5]);t.setAttribute("position",new r.BufferAttribute(e,3));const i=new r.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.6}),s=new r.Line(t,i);return s.visible=!1,s}enable(){this.isEnabled=!0,this.controller0||this.init()}disable(){this.isEnabled=!1,this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1)}onSelectStart(t,e){console.log(`Controller ${t} select start - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!0;const i=t===0?this.rayLine0:this.rayLine1;i&&(i.visible=!0,i.material.color.setHex(65280)),this.isPaintMode?(console.log("Paint mode active - setting isDragging to true"),this.isDragging=!0):console.log("NOT in paint mode - will teleport on release")}onSelectEnd(t,e){console.log(`Controller ${t} select end - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!1;const i=t===0?this.rayLine0:this.rayLine1;if(i&&(i.visible=!1),this.isPaintMode){if(console.log("Paint mode - checking color selection"),this.checkColorSelection(t)){console.log("Color selected from palette");return}console.log("Stopping paint (isDragging = false)"),this.isDragging=!1}else console.log("NOT in paint mode - executing teleport"),this.xrManager.executeTeleport()}onSqueezeStart(t,e){console.log(`Controller ${t} squeeze start`),this.isSqueezePressed=!0,this.squeezeHoldTime=0,this.xrManager.onJumpPressed()}onSqueezeEnd(t,e){console.log(`Controller ${t} squeeze end`),this.isSqueezePressed=!1,this.xrManager.onJetpackPressed(!1)}getThumbstickAxes(){const t=this.renderer.xr.getSession();if(!t)return null;this.leftThumbstickAxes.set(0,0),this.rightThumbstickAxes.set(0,0);for(const e of t.inputSources)if(e.gamepad&&e.handedness){const i=e.gamepad,s=e.handedness==="left";if(i.axes.length>=4){const o=i.axes[2],n=i.axes[3];s?this.leftThumbstickAxes.set(o,n):this.rightThumbstickAxes.set(o,n)}i.buttons.length>4&&i.buttons[4].pressed?!this.buttonAPressed&&this.buttonACooldown<=0&&(this.buttonAPressed=!0,this.buttonACooldown=this.buttonCooldownDuration,this.xrManager.onRunToggle()):this.buttonAPressed=!1,i.buttons.length>5&&i.buttons[5].pressed?!this.buttonBPressed&&this.buttonBCooldown<=0?(this.buttonBPressed=!0,this.buttonBCooldown=this.buttonCooldownDuration,console.log(`B/Y button pressed - toggling paint mode (cooldown: ${this.buttonCooldownDuration}s)`),this.togglePaintMode()):this.buttonBCooldown>0:this.buttonBPressed=!1,!s&&i.buttons.length>3&&i.buttons[3].pressed?!this.rightStickPressed&&this.rightStickCooldown<=0&&(this.rightStickPressed=!0,this.rightStickCooldown=this.buttonCooldownDuration,console.log("Right stick pressed - resetting camera pitch to flat"),this.xrManager.onResetPitch()):s||(this.rightStickPressed=!1)}return this.leftThumbstickAxes.lengthSq()>.01?(this.thumbstickAxes.copy(this.leftThumbstickAxes),this.thumbstickAxes):(this.thumbstickAxes.set(0,0),this.thumbstickAxes)}getRightThumbstickAxes(){return this.rightThumbstickAxes}togglePaintMode(){this.isPaintMode=!this.isPaintMode,this.isPaintMode?(console.log("VR Paint mode: ON"),this.showColorPalette(),this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1),this.xrManager.updateTeleportTarget(null)):(console.log("VR Paint mode: OFF"),this.hideColorPalette())}createColorPalette(){this.colorPalette=new r.Group;const t=new r.SphereGeometry(.03,16,16),e=.08;this.paletteColors.forEach((i,s)=>{const o=new r.MeshBasicMaterial({color:i.hex}),n=new r.Mesh(t,o),l=Math.floor(s/3),c=s%3;n.position.set(c*e-e,-l*e,0),n.userData={isColorPicker:!0,colorIndex:s,colorHex:i.hex,colorName:i.name},this.colorPalette.add(n)}),this.colorPalette.position.set(.15,0,-.3),this.colorPalette.visible=!1,this.controller1&&this.controller1.add(this.colorPalette),console.log("VR color palette created")}showColorPalette(){this.colorPalette||this.createColorPalette(),this.colorPalette&&(this.colorPalette.visible=!0)}hideColorPalette(){this.colorPalette&&(this.colorPalette.visible=!1)}checkColorSelection(t){if(!this.isPaintMode||!this.colorPalette||!this.colorPalette.visible)return!1;const e=t===0?this.controller0:this.controller1;if(!e)return!1;const i=new r.Matrix4;i.identity().extractRotation(e.matrixWorld),this.raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(i);const s=this.raycaster.intersectObjects(this.colorPalette.children,!1);if(s.length>0){const o=s[0].object;if(o.userData.isColorPicker)return this.currentColorIndex=o.userData.colorIndex,console.log(`Selected color: ${o.userData.colorName}`),o.scale.set(1.3,1.3,1.3),setTimeout(()=>{o.scale.set(1,1,1)},200),!0}return!1}getRayForPainting(t){if(!this.isPaintMode)return null;const e=t===0?this.controller0:this.controller1;if(!e)return null;const i=new r.Matrix4;i.identity().extractRotation(e.matrixWorld);const s=new r.Vector3;s.setFromMatrixPosition(e.matrixWorld);const o=new r.Vector3(0,0,-1);return o.applyMatrix4(i).normalize(),{origin:s,direction:o}}raycastForTeleport(t){if(!t||this.groundMeshes.length===0)return null;const e=new r.Matrix4;e.identity().extractRotation(t.matrixWorld);const i=this.raycaster;i.ray.origin.setFromMatrixPosition(t.matrixWorld),i.ray.direction.set(0,0,-1).applyMatrix4(e);const s=i.intersectObjects(this.groundMeshes,!1);return s.length>0?s[0].point:null}update(t){if(this.isEnabled){if(this.isSqueezePressed?(this.squeezeHoldTime+=t,this.squeezeHoldTime>.4&&this.xrManager.onJetpackPressed(!0)):this.squeezeHoldTime=0,this.buttonACooldown>0&&(this.buttonACooldown-=t),this.buttonBCooldown>0&&(this.buttonBCooldown-=t),this.rightStickCooldown>0&&(this.rightStickCooldown-=t),this.isSelectPressed&&!this.isPaintMode){const e=this.raycastForTeleport(this.controller0);this.xrManager.updateTeleportTarget(e),this.rayLine0&&this.rayLine0.material.color.setHex(e?65280:16711680)}else this.xrManager.updateTeleportTarget(null);this.getThumbstickAxes()}}setGroundMeshes(t){this.groundMeshes=t}dispose(){this.rayLine0&&(this.rayLine0.geometry.dispose(),this.rayLine0.material.dispose()),this.rayLine1&&(this.rayLine1.geometry.dispose(),this.rayLine1.material.dispose()),this.controller0&&(this.controller0.removeEventListener("selectstart",this.onSelectStart),this.controller0.removeEventListener("selectend",this.onSelectEnd),this.controller0.removeEventListener("squeezestart",this.onSqueezeStart),this.controller0.removeEventListener("squeezeend",this.onSqueezeEnd)),this.controller1&&(this.controller1.removeEventListener("selectstart",this.onSelectStart),this.controller1.removeEventListener("selectend",this.onSelectEnd),this.controller1.removeEventListener("squeezestart",this.onSqueezeStart),this.controller1.removeEventListener("squeezeend",this.onSqueezeEnd))}}class li{constructor(t,e,i){this.renderer=t,this.scene=e,this.characterModel=i,this.hand0=null,this.hand1=null,this.handModelFactory=new He,this.rightHandMesh=null,this.leftHandMesh=null,this.rightHandFallback=null,this.leftHandFallback=null,this.isEnabled=!1,this.handInputState={left:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null},right:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null}}}init(){this.hand0=this.renderer.xr.getHand(0),this.hand1=this.renderer.xr.getHand(1);try{this.rightHandMesh=this.handModelFactory.createHandModel(this.hand0,"mesh"),this.hand0.add(this.rightHandMesh),this.scene.add(this.hand0)}catch{console.warn("Hand tracking model 0 not available, using fallback")}try{this.leftHandMesh=this.handModelFactory.createHandModel(this.hand1,"mesh"),this.hand1.add(this.leftHandMesh),this.scene.add(this.hand1)}catch{console.warn("Hand tracking model 1 not available, using fallback")}this.createFallbackHands(),console.log("XR Hands initialized")}createFallbackHands(){const t=new r.Group,e=new r.SphereGeometry(.04,16,16),i=new r.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),s=new r.Mesh(e,i);t.add(s);const o=new r.CylinderGeometry(.01,.01,.08,8),n=new r.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),l=new r.Mesh(o,n);l.position.set(0,0,-.06),l.rotation.x=Math.PI/2,t.add(l);const c=new r.SphereGeometry(.012,8,8),d=new r.Mesh(c,n);d.position.set(0,0,-.1),t.add(d),this.rightHandFallback=t,this.rightHandFallback.visible=!1,this.scene.add(this.rightHandFallback);const u=t.clone();this.leftHandFallback=u,this.leftHandFallback.visible=!1,this.scene.add(this.leftHandFallback)}enable(){this.isEnabled=!0,this.hand0||this.init(),this.updateFallbackVisibility()}disable(){this.isEnabled=!1,this.rightHandFallback&&(this.rightHandFallback.visible=!1),this.leftHandFallback&&(this.leftHandFallback.visible=!1)}updateFallbackVisibility(){if(!this.isEnabled)return;const t=this.renderer.xr.getSession();if(!t)return;let e=!1;for(const i of t.inputSources)if(i.hand){e=!0;break}this.rightHandFallback&&(this.rightHandFallback.visible=this.isEnabled&&!e),this.leftHandFallback&&(this.leftHandFallback.visible=this.isEnabled&&!e)}update(){if(this.isEnabled){if(this.updateFallbackVisibility(),this.rightHandFallback&&this.rightHandFallback.visible){const t=this.renderer.xr.getController(0);t&&(this.rightHandFallback.position.copy(t.position),this.rightHandFallback.quaternion.copy(t.quaternion))}if(this.leftHandFallback&&this.leftHandFallback.visible){const t=this.renderer.xr.getController(1);t&&(this.leftHandFallback.position.copy(t.position),this.leftHandFallback.quaternion.copy(t.quaternion))}}}animateGrip(t,e){const i=t===0?this.rightHandFallback:this.leftHandFallback;if(!i||!i.visible)return;const s=i.children[1];s&&(s.scale.y=1-e*.3)}getJointPosition(t,e){if(!t)return null;const i=t.get(e);if(!i)return null;const s=this.renderer.xr.getFrame(),o=this.renderer.xr.getReferenceSpace();if(!s||!o)return null;const n=s.getJointPose(i,o);return n?new r.Vector3().setFromMatrixPosition(new r.Matrix4().fromArray(n.transform.matrix)):null}getPinchDistance(t){const e=this.getJointPosition(t,"thumb-tip"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:e.distanceTo(i)}getPointingDirection(t){const e=this.getJointPosition(t,"wrist"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:new r.Vector3().subVectors(i,e).normalize()}getPalmNormal(t){if(!t)return null;const e=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(!e||!i)return null;const s=t.get("wrist");if(!s)return null;const o=e.getJointPose(s,i);if(!o)return null;const n=new r.Matrix4().fromArray(o.transform.matrix),l=new r.Vector3(0,1,0);return l.applyMatrix4(n),l.sub(new r.Vector3().setFromMatrixPosition(n)),l.normalize()}resetGestureState(t){t!=="left"&&t!=="right"||(this.handInputState[t]={isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null})}resetAllGestureStates(){this.resetGestureState("left"),this.resetGestureState("right")}dispose(){this.resetAllGestureStates(),this.rightHandFallback&&(this.scene.remove(this.rightHandFallback),this.rightHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.leftHandFallback&&(this.scene.remove(this.leftHandFallback),this.leftHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.hand0&&this.scene.remove(this.hand0),this.hand1&&this.scene.remove(this.hand1)}}const ci=.015,hi=300,di=500,ui=.003,Qt=.3,mi=.6,fi=600,S={IDLE:"idle",PAINTING:"painting",MOVING:"moving",JETPACK:"jetpack",MOVING_JETPACK:"moving_jetpack",TELEPORTING:"teleporting"};class pi{constructor(t,e,i=null){this.xrHands=t,this.xrManager=e,this.wristPalette=i,this.mode=S.IDLE,this.activePainterHand=null,this.paintModeEnabled=!1,this.isTeleporting=!1,this.callbacks={onPaintStart:null,onPaintDrag:null,onPaintEnd:null,onMovementStart:null,onMovementUpdate:null,onMovementEnd:null,onJetpackStart:null,onJetpackEnd:null,onColorSelect:null,onTeleportStart:null,onTeleportUpdate:null,onTeleportEnd:null,onTogglePaintMode:null},this.selectedColorIndex=6,console.log("GestureDetector initialized with proven LDIPlayer patterns")}setWristPalette(t){this.wristPalette=t}update(t,e){if(t){for(const i of t.inputSources)if(i.hand){const s=i.hand,o=i.handedness;if(o!=="left"&&o!=="right")continue;this.updateHandGestures(s,o,e)}this.updateMode(e)}}updateHandGestures(t,e,i){const s=this.xrHands.handInputState[e],o=this.xrHands.getPinchDistance(t);if(o===null)return;const n=performance.now();if(o<ci)if(s.isPinching)this.onPinchSustain(t,e,s,i);else{s.isPinching=!0,s.pinchStartTime=n;const l=this.xrHands.getJointPosition(t,"index-finger-tip");l&&(s.dragStartPosition={x:l.x,y:l.y,z:l.z}),this.onPinchStart(t,e,i)}else if(s.isPinching){const l=n-s.pinchStartTime;this.onPinchRelease(t,e,s,l,n),s.isPinching=!1,s.dragStartPosition=null}}onPinchStart(t,e,i){console.log(`${e} pinch start`),this.mode,S.IDLE}onPinchSustain(t,e,i,s){const o=this.xrHands.getJointPosition(t,"index-finger-tip");if(!o||!i.dragStartPosition)return;const n=o.x-i.dragStartPosition.x,l=o.y-i.dragStartPosition.y,c=o.z-i.dragStartPosition.z,d=Math.sqrt(n*n+l*l+c*c);if(e==="left"&&!this.paintModeEnabled){const u=this.xrHands.getJointPosition(t,"wrist");if(u&&o){const f=u.clone(),p=new r.Vector3().subVectors(o,u).normalize();this.isTeleporting?this.callbacks.onTeleportUpdate&&this.callbacks.onTeleportUpdate(f,p):(this.isTeleporting=!0,this.mode=S.TELEPORTING,console.log("LEFT hand teleportation started"),this.callbacks.onTeleportStart&&this.callbacks.onTeleportStart(f,p))}return}d>ui&&(this.mode===S.IDLE&&this.paintModeEnabled&&this.activePainterHand===null&&this.startPainting(t,e),this.mode===S.PAINTING&&this.activePainterHand===e&&this.updatePainting(t,e))}onPinchRelease(t,e,i,s,o){if(console.log(`${e} pinch release (duration: ${s}ms)`),e==="left"&&this.isTeleporting){const n=this.xrHands.getJointPosition(t,"wrist"),l=this.xrHands.getJointPosition(t,"index-finger-tip");if(n&&l){const c=n.clone(),d=new r.Vector3().subVectors(l,n).normalize();console.log("LEFT hand teleportation executed"),this.callbacks.onTeleportEnd&&this.callbacks.onTeleportEnd(c,d)}this.isTeleporting=!1,this.mode=S.IDLE;return}s<hi?(o-i.lastTapTime<di?(i.tapCount++,console.log(`${e} double-tap detected (count: ${i.tapCount})`),this.onDoubleTap(e)):(i.tapCount=1,console.log(`${e} tap 1/2`),this.onSingleTap(t,e)),i.lastTapTime=o):(console.log(`${e} hold/drag end (duration: ${s}ms)`),this.mode===S.PAINTING&&this.activePainterHand===e&&this.endPainting(e),this.mode===S.JETPACK&&e==="right"&&this.endJetpack(e))}onSingleTap(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(!i||!s)return;const o=i.clone(),n=new r.Vector3().subVectors(s,i).normalize();if(this.wristPalette&&this.wristPalette.checkToggleButtonHover(o,n)){const l=this.wristPalette.togglePaintMode();this.paintModeEnabled=l,this.callbacks.onTogglePaintMode&&this.callbacks.onTogglePaintMode(l),console.log(`Paint mode toggled via wrist button: ${l?"ON":"OFF"}`);return}if(this.paintModeEnabled&&this.callbacks.onColorSelect){this.callbacks.onColorSelect(o,n);return}}onDoubleTap(t){console.log(`${t} double-tap action`)}startPainting(t,e){this.mode=S.PAINTING,this.activePainterHand=e;const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&s){const o=i.clone(),n=new r.Vector3().subVectors(s,i).normalize();console.log(`Painting started with ${e} hand`),this.callbacks.onPaintStart&&this.callbacks.onPaintStart(e,o,n)}}updatePainting(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&s){const o=i.clone(),n=new r.Vector3().subVectors(s,i).normalize();this.callbacks.onPaintDrag&&this.callbacks.onPaintDrag(e,o,n)}}endPainting(t){console.log(`Painting ended with ${t} hand`),this.mode=S.IDLE,this.activePainterHand=null,this.callbacks.onPaintEnd&&this.callbacks.onPaintEnd(t)}startJetpack(t){this.mode===S.MOVING?this.mode=S.MOVING_JETPACK:this.mode=S.JETPACK,console.log(`Jetpack started with ${t} hand`),this.callbacks.onJetpackStart&&this.callbacks.onJetpackStart(t)}endJetpack(t){console.log(`Jetpack ended with ${t} hand`),this.mode===S.MOVING_JETPACK?this.mode=S.MOVING:this.mode=S.IDLE,this.callbacks.onJetpackEnd&&this.callbacks.onJetpackEnd(t)}updateMode(t){this.mode!==S.PAINTING&&this.checkMovementGesture(t),this.mode!==S.PAINTING&&this.checkJetpackGesture()}checkMovementGesture(t){const e=this.xrManager.renderer.xr.getSession();if(!e){console.log("[Movement] No XR session");return}let i=null;for(const l of e.inputSources)if(l.hand&&l.handedness==="left"){i=l.hand;break}if(!i){console.log("[Movement] No left hand found");return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getJointPosition(i,"index-finger-tip");if(!s||!o||!t){console.log("[Movement] Missing joint positions - wrist:",!!s,"indexTip:",!!o,"camera:",!!t);return}const n=s.distanceTo(t);if(console.log(`[Movement] Extension distance: ${n.toFixed(3)}m (min: ${Qt}m)`),n>=Qt){const l=new r.Vector3().subVectors(o,s).normalize();l.y=0,l.normalize();const c=Math.min((n-Qt)/(mi-Qt),1);if(console.log(`[Movement] Hand extended! Speed: ${c.toFixed(2)}, Mode: ${this.mode}`),this.mode===S.IDLE||this.mode===S.JETPACK){const d=this.mode===S.JETPACK?S.MOVING_JETPACK:S.MOVING;this.mode=d,console.log(`[Movement] Started - New mode: ${d}`),this.callbacks.onMovementStart&&this.callbacks.onMovementStart(l,c)}else(this.mode===S.MOVING||this.mode===S.MOVING_JETPACK)&&this.callbacks.onMovementUpdate&&this.callbacks.onMovementUpdate(l,c)}else console.log("[Movement] Hand not extended enough"),this.mode===S.MOVING?(this.mode=S.IDLE,console.log("[Movement] Ended - Mode: IDLE"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd()):this.mode===S.MOVING_JETPACK&&(this.mode=S.JETPACK,console.log("[Movement] Ended - Mode: JETPACK"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd())}checkJetpackGesture(){const t=this.xrHands.handInputState.right,e=performance.now();if(!(this.mode===S.TELEPORTING||this.mode===S.PAINTING)&&t.isPinching){const i=e-t.pinchStartTime;i>=fi&&this.mode!==S.JETPACK&&this.mode!==S.MOVING_JETPACK&&(console.log(`RIGHT hand jetpack activated (hold duration: ${i}ms)`),this.startJetpack("right"))}}isLeftPalmFacingUser(t){const e=this.xrManager.renderer.xr.getSession();if(!e)return!1;let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i)return!1;const s=this.xrHands.getPalmNormal(i),o=this.xrHands.getJointPosition(i,"wrist");if(!s||!o||!t)return!1;const n=new r.Vector3().subVectors(t,o).normalize();return s.dot(n)>.5}reset(){this.mode=S.IDLE,this.activePainterHand=null,this.xrHands.resetAllGestureStates(),console.log("GestureDetector reset")}on(t,e){this.callbacks.hasOwnProperty("on"+t.charAt(0).toUpperCase()+t.slice(1))&&(this.callbacks["on"+t.charAt(0).toUpperCase()+t.slice(1)]=e)}}class gi{constructor(t,e){this.scene=t,this.xrHands=e,this.colors=[{hex:16711680,name:"Red"},{hex:16746496,name:"Orange"},{hex:16776960,name:"Yellow"},{hex:65280,name:"Green"},{hex:65535,name:"Cyan"},{hex:255,name:"Blue"},{hex:8913151,name:"Purple"},{hex:16711935,name:"Magenta"},{hex:16777215,name:"White"},{hex:8947848,name:"Gray"},{hex:0,name:"Black"},{hex:8930304,name:"Brown"}],this.spheres=[],this.selectedIndex=6,this.hoveredIndex=-1,this.toggleButton=null,this.toggleButtonHovered=!1,this.paintModeEnabled=!1,this.paletteGroup=null,this.isVisible=!1,this.sphereRadius=.015,this.arcRadius=.12,this.arcSpan=Math.PI/2,this.rows=3,this.cols=4,this.createPalette()}createPalette(){this.paletteGroup=new r.Group,this.paletteGroup.visible=!1;let t=0;for(let l=0;l<this.rows;l++)for(let c=0;c<this.cols&&!(t>=this.colors.length);c++){const d=this.colors[t],u=new r.SphereGeometry(this.sphereRadius,16,16),f=new r.MeshStandardMaterial({color:d.hex,roughness:.3,metalness:.1,emissive:d.hex,emissiveIntensity:.2}),p=new r.Mesh(u,f),y=(c/(this.cols-1)-.5)*this.arcSpan,k=(l-(this.rows-1)/2)*(this.sphereRadius*3);p.position.x=Math.sin(y)*this.arcRadius,p.position.y=k,p.position.z=-Math.cos(y)*this.arcRadius,p.userData.colorIndex=t,p.userData.colorHex=d.hex,p.userData.colorName=d.name,this.spheres.push(p),this.paletteGroup.add(p),t++}const e=new r.RingGeometry(this.sphereRadius*1.2,this.sphereRadius*1.5,32),i=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,opacity:.8});this.selectionRing=new r.Mesh(e,i),this.selectionRing.visible=!1,this.paletteGroup.add(this.selectionRing);const s=this.sphereRadius*2.5,o=new r.SphereGeometry(s,16,16),n=new r.MeshStandardMaterial({color:16711680,roughness:.3,metalness:.1,emissive:16711680,emissiveIntensity:.3});this.toggleButton=new r.Mesh(o,n),this.toggleButton.position.set(0,this.sphereRadius*6,0),this.toggleButton.userData.isToggleButton=!0,this.paletteGroup.add(this.toggleButton),this.scene.add(this.paletteGroup),console.log("WristPalette created with",this.colors.length,"colors and toggle button")}update(t){const e=this.xrHands.renderer.xr.getSession();if(!e){this.hide();return}let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i){this.hide();return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getPalmNormal(i);if(!s||!o||!t){this.hide();return}const n=new r.Vector3().subVectors(t,s).normalize();if(o.dot(n)>.5){this.show(),this.paletteGroup.position.copy(s),this.paletteGroup.lookAt(t);const c=new r.Vector3().subVectors(t,s).normalize();this.paletteGroup.position.add(c.multiplyScalar(.05))}else this.hide()}checkHover(t,e){if(!this.isVisible)return null;const s=new r.Raycaster(t,e).intersectObjects(this.spheres);if(s.length>0){const o=s[0].object.userData.colorIndex;return this.setHovered(o),o}else return this.setHovered(-1),null}checkToggleButtonHover(t,e){if(!this.isVisible||!this.toggleButton)return!1;const o=new r.Raycaster(t,e).intersectObject(this.toggleButton).length>0;return o!==this.toggleButtonHovered&&(this.toggleButtonHovered=o,this.toggleButton&&(o?(this.toggleButton.scale.set(1.2,1.2,1.2),this.toggleButton.material.emissiveIntensity=.6):(this.toggleButton.scale.set(1,1,1),this.toggleButton.material.emissiveIntensity=.3))),o}togglePaintMode(){if(this.paintModeEnabled=!this.paintModeEnabled,this.toggleButton){const t=this.paintModeEnabled?65280:16711680;this.toggleButton.material.color.setHex(t),this.toggleButton.material.emissive.setHex(t),this.toggleButton.scale.set(1.4,1.4,1.4),setTimeout(()=>{this.toggleButton.scale.set(1,1,1)},100)}return console.log(`Paint mode toggled: ${this.paintModeEnabled?"ON":"OFF"}`),this.paintModeEnabled}getPaintModeEnabled(){return this.paintModeEnabled}setHovered(t){if(this.hoveredIndex!==t){if(this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1,1,1),e.material.emissiveIntensity=.2}if(this.hoveredIndex=t,this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1.3,1.3,1.3),e.material.emissiveIntensity=.6}}}selectColor(t){if(t<0||t>=this.colors.length)return;this.selectedIndex=t,console.log("Selected color:",this.colors[t].name);const e=this.spheres[t];this.selectionRing.position.copy(e.position),this.selectionRing.lookAt(this.paletteGroup.position),this.selectionRing.visible=this.isVisible;const i=e.scale.clone();e.scale.set(1.5,1.5,1.5),setTimeout(()=>{e.scale.copy(i)},100)}getSelectedColor(){return this.colors[this.selectedIndex]}show(){if(!this.isVisible&&(this.paletteGroup.visible=!0,this.selectionRing.visible=!0,this.isVisible=!0,this.selectedIndex>=0&&this.selectedIndex<this.spheres.length)){const t=this.spheres[this.selectedIndex];this.selectionRing.position.copy(t.position),this.selectionRing.lookAt(this.paletteGroup.position)}}hide(){this.isVisible&&(this.paletteGroup.visible=!1,this.selectionRing.visible=!1,this.isVisible=!1,this.setHovered(-1))}dispose(){this.spheres.forEach(t=>{t.geometry.dispose(),t.material.dispose()}),this.selectionRing&&(this.selectionRing.geometry.dispose(),this.selectionRing.material.dispose()),this.toggleButton&&(this.toggleButton.geometry.dispose(),this.toggleButton.material.dispose()),this.paletteGroup&&this.scene.remove(this.paletteGroup)}}class yi{constructor(t){this.scene=t,this.paintRays={left:null,right:null},this.movementArrow=null,this.jetpackGlows={left:null,right:null},this.createVisuals()}createVisuals(){this.createPaintRays(),this.createMovementArrow(),this.createJetpackGlows()}createPaintRays(){const t=()=>{const e=new r.BufferGeometry,i=new Float32Array([0,0,0,0,0,-5]);e.setAttribute("position",new r.BufferAttribute(i,3));const s=new r.LineBasicMaterial({color:65280,transparent:!0,opacity:.6,linewidth:2}),o=new r.Line(e,s);return o.visible=!1,this.scene.add(o),o};this.paintRays.left=t(),this.paintRays.right=t()}createMovementArrow(){const t=new r.Group,e=new r.CylinderGeometry(.02,.02,.4,8),i=new r.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),s=new r.Mesh(e,i);s.rotation.z=-Math.PI/2,t.add(s);const o=new r.ConeGeometry(.05,.1,8),n=new r.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),l=new r.Mesh(o,n);l.rotation.z=-Math.PI/2,l.position.x=.25,t.add(l),t.visible=!1,this.scene.add(t),this.movementArrow=t}createJetpackGlows(){const t=()=>{const e=new r.SphereGeometry(.06,16,16),i=new r.MeshBasicMaterial({color:65280,transparent:!0,opacity:.5}),s=new r.Mesh(e,i);return s.visible=!1,this.scene.add(s),s};this.jetpackGlows.left=t(),this.jetpackGlows.right=t()}updatePaintRay(t,e,i,s=!0){const o=this.paintRays[t];if(o)if(s&&e&&i){o.visible=!0,o.position.copy(e);const n=new r.Vector3().copy(e).add(i.clone().multiplyScalar(5));o.lookAt(n);const l=o.geometry.attributes.position.array;l[3]=0,l[4]=0,l[5]=-5,o.geometry.attributes.position.needsUpdate=!0}else o.visible=!1}updateMovementArrow(t,e,i,s=!0){if(this.movementArrow)if(s&&t&&e&&i>0){this.movementArrow.visible=!0,this.movementArrow.position.copy(t),this.movementArrow.position.y=t.y-1.3;const o=new r.Vector3().copy(t).add(e);o.y=this.movementArrow.position.y,this.movementArrow.lookAt(o);const n=.5+i*.5;this.movementArrow.scale.set(n,n,n),this.movementArrow.children.forEach(l=>{l.material&&(l.material.opacity=.4+i*.3)})}else this.movementArrow.visible=!1}updateJetpackGlow(t,e,i=!0){const s=this.jetpackGlows[t];if(s)if(i&&e){s.visible=!0,s.position.copy(e);const o=performance.now()*.005,n=.8+Math.sin(o)*.2;s.scale.set(n,n,n),s.material.opacity=.3+Math.sin(o*2)*.2}else s.visible=!1}hidePaintRays(){this.paintRays.left.visible=!1,this.paintRays.right.visible=!1}hideMovementArrow(){this.movementArrow&&(this.movementArrow.visible=!1)}hideJetpackGlows(){this.jetpackGlows.left.visible=!1,this.jetpackGlows.right.visible=!1}hideAll(){this.hidePaintRays(),this.hideMovementArrow(),this.hideJetpackGlows()}dispose(){Object.values(this.paintRays).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))}),this.movementArrow&&(this.movementArrow.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.scene.remove(this.movementArrow)),Object.values(this.jetpackGlows).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))})}}class bi{constructor(t,e,i=20,s=0){this.spark=t,this.renderer=e,this.targetFPS=i,this.initialTargetFPS=i,this.frameCount=0,this.lastTime=performance.now(),this.fps=60,this.fpsHistory=[],this.qualityPresets=[{name:"Ultra",maxStdDev:Math.sqrt(8),minPixelRadius:0,maxPixelRadius:512,minAlpha:.5/255,clipXY:2,falloff:1,stochastic:!1,sortDistance:.01,sortCoorient:.99,pixelRatio:2},{name:"High",maxStdDev:Math.sqrt(7),minPixelRadius:.3,maxPixelRadius:384,minAlpha:.7/255,clipXY:1.8,falloff:.95,stochastic:!1,sortDistance:.02,sortCoorient:.99,pixelRatio:1.5},{name:"Medium",maxStdDev:Math.sqrt(6),minPixelRadius:.5,maxPixelRadius:256,minAlpha:1/255,clipXY:1.6,falloff:.85,stochastic:!1,sortDistance:.05,sortCoorient:.97,pixelRatio:1.5},{name:"Low",maxStdDev:Math.sqrt(5),minPixelRadius:.8,maxPixelRadius:192,minAlpha:1.8/255,clipXY:1.4,falloff:.7,stochastic:!1,sortDistance:.08,sortCoorient:.96,pixelRatio:1},{name:"Potato",maxStdDev:Math.sqrt(4.5),minPixelRadius:1.2,maxPixelRadius:128,minAlpha:2.5/255,clipXY:1.2,falloff:.6,stochastic:!1,sortDistance:.15,sortCoorient:.93,pixelRatio:1}],this.currentQualityIndex=Math.min(s,this.qualityPresets.length-1),this.manualMode=!1,this.originalPixelRatio=this.renderer.getPixelRatio(),this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Initialized - Starting at ${this.getCurrentQualityName()} quality (target: ${this.targetFPS} FPS)`)}update(){this.frameCount++;const t=performance.now();if(t>=this.lastTime+1e3){this.fps=Math.round(this.frameCount*1e3/(t-this.lastTime)),this.frameCount=0,this.lastTime=t,this.fpsHistory.push(this.fps),this.fpsHistory.length>3&&this.fpsHistory.shift();const e=this.fpsHistory.reduce((i,s)=>i+s,0)/this.fpsHistory.length;this.manualMode||this.adjustQuality(e)}}adjustQuality(t){this.currentQualityIndex,t<this.targetFPS-5&&this.currentQualityIndex<this.qualityPresets.length-1&&(this.currentQualityIndex++,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] â†“ Reduced to: ${this.getCurrentQualityName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`)),t>this.targetFPS+5*2&&this.currentQualityIndex>0&&(this.currentQualityIndex--,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] â†‘ Increased to: ${this.getCurrentQualityName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`))}applyQualityPreset(t){const e=this.qualityPresets[t];this.spark.maxStdDev=e.maxStdDev,this.spark.minPixelRadius=e.minPixelRadius,this.spark.maxPixelRadius=e.maxPixelRadius,this.spark.minAlpha=e.minAlpha,this.spark.clipXY=e.clipXY,this.spark.falloff=e.falloff,this.spark.defaultView.stochastic=e.stochastic,this.spark.defaultView.sortDistance=e.sortDistance,this.spark.defaultView.sortCoorient=e.sortCoorient;const i=Math.min(this.originalPixelRatio,e.pixelRatio);this.renderer.setPixelRatio(i),console.log(`[AdaptiveQuality] Applied preset: ${e.name}`,{maxStdDev:e.maxStdDev.toFixed(2),minPixelRadius:e.minPixelRadius,stochastic:e.stochastic,pixelRatio:i.toFixed(1)})}increaseQuality(){this.currentQualityIndex>0&&(this.manualMode=!0,this.currentQualityIndex--,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Manual increase to: ${this.getCurrentQualityName()} (Adaptive DISABLED)`))}decreaseQuality(){this.currentQualityIndex<this.qualityPresets.length-1&&(this.manualMode=!0,this.currentQualityIndex++,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Manual decrease to: ${this.getCurrentQualityName()} (Adaptive DISABLED)`))}setQualityByName(t){const e=this.qualityPresets.findIndex(i=>i.name.toLowerCase()===t.toLowerCase());e!==-1&&(this.currentQualityIndex=e,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Set to: ${this.getCurrentQualityName()}`))}resumeAdaptive(){this.manualMode=!1,console.log("[AdaptiveQuality] Resumed adaptive quality adjustment"),console.log(`[AdaptiveQuality] Current quality: ${this.getCurrentQualityName()} (will adjust based on FPS)`)}setTargetFPS(t){if(t!==this.targetFPS){const e=this.targetFPS;this.targetFPS=t,this.fpsHistory=[],console.log(`[AdaptiveQuality] Target FPS changed: ${e} â†’ ${t}`)}}getFPS(){return this.fps}getCurrentQualityName(){return this.qualityPresets[this.currentQualityIndex].name}getCurrentQualityIndex(){return this.currentQualityIndex}getQualityPresets(){return this.qualityPresets.map(t=>t.name)}isManualMode(){return this.manualMode}getStats(){const t=this.qualityPresets[this.currentQualityIndex];return{fps:this.fps,qualityName:t.name,qualityIndex:this.currentQualityIndex,maxStdDev:t.maxStdDev.toFixed(2),minPixelRadius:t.minPixelRadius,stochastic:t.stochastic,pixelRatio:this.renderer.getPixelRatio().toFixed(1),targetFPS:this.targetFPS}}}class xi{constructor(){this.currentSiteId=null,this.urlParams=new URLSearchParams(window.location.search)}hasSiteParameter(){return this.urlParams.has("site")}getSiteFromURL(){return this.urlParams.get("site")}isValidSite(t,e){return!t||!e?!1:e.some(i=>i.id===t)}shouldShowGlobe(t){const e=this.getSiteFromURL();return e?this.isValidSite(e,t)?(this.currentSiteId=e,!1):(console.warn(`Invalid site parameter: ${e}. Showing globe.`),!0):!0}navigateToSite(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.location.href=i}navigateToGlobe(){window.location.href=window.location.pathname}getCurrentSiteId(){return this.currentSiteId||this.getSiteFromURL()}updateURLWithoutReload(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.history.pushState({siteId:t},"",i)}}class vi{constructor(t,e){this.container=t,this.onSiteSelected=e,this.scene=null,this.camera=null,this.renderer=null,this.labelRenderer=null,this.controls=null,this.earth=null,this.atmosphere=null,this.markers=[],this.raycaster=new r.Raycaster,this.mouse=new r.Vector2,this.hoveredMarker=null,this.animationId=null,this.isInitialized=!1}latLongToVector3(t,e,i){const s=(90-t)*(Math.PI/180),o=(e+180)*(Math.PI/180);return new r.Vector3(-i*Math.sin(s)*Math.cos(o),i*Math.cos(s),i*Math.sin(s)*Math.sin(o))}async init(t){if(this.isInitialized)return;this.scene=new r.Scene,this.scene.background=new r.Color(1296);const e=window.innerWidth/window.innerHeight;this.camera=new r.PerspectiveCamera(45,e,.1,1e3);const n=this.latLongToVector3(45,10,12);this.camera.position.copy(n),this.camera.lookAt(0,0,0),this.renderer=new r.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.labelRenderer=new je,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0",this.labelRenderer.domElement.style.pointerEvents="none",this.container.appendChild(this.labelRenderer.domElement);const l=new r.AmbientLight(16777215,.4);this.scene.add(l);const c=new r.DirectionalLight(16777215,.8);c.position.set(5,3,5),this.scene.add(c),await this.createEarth(),this.createAtmosphere(),this.createSiteMarkers(t),this.controls=new Ne(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.minDistance=7,this.controls.maxDistance=20,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.addEventListeners(),this.isInitialized=!0,this.animate()}async createEarth(){const t=new r.SphereGeometry(5,64,64),e=new r.TextureLoader,i=await new Promise((o,n)=>{e.load("models/textures/earth_day.jpg",o,void 0,n)}),s=new r.MeshStandardMaterial({map:i,roughness:.9,metalness:.1});this.earth=new r.Mesh(t,s),this.scene.add(this.earth)}createAtmosphere(){const t=new r.SphereGeometry(5.2,64,64),e=new r.ShaderMaterial({vertexShader:`
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
                }
            `,blending:r.AdditiveBlending,side:r.BackSide,transparent:!0});this.atmosphere=new r.Mesh(t,e),this.scene.add(this.atmosphere)}positionLabelsWithCollisionAvoidance(t,e=8,i=1.5){const s=t.map(l=>this.latLongToVector3(l.latitude,l.longitude,e)),o=50,n=.5;for(let l=0;l<o;l++){let c=!1;for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++){const f=s[d].distanceTo(s[u]);if(f<i){const p=new r.Vector3().subVectors(s[d],s[u]).normalize(),y=(i-f)*n;s[d].add(p.clone().multiplyScalar(y)),s[u].sub(p.clone().multiplyScalar(y)),c=!0}}if(s.forEach(d=>{d.normalize().multiplyScalar(e)}),!c){console.log(`Label positioning converged in ${l+1} iterations`);break}}return s}createConnectingLine(t,e){const i=[t,e],s=new r.BufferGeometry().setFromPoints(i),o=new r.LineBasicMaterial({color:16777215,opacity:.5,transparent:!0,linewidth:1});return new r.Line(s,o)}createSiteMarkers(t){const s=this.positionLabelsWithCollisionAvoidance(t,6.5);t.forEach((o,n)=>{const l=this.latLongToVector3(o.latitude,o.longitude,5.05),c=s[n],d=new r.SphereGeometry(.15,16,16),u=new r.MeshBasicMaterial({color:16737792,transparent:!0,opacity:0}),f=new r.Mesh(d,u);f.position.copy(l),f.userData={siteId:o.id,siteName:o.name},this.scene.add(f);const p=this.createLabelElement(o),y=new Xe(p);y.position.copy(c),y.userData={siteId:o.id},this.scene.add(y);const k=this.createConnectingLine(l,c);this.scene.add(k),this.markers.push({mesh:f,label:y,line:k,site:o,sitePosition:l.clone(),labelPosition:c.clone()})})}createLabelElement(t){const e=document.createElement("div");e.className="globe-site-marker",e.style.pointerEvents="auto";const i=document.createElement("div");i.className="globe-thumbnail-container",i.style.width="80px",i.style.height="80px",i.style.borderRadius="50%",i.style.border="3px solid #ff6600",i.style.marginBottom="8px",i.style.overflow="hidden",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.boxShadow="0 0 20px rgba(255, 102, 0, 0.6)",i.style.transition="border-color 0.2s ease, box-shadow 0.2s ease";const s=document.createElement("img");s.src=t.thumbnail||"models/thumbnails/placeholder.jpg",s.alt=t.name,s.style.width="120px",s.style.height="120px",s.style.objectFit="cover",s.style.display="block",i.appendChild(s);const o=document.createElement("span");return o.textContent=t.name,o.style.color="#ffffff",o.style.fontSize="14px",o.style.fontWeight="bold",o.style.textShadow="0 0 10px rgba(0, 0, 0, 0.8)",o.style.display="block",o.style.textAlign="center",e.appendChild(i),e.appendChild(o),e.style.cursor="pointer",e.style.transition="transform 0.2s ease",e.dataset.siteId=t.id,e}addEventListeners(){window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("click",this.onClick.bind(this)),window.addEventListener("touchend",this.onTouch.bind(this)),window.addEventListener("resize",this.onWindowResize.bind(this))}onMouseMove(t){var s,o;this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-(t.clientY/window.innerHeight)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(n=>n.mesh),i=this.raycaster.intersectObjects(e);if(this.hoveredMarker){const n=(s=this.markers.find(l=>l.mesh===this.hoveredMarker))==null?void 0:s.label;n&&(n.element.style.transform="scale(1)"),this.hoveredMarker=null}if(i.length>0){this.hoveredMarker=i[0].object;const n=(o=this.markers.find(l=>l.mesh===this.hoveredMarker))==null?void 0:o.label;n&&(n.element.style.transform="scale(1.2)"),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onTouch(t){const e=t.changedTouches[0],i=document.elementFromPoint(e.clientX,e.clientY);if(i&&i.closest(".globe-site-marker")){const o=i.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&(console.log("Touch site selected:",o),this.onSiteSelected(o),t.preventDefault())}}onClick(t){if(t.target.closest(".globe-site-marker")){const o=t.target.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&this.onSiteSelected(o);return}this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(s=>s.mesh),i=this.raycaster.intersectObjects(e);if(i.length>0){const s=i[0].object.userData.siteId;s&&this.onSiteSelected&&this.onSiteSelected(s)}}onWindowResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.labelRenderer.setSize(t,e)}animate(){this.animationId=requestAnimationFrame(this.animate.bind(this)),this.controls&&this.controls.update(),this.updateConnectingLines(),this.renderer&&this.scene&&this.camera&&(this.renderer.render(this.scene,this.camera),this.labelRenderer.render(this.scene,this.camera))}updateConnectingLines(){this.markers&&this.markers.forEach(t=>{if(t.line&&t.mesh&&t.label){const e=new r.Vector3;t.mesh.getWorldPosition(e);const i=t.label.position,s=t.line.geometry.attributes.position.array;s[0]=e.x,s[1]=e.y,s[2]=e.z,s[3]=i.x,s[4]=i.y,s[5]=i.z,t.line.geometry.attributes.position.needsUpdate=!0}})}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),window.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("click",this.onClick.bind(this)),window.removeEventListener("touchend",this.onTouch.bind(this)),window.removeEventListener("resize",this.onWindowResize.bind(this)),this.controls&&this.controls.dispose(),this.markers&&(this.markers.forEach(t=>{t.line&&(t.line.geometry&&t.line.geometry.dispose(),t.line.material&&t.line.material.dispose()),t.mesh&&(t.mesh.geometry&&t.mesh.geometry.dispose(),t.mesh.material&&t.mesh.material.dispose())}),this.markers=[]),this.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.renderer&&this.container.removeChild(this.renderer.domElement),this.labelRenderer&&this.container.removeChild(this.labelRenderer.domElement),this.isInitialized=!1}show(){this.container.style.display="block",setTimeout(()=>{this.container.classList.add("visible")},50)}hide(){this.container.classList.remove("visible"),setTimeout(()=>{this.container.style.display="none"},500)}}const at={JOIN_ROOM:"join_room",LEAVE_ROOM:"leave_room",PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left",PLAYER_STATE:"player_state",FULL_STATE:"full_state",PAINT_STROKE:"paint_stroke",ERROR:"error"};class wi{constructor(t){this.socket=null,this.serverUrl=t,this.connected=!1,this.connecting=!1,this.roomId=null,this.playerId=null,this.playerName=null,this.onPlayerJoined=null,this.onPlayerLeft=null,this.onPlayerState=null,this.onFullState=null,this.onPaintStroke=null,this.onConnectionChange=null,this.onError=null,this.lastStateSend=0,this.stateUpdateInterval=50,this.reconnectAttempts=0,this.maxReconnectAttempts=5}connect(){return this.connected||this.connecting?Promise.resolve(this.playerId):(this.connecting=!0,new Promise((t,e)=>{console.log(`[MP] Connecting to ${this.serverUrl}...`),this.socket=qe(this.serverUrl,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:2e4}),this.socket.on("connect",()=>{this.connected=!0,this.connecting=!1,this.playerId=this.socket.id,this.reconnectAttempts=0,console.log(`[MP] Connected! Player ID: ${this.playerId}`),this.onConnectionChange&&this.onConnectionChange(!0),t(this.playerId)}),this.socket.on("connect_error",i=>{console.error("[MP] Connection error:",i.message),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&(this.connecting=!1,e(new Error(`Failed to connect after ${this.maxReconnectAttempts} attempts`)))}),this.socket.on("disconnect",i=>{console.log(`[MP] Disconnected: ${i}`),this.connected=!1,this.onConnectionChange&&this.onConnectionChange(!1),i==="io server disconnect"&&(this.roomId=null)}),this.socket.on("reconnect",i=>{console.log(`[MP] Reconnected after ${i} attempts`),this.connected=!0,this.playerId=this.socket.id,this.onConnectionChange&&this.onConnectionChange(!0),this.roomId&&this.joinRoom(this.roomId,this.playerName)}),this.setupMessageHandlers()}))}setupMessageHandlers(){this.socket.on(at.PLAYER_JOINED,t=>{console.log(`[MP] Player joined: ${t.name} (${t.playerId})`),this.onPlayerJoined&&this.onPlayerJoined(t)}),this.socket.on(at.PLAYER_LEFT,t=>{console.log(`[MP] Player left: ${t.playerId}`),this.onPlayerLeft&&this.onPlayerLeft(t)}),this.socket.on(at.PLAYER_STATE,t=>{this.onPlayerState&&this.onPlayerState(t)}),this.socket.on(at.FULL_STATE,t=>{console.log(`[MP] Received full state: ${Object.keys(t.players||{}).length} players, ${(t.paintHistory||[]).length} paint actions`),this.playerName=t.playerName,this.onFullState&&this.onFullState(t)}),this.socket.on(at.PAINT_STROKE,t=>{this.onPaintStroke&&this.onPaintStroke(t)}),this.socket.on(at.ERROR,t=>{console.error("[MP] Server error:",t.message),this.onError&&this.onError(t)})}joinRoom(t,e=null){if(!this.connected){console.warn("[MP] Cannot join room: not connected");return}this.roomId=t,this.playerName=e,console.log(`[MP] Joining room: ${t}`),this.socket.emit(at.JOIN_ROOM,{sceneId:t,playerName:e})}leaveRoom(){!this.connected||!this.roomId||(console.log(`[MP] Leaving room: ${this.roomId}`),this.socket.emit(at.LEAVE_ROOM),this.roomId=null)}sendPlayerState(t){if(!this.connected||!this.roomId)return;const e=Date.now();e-this.lastStateSend<this.stateUpdateInterval||(this.lastStateSend=e,this.socket.emit(at.PLAYER_STATE,t))}sendPaintStroke(t){!this.connected||!this.roomId||this.socket.emit(at.PAINT_STROKE,t)}disconnect(){this.socket&&(console.log("[MP] Disconnecting..."),this.socket.disconnect(),this.socket=null,this.connected=!1,this.connecting=!1,this.roomId=null,this.playerId=null)}isConnected(){return this.connected}getRoomId(){return this.roomId}getPlayerId(){return this.playerId}}class Pi{constructor(t,e,i){this.id=t,this.name=e,this.scene=i,this.model=null,this.mixer=null,this.animationsMap=new Map,this.currentAction="Idle",this.loaded=!1,this.targetPosition=new r.Vector3,this.targetQuaternion=new r.Quaternion,this.stateBuffer=[],this.interpolationDelay=100,this.nameLabel=null,this.positionLerpFactor=.15,this.rotationSlerpFactor=.15}async load(t){const e=new be;return new Promise((i,s)=>{e.load(t,o=>{this.model=Je.clone(o.scene),this.model.traverse(l=>{l.isMesh&&(l.castShadow=!0,l.receiveShadow=!0,l.material&&(l.material=l.material.clone(),l.material.color.multiplyScalar(.85)))}),this.scene.add(this.model),this.mixer=new r.AnimationMixer(this.model),o.animations.forEach(l=>{const c=l.clone(),d=this.mixer.clipAction(c);this.animationsMap.set(l.name,d)});const n=this.animationsMap.get("Idle");n&&n.play(),this.createNameLabel(),this.loaded=!0,console.log(`[MP] Remote player model loaded: ${this.name} (animations: ${this.animationsMap.size})`),i(this)},void 0,o=>{console.error("[MP] Failed to load remote player model:",o),s(o)})})}createNameLabel(){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=256,t.height=64,e.fillStyle="rgba(0, 0, 0, 0.6)",e.roundRect(10,10,236,44,8),e.fill(),e.font="Bold 24px Arial",e.fillStyle="#ffffff",e.textAlign="center",e.textBaseline="middle",e.fillText(this.name,128,32);const i=new r.CanvasTexture(t);i.minFilter=r.LinearFilter;const s=new r.SpriteMaterial({map:i,transparent:!0,depthTest:!1});this.nameLabel=new r.Sprite(s),this.nameLabel.scale.set(2,.5,1),this.nameLabel.renderOrder=999,this.scene.add(this.nameLabel)}updateState(t,e){const i=new r.Vector3(t.position.x,t.position.y,t.position.z),s=new r.Quaternion(t.quaternion.x,t.quaternion.y,t.quaternion.z,t.quaternion.w);for(this.stateBuffer.push({timestamp:e,position:i,quaternion:s,animationState:t.animationState});this.stateBuffer.length>30;)this.stateBuffer.shift()}update(t){if(!this.model||!this.loaded)return;const e=Date.now()-this.interpolationDelay;let i=null,s=null;for(let o=0;o<this.stateBuffer.length-1;o++)if(this.stateBuffer[o].timestamp<=e&&this.stateBuffer[o+1].timestamp>=e){i=this.stateBuffer[o],s=this.stateBuffer[o+1];break}if(i&&s){const o=(e-i.timestamp)/(s.timestamp-i.timestamp),n=Math.max(0,Math.min(1,o));this.model.position.lerpVectors(i.position,s.position,n),this.model.quaternion.slerpQuaternions(i.quaternion,s.quaternion,n),this.updateAnimation(s.animationState)}else if(this.stateBuffer.length>0){const o=this.stateBuffer[this.stateBuffer.length-1];this.model.position.lerp(o.position,this.positionLerpFactor),this.model.quaternion.slerp(o.quaternion,this.rotationSlerpFactor),this.updateAnimation(o.animationState)}this.model.updateMatrixWorld(!0),this.nameLabel&&(this.nameLabel.position.copy(this.model.position),this.nameLabel.position.y+=2.5),this.mixer&&this.mixer.update(t)}updateAnimation(t){if(!t)return;let e="Idle";if(t.isJetpackActive&&!t.isGrounded?e="TPose":!t.isGrounded&&t.timeInAir>.4?e="Idle":t.directionPressed&&t.toggleRun?e="Run":t.directionPressed&&(e="Walk"),e!==this.currentAction){const i=this.animationsMap.get(this.currentAction),s=this.animationsMap.get(e);i&&s&&(i.fadeOut(.2),s.reset().fadeIn(.2).play(),this.currentAction=e)}}setInitialState(t){!this.model||!t||(this.model.position.set(t.position.x,t.position.y,t.position.z),this.model.quaternion.set(t.quaternion.x,t.quaternion.y,t.quaternion.z,t.quaternion.w),this.nameLabel&&(this.nameLabel.position.copy(this.model.position),this.nameLabel.position.y+=2.5))}dispose(){console.log(`[MP] Disposing remote player: ${this.name}`),this.model&&(this.scene.remove(this.model),this.model.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.model=null),this.nameLabel&&(this.scene.remove(this.nameLabel),this.nameLabel.material.map&&this.nameLabel.material.map.dispose(),this.nameLabel.material.dispose(),this.nameLabel=null),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null),this.animationsMap.clear(),this.stateBuffer=[],this.loaded=!1}}class Si{constructor(t,e){this.scene=t,this.characterModelPath=e,this.remotePlayers=new Map,this.pendingPlayers=new Map,this.pendingStates=new Map}async addPlayer(t,e,i=null){if(this.remotePlayers.has(t))return console.warn(`[MP] Player ${t} already exists`),this.remotePlayers.get(t);if(this.pendingPlayers.has(t))return this.pendingPlayers.get(t);console.log(`[MP] Adding remote player: ${e} (${t})`);const s=new Pi(t,e,this.scene),o=s.load(this.characterModelPath).then(()=>{i&&s.setInitialState(i),this.remotePlayers.set(t,s),this.pendingPlayers.delete(t);const n=this.pendingStates.get(t);return n&&(s.updateState(n.state,n.timestamp),s.setInitialState(n.state),this.pendingStates.delete(t),console.log(`[MP] Applied pending state for ${e}`)),console.log(`[MP] Remote player ready: ${e} (total: ${this.remotePlayers.size})`),s}).catch(n=>{throw console.error(`[MP] Failed to add remote player ${e}:`,n),this.pendingPlayers.delete(t),this.pendingStates.delete(t),n});return this.pendingPlayers.set(t,o),o}removePlayer(t){const e=this.remotePlayers.get(t);e&&(e.dispose(),this.remotePlayers.delete(t),console.log(`[MP] Remote player removed: ${t} (remaining: ${this.remotePlayers.size})`)),this.pendingPlayers.delete(t),this.pendingStates.delete(t)}updatePlayerState(t,e,i){const s=this.remotePlayers.get(t);s&&s.loaded?s.updateState(e,i):this.pendingPlayers.has(t)&&this.pendingStates.set(t,{state:e,timestamp:i})}hasPlayer(t){return this.remotePlayers.has(t)||this.pendingPlayers.has(t)}getPlayer(t){return this.remotePlayers.get(t)}update(t){this.remotePlayers.forEach(e=>{e.update(t)})}getPlayerCount(){return this.remotePlayers.size}getPlayerIds(){return Array.from(this.remotePlayers.keys())}clear(){console.log(`[MP] Clearing all remote players (${this.remotePlayers.size})`),this.remotePlayers.forEach(t=>{t.dispose()}),this.remotePlayers.clear(),this.pendingPlayers.clear(),this.pendingStates.clear()}dispose(){this.clear(),this.scene=null,this.characterModelPath=null}}class Ae{constructor(t,e,i){this.gaussianSplat=t,this.spark=e,this.brushParams=i,this.appliedPaintIds=new Set}applyRemotePaint(t,e){if(console.log(`[MP] applyRemotePaint called - paintData.id: ${t.id}, paintData.playerId: ${t.playerId}, localPlayerId: ${e}`),this.appliedPaintIds.has(t.id)){console.log(`[MP] Skipping paint ${t.id} - already applied`);return}if(t.playerId===e){console.log(`[MP] Skipping paint ${t.id} - this is our own paint`),this.appliedPaintIds.add(t.id);return}console.log(`[MP] Applying remote paint from ${t.playerId}, brush params:`,{radius:t.brushRadius,color:t.brushColor,origin:t.rayOrigin,direction:t.rayDirection,useSurface:t.useSurface}),this.appliedPaintIds.add(t.id);const i={enabled:this.brushParams.enabled.value,radius:this.brushParams.brushRadius.value,depth:this.brushParams.brushDepth.value,color:this.brushParams.brushColor.value.clone(),origin:this.brushParams.brushOrigin.value.clone(),direction:this.brushParams.brushDirection.value.clone(),useSurface:this.brushParams.useSurface.value,surfacePoint:this.brushParams.surfacePoint.value.clone()};this.brushParams.enabled.value=!0,this.brushParams.brushRadius.value=t.brushRadius,this.brushParams.brushDepth.value=t.brushDepth,this.brushParams.brushColor.value.set(t.brushColor.r,t.brushColor.g,t.brushColor.b),this.brushParams.brushOrigin.value.set(t.rayOrigin.x,t.rayOrigin.y,t.rayOrigin.z),this.brushParams.brushDirection.value.set(t.rayDirection.x,t.rayDirection.y,t.rayDirection.z),console.log("[MP] After setting brush params:",{origin:{x:this.brushParams.brushOrigin.value.x,y:this.brushParams.brushOrigin.value.y,z:this.brushParams.brushOrigin.value.z},direction:{x:this.brushParams.brushDirection.value.x,y:this.brushParams.brushDirection.value.y,z:this.brushParams.brushDirection.value.z},enabled:this.brushParams.enabled.value}),this.brushParams.useSurface.value=t.useSurface,t.surfacePoint&&this.brushParams.surfacePoint.value.set(t.surfacePoint.x,t.surfacePoint.y,t.surfacePoint.z),requestAnimationFrame(()=>{console.log("[MP] Inside requestAnimationFrame - about to bake. Brush state:",{origin:{x:this.brushParams.brushOrigin.value.x,y:this.brushParams.brushOrigin.value.y,z:this.brushParams.brushOrigin.value.z},direction:{x:this.brushParams.brushDirection.value.x,y:this.brushParams.brushDirection.value.y,z:this.brushParams.brushDirection.value.z},enabled:this.brushParams.enabled.value}),this.bakePaint(),this.brushParams.enabled.value=i.enabled,this.brushParams.brushRadius.value=i.radius,this.brushParams.brushDepth.value=i.depth,this.brushParams.brushColor.value.copy(i.color),this.brushParams.brushOrigin.value.copy(i.origin),this.brushParams.brushDirection.value.copy(i.direction),this.brushParams.useSurface.value=i.useSurface,this.brushParams.surfacePoint.value.copy(i.surfacePoint)})}applyPaintHistory(t,e){!t||t.length===0||(console.log(`[MP] Applying paint history: ${t.length} actions`),t.forEach(i=>{this.applyRemotePaint(i,e)}))}bakePaint(){var t,e;if(!this.gaussianSplat||!this.spark){console.warn("[MP] Cannot bake paint: missing gaussianSplat or spark");return}try{console.log(`[MP] bakePaint called - splatRgba exists: ${!!this.gaussianSplat.splatRgba}, enabled: ${this.brushParams.enabled.value}`),console.log("[MP] Current brush state:",{enabled:this.brushParams.enabled.value,radius:this.brushParams.brushRadius.value,origin:{x:this.brushParams.brushOrigin.value.x,y:this.brushParams.brushOrigin.value.y,z:this.brushParams.brushOrigin.value.z},direction:{x:this.brushParams.brushDirection.value.x,y:this.brushParams.brushDirection.value.y,z:this.brushParams.brushDirection.value.z},color:{r:this.brushParams.brushColor.value.x,g:this.brushParams.brushColor.value.y,b:this.brushParams.brushColor.value.z}}),console.log(`[MP] gaussianSplat.worldModifier exists: ${!!this.gaussianSplat.worldModifier}`),console.log("[MP] DEBUG: brushParams.brushOrigin === window.BRUSH_PARAMS?.brushOrigin:",this.brushParams.brushOrigin===((t=window.BRUSH_PARAMS)==null?void 0:t.brushOrigin)),console.log("[MP] DEBUG: brushParams reference check - enabled.value:",this.brushParams.enabled.value);const i=this.gaussianSplat.splatRgba;console.log("[MP] Calling spark.getRgba with generator:",this.gaussianSplat);const s=this.spark.getRgba({generator:this.gaussianSplat,rgba:this.gaussianSplat.splatRgba});console.log("[MP] getRgba returned:",s),console.log("[MP] newRgba type:",typeof s,(e=s==null?void 0:s.constructor)==null?void 0:e.name),this.gaussianSplat.splatRgba=s,console.log(`[MP] splatRgba before: ${i?"exists":"null"}, after: ${s?"exists":"null"}`),this.gaussianSplat.updateVersion(),console.log("[MP] Called updateVersion()"),console.log("[MP] bakePaint completed successfully"),console.log(`[MP] gaussianSplat.visible: ${this.gaussianSplat.visible}, gaussianSplat in scene: ${this.gaussianSplat.parent?"yes":"no"}`)}catch(i){console.error("[MP] Error baking paint:",i)}}isReady(){return this.gaussianSplat&&this.gaussianSplat.worldModifier&&this.gaussianSplat.parent!==null&&this.spark}clearAppliedPaints(){this.appliedPaintIds.clear()}updateReferences(t,e){this.gaussianSplat=t,this.spark=e,this.clearAppliedPaints()}dispose(){this.appliedPaintIds.clear(),this.gaussianSplat=null,this.spark=null,this.brushParams=null}}function Mi(a){const t=a.model,e=a.currentAction,i=e==="Walk"||e==="Run";return{position:{x:t.position.x,y:t.position.y,z:t.position.z},quaternion:{x:t.quaternion.x,y:t.quaternion.y,z:t.quaternion.z,w:t.quaternion.w},animationState:{isGrounded:a.isGrounded,timeInAir:a.timeInAir,isJetpackActive:a.isJetpackActive,directionPressed:i,toggleRun:a.toggleRun}}}function ki(a,t){return{brushRadius:a.brushRadius.value,brushDepth:a.brushDepth.value,brushColor:{r:a.brushColor.value.x,g:a.brushColor.value.y,b:a.brushColor.value.z},rayOrigin:{x:a.brushOrigin.value.x,y:a.brushOrigin.value.y,z:a.brushOrigin.value.z},rayDirection:{x:a.brushDirection.value.x,y:a.brushDirection.value.y,z:a.brushDirection.value.z},useSurface:a.useSurface.value,surfacePoint:t?{x:t.x,y:t.y,z:t.z}:null}}let Rt=null,h=null,mt=null,Pt=null,ce=null,J,P,E,U,R,x,V,I=null,_=null,Bt=null,G=null,dt=null,W=null,It=null,Ft=0;const Ci="https://multiplayer-server-production-6351.up.railway.app",$t="f1000_username";let H=null,vt=null,rt=null,ut=[],st=null,M,X,b=null,St=1,Q=null,pt=0,ue=2500,F=null,K=null,Lt=213,zt=37,Xt=180,qt=0,Jt=0,Dt=0,Ot=0,B=0,lt=0,ct=0,ht=0;const Ri=new r.Clock;let Se=60;const le=v.dynoFloat(0);let Tt=0;const m={enabled:v.dynoBool(!1),brushRadius:v.dynoFloat(.05),brushDepth:v.dynoFloat(10),brushOrigin:v.dynoVec3(new r.Vector3(0,0,0)),brushDirection:v.dynoVec3(new r.Vector3(0,0,0)),brushColor:v.dynoVec3(new r.Vector3(1,0,1)),useSurface:v.dynoBool(!1),surfacePoint:v.dynoVec3(new r.Vector3(0,0,0)),surfaceRadius:v.dynoFloat(.2)},Ti=.01,Ei=.25,Ai=.1,Ii=100;let q=!1,he=!1,Z=null,me=!1;const D=function(){const a="ontouchstart"in window||navigator.maxTouchPoints>0,t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),e=a||t;return console.log("Mobile detection:",{touch:a,userAgent:t,isMobile:e}),e}(),Gt={},fe=new _e(D);let $=null,nt="third-person",ot=0,et=0,pe=!1;const Me=.002,ke=.005,se=Math.PI/2-.1;function xe(a){for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;return a}let gt=!1,wt=0;const Fi=.5;let te=new r.Vector3,Et=new r.Vector3,ee=new r.Quaternion,oe=new r.Quaternion,ft="third-person",Kt=0;const Ce=.2;let ge=!1,Yt=!1,ne=2,ae=!1,Nt=!1,jt=!1,Mt=null,Zt=!1,j=null;function Li(){var i,s;J=new r.Scene;const a=((i=h==null?void 0:h.scene)==null?void 0:i.backgroundColor)||"#a8def0";J.background=new r.Color(a);const t=(h==null?void 0:h.camera)||{};P=new r.PerspectiveCamera(t.fov||60,window.innerWidth/window.innerHeight,t.near||.1,t.far||1e3),P.position.set(0,5,10),E=new r.WebGLRenderer({antialias:!1,powerPreference:"high-performance"}),E.setSize(window.innerWidth,window.innerHeight),E.setPixelRatio(D?1:Math.min(window.devicePixelRatio,2)),E.shadowMap.enabled=!0,E.shadowMap.type=r.PCFSoftShadowMap,document.body.appendChild(E.domElement),U=new Oe({renderer:E,maxStdDev:Math.sqrt(D?5:7),minPixelRadius:D?.5:.3,maxPixelRadius:D?256:384,minAlpha:D?1/255:.7/255,clipXY:D?1.6:2,falloff:D?.8:.95}),J.add(U),D&&(U.defaultView.sortDistance=.05,U.defaultView.sortCoorient=.97,console.log("Mobile sorting optimizations applied")),Z=new r.Raycaster,zi();const e=((s=h==null?void 0:h.camera)==null?void 0:s.orbitControls)||{};R=new Ye(P,E.domElement),R.enableDamping=e.enableDamping!==void 0?e.enableDamping:!0,R.minDistance=e.minDistance||1,R.maxDistance=e.maxDistance||5,R.enablePan=e.enablePan!==void 0?e.enablePan:!1,R.maxPolarAngle=Math.PI*(e.maxPolarAngle||.55),R.update(),D&&($=new Ke(Gt,R),$.setFirstPersonCallback(es),$.setPaintCallback(Wi),$.setPaintEndCallback(Ui),console.log("Touch controls initialized early (before character load)")),console.log("Scene initialized")}function zi(){var l,c;const a=((l=h==null?void 0:h.lighting)==null?void 0:l.ambient)||{};J.add(new r.AmbientLight(a.color||16777215,a.intensity!==void 0?a.intensity:.7));const t=((c=h==null?void 0:h.lighting)==null?void 0:c.directional)||{};K=new r.DirectionalLight(t.color||16777215,t.intensity!==void 0?t.intensity:1),K.castShadow=t.castShadow!==void 0?t.castShadow:!0;const e=t.shadowCamera||{};K.shadow.camera.top=e.top||50,K.shadow.camera.bottom=e.bottom||-50,K.shadow.camera.left=e.left||-50,K.shadow.camera.right=e.right||50,K.shadow.camera.near=e.near||.1,K.shadow.camera.far=e.far||200;const i=t.shadowMapSize,s=typeof i=="number"?i:2048,o=(i==null?void 0:i.width)||s,n=(i==null?void 0:i.height)||s;K.shadow.mapSize.width=o,K.shadow.mapSize.height=n,J.add(K),ie()}function Di(){var e;const a=new be,t=((e=h==null?void 0:h.assets)==null?void 0:e.collisionFile)||"models/StoneHenge-collision.glb";a.load(t,i=>{var tt,xt,Y,Pe;let s;if(i.scene.traverse(N=>{N instanceof r.Mesh&&!s&&(s=N)}),!s){console.error("No mesh found in collision GLB file");return}const o=s,n=new r.MeshStandardMaterial({color:8421504,roughness:.8,metalness:.2,side:r.DoubleSide}),l=o.geometry;M=new r.Mesh(l,n),M.position.copy(o.position),M.rotation.copy(o.rotation),M.scale.copy(o.scale),M.applyMatrix4(i.scene.matrix),M.scale.multiplyScalar(St),M.rotation.x+=Xt*(Math.PI/180),M.rotation.y+=qt*(Math.PI/180),M.rotation.z+=Jt*(Math.PI/180),M.position.y=0,M.receiveShadow=!0,M.castShadow=!0,M.visible=!1,J.add(M);try{l.boundingBox||l.computeBoundingBox();const N=l.boundingBox.clone();N.min.multiplyScalar(St),N.max.multiplyScalar(St);const _t=new r.Vector3(N.min.x,-N.max.y,N.min.z),Vt=new r.Vector3(N.max.x,-N.min.y,N.max.z);pt=Vt.y,console.log(`[Collision Mesh] World bounding box (at Y=0): min.y=${_t.y.toFixed(2)}, max.y=${Vt.y.toFixed(2)}`),console.log(`[Collision Mesh] maxTerrainHeight = ${pt.toFixed(2)} (highest walkable point after all transforms)`),ct=_t.y<0?-_t.y:0,ht=Vt.y>0?-Vt.y:0,console.log(`[Height Offset Bounds] Calculated from worldBBox: min.y=${_t.y.toFixed(2)}, max.y=${Vt.y.toFixed(2)}`),console.log(`[Height Offset Bounds] Range: ${ht.toFixed(2)} to ${ct.toFixed(2)} (scaled units)`)}catch(N){console.error("[Collision Mesh] Failed to calculate bounds:",N),pt=100,ct=0,ht=-100}lt==="max"?(B=ct,console.log(`[Height Offset] Resolved "max" to ${B.toFixed(2)}`)):lt==="min"&&(B=ht,console.log(`[Height Offset] Resolved "min" to ${B.toFixed(2)}`)),cs(),M.position.y=B;const c=new r.PlaneGeometry(1e4,1e4),d=new r.TextureLoader,u=((xt=(tt=h==null?void 0:h.assets)==null?void 0:tt.textures)==null?void 0:xt.floor)||{},f=d.load(u.color||"textures/sand/Sand 002_COLOR.jpg"),p=d.load(u.normal||"textures/sand/Sand 002_NRM.jpg"),y=d.load(u.displacement||"textures/sand/Sand 002_DISP.jpg"),k=d.load(u.ao||"textures/sand/Sand 002_OCC.jpg"),w=1e3;[f,p,y,k].forEach(N=>{N.wrapS=r.RepeatWrapping,N.wrapT=r.RepeatWrapping,N.repeat.set(w,w)});const C=new r.MeshStandardMaterial({map:f,normalMap:p,displacementMap:y,displacementScale:0,aoMap:k,aoMapIntensity:1,roughness:.9,metalness:0,side:r.DoubleSide});X=new r.Mesh(c,C),X.rotation.x=-Math.PI/2,X.position.y=0,X.receiveShadow=!0,X.visible=((Pe=(Y=h==null?void 0:h.scene)==null?void 0:Y.infiniteFloor)==null?void 0:Pe.visible)!==!1,J.add(X);const O=new r.WireframeGeometry(l),L=new r.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.8});j=new r.LineSegments(O,L),j.position.copy(M.position),j.rotation.copy(M.rotation),j.scale.copy(M.scale),j.visible=!1,J.add(j),console.log("Collision mesh loaded successfully (invisible, use for physics only)"),console.log("Press G to toggle collision wireframe, H to toggle Gaussian splat, R to reset Magic effect, F to toggle infinite floor, L to toggle leveling controls"),console.log("Press M to toggle background music, N to toggle movement sounds"),At(),Nt=!0;const T=document.getElementById("collision-progress-bar"),A=document.getElementById("collision-progress-text"),z=document.getElementById("start-collision-bar"),it=document.getElementById("start-collision-text");T&&A&&(T.style.width="100%",A.textContent="100%"),z&&it&&(z.style.width="100%",it.textContent="100%"),ve(),Vi(),$i()},i=>{const s=i.total>0?Math.min(100,Math.round(i.loaded/i.total*100)):0;console.log("Collision mesh: "+s+"% loaded");const o=document.getElementById("collision-progress-bar"),n=document.getElementById("collision-progress-text"),l=document.getElementById("start-collision-bar"),c=document.getElementById("start-collision-text");o&&n&&(o.style.width=s+"%",n.textContent=s+"%"),l&&c&&(l.style.width=s+"%",c.textContent=s+"%")},i=>{console.error("Error loading collision mesh:",i)})}function At(){const a=Xt*(Math.PI/180),t=qt*(Math.PI/180),e=Jt*(Math.PI/180),i=Dt*(Math.PI/180),s=Ot*(Math.PI/180),o=B;M&&(M.position.y=o,M.rotation.x=a,M.rotation.y=t,M.rotation.z=e,M.rotation.x+=i,M.rotation.z+=s),b&&(b.position.y=o,b.rotation.x=a,b.rotation.y=t,b.rotation.z=e,b.rotation.x+=i,b.rotation.z+=s),j&&(j.position.y=o,j.rotation.x=a,j.rotation.y=t,j.rotation.z=e,j.rotation.x+=i,j.rotation.z+=s),console.log(`Leveling applied: X=${Dt.toFixed(1)}Â°, Z=${Ot.toFixed(1)}Â°, Height=${B.toFixed(2)}`)}function ie(){if(!K)return;const a=Lt*Math.PI/180,t=zt*Math.PI/180,e=100,i=e*Math.cos(t)*Math.sin(a),s=e*Math.sin(t),o=e*Math.cos(t)*Math.cos(a);K.position.set(i,s,o),console.log(`Light orientation: Azimuth=${Lt}Â°, Elevation=${zt}Â°, Position=(${i.toFixed(1)}, ${s.toFixed(1)}, ${o.toFixed(1)})`)}function Oi(){var i;const a=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},t=a.expansionRadius??ue,e=a.duration||2;return console.log(`Creating magic modifier: radius=${t.toFixed(1)}, duration=${e.toFixed(1)}s ${a.expansionRadius?"(from config)":"(auto-calculated)"}`),v.dynoBlock({gsplat:v.Gsplat},{gsplat:v.Gsplat},({gsplat:s})=>(s=new v.Dyno({inTypes:{gsplat:v.Gsplat,t:"float"},outTypes:{gsplat:v.Gsplat},globals:()=>[v.unindent(`
            // Pseudo-random hash function for noise generation
            vec3 hash(vec3 p) {
              p = fract(p * 0.3183099 + 0.1);
              p *= 17.0;
              return fract(vec3(p.x * p.y * p.z, p.x + p.y * p.z, p.x * p.y + p.z));
            }

            // 3D Perlin-style noise function
            vec3 noise(vec3 p) {
              vec3 i = floor(p);
              vec3 f = fract(p);
              f = f * f * (3.0 - 2.0 * f);

              vec3 n000 = hash(i + vec3(0,0,0));
              vec3 n100 = hash(i + vec3(1,0,0));
              vec3 n010 = hash(i + vec3(0,1,0));
              vec3 n110 = hash(i + vec3(1,1,0));
              vec3 n001 = hash(i + vec3(0,0,1));
              vec3 n101 = hash(i + vec3(1,0,1));
              vec3 n011 = hash(i + vec3(0,1,1));
              vec3 n111 = hash(i + vec3(1,1,1));

              vec3 x0 = mix(n000, n100, f.x);
              vec3 x1 = mix(n010, n110, f.x);
              vec3 x2 = mix(n001, n101, f.x);
              vec3 x3 = mix(n011, n111, f.x);

              vec3 y0 = mix(x0, x1, f.y);
              vec3 y1 = mix(x2, x3, f.y);

              return mix(y0, y1, f.z);
            }
          `)],statements:({inputs:n,outputs:l})=>v.unindentLines(`
          ${l.gsplat} = ${n.gsplat};
          float t = ${n.t};
          float s = smoothstep(0., ${e.toFixed(1)}, t) * ${t.toFixed(1)};
          vec3 scales = ${n.gsplat}.scales;
          vec3 localPos = ${n.gsplat}.center;
          float l = length(localPos.xz);

          // Magic Effect: Complex twister with noise and radial reveal (${t} unit radius in ${e} seconds)
          float border = abs(s-l-.5);
          localPos *= 1.-.2*exp(-20.*border);
          vec3 finalScales = mix(scales,vec3(0.002),smoothstep(s-.5,s,l+.5));
          ${l.gsplat}.center = localPos + .1*noise(localPos.xyz*2.+t*.5)*smoothstep(s-.5,s,l+.5);
          ${l.gsplat}.scales = finalScales;
          float at = atan(localPos.x,localPos.z)/3.1416;
          ${l.gsplat}.rgba *= step(at,t-3.1416);
          ${l.gsplat}.rgba += exp(-20.*border) + exp(-50.*abs(t-at-3.1416))*.5;
        `)}).apply({gsplat:s,t:le}).gsplat,{gsplat:s}))}function Gi(a,t,e,i,s,o,n,l,c){return v.dynoBlock({gsplat:v.Gsplat},{gsplat:v.Gsplat},({gsplat:d})=>{if(!d)throw new Error("No gsplat input");let{center:u,rgb:f}=v.splitGsplat(d).outputs;const p=v.dot(s,v.sub(u,i)),y=v.add(i,v.mul(s,p)),k=v.length(v.sub(y,u)),w=v.lessThan(k,t),C=v.length(v.sub(y,l)),O=v.lessThan(C,c),L=v.and(v.greaterThan(p,v.dynoFloat(0)),v.lessThan(p,e)),T=v.select(n,O,L),A=v.and(w,T),z=v.select(a,v.select(A,o,f),f);return d=v.combineGsplat({gsplat:d,rgb:z}),{gsplat:d}})}async function Vi(){var a,t,e,i;console.log("Loading Gaussian splat...");try{const s=document.getElementById("splat-progress-bar"),o=document.getElementById("splat-progress-text"),n=document.getElementById("start-splat-bar"),l=document.getElementById("start-splat-text");s&&o&&(s.style.width="10%",o.textContent="10%"),n&&l&&(n.style.width="10%",l.textContent="10%");const c=((a=h==null?void 0:h.assets)==null?void 0:a.splatFile)||"models/StoneHenge.sog";b=new Ge({url:c}),console.log("SplatMesh created, waiting for initialization..."),s&&o&&(s.style.width="50%",o.textContent="50%"),n&&l&&(n.style.width="50%",l.textContent="50%"),await b.initialized,console.log("SplatMesh initialized successfully");const d=b.getBoundingBox(!1),u=new r.Vector3;d.getSize(u);const f=Math.max(u.x,u.y,u.z),p=u.length()/2;console.log("Splat bounding box (local space):"),console.log("  min:",d.min),console.log("  max:",d.max),console.log("  extent:",u),console.log("  max dimension:",f.toFixed(2)),console.log("  radius (center to corner):",p.toFixed(2));const y=p*St*1.5,k=((t=h==null?void 0:h.camera)==null?void 0:t.far)||1e3,w=Math.max(y,k);P&&(P.far=w,P.updateProjectionMatrix(),console.log(`Camera far plane: config=${k}, auto=${y.toFixed(0)}, using=${w.toFixed(0)}`)),ue=Math.sqrt(u.x*u.x+u.z*u.z)/2*1.1,console.log(`Magic effect expansion radius: auto=${ue.toFixed(1)} (in splat space)`);const O=(e=h==null?void 0:h.character)==null?void 0:e.maxHeight;if(console.log(`[Height Cap Config] configMaxHeight="${O}", maxTerrainHeight=${pt.toFixed(2)}, heightOffset=${B.toFixed(2)}`),O==="auto"){const Y=pt+B;Q=Y*2,console.log(`[Height Cap] Set to ${Q.toFixed(2)} (auto: 2Ã— actual terrain height ${Y.toFixed(2)} = 2Ã— (${pt.toFixed(2)} + ${B.toFixed(2)}))`)}else if(typeof O=="number")O<0?(Q=null,console.log(`[Height Cap] Set to NONE (unlimited) - config value: ${O}`)):(Q=O,console.log(`[Height Cap] Set to ${Q.toFixed(2)} (absolute from config)`));else{const Y=pt+B;Q=Y*2,console.log(`[Height Cap] Set to ${Q.toFixed(2)} (default auto: 2Ã— actual terrain height ${Y.toFixed(2)} = 2Ã— (${pt.toFixed(2)} + ${B.toFixed(2)}))`)}console.log(`[Height Cap Final] maxCharacterHeight = ${Q===null?"null (unlimited)":Q.toFixed(2)}`),x&&(x.maxHeight=Q,console.log(`[Height Cap] Updated existing CharacterControls.maxHeight to ${Q===null?"null (unlimited)":Q.toFixed(2)}`)),s&&o&&(s.style.width="100%",o.textContent="100%"),n&&l&&(n.style.width="100%",l.textContent="100%"),b.scale.multiplyScalar(St),b.rotation.x+=Xt*(Math.PI/180),b.rotation.y+=qt*(Math.PI/180),b.rotation.z+=Jt*(Math.PI/180),b.position.y=B,U.add(b),b.visible=!1,At(),jt=!0,I&&(I.gaussianSplat=b,console.log("Gaussian splat reference set in XRManager"));const L=30,T=20,A=50,z=D?T:L,it=D?2:0;F=new bi(U,E,z,it),F.vrTargetFPS=A,F.desktopTargetFPS=L,F.mobileTargetFPS=T,console.log("Adaptive quality system initialized");const tt=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},xt=tt.enabled!==!1&&(!D||tt.mobileEnabled===!0);if(console.log("Magic effect config check:",{enabled:tt.enabled,mobileEnabled:tt.mobileEnabled,isMobile:D,shouldEnableEffect:xt}),xt)try{b.objectModifier=Oi(),b.updateGenerator(),console.log(`Gaussian splat loaded with Magic effect (${D?"mobile":"desktop"}) - awaiting user interaction`),console.log("Magic effect modifier attached:",!!b.objectModifier)}catch(Y){console.error("Error applying Magic effect modifier:",Y),console.log("Gaussian splat loaded without Magic effect (shader compilation failed)")}else console.log(`Gaussian splat loaded without Magic effect (${D?"mobile not enabled in config":"disabled in config"})`);try{b.worldModifier=Gi(m.enabled,m.brushRadius,m.brushDepth,m.brushOrigin,m.brushDirection,m.brushColor,m.useSurface,m.surfacePoint,m.surfaceRadius),b.splatRgba=new Ve,console.log("[Paint] Pre-initialized empty splatRgba for shader compatibility"),b.updateGenerator(),console.log("Brush modifier applied to Gaussian splat"),Xi()}catch(Y){console.error("Error applying brush modifier:",Y)}ve()}catch(s){console.error("Error loading Gaussian splat:",s)}}async function ve(){if(Zt)return;const a=document.getElementById("start-loading-bars"),t=document.getElementById("start-button");a&&(Nt&&jt?(Zt=!0,Mt&&(clearTimeout(Mt),Mt=null),console.log("All assets loaded, showing buttons..."),setTimeout(async()=>{a.style.display="none";const e=document.getElementById("username-container"),i=document.getElementById("username-input");if(e&&i){const s=localStorage.getItem($t);if(s)i.value=s,st=s;else{const o=`Player_${Math.random().toString(36).substring(2,6).toUpperCase()}`;i.value=o,st=o}e.style.display="block",i.addEventListener("input",()=>{const o=i.value.trim();o&&(st=o,localStorage.setItem($t,o))})}t&&(t.style.display="inline-block"),console.log("Assets loaded, start button shown")},500)):Mt||(console.log("Assets not fully loaded, setting fallback timeout..."),Mt=setTimeout(async()=>{if(Nt&&jt&&!Zt){Zt=!0,console.log("Loading timeout: assets confirmed loaded, showing buttons"),a.style.display="none";const e=document.getElementById("username-container"),i=document.getElementById("username-input");if(e&&i){const s=localStorage.getItem($t);if(s)i.value=s,st=s;else{const o=`Player_${Math.random().toString(36).substring(2,6).toUpperCase()}`;i.value=o,st=o}e.style.display="block",i.addEventListener("input",()=>{const o=i.value.trim();o&&(st=o,localStorage.setItem($t,o))})}t&&(t.style.display="inline-block")}else(!Nt||!jt)&&(console.warn("Loading timeout: assets STILL not loaded, waiting longer..."),Mt=null,setTimeout(()=>ve(),2e3))},1e4)))}function Bi(){var t,e;if(ge){console.log("Magic reveal already started");return}if(ge=!0,Yt=!1,ne=(((t=h==null?void 0:h.scene)==null?void 0:t.magicEffect)||{}).duration||2,b&&(b.visible=!0),b&&b.objectModifier?(Tt=0,le.value=0,console.log(`Magic reveal animation started (duration: ${ne}s)`)):(console.log("Gaussian splat not ready for animation, skipping magic effect"),Yt=!0,Ie()),V&&(V.startBackgroundMusic(),console.log("Background music started")),V){const s=(((e=h==null?void 0:h.scene)==null?void 0:e.magicEffect)||{}).soundDelay||0;V.playMagicReveal(s),console.log(`Magic reveal sound will play in ${s}s`)}}function $i(){var e;const a=new be,t=((e=h==null?void 0:h.assets)==null?void 0:e.characterFile)||"models/Soldier.glb";a.load(t,i=>{var O,L,T,A;const s=i.scene;s.traverse(z=>{z.isMesh&&(z.castShadow=!0)}),J.add(s);const o=i.animations,n=new r.AnimationMixer(s),l=new Map;o.forEach(z=>{l.set(z.name,n.clipAction(z))});const c=((O=h==null?void 0:h.camera)==null?void 0:O.offsetFromCharacter)||{x:0,y:2,z:5},d=((T=(L=h==null?void 0:h.camera)==null?void 0:L.targetOffset)==null?void 0:T.y)||1;x=new We(s,n,l,R,P,"Idle",[M,X],Q,d);const u=((A=h==null?void 0:h.character)==null?void 0:A.spawn)||{},f=u.position||{x:0,y:"auto",z:40},p=u.rotation||{y:0};s.position.x=f.x,s.position.z=f.z,s.rotation.y=p.y*(Math.PI/180),f.y==="auto"?(s.position.y=1e3,console.log(`Auto-detecting ground height at spawn position (${f.x}, ${f.z})...`),x.placeOnGround()):(s.position.y=f.y,console.log(`Character spawned at specified position (${f.x}, ${f.y}, ${f.z})`));const k=new r.Vector3(c.x,c.y,c.z).clone().applyQuaternion(s.quaternion);P.position.set(s.position.x+k.x,s.position.y+k.y,s.position.z+k.z);const C=new r.Vector3(0,d,0).clone().applyQuaternion(s.quaternion);R.target.set(s.position.x+C.x,s.position.y+C.y,s.position.z+C.z),R.syncFromCamera(),R.update(),console.log("Character loaded successfully at position:",s.position),console.log("Camera positioned at:",P.position),console.log("Character facing east (rotation Y:",s.rotation.y,")"),console.log("Available animations:",Array.from(l.keys())),D&&(x.toggleRun=!0,console.log("Mobile: run mode enabled by default")),Hi(),Ni(t)},i=>{console.log(i.loaded/i.total*100+"% loaded")},i=>{console.error("Error loading character:",i)})}function Hi(){I=new ai(E,P,J,h),_=new ri(E,J,I),_.setGroundMeshes([M,X]),Bt=new li(E,J,x==null?void 0:x.model),dt=new gi(J,Bt),G=new pi(Bt,I,dt),W=new yi(J),G.callbacks.onPaintStart=(a,t,e)=>{console.log(`Gesture paint start (${a})`),b&&(m.brushOrigin.value.copy(t),m.brushDirection.value.copy(e),m.enabled.value=!0),W&&W.updatePaintRay(a,t,e,!0)},G.callbacks.onPaintDrag=(a,t,e)=>{if(!b)return;m.brushOrigin.value.copy(t),m.brushDirection.value.copy(e),m.enabled.value=!0;const i=dt?dt.getSelectedColor():{hex:8913151},s=new r.Color(i.hex).convertLinearToSRGB();m.brushColor.value.x=s.r,m.brushColor.value.y=s.g,m.brushColor.value.z=s.b;const n=new r.Raycaster(t,e).intersectObjects([M,X],!0);n.length>0?(m.useSurface.value=!0,m.surfacePoint.value.copy(n[0].point)):m.useSurface.value=!1,b.splatRgba=U.getRgba({generator:b,rgba:b.splatRgba}),b.updateVersion(),W&&W.updatePaintRay(a,t,e,!0)},G.callbacks.onPaintEnd=a=>{console.log(`Gesture paint end (${a})`),m.enabled.value=!1,W&&W.updatePaintRay(a,null,null,!1)},G.callbacks.onMovementStart=(a,t)=>{console.log(`Movement gesture started: speed=${t.toFixed(2)}`),It=a.clone(),Ft=t},G.callbacks.onMovementUpdate=(a,t)=>{It=a.clone(),Ft=t},G.callbacks.onMovementEnd=()=>{console.log("Movement gesture ended"),It=null,Ft=0},G.callbacks.onJetpackStart=a=>{console.log(`Jetpack gesture started (${a})`),x&&x.activateJetpack()},G.callbacks.onJetpackEnd=a=>{console.log(`Jetpack gesture ended (${a})`),x&&x.deactivateJetpack()},G.callbacks.onColorSelect=(a,t)=>{if(dt){const e=dt.checkHover(a,t);e!==null&&(dt.selectColor(e),G.selectedColorIndex=e,console.log(`Color selected: index ${e}`))}},G.callbacks.onTeleportStart=(a,t)=>{if(console.log("Teleport started (LEFT hand)"),I){const i=new r.Raycaster(a,t).intersectObjects([M,X],!0);i.length>0?I.updateTeleportTarget(i[0].point):I.updateTeleportTarget(null)}},G.callbacks.onTeleportUpdate=(a,t)=>{if(I){const i=new r.Raycaster(a,t).intersectObjects([M,X],!0);i.length>0?I.updateTeleportTarget(i[0].point):I.updateTeleportTarget(null)}},G.callbacks.onTeleportEnd=(a,t)=>{console.log("Teleport executed (LEFT hand released)"),I&&I.executeTeleport()},G.callbacks.onTogglePaintMode=a=>{console.log(`Paint mode toggled via gesture: ${a?"ON":"OFF"}`),_&&(_.isPaintMode=a),b&&(m.enabled.value=a)},I.characterControls=x,I.orbitControls=R,I.xrControllers=_,I.xrHands=Bt,I.gestureDetector=G,console.log("WebXR system initialized with gesture detection")}async function Ni(a){console.log("[MP] Initializing multiplayer..."),H=new wi(Ci),vt=new Si(J,a),b&&U&&(rt=new Ae(b,U,m)),H.onPlayerJoined=async t=>{console.log(`[MP] Player joined: ${t.name}`);try{await vt.addPlayer(t.playerId,t.name)}catch(e){console.error("[MP] Failed to add remote player:",e)}},H.onPlayerLeft=t=>{console.log(`[MP] Player left: ${t.playerId}`),vt.removePlayer(t.playerId)},H.onPlayerState=t=>{vt.updatePlayerState(t.playerId,t.state,t.timestamp)},H.onFullState=async t=>{console.log(`[MP] Received full state with ${Object.keys(t.players||{}).length} players`);for(const[e,i]of Object.entries(t.players||{}))try{const s=await vt.addPlayer(e,i.name,i.state);s&&i.state&&s.setInitialState(i.state)}catch(s){console.error(`[MP] Failed to add existing player ${e}:`,s)}t.paintHistory&&t.paintHistory.length>0&&(console.log(`[MP] Queuing ${t.paintHistory.length} paint history actions (will apply after magic reveal)`),ut.push(...t.paintHistory))},H.onPaintStroke=t=>{console.log("[MP] Received paint_stroke event:",t),Yt?rt&&rt.isReady()?(console.log(`[MP] paintSync is ready, applying remote paint from ${t.playerId}`),rt.applyRemotePaint(t,H.getPlayerId())):(ut.push(t),console.log(`[MP] Queued paint event (paintSync not ready yet), queue size: ${ut.length}`)):(ut.push(t),console.log(`[MP] Queued paint event (magic reveal in progress), queue size: ${ut.length}`))},H.onConnectionChange=t=>{console.log(`[MP] Connection status: ${t?"connected":"disconnected"}`)};try{await H.connect(),console.log("[MP] Connected to multiplayer server (will join room when experience starts)")}catch(t){console.error("[MP] Failed to connect to multiplayer server:",t)}}function ji(){!H||!H.connected||mt&&(console.log(`[MP] Joining room ${mt} as "${st}"`),H.joinRoom(mt,st))}function Ie(){if(!rt||!rt.isReady()||!H){console.log("[MP] Cannot apply pending paint - paintSync not ready");return}if(ut.length===0){console.log("[MP] No pending paint events to apply");return}console.log(`[MP] Applying ${ut.length} pending paint events after magic reveal`);const a=H.getPlayerId();ut.forEach(t=>{rt.applyRemotePaint(t,a)}),ut=[],console.log("[MP] All pending paint events applied")}function Xi(){b&&U&&(rt?rt.updateReferences(b,U):(rt=new Ae(b,U,m),console.log("[MP] PaintSync initialized")))}function qi(){var t,e;const a=((e=(t=h==null?void 0:h.assets)==null?void 0:t.audio)==null?void 0:e.jetpack)||"sounds/thrusters_loopwav-14699.mp3";V=new ni({backgroundMusic:"sounds/happy-relaxing-loop-275536.mp3",walkingSound:"sounds/walking-on-gravel-version-2-308744.mp3",runningSound:"sounds/running-on-gravel-301880.mp3",jetpackSound:a,magicReveal:"sounds/a-magical-intro-395716.mp3"},D),console.log("Audio system initialized - will start on user clicking start button")}function Ji(){const a=document.getElementById("camera-icon-3rd"),t=document.getElementById("camera-icon-1st");nt==="first-person"?(a&&(a.style.display="none"),t&&(t.style.display="block")):(a&&(a.style.display="block"),t&&(t.style.display="none"))}function ye(){var a,t,e;if(!x){console.log("Character not loaded yet");return}if(!gt)if(nt==="third-person"){const i=x.model,s=new r.Euler;s.setFromQuaternion(i.quaternion,"YXZ"),et=xe(s.y),ot=0,te.copy(P.position),ee.copy(P.quaternion),Et.set(i.position.x,i.position.y+x.firstPersonHeadHeight,i.position.z),P.rotation.order="YXZ";const o=new r.Euler(ot,et,0,"YXZ");oe.setFromEuler(o),gt=!0,wt=0,ft="first-person",console.log("Starting transition to first-person mode")}else{const i=x.model;if(i){const s=((a=h==null?void 0:h.camera)==null?void 0:a.offsetFromCharacter)||{x:0,y:2,z:5},o=((e=(t=h==null?void 0:h.camera)==null?void 0:t.targetOffset)==null?void 0:e.y)||1,n=et,l=new r.Quaternion;l.setFromAxisAngle(new r.Vector3(0,1,0),n),i.quaternion.copy(l);const d=new r.Vector3(s.x,s.y,s.z).clone().applyQuaternion(i.quaternion);te.copy(P.position),ee.copy(P.quaternion),Et.set(i.position.x+d.x,i.position.y+d.y,i.position.z+d.z);const f=new r.Vector3(0,o,0).clone().applyQuaternion(l);R.target.set(i.position.x+f.x,i.position.y+f.y,i.position.z+f.z);const p=Et.distanceTo(R.target);console.log("Transition target distance:",p.toFixed(3)),console.log("WorldOffset:",d),console.log("TargetOffsetY:",o),gt=!0,wt=0,ft="third-person",console.log("Starting transition to third-person mode"),console.log("Start pos:",te),console.log("Start quat:",ee),console.log("Target pos (OrbitControls final):",Et),console.log("Target quat (OrbitControls final):",oe)}}}function Yi(){const a=document.getElementById("camera-toggle-button");a&&(a.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ye()}),D&&a.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),ye()},{passive:!1}),console.log("Camera toggle button initialized"))}function _i(){const a=document.getElementById("paint-toggle-button");a&&D&&(a.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),Re()}),a.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),Re()},{passive:!1}),console.log("Paint toggle button initialized"))}function Re(){q=!q;const a=document.getElementById("paint-toggle-button");a&&(q?a.classList.add("active"):a.classList.remove("active")),$&&$.setPaintMode(q),console.log(`Mobile paint mode: ${q?"ON":"OFF"}`)}function Wi(a,t){if(!q||!b||!Z)return;const e=new r.Vector3(1,0,1),i=E.domElement.getBoundingClientRect(),s=new r.Vector2;s.x=(a-i.left)/i.width*2-1,s.y=-((t-i.top)/i.height)*2+1,Z.setFromCamera(s,P),m.brushOrigin.value.copy(Z.ray.origin),m.brushDirection.value.copy(Z.ray.direction),m.brushColor.value.copy(e);const o=Z.intersectObjects([M,X],!0);o.length>0?(m.useSurface.value=!0,m.surfacePoint.value.copy(o[0].point)):m.useSurface.value=!1,m.enabled.value=!0;const n=o.length>0?o[0].point:null;re(n)}function Ui(){m&&m.enabled&&(m.enabled.value=!1)}function Qi(){const a=document.getElementById("jump-jetpack-button");if(a&&D){let t=null;const e=400;a.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),Gt[" "]=!0,setTimeout(()=>{(!$||!$.jetpackActive)&&(Gt[" "]=!1)},50),t=setTimeout(()=>{$&&($.activateJetpack(),a.classList.add("jetpack-active"))},e)},{passive:!1}),a.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),t&&(clearTimeout(t),t=null),$&&$.jetpackActive&&($.deactivateJetpack(),a.classList.remove("jetpack-active"))},{passive:!1}),a.addEventListener("touchcancel",i=>{t&&(clearTimeout(t),t=null),$&&$.jetpackActive&&($.deactivateJetpack(),a.classList.remove("jetpack-active"))},{passive:!1}),console.log("Jump/jetpack button initialized")}}function Ki(a){nt==="first-person"&&pe&&(et-=a.movementX*Me,et=xe(et),ot-=a.movementY*Me,ot=Math.max(-se,Math.min(se,ot)),x&&x.setFirstPersonRotation(ot,et))}function Zi(){pe=document.pointerLockElement===E.domElement,console.log(`Pointer lock: ${pe?"LOCKED":"UNLOCKED"}`)}function ts(){console.error("Pointer lock failed")}function Fe(){nt==="first-person"&&!D&&!q&&E.domElement.requestPointerLock()}function Le(){document.pointerLockElement===E.domElement&&document.exitPointerLock()}function es(a,t){nt==="first-person"&&(et-=a*ke,et=xe(et),ot-=t*ke,ot=Math.max(-se,Math.min(se,ot)),x&&x.setFirstPersonRotation(ot,et))}function is(){q=!q,m.enabled.value=q,b&&(b.needsUpdate=!0);const a=document.getElementById("paint-controls");a&&(q?a.classList.add("visible"):a.classList.remove("visible")),q?E.domElement.classList.add("paint-mode"):E.domElement.classList.remove("paint-mode"),q?(Le(),nt==="third-person"&&(R.enabled=!1),console.log("Paint mode: ON - LEFT-click drag or CTRL+move to paint, camera rotation disabled")):(nt==="first-person"?Fe():nt==="third-person"&&(R.enabled=!0),console.log("Paint mode: OFF"))}function Te(a){const t=m.brushRadius.value,e=Math.max(Ti,Math.min(Ei,t+a));m.brushRadius.value=e,console.log(`Brush radius: ${e.toFixed(3)}`),we()}function Ee(a){const t=m.brushDepth.value,e=Math.max(Ai,Math.min(Ii,t+a));m.brushDepth.value=e,console.log(`Brush depth: ${e.toFixed(1)}`),we()}function we(){const a=document.getElementById("brush-size-display");a&&(a.textContent=`Radius: ${m.brushRadius.value.toFixed(3)} | Depth: ${m.brushDepth.value.toFixed(1)}`)}function re(a=null){if(!(!b||!U)&&(console.log("[MP] bakePaintAndBroadcast - brush params BEFORE getRgba:",{origin:{x:m.brushOrigin.value.x,y:m.brushOrigin.value.y,z:m.brushOrigin.value.z},direction:{x:m.brushDirection.value.x,y:m.brushDirection.value.y,z:m.brushDirection.value.z},enabled:m.enabled.value}),b.splatRgba=U.getRgba({generator:b,rgba:b.splatRgba}),b.updateVersion(),console.log("[MP] bakePaintAndBroadcast - brush params AFTER getRgba:",{origin:{x:m.brushOrigin.value.x,y:m.brushOrigin.value.y,z:m.brushOrigin.value.z},direction:{x:m.brushDirection.value.x,y:m.brushDirection.value.y,z:m.brushDirection.value.z},enabled:m.enabled.value}),H&&H.isConnected())){const t=ki(m,a);console.log("[MP] Sending paint stroke:",t),H.sendPaintStroke(t)}}function ss(){const a=document.getElementById("color-picker");a&&(a.addEventListener("input",t=>{const e=t.target.value,i=new r.Color(e).convertLinearToSRGB();m.brushColor.value.x=i.r,m.brushColor.value.y=i.g,m.brushColor.value.z=i.b,console.log(`Brush color changed to: ${e}`,i)}),console.log("Color picker initialized")),we()}function os(){E.domElement.addEventListener("pointermove",a=>{if(!q||!b||!Z)return;const t=new r.Vector2(a.clientX/window.innerWidth*2-1,-(a.clientY/window.innerHeight)*2+1);Z.setFromCamera(t,P);const e=Z.ray.direction.normalize();if(m.brushDirection.value.x=e.x,m.brushDirection.value.y=e.y,m.brushDirection.value.z=e.z,m.brushOrigin.value.x=Z.ray.origin.x,m.brushOrigin.value.y=Z.ray.origin.y,m.brushOrigin.value.z=Z.ray.origin.z,M){const i=Z.intersectObject(M,!1);if(i.length>0){const s=i[0].point;m.useSurface.value=!0,m.surfacePoint.value.x=s.x,m.surfacePoint.value.y=s.y,m.surfacePoint.value.z=s.z}else m.useSurface.value=!1}else m.useSurface.value=!1;if(b&&(b.needsUpdate=!0),(he||me)&&b){const i=m.useSurface.value?m.surfacePoint.value.clone():null;re(i)}}),E.domElement.addEventListener("pointerdown",a=>{if(!q||!b||a.button!==0)return;a.preventDefault(),he=!0;const t=m.useSurface.value?m.surfacePoint.value.clone():null;re(t)}),E.domElement.addEventListener("pointerup",a=>{!q||a.button!==0||(he=!1)}),console.log("Paint controls initialized")}function ns(){let a=!1;const t=()=>{!a&&V&&(V.startBackgroundMusic(),a=!0,console.log("Background music started on touch interaction (fallback)"),document.removeEventListener("touchstart",t))};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",e=>{var s;if(!ae)return;const i=e.key.toLowerCase();if(e.key==="Control"&&(me=!0),Gt[i]=!0,fe.down(i),!a&&V&&(V.startBackgroundMusic(),a=!0,console.log("Background music started on keyboard interaction (fallback)")),i==="shift"&&x&&x.switchRunToggle(),i==="g"&&j&&(j.visible=!j.visible,console.log(`Collision mesh wireframe: ${j.visible?"ON":"OFF"}`)),i==="h"&&b&&(b.visible=!b.visible,console.log(`Gaussian splat: ${b.visible?"ON":"OFF"}`)),i==="r"&&b){if(Tt=0,le.value=0,V){const n=(((s=h==null?void 0:h.scene)==null?void 0:s.magicEffect)||{}).soundDelay||0;V.playMagicReveal(n)}console.log("Magic effect reset")}if(i==="f"&&X&&(X.visible=!X.visible,console.log(`Infinite floor: ${X.visible?"ON":"OFF"}`)),i==="l"){const o=document.getElementById("leveling-controls");if(o){o.classList.toggle("visible");const n=o.classList.contains("visible");console.log(`Leveling controls: ${n?"ON":"OFF"}`)}}i==="m"&&V&&V.toggleBackgroundMusic(),i==="n"&&V&&V.toggleMovementSounds(),i==="v"&&ye(),i==="p"&&is(),i==="q"&&F&&F.increaseQuality(),i==="e"&&F&&F.decreaseQuality(),i==="t"&&F&&F.resumeAdaptive(),(i==="="||i==="+")&&Te(.01),(i==="-"||i==="_")&&Te(-.01),i==="["&&Ee(-1),i==="]"&&Ee(1)}),document.addEventListener("keyup",e=>{if(!ae)return;const i=e.key.toLowerCase();e.key==="Control"&&(me=!1),Gt[i]=!1,fe.up(i)}),console.log("Keyboard controls initialized")}async function as(){const a=document.getElementById("start-button"),t=document.getElementById("start-overlay"),e=i=>{if(i.preventDefault(),i.stopPropagation(),!Nt||!jt){console.warn("Assets not fully loaded yet, cannot start experience"),alert("Please wait for assets to finish loading...");return}console.log("Start button triggered - entering experience");const s=document.getElementById("username-input");s&&s.value.trim()&&(st=s.value.trim(),localStorage.setItem($t,st),console.log(`[MP] Using username: ${st}`)),ji(),ae=!0,t.classList.remove("visible"),Bi(),V&&V.unlockAudio().then(()=>{console.log("Audio unlocked successfully in background")}).catch(o=>{console.error("Audio unlock failed:",o)})};a&&(a.addEventListener("click",e),D&&a.addEventListener("touchstart",e,{passive:!1})),console.log("Start button initialized")}function rs(){P.aspect=window.innerWidth/window.innerHeight,P.updateProjectionMatrix(),E.setSize(window.innerWidth,window.innerHeight),fe.updatePosition()}function ls(){var e,i,s,o;const a=Ri.getDelta();if(F){F.update(),Se=F.getFPS();const n=document.getElementById("debug-fps");n&&(n.textContent=Se);const l=document.getElementById("debug-quality");if(l){const d=F.getCurrentQualityName(),u=F.isManualMode()?"MANUAL":"Auto";l.textContent=`${d} (${u})`}const c=document.getElementById("debug-decimation");if(c){const d=F.getCurrentQualityIndex(),u=F.getQualityPresets();c.textContent=`${d}/${u.length-1}`}}if(b&&ae&&(Tt+=1/60,le.value=Tt,b.updateVersion(),ge&&!Yt&&Tt>=ne&&(Yt=!0,console.log(`Magic reveal complete (baseTime: ${Tt.toFixed(2)} >= duration: ${ne})`),Ie())),gt){if(wt+=a/Fi,ft==="third-person"){const c=P.position.distanceTo(R.target);console.log(`[Transition ${(wt*100).toFixed(1)}%] Pos: (${P.position.x.toFixed(3)}, ${P.position.y.toFixed(3)}, ${P.position.z.toFixed(3)}) Distance: ${c.toFixed(6)}`)}if(wt>=1){if(wt=1,P.position.copy(Et),ft==="first-person"?P.quaternion.copy(oe):P.lookAt(R.target),gt=!1,ft==="third-person"&&(Kt=Ce),nt=ft,nt==="first-person")R.enabled=!1,x.model&&(x.model.visible=!1,x.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1,c.material.transparent=!1)})),x.setCameraMode("first-person"),x.setFirstPersonRotation(ot,et),$&&$.setCameraMode("first-person"),Fe(),console.log("Transition to first-person complete");else{x.model&&(x.model.visible=!0,x.model.traverse(f=>{f.isMesh&&f.material&&(f.material.opacity=1,f.material.transparent=!1)})),x.setCameraMode("third-person"),$&&$.setCameraMode("third-person"),Le();const c=x.model,d=((i=(e=h==null?void 0:h.camera)==null?void 0:e.targetOffset)==null?void 0:i.y)||1;if(c){const p=new r.Vector3(0,d,0).clone().applyQuaternion(c.quaternion);R.target.set(c.position.x+p.x,c.position.y+p.y,c.position.z+p.z),console.log("Re-synced OrbitControls target to character position:",R.target)}R.enabled=!0,R.syncFromCamera(),R.update();const u=P.position.distanceTo(R.target);console.log("Transition to third-person complete"),console.log("Final camera pos:",P.position),console.log("Final distance to target:",u.toFixed(3)),console.log("OrbitControls target:",R.target)}Ji()}const n=wt,l=n<.5?2*n*n:-1+(4-2*n)*n;P.position.lerpVectors(te,Et,l),ft==="first-person"?P.quaternion.slerpQuaternions(ee,oe,l):P.lookAt(R.target),x&&x.model&&(ft==="first-person"?l<.7?(x.model.visible=!0,x.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1-l,c.material.transparent=!0)})):x.model.visible=!1:(x.model.visible=!0,x.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=l,c.material.transparent=!0)})))}const t=I&&I.getIsXRActive();if(F){const n=F.targetFPS===F.vrTargetFPS;if(t&&!n)F.setTargetFPS(F.vrTargetFPS);else if(!t&&n){const l=D?F.mobileTargetFPS:F.desktopTargetFPS;F.setTargetFPS(l)}}if(t){if(I.update(a,[M,X]),G){const n=E.xr.getSession();G.update(n,P.position)}if(dt&&dt.update(P.position),It&&Ft>0&&I){const n=((s=h==null?void 0:h.controls)==null?void 0:s.walkSpeed)||1.5,l=((o=h==null?void 0:h.controls)==null?void 0:o.runSpeed)||3,c=n+(l-n)*Ft,d=It.clone().multiplyScalar(c*a);I.updateReferenceSpaceByOffset(d),W&&W.updateMovementArrow(P.position,It,Ft,!0)}else W&&W.hideMovementArrow();if(W&&G)if(G.mode==="jetpack"||G.mode==="moving_jetpack"){const l=E.xr.getSession();if(l){for(const c of l.inputSources)if(c.hand&&c.handedness==="right"){const d=Bt.getJointPosition(c.hand,"wrist");d&&W.updateJetpackGlow("right",d,!0);break}}}else W.hideJetpackGlows();if(_&&_.isPaintMode&&b)for(let n=0;n<2;n++){const l=_.getRayForPainting(n);if(l){console.log(`VR Paint: controller ${n} painting - isDragging: ${_.isDragging}`),m.brushOrigin.value.copy(l.origin),m.brushDirection.value.copy(l.direction);const c=_.paletteColors[_.currentColorIndex],d=new r.Color(c.hex).convertLinearToSRGB();if(m.brushColor.value.x=d.r,m.brushColor.value.y=d.g,m.brushColor.value.z=d.b,m.enabled.value=!0,_.isDragging){console.log("VR Paint: Baking paint to texture");const u=m.useSurface.value?m.surfacePoint.value.clone():null;re(u)}break}}else _&&!_.isPaintMode&&(m.enabled.value=!1);if(x){const n=document.getElementById("debug-state"),l=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist");if(n&&l&&c&&d){const u=I.isGrounded,f=I.jetpackActive;n.textContent=u?"GROUNDED":"IN AIR",n.className=u?"grounded":"in-air",l.textContent="VR Mode",c.textContent=f?"ACTIVE":"OFF",c.className=f?"jetpack-active":"",d.textContent="N/A (VR)"}}}else if(x){gt||x.update(a,Gt);const n=document.getElementById("debug-state"),l=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist"),u=document.getElementById("debug-position");if(n&&l&&c&&d&&u){const f=x.getGroundedState(),p=x.getCurrentAction(),y=x.getJetpackActive(),k=x.getGroundDistance(),w=x.getPosition();n.textContent=f?"GROUNDED":"IN AIR",n.className=f?"grounded":"in-air",l.textContent=p,c.textContent=y?"ACTIVE":"OFF",c.className=y?"jetpack-active":"",d.textContent=k.toFixed(1)+"m",u.textContent=`(${w.x.toFixed(1)}|${w.y.toFixed(1)}|${w.z.toFixed(1)})`}if(V){const f=x.getMovementState();V.updateMovementSounds(f)}}if(V&&V.update(a),H&&H.isConnected()&&(x&&!gt&&H.sendPlayerState(Mi(x)),vt&&vt.update(a)),Kt>0){Kt-=a;const n=P.position.distanceTo(R.target);console.log(`[Post-transition ${((Ce-Kt)*1e3).toFixed(0)}ms] Pos: (${P.position.x.toFixed(3)}, ${P.position.y.toFixed(3)}, ${P.position.z.toFixed(3)}) Distance: ${n.toFixed(6)} OrbitEnabled: ${R.enabled}`)}!gt&&!t&&nt==="third-person"&&R.update(),E.render(J,P)}function cs(){const a=document.getElementById("level-height-slider"),t=document.getElementById("level-height-value");a&&t&&(a.min=ht.toFixed(2),a.max=ct.toFixed(2),a.value=B.toString(),t.textContent=`${B.toFixed(2)} [${ht.toFixed(2)} to ${ct.toFixed(2)}]`,console.log(`[UI] Height slider bounds updated: [${ht.toFixed(2)} to ${ct.toFixed(2)}]`))}function hs(){const a=document.getElementById("level-x-slider"),t=document.getElementById("level-z-slider"),e=document.getElementById("level-height-slider"),i=document.getElementById("light-azimuth-slider"),s=document.getElementById("light-elevation-slider"),o=document.getElementById("level-x-value"),n=document.getElementById("level-z-value"),l=document.getElementById("level-height-value"),c=document.getElementById("light-azimuth-value"),d=document.getElementById("light-elevation-value"),u=document.getElementById("leveling-reset");e&&l&&(e.value=B.toString(),l.textContent=`${B.toFixed(2)} [calculating...]`),a&&a.addEventListener("input",f=>{Dt=parseFloat(f.target.value),o.textContent=Dt.toFixed(1)+"Â°",At()}),t&&t.addEventListener("input",f=>{Ot=parseFloat(f.target.value),n.textContent=Ot.toFixed(1)+"Â°",At()}),e&&e.addEventListener("input",f=>{B=parseFloat(f.target.value),l.textContent=`${B.toFixed(2)} [${ht.toFixed(2)} to ${ct.toFixed(2)}]`,At()}),i&&i.addEventListener("input",f=>{Lt=parseFloat(f.target.value),c.textContent=Lt.toFixed(0)+"Â°",ie()}),s&&s.addEventListener("input",f=>{zt=parseFloat(f.target.value),d.textContent=zt.toFixed(0)+"Â°",ie()}),u&&u.addEventListener("click",()=>{var C,O,L,T,A,z,it,tt;const f=((O=(C=h==null?void 0:h.transform)==null?void 0:C.defaultLeveling)==null?void 0:O.x)||0,p=((T=(L=h==null?void 0:h.transform)==null?void 0:L.defaultLeveling)==null?void 0:T.z)||0;let y=0;lt==="max"?y=ct:lt==="min"?y=ht:typeof lt=="number"&&(y=lt),Dt=f,Ot=p,B=y,a.value=f,t.value=p,e.value=y,o.textContent=f.toFixed(1)+"Â°",n.textContent=p.toFixed(1)+"Â°",l.textContent=`${y.toFixed(2)} [${ht.toFixed(2)} to ${ct.toFixed(2)}]`;const k=((z=(A=h==null?void 0:h.lighting)==null?void 0:A.directional)==null?void 0:z.azimuth)||213,w=((tt=(it=h==null?void 0:h.lighting)==null?void 0:it.directional)==null?void 0:tt.elevation)||37;Lt=k,zt=w,i.value=k,s.value=w,c.textContent=k.toFixed(0)+"Â°",d.textContent=w.toFixed(0)+"Â°",At(),ie(),console.log("All controls reset to defaults")}),console.log("Leveling controls initialized")}async function ds(){try{Rt=await Ze();const a=de(Rt),t=document.getElementById("scene-dropdown"),e=document.getElementById("start-scene-dropdown");t.innerHTML="",e&&(e.innerHTML=""),a.forEach(s=>{const o=document.createElement("option");if(o.value=s.id,o.textContent=s.name,t.appendChild(o),e){const n=document.createElement("option");n.value=s.id,n.textContent=s.name,e.appendChild(n)}});const i=ii(Rt);t.value=i,e&&(e.value=i),t.addEventListener("change",async s=>{const o=s.target.value;o!==mt&&(console.log(`Switching to scene: ${o}`),Pt.navigateToSite(o))}),e&&e.addEventListener("change",async s=>{const o=s.target.value;if(o!==mt){console.log(`Switching to scene: ${o}`),t.value=o;const l=de(Rt).find(c=>c.id===o);if(l){const c=document.getElementById("start-title"),d=document.getElementById("start-description");c&&(c.textContent=l.name),d&&(d.textContent=l.description||"Prepare for an amazing journey")}Pt.navigateToSite(o)}}),console.log("Scene selectors initialized")}catch(a){console.error("Failed to initialize scene selector:",a)}}function us(){sessionStorage.setItem("currentScene",mt),h.transform.scale!==void 0&&(St=h.transform.scale,console.log("Applied scale from config:",St)),h.transform.rotation&&(Xt=h.transform.rotation.x!==void 0?h.transform.rotation.x:180,qt=h.transform.rotation.y!==void 0?h.transform.rotation.y:0,Jt=h.transform.rotation.z!==void 0?h.transform.rotation.z:0,console.log("Applied rotation from config:",Xt,qt,Jt)),h.transform.defaultLeveling&&(Dt=h.transform.defaultLeveling.x||0,Ot=h.transform.defaultLeveling.z||0),h.transform.heightOffset!==void 0&&(lt=h.transform.heightOffset,typeof lt=="number"&&(B=lt),console.log(`[Config] heightOffset config value: ${lt}`)),h.lighting.directional&&(Lt=h.lighting.directional.azimuth,zt=h.lighting.directional.elevation),console.log("Scene configuration applied to global state")}async function ms(a){console.log("Initializing globe view...");const t=document.getElementById("start-overlay");t&&(t.classList.remove("visible"),t.style.display="none");const e=document.getElementById("globe-overlay");if(!e){console.error("Globe container not found");return}ce=new vi(e,i=>{console.log("Site selected:",i),Pt.navigateToSite(i)}),await ce.init(a),ce.show(),console.log("Globe view initialized successfully")}async function fs(){console.log("Initializing F1000..."),await ds(),Pt=new xi;const a=de(Rt);if(Pt.shouldShowGlobe(a)){console.log("No valid site parameter - showing globe"),await ms(a);return}console.log("Valid site parameter found - loading site:",Pt.getCurrentSiteId());let t=Pt.getCurrentSiteId();const e=si(Rt,t);h=await ti(e),mt=t,us();const i=document.getElementById("scene-dropdown");i&&(i.value=mt);const s=document.getElementById("start-scene-dropdown");s&&(s.value=mt);const o=document.getElementById("start-title"),n=document.getElementById("start-description");h&&o&&n&&(o.textContent=h.name||"Unknown Location",n.textContent=h.description||"Prepare for an amazing journey"),Li(),qi(),Di(),ns(),os(),ss(),hs(),as(),Yi(),_i(),Qi(),window.addEventListener("resize",rs),document.addEventListener("mousemove",Ki),document.addEventListener("pointerlockchange",Zi),document.addEventListener("pointerlockerror",ts),E.setAnimationLoop(ls),console.log("F1000 initialized successfully")}fs();
