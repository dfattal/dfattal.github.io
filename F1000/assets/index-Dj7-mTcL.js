var Me=Object.defineProperty;var Se=(l,t,e)=>t in l?Me(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var p=(l,t,e)=>Se(l,typeof t!="symbol"?t+"":t,e);import*as a from"three";import{GLTFLoader as xe}from"three/addons/loaders/GLTFLoader.js";import{dyno as T,SparkRenderer as ke,SplatMesh as Pe}from"@sparkjsdev/spark";import{VRButton as Ce}from"three/addons/webxr/VRButton.js";import{XRControllerModelFactory as Te}from"three/addons/webxr/XRControllerModelFactory.js";import{XRHandModelFactory as De}from"three/addons/webxr/XRHandModelFactory.js";import{OrbitControls as Ee}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as Le,CSS2DObject as Re}from"three/addons/renderers/CSS2DRenderer.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class Fe{constructor(t,e){this.camera=t,this.domElement=e,this.target=new a.Vector3,this.yaw=0,this.pitch=0,this.distance=5,this.minDistance=1,this.maxDistance=10,this.enableDamping=!0,this.dampingFactor=.1,this.targetYaw=0,this.targetPitch=0,this.targetDistance=5,this.maxPolarAngle=Math.PI,this.minPolarAngle=0,this.enablePan=!1,this.enabled=!0,this.isRotating=!1,this.isZooming=!1,this.mouseStart=new a.Vector2,this.mouseCurrent=new a.Vector2,this.rotateSpeed=1,this.zoomSpeed=1,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onWheel=this.onWheel.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.domElement.addEventListener("mousedown",this.onMouseDown),this.domElement.addEventListener("wheel",this.onWheel),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.syncFromCamera()}syncFromCamera(){const t=new a.Vector3().subVectors(this.camera.position,this.target);this.distance=t.length(),this.targetDistance=this.distance;const e=Math.sqrt(t.x*t.x+t.z*t.z);this.yaw=Math.atan2(t.x,t.z),this.pitch=Math.atan2(e,t.y),this.targetYaw=this.yaw,this.targetPitch=this.pitch}rotateLeft(t){this.targetYaw+=t}rotateUp(t){this.targetPitch-=t,this.targetPitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this.targetPitch))}dolly(t){t<0?this.targetDistance/=Math.pow(.95,this.zoomSpeed):t>0&&(this.targetDistance*=Math.pow(.95,this.zoomSpeed)),this.targetDistance=Math.max(this.minDistance,Math.min(this.maxDistance,this.targetDistance))}onMouseDown(t){this.enabled&&t.button===0&&(this.isRotating=!0,this.mouseStart.set(t.clientX,t.clientY),this.mouseCurrent.set(t.clientX,t.clientY),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp))}onMouseMove(t){if(this.isRotating){this.mouseCurrent.set(t.clientX,t.clientY);const e=this.mouseCurrent.x-this.mouseStart.x,i=this.mouseCurrent.y-this.mouseStart.y,s=2*Math.PI*e/this.domElement.clientHeight*this.rotateSpeed,o=2*Math.PI*i/this.domElement.clientHeight*this.rotateSpeed;this.rotateLeft(-s),this.rotateUp(-o),this.mouseStart.copy(this.mouseCurrent)}}onMouseUp(t){t.button===0&&(this.isRotating=!1,document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp))}onWheel(t){this.enabled&&(t.preventDefault(),this.dolly(t.deltaY))}onContextMenu(t){t.preventDefault()}update(){this.enableDamping?(this.yaw+=(this.targetYaw-this.yaw)*this.dampingFactor,this.pitch+=(this.targetPitch-this.pitch)*this.dampingFactor,this.distance+=(this.targetDistance-this.distance)*this.dampingFactor):(this.yaw=this.targetYaw,this.pitch=this.targetPitch,this.distance=this.targetDistance);const t=new a.Vector3(this.distance*Math.sin(this.pitch)*Math.sin(this.yaw),this.distance*Math.cos(this.pitch),this.distance*Math.sin(this.pitch)*Math.cos(this.yaw));return this.camera.position.copy(this.target).add(t),this.camera.lookAt(this.target),!0}getAzimuthalAngle(){return this.yaw}getPolarAngle(){return this.pitch}dispose(){this.domElement.removeEventListener("mousedown",this.onMouseDown),this.domElement.removeEventListener("wheel",this.onWheel),this.domElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}reset(){this.yaw=0,this.pitch=Math.PI/4,this.distance=5,this.targetYaw=this.yaw,this.targetPitch=this.pitch,this.targetDistance=this.distance}saveState(){this.savedYaw=this.yaw,this.savedPitch=this.pitch,this.savedDistance=this.distance}}const yt="w",ht="a",xt="s",dt="d",Ht="shift",Ot=" ",$t="p";class Oe{constructor(t=!1){p(this,"map",new Map);console.log("KeyDisplay: isMobile =",t);const e=this.createKeyDiv(yt,t),i=this.createKeyDiv(ht,t),s=this.createKeyDiv(xt,t),o=this.createKeyDiv(dt,t),n=this.createKeyDiv(Ht,t),r=this.createKeyDiv("SPACE",t),c=this.createKeyDiv($t,t);this.map.set(yt,e),this.map.set(ht,i),this.map.set(xt,s),this.map.set(dt,o),this.map.set(Ht,n),this.map.set(Ot,r),this.map.set($t,c),document.body.appendChild(e),document.body.appendChild(i),document.body.appendChild(s),document.body.appendChild(o),document.body.appendChild(n),document.body.appendChild(r),document.body.appendChild(c),this.updatePosition()}createKeyDiv(t,e=!1){const i=document.createElement("div");return i.style.position="absolute",i.style.padding="8px 12px",i.style.minWidth="40px",i.style.textAlign="center",i.style.fontFamily="'Courier New', monospace",i.style.fontSize="16px",i.style.fontWeight="bold",i.style.color="#333",i.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",i.style.border="1px solid #999",i.style.borderRadius="4px",i.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",i.style.transition="all 0.1s ease",i.style.userSelect="none",i.style.opacity="0.6",i.textContent=t.toUpperCase(),e&&(i.style.display="none"),i}updatePosition(){this.map.get(yt).style.top=`${window.innerHeight-80-45}px`,this.map.get(yt).style.left="168px",this.map.get(ht).style.top=`${window.innerHeight-80}px`,this.map.get(ht).style.left="100px",this.map.get(xt).style.top=`${window.innerHeight-80}px`,this.map.get(xt).style.left="168px",this.map.get(dt).style.top=`${window.innerHeight-80}px`,this.map.get(dt).style.left=`${100+68*2}px`,this.map.get(Ht).style.top=`${window.innerHeight-80}px`,this.map.get(Ht).style.left="21px",this.map.get(Ot).style.top=`${window.innerHeight-80}px`,this.map.get(Ot).style.left=`${100+68*3+15}px`,this.map.get($t).style.top=`${window.innerHeight-80}px`,this.map.get($t).style.left=`${100+68*4+15*2}px`}down(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #00ff00, #00cc00)",e.style.color="#000",e.style.boxShadow="0 1px 2px rgba(0,0,0,0.3), inset 0 2px 4px rgba(0,0,0,0.2)",e.style.transform="translateY(2px)",e.style.opacity="1")}up(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",e.style.color="#333",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",e.style.transform="translateY(0)",e.style.opacity="0.6")}}class Ie{constructor(t,e,i,s,o,n,r,c=null,d=1){p(this,"currentAction");p(this,"toggleRun",!0);p(this,"walkVelocity",2);p(this,"runVelocity",5);p(this,"jumpForce",8);p(this,"gravity",-20);p(this,"maxFallSpeed",-50);p(this,"jumpCooldownDuration",.3);p(this,"characterHeightOffset",0);p(this,"maxHeight",null);p(this,"verticalVelocity",0);p(this,"isGrounded",!0);p(this,"jumpCooldown",0);p(this,"timeInAir",0);p(this,"airTimeThreshold",.4);p(this,"isJetpackActive",!1);p(this,"jetpackThrust",25);p(this,"jetpackTransitionDuration",.3);p(this,"jetpackTransitionTimer",0);p(this,"inertiaVelocityX",0);p(this,"inertiaVelocityZ",0);p(this,"hasInertia",!1);p(this,"raycaster",new a.Raycaster);p(this,"groundMeshes",[]);p(this,"rayOrigin",new a.Vector3);p(this,"rayDirection",new a.Vector3(0,-1,0));p(this,"forwardRaycaster",new a.Raycaster);p(this,"ceilingRaycaster",new a.Raycaster);p(this,"forwardGroundRaycaster",new a.Raycaster);p(this,"forwardCollisionDistance",.5);p(this,"ceilingCollisionDistance",2.5);p(this,"maxSlopeAngle",Math.PI/3);p(this,"maxStepHeight",.5);p(this,"tempCollisionVector",new a.Vector3);p(this,"tempCollisionNormal",new a.Vector3);p(this,"tempSlideVector",new a.Vector3);p(this,"walkDirection",new a.Vector3);p(this,"rotateAngle",new a.Vector3(0,1,0));p(this,"rotateQuaternion",new a.Quaternion);p(this,"fadeDuration",.2);p(this,"updateCameraTargetOffset",new a.Vector3);p(this,"cameraMode","third-person");p(this,"firstPersonPitch",0);p(this,"firstPersonYaw",0);p(this,"firstPersonHeadHeight",1.6);p(this,"targetOffsetY",1);this.model=t,this.mixer=e,this.animationsMap=i,this.orbitControl=s,this.camera=o,this.currentAction=n,r&&(this.groundMeshes=Array.isArray(r)?r:[r]),this.maxHeight=c,console.log(`[CharacterControls] maxHeight set to: ${this.maxHeight===null?"null (unlimited)":this.maxHeight.toFixed(2)}`),this.targetOffsetY=d,this.animationsMap.forEach((u,f)=>{f===n&&u.play()})}switchRunToggle(){this.toggleRun=!this.toggleRun}getGroundedState(){return this.isGrounded}getCurrentAction(){return this.currentAction}getJetpackActive(){return this.isJetpackActive}getGroundDistance(){const t=this.getGroundInfo();return Math.max(0,this.model.position.y-t.height)}getPosition(){return{x:this.model.position.x,y:this.model.position.y,z:this.model.position.z}}getMovementState(){return this.isJetpackActive&&!this.isGrounded?"jetpack":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?"idle":this.currentAction==="Run"?"run":this.currentAction==="Walk"?"walk":"idle"}setCameraMode(t){this.cameraMode=t,console.log(`CharacterControls: Camera mode set to ${t}`)}setFirstPersonRotation(t,e){this.firstPersonPitch=t,this.firstPersonYaw=e}placeOnGround(){const t=this.getGroundInfo();this.model.position.y=t.height+this.characterHeightOffset,console.log(`Character placed on ground at Y: ${this.model.position.y.toFixed(2)}`)}getGroundInfo(){if(this.groundMeshes.length===0)return{height:0,normal:null};this.rayOrigin.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.raycaster.set(this.rayOrigin,this.rayDirection);const t=this.raycaster.intersectObjects(this.groundMeshes,!0);if(t.length>0){const e=t[0];let i=null;if(e.face&&e.object){i=e.face.normal.clone();const s=new a.Matrix3().getNormalMatrix(e.object.matrixWorld);i.applyMatrix3(s).normalize()}return{height:e.point.y,normal:i}}return{height:-100,normal:null}}checkForwardCollision(t){if(this.groundMeshes.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.forwardRaycaster.set(this.tempCollisionVector,t),this.forwardRaycaster.far=this.forwardCollisionDistance;const e=this.forwardRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0],s=i.face?i.face.normal.clone():new a.Vector3(0,1,0);if(i.object&&i.face){const r=new a.Matrix3().getNormalMatrix(i.object.matrixWorld);s.applyMatrix3(r).normalize()}const o=s.dot(new a.Vector3(0,1,0)),n=o>=.5;return{hit:!0,point:i.point,normal:s,distance:i.distance,isWalkable:n,surfaceAngle:Math.acos(Math.abs(o))*(180/Math.PI)}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}checkCeilingCollision(){if(this.groundMeshes.length===0)return{hit:!1,height:1/0,distance:1/0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y,this.model.position.z);const t=new a.Vector3(0,1,0);this.ceilingRaycaster.set(this.tempCollisionVector,t),this.ceilingRaycaster.far=this.ceilingCollisionDistance;const e=this.ceilingRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0];return{hit:!0,height:i.point.y,distance:i.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardGround(t,e){if(this.groundMeshes.length===0)return{exists:!1,height:-100,normal:null,isWalkable:!1};const i=this.model.position.x+t.x*e,s=this.model.position.z+t.z*e;this.tempCollisionVector.set(i,this.model.position.y+10,s);const o=new a.Vector3(0,-1,0);this.forwardGroundRaycaster.set(this.tempCollisionVector,o);const n=this.forwardGroundRaycaster.intersectObjects(this.groundMeshes,!0);if(n.length>0){const r=n[0],c=r.point.y,d=r.face?r.face.normal:new a.Vector3(0,1,0),u=this.getGroundInfo().height,f=c-u,m=Math.acos(Math.abs(d.y)),y=m<=this.maxSlopeAngle||Math.abs(f)<=this.maxStepHeight;return{exists:!0,height:c,normal:d,isWalkable:y,slopeAngle:m,heightDifference:f}}return{exists:!1,height:-100,normal:null,isWalkable:!1}}update(t,e){if(this.jumpCooldown>0&&(this.jumpCooldown-=t),e[Ot]&&this.isGrounded&&this.jumpCooldown<=0&&(this.verticalVelocity=this.jumpForce,this.isGrounded=!1,this.jumpCooldown=this.jumpCooldownDuration),e[Ot]&&!this.isGrounded&&this.timeInAir>this.airTimeThreshold?(this.isJetpackActive||(this.isJetpackActive=!0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0),this.verticalVelocity+=this.jetpackThrust*t):this.isJetpackActive&&(this.isJetpackActive=!1,this.jetpackTransitionTimer=this.jetpackTransitionDuration,(this.inertiaVelocityX!==0||this.inertiaVelocityZ!==0)&&(this.hasInertia=!0)),this.jetpackTransitionTimer>0){const m=this.jetpackTransitionTimer/this.jetpackTransitionDuration;this.verticalVelocity+=this.jetpackThrust*m*t,this.jetpackTransitionTimer-=t}this.verticalVelocity+=this.gravity*t,this.verticalVelocity<this.maxFallSpeed&&(this.verticalVelocity=this.maxFallSpeed);const i=this.getGroundInfo(),s=i.height,o=this.model.position.y;if(this.model.position.y+=this.verticalVelocity*t,this.verticalVelocity>0){const m=this.checkCeilingCollision();if(m.hit){const y=m.height-this.characterHeightOffset;this.model.position.y>y&&(this.model.position.y=y,this.verticalVelocity=0)}}this.maxHeight!==null&&this.model.position.y>this.maxHeight&&(console.log(`[Height Cap] Enforcing ceiling: position.y=${this.model.position.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),this.model.position.y=this.maxHeight,this.verticalVelocity=0);const r=this.model.position.y-this.characterHeightOffset-s;let c=!0;if(i.normal&&(c=i.normal.dot(new a.Vector3(0,1,0))>=.5),r<=0&&c?(this.model.position.y=s+this.characterHeightOffset,this.verticalVelocity=0,this.isGrounded=!0,this.timeInAir=0,this.isJetpackActive&&(this.isJetpackActive=!1),this.jetpackTransitionTimer=0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0):(this.isGrounded=!1,this.timeInAir+=t),this.cameraMode==="first-person")this.camera.position.y=this.model.position.y+this.firstPersonHeadHeight;else{const m=this.model.position.y-o;this.camera.position.y+=m}const d=Ae.some(m=>e[m]===!0);let u="";if(this.isJetpackActive&&!this.isGrounded?u="TPose":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?u="Idle":d&&this.toggleRun?u="Run":d?u="Walk":u="Idle",this.currentAction!==u){const m=this.animationsMap.get(u),y=this.animationsMap.get(this.currentAction);y&&m&&(y.fadeOut(this.fadeDuration),m.reset().fadeIn(this.fadeDuration).play(),this.currentAction=u)}this.mixer.update(t);const f=this.isGrounded||this.timeInAir<=this.airTimeThreshold;if(this.isJetpackActive&&!d&&(this.inertiaVelocityX=0,this.inertiaVelocityZ=0),d&&(f||this.isJetpackActive)){let m;this.cameraMode==="first-person"?m=this.firstPersonYaw:m=Math.atan2(this.camera.position.x-this.model.position.x,this.camera.position.z-this.model.position.z);const y=this.directionOffset(e);this.rotateQuaternion.setFromAxisAngle(this.rotateAngle,m+y),this.model.quaternion.rotateTowards(this.rotateQuaternion,.2),this.camera.getWorldDirection(this.walkDirection),this.walkDirection.y=0,this.walkDirection.normalize(),this.walkDirection.applyAxisAngle(this.rotateAngle,y);const k=this.toggleRun?this.runVelocity:this.walkVelocity;let w=this.walkDirection.x*k*t,P=this.walkDirection.z*k*t;this.isGrounded||(this.inertiaVelocityX=this.walkDirection.x*k,this.inertiaVelocityZ=this.walkDirection.z*k,this.hasInertia=!0);let B=!1,I=null;if(this.isGrounded){const O=Math.sqrt(w*w+P*P),A=this.checkForwardGround(this.walkDirection,O);A.isWalkable||(B=!0,A.normal?I=A.normal.clone():I=new a.Vector3(-this.walkDirection.x,0,-this.walkDirection.z).normalize())}const E=this.checkForwardCollision(this.walkDirection);if(E.hit||B){let O;E.hit?O=E.normal.clone():O=I.clone(),E.hit&&!E.isWalkable&&(O.y=0,O.normalize());const W=this.tempSlideVector.set(w,0,P).dot(O);if(W<0){const st=w-W*O.x,$=P-W*O.z;w=st,P=$}}this.model.position.x+=w,this.model.position.z+=P,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=w,this.camera.position.z+=P)}else if(this.hasInertia&&!this.isGrounded&&!this.isJetpackActive){let m=this.inertiaVelocityX*t,y=this.inertiaVelocityZ*t;const k=new a.Vector3(this.inertiaVelocityX,0,this.inertiaVelocityZ).normalize(),w=this.checkForwardCollision(k);if(w.hit){const P=w.normal.clone();w.isWalkable||(P.y=0,P.normalize());const I=this.tempSlideVector.set(m,0,y).dot(P);if(I<0){const E=m-I*P.x,O=y-I*P.z;m=E,y=O}}this.model.position.x+=m,this.model.position.z+=y,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=m,this.camera.position.z+=y)}if(this.cameraMode==="first-person"){this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z,this.model.rotation.y=this.firstPersonYaw,this.camera.rotation.order="YXZ",this.camera.rotation.y=this.firstPersonYaw,this.camera.rotation.x=this.firstPersonPitch,this.camera.rotation.z=0;const m=new a.Vector3;this.camera.getWorldDirection(m),this.updateCameraTargetOffset.copy(this.camera.position).add(m),this.orbitControl.target.copy(this.updateCameraTargetOffset)}else{const y=new a.Vector3(0,this.targetOffsetY,0).clone().applyQuaternion(this.model.quaternion);this.updateCameraTargetOffset.x=this.model.position.x+y.x,this.updateCameraTargetOffset.y=this.model.position.y+y.y,this.updateCameraTargetOffset.z=this.model.position.z+y.z,this.orbitControl.target.copy(this.updateCameraTargetOffset)}}directionOffset(t){let e=0;return t[yt]?t[ht]?e=Math.PI/4:t[dt]&&(e=-Math.PI/4):t[xt]?t[ht]?e=Math.PI/4+Math.PI/2:t[dt]?e=-Math.PI/4-Math.PI/2:e=Math.PI:t[ht]?e=Math.PI/2:t[dt]&&(e=-Math.PI/2),e}updateVRPhysics(t,e,i,s,o,n,r,c,d){const u=t.clone();if(c&&(e.y+=this.jetpackThrust*s),d>0){const w=d/this.jetpackTransitionDuration;e.y+=this.jetpackThrust*w*s,d-=s}if(e.y+=this.gravity*s,e.y<this.maxFallSpeed&&(e.y=this.maxFallSpeed),u.y+=e.y*s,e.y>0){const w=this.checkCeilingCollisionAtPosition(u,o);if(w.hit){const P=w.height;u.y>P&&(u.y=P,e.y=0)}}this.maxHeight!==null&&u.y>this.maxHeight&&(console.log(`[Height Cap VR] Enforcing ceiling: position.y=${u.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),u.y=this.maxHeight,e.y=0);const f=this.getGroundInfoAtPosition(u,o),m=f.height;let y=!0;if(f.normal&&(y=f.normal.dot(new a.Vector3(0,1,0))>=.5),u.y-m<=0&&y?(u.y=m,e.y=0,n=!0,r=0,c&&(c=!1),d=0):(n=!1,r+=s),i&&i.lengthSq()>0){let w=i.x,P=i.z;const B=i.clone().normalize(),I=this.checkForwardCollisionAtPosition(u,B,o);if(I.hit){const E=I.normal.clone();I.isWalkable||(E.y=0,E.normalize());const A=new a.Vector3(w,0,P).dot(E);A<0&&(w=w-A*E.x,P=P-A*E.z)}u.x+=w,u.z+=P}return{newPosition:u,velocity:e,isGrounded:n,airTime:r,jetpackActive:c,jetpackTransitionTimer:d}}getGroundInfoAtPosition(t,e){if(!e||e.length===0)return{height:0,normal:null};const i=Math.max(t.y+10,100),s=new a.Vector3(t.x,i,t.z),o=new a.Vector3(0,-1,0),n=new a.Raycaster;n.set(s,o);const r=n.intersectObjects(e,!0);if(r.length>0){const c=r[0];let d=null;if(c.face&&c.object){d=c.face.normal.clone();const u=new a.Matrix3().getNormalMatrix(c.object.matrixWorld);d.applyMatrix3(u).normalize()}return{height:c.point.y,normal:d}}return{height:-100,normal:null}}checkCeilingCollisionAtPosition(t,e){if(!e||e.length===0)return{hit:!1,height:1/0,distance:1/0};const i=new a.Vector3(t.x,t.y+1,t.z),s=new a.Vector3(0,1,0),o=new a.Raycaster;o.set(i,s),o.far=this.ceilingCollisionDistance;const n=o.intersectObjects(e,!0);if(n.length>0){const r=n[0];return{hit:!0,height:r.point.y,distance:r.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardCollisionAtPosition(t,e,i){if(!i||i.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};const s=new a.Vector3(t.x,t.y+1,t.z),o=new a.Raycaster;o.set(s,e),o.far=this.forwardCollisionDistance;const n=o.intersectObjects(i,!0);if(n.length>0){const r=n[0],c=r.face?r.face.normal.clone():new a.Vector3(0,1,0);if(r.object&&r.face){const f=new a.Matrix3().getNormalMatrix(r.object.matrixWorld);c.applyMatrix3(f).normalize()}const u=c.dot(new a.Vector3(0,1,0))>=.5;return{hit:!0,point:r.point,normal:c,distance:r.distance,isWalkable:u}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}}const Ae=[yt,ht,xt,dt];class ze{constructor(){this.base=null,this.thumb=null,this.active=!1,this.originX=0,this.originY=0,this.currentX=0,this.currentY=0,this.maxDistance=40,this.deadzone=.15,this.createElements()}createElements(){this.base=document.createElement("div"),this.base.id="joystick-base",this.base.style.display="none",document.body.appendChild(this.base),this.thumb=document.createElement("div"),this.thumb.id="joystick-thumb",this.base.appendChild(this.thumb)}show(t,e){this.active=!0,this.originX=t,this.originY=e,this.currentX=t,this.currentY=e,this.base.style.left=`${t}px`,this.base.style.top=`${e}px`,this.base.style.display="block",this.thumb.style.transform="translate(0px, 0px)",requestAnimationFrame(()=>{this.base.style.opacity="1"})}update(t,e){if(!this.active)return;this.currentX=t,this.currentY=e;let i=t-this.originX,s=e-this.originY;if(Math.sqrt(i*i+s*s)>this.maxDistance){const n=Math.atan2(s,i);i=Math.cos(n)*this.maxDistance,s=Math.sin(n)*this.maxDistance}this.thumb.style.transform=`translate(${i}px, ${s}px)`}hide(){this.active=!1,this.base.style.opacity="0",setTimeout(()=>{this.active||(this.base.style.display="none")},200)}getDirection(){if(!this.active)return{angle:0,magnitude:0};const t=this.currentX-this.originX,e=this.currentY-this.originY,i=Math.sqrt(t*t+e*e),s=Math.min(i/this.maxDistance,1);return s<this.deadzone?{angle:0,magnitude:0}:{angle:Math.atan2(e,t),magnitude:s}}getKeys(){const{angle:t,magnitude:e}=this.getDirection();if(e===0)return{w:!1,a:!1,s:!1,d:!1};let i=t*180/Math.PI;i<0&&(i+=360);const s={w:!1,a:!1,s:!1,d:!1};return i>=337.5||i<22.5?s.d=!0:i>=22.5&&i<67.5?(s.d=!0,s.w=!0):i>=67.5&&i<112.5?s.s=!0:i>=112.5&&i<157.5?(s.a=!0,s.s=!0):i>=157.5&&i<202.5?s.a=!0:i>=202.5&&i<247.5?(s.a=!0,s.w=!0):i>=247.5&&i<292.5?s.w=!0:i>=292.5&&i<337.5&&(s.d=!0,s.w=!0),s}isActive(){return this.active}}class Ge{constructor(t,e){this.keysPressed=t,this.orbitControls=e,this.joystick=new ze,this.activeTouchId=null,this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.touchLastX=0,this.touchLastY=0,this.touchHasMoved=!1,this.longPressThreshold=400,this.movementThreshold=10,this.jetpackActive=!1,this.orbitControlsEnabled=!0,this.cameraMode="third-person",this.firstPersonCallback=null,this.isPaintMode=!1,this.paintCallback=null,this.paintEndCallback=null,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.setupEventListeners(),this.startUpdateLoop()}setupEventListeners(){document.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),document.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1}),document.addEventListener("contextmenu",this.handleContextMenu,{passive:!1})}handleTouchStart(t){const e=t.target;if(e&&(e.tagName==="BUTTON"||e.tagName==="SELECT"||e.tagName==="INPUT"||e.tagName==="A"||e.closest("button")||e.closest("select")||e.closest("input")))return;const i=t.changedTouches[0],s=Date.now();this.activeTouchId!==null||this.joystick.isActive()||(this.activeTouchId=i.identifier,this.touchStartTime=s,this.touchStartX=i.clientX,this.touchStartY=i.clientY,this.touchLastX=i.clientX,this.touchLastY=i.clientY,this.touchHasMoved=!1,t.preventDefault())}handleTouchMove(t){let e=null;for(let n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===this.activeTouchId){e=t.changedTouches[n];break}if(!e)return;if(t.preventDefault(),this.joystick.isActive()){this.joystick.update(e.clientX,e.clientY);return}const i=e.clientX-this.touchStartX,s=e.clientY-this.touchStartY;if(Math.sqrt(i*i+s*s)>this.movementThreshold&&(this.touchHasMoved=!0),this.touchHasMoved){const n=e.clientX-this.touchLastX,r=e.clientY-this.touchLastY;this.isPaintMode&&this.paintCallback?this.paintCallback(e.clientX,e.clientY):this.handleCameraRotation(n,r)}this.touchLastX=e.clientX,this.touchLastY=e.clientY}handleTouchEnd(t){for(let e=0;e<t.changedTouches.length;e++)if(t.changedTouches[e].identifier===this.activeTouchId){this.joystick.isActive()&&this.deactivateJoystick(),this.isPaintMode&&this.paintEndCallback&&this.paintEndCallback(),this.activeTouchId=null,this.touchHasMoved=!1;break}}handleCameraRotation(t,e){this.cameraMode==="first-person"?this.firstPersonCallback&&this.firstPersonCallback(t,e):this.orbitControls&&(this.orbitControls.rotateLeft(-t*.005),this.orbitControls.rotateUp(-e*.005),this.orbitControls.update())}activateJoystick(t,e){this.joystick.show(t,e),this.orbitControls&&(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1),console.log("Virtual joystick activated")}deactivateJoystick(){this.joystick.hide(),this.keysPressed.w=!1,this.keysPressed.a=!1,this.keysPressed.s=!1,this.keysPressed.d=!1,this.orbitControls&&this.orbitControlsEnabled&&(this.orbitControls.enabled=!0),console.log("Virtual joystick deactivated")}activateJetpack(){this.jetpackActive=!0,this.keysPressed[" "]=!0,console.log("Jetpack mode activated")}deactivateJetpack(){this.jetpackActive=!1,this.keysPressed[" "]=!1,console.log("Jetpack mode deactivated")}startUpdateLoop(){const t=()=>{if(this.joystick.isActive()){const e=this.joystick.getKeys();this.keysPressed.w=e.w,this.keysPressed.a=e.a,this.keysPressed.s=e.s,this.keysPressed.d=e.d}this.activeTouchId!==null&&!this.joystick.isActive()&&!this.touchHasMoved&&Date.now()-this.touchStartTime>=this.longPressThreshold&&this.activateJoystick(this.touchStartX,this.touchStartY),requestAnimationFrame(t)};t()}setCameraMode(t){this.cameraMode=t,console.log(`TouchControls: Camera mode set to ${t}`)}setFirstPersonCallback(t){this.firstPersonCallback=t}setPaintMode(t){this.isPaintMode=t,this.orbitControls&&(t?(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1):this.orbitControls.enabled=this.orbitControlsEnabled),console.log(`TouchControls: Paint mode ${t?"ON":"OFF"}`)}setPaintCallback(t){this.paintCallback=t}setPaintEndCallback(t){this.paintEndCallback=t}handleContextMenu(t){return t.preventDefault(),!1}disable(){document.removeEventListener("touchstart",this.handleTouchStart),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("touchcancel",this.handleTouchEnd),document.removeEventListener("contextmenu",this.handleContextMenu),this.joystick.isActive()&&this.deactivateJoystick(),console.log("Touch controls disabled")}}async function Ve(){try{const l=await fetch("models/scenes.json");if(!l.ok)throw new Error(`Failed to load scenes manifest: ${l.statusText}`);const t=await l.json();return console.log("Scenes manifest loaded:",t),t}catch(l){throw console.error("Error loading scenes manifest:",l),l}}async function Be(l){try{const t=await fetch(l);if(!t.ok)throw new Error(`Failed to load scene config from ${l}: ${t.statusText}`);const e=await t.json();return He(e),console.log(`Scene config loaded: ${e.name}`,e),e}catch(t){throw console.error(`Error loading scene config from ${l}:`,t),t}}function He(l){const t=["name","assets","transform","character","camera","lighting","scene"];for(const e of t)if(!(e in l))throw new Error(`Scene config missing required field: ${e}`);if(!l.assets.splatFile||!l.assets.collisionFile||!l.assets.characterFile)throw new Error("Scene config missing required asset files");if(typeof l.transform.scale!="number")throw new Error("Scene config: transform.scale must be a number");console.log("Scene config validation passed")}function te(l){return l.scenes.map(t=>({id:t.id,name:t.name,description:t.description||"",latitude:t.latitude||0,longitude:t.longitude||0,thumbnail:t.thumbnail||"models/thumbnails/placeholder.jpg"}))}function $e(l){var t;return l.defaultScene||((t=l.scenes[0])==null?void 0:t.id)||"StoneHenge"}function Ne(l,t){const e=l.scenes.find(i=>i.id===t);return e?e.config:null}class je{constructor(t,e,i={}){this.context=t,this.destination=e,this.buffer=null,this.source=null,this.gainNode=this.context.createGain(),this.gainNode.gain.value=i.initialGain!==void 0?i.initialGain:0,this.gainNode.connect(this.destination),this.isPlaying=!1}setBuffer(t){this.buffer=t}start(){if(!(this.isPlaying||!this.buffer)){this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.gainNode);try{this.source.start(),this.isPlaying=!0}catch(t){console.warn("LoopedTrack start failed:",t)}}}stop(){if(this.isPlaying){try{this.source.stop()}catch{}try{this.source.disconnect()}catch{}this.source=null,this.isPlaying=!1}}dispose(){this.stop();try{this.gainNode.disconnect()}catch{}this.gainNode=null}}class Xe{constructor(t={},e=!1){p(this,"isMobile",!1);p(this,"audioContext",null);p(this,"masterGain",null);p(this,"oneShotGain",null);p(this,"tracks",{background:null,walking:null,running:null,jetpack:null});p(this,"buffers",{background:null,walking:null,running:null,jetpack:null,magicReveal:null});p(this,"backgroundMusicEnabled",!0);p(this,"movementSoundsEnabled",!0);p(this,"backgroundMusicVolume",.3);p(this,"walkingSoundVolume",.25);p(this,"runningSoundVolume",.15);p(this,"jetpackVolume",.5);p(this,"magicRevealVolume",.6);p(this,"fadeSpeed",2);p(this,"backgroundMusicTarget",0);p(this,"walkingSoundTarget",0);p(this,"runningSoundTarget",0);p(this,"jetpackTarget",0);p(this,"currentMovementState","idle");p(this,"previousMovementState","idle");p(this,"audioUnlocked",!1);p(this,"loopedSoundsStarted",!1);p(this,"preloadPromise",null);this.config=t,this.isMobile=e,this.ensureContext(),this.setupGraph(),this.preloadPromise=this.preloadAll().then(()=>{console.log("Audio buffers preloaded")}).catch(i=>{console.warn("Audio preload failed:",i)}),console.log("AudioManager (Web Audio) initialized with config:",t,"mobile:",e)}ensureContext(){if(this.audioContext)return this.audioContext;const t=window.AudioContext||window.webkitAudioContext;return this.audioContext=new t,this.audioContext}setupGraph(){if(this.masterGain)return;const t=this.ensureContext();this.masterGain=t.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(t.destination),this.oneShotGain=t.createGain(),this.oneShotGain.gain.value=this.magicRevealVolume,this.oneShotGain.connect(this.masterGain)}async preloadAll(){const t=[];this.config.backgroundMusic&&!this.buffers.background&&t.push(this.loadBuffer(this.config.backgroundMusic,"background").then(e=>this.buffers.background=e).catch(e=>console.warn("Failed to load background:",e))),this.config.runningSound&&!this.buffers.running&&t.push(this.loadBuffer(this.config.runningSound,"running").then(e=>this.buffers.running=e).catch(e=>console.warn("Failed to load running:",e))),this.config.jetpackSound&&!this.buffers.jetpack&&t.push(this.loadBuffer(this.config.jetpackSound,"jetpack").then(e=>this.buffers.jetpack=e).catch(e=>console.warn("Failed to load jetpack:",e))),!this.isMobile&&this.config.walkingSound&&!this.buffers.walking&&t.push(this.loadBuffer(this.config.walkingSound,"walking").then(e=>this.buffers.walking=e).catch(e=>console.warn("Failed to load walking:",e))),this.config.magicReveal&&!this.buffers.magicReveal&&t.push(this.loadBuffer(this.config.magicReveal,"magicReveal").then(e=>this.buffers.magicReveal=e).catch(e=>console.warn("Failed to load magicReveal:",e))),t.length>0?(console.log(`Loading ${t.length} audio buffers...`),await Promise.allSettled(t),console.log("Audio preload complete (some may have failed)")):console.log("All audio buffers already loaded")}async loadBuffer(t){const e=this.ensureContext(),s=await(await fetch(t)).arrayBuffer();return await new Promise((o,n)=>{try{const r=e.decodeAudioData(s);r&&typeof r.then=="function"?r.then(o).catch(c=>{try{e.decodeAudioData(s,o,n)}catch(d){n(d)}}):e.decodeAudioData(s,o,n)}catch{try{e.decodeAudioData(s,o,n)}catch(c){n(c)}}})}async unlockAudio(){if(this.audioUnlocked){console.log("Audio already unlocked");return}if(this.isMobile){try{if(this.audioContext&&this.audioContext.state!=="closed")try{await this.audioContext.close()}catch{}}catch{}const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.masterGain=null,this.oneShotGain=null,this.tracks={background:null,walking:null,running:null,jetpack:null},this.setupGraph()}const t=this.ensureContext();try{await t.resume()}catch(e){console.warn("AudioContext resume failed:",e)}try{await this.preloadAll()}catch(e){console.warn("Continuing without all audio buffers:",e)}this.startOrCreateTrack("background",this.buffers.background),this.isMobile||this.startOrCreateTrack("walking",this.buffers.walking),this.startOrCreateTrack("running",this.buffers.running),this.startOrCreateTrack("jetpack",this.buffers.jetpack),this.audioUnlocked=!0,this.loopedSoundsStarted=!0,console.log("âœ“ Web Audio unlocked, looped tracks running at gain 0")}startOrCreateTrack(t,e){e&&(this.tracks[t]||(this.tracks[t]=new je(this.audioContext,this.masterGain,{initialGain:0}),this.tracks[t].setBuffer(e)),this.tracks[t].start())}playMagicReveal(t=0){if(!this.buffers.magicReveal)return;const e=()=>{try{const i=this.audioContext.createBufferSource(),s=this.audioContext.createGain();s.gain.value=this.magicRevealVolume,i.buffer=this.buffers.magicReveal,i.connect(s).connect(this.masterGain),i.start(),i.onended=()=>{try{i.disconnect()}catch{}try{s.disconnect()}catch{}}}catch(i){console.warn("Magic reveal play failed:",i)}};t>0?setTimeout(e,t*1e3):e()}startBackgroundMusic(){this.backgroundMusicEnabled&&(this.backgroundMusicTarget=this.backgroundMusicVolume,console.log("Background music fading in"))}stopBackgroundMusic(){this.backgroundMusicTarget=0,console.log("Background music fading out")}updateMovementSounds(t){if(this.previousMovementState=this.currentMovementState,this.currentMovementState=t,this.previousMovementState!==this.currentMovementState&&console.log(`Movement state changed: ${this.previousMovementState} -> ${t}`),!this.movementSoundsEnabled){this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0;return}t==="walk"?(this.isMobile?this.walkingSoundTarget=0:this.walkingSoundTarget=this.walkingSoundVolume,this.runningSoundTarget=0,this.jetpackTarget=0):t==="run"?(this.walkingSoundTarget=0,this.runningSoundTarget=this.runningSoundVolume,this.jetpackTarget=0):t==="jetpack"?(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=this.jetpackVolume):(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0)}update(t){this.rampGainTo("background",this.backgroundMusicTarget,t),this.isMobile||this.rampGainTo("walking",this.walkingSoundTarget,t),this.rampGainTo("running",this.runningSoundTarget,t),this.rampGainTo("jetpack",this.jetpackTarget,t)}rampGainTo(t,e,i){const s=this.tracks[t];if(!s||!s.gainNode)return;const o=s.gainNode.gain.value;if(o===e)return;const n=this.fadeSpeed*i,r=o<e?Math.min(e,o+n):Math.max(e,o-n),c=this.audioContext.currentTime;try{s.gainNode.gain.cancelScheduledValues(c),s.gainNode.gain.setValueAtTime(o,c),s.gainNode.gain.linearRampToValueAtTime(r,c+.05)}catch{s.gainNode.gain.value=r}}toggleBackgroundMusic(){this.backgroundMusicEnabled=!this.backgroundMusicEnabled,this.backgroundMusicEnabled?this.startBackgroundMusic():this.stopBackgroundMusic(),console.log("Background music:",this.backgroundMusicEnabled?"ON":"OFF")}toggleMovementSounds(){this.movementSoundsEnabled=!this.movementSoundsEnabled,this.movementSoundsEnabled||(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0),console.log("Movement sounds:",this.movementSoundsEnabled?"ON":"OFF")}setMasterVolume(t){const e=Math.max(0,Math.min(1,t));this.backgroundMusicVolume=e*.3,this.walkingSoundVolume=e*.25,this.runningSoundVolume=e*.15,this.jetpackVolume=e*.5,this.oneShotGain&&(this.oneShotGain.gain.value=this.magicRevealVolume*e),console.log("Master volume set to:",e)}dispose(){Object.values(this.tracks).forEach(t=>{t&&t.dispose()}),this.tracks={background:null,walking:null,running:null,jetpack:null};try{this.oneShotGain&&this.oneShotGain.disconnect()}catch{}try{this.masterGain&&this.masterGain.disconnect()}catch{}try{this.audioContext.suspend()}catch{}console.log("AudioManager (Web Audio) disposed")}}class Je{constructor(t,e,i,s){this.renderer=t,this.camera=e,this.scene=i,this.sceneConfig=s,this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.xrConfig=(s==null?void 0:s.xr)||{enabled:!0,referenceSpaceType:"local-floor",referenceSpaceOrigin:{position:{x:0,y:0,z:0},rotation:{y:0}},userHeight:1.6},this.vrVelocity=new a.Vector3,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1,this.jetpackTransitionTimer=0,this.moveSpeed=5,this.runSpeedMultiplier=2,this.isRunning=!1,this.teleportTarget=null,this.teleportReticle=null,this.isTeleporting=!1,this.characterControls=null,this.orbitControls=null,this.xrControllers=null,this.xrHands=null,this.gaussianSplat=null,this.worldOffset=new a.Vector3,this.yRotation=0,this.xRotation=0,this.actualReferenceOrigin=null,this.characterPosition=new a.Vector3,this.init()}async init(){if(!this.xrConfig.enabled){console.log("XR disabled in scene config");return}this.renderer.xr.enabled=!0,await this.createVRButton(),this.renderer.xr.addEventListener("sessionstart",this.onSessionStart.bind(this)),this.renderer.xr.addEventListener("sessionend",this.onSessionEnd.bind(this)),this.createTeleportReticle(),console.log("XRManager initialized",this.xrConfig)}async createVRButton(){if(!navigator.xr){console.log("WebXR not available, VR button hidden");return}try{if(!await navigator.xr.isSessionSupported("immersive-vr")){console.log("immersive-vr not supported, VR button hidden");return}const e=Ce.createButton(this.renderer);e.style.position="fixed",e.style.bottom="90px",e.style.right="30px",e.style.zIndex="1000",document.body.appendChild(e),this.vrButton=e,console.log("WebXR available, VR button shown")}catch(t){console.warn("Error checking WebXR support:",t)}}createTeleportReticle(){const t=new a.RingGeometry(.2,.25,32),e=new a.MeshBasicMaterial({color:65280,side:a.DoubleSide,transparent:!0,opacity:.8});this.teleportReticle=new a.Mesh(t,e),this.teleportReticle.rotation.x=-Math.PI/2,this.teleportReticle.visible=!1,this.scene.add(this.teleportReticle)}async onSessionStart(){var t,e,i;if(console.log("XR session starting..."),this.session=this.renderer.xr.getSession(),this.isXRActive=!0,this.gaussianSplat){this.gaussianSplat.visible=!0,console.log("Gaussian splat visibility ensured for VR mode:",this.gaussianSplat.visible);let s=this.gaussianSplat.parent,o=0;for(;s&&o<5;)console.log(`  Parent ${o}:`,s.type||s.constructor.name),s=s.parent,o++}else console.warn("Gaussian splat reference not set in XRManager");try{const s=this.xrConfig.referenceSpaceType||"local-floor";try{this.localSpace=await this.session.requestReferenceSpace(s),console.log(`XR reference space type: ${s}`)}catch{console.warn(`${s} not supported, falling back to 'local'`),this.localSpace=await this.session.requestReferenceSpace("local")}const o=((e=(t=this.sceneConfig)==null?void 0:t.character)==null?void 0:e.spawn)||{},n=o.position||{x:0,y:"auto",z:40},r=o.rotation||{y:0},c=n.x,d=n.z,u=((i=this.characterControls)==null?void 0:i.groundMeshes)||[];let f=0;if(u.length>0&&this.characterControls){const k=new a.Vector3(c,1e3,d);f=this.characterControls.getGroundInfoAtPosition(k,u).height,f<-50?(console.warn(`No ground found at XR spawn (${c}, ${d}), using Y=0`),f=0):console.log(`Ground height at XR spawn (${c}, ${d}): ${f.toFixed(2)}`)}const m=this.xrConfig.userHeight||1.6,y={x:c,y:f,z:d};this.actualReferenceOrigin={position:y,rotation:r,userHeight:m},this.characterPosition.set(y.x,y.y,y.z),this.setReferenceSpaceOrigin(y,r),console.log("XR reference space initialized at:",y),console.log("Character position (play space center):",this.characterPosition)}catch(s){console.error("Failed to request reference space:",s)}this.orbitControls&&(this.orbitControls.enabled=!1),this.hideNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!1),this.xrControllers&&this.xrControllers.enable(),this.xrHands&&this.xrHands.enable(),this.vrVelocity.set(0,0,0),this.worldOffset.set(0,0,0),this.yRotation=0,this.xRotation=0,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1}onSessionEnd(){console.log("XR session ended"),this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.actualReferenceOrigin=null,this.characterPosition.set(0,0,0),this.orbitControls&&(this.orbitControls.enabled=!0),this.showNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!0),this.xrControllers&&this.xrControllers.disable(),this.xrHands&&this.xrHands.disable(),this.teleportReticle.visible=!1}setReferenceSpaceOrigin(t,e){if(!this.localSpace)return;const i=t||{x:0,y:0,z:0},s=e||{y:0},o=new a.PerspectiveCamera;o.position.set(i.x,i.y,i.z),o.rotation.order="YXZ",o.rotation.y=s.y*(Math.PI/180),o.updateMatrixWorld();const n=o.quaternion,r=new XRRigidTransform({x:i.x,y:i.y,z:i.z},{x:n.x,y:n.y,z:n.z,w:n.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(r.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace),this.worldOffset.set(0,0,0)}updateReferenceSpaceByOffset(t){if(!this.currentReferenceSpace||!this.localSpace)return;this.worldOffset.add(t);const e=this.actualReferenceOrigin||this.xrConfig.referenceSpaceOrigin,i=e.position||{x:0,y:0,z:0},s=e.rotation||{y:0},o={x:i.x+this.worldOffset.x,y:i.y+this.worldOffset.y,z:i.z+this.worldOffset.z},n=new a.PerspectiveCamera;n.position.set(o.x,o.y,o.z),n.rotation.order="YXZ",n.rotation.y=s.y*(Math.PI/180)+this.yRotation,n.rotation.x=this.xRotation,n.updateMatrixWorld();const r=n.quaternion,c=new XRRigidTransform({x:o.x,y:o.y,z:o.z},{x:r.x,y:r.y,z:r.z,w:r.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(c.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace)}teleportTo(t){if(!this.isXRActive)return;const e=t.clone(),i=new a.Vector3().subVectors(e,this.characterPosition);this.characterPosition.copy(e),this.updateReferenceSpaceByOffset(i),console.log("Teleported to ground:",t,"character at feet:",e)}updateTeleportTarget(t){t?(this.teleportReticle.position.copy(t),this.teleportReticle.visible=!0,this.teleportTarget=t.clone()):(this.teleportReticle.visible=!1,this.teleportTarget=null)}executeTeleport(){this.teleportTarget&&(this.teleportTo(this.teleportTarget),this.teleportReticle.visible=!1,this.teleportTarget=null)}handleThumbstickMovement(t,e){if(!this.isXRActive||t.lengthSq()<.01)return;const i=this.renderer.xr.getCamera(),s=new a.Vector3(0,0,-1),o=new a.Vector3(1,0,0),n=Math.atan2(i.matrixWorld.elements[8],i.matrixWorld.elements[10]);s.applyAxisAngle(new a.Vector3(0,1,0),n),o.applyAxisAngle(new a.Vector3(0,1,0),n);const r=new a.Vector3().addScaledVector(s,-t.y).addScaledVector(o,t.x);r.y=0,r.normalize();const c=this.moveSpeed*(this.isRunning?this.runSpeedMultiplier:1);return r.multiplyScalar(c*e)}handleThumbstickRotation(t,e){if(!this.isXRActive||!t)return;const i=2,s=.15,o=Math.PI/2-.1;let n=!1;if(Math.abs(t.x)>s){const r=-t.x*i*e;this.yRotation+=r,n=!0}if(Math.abs(t.y)>s){const r=-t.y*i*e;this.xRotation+=r,this.xRotation=Math.max(-o,Math.min(o,this.xRotation)),n=!0}n&&this.updateReferenceSpaceByOffset(new a.Vector3)}updateVRPhysics(t,e){if(!this.isXRActive||!this.characterControls)return;const i=this.characterPosition.clone();let s=new a.Vector3;if(this.xrControllers){const r=this.xrControllers.getThumbstickAxes();r&&(s=this.handleThumbstickMovement(r,t)||new a.Vector3);const c=this.xrControllers.getRightThumbstickAxes();c&&this.handleThumbstickRotation(c,t)}const o=this.characterControls.updateVRPhysics(i,this.vrVelocity,s,t,e,this.isGrounded,this.airTime,this.jetpackActive,this.jetpackTransitionTimer);this.vrVelocity.copy(o.velocity),this.isGrounded=o.isGrounded,this.airTime=o.airTime,this.jetpackActive=o.jetpackActive,this.jetpackTransitionTimer=o.jetpackTransitionTimer;const n=new a.Vector3().subVectors(o.newPosition,i);n.lengthSq()>1e-4&&(this.characterPosition.copy(o.newPosition),this.updateReferenceSpaceByOffset(n),Math.random()<.01&&console.log("VR Physics:",{characterY:this.characterPosition.y.toFixed(2),deltaY:n.y.toFixed(3),isGrounded:o.isGrounded,velocity:this.vrVelocity.y.toFixed(2)}))}update(t,e){this.isXRActive&&(this.updateVRPhysics(t,e),this.xrControllers&&this.xrControllers.update(t),this.xrHands&&this.xrHands.update())}hideNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="none");const e=document.getElementById("camera-toggle");e&&(e.style.display="none");const i=document.getElementById("key-display");i&&(i.style.display="none")}showNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="block");const e=document.getElementById("camera-toggle");e&&(e.style.display="block");const i=document.getElementById("key-display");i&&(i.style.display="block")}getIsXRActive(){return this.isXRActive}getXRCamera(){return this.isXRActive?this.renderer.xr.getCamera():null}onJumpPressed(){this.isGrounded&&(this.vrVelocity.y=this.characterControls.jumpForce,this.isGrounded=!1,this.airTime=0)}onJetpackPressed(t){this.airTime>.4&&(this.jetpackActive=t)}onRunToggle(){this.isRunning=!this.isRunning,console.log("Run mode:",this.isRunning?"ON":"OFF")}onResetPitch(){this.xRotation=0,console.log("Camera pitch reset to flat (0 degrees)"),this.updateReferenceSpaceByOffset(new a.Vector3)}dispose(){this.vrButton&&this.vrButton.parentNode&&this.vrButton.parentNode.removeChild(this.vrButton),this.teleportReticle&&(this.scene.remove(this.teleportReticle),this.teleportReticle.geometry.dispose(),this.teleportReticle.material.dispose()),this.renderer.xr.removeEventListener("sessionstart",this.onSessionStart),this.renderer.xr.removeEventListener("sessionend",this.onSessionEnd)}}class Ue{constructor(t,e,i){this.renderer=t,this.scene=e,this.xrManager=i,this.controller0=null,this.controller1=null,this.controllerGrip0=null,this.controllerGrip1=null,this.controllerModelFactory=new Te,this.rayLine0=null,this.rayLine1=null,this.leftThumbstickAxes=new a.Vector2,this.rightThumbstickAxes=new a.Vector2,this.thumbstickAxes=new a.Vector2,this.isSelectPressed=!1,this.isSqueezePressed=!1,this.squeezeHoldTime=0,this.buttonAPressed=!1,this.buttonBPressed=!1,this.rightStickPressed=!1,this.buttonACooldown=0,this.buttonBCooldown=0,this.rightStickCooldown=0,this.buttonCooldownDuration=.3,this.isPaintMode=!1,this.colorPalette=null,this.paletteColors=[{name:"Red",hex:16711680},{name:"Orange",hex:16746496},{name:"Yellow",hex:16776960},{name:"Green",hex:65280},{name:"Cyan",hex:65535},{name:"Blue",hex:255},{name:"Purple",hex:8913151},{name:"Magenta",hex:16711935},{name:"White",hex:16777215},{name:"Gray",hex:8421504},{name:"Black",hex:0},{name:"Brown",hex:9127187}],this.currentColorIndex=4,this.raycaster=new a.Raycaster,this.groundMeshes=[],this.isEnabled=!1}init(){this.controller0=this.renderer.xr.getController(0),this.controller0.addEventListener("selectstart",this.onSelectStart.bind(this,0)),this.controller0.addEventListener("selectend",this.onSelectEnd.bind(this,0)),this.controller0.addEventListener("squeezestart",this.onSqueezeStart.bind(this,0)),this.controller0.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,0)),this.scene.add(this.controller0),this.controller1=this.renderer.xr.getController(1),this.controller1.addEventListener("selectstart",this.onSelectStart.bind(this,1)),this.controller1.addEventListener("selectend",this.onSelectEnd.bind(this,1)),this.controller1.addEventListener("squeezestart",this.onSqueezeStart.bind(this,1)),this.controller1.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,1)),this.scene.add(this.controller1),this.controllerGrip0=this.renderer.xr.getControllerGrip(0),this.controllerGrip0.add(this.controllerModelFactory.createControllerModel(this.controllerGrip0)),this.scene.add(this.controllerGrip0),this.controllerGrip1=this.renderer.xr.getControllerGrip(1),this.controllerGrip1.add(this.controllerModelFactory.createControllerModel(this.controllerGrip1)),this.scene.add(this.controllerGrip1),this.rayLine0=this.createRayLine(),this.controller0.add(this.rayLine0),this.rayLine1=this.createRayLine(),this.controller1.add(this.rayLine1),console.log("XR Controllers initialized")}createRayLine(){const t=new a.BufferGeometry,e=new Float32Array([0,0,0,0,0,-5]);t.setAttribute("position",new a.BufferAttribute(e,3));const i=new a.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.6}),s=new a.Line(t,i);return s.visible=!1,s}enable(){this.isEnabled=!0,this.controller0||this.init()}disable(){this.isEnabled=!1,this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1)}onSelectStart(t,e){console.log(`Controller ${t} select start - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!0;const i=t===0?this.rayLine0:this.rayLine1;i&&(i.visible=!0,i.material.color.setHex(65280)),this.isPaintMode?(console.log("Paint mode active - setting isDragging to true"),this.isDragging=!0):console.log("NOT in paint mode - will teleport on release")}onSelectEnd(t,e){console.log(`Controller ${t} select end - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!1;const i=t===0?this.rayLine0:this.rayLine1;if(i&&(i.visible=!1),this.isPaintMode){if(console.log("Paint mode - checking color selection"),this.checkColorSelection(t)){console.log("Color selected from palette");return}console.log("Stopping paint (isDragging = false)"),this.isDragging=!1}else console.log("NOT in paint mode - executing teleport"),this.xrManager.executeTeleport()}onSqueezeStart(t,e){console.log(`Controller ${t} squeeze start`),this.isSqueezePressed=!0,this.squeezeHoldTime=0,this.xrManager.onJumpPressed()}onSqueezeEnd(t,e){console.log(`Controller ${t} squeeze end`),this.isSqueezePressed=!1,this.xrManager.onJetpackPressed(!1)}getThumbstickAxes(){const t=this.renderer.xr.getSession();if(!t)return null;this.leftThumbstickAxes.set(0,0),this.rightThumbstickAxes.set(0,0);for(const e of t.inputSources)if(e.gamepad&&e.handedness){const i=e.gamepad,s=e.handedness==="left";if(i.axes.length>=4){const o=i.axes[2],n=i.axes[3];s?this.leftThumbstickAxes.set(o,n):this.rightThumbstickAxes.set(o,n)}i.buttons.length>4&&i.buttons[4].pressed?!this.buttonAPressed&&this.buttonACooldown<=0&&(this.buttonAPressed=!0,this.buttonACooldown=this.buttonCooldownDuration,this.xrManager.onRunToggle()):this.buttonAPressed=!1,i.buttons.length>5&&i.buttons[5].pressed?!this.buttonBPressed&&this.buttonBCooldown<=0?(this.buttonBPressed=!0,this.buttonBCooldown=this.buttonCooldownDuration,console.log(`B/Y button pressed - toggling paint mode (cooldown: ${this.buttonCooldownDuration}s)`),this.togglePaintMode()):this.buttonBCooldown>0:this.buttonBPressed=!1,!s&&i.buttons.length>3&&i.buttons[3].pressed?!this.rightStickPressed&&this.rightStickCooldown<=0&&(this.rightStickPressed=!0,this.rightStickCooldown=this.buttonCooldownDuration,console.log("Right stick pressed - resetting camera pitch to flat"),this.xrManager.onResetPitch()):s||(this.rightStickPressed=!1)}return this.leftThumbstickAxes.lengthSq()>.01?(this.thumbstickAxes.copy(this.leftThumbstickAxes),this.thumbstickAxes):(this.thumbstickAxes.set(0,0),this.thumbstickAxes)}getRightThumbstickAxes(){return this.rightThumbstickAxes}togglePaintMode(){this.isPaintMode=!this.isPaintMode,this.isPaintMode?(console.log("VR Paint mode: ON"),this.showColorPalette(),this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1),this.xrManager.updateTeleportTarget(null)):(console.log("VR Paint mode: OFF"),this.hideColorPalette())}createColorPalette(){this.colorPalette=new a.Group;const t=new a.SphereGeometry(.03,16,16),e=.08;this.paletteColors.forEach((i,s)=>{const o=new a.MeshBasicMaterial({color:i.hex}),n=new a.Mesh(t,o),r=Math.floor(s/3),c=s%3;n.position.set(c*e-e,-r*e,0),n.userData={isColorPicker:!0,colorIndex:s,colorHex:i.hex,colorName:i.name},this.colorPalette.add(n)}),this.colorPalette.position.set(.15,0,-.3),this.colorPalette.visible=!1,this.controller1&&this.controller1.add(this.colorPalette),console.log("VR color palette created")}showColorPalette(){this.colorPalette||this.createColorPalette(),this.colorPalette&&(this.colorPalette.visible=!0)}hideColorPalette(){this.colorPalette&&(this.colorPalette.visible=!1)}checkColorSelection(t){if(!this.isPaintMode||!this.colorPalette||!this.colorPalette.visible)return!1;const e=t===0?this.controller0:this.controller1;if(!e)return!1;const i=new a.Matrix4;i.identity().extractRotation(e.matrixWorld),this.raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(i);const s=this.raycaster.intersectObjects(this.colorPalette.children,!1);if(s.length>0){const o=s[0].object;if(o.userData.isColorPicker)return this.currentColorIndex=o.userData.colorIndex,console.log(`Selected color: ${o.userData.colorName}`),o.scale.set(1.3,1.3,1.3),setTimeout(()=>{o.scale.set(1,1,1)},200),!0}return!1}getRayForPainting(t){if(!this.isPaintMode)return null;const e=t===0?this.controller0:this.controller1;if(!e)return null;const i=new a.Matrix4;i.identity().extractRotation(e.matrixWorld);const s=new a.Vector3;s.setFromMatrixPosition(e.matrixWorld);const o=new a.Vector3(0,0,-1);return o.applyMatrix4(i).normalize(),{origin:s,direction:o}}raycastForTeleport(t){if(!t||this.groundMeshes.length===0)return null;const e=new a.Matrix4;e.identity().extractRotation(t.matrixWorld);const i=this.raycaster;i.ray.origin.setFromMatrixPosition(t.matrixWorld),i.ray.direction.set(0,0,-1).applyMatrix4(e);const s=i.intersectObjects(this.groundMeshes,!1);return s.length>0?s[0].point:null}update(t){if(this.isEnabled){if(this.isSqueezePressed?(this.squeezeHoldTime+=t,this.squeezeHoldTime>.4&&this.xrManager.onJetpackPressed(!0)):this.squeezeHoldTime=0,this.buttonACooldown>0&&(this.buttonACooldown-=t),this.buttonBCooldown>0&&(this.buttonBCooldown-=t),this.rightStickCooldown>0&&(this.rightStickCooldown-=t),this.isSelectPressed&&!this.isPaintMode){const e=this.raycastForTeleport(this.controller0);this.xrManager.updateTeleportTarget(e),this.rayLine0&&this.rayLine0.material.color.setHex(e?65280:16711680)}else this.xrManager.updateTeleportTarget(null);this.getThumbstickAxes()}}setGroundMeshes(t){this.groundMeshes=t}dispose(){this.rayLine0&&(this.rayLine0.geometry.dispose(),this.rayLine0.material.dispose()),this.rayLine1&&(this.rayLine1.geometry.dispose(),this.rayLine1.material.dispose()),this.controller0&&(this.controller0.removeEventListener("selectstart",this.onSelectStart),this.controller0.removeEventListener("selectend",this.onSelectEnd),this.controller0.removeEventListener("squeezestart",this.onSqueezeStart),this.controller0.removeEventListener("squeezeend",this.onSqueezeEnd)),this.controller1&&(this.controller1.removeEventListener("selectstart",this.onSelectStart),this.controller1.removeEventListener("selectend",this.onSelectEnd),this.controller1.removeEventListener("squeezestart",this.onSqueezeStart),this.controller1.removeEventListener("squeezeend",this.onSqueezeEnd))}}class We{constructor(t,e,i){this.renderer=t,this.scene=e,this.characterModel=i,this.hand0=null,this.hand1=null,this.handModelFactory=new De,this.rightHandMesh=null,this.leftHandMesh=null,this.rightHandFallback=null,this.leftHandFallback=null,this.isEnabled=!1,this.handInputState={left:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null},right:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null}}}init(){this.hand0=this.renderer.xr.getHand(0),this.hand1=this.renderer.xr.getHand(1);try{this.rightHandMesh=this.handModelFactory.createHandModel(this.hand0,"mesh"),this.hand0.add(this.rightHandMesh),this.scene.add(this.hand0)}catch{console.warn("Hand tracking model 0 not available, using fallback")}try{this.leftHandMesh=this.handModelFactory.createHandModel(this.hand1,"mesh"),this.hand1.add(this.leftHandMesh),this.scene.add(this.hand1)}catch{console.warn("Hand tracking model 1 not available, using fallback")}this.createFallbackHands(),console.log("XR Hands initialized")}createFallbackHands(){const t=new a.Group,e=new a.SphereGeometry(.04,16,16),i=new a.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),s=new a.Mesh(e,i);t.add(s);const o=new a.CylinderGeometry(.01,.01,.08,8),n=new a.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),r=new a.Mesh(o,n);r.position.set(0,0,-.06),r.rotation.x=Math.PI/2,t.add(r);const c=new a.SphereGeometry(.012,8,8),d=new a.Mesh(c,n);d.position.set(0,0,-.1),t.add(d),this.rightHandFallback=t,this.rightHandFallback.visible=!1,this.scene.add(this.rightHandFallback);const u=t.clone();this.leftHandFallback=u,this.leftHandFallback.visible=!1,this.scene.add(this.leftHandFallback)}enable(){this.isEnabled=!0,this.hand0||this.init(),this.updateFallbackVisibility()}disable(){this.isEnabled=!1,this.rightHandFallback&&(this.rightHandFallback.visible=!1),this.leftHandFallback&&(this.leftHandFallback.visible=!1)}updateFallbackVisibility(){if(!this.isEnabled)return;const t=this.renderer.xr.getSession();if(!t)return;let e=!1;for(const i of t.inputSources)if(i.hand){e=!0;break}this.rightHandFallback&&(this.rightHandFallback.visible=this.isEnabled&&!e),this.leftHandFallback&&(this.leftHandFallback.visible=this.isEnabled&&!e)}update(){if(this.isEnabled){if(this.updateFallbackVisibility(),this.rightHandFallback&&this.rightHandFallback.visible){const t=this.renderer.xr.getController(0);t&&(this.rightHandFallback.position.copy(t.position),this.rightHandFallback.quaternion.copy(t.quaternion))}if(this.leftHandFallback&&this.leftHandFallback.visible){const t=this.renderer.xr.getController(1);t&&(this.leftHandFallback.position.copy(t.position),this.leftHandFallback.quaternion.copy(t.quaternion))}}}animateGrip(t,e){const i=t===0?this.rightHandFallback:this.leftHandFallback;if(!i||!i.visible)return;const s=i.children[1];s&&(s.scale.y=1-e*.3)}getJointPosition(t,e){if(!t)return null;const i=t.get(e);if(!i)return null;const s=this.renderer.xr.getFrame(),o=this.renderer.xr.getReferenceSpace();if(!s||!o)return null;const n=s.getJointPose(i,o);return n?new a.Vector3().setFromMatrixPosition(new a.Matrix4().fromArray(n.transform.matrix)):null}getPinchDistance(t){const e=this.getJointPosition(t,"thumb-tip"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:e.distanceTo(i)}getPointingDirection(t){const e=this.getJointPosition(t,"wrist"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:new a.Vector3().subVectors(i,e).normalize()}getPalmNormal(t){if(!t)return null;const e=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(!e||!i)return null;const s=t.get("wrist");if(!s)return null;const o=e.getJointPose(s,i);if(!o)return null;const n=new a.Matrix4().fromArray(o.transform.matrix),r=new a.Vector3(0,1,0);return r.applyMatrix4(n),r.sub(new a.Vector3().setFromMatrixPosition(n)),r.normalize()}resetGestureState(t){t!=="left"&&t!=="right"||(this.handInputState[t]={isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null})}resetAllGestureStates(){this.resetGestureState("left"),this.resetGestureState("right")}dispose(){this.resetAllGestureStates(),this.rightHandFallback&&(this.scene.remove(this.rightHandFallback),this.rightHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.leftHandFallback&&(this.scene.remove(this.leftHandFallback),this.leftHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.hand0&&this.scene.remove(this.hand0),this.hand1&&this.scene.remove(this.hand1)}}const qe=.015,Ye=300,_e=500,Ke=.003,Nt=.3,Ze=.6,Qe=600,M={IDLE:"idle",PAINTING:"painting",MOVING:"moving",JETPACK:"jetpack",MOVING_JETPACK:"moving_jetpack",TELEPORTING:"teleporting"};class ti{constructor(t,e,i=null){this.xrHands=t,this.xrManager=e,this.wristPalette=i,this.mode=M.IDLE,this.activePainterHand=null,this.paintModeEnabled=!1,this.isTeleporting=!1,this.callbacks={onPaintStart:null,onPaintDrag:null,onPaintEnd:null,onMovementStart:null,onMovementUpdate:null,onMovementEnd:null,onJetpackStart:null,onJetpackEnd:null,onColorSelect:null,onTeleportStart:null,onTeleportUpdate:null,onTeleportEnd:null,onTogglePaintMode:null},this.selectedColorIndex=6,console.log("GestureDetector initialized with proven LDIPlayer patterns")}setWristPalette(t){this.wristPalette=t}update(t,e){if(t){for(const i of t.inputSources)if(i.hand){const s=i.hand,o=i.handedness;if(o!=="left"&&o!=="right")continue;this.updateHandGestures(s,o,e)}this.updateMode(e)}}updateHandGestures(t,e,i){const s=this.xrHands.handInputState[e],o=this.xrHands.getPinchDistance(t);if(o===null)return;const n=performance.now();if(o<qe)if(s.isPinching)this.onPinchSustain(t,e,s,i);else{s.isPinching=!0,s.pinchStartTime=n;const r=this.xrHands.getJointPosition(t,"index-finger-tip");r&&(s.dragStartPosition={x:r.x,y:r.y,z:r.z}),this.onPinchStart(t,e,i)}else if(s.isPinching){const r=n-s.pinchStartTime;this.onPinchRelease(t,e,s,r,n),s.isPinching=!1,s.dragStartPosition=null}}onPinchStart(t,e,i){console.log(`${e} pinch start`),this.mode,M.IDLE}onPinchSustain(t,e,i,s){const o=this.xrHands.getJointPosition(t,"index-finger-tip");if(!o||!i.dragStartPosition)return;const n=o.x-i.dragStartPosition.x,r=o.y-i.dragStartPosition.y,c=o.z-i.dragStartPosition.z,d=Math.sqrt(n*n+r*r+c*c);if(e==="left"&&!this.paintModeEnabled){const u=this.xrHands.getJointPosition(t,"wrist");if(u&&o){const f=u.clone(),m=new a.Vector3().subVectors(o,u).normalize();this.isTeleporting?this.callbacks.onTeleportUpdate&&this.callbacks.onTeleportUpdate(f,m):(this.isTeleporting=!0,this.mode=M.TELEPORTING,console.log("LEFT hand teleportation started"),this.callbacks.onTeleportStart&&this.callbacks.onTeleportStart(f,m))}return}d>Ke&&(this.mode===M.IDLE&&this.paintModeEnabled&&this.activePainterHand===null&&this.startPainting(t,e),this.mode===M.PAINTING&&this.activePainterHand===e&&this.updatePainting(t,e))}onPinchRelease(t,e,i,s,o){if(console.log(`${e} pinch release (duration: ${s}ms)`),e==="left"&&this.isTeleporting){const n=this.xrHands.getJointPosition(t,"wrist"),r=this.xrHands.getJointPosition(t,"index-finger-tip");if(n&&r){const c=n.clone(),d=new a.Vector3().subVectors(r,n).normalize();console.log("LEFT hand teleportation executed"),this.callbacks.onTeleportEnd&&this.callbacks.onTeleportEnd(c,d)}this.isTeleporting=!1,this.mode=M.IDLE;return}s<Ye?(o-i.lastTapTime<_e?(i.tapCount++,console.log(`${e} double-tap detected (count: ${i.tapCount})`),this.onDoubleTap(e)):(i.tapCount=1,console.log(`${e} tap 1/2`),this.onSingleTap(t,e)),i.lastTapTime=o):(console.log(`${e} hold/drag end (duration: ${s}ms)`),this.mode===M.PAINTING&&this.activePainterHand===e&&this.endPainting(e),this.mode===M.JETPACK&&e==="right"&&this.endJetpack(e))}onSingleTap(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(!i||!s)return;const o=i.clone(),n=new a.Vector3().subVectors(s,i).normalize();if(this.wristPalette&&this.wristPalette.checkToggleButtonHover(o,n)){const r=this.wristPalette.togglePaintMode();this.paintModeEnabled=r,this.callbacks.onTogglePaintMode&&this.callbacks.onTogglePaintMode(r),console.log(`Paint mode toggled via wrist button: ${r?"ON":"OFF"}`);return}if(this.paintModeEnabled&&this.callbacks.onColorSelect){this.callbacks.onColorSelect(o,n);return}}onDoubleTap(t){console.log(`${t} double-tap action`)}startPainting(t,e){this.mode=M.PAINTING,this.activePainterHand=e;const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&s){const o=i.clone(),n=new a.Vector3().subVectors(s,i).normalize();console.log(`Painting started with ${e} hand`),this.callbacks.onPaintStart&&this.callbacks.onPaintStart(e,o,n)}}updatePainting(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),s=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&s){const o=i.clone(),n=new a.Vector3().subVectors(s,i).normalize();this.callbacks.onPaintDrag&&this.callbacks.onPaintDrag(e,o,n)}}endPainting(t){console.log(`Painting ended with ${t} hand`),this.mode=M.IDLE,this.activePainterHand=null,this.callbacks.onPaintEnd&&this.callbacks.onPaintEnd(t)}startJetpack(t){this.mode===M.MOVING?this.mode=M.MOVING_JETPACK:this.mode=M.JETPACK,console.log(`Jetpack started with ${t} hand`),this.callbacks.onJetpackStart&&this.callbacks.onJetpackStart(t)}endJetpack(t){console.log(`Jetpack ended with ${t} hand`),this.mode===M.MOVING_JETPACK?this.mode=M.MOVING:this.mode=M.IDLE,this.callbacks.onJetpackEnd&&this.callbacks.onJetpackEnd(t)}updateMode(t){this.mode!==M.PAINTING&&this.checkMovementGesture(t),this.mode!==M.PAINTING&&this.checkJetpackGesture()}checkMovementGesture(t){const e=this.xrManager.renderer.xr.getSession();if(!e){console.log("[Movement] No XR session");return}let i=null;for(const r of e.inputSources)if(r.hand&&r.handedness==="left"){i=r.hand;break}if(!i){console.log("[Movement] No left hand found");return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getJointPosition(i,"index-finger-tip");if(!s||!o||!t){console.log("[Movement] Missing joint positions - wrist:",!!s,"indexTip:",!!o,"camera:",!!t);return}const n=s.distanceTo(t);if(console.log(`[Movement] Extension distance: ${n.toFixed(3)}m (min: ${Nt}m)`),n>=Nt){const r=new a.Vector3().subVectors(o,s).normalize();r.y=0,r.normalize();const c=Math.min((n-Nt)/(Ze-Nt),1);if(console.log(`[Movement] Hand extended! Speed: ${c.toFixed(2)}, Mode: ${this.mode}`),this.mode===M.IDLE||this.mode===M.JETPACK){const d=this.mode===M.JETPACK?M.MOVING_JETPACK:M.MOVING;this.mode=d,console.log(`[Movement] Started - New mode: ${d}`),this.callbacks.onMovementStart&&this.callbacks.onMovementStart(r,c)}else(this.mode===M.MOVING||this.mode===M.MOVING_JETPACK)&&this.callbacks.onMovementUpdate&&this.callbacks.onMovementUpdate(r,c)}else console.log("[Movement] Hand not extended enough"),this.mode===M.MOVING?(this.mode=M.IDLE,console.log("[Movement] Ended - Mode: IDLE"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd()):this.mode===M.MOVING_JETPACK&&(this.mode=M.JETPACK,console.log("[Movement] Ended - Mode: JETPACK"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd())}checkJetpackGesture(){const t=this.xrHands.handInputState.right,e=performance.now();if(!(this.mode===M.TELEPORTING||this.mode===M.PAINTING)&&t.isPinching){const i=e-t.pinchStartTime;i>=Qe&&this.mode!==M.JETPACK&&this.mode!==M.MOVING_JETPACK&&(console.log(`RIGHT hand jetpack activated (hold duration: ${i}ms)`),this.startJetpack("right"))}}isLeftPalmFacingUser(t){const e=this.xrManager.renderer.xr.getSession();if(!e)return!1;let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i)return!1;const s=this.xrHands.getPalmNormal(i),o=this.xrHands.getJointPosition(i,"wrist");if(!s||!o||!t)return!1;const n=new a.Vector3().subVectors(t,o).normalize();return s.dot(n)>.5}reset(){this.mode=M.IDLE,this.activePainterHand=null,this.xrHands.resetAllGestureStates(),console.log("GestureDetector reset")}on(t,e){this.callbacks.hasOwnProperty("on"+t.charAt(0).toUpperCase()+t.slice(1))&&(this.callbacks["on"+t.charAt(0).toUpperCase()+t.slice(1)]=e)}}class ei{constructor(t,e){this.scene=t,this.xrHands=e,this.colors=[{hex:16711680,name:"Red"},{hex:16746496,name:"Orange"},{hex:16776960,name:"Yellow"},{hex:65280,name:"Green"},{hex:65535,name:"Cyan"},{hex:255,name:"Blue"},{hex:8913151,name:"Purple"},{hex:16711935,name:"Magenta"},{hex:16777215,name:"White"},{hex:8947848,name:"Gray"},{hex:0,name:"Black"},{hex:8930304,name:"Brown"}],this.spheres=[],this.selectedIndex=6,this.hoveredIndex=-1,this.toggleButton=null,this.toggleButtonHovered=!1,this.paintModeEnabled=!1,this.paletteGroup=null,this.isVisible=!1,this.sphereRadius=.015,this.arcRadius=.12,this.arcSpan=Math.PI/2,this.rows=3,this.cols=4,this.createPalette()}createPalette(){this.paletteGroup=new a.Group,this.paletteGroup.visible=!1;let t=0;for(let r=0;r<this.rows;r++)for(let c=0;c<this.cols&&!(t>=this.colors.length);c++){const d=this.colors[t],u=new a.SphereGeometry(this.sphereRadius,16,16),f=new a.MeshStandardMaterial({color:d.hex,roughness:.3,metalness:.1,emissive:d.hex,emissiveIntensity:.2}),m=new a.Mesh(u,f),y=(c/(this.cols-1)-.5)*this.arcSpan,k=(r-(this.rows-1)/2)*(this.sphereRadius*3);m.position.x=Math.sin(y)*this.arcRadius,m.position.y=k,m.position.z=-Math.cos(y)*this.arcRadius,m.userData.colorIndex=t,m.userData.colorHex=d.hex,m.userData.colorName=d.name,this.spheres.push(m),this.paletteGroup.add(m),t++}const e=new a.RingGeometry(this.sphereRadius*1.2,this.sphereRadius*1.5,32),i=new a.MeshBasicMaterial({color:16777215,side:a.DoubleSide,transparent:!0,opacity:.8});this.selectionRing=new a.Mesh(e,i),this.selectionRing.visible=!1,this.paletteGroup.add(this.selectionRing);const s=this.sphereRadius*2.5,o=new a.SphereGeometry(s,16,16),n=new a.MeshStandardMaterial({color:16711680,roughness:.3,metalness:.1,emissive:16711680,emissiveIntensity:.3});this.toggleButton=new a.Mesh(o,n),this.toggleButton.position.set(0,this.sphereRadius*6,0),this.toggleButton.userData.isToggleButton=!0,this.paletteGroup.add(this.toggleButton),this.scene.add(this.paletteGroup),console.log("WristPalette created with",this.colors.length,"colors and toggle button")}update(t){const e=this.xrHands.renderer.xr.getSession();if(!e){this.hide();return}let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i){this.hide();return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getPalmNormal(i);if(!s||!o||!t){this.hide();return}const n=new a.Vector3().subVectors(t,s).normalize();if(o.dot(n)>.5){this.show(),this.paletteGroup.position.copy(s),this.paletteGroup.lookAt(t);const c=new a.Vector3().subVectors(t,s).normalize();this.paletteGroup.position.add(c.multiplyScalar(.05))}else this.hide()}checkHover(t,e){if(!this.isVisible)return null;const s=new a.Raycaster(t,e).intersectObjects(this.spheres);if(s.length>0){const o=s[0].object.userData.colorIndex;return this.setHovered(o),o}else return this.setHovered(-1),null}checkToggleButtonHover(t,e){if(!this.isVisible||!this.toggleButton)return!1;const o=new a.Raycaster(t,e).intersectObject(this.toggleButton).length>0;return o!==this.toggleButtonHovered&&(this.toggleButtonHovered=o,this.toggleButton&&(o?(this.toggleButton.scale.set(1.2,1.2,1.2),this.toggleButton.material.emissiveIntensity=.6):(this.toggleButton.scale.set(1,1,1),this.toggleButton.material.emissiveIntensity=.3))),o}togglePaintMode(){if(this.paintModeEnabled=!this.paintModeEnabled,this.toggleButton){const t=this.paintModeEnabled?65280:16711680;this.toggleButton.material.color.setHex(t),this.toggleButton.material.emissive.setHex(t),this.toggleButton.scale.set(1.4,1.4,1.4),setTimeout(()=>{this.toggleButton.scale.set(1,1,1)},100)}return console.log(`Paint mode toggled: ${this.paintModeEnabled?"ON":"OFF"}`),this.paintModeEnabled}getPaintModeEnabled(){return this.paintModeEnabled}setHovered(t){if(this.hoveredIndex!==t){if(this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1,1,1),e.material.emissiveIntensity=.2}if(this.hoveredIndex=t,this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1.3,1.3,1.3),e.material.emissiveIntensity=.6}}}selectColor(t){if(t<0||t>=this.colors.length)return;this.selectedIndex=t,console.log("Selected color:",this.colors[t].name);const e=this.spheres[t];this.selectionRing.position.copy(e.position),this.selectionRing.lookAt(this.paletteGroup.position),this.selectionRing.visible=this.isVisible;const i=e.scale.clone();e.scale.set(1.5,1.5,1.5),setTimeout(()=>{e.scale.copy(i)},100)}getSelectedColor(){return this.colors[this.selectedIndex]}show(){if(!this.isVisible&&(this.paletteGroup.visible=!0,this.selectionRing.visible=!0,this.isVisible=!0,this.selectedIndex>=0&&this.selectedIndex<this.spheres.length)){const t=this.spheres[this.selectedIndex];this.selectionRing.position.copy(t.position),this.selectionRing.lookAt(this.paletteGroup.position)}}hide(){this.isVisible&&(this.paletteGroup.visible=!1,this.selectionRing.visible=!1,this.isVisible=!1,this.setHovered(-1))}dispose(){this.spheres.forEach(t=>{t.geometry.dispose(),t.material.dispose()}),this.selectionRing&&(this.selectionRing.geometry.dispose(),this.selectionRing.material.dispose()),this.toggleButton&&(this.toggleButton.geometry.dispose(),this.toggleButton.material.dispose()),this.paletteGroup&&this.scene.remove(this.paletteGroup)}}class ii{constructor(t){this.scene=t,this.paintRays={left:null,right:null},this.movementArrow=null,this.jetpackGlows={left:null,right:null},this.createVisuals()}createVisuals(){this.createPaintRays(),this.createMovementArrow(),this.createJetpackGlows()}createPaintRays(){const t=()=>{const e=new a.BufferGeometry,i=new Float32Array([0,0,0,0,0,-5]);e.setAttribute("position",new a.BufferAttribute(i,3));const s=new a.LineBasicMaterial({color:65280,transparent:!0,opacity:.6,linewidth:2}),o=new a.Line(e,s);return o.visible=!1,this.scene.add(o),o};this.paintRays.left=t(),this.paintRays.right=t()}createMovementArrow(){const t=new a.Group,e=new a.CylinderGeometry(.02,.02,.4,8),i=new a.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),s=new a.Mesh(e,i);s.rotation.z=-Math.PI/2,t.add(s);const o=new a.ConeGeometry(.05,.1,8),n=new a.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),r=new a.Mesh(o,n);r.rotation.z=-Math.PI/2,r.position.x=.25,t.add(r),t.visible=!1,this.scene.add(t),this.movementArrow=t}createJetpackGlows(){const t=()=>{const e=new a.SphereGeometry(.06,16,16),i=new a.MeshBasicMaterial({color:65280,transparent:!0,opacity:.5}),s=new a.Mesh(e,i);return s.visible=!1,this.scene.add(s),s};this.jetpackGlows.left=t(),this.jetpackGlows.right=t()}updatePaintRay(t,e,i,s=!0){const o=this.paintRays[t];if(o)if(s&&e&&i){o.visible=!0,o.position.copy(e);const n=new a.Vector3().copy(e).add(i.clone().multiplyScalar(5));o.lookAt(n);const r=o.geometry.attributes.position.array;r[3]=0,r[4]=0,r[5]=-5,o.geometry.attributes.position.needsUpdate=!0}else o.visible=!1}updateMovementArrow(t,e,i,s=!0){if(this.movementArrow)if(s&&t&&e&&i>0){this.movementArrow.visible=!0,this.movementArrow.position.copy(t),this.movementArrow.position.y=t.y-1.3;const o=new a.Vector3().copy(t).add(e);o.y=this.movementArrow.position.y,this.movementArrow.lookAt(o);const n=.5+i*.5;this.movementArrow.scale.set(n,n,n),this.movementArrow.children.forEach(r=>{r.material&&(r.material.opacity=.4+i*.3)})}else this.movementArrow.visible=!1}updateJetpackGlow(t,e,i=!0){const s=this.jetpackGlows[t];if(s)if(i&&e){s.visible=!0,s.position.copy(e);const o=performance.now()*.005,n=.8+Math.sin(o)*.2;s.scale.set(n,n,n),s.material.opacity=.3+Math.sin(o*2)*.2}else s.visible=!1}hidePaintRays(){this.paintRays.left.visible=!1,this.paintRays.right.visible=!1}hideMovementArrow(){this.movementArrow&&(this.movementArrow.visible=!1)}hideJetpackGlows(){this.jetpackGlows.left.visible=!1,this.jetpackGlows.right.visible=!1}hideAll(){this.hidePaintRays(),this.hideMovementArrow(),this.hideJetpackGlows()}dispose(){Object.values(this.paintRays).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))}),this.movementArrow&&(this.movementArrow.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.scene.remove(this.movementArrow)),Object.values(this.jetpackGlows).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))})}}class si{constructor(t,e,i,s=30,o=0,n=null,r=null){this.splatMesh=t,this.camera=e,this.renderer=i,this.spark=r,this.targetFPS=s,this.boundingBox=null,this.splatExtent=n||1,this.currentLODLevel=o,this.frameCount=0,this.lastTime=performance.now(),this.fps=60,this.fpsHistory=[],this.manualMode=!1,this.lodConfigs=[{name:"Ultra",distMult:10,skipFactor:1,pixelRatio:2,maxStdDev:Math.sqrt(8),minPixelRadius:0,minAlpha:.5/255,falloff:1},{name:"High",distMult:.15,skipFactor:1,pixelRatio:1.5,maxStdDev:Math.sqrt(7),minPixelRadius:.3,minAlpha:.7/255,falloff:.95},{name:"Medium",distMult:.1,skipFactor:2,pixelRatio:1.5,maxStdDev:Math.sqrt(6),minPixelRadius:.5,minAlpha:1/255,falloff:.85},{name:"Low",distMult:.06,skipFactor:3,pixelRatio:1,maxStdDev:Math.sqrt(5),minPixelRadius:.8,minAlpha:1.8/255,falloff:.7},{name:"Potato",distMult:.03,skipFactor:4,pixelRatio:.75,maxStdDev:Math.sqrt(4.5),minPixelRadius:1.2,minAlpha:2.5/255,falloff:.6}],this.maxDistanceUniform=new T.DynoFloat({value:1e3}),this.skipFactorUniform=new T.DynoInt({value:1}),this.bypassLODUniform=new T.DynoBool({value:!1}),this.cameraPosUniform=new T.DynoVec3({value:[0,0,0]}),this.originalPixelRatio=this.renderer.getPixelRatio(),this.onModifierCreated=null,this.onLODUpdate=null;const c=()=>{console.log("[DistanceBasedLOD] *** Initializing LOD system ***"),console.log("[DistanceBasedLOD] About to call setupModifier()..."),this.setupModifier(),console.log("[DistanceBasedLOD] Modifier created"),n?(console.log(`[DistanceBasedLOD] Using provided world extent: ${this.splatExtent.toFixed(2)} units`),this.updateLODLevel(this.currentLODLevel)):(console.log("[DistanceBasedLOD] Calculating extent from mesh..."),this.calculateExtent()),console.log(`[DistanceBasedLOD] Initialized - Extent: ${this.splatExtent.toFixed(2)} units, Starting at ${this.getCurrentLODName()}`),this.onModifierCreated?(console.log("[DistanceBasedLOD] Calling onModifierCreated callback..."),this.onModifierCreated()):console.warn("[DistanceBasedLOD] No onModifierCreated callback set!")};this.splatMesh.initialized?(console.log("[DistanceBasedLOD] Mesh already initialized, setting up immediately"),setTimeout(()=>c(),0)):(console.log("[DistanceBasedLOD] Mesh not yet initialized, registering event listener..."),this.splatMesh.addEventListener("initialized",c))}calculateExtent(){this.boundingBox=this.splatMesh.getBoundingBox(!1);const t=new a.Vector3;this.boundingBox.getSize(t),this.splatExtent=t.length(),console.log(`[DistanceBasedLOD] Calculated splat extent (world-space): ${this.splatExtent.toFixed(2)} units`),console.log(`[DistanceBasedLOD] Bounding box size: X=${t.x.toFixed(2)}, Y=${t.y.toFixed(2)}, Z=${t.z.toFixed(2)}`),this.updateLODLevel(this.currentLODLevel)}setupModifier(){this.lodModifier=T.dynoBlock({gsplat:T.Gsplat},{gsplat:T.Gsplat},({gsplat:t})=>(t=new T.Dyno({inTypes:{gsplat:T.Gsplat,maxDist:"float",skipFactor:"int",cameraPos:"vec3",bypassLOD:"bool"},outTypes:{gsplat:T.Gsplat},statements:({inputs:i,outputs:s})=>{const{gsplat:o,maxDist:n,skipFactor:r,cameraPos:c,bypassLOD:d}=i,{gsplat:u}=s;return T.unindentLines(`
                            ${u} = ${o};

                            // Early exit: Skip all LOD calculations if in bypass mode (Ultra quality)
                            // This avoids expensive per-splat distance calculations when not needed
                            if (!${d}) {
                                // Distance-based culling (world-space)
                                float distance = length(${u}.center - ${c});
                                if (distance > ${n}) {
                                    ${u}.flags = 0u; // Mark as inactive (culled)
                                }

                                // Index-based subsampling for additional decimation
                                // Skip every N splats to reduce render load
                                if (${r} > 1 && ${o}.index % ${r} != 0) {
                                    ${u}.flags = 0u;
                                }
                            }
                        `)}}).apply({gsplat:t,maxDist:this.maxDistanceUniform,skipFactor:this.skipFactorUniform,cameraPos:this.cameraPosUniform,bypassLOD:this.bypassLODUniform}).gsplat,{gsplat:t})),this.splatMesh.worldModifier=this.lodModifier,console.log("[DistanceBasedLOD] Distance-based worldModifier shader installed")}getModifier(){return this.lodModifier||console.warn("[DistanceBasedLOD] getModifier() called but lodModifier not created yet!"),this.lodModifier}update(){if(this.cameraPosUniform&&this.camera&&this.lodModifier&&!this.bypassLODUniform.value){const e=this.camera.position,i=this.cameraPosUniform.value;i[0]=e.x,i[1]=e.y,i[2]=e.z}this.frameCount++;const t=performance.now();if(t>=this.lastTime+1e3){this.fps=Math.round(this.frameCount*1e3/(t-this.lastTime)),this.frameCount=0,this.lastTime=t,this.fpsHistory.push(this.fps),this.fpsHistory.length>3&&this.fpsHistory.shift();const e=this.fpsHistory.reduce((i,s)=>i+s,0)/this.fpsHistory.length;this.manualMode||this.adjustLOD(e)}}adjustLOD(t){this.currentLODLevel,t<this.targetFPS-5&&this.currentLODLevel<this.lodConfigs.length-1&&(this.currentLODLevel++,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] â†“ Reduced to: ${this.getCurrentLODName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`)),t>this.targetFPS+5*2&&this.currentLODLevel>0&&(this.currentLODLevel--,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] â†‘ Increased to: ${this.getCurrentLODName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`))}updateLODLevel(t){this.currentLODLevel=Math.max(0,Math.min(this.lodConfigs.length-1,t));const e=this.lodConfigs[this.currentLODLevel];this.maxDistanceUniform.value=this.splatExtent*e.distMult,this.skipFactorUniform.value=e.skipFactor,this.bypassLODUniform.value=this.currentLODLevel===0,console.log(`[DistanceBasedLOD] Updated uniforms - Distance: ${this.maxDistanceUniform.value.toFixed(2)}, Skip: ${e.skipFactor}, Bypass: ${this.bypassLODUniform.value}`),this.lodModifier&&this.onLODUpdate?(console.log("[DistanceBasedLOD] Calling onLODUpdate callback to rebuild combined modifier"),this.onLODUpdate()):this.lodModifier?this.splatMesh.updateGenerator&&(this.splatMesh.updateGenerator(),console.log("[DistanceBasedLOD] Shader updated directly (no combined modifier)")):console.warn("[DistanceBasedLOD] Cannot update shader - lodModifier not created yet (waiting for 'initialized' event)");const i=Math.min(this.originalPixelRatio,e.pixelRatio);this.renderer.setPixelRatio(i),this.spark&&e.maxStdDev!==void 0&&(this.spark.setQualityParams({maxStdDev:e.maxStdDev,minPixelRadius:e.minPixelRadius,minAlpha:e.minAlpha,falloff:e.falloff}),console.log(`[DistanceBasedLOD] Applied Spark quality params: maxStdDev=${e.maxStdDev.toFixed(2)}, minPixelRadius=${e.minPixelRadius}, falloff=${e.falloff}`)),console.log(`[DistanceBasedLOD] LOD: ${e.name}, Distance: ${this.maxDistanceUniform.value.toFixed(2)} units, Skip: ${e.skipFactor}, PixelRatio: ${i.toFixed(1)}`)}increaseLOD(){this.currentLODLevel>0?(this.manualMode=!0,this.currentLODLevel--,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] Manual increase to: ${this.getCurrentLODName()} (Adaptive DISABLED)`)):console.log(`[DistanceBasedLOD] Already at maximum quality (${this.getCurrentLODName()})`)}decreaseLOD(){this.currentLODLevel<this.lodConfigs.length-1?(this.manualMode=!0,this.currentLODLevel++,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] Manual decrease to: ${this.getCurrentLODName()} (Adaptive DISABLED)`)):console.log(`[DistanceBasedLOD] Already at minimum quality (${this.getCurrentLODName()})`)}resumeAdaptive(){this.manualMode=!1,console.log("[DistanceBasedLOD] Resumed adaptive LOD adjustment"),console.log(`[DistanceBasedLOD] Current LOD: ${this.getCurrentLODName()} (will adjust based on FPS)`)}setTargetFPS(t){if(t!==this.targetFPS){const e=this.targetFPS;this.targetFPS=t,this.fpsHistory=[],console.log(`[DistanceBasedLOD] Target FPS changed: ${e} â†’ ${t}`)}}getFPS(){return this.fps}getCurrentLODName(){return this.lodConfigs[this.currentLODLevel].name}getCurrentLODLevel(){return this.currentLODLevel}getLODConfigs(){return this.lodConfigs.map(t=>t.name)}isManualMode(){return this.manualMode}getSplatExtent(){return this.splatExtent}getStats(){const t=this.lodConfigs[this.currentLODLevel];return{fps:this.fps,lodName:t.name,lodLevel:this.currentLODLevel,maxDistance:this.maxDistanceUniform.value.toFixed(2),skipFactor:t.skipFactor,pixelRatio:this.renderer.getPixelRatio().toFixed(1),targetFPS:this.targetFPS,splatExtent:this.splatExtent.toFixed(2)}}}class oi{constructor(){this.currentSiteId=null,this.urlParams=new URLSearchParams(window.location.search)}hasSiteParameter(){return this.urlParams.has("site")}getSiteFromURL(){return this.urlParams.get("site")}isValidSite(t,e){return!t||!e?!1:e.some(i=>i.id===t)}shouldShowGlobe(t){const e=this.getSiteFromURL();return e?this.isValidSite(e,t)?(this.currentSiteId=e,!1):(console.warn(`Invalid site parameter: ${e}. Showing globe.`),!0):!0}navigateToSite(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.location.href=i}navigateToGlobe(){window.location.href=window.location.pathname}getCurrentSiteId(){return this.currentSiteId||this.getSiteFromURL()}updateURLWithoutReload(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.history.pushState({siteId:t},"",i)}}class ni{constructor(t,e){this.container=t,this.onSiteSelected=e,this.scene=null,this.camera=null,this.renderer=null,this.labelRenderer=null,this.controls=null,this.earth=null,this.atmosphere=null,this.markers=[],this.raycaster=new a.Raycaster,this.mouse=new a.Vector2,this.hoveredMarker=null,this.animationId=null,this.isInitialized=!1}latLongToVector3(t,e,i){const s=(90-t)*(Math.PI/180),o=(e+180)*(Math.PI/180);return new a.Vector3(-i*Math.sin(s)*Math.cos(o),i*Math.cos(s),i*Math.sin(s)*Math.sin(o))}async init(t){if(this.isInitialized)return;this.scene=new a.Scene,this.scene.background=new a.Color(1296);const e=window.innerWidth/window.innerHeight;this.camera=new a.PerspectiveCamera(45,e,.1,1e3);const n=this.latLongToVector3(45,10,12);this.camera.position.copy(n),this.camera.lookAt(0,0,0),this.renderer=new a.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.labelRenderer=new Le,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0",this.labelRenderer.domElement.style.pointerEvents="none",this.container.appendChild(this.labelRenderer.domElement);const r=new a.AmbientLight(16777215,.4);this.scene.add(r);const c=new a.DirectionalLight(16777215,.8);c.position.set(5,3,5),this.scene.add(c),await this.createEarth(),this.createAtmosphere(),this.createSiteMarkers(t),this.controls=new Ee(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.minDistance=7,this.controls.maxDistance=20,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.addEventListeners(),this.isInitialized=!0,this.animate()}async createEarth(){const t=new a.SphereGeometry(5,64,64),e=new a.TextureLoader,i=await new Promise((o,n)=>{e.load("models/textures/earth_day.jpg",o,void 0,n)}),s=new a.MeshStandardMaterial({map:i,roughness:.9,metalness:.1});this.earth=new a.Mesh(t,s),this.scene.add(this.earth)}createAtmosphere(){const t=new a.SphereGeometry(5.2,64,64),e=new a.ShaderMaterial({vertexShader:`
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
                }
            `,blending:a.AdditiveBlending,side:a.BackSide,transparent:!0});this.atmosphere=new a.Mesh(t,e),this.scene.add(this.atmosphere)}positionLabelsWithCollisionAvoidance(t,e=8,i=1.5){const s=t.map(r=>this.latLongToVector3(r.latitude,r.longitude,e)),o=50,n=.5;for(let r=0;r<o;r++){let c=!1;for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++){const f=s[d].distanceTo(s[u]);if(f<i){const m=new a.Vector3().subVectors(s[d],s[u]).normalize(),y=(i-f)*n;s[d].add(m.clone().multiplyScalar(y)),s[u].sub(m.clone().multiplyScalar(y)),c=!0}}if(s.forEach(d=>{d.normalize().multiplyScalar(e)}),!c){console.log(`Label positioning converged in ${r+1} iterations`);break}}return s}createConnectingLine(t,e){const i=[t,e],s=new a.BufferGeometry().setFromPoints(i),o=new a.LineBasicMaterial({color:16777215,opacity:.5,transparent:!0,linewidth:1});return new a.Line(s,o)}createSiteMarkers(t){const s=this.positionLabelsWithCollisionAvoidance(t,6.5);t.forEach((o,n)=>{const r=this.latLongToVector3(o.latitude,o.longitude,5.05),c=s[n],d=new a.SphereGeometry(.15,16,16),u=new a.MeshBasicMaterial({color:16737792,transparent:!0,opacity:0}),f=new a.Mesh(d,u);f.position.copy(r),f.userData={siteId:o.id,siteName:o.name},this.scene.add(f);const m=this.createLabelElement(o),y=new Re(m);y.position.copy(c),y.userData={siteId:o.id},this.scene.add(y);const k=this.createConnectingLine(r,c);this.scene.add(k),this.markers.push({mesh:f,label:y,line:k,site:o,sitePosition:r.clone(),labelPosition:c.clone()})})}createLabelElement(t){const e=document.createElement("div");e.className="globe-site-marker",e.style.pointerEvents="auto";const i=document.createElement("div");i.className="globe-thumbnail-container",i.style.width="80px",i.style.height="80px",i.style.borderRadius="50%",i.style.border="3px solid #ff6600",i.style.marginBottom="8px",i.style.overflow="hidden",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.boxShadow="0 0 20px rgba(255, 102, 0, 0.6)",i.style.transition="border-color 0.2s ease, box-shadow 0.2s ease";const s=document.createElement("img");s.src=t.thumbnail||"models/thumbnails/placeholder.jpg",s.alt=t.name,s.style.width="120px",s.style.height="120px",s.style.objectFit="cover",s.style.display="block",i.appendChild(s);const o=document.createElement("span");return o.textContent=t.name,o.style.color="#ffffff",o.style.fontSize="14px",o.style.fontWeight="bold",o.style.textShadow="0 0 10px rgba(0, 0, 0, 0.8)",o.style.display="block",o.style.textAlign="center",e.appendChild(i),e.appendChild(o),e.style.cursor="pointer",e.style.transition="transform 0.2s ease",e.dataset.siteId=t.id,e}addEventListeners(){window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("click",this.onClick.bind(this)),window.addEventListener("touchend",this.onTouch.bind(this)),window.addEventListener("resize",this.onWindowResize.bind(this))}onMouseMove(t){var s,o;this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-(t.clientY/window.innerHeight)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(n=>n.mesh),i=this.raycaster.intersectObjects(e);if(this.hoveredMarker){const n=(s=this.markers.find(r=>r.mesh===this.hoveredMarker))==null?void 0:s.label;n&&(n.element.style.transform="scale(1)"),this.hoveredMarker=null}if(i.length>0){this.hoveredMarker=i[0].object;const n=(o=this.markers.find(r=>r.mesh===this.hoveredMarker))==null?void 0:o.label;n&&(n.element.style.transform="scale(1.2)"),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onTouch(t){const e=t.changedTouches[0],i=document.elementFromPoint(e.clientX,e.clientY);if(i&&i.closest(".globe-site-marker")){const o=i.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&(console.log("Touch site selected:",o),this.onSiteSelected(o),t.preventDefault())}}onClick(t){if(t.target.closest(".globe-site-marker")){const o=t.target.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&this.onSiteSelected(o);return}this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(s=>s.mesh),i=this.raycaster.intersectObjects(e);if(i.length>0){const s=i[0].object.userData.siteId;s&&this.onSiteSelected&&this.onSiteSelected(s)}}onWindowResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.labelRenderer.setSize(t,e)}animate(){this.animationId=requestAnimationFrame(this.animate.bind(this)),this.controls&&this.controls.update(),this.updateConnectingLines(),this.renderer&&this.scene&&this.camera&&(this.renderer.render(this.scene,this.camera),this.labelRenderer.render(this.scene,this.camera))}updateConnectingLines(){this.markers&&this.markers.forEach(t=>{if(t.line&&t.mesh&&t.label){const e=new a.Vector3;t.mesh.getWorldPosition(e);const i=t.label.position,s=t.line.geometry.attributes.position.array;s[0]=e.x,s[1]=e.y,s[2]=e.z,s[3]=i.x,s[4]=i.y,s[5]=i.z,t.line.geometry.attributes.position.needsUpdate=!0}})}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),window.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("click",this.onClick.bind(this)),window.removeEventListener("touchend",this.onTouch.bind(this)),window.removeEventListener("resize",this.onWindowResize.bind(this)),this.controls&&this.controls.dispose(),this.markers&&(this.markers.forEach(t=>{t.line&&(t.line.geometry&&t.line.geometry.dispose(),t.line.material&&t.line.material.dispose()),t.mesh&&(t.mesh.geometry&&t.mesh.geometry.dispose(),t.mesh.material&&t.mesh.material.dispose())}),this.markers=[]),this.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.renderer&&this.container.removeChild(this.renderer.domElement),this.labelRenderer&&this.container.removeChild(this.labelRenderer.domElement),this.isInitialized=!1}show(){this.container.style.display="block",setTimeout(()=>{this.container.classList.add("visible")},50)}hide(){this.container.classList.remove("visible"),setTimeout(()=>{this.container.style.display="none"},500)}}let bt=null,h=null,Mt=null,gt=null,Zt=null,U,v,D,tt,C,b,G,L=null,q=null,Ft=null,z=null,rt=null,Y=null,St=null,kt=0,S,X,g=null,ut=1,_=null,ct=0,ee=2500,R=null,K=null,Pt=213,Ct=37,zt=180,Gt=0,Vt=0,Tt=0,Dt=0,V=0,ot=0,nt=0,at=0;const ai=new a.Clock;let he=60;const Kt=T.dynoFloat(0);let qt=0;const x={enabled:T.dynoBool(!1),brushRadius:T.dynoFloat(.05),brushDepth:T.dynoFloat(10),brushOrigin:T.dynoVec3(new a.Vector3(0,0,0)),brushDirection:T.dynoVec3(new a.Vector3(0,0,0)),brushColor:T.dynoVec3(new a.Vector3(1,0,1)),useSurface:T.dynoBool(!1),surfacePoint:T.dynoVec3(new a.Vector3(0,0,0)),surfaceRadius:T.dynoFloat(.2)},ri=.01,li=.25,ci=.1,hi=100;let J=!1,Qt=!1,Z=null,ie=!1;const F=function(){const l="ontouchstart"in window||navigator.maxTouchPoints>0,t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),e=l||t;return console.log("Mobile detection:",{touch:l,userAgent:t,isMobile:e}),e}(),Et={},se=new Oe(F);let H=null,it="third-person",et=0,Q=0,oe=!1;const de=.002,ue=.005,Yt=Math.PI/2-.1;function ae(l){for(;l>Math.PI;)l-=Math.PI*2;for(;l<-Math.PI;)l+=Math.PI*2;return l}let mt=!1,ft=0;const di=.5;let Jt=new a.Vector3,vt=new a.Vector3,Ut=new a.Quaternion,_t=new a.Quaternion,lt="third-person",jt=0;const fe=.2;let ge=!1,be=!1,It=!1,At=!1,pt=null,Xt=!1,j=null;function ui(){var i,s;U=new a.Scene;const l=((i=h==null?void 0:h.scene)==null?void 0:i.backgroundColor)||"#a8def0";U.background=new a.Color(l);const t=(h==null?void 0:h.camera)||{};v=new a.PerspectiveCamera(t.fov||60,window.innerWidth/window.innerHeight,t.near||.1,t.far||1e3),v.position.set(0,5,10),D=new a.WebGLRenderer({antialias:!1,powerPreference:"high-performance"}),D.setSize(window.innerWidth,window.innerHeight),D.setPixelRatio(F?1:Math.min(window.devicePixelRatio,2)),D.shadowMap.enabled=!0,D.shadowMap.type=a.PCFSoftShadowMap,document.body.appendChild(D.domElement),tt=new ke({renderer:D,maxStdDev:Math.sqrt(F?5:7),minPixelRadius:F?.5:.3,maxPixelRadius:F?256:384,minAlpha:F?1/255:.7/255,clipXY:F?1.6:2,falloff:F?.8:.95}),U.add(tt),F&&(tt.defaultView.sortDistance=.05,tt.defaultView.sortCoorient=.97,console.log("Mobile sorting optimizations applied")),Z=new a.Raycaster,fi();const e=((s=h==null?void 0:h.camera)==null?void 0:s.orbitControls)||{};C=new Fe(v,D.domElement),C.enableDamping=e.enableDamping!==void 0?e.enableDamping:!0,C.minDistance=e.minDistance||1,C.maxDistance=e.maxDistance||5,C.enablePan=e.enablePan!==void 0?e.enablePan:!1,C.maxPolarAngle=Math.PI*(e.maxPolarAngle||.55),C.update(),F&&(H=new Ge(Et,C),H.setFirstPersonCallback(Li),H.setPaintCallback(ki),H.setPaintEndCallback(Pi),console.log("Touch controls initialized early (before character load)")),console.log("Scene initialized")}function fi(){var r,c;const l=((r=h==null?void 0:h.lighting)==null?void 0:r.ambient)||{};U.add(new a.AmbientLight(l.color||16777215,l.intensity!==void 0?l.intensity:.7));const t=((c=h==null?void 0:h.lighting)==null?void 0:c.directional)||{};K=new a.DirectionalLight(t.color||16777215,t.intensity!==void 0?t.intensity:1),K.castShadow=t.castShadow!==void 0?t.castShadow:!0;const e=t.shadowCamera||{};K.shadow.camera.top=e.top||50,K.shadow.camera.bottom=e.bottom||-50,K.shadow.camera.left=e.left||-50,K.shadow.camera.right=e.right||50,K.shadow.camera.near=e.near||.1,K.shadow.camera.far=e.far||200;const i=t.shadowMapSize,s=typeof i=="number"?i:2048,o=(i==null?void 0:i.width)||s,n=(i==null?void 0:i.height)||s;K.shadow.mapSize.width=o,K.shadow.mapSize.height=n,U.add(K),Wt()}function gi(){var e;const l=new xe,t=((e=h==null?void 0:h.assets)==null?void 0:e.collisionFile)||"models/StoneHenge-collision.glb";l.load(t,i=>{var st,$,Lt,ce;let s;if(i.scene.traverse(N=>{N instanceof a.Mesh&&!s&&(s=N)}),!s){console.error("No mesh found in collision GLB file");return}const o=s,n=new a.MeshStandardMaterial({color:8421504,roughness:.8,metalness:.2,side:a.DoubleSide}),r=o.geometry;S=new a.Mesh(r,n),S.position.copy(o.position),S.rotation.copy(o.rotation),S.scale.copy(o.scale),S.applyMatrix4(i.scene.matrix),S.scale.multiplyScalar(ut),S.rotation.x+=zt*(Math.PI/180),S.rotation.y+=Gt*(Math.PI/180),S.rotation.z+=Vt*(Math.PI/180),S.position.y=0,S.receiveShadow=!0,S.castShadow=!0,S.visible=!1,U.add(S);try{r.boundingBox||r.computeBoundingBox();const N=r.boundingBox.clone();N.min.multiplyScalar(ut),N.max.multiplyScalar(ut);const Bt=new a.Vector3(N.min.x,-N.max.y,N.min.z),Rt=new a.Vector3(N.max.x,-N.min.y,N.max.z);ct=Rt.y,console.log(`[Collision Mesh] World bounding box (at Y=0): min.y=${Bt.y.toFixed(2)}, max.y=${Rt.y.toFixed(2)}`),console.log(`[Collision Mesh] maxTerrainHeight = ${ct.toFixed(2)} (highest walkable point after all transforms)`),nt=Bt.y<0?-Bt.y:0,at=Rt.y>0?-Rt.y:0,console.log(`[Height Offset Bounds] Calculated from worldBBox: min.y=${Bt.y.toFixed(2)}, max.y=${Rt.y.toFixed(2)}`),console.log(`[Height Offset Bounds] Range: ${at.toFixed(2)} to ${nt.toFixed(2)} (scaled units)`)}catch(N){console.error("[Collision Mesh] Failed to calculate bounds:",N),ct=100,nt=0,at=-100}ot==="max"?(V=nt,console.log(`[Height Offset] Resolved "max" to ${V.toFixed(2)}`)):ot==="min"&&(V=at,console.log(`[Height Offset] Resolved "min" to ${V.toFixed(2)}`)),Vi(),S.position.y=V;const c=new a.PlaneGeometry(1e4,1e4),d=new a.TextureLoader,u=(($=(st=h==null?void 0:h.assets)==null?void 0:st.textures)==null?void 0:$.floor)||{},f=d.load(u.color||"textures/sand/Sand 002_COLOR.jpg"),m=d.load(u.normal||"textures/sand/Sand 002_NRM.jpg"),y=d.load(u.displacement||"textures/sand/Sand 002_DISP.jpg"),k=d.load(u.ao||"textures/sand/Sand 002_OCC.jpg"),w=1e3;[f,m,y,k].forEach(N=>{N.wrapS=a.RepeatWrapping,N.wrapT=a.RepeatWrapping,N.repeat.set(w,w)});const P=new a.MeshStandardMaterial({map:f,normalMap:m,displacementMap:y,displacementScale:0,aoMap:k,aoMapIntensity:1,roughness:.9,metalness:0,side:a.DoubleSide});X=new a.Mesh(c,P),X.rotation.x=-Math.PI/2,X.position.y=0,X.receiveShadow=!0,X.visible=((ce=(Lt=h==null?void 0:h.scene)==null?void 0:Lt.infiniteFloor)==null?void 0:ce.visible)!==!1,U.add(X);const B=new a.WireframeGeometry(r),I=new a.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.8});j=new a.LineSegments(B,I),j.position.copy(S.position),j.rotation.copy(S.rotation),j.scale.copy(S.scale),j.visible=!1,U.add(j),console.log("Collision mesh loaded successfully (invisible, use for physics only)"),console.log("Press G to toggle collision wireframe, H to toggle Gaussian splat, R to reset Magic effect, F to toggle infinite floor, L to toggle leveling controls"),console.log("Press M to toggle background music, N to toggle movement sounds"),wt(),It=!0;const E=document.getElementById("collision-progress-bar"),O=document.getElementById("collision-progress-text"),A=document.getElementById("start-collision-bar"),W=document.getElementById("start-collision-text");E&&O&&(E.style.width="100%",O.textContent="100%"),A&&W&&(A.style.width="100%",W.textContent="100%"),re(),pi(),xi()},i=>{const s=i.total>0?Math.min(100,Math.round(i.loaded/i.total*100)):0;console.log("Collision mesh: "+s+"% loaded");const o=document.getElementById("collision-progress-bar"),n=document.getElementById("collision-progress-text"),r=document.getElementById("start-collision-bar"),c=document.getElementById("start-collision-text");o&&n&&(o.style.width=s+"%",n.textContent=s+"%"),r&&c&&(r.style.width=s+"%",c.textContent=s+"%")},i=>{console.error("Error loading collision mesh:",i)})}function wt(){const l=zt*(Math.PI/180),t=Gt*(Math.PI/180),e=Vt*(Math.PI/180),i=Tt*(Math.PI/180),s=Dt*(Math.PI/180),o=V;S&&(S.position.y=o,S.rotation.x=l,S.rotation.y=t,S.rotation.z=e,S.rotation.x+=i,S.rotation.z+=s),g&&(g.position.y=o,g.rotation.x=l,g.rotation.y=t,g.rotation.z=e,g.rotation.x+=i,g.rotation.z+=s),j&&(j.position.y=o,j.rotation.x=l,j.rotation.y=t,j.rotation.z=e,j.rotation.x+=i,j.rotation.z+=s),console.log(`Leveling applied: X=${Tt.toFixed(1)}Â°, Z=${Dt.toFixed(1)}Â°, Height=${V.toFixed(2)}`)}function Wt(){if(!K)return;const l=Pt*Math.PI/180,t=Ct*Math.PI/180,e=100,i=e*Math.cos(t)*Math.sin(l),s=e*Math.sin(t),o=e*Math.cos(t)*Math.cos(l);K.position.set(i,s,o),console.log(`Light orientation: Azimuth=${Pt}Â°, Elevation=${Ct}Â°, Position=(${i.toFixed(1)}, ${s.toFixed(1)}, ${o.toFixed(1)})`)}function mi(){var i;const l=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},t=l.expansionRadius??ee,e=l.duration||2;return console.log(`Creating magic modifier: radius=${t.toFixed(1)}, duration=${e.toFixed(1)}s ${l.expansionRadius?"(from config)":"(auto-calculated)"}`),T.dynoBlock({gsplat:T.Gsplat},{gsplat:T.Gsplat},({gsplat:s})=>(s=new T.Dyno({inTypes:{gsplat:T.Gsplat,t:"float"},outTypes:{gsplat:T.Gsplat},globals:()=>[T.unindent(`
            // Pseudo-random hash function for noise generation
            vec3 hash(vec3 p) {
              p = fract(p * 0.3183099 + 0.1);
              p *= 17.0;
              return fract(vec3(p.x * p.y * p.z, p.x + p.y * p.z, p.x * p.y + p.z));
            }

            // 3D Perlin-style noise function
            vec3 noise(vec3 p) {
              vec3 i = floor(p);
              vec3 f = fract(p);
              f = f * f * (3.0 - 2.0 * f);

              vec3 n000 = hash(i + vec3(0,0,0));
              vec3 n100 = hash(i + vec3(1,0,0));
              vec3 n010 = hash(i + vec3(0,1,0));
              vec3 n110 = hash(i + vec3(1,1,0));
              vec3 n001 = hash(i + vec3(0,0,1));
              vec3 n101 = hash(i + vec3(1,0,1));
              vec3 n011 = hash(i + vec3(0,1,1));
              vec3 n111 = hash(i + vec3(1,1,1));

              vec3 x0 = mix(n000, n100, f.x);
              vec3 x1 = mix(n010, n110, f.x);
              vec3 x2 = mix(n001, n101, f.x);
              vec3 x3 = mix(n011, n111, f.x);

              vec3 y0 = mix(x0, x1, f.y);
              vec3 y1 = mix(x2, x3, f.y);

              return mix(y0, y1, f.z);
            }
          `)],statements:({inputs:n,outputs:r})=>T.unindentLines(`
          ${r.gsplat} = ${n.gsplat};
          float t = ${n.t};
          float s = smoothstep(0., ${e.toFixed(1)}, t) * ${t.toFixed(1)};
          vec3 scales = ${n.gsplat}.scales;
          vec3 localPos = ${n.gsplat}.center;
          float l = length(localPos.xz);

          // Magic Effect: Complex twister with noise and radial reveal (${t} unit radius in ${e} seconds)
          float border = abs(s-l-.5);
          localPos *= 1.-.2*exp(-20.*border);
          vec3 finalScales = mix(scales,vec3(0.002),smoothstep(s-.5,s,l+.5));
          ${r.gsplat}.center = localPos + .1*noise(localPos.xyz*2.+t*.5)*smoothstep(s-.5,s,l+.5);
          ${r.gsplat}.scales = finalScales;
          float at = atan(localPos.x,localPos.z)/3.1416;
          ${r.gsplat}.rgba *= step(at,t-3.1416);
          ${r.gsplat}.rgba += exp(-20.*border) + exp(-50.*abs(t-at-3.1416))*.5;
        `)}).apply({gsplat:s,t:Kt}).gsplat,{gsplat:s}))}async function pi(){var l,t,e,i;console.log("Loading Gaussian splat...");try{const s=document.getElementById("splat-progress-bar"),o=document.getElementById("splat-progress-text"),n=document.getElementById("start-splat-bar"),r=document.getElementById("start-splat-text");s&&o&&(s.style.width="10%",o.textContent="10%"),n&&r&&(n.style.width="10%",r.textContent="10%");const c=((l=h==null?void 0:h.assets)==null?void 0:l.splatFile)||"models/StoneHenge.sog";g=new Pe({url:c}),console.log("SplatMesh created, waiting for initialization..."),s&&o&&(s.style.width="50%",o.textContent="50%"),n&&r&&(n.style.width="50%",r.textContent="50%"),await g.initialized,console.log("SplatMesh initialized successfully");const d=g.getBoundingBox(!1),u=new a.Vector3;d.getSize(u);const f=Math.max(u.x,u.y,u.z),m=u.length()/2;console.log("Splat bounding box (local space):"),console.log("  min:",d.min),console.log("  max:",d.max),console.log("  extent:",u),console.log("  max dimension:",f.toFixed(2)),console.log("  radius (center to corner):",m.toFixed(2));const y=m*ut*1.5,k=((t=h==null?void 0:h.camera)==null?void 0:t.far)||1e3,w=Math.max(y,k);v&&(v.far=w,v.updateProjectionMatrix(),console.log(`Camera far plane: config=${k}, auto=${y.toFixed(0)}, using=${w.toFixed(0)}`)),ee=Math.sqrt(u.x*u.x+u.z*u.z)/2*1.1,console.log(`Magic effect expansion radius: auto=${ee.toFixed(1)} (in splat space)`);const B=(e=h==null?void 0:h.character)==null?void 0:e.maxHeight;if(console.log(`[Height Cap Config] configMaxHeight="${B}", maxTerrainHeight=${ct.toFixed(2)}, heightOffset=${V.toFixed(2)}`),B==="auto"){const $=ct+V;_=$*2,console.log(`[Height Cap] Set to ${_.toFixed(2)} (auto: 2Ã— actual terrain height ${$.toFixed(2)} = 2Ã— (${ct.toFixed(2)} + ${V.toFixed(2)}))`)}else if(typeof B=="number")B<0?(_=null,console.log(`[Height Cap] Set to NONE (unlimited) - config value: ${B}`)):(_=B,console.log(`[Height Cap] Set to ${_.toFixed(2)} (absolute from config)`));else{const $=ct+V;_=$*2,console.log(`[Height Cap] Set to ${_.toFixed(2)} (default auto: 2Ã— actual terrain height ${$.toFixed(2)} = 2Ã— (${ct.toFixed(2)} + ${V.toFixed(2)}))`)}console.log(`[Height Cap Final] maxCharacterHeight = ${_===null?"null (unlimited)":_.toFixed(2)}`),b&&(b.maxHeight=_,console.log(`[Height Cap] Updated existing CharacterControls.maxHeight to ${_===null?"null (unlimited)":_.toFixed(2)}`)),s&&o&&(s.style.width="100%",o.textContent="100%"),n&&r&&(n.style.width="100%",r.textContent="100%"),g.scale.multiplyScalar(ut),g.rotation.x+=zt*(Math.PI/180),g.rotation.y+=Gt*(Math.PI/180),g.rotation.z+=Vt*(Math.PI/180),g.position.y=V,tt.add(g),g.visible=!1,wt(),At=!0,L&&(L.gaussianSplat=g,console.log("Gaussian splat reference set in XRManager"));const I=30,E=20,O=50,A=F?E:I;window.lodTargetFPS={desktop:I,mobile:E,vr:O,initial:A},console.log("LOD target FPS stored, will initialize after splat loads");const W=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},st=W.enabled!==!1&&(!F||W.mobileEnabled===!0);if(console.log("Magic effect config check:",{enabled:W.enabled,mobileEnabled:W.mobileEnabled,isMobile:F,shouldEnableEffect:st}),st)try{g.objectModifier=mi(),g.updateGenerator(),console.log(`Gaussian splat loaded with Magic effect (${F?"mobile":"desktop"}) - awaiting user interaction`),console.log("Magic effect modifier attached:",!!g.objectModifier)}catch($){console.error("Error applying Magic effect modifier:",$),console.log("Gaussian splat loaded without Magic effect (shader compilation failed)")}else console.log(`Gaussian splat loaded without Magic effect (${F?"mobile not enabled in config":"disabled in config"})`);try{const $=F?2:0,Lt=m*ut*2;console.log(`[LOD] World extent for culling: ${Lt.toFixed(2)} units`),R=new si(g,v,D,window.lodTargetFPS.initial,$,Lt,tt),R.desktopTargetFPS=window.lodTargetFPS.desktop,R.mobileTargetFPS=window.lodTargetFPS.mobile,R.vrTargetFPS=window.lodTargetFPS.vr,console.log("Distance-based LOD system initialized (standalone, no brush)")}catch($){console.error("Error initializing LOD system:",$)}re()}catch(s){console.error("Error loading Gaussian splat:",s)}}async function re(){if(Xt)return;const l=document.getElementById("start-loading-bars"),t=document.getElementById("start-button");l&&(It&&At?(Xt=!0,pt&&(clearTimeout(pt),pt=null),console.log("All assets loaded, showing buttons..."),setTimeout(async()=>{l.style.display="none",t&&(t.style.display="inline-block"),console.log("Assets loaded, start button shown")},500)):pt||(console.log("Assets not fully loaded, setting fallback timeout..."),pt=setTimeout(async()=>{It&&At&&!Xt?(Xt=!0,console.log("Loading timeout: assets confirmed loaded, showing buttons"),l.style.display="none",t&&(t.style.display="inline-block")):(!It||!At)&&(console.warn("Loading timeout: assets STILL not loaded, waiting longer..."),pt=null,setTimeout(()=>re(),2e3))},1e4)))}function yi(){var l;if(ge){console.log("Magic reveal already started");return}if(ge=!0,g&&(g.visible=!0),g&&g.objectModifier?(qt=0,Kt.value=0,console.log("Magic reveal animation started by user interaction")):console.log("Gaussian splat not ready for animation, skipping magic effect"),G&&(G.startBackgroundMusic(),console.log("Background music started")),G){const e=(((l=h==null?void 0:h.scene)==null?void 0:l.magicEffect)||{}).soundDelay||0;G.playMagicReveal(e),console.log(`Magic reveal sound will play in ${e}s`)}}function xi(){var e;const l=new xe,t=((e=h==null?void 0:h.assets)==null?void 0:e.characterFile)||"models/Soldier.glb";l.load(t,i=>{var B,I,E,O;const s=i.scene;s.traverse(A=>{A.isMesh&&(A.castShadow=!0)}),U.add(s);const o=i.animations,n=new a.AnimationMixer(s),r=new Map;o.forEach(A=>{r.set(A.name,n.clipAction(A))});const c=((B=h==null?void 0:h.camera)==null?void 0:B.offsetFromCharacter)||{x:0,y:2,z:5},d=((E=(I=h==null?void 0:h.camera)==null?void 0:I.targetOffset)==null?void 0:E.y)||1;b=new Ie(s,n,r,C,v,"Idle",[S,X],_,d);const u=((O=h==null?void 0:h.character)==null?void 0:O.spawn)||{},f=u.position||{x:0,y:"auto",z:40},m=u.rotation||{y:0};s.position.x=f.x,s.position.z=f.z,s.rotation.y=m.y*(Math.PI/180),f.y==="auto"?(s.position.y=1e3,console.log(`Auto-detecting ground height at spawn position (${f.x}, ${f.z})...`),b.placeOnGround()):(s.position.y=f.y,console.log(`Character spawned at specified position (${f.x}, ${f.y}, ${f.z})`));const k=new a.Vector3(c.x,c.y,c.z).clone().applyQuaternion(s.quaternion);v.position.set(s.position.x+k.x,s.position.y+k.y,s.position.z+k.z);const P=new a.Vector3(0,d,0).clone().applyQuaternion(s.quaternion);C.target.set(s.position.x+P.x,s.position.y+P.y,s.position.z+P.z),C.syncFromCamera(),C.update(),console.log("Character loaded successfully at position:",s.position),console.log("Camera positioned at:",v.position),console.log("Character facing east (rotation Y:",s.rotation.y,")"),console.log("Available animations:",Array.from(r.keys())),F&&(b.toggleRun=!0,console.log("Mobile: run mode enabled by default")),bi()},i=>{console.log(i.loaded/i.total*100+"% loaded")},i=>{console.error("Error loading character:",i)})}function bi(){L=new Je(D,v,U,h),q=new Ue(D,U,L),q.setGroundMeshes([S,X]),Ft=new We(D,U,b==null?void 0:b.model),rt=new ei(U,Ft),z=new ti(Ft,L,rt),Y=new ii(U),z.callbacks.onPaintStart=(l,t,e)=>{console.log(`Gesture paint start (${l})`),g&&(x.brushOrigin.value.copy(t),x.brushDirection.value.copy(e),x.enabled.value=!0),Y&&Y.updatePaintRay(l,t,e,!0)},z.callbacks.onPaintDrag=(l,t,e)=>{if(!g)return;x.brushOrigin.value.copy(t),x.brushDirection.value.copy(e),x.enabled.value=!0;const i=rt?rt.getSelectedColor():{hex:8913151},s=new a.Color(i.hex).convertLinearToSRGB();x.brushColor.value.x=s.r,x.brushColor.value.y=s.g,x.brushColor.value.z=s.b;const n=new a.Raycaster(t,e).intersectObjects([S,X],!0);n.length>0?(x.useSurface.value=!0,x.surfacePoint.value.copy(n[0].point)):x.useSurface.value=!1;const r=!g.splatRgba;g.splatRgba=tt.getRgba({generator:g,rgba:g.splatRgba}),r?g.updateGenerator():g.updateVersion(),Y&&Y.updatePaintRay(l,t,e,!0)},z.callbacks.onPaintEnd=l=>{console.log(`Gesture paint end (${l})`),x.enabled.value=!1,Y&&Y.updatePaintRay(l,null,null,!1)},z.callbacks.onMovementStart=(l,t)=>{console.log(`Movement gesture started: speed=${t.toFixed(2)}`),St=l.clone(),kt=t},z.callbacks.onMovementUpdate=(l,t)=>{St=l.clone(),kt=t},z.callbacks.onMovementEnd=()=>{console.log("Movement gesture ended"),St=null,kt=0},z.callbacks.onJetpackStart=l=>{console.log(`Jetpack gesture started (${l})`),b&&b.activateJetpack()},z.callbacks.onJetpackEnd=l=>{console.log(`Jetpack gesture ended (${l})`),b&&b.deactivateJetpack()},z.callbacks.onColorSelect=(l,t)=>{if(rt){const e=rt.checkHover(l,t);e!==null&&(rt.selectColor(e),z.selectedColorIndex=e,console.log(`Color selected: index ${e}`))}},z.callbacks.onTeleportStart=(l,t)=>{if(console.log("Teleport started (LEFT hand)"),L){const i=new a.Raycaster(l,t).intersectObjects([S,X],!0);i.length>0?L.updateTeleportTarget(i[0].point):L.updateTeleportTarget(null)}},z.callbacks.onTeleportUpdate=(l,t)=>{if(L){const i=new a.Raycaster(l,t).intersectObjects([S,X],!0);i.length>0?L.updateTeleportTarget(i[0].point):L.updateTeleportTarget(null)}},z.callbacks.onTeleportEnd=(l,t)=>{console.log("Teleport executed (LEFT hand released)"),L&&L.executeTeleport()},z.callbacks.onTogglePaintMode=l=>{console.log(`Paint mode toggled via gesture: ${l?"ON":"OFF"}`),q&&(q.isPaintMode=l),g&&(x.enabled.value=l)},L.characterControls=b,L.orbitControls=C,L.xrControllers=q,L.xrHands=Ft,L.gestureDetector=z,console.log("WebXR system initialized with gesture detection")}function vi(){var t,e;const l=((e=(t=h==null?void 0:h.assets)==null?void 0:t.audio)==null?void 0:e.jetpack)||"sounds/thrusters_loopwav-14699.mp3";G=new Xe({backgroundMusic:"sounds/happy-relaxing-loop-275536.mp3",walkingSound:"sounds/walking-on-gravel-version-2-308744.mp3",runningSound:"sounds/running-on-gravel-301880.mp3",jetpackSound:l,magicReveal:"sounds/a-magical-intro-395716.mp3"},F),console.log("Audio system initialized - will start on user clicking start button")}function wi(){const l=document.getElementById("camera-icon-3rd"),t=document.getElementById("camera-icon-1st");it==="first-person"?(l&&(l.style.display="none"),t&&(t.style.display="block")):(l&&(l.style.display="block"),t&&(t.style.display="none"))}function ne(){var l,t,e;if(!b){console.log("Character not loaded yet");return}if(!mt)if(it==="third-person"){const i=b.model,s=new a.Euler;s.setFromQuaternion(i.quaternion,"YXZ"),Q=ae(s.y),et=0,Jt.copy(v.position),Ut.copy(v.quaternion),vt.set(i.position.x,i.position.y+b.firstPersonHeadHeight,i.position.z),v.rotation.order="YXZ";const o=new a.Euler(et,Q,0,"YXZ");_t.setFromEuler(o),mt=!0,ft=0,lt="first-person",console.log("Starting transition to first-person mode")}else{const i=b.model;if(i){const s=((l=h==null?void 0:h.camera)==null?void 0:l.offsetFromCharacter)||{x:0,y:2,z:5},o=((e=(t=h==null?void 0:h.camera)==null?void 0:t.targetOffset)==null?void 0:e.y)||1,n=Q,r=new a.Quaternion;r.setFromAxisAngle(new a.Vector3(0,1,0),n),i.quaternion.copy(r);const d=new a.Vector3(s.x,s.y,s.z).clone().applyQuaternion(i.quaternion);Jt.copy(v.position),Ut.copy(v.quaternion),vt.set(i.position.x+d.x,i.position.y+d.y,i.position.z+d.z);const f=new a.Vector3(0,o,0).clone().applyQuaternion(r);C.target.set(i.position.x+f.x,i.position.y+f.y,i.position.z+f.z);const m=vt.distanceTo(C.target);console.log("Transition target distance:",m.toFixed(3)),console.log("WorldOffset:",d),console.log("TargetOffsetY:",o),mt=!0,ft=0,lt="third-person",console.log("Starting transition to third-person mode"),console.log("Start pos:",Jt),console.log("Start quat:",Ut),console.log("Target pos (OrbitControls final):",vt),console.log("Target quat (OrbitControls final):",_t)}}}function Mi(){const l=document.getElementById("camera-toggle-button");l&&(l.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ne()}),F&&l.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),ne()},{passive:!1}),console.log("Camera toggle button initialized"))}function Si(){const l=document.getElementById("paint-toggle-button");l&&F&&(l.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),me()}),l.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),me()},{passive:!1}),console.log("Paint toggle button initialized"))}function me(){J=!J;const l=document.getElementById("paint-toggle-button");l&&(J?l.classList.add("active"):l.classList.remove("active")),H&&H.setPaintMode(J),console.log(`Mobile paint mode: ${J?"ON":"OFF"}`)}function ki(l,t){if(!J||!g||!Z)return;const e=new a.Vector3(1,0,1),i=D.domElement.getBoundingClientRect(),s=new a.Vector2;s.x=(l-i.left)/i.width*2-1,s.y=-((t-i.top)/i.height)*2+1,Z.setFromCamera(s,v),x.brushOrigin.value.copy(Z.ray.origin),x.brushDirection.value.copy(Z.ray.direction),x.brushColor.value.copy(e);const o=Z.intersectObjects([S,X],!0);o.length>0?(x.useSurface.value=!0,x.surfacePoint.value.copy(o[0].point)):x.useSurface.value=!1,x.enabled.value=!0;const n=!g.splatRgba;g.splatRgba=tt.getRgba({generator:g,rgba:g.splatRgba}),n?g.updateGenerator():g.updateVersion()}function Pi(){x&&x.enabled&&(x.enabled.value=!1)}function Ci(){const l=document.getElementById("jump-jetpack-button");if(l&&F){let t=null;const e=400;l.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),Et[" "]=!0,setTimeout(()=>{(!H||!H.jetpackActive)&&(Et[" "]=!1)},50),t=setTimeout(()=>{H&&(H.activateJetpack(),l.classList.add("jetpack-active"))},e)},{passive:!1}),l.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),t&&(clearTimeout(t),t=null),H&&H.jetpackActive&&(H.deactivateJetpack(),l.classList.remove("jetpack-active"))},{passive:!1}),l.addEventListener("touchcancel",i=>{t&&(clearTimeout(t),t=null),H&&H.jetpackActive&&(H.deactivateJetpack(),l.classList.remove("jetpack-active"))},{passive:!1}),console.log("Jump/jetpack button initialized")}}function Ti(l){it==="first-person"&&oe&&(Q-=l.movementX*de,Q=ae(Q),et-=l.movementY*de,et=Math.max(-Yt,Math.min(Yt,et)),b&&b.setFirstPersonRotation(et,Q))}function Di(){oe=document.pointerLockElement===D.domElement,console.log(`Pointer lock: ${oe?"LOCKED":"UNLOCKED"}`)}function Ei(){console.error("Pointer lock failed")}function ve(){it==="first-person"&&!F&&!J&&D.domElement.requestPointerLock()}function we(){document.pointerLockElement===D.domElement&&document.exitPointerLock()}function Li(l,t){it==="first-person"&&(Q-=l*ue,Q=ae(Q),et-=t*ue,et=Math.max(-Yt,Math.min(Yt,et)),b&&b.setFirstPersonRotation(et,Q))}function Ri(){J=!J,x.enabled.value=J,g&&(g.needsUpdate=!0);const l=document.getElementById("paint-controls");l&&(J?l.classList.add("visible"):l.classList.remove("visible")),J?D.domElement.classList.add("paint-mode"):D.domElement.classList.remove("paint-mode"),J?(we(),it==="third-person"&&(C.enabled=!1),console.log("Paint mode: ON - LEFT-click drag or CTRL+move to paint, camera rotation disabled")):(it==="first-person"?ve():it==="third-person"&&(C.enabled=!0),console.log("Paint mode: OFF"))}function pe(l){const t=x.brushRadius.value,e=Math.max(ri,Math.min(li,t+l));x.brushRadius.value=e,console.log(`Brush radius: ${e.toFixed(3)}`),le()}function ye(l){const t=x.brushDepth.value,e=Math.max(ci,Math.min(hi,t+l));x.brushDepth.value=e,console.log(`Brush depth: ${e.toFixed(1)}`),le()}function le(){const l=document.getElementById("brush-size-display");l&&(l.textContent=`Radius: ${x.brushRadius.value.toFixed(3)} | Depth: ${x.brushDepth.value.toFixed(1)}`)}function Fi(){const l=document.getElementById("color-picker");l&&(l.addEventListener("input",t=>{const e=t.target.value,i=new a.Color(e).convertLinearToSRGB();x.brushColor.value.x=i.r,x.brushColor.value.y=i.g,x.brushColor.value.z=i.b,console.log(`Brush color changed to: ${e}`,i)}),console.log("Color picker initialized")),le()}function Oi(){D.domElement.addEventListener("pointermove",l=>{if(!J||!g||!Z)return;const t=new a.Vector2(l.clientX/window.innerWidth*2-1,-(l.clientY/window.innerHeight)*2+1);Z.setFromCamera(t,v);const e=Z.ray.direction.normalize();if(x.brushDirection.value.x=e.x,x.brushDirection.value.y=e.y,x.brushDirection.value.z=e.z,x.brushOrigin.value.x=Z.ray.origin.x,x.brushOrigin.value.y=Z.ray.origin.y,x.brushOrigin.value.z=Z.ray.origin.z,S){const i=Z.intersectObject(S,!1);if(i.length>0){const s=i[0].point;x.useSurface.value=!0,x.surfacePoint.value.x=s.x,x.surfacePoint.value.y=s.y,x.surfacePoint.value.z=s.z}else x.useSurface.value=!1}else x.useSurface.value=!1;if(g&&(g.needsUpdate=!0),(Qt||ie)&&g){const i=!g.splatRgba;g.splatRgba=tt.getRgba({generator:g,rgba:g.splatRgba}),i?g.updateGenerator():g.updateVersion()}}),D.domElement.addEventListener("pointerdown",l=>{if(!J||!g||l.button!==0)return;l.preventDefault(),Qt=!0;const t=!g.splatRgba;g.splatRgba=tt.getRgba({generator:g,rgba:g.splatRgba}),t?g.updateGenerator():g.updateVersion()}),D.domElement.addEventListener("pointerup",l=>{!J||l.button!==0||(Qt=!1)}),console.log("Paint controls initialized")}function Ii(){let l=!1;const t=()=>{!l&&G&&(G.startBackgroundMusic(),l=!0,console.log("Background music started on touch interaction (fallback)"),document.removeEventListener("touchstart",t))};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",e=>{var s;const i=e.key.toLowerCase();if(e.key==="Control"&&(ie=!0),Et[i]=!0,se.down(i),!l&&G&&(G.startBackgroundMusic(),l=!0,console.log("Background music started on keyboard interaction (fallback)")),i==="shift"&&b&&b.switchRunToggle(),i==="g"&&j&&(j.visible=!j.visible,console.log(`Collision mesh wireframe: ${j.visible?"ON":"OFF"}`)),i==="h"&&g&&(g.visible=!g.visible,console.log(`Gaussian splat: ${g.visible?"ON":"OFF"}`)),i==="r"&&g){if(qt=0,Kt.value=0,G){const n=(((s=h==null?void 0:h.scene)==null?void 0:s.magicEffect)||{}).soundDelay||0;G.playMagicReveal(n)}console.log("Magic effect reset")}if(i==="f"&&X&&(X.visible=!X.visible,console.log(`Infinite floor: ${X.visible?"ON":"OFF"}`)),i==="l"){const o=document.getElementById("leveling-controls");if(o){o.classList.toggle("visible");const n=o.classList.contains("visible");console.log(`Leveling controls: ${n?"ON":"OFF"}`)}}i==="m"&&G&&G.toggleBackgroundMusic(),i==="n"&&G&&G.toggleMovementSounds(),i==="v"&&ne(),i==="p"&&Ri(),i==="q"&&(R?(console.log("[Main] Q pressed - increasing LOD quality"),R.increaseLOD()):console.warn("[Main] Q pressed but distanceLOD not initialized yet")),i==="e"&&(R?(console.log("[Main] E pressed - decreasing LOD quality"),R.decreaseLOD()):console.warn("[Main] E pressed but distanceLOD not initialized yet")),i==="t"&&(R?(console.log("[Main] T pressed - resuming adaptive LOD"),R.resumeAdaptive()):console.warn("[Main] T pressed but distanceLOD not initialized yet")),(i==="="||i==="+")&&pe(.01),(i==="-"||i==="_")&&pe(-.01),i==="["&&ye(-1),i==="]"&&ye(1)}),document.addEventListener("keyup",e=>{const i=e.key.toLowerCase();e.key==="Control"&&(ie=!1),Et[i]=!1,se.up(i)}),console.log("Keyboard controls initialized")}async function Ai(){const l=document.getElementById("start-button"),t=document.getElementById("start-overlay"),e=i=>{if(i.preventDefault(),i.stopPropagation(),!It||!At){console.warn("Assets not fully loaded yet, cannot start experience"),alert("Please wait for assets to finish loading...");return}console.log("Start button triggered - entering experience"),be=!0,t.classList.remove("visible"),yi(),G&&G.unlockAudio().then(()=>{console.log("Audio unlocked successfully in background")}).catch(s=>{console.error("Audio unlock failed:",s)})};l&&(l.addEventListener("click",e),F&&l.addEventListener("touchstart",e,{passive:!1})),console.log("Start button initialized")}function zi(){v.aspect=window.innerWidth/window.innerHeight,v.updateProjectionMatrix(),D.setSize(window.innerWidth,window.innerHeight),se.updatePosition()}function Gi(){var e,i,s,o;const l=ai.getDelta();if(R){R.update(),he=R.getFPS();const n=document.getElementById("debug-fps");n&&(n.textContent=he);const r=document.getElementById("debug-quality");if(r){const d=R.getCurrentLODName(),u=R.isManualMode()?"MANUAL":"Auto";r.textContent=`${d} (${u})`}const c=document.getElementById("debug-decimation");if(c){const d=R.getCurrentLODLevel(),u=R.getLODConfigs();c.textContent=`${d}/${u.length-1}`}}if(g&&be&&(qt+=1/60,Kt.value=qt,g.updateVersion()),mt){if(ft+=l/di,lt==="third-person"){const c=v.position.distanceTo(C.target);console.log(`[Transition ${(ft*100).toFixed(1)}%] Pos: (${v.position.x.toFixed(3)}, ${v.position.y.toFixed(3)}, ${v.position.z.toFixed(3)}) Distance: ${c.toFixed(6)}`)}if(ft>=1){if(ft=1,v.position.copy(vt),lt==="first-person"?v.quaternion.copy(_t):v.lookAt(C.target),mt=!1,lt==="third-person"&&(jt=fe),it=lt,it==="first-person")C.enabled=!1,b.model&&(b.model.visible=!1,b.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1,c.material.transparent=!1)})),b.setCameraMode("first-person"),b.setFirstPersonRotation(et,Q),H&&H.setCameraMode("first-person"),ve(),console.log("Transition to first-person complete");else{b.model&&(b.model.visible=!0,b.model.traverse(f=>{f.isMesh&&f.material&&(f.material.opacity=1,f.material.transparent=!1)})),b.setCameraMode("third-person"),H&&H.setCameraMode("third-person"),we();const c=b.model,d=((i=(e=h==null?void 0:h.camera)==null?void 0:e.targetOffset)==null?void 0:i.y)||1;if(c){const m=new a.Vector3(0,d,0).clone().applyQuaternion(c.quaternion);C.target.set(c.position.x+m.x,c.position.y+m.y,c.position.z+m.z),console.log("Re-synced OrbitControls target to character position:",C.target)}C.enabled=!0,C.syncFromCamera(),C.update();const u=v.position.distanceTo(C.target);console.log("Transition to third-person complete"),console.log("Final camera pos:",v.position),console.log("Final distance to target:",u.toFixed(3)),console.log("OrbitControls target:",C.target)}wi()}const n=ft,r=n<.5?2*n*n:-1+(4-2*n)*n;v.position.lerpVectors(Jt,vt,r),lt==="first-person"?v.quaternion.slerpQuaternions(Ut,_t,r):v.lookAt(C.target),b&&b.model&&(lt==="first-person"?r<.7?(b.model.visible=!0,b.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1-r,c.material.transparent=!0)})):b.model.visible=!1:(b.model.visible=!0,b.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=r,c.material.transparent=!0)})))}const t=L&&L.getIsXRActive();if(R){const n=R.targetFPS===R.vrTargetFPS;if(t&&!n)R.setTargetFPS(R.vrTargetFPS);else if(!t&&n){const r=F?R.mobileTargetFPS:R.desktopTargetFPS;R.setTargetFPS(r)}}if(t){if(L.update(l,[S,X]),z){const n=D.xr.getSession();z.update(n,v.position)}if(rt&&rt.update(v.position),St&&kt>0&&L){const n=((s=h==null?void 0:h.controls)==null?void 0:s.walkSpeed)||1.5,r=((o=h==null?void 0:h.controls)==null?void 0:o.runSpeed)||3,c=n+(r-n)*kt,d=St.clone().multiplyScalar(c*l);L.updateReferenceSpaceByOffset(d),Y&&Y.updateMovementArrow(v.position,St,kt,!0)}else Y&&Y.hideMovementArrow();if(Y&&z)if(z.mode==="jetpack"||z.mode==="moving_jetpack"){const r=D.xr.getSession();if(r){for(const c of r.inputSources)if(c.hand&&c.handedness==="right"){const d=Ft.getJointPosition(c.hand,"wrist");d&&Y.updateJetpackGlow("right",d,!0);break}}}else Y.hideJetpackGlows();if(q&&q.isPaintMode&&g)for(let n=0;n<2;n++){const r=q.getRayForPainting(n);if(r){console.log(`VR Paint: controller ${n} painting - isDragging: ${q.isDragging}`),x.brushOrigin.value.copy(r.origin),x.brushDirection.value.copy(r.direction);const c=q.paletteColors[q.currentColorIndex],d=new a.Color(c.hex).convertLinearToSRGB();if(x.brushColor.value.x=d.r,x.brushColor.value.y=d.g,x.brushColor.value.z=d.b,x.enabled.value=!0,q.isDragging){console.log("VR Paint: Baking paint to texture");const u=!g.splatRgba;g.splatRgba=tt.getRgba({generator:g,rgba:g.splatRgba}),u?g.updateGenerator():g.updateVersion()}break}}else q&&!q.isPaintMode&&(x.enabled.value=!1);if(b){const n=document.getElementById("debug-state"),r=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist");if(n&&r&&c&&d){const u=L.isGrounded,f=L.jetpackActive;n.textContent=u?"GROUNDED":"IN AIR",n.className=u?"grounded":"in-air",r.textContent="VR Mode",c.textContent=f?"ACTIVE":"OFF",c.className=f?"jetpack-active":"",d.textContent="N/A (VR)"}}}else if(b){mt||b.update(l,Et);const n=document.getElementById("debug-state"),r=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist"),u=document.getElementById("debug-position");if(n&&r&&c&&d&&u){const f=b.getGroundedState(),m=b.getCurrentAction(),y=b.getJetpackActive(),k=b.getGroundDistance(),w=b.getPosition();n.textContent=f?"GROUNDED":"IN AIR",n.className=f?"grounded":"in-air",r.textContent=m,c.textContent=y?"ACTIVE":"OFF",c.className=y?"jetpack-active":"",d.textContent=k.toFixed(1)+"m",u.textContent=`(${w.x.toFixed(1)}|${w.y.toFixed(1)}|${w.z.toFixed(1)})`}if(G){const f=b.getMovementState();G.updateMovementSounds(f)}}if(G&&G.update(l),jt>0){jt-=l;const n=v.position.distanceTo(C.target);console.log(`[Post-transition ${((fe-jt)*1e3).toFixed(0)}ms] Pos: (${v.position.x.toFixed(3)}, ${v.position.y.toFixed(3)}, ${v.position.z.toFixed(3)}) Distance: ${n.toFixed(6)} OrbitEnabled: ${C.enabled}`)}!mt&&!t&&it==="third-person"&&C.update(),D.render(U,v)}function Vi(){const l=document.getElementById("level-height-slider"),t=document.getElementById("level-height-value");l&&t&&(l.min=at.toFixed(2),l.max=nt.toFixed(2),l.value=V.toString(),t.textContent=`${V.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`,console.log(`[UI] Height slider bounds updated: [${at.toFixed(2)} to ${nt.toFixed(2)}]`))}function Bi(){const l=document.getElementById("level-x-slider"),t=document.getElementById("level-z-slider"),e=document.getElementById("level-height-slider"),i=document.getElementById("light-azimuth-slider"),s=document.getElementById("light-elevation-slider"),o=document.getElementById("level-x-value"),n=document.getElementById("level-z-value"),r=document.getElementById("level-height-value"),c=document.getElementById("light-azimuth-value"),d=document.getElementById("light-elevation-value"),u=document.getElementById("leveling-reset");e&&r&&(e.value=V.toString(),r.textContent=`${V.toFixed(2)} [calculating...]`),l&&l.addEventListener("input",f=>{Tt=parseFloat(f.target.value),o.textContent=Tt.toFixed(1)+"Â°",wt()}),t&&t.addEventListener("input",f=>{Dt=parseFloat(f.target.value),n.textContent=Dt.toFixed(1)+"Â°",wt()}),e&&e.addEventListener("input",f=>{V=parseFloat(f.target.value),r.textContent=`${V.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`,wt()}),i&&i.addEventListener("input",f=>{Pt=parseFloat(f.target.value),c.textContent=Pt.toFixed(0)+"Â°",Wt()}),s&&s.addEventListener("input",f=>{Ct=parseFloat(f.target.value),d.textContent=Ct.toFixed(0)+"Â°",Wt()}),u&&u.addEventListener("click",()=>{var P,B,I,E,O,A,W,st;const f=((B=(P=h==null?void 0:h.transform)==null?void 0:P.defaultLeveling)==null?void 0:B.x)||0,m=((E=(I=h==null?void 0:h.transform)==null?void 0:I.defaultLeveling)==null?void 0:E.z)||0;let y=0;ot==="max"?y=nt:ot==="min"?y=at:typeof ot=="number"&&(y=ot),Tt=f,Dt=m,V=y,l.value=f,t.value=m,e.value=y,o.textContent=f.toFixed(1)+"Â°",n.textContent=m.toFixed(1)+"Â°",r.textContent=`${y.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`;const k=((A=(O=h==null?void 0:h.lighting)==null?void 0:O.directional)==null?void 0:A.azimuth)||213,w=((st=(W=h==null?void 0:h.lighting)==null?void 0:W.directional)==null?void 0:st.elevation)||37;Pt=k,Ct=w,i.value=k,s.value=w,c.textContent=k.toFixed(0)+"Â°",d.textContent=w.toFixed(0)+"Â°",wt(),Wt(),console.log("All controls reset to defaults")}),console.log("Leveling controls initialized")}async function Hi(){try{bt=await Ve();const l=te(bt),t=document.getElementById("scene-dropdown"),e=document.getElementById("start-scene-dropdown");t.innerHTML="",e&&(e.innerHTML=""),l.forEach(s=>{const o=document.createElement("option");if(o.value=s.id,o.textContent=s.name,t.appendChild(o),e){const n=document.createElement("option");n.value=s.id,n.textContent=s.name,e.appendChild(n)}});const i=$e(bt);t.value=i,e&&(e.value=i),t.addEventListener("change",async s=>{const o=s.target.value;o!==Mt&&(console.log(`Switching to scene: ${o}`),gt.navigateToSite(o))}),e&&e.addEventListener("change",async s=>{const o=s.target.value;if(o!==Mt){console.log(`Switching to scene: ${o}`),t.value=o;const r=te(bt).find(c=>c.id===o);if(r){const c=document.getElementById("start-title"),d=document.getElementById("start-description");c&&(c.textContent=r.name),d&&(d.textContent=r.description||"Prepare for an amazing journey")}gt.navigateToSite(o)}}),console.log("Scene selectors initialized")}catch(l){console.error("Failed to initialize scene selector:",l)}}function $i(){sessionStorage.setItem("currentScene",Mt),h.transform.scale!==void 0&&(ut=h.transform.scale,console.log("Applied scale from config:",ut)),h.transform.rotation&&(zt=h.transform.rotation.x!==void 0?h.transform.rotation.x:180,Gt=h.transform.rotation.y!==void 0?h.transform.rotation.y:0,Vt=h.transform.rotation.z!==void 0?h.transform.rotation.z:0,console.log("Applied rotation from config:",zt,Gt,Vt)),h.transform.defaultLeveling&&(Tt=h.transform.defaultLeveling.x||0,Dt=h.transform.defaultLeveling.z||0),h.transform.heightOffset!==void 0&&(ot=h.transform.heightOffset,typeof ot=="number"&&(V=ot),console.log(`[Config] heightOffset config value: ${ot}`)),h.lighting.directional&&(Pt=h.lighting.directional.azimuth,Ct=h.lighting.directional.elevation),console.log("Scene configuration applied to global state")}async function Ni(l){console.log("Initializing globe view...");const t=document.getElementById("start-overlay");t&&(t.classList.remove("visible"),t.style.display="none");const e=document.getElementById("globe-overlay");if(!e){console.error("Globe container not found");return}Zt=new ni(e,i=>{console.log("Site selected:",i),gt.navigateToSite(i)}),await Zt.init(l),Zt.show(),console.log("Globe view initialized successfully")}async function ji(){console.log("Initializing F1000..."),await Hi(),gt=new oi;const l=te(bt);if(gt.shouldShowGlobe(l)){console.log("No valid site parameter - showing globe"),await Ni(l);return}console.log("Valid site parameter found - loading site:",gt.getCurrentSiteId());let t=gt.getCurrentSiteId();const e=Ne(bt,t);h=await Be(e),Mt=t,$i();const i=document.getElementById("scene-dropdown");i&&(i.value=Mt);const s=document.getElementById("start-scene-dropdown");s&&(s.value=Mt);const o=document.getElementById("start-title"),n=document.getElementById("start-description");h&&o&&n&&(o.textContent=h.name||"Unknown Location",n.textContent=h.description||"Prepare for an amazing journey"),ui(),vi(),gi(),Ii(),Oi(),Fi(),Bi(),Ai(),Mi(),Si(),Ci(),window.addEventListener("resize",zi),document.addEventListener("mousemove",Ti),document.addEventListener("pointerlockchange",Di),document.addEventListener("pointerlockerror",Ei),D.setAnimationLoop(Gi),console.log("F1000 initialized successfully")}ji();
