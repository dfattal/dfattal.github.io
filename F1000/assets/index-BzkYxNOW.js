var Me=Object.defineProperty;var Se=(l,t,e)=>t in l?Me(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var m=(l,t,e)=>Se(l,typeof t!="symbol"?t+"":t,e);import*as a from"three";import{GLTFLoader as be}from"three/addons/loaders/GLTFLoader.js";import{dyno as x,SparkRenderer as ke,SplatMesh as Pe}from"@sparkjsdev/spark";import{VRButton as Ce}from"three/addons/webxr/VRButton.js";import{XRControllerModelFactory as Te}from"three/addons/webxr/XRControllerModelFactory.js";import{XRHandModelFactory as Ee}from"three/addons/webxr/XRHandModelFactory.js";import{OrbitControls as Re}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as Le,CSS2DObject as De}from"three/addons/renderers/CSS2DRenderer.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();class Fe{constructor(t,e){this.camera=t,this.domElement=e,this.target=new a.Vector3,this.yaw=0,this.pitch=0,this.distance=5,this.minDistance=1,this.maxDistance=10,this.enableDamping=!0,this.dampingFactor=.1,this.targetYaw=0,this.targetPitch=0,this.targetDistance=5,this.maxPolarAngle=Math.PI,this.minPolarAngle=0,this.enablePan=!1,this.enabled=!0,this.isRotating=!1,this.isZooming=!1,this.mouseStart=new a.Vector2,this.mouseCurrent=new a.Vector2,this.rotateSpeed=1,this.zoomSpeed=1,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onWheel=this.onWheel.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.domElement.addEventListener("mousedown",this.onMouseDown),this.domElement.addEventListener("wheel",this.onWheel),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.syncFromCamera()}syncFromCamera(){const t=new a.Vector3().subVectors(this.camera.position,this.target);this.distance=t.length(),this.targetDistance=this.distance;const e=Math.sqrt(t.x*t.x+t.z*t.z);this.yaw=Math.atan2(t.x,t.z),this.pitch=Math.atan2(e,t.y),this.targetYaw=this.yaw,this.targetPitch=this.pitch}rotateLeft(t){this.targetYaw+=t}rotateUp(t){this.targetPitch-=t,this.targetPitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this.targetPitch))}dolly(t){t<0?this.targetDistance/=Math.pow(.95,this.zoomSpeed):t>0&&(this.targetDistance*=Math.pow(.95,this.zoomSpeed)),this.targetDistance=Math.max(this.minDistance,Math.min(this.maxDistance,this.targetDistance))}onMouseDown(t){this.enabled&&t.button===0&&(this.isRotating=!0,this.mouseStart.set(t.clientX,t.clientY),this.mouseCurrent.set(t.clientX,t.clientY),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp))}onMouseMove(t){if(this.isRotating){this.mouseCurrent.set(t.clientX,t.clientY);const e=this.mouseCurrent.x-this.mouseStart.x,i=this.mouseCurrent.y-this.mouseStart.y,o=2*Math.PI*e/this.domElement.clientHeight*this.rotateSpeed,s=2*Math.PI*i/this.domElement.clientHeight*this.rotateSpeed;this.rotateLeft(-o),this.rotateUp(-s),this.mouseStart.copy(this.mouseCurrent)}}onMouseUp(t){t.button===0&&(this.isRotating=!1,document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp))}onWheel(t){this.enabled&&(t.preventDefault(),this.dolly(t.deltaY))}onContextMenu(t){t.preventDefault()}update(){this.enableDamping?(this.yaw+=(this.targetYaw-this.yaw)*this.dampingFactor,this.pitch+=(this.targetPitch-this.pitch)*this.dampingFactor,this.distance+=(this.targetDistance-this.distance)*this.dampingFactor):(this.yaw=this.targetYaw,this.pitch=this.targetPitch,this.distance=this.targetDistance);const t=new a.Vector3(this.distance*Math.sin(this.pitch)*Math.sin(this.yaw),this.distance*Math.cos(this.pitch),this.distance*Math.sin(this.pitch)*Math.cos(this.yaw));return this.camera.position.copy(this.target).add(t),this.camera.lookAt(this.target),!0}getAzimuthalAngle(){return this.yaw}getPolarAngle(){return this.pitch}dispose(){this.domElement.removeEventListener("mousedown",this.onMouseDown),this.domElement.removeEventListener("wheel",this.onWheel),this.domElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}reset(){this.yaw=0,this.pitch=Math.PI/4,this.distance=5,this.targetYaw=this.yaw,this.targetPitch=this.pitch,this.targetDistance=this.distance}saveState(){this.savedYaw=this.yaw,this.savedPitch=this.pitch,this.savedDistance=this.distance}}const xt="w",ht="a",vt="s",dt="d",$t="shift",At=" ",Nt="p";class Ie{constructor(t=!1){m(this,"map",new Map);console.log("KeyDisplay: isMobile =",t);const e=this.createKeyDiv(xt,t),i=this.createKeyDiv(ht,t),o=this.createKeyDiv(vt,t),s=this.createKeyDiv(dt,t),n=this.createKeyDiv($t,t),r=this.createKeyDiv("SPACE",t),c=this.createKeyDiv(Nt,t);this.map.set(xt,e),this.map.set(ht,i),this.map.set(vt,o),this.map.set(dt,s),this.map.set($t,n),this.map.set(At,r),this.map.set(Nt,c),document.body.appendChild(e),document.body.appendChild(i),document.body.appendChild(o),document.body.appendChild(s),document.body.appendChild(n),document.body.appendChild(r),document.body.appendChild(c),this.updatePosition()}createKeyDiv(t,e=!1){const i=document.createElement("div");return i.style.position="absolute",i.style.padding="8px 12px",i.style.minWidth="40px",i.style.textAlign="center",i.style.fontFamily="'Courier New', monospace",i.style.fontSize="16px",i.style.fontWeight="bold",i.style.color="#333",i.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",i.style.border="1px solid #999",i.style.borderRadius="4px",i.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",i.style.transition="all 0.1s ease",i.style.userSelect="none",i.style.opacity="0.6",i.textContent=t.toUpperCase(),e&&(i.style.display="none"),i}updatePosition(){this.map.get(xt).style.top=`${window.innerHeight-80-45}px`,this.map.get(xt).style.left="168px",this.map.get(ht).style.top=`${window.innerHeight-80}px`,this.map.get(ht).style.left="100px",this.map.get(vt).style.top=`${window.innerHeight-80}px`,this.map.get(vt).style.left="168px",this.map.get(dt).style.top=`${window.innerHeight-80}px`,this.map.get(dt).style.left=`${100+68*2}px`,this.map.get($t).style.top=`${window.innerHeight-80}px`,this.map.get($t).style.left="21px",this.map.get(At).style.top=`${window.innerHeight-80}px`,this.map.get(At).style.left=`${100+68*3+15}px`,this.map.get(Nt).style.top=`${window.innerHeight-80}px`,this.map.get(Nt).style.left=`${100+68*4+15*2}px`}down(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #00ff00, #00cc00)",e.style.color="#000",e.style.boxShadow="0 1px 2px rgba(0,0,0,0.3), inset 0 2px 4px rgba(0,0,0,0.2)",e.style.transform="translateY(2px)",e.style.opacity="1")}up(t){const e=this.map.get(t.toLowerCase());e&&(e.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",e.style.color="#333",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",e.style.transform="translateY(0)",e.style.opacity="0.6")}}class Ae{constructor(t,e,i,o,s,n,r,c=null,h=1){m(this,"currentAction");m(this,"toggleRun",!0);m(this,"walkVelocity",2);m(this,"runVelocity",5);m(this,"jumpForce",8);m(this,"gravity",-20);m(this,"maxFallSpeed",-50);m(this,"jumpCooldownDuration",.3);m(this,"characterHeightOffset",0);m(this,"maxHeight",null);m(this,"verticalVelocity",0);m(this,"isGrounded",!0);m(this,"jumpCooldown",0);m(this,"timeInAir",0);m(this,"airTimeThreshold",.4);m(this,"isJetpackActive",!1);m(this,"jetpackThrust",25);m(this,"jetpackTransitionDuration",.3);m(this,"jetpackTransitionTimer",0);m(this,"inertiaVelocityX",0);m(this,"inertiaVelocityZ",0);m(this,"hasInertia",!1);m(this,"raycaster",new a.Raycaster);m(this,"groundMeshes",[]);m(this,"rayOrigin",new a.Vector3);m(this,"rayDirection",new a.Vector3(0,-1,0));m(this,"forwardRaycaster",new a.Raycaster);m(this,"ceilingRaycaster",new a.Raycaster);m(this,"forwardGroundRaycaster",new a.Raycaster);m(this,"forwardCollisionDistance",.5);m(this,"ceilingCollisionDistance",2.5);m(this,"maxSlopeAngle",Math.PI/3);m(this,"maxStepHeight",.5);m(this,"tempCollisionVector",new a.Vector3);m(this,"tempCollisionNormal",new a.Vector3);m(this,"tempSlideVector",new a.Vector3);m(this,"walkDirection",new a.Vector3);m(this,"rotateAngle",new a.Vector3(0,1,0));m(this,"rotateQuaternion",new a.Quaternion);m(this,"fadeDuration",.2);m(this,"updateCameraTargetOffset",new a.Vector3);m(this,"cameraMode","third-person");m(this,"firstPersonPitch",0);m(this,"firstPersonYaw",0);m(this,"firstPersonHeadHeight",1.6);m(this,"targetOffsetY",1);this.model=t,this.mixer=e,this.animationsMap=i,this.orbitControl=o,this.camera=s,this.currentAction=n,r&&(this.groundMeshes=Array.isArray(r)?r:[r]),this.maxHeight=c,console.log(`[CharacterControls] maxHeight set to: ${this.maxHeight===null?"null (unlimited)":this.maxHeight.toFixed(2)}`),this.targetOffsetY=h,this.animationsMap.forEach((u,f)=>{f===n&&u.play()})}switchRunToggle(){this.toggleRun=!this.toggleRun}getGroundedState(){return this.isGrounded}getCurrentAction(){return this.currentAction}getJetpackActive(){return this.isJetpackActive}getGroundDistance(){const t=this.getGroundInfo();return Math.max(0,this.model.position.y-t.height)}getPosition(){return{x:this.model.position.x,y:this.model.position.y,z:this.model.position.z}}getMovementState(){return this.isJetpackActive&&!this.isGrounded?"jetpack":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?"idle":this.currentAction==="Run"?"run":this.currentAction==="Walk"?"walk":"idle"}setCameraMode(t){this.cameraMode=t,console.log(`CharacterControls: Camera mode set to ${t}`)}setFirstPersonRotation(t,e){this.firstPersonPitch=t,this.firstPersonYaw=e}placeOnGround(){const t=this.getGroundInfo();this.model.position.y=t.height+this.characterHeightOffset,console.log(`Character placed on ground at Y: ${this.model.position.y.toFixed(2)}`)}getGroundInfo(){if(this.groundMeshes.length===0)return{height:0,normal:null};this.rayOrigin.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.raycaster.set(this.rayOrigin,this.rayDirection);const t=this.raycaster.intersectObjects(this.groundMeshes,!0);if(t.length>0){const e=t[0];let i=null;if(e.face&&e.object){i=e.face.normal.clone();const o=new a.Matrix3().getNormalMatrix(e.object.matrixWorld);i.applyMatrix3(o).normalize()}return{height:e.point.y,normal:i}}return{height:-100,normal:null}}checkForwardCollision(t){if(this.groundMeshes.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.forwardRaycaster.set(this.tempCollisionVector,t),this.forwardRaycaster.far=this.forwardCollisionDistance;const e=this.forwardRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0],o=i.face?i.face.normal.clone():new a.Vector3(0,1,0);if(i.object&&i.face){const r=new a.Matrix3().getNormalMatrix(i.object.matrixWorld);o.applyMatrix3(r).normalize()}const s=o.dot(new a.Vector3(0,1,0)),n=s>=.5;return{hit:!0,point:i.point,normal:o,distance:i.distance,isWalkable:n,surfaceAngle:Math.acos(Math.abs(s))*(180/Math.PI)}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}checkCeilingCollision(){if(this.groundMeshes.length===0)return{hit:!1,height:1/0,distance:1/0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y,this.model.position.z);const t=new a.Vector3(0,1,0);this.ceilingRaycaster.set(this.tempCollisionVector,t),this.ceilingRaycaster.far=this.ceilingCollisionDistance;const e=this.ceilingRaycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const i=e[0];return{hit:!0,height:i.point.y,distance:i.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardGround(t,e){if(this.groundMeshes.length===0)return{exists:!1,height:-100,normal:null,isWalkable:!1};const i=this.model.position.x+t.x*e,o=this.model.position.z+t.z*e;this.tempCollisionVector.set(i,this.model.position.y+10,o);const s=new a.Vector3(0,-1,0);this.forwardGroundRaycaster.set(this.tempCollisionVector,s);const n=this.forwardGroundRaycaster.intersectObjects(this.groundMeshes,!0);if(n.length>0){const r=n[0],c=r.point.y,h=r.face?r.face.normal:new a.Vector3(0,1,0),u=this.getGroundInfo().height,f=c-u,p=Math.acos(Math.abs(h.y)),b=p<=this.maxSlopeAngle||Math.abs(f)<=this.maxStepHeight;return{exists:!0,height:c,normal:h,isWalkable:b,slopeAngle:p,heightDifference:f}}return{exists:!1,height:-100,normal:null,isWalkable:!1}}update(t,e){if(this.jumpCooldown>0&&(this.jumpCooldown-=t),e[At]&&this.isGrounded&&this.jumpCooldown<=0&&(this.verticalVelocity=this.jumpForce,this.isGrounded=!1,this.jumpCooldown=this.jumpCooldownDuration),e[At]&&!this.isGrounded&&this.timeInAir>this.airTimeThreshold?(this.isJetpackActive||(this.isJetpackActive=!0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0),this.verticalVelocity+=this.jetpackThrust*t):this.isJetpackActive&&(this.isJetpackActive=!1,this.jetpackTransitionTimer=this.jetpackTransitionDuration,(this.inertiaVelocityX!==0||this.inertiaVelocityZ!==0)&&(this.hasInertia=!0)),this.jetpackTransitionTimer>0){const p=this.jetpackTransitionTimer/this.jetpackTransitionDuration;this.verticalVelocity+=this.jetpackThrust*p*t,this.jetpackTransitionTimer-=t}this.verticalVelocity+=this.gravity*t,this.verticalVelocity<this.maxFallSpeed&&(this.verticalVelocity=this.maxFallSpeed);const i=this.getGroundInfo(),o=i.height,s=this.model.position.y;if(this.model.position.y+=this.verticalVelocity*t,this.verticalVelocity>0){const p=this.checkCeilingCollision();if(p.hit){const b=p.height-this.characterHeightOffset;this.model.position.y>b&&(this.model.position.y=b,this.verticalVelocity=0)}}this.maxHeight!==null&&this.model.position.y>this.maxHeight&&(console.log(`[Height Cap] Enforcing ceiling: position.y=${this.model.position.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),this.model.position.y=this.maxHeight,this.verticalVelocity=0);const r=this.model.position.y-this.characterHeightOffset-o;let c=!0;if(i.normal&&(c=i.normal.dot(new a.Vector3(0,1,0))>=.5),r<=0&&c?(this.model.position.y=o+this.characterHeightOffset,this.verticalVelocity=0,this.isGrounded=!0,this.timeInAir=0,this.isJetpackActive&&(this.isJetpackActive=!1),this.jetpackTransitionTimer=0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0):(this.isGrounded=!1,this.timeInAir+=t),this.cameraMode==="first-person")this.camera.position.y=this.model.position.y+this.firstPersonHeadHeight;else{const p=this.model.position.y-s;this.camera.position.y+=p}const h=Oe.some(p=>e[p]===!0);let u="";if(this.isJetpackActive&&!this.isGrounded?u="TPose":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?u="Idle":h&&this.toggleRun?u="Run":h?u="Walk":u="Idle",this.currentAction!==u){const p=this.animationsMap.get(u),b=this.animationsMap.get(this.currentAction);b&&p&&(b.fadeOut(this.fadeDuration),p.reset().fadeIn(this.fadeDuration).play(),this.currentAction=u)}this.mixer.update(t);const f=this.isGrounded||this.timeInAir<=this.airTimeThreshold;if(this.isJetpackActive&&!h&&(this.inertiaVelocityX=0,this.inertiaVelocityZ=0),h&&(f||this.isJetpackActive)){let p;this.cameraMode==="first-person"?p=this.firstPersonYaw:p=Math.atan2(this.camera.position.x-this.model.position.x,this.camera.position.z-this.model.position.z);const b=this.directionOffset(e);this.rotateQuaternion.setFromAxisAngle(this.rotateAngle,p+b),this.model.quaternion.rotateTowards(this.rotateQuaternion,.2),this.camera.getWorldDirection(this.walkDirection),this.walkDirection.y=0,this.walkDirection.normalize(),this.walkDirection.applyAxisAngle(this.rotateAngle,b);const P=this.toggleRun?this.runVelocity:this.walkVelocity;let w=this.walkDirection.x*P*t,C=this.walkDirection.z*P*t;this.isGrounded||(this.inertiaVelocityX=this.walkDirection.x*P,this.inertiaVelocityZ=this.walkDirection.z*P,this.hasInertia=!0);let G=!1,I=null;if(this.isGrounded){const L=Math.sqrt(w*w+C*C),A=this.checkForwardGround(this.walkDirection,L);A.isWalkable||(G=!0,A.normal?I=A.normal.clone():I=new a.Vector3(-this.walkDirection.x,0,-this.walkDirection.z).normalize())}const E=this.checkForwardCollision(this.walkDirection);if(E.hit||G){let L;E.hit?L=E.normal.clone():L=I.clone(),E.hit&&!E.isWalkable&&(L.y=0,L.normalize());const Y=this.tempSlideVector.set(w,0,C).dot(L);if(Y<0){const it=w-Y*L.x,V=C-Y*L.z;w=it,C=V}}this.model.position.x+=w,this.model.position.z+=C,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=w,this.camera.position.z+=C)}else if(this.hasInertia&&!this.isGrounded&&!this.isJetpackActive){let p=this.inertiaVelocityX*t,b=this.inertiaVelocityZ*t;const P=new a.Vector3(this.inertiaVelocityX,0,this.inertiaVelocityZ).normalize(),w=this.checkForwardCollision(P);if(w.hit){const C=w.normal.clone();w.isWalkable||(C.y=0,C.normalize());const I=this.tempSlideVector.set(p,0,b).dot(C);if(I<0){const E=p-I*C.x,L=b-I*C.z;p=E,b=L}}this.model.position.x+=p,this.model.position.z+=b,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=p,this.camera.position.z+=b)}if(this.cameraMode==="first-person"){this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z,this.model.rotation.y=this.firstPersonYaw,this.camera.rotation.order="YXZ",this.camera.rotation.y=this.firstPersonYaw,this.camera.rotation.x=this.firstPersonPitch,this.camera.rotation.z=0;const p=new a.Vector3;this.camera.getWorldDirection(p),this.updateCameraTargetOffset.copy(this.camera.position).add(p),this.orbitControl.target.copy(this.updateCameraTargetOffset)}else{const b=new a.Vector3(0,this.targetOffsetY,0).clone().applyQuaternion(this.model.quaternion);this.updateCameraTargetOffset.x=this.model.position.x+b.x,this.updateCameraTargetOffset.y=this.model.position.y+b.y,this.updateCameraTargetOffset.z=this.model.position.z+b.z,this.orbitControl.target.copy(this.updateCameraTargetOffset)}}directionOffset(t){let e=0;return t[xt]?t[ht]?e=Math.PI/4:t[dt]&&(e=-Math.PI/4):t[vt]?t[ht]?e=Math.PI/4+Math.PI/2:t[dt]?e=-Math.PI/4-Math.PI/2:e=Math.PI:t[ht]?e=Math.PI/2:t[dt]&&(e=-Math.PI/2),e}updateVRPhysics(t,e,i,o,s,n,r,c,h){const u=t.clone();if(c&&(e.y+=this.jetpackThrust*o),h>0){const w=h/this.jetpackTransitionDuration;e.y+=this.jetpackThrust*w*o,h-=o}if(e.y+=this.gravity*o,e.y<this.maxFallSpeed&&(e.y=this.maxFallSpeed),u.y+=e.y*o,e.y>0){const w=this.checkCeilingCollisionAtPosition(u,s);if(w.hit){const C=w.height;u.y>C&&(u.y=C,e.y=0)}}this.maxHeight!==null&&u.y>this.maxHeight&&(console.log(`[Height Cap VR] Enforcing ceiling: position.y=${u.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),u.y=this.maxHeight,e.y=0);const f=this.getGroundInfoAtPosition(u,s),p=f.height;let b=!0;if(f.normal&&(b=f.normal.dot(new a.Vector3(0,1,0))>=.5),u.y-p<=0&&b?(u.y=p,e.y=0,n=!0,r=0,c&&(c=!1),h=0):(n=!1,r+=o),i&&i.lengthSq()>0){let w=i.x,C=i.z;const G=i.clone().normalize(),I=this.checkForwardCollisionAtPosition(u,G,s);if(I.hit){const E=I.normal.clone();I.isWalkable||(E.y=0,E.normalize());const A=new a.Vector3(w,0,C).dot(E);A<0&&(w=w-A*E.x,C=C-A*E.z)}u.x+=w,u.z+=C}return{newPosition:u,velocity:e,isGrounded:n,airTime:r,jetpackActive:c,jetpackTransitionTimer:h}}getGroundInfoAtPosition(t,e){if(!e||e.length===0)return{height:0,normal:null};const i=Math.max(t.y+10,100),o=new a.Vector3(t.x,i,t.z),s=new a.Vector3(0,-1,0),n=new a.Raycaster;n.set(o,s);const r=n.intersectObjects(e,!0);if(r.length>0){const c=r[0];let h=null;if(c.face&&c.object){h=c.face.normal.clone();const u=new a.Matrix3().getNormalMatrix(c.object.matrixWorld);h.applyMatrix3(u).normalize()}return{height:c.point.y,normal:h}}return{height:-100,normal:null}}checkCeilingCollisionAtPosition(t,e){if(!e||e.length===0)return{hit:!1,height:1/0,distance:1/0};const i=new a.Vector3(t.x,t.y+1,t.z),o=new a.Vector3(0,1,0),s=new a.Raycaster;s.set(i,o),s.far=this.ceilingCollisionDistance;const n=s.intersectObjects(e,!0);if(n.length>0){const r=n[0];return{hit:!0,height:r.point.y,distance:r.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardCollisionAtPosition(t,e,i){if(!i||i.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};const o=new a.Vector3(t.x,t.y+1,t.z),s=new a.Raycaster;s.set(o,e),s.far=this.forwardCollisionDistance;const n=s.intersectObjects(i,!0);if(n.length>0){const r=n[0],c=r.face?r.face.normal.clone():new a.Vector3(0,1,0);if(r.object&&r.face){const f=new a.Matrix3().getNormalMatrix(r.object.matrixWorld);c.applyMatrix3(f).normalize()}const u=c.dot(new a.Vector3(0,1,0))>=.5;return{hit:!0,point:r.point,normal:c,distance:r.distance,isWalkable:u}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}}const Oe=[xt,ht,vt,dt];class Ge{constructor(){this.base=null,this.thumb=null,this.active=!1,this.originX=0,this.originY=0,this.currentX=0,this.currentY=0,this.maxDistance=40,this.deadzone=.15,this.createElements()}createElements(){this.base=document.createElement("div"),this.base.id="joystick-base",this.base.style.display="none",document.body.appendChild(this.base),this.thumb=document.createElement("div"),this.thumb.id="joystick-thumb",this.base.appendChild(this.thumb)}show(t,e){this.active=!0,this.originX=t,this.originY=e,this.currentX=t,this.currentY=e,this.base.style.left=`${t}px`,this.base.style.top=`${e}px`,this.base.style.display="block",this.thumb.style.transform="translate(0px, 0px)",requestAnimationFrame(()=>{this.base.style.opacity="1"})}update(t,e){if(!this.active)return;this.currentX=t,this.currentY=e;let i=t-this.originX,o=e-this.originY;if(Math.sqrt(i*i+o*o)>this.maxDistance){const n=Math.atan2(o,i);i=Math.cos(n)*this.maxDistance,o=Math.sin(n)*this.maxDistance}this.thumb.style.transform=`translate(${i}px, ${o}px)`}hide(){this.active=!1,this.base.style.opacity="0",setTimeout(()=>{this.active||(this.base.style.display="none")},200)}getDirection(){if(!this.active)return{angle:0,magnitude:0};const t=this.currentX-this.originX,e=this.currentY-this.originY,i=Math.sqrt(t*t+e*e),o=Math.min(i/this.maxDistance,1);return o<this.deadzone?{angle:0,magnitude:0}:{angle:Math.atan2(e,t),magnitude:o}}getKeys(){const{angle:t,magnitude:e}=this.getDirection();if(e===0)return{w:!1,a:!1,s:!1,d:!1};let i=t*180/Math.PI;i<0&&(i+=360);const o={w:!1,a:!1,s:!1,d:!1};return i>=337.5||i<22.5?o.d=!0:i>=22.5&&i<67.5?(o.d=!0,o.w=!0):i>=67.5&&i<112.5?o.s=!0:i>=112.5&&i<157.5?(o.a=!0,o.s=!0):i>=157.5&&i<202.5?o.a=!0:i>=202.5&&i<247.5?(o.a=!0,o.w=!0):i>=247.5&&i<292.5?o.w=!0:i>=292.5&&i<337.5&&(o.d=!0,o.w=!0),o}isActive(){return this.active}}class Ve{constructor(t,e){this.keysPressed=t,this.orbitControls=e,this.joystick=new Ge,this.activeTouchId=null,this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.touchLastX=0,this.touchLastY=0,this.touchHasMoved=!1,this.longPressThreshold=400,this.movementThreshold=10,this.jetpackActive=!1,this.orbitControlsEnabled=!0,this.cameraMode="third-person",this.firstPersonCallback=null,this.isPaintMode=!1,this.paintCallback=null,this.paintEndCallback=null,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.setupEventListeners(),this.startUpdateLoop()}setupEventListeners(){document.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),document.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1}),document.addEventListener("contextmenu",this.handleContextMenu,{passive:!1})}handleTouchStart(t){const e=t.target;if(e&&(e.tagName==="BUTTON"||e.tagName==="SELECT"||e.tagName==="INPUT"||e.tagName==="A"||e.closest("button")||e.closest("select")||e.closest("input")))return;const i=t.changedTouches[0],o=Date.now();this.activeTouchId!==null||this.joystick.isActive()||(this.activeTouchId=i.identifier,this.touchStartTime=o,this.touchStartX=i.clientX,this.touchStartY=i.clientY,this.touchLastX=i.clientX,this.touchLastY=i.clientY,this.touchHasMoved=!1,t.preventDefault())}handleTouchMove(t){let e=null;for(let n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===this.activeTouchId){e=t.changedTouches[n];break}if(!e)return;if(t.preventDefault(),this.joystick.isActive()){this.joystick.update(e.clientX,e.clientY);return}const i=e.clientX-this.touchStartX,o=e.clientY-this.touchStartY;if(Math.sqrt(i*i+o*o)>this.movementThreshold&&(this.touchHasMoved=!0),this.touchHasMoved){const n=e.clientX-this.touchLastX,r=e.clientY-this.touchLastY;this.isPaintMode&&this.paintCallback?this.paintCallback(e.clientX,e.clientY):this.handleCameraRotation(n,r)}this.touchLastX=e.clientX,this.touchLastY=e.clientY}handleTouchEnd(t){for(let e=0;e<t.changedTouches.length;e++)if(t.changedTouches[e].identifier===this.activeTouchId){this.joystick.isActive()&&this.deactivateJoystick(),this.isPaintMode&&this.paintEndCallback&&this.paintEndCallback(),this.activeTouchId=null,this.touchHasMoved=!1;break}}handleCameraRotation(t,e){this.cameraMode==="first-person"?this.firstPersonCallback&&this.firstPersonCallback(t,e):this.orbitControls&&(this.orbitControls.rotateLeft(-t*.005),this.orbitControls.rotateUp(-e*.005),this.orbitControls.update())}activateJoystick(t,e){this.joystick.show(t,e),this.orbitControls&&(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1),console.log("Virtual joystick activated")}deactivateJoystick(){this.joystick.hide(),this.keysPressed.w=!1,this.keysPressed.a=!1,this.keysPressed.s=!1,this.keysPressed.d=!1,this.orbitControls&&this.orbitControlsEnabled&&(this.orbitControls.enabled=!0),console.log("Virtual joystick deactivated")}activateJetpack(){this.jetpackActive=!0,this.keysPressed[" "]=!0,console.log("Jetpack mode activated")}deactivateJetpack(){this.jetpackActive=!1,this.keysPressed[" "]=!1,console.log("Jetpack mode deactivated")}startUpdateLoop(){const t=()=>{if(this.joystick.isActive()){const e=this.joystick.getKeys();this.keysPressed.w=e.w,this.keysPressed.a=e.a,this.keysPressed.s=e.s,this.keysPressed.d=e.d}this.activeTouchId!==null&&!this.joystick.isActive()&&!this.touchHasMoved&&Date.now()-this.touchStartTime>=this.longPressThreshold&&this.activateJoystick(this.touchStartX,this.touchStartY),requestAnimationFrame(t)};t()}setCameraMode(t){this.cameraMode=t,console.log(`TouchControls: Camera mode set to ${t}`)}setFirstPersonCallback(t){this.firstPersonCallback=t}setPaintMode(t){this.isPaintMode=t,this.orbitControls&&(t?(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1):this.orbitControls.enabled=this.orbitControlsEnabled),console.log(`TouchControls: Paint mode ${t?"ON":"OFF"}`)}setPaintCallback(t){this.paintCallback=t}setPaintEndCallback(t){this.paintEndCallback=t}handleContextMenu(t){return t.preventDefault(),!1}disable(){document.removeEventListener("touchstart",this.handleTouchStart),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("touchcancel",this.handleTouchEnd),document.removeEventListener("contextmenu",this.handleContextMenu),this.joystick.isActive()&&this.deactivateJoystick(),console.log("Touch controls disabled")}}async function ze(){try{const l=await fetch("models/scenes.json");if(!l.ok)throw new Error(`Failed to load scenes manifest: ${l.statusText}`);const t=await l.json();return console.log("Scenes manifest loaded:",t),t}catch(l){throw console.error("Error loading scenes manifest:",l),l}}async function Be(l){try{const t=await fetch(l);if(!t.ok)throw new Error(`Failed to load scene config from ${l}: ${t.statusText}`);const e=await t.json();return He(e),console.log(`Scene config loaded: ${e.name}`,e),e}catch(t){throw console.error(`Error loading scene config from ${l}:`,t),t}}function He(l){const t=["name","assets","transform","character","camera","lighting","scene"];for(const e of t)if(!(e in l))throw new Error(`Scene config missing required field: ${e}`);if(!l.assets.splatFile||!l.assets.collisionFile||!l.assets.characterFile)throw new Error("Scene config missing required asset files");if(typeof l.transform.scale!="number")throw new Error("Scene config: transform.scale must be a number");console.log("Scene config validation passed")}function ee(l){return l.scenes.map(t=>({id:t.id,name:t.name,description:t.description||"",latitude:t.latitude||0,longitude:t.longitude||0,thumbnail:t.thumbnail||"models/thumbnails/placeholder.jpg"}))}function $e(l){var t;return l.defaultScene||((t=l.scenes[0])==null?void 0:t.id)||"StoneHenge"}function Ne(l,t){const e=l.scenes.find(i=>i.id===t);return e?e.config:null}class je{constructor(t,e,i={}){this.context=t,this.destination=e,this.buffer=null,this.source=null,this.gainNode=this.context.createGain(),this.gainNode.gain.value=i.initialGain!==void 0?i.initialGain:0,this.gainNode.connect(this.destination),this.isPlaying=!1}setBuffer(t){this.buffer=t}start(){if(!(this.isPlaying||!this.buffer)){this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.gainNode);try{this.source.start(),this.isPlaying=!0}catch(t){console.warn("LoopedTrack start failed:",t)}}}stop(){if(this.isPlaying){try{this.source.stop()}catch{}try{this.source.disconnect()}catch{}this.source=null,this.isPlaying=!1}}dispose(){this.stop();try{this.gainNode.disconnect()}catch{}this.gainNode=null}}class Xe{constructor(t={},e=!1){m(this,"isMobile",!1);m(this,"audioContext",null);m(this,"masterGain",null);m(this,"oneShotGain",null);m(this,"tracks",{background:null,walking:null,running:null,jetpack:null});m(this,"buffers",{background:null,walking:null,running:null,jetpack:null,magicReveal:null});m(this,"backgroundMusicEnabled",!0);m(this,"movementSoundsEnabled",!0);m(this,"backgroundMusicVolume",.3);m(this,"walkingSoundVolume",.25);m(this,"runningSoundVolume",.15);m(this,"jetpackVolume",.5);m(this,"magicRevealVolume",.6);m(this,"fadeSpeed",2);m(this,"backgroundMusicTarget",0);m(this,"walkingSoundTarget",0);m(this,"runningSoundTarget",0);m(this,"jetpackTarget",0);m(this,"currentMovementState","idle");m(this,"previousMovementState","idle");m(this,"audioUnlocked",!1);m(this,"loopedSoundsStarted",!1);m(this,"preloadPromise",null);this.config=t,this.isMobile=e,this.ensureContext(),this.setupGraph(),this.preloadPromise=this.preloadAll().then(()=>{console.log("Audio buffers preloaded")}).catch(i=>{console.warn("Audio preload failed:",i)}),console.log("AudioManager (Web Audio) initialized with config:",t,"mobile:",e)}ensureContext(){if(this.audioContext)return this.audioContext;const t=window.AudioContext||window.webkitAudioContext;return this.audioContext=new t,this.audioContext}setupGraph(){if(this.masterGain)return;const t=this.ensureContext();this.masterGain=t.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(t.destination),this.oneShotGain=t.createGain(),this.oneShotGain.gain.value=this.magicRevealVolume,this.oneShotGain.connect(this.masterGain)}async preloadAll(){const t=[];this.config.backgroundMusic&&!this.buffers.background&&t.push(this.loadBuffer(this.config.backgroundMusic,"background").then(e=>this.buffers.background=e).catch(e=>console.warn("Failed to load background:",e))),this.config.runningSound&&!this.buffers.running&&t.push(this.loadBuffer(this.config.runningSound,"running").then(e=>this.buffers.running=e).catch(e=>console.warn("Failed to load running:",e))),this.config.jetpackSound&&!this.buffers.jetpack&&t.push(this.loadBuffer(this.config.jetpackSound,"jetpack").then(e=>this.buffers.jetpack=e).catch(e=>console.warn("Failed to load jetpack:",e))),!this.isMobile&&this.config.walkingSound&&!this.buffers.walking&&t.push(this.loadBuffer(this.config.walkingSound,"walking").then(e=>this.buffers.walking=e).catch(e=>console.warn("Failed to load walking:",e))),this.config.magicReveal&&!this.buffers.magicReveal&&t.push(this.loadBuffer(this.config.magicReveal,"magicReveal").then(e=>this.buffers.magicReveal=e).catch(e=>console.warn("Failed to load magicReveal:",e))),t.length>0?(console.log(`Loading ${t.length} audio buffers...`),await Promise.allSettled(t),console.log("Audio preload complete (some may have failed)")):console.log("All audio buffers already loaded")}async loadBuffer(t){const e=this.ensureContext(),o=await(await fetch(t)).arrayBuffer();return await new Promise((s,n)=>{try{const r=e.decodeAudioData(o);r&&typeof r.then=="function"?r.then(s).catch(c=>{try{e.decodeAudioData(o,s,n)}catch(h){n(h)}}):e.decodeAudioData(o,s,n)}catch{try{e.decodeAudioData(o,s,n)}catch(c){n(c)}}})}async unlockAudio(){if(this.audioUnlocked){console.log("Audio already unlocked");return}if(this.isMobile){try{if(this.audioContext&&this.audioContext.state!=="closed")try{await this.audioContext.close()}catch{}}catch{}const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.masterGain=null,this.oneShotGain=null,this.tracks={background:null,walking:null,running:null,jetpack:null},this.setupGraph()}const t=this.ensureContext();try{await t.resume()}catch(e){console.warn("AudioContext resume failed:",e)}try{await this.preloadAll()}catch(e){console.warn("Continuing without all audio buffers:",e)}this.startOrCreateTrack("background",this.buffers.background),this.isMobile||this.startOrCreateTrack("walking",this.buffers.walking),this.startOrCreateTrack("running",this.buffers.running),this.startOrCreateTrack("jetpack",this.buffers.jetpack),this.audioUnlocked=!0,this.loopedSoundsStarted=!0,console.log("âœ“ Web Audio unlocked, looped tracks running at gain 0")}startOrCreateTrack(t,e){e&&(this.tracks[t]||(this.tracks[t]=new je(this.audioContext,this.masterGain,{initialGain:0}),this.tracks[t].setBuffer(e)),this.tracks[t].start())}playMagicReveal(t=0){if(!this.buffers.magicReveal)return;const e=()=>{try{const i=this.audioContext.createBufferSource(),o=this.audioContext.createGain();o.gain.value=this.magicRevealVolume,i.buffer=this.buffers.magicReveal,i.connect(o).connect(this.masterGain),i.start(),i.onended=()=>{try{i.disconnect()}catch{}try{o.disconnect()}catch{}}}catch(i){console.warn("Magic reveal play failed:",i)}};t>0?setTimeout(e,t*1e3):e()}startBackgroundMusic(){this.backgroundMusicEnabled&&(this.backgroundMusicTarget=this.backgroundMusicVolume,console.log("Background music fading in"))}stopBackgroundMusic(){this.backgroundMusicTarget=0,console.log("Background music fading out")}updateMovementSounds(t){if(this.previousMovementState=this.currentMovementState,this.currentMovementState=t,this.previousMovementState!==this.currentMovementState&&console.log(`Movement state changed: ${this.previousMovementState} -> ${t}`),!this.movementSoundsEnabled){this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0;return}t==="walk"?(this.isMobile?this.walkingSoundTarget=0:this.walkingSoundTarget=this.walkingSoundVolume,this.runningSoundTarget=0,this.jetpackTarget=0):t==="run"?(this.walkingSoundTarget=0,this.runningSoundTarget=this.runningSoundVolume,this.jetpackTarget=0):t==="jetpack"?(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=this.jetpackVolume):(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0)}update(t){this.rampGainTo("background",this.backgroundMusicTarget,t),this.isMobile||this.rampGainTo("walking",this.walkingSoundTarget,t),this.rampGainTo("running",this.runningSoundTarget,t),this.rampGainTo("jetpack",this.jetpackTarget,t)}rampGainTo(t,e,i){const o=this.tracks[t];if(!o||!o.gainNode)return;const s=o.gainNode.gain.value;if(s===e)return;const n=this.fadeSpeed*i,r=s<e?Math.min(e,s+n):Math.max(e,s-n),c=this.audioContext.currentTime;try{o.gainNode.gain.cancelScheduledValues(c),o.gainNode.gain.setValueAtTime(s,c),o.gainNode.gain.linearRampToValueAtTime(r,c+.05)}catch{o.gainNode.gain.value=r}}toggleBackgroundMusic(){this.backgroundMusicEnabled=!this.backgroundMusicEnabled,this.backgroundMusicEnabled?this.startBackgroundMusic():this.stopBackgroundMusic(),console.log("Background music:",this.backgroundMusicEnabled?"ON":"OFF")}toggleMovementSounds(){this.movementSoundsEnabled=!this.movementSoundsEnabled,this.movementSoundsEnabled||(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0),console.log("Movement sounds:",this.movementSoundsEnabled?"ON":"OFF")}setMasterVolume(t){const e=Math.max(0,Math.min(1,t));this.backgroundMusicVolume=e*.3,this.walkingSoundVolume=e*.25,this.runningSoundVolume=e*.15,this.jetpackVolume=e*.5,this.oneShotGain&&(this.oneShotGain.gain.value=this.magicRevealVolume*e),console.log("Master volume set to:",e)}dispose(){Object.values(this.tracks).forEach(t=>{t&&t.dispose()}),this.tracks={background:null,walking:null,running:null,jetpack:null};try{this.oneShotGain&&this.oneShotGain.disconnect()}catch{}try{this.masterGain&&this.masterGain.disconnect()}catch{}try{this.audioContext.suspend()}catch{}console.log("AudioManager (Web Audio) disposed")}}class Je{constructor(t,e,i,o){this.renderer=t,this.camera=e,this.scene=i,this.sceneConfig=o,this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.xrConfig=(o==null?void 0:o.xr)||{enabled:!0,referenceSpaceType:"local-floor",referenceSpaceOrigin:{position:{x:0,y:0,z:0},rotation:{y:0}},userHeight:1.6},this.vrVelocity=new a.Vector3,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1,this.jetpackTransitionTimer=0,this.moveSpeed=5,this.runSpeedMultiplier=2,this.isRunning=!1,this.teleportTarget=null,this.teleportReticle=null,this.isTeleporting=!1,this.characterControls=null,this.orbitControls=null,this.xrControllers=null,this.xrHands=null,this.gaussianSplat=null,this.worldOffset=new a.Vector3,this.yRotation=0,this.xRotation=0,this.actualReferenceOrigin=null,this.characterPosition=new a.Vector3,this.init()}async init(){if(!this.xrConfig.enabled){console.log("XR disabled in scene config");return}this.renderer.xr.enabled=!0,await this.createVRButton(),this.renderer.xr.addEventListener("sessionstart",this.onSessionStart.bind(this)),this.renderer.xr.addEventListener("sessionend",this.onSessionEnd.bind(this)),this.createTeleportReticle(),console.log("XRManager initialized",this.xrConfig)}async createVRButton(){if(!navigator.xr){console.log("WebXR not available, VR button hidden");return}try{if(!await navigator.xr.isSessionSupported("immersive-vr")){console.log("immersive-vr not supported, VR button hidden");return}const e=Ce.createButton(this.renderer);e.style.position="fixed",e.style.bottom="90px",e.style.right="30px",e.style.zIndex="1000",document.body.appendChild(e),this.vrButton=e,console.log("WebXR available, VR button shown")}catch(t){console.warn("Error checking WebXR support:",t)}}createTeleportReticle(){const t=new a.RingGeometry(.2,.25,32),e=new a.MeshBasicMaterial({color:65280,side:a.DoubleSide,transparent:!0,opacity:.8});this.teleportReticle=new a.Mesh(t,e),this.teleportReticle.rotation.x=-Math.PI/2,this.teleportReticle.visible=!1,this.scene.add(this.teleportReticle)}async onSessionStart(){var t,e,i;if(console.log("XR session starting..."),this.session=this.renderer.xr.getSession(),this.isXRActive=!0,this.gaussianSplat){this.gaussianSplat.visible=!0,console.log("Gaussian splat visibility ensured for VR mode:",this.gaussianSplat.visible);let o=this.gaussianSplat.parent,s=0;for(;o&&s<5;)console.log(`  Parent ${s}:`,o.type||o.constructor.name),o=o.parent,s++}else console.warn("Gaussian splat reference not set in XRManager");try{const o=this.xrConfig.referenceSpaceType||"local-floor";try{this.localSpace=await this.session.requestReferenceSpace(o),console.log(`XR reference space type: ${o}`)}catch{console.warn(`${o} not supported, falling back to 'local'`),this.localSpace=await this.session.requestReferenceSpace("local")}const s=((e=(t=this.sceneConfig)==null?void 0:t.character)==null?void 0:e.spawn)||{},n=s.position||{x:0,y:"auto",z:40},r=s.rotation||{y:0},c=n.x,h=n.z,u=((i=this.characterControls)==null?void 0:i.groundMeshes)||[];let f=0;if(u.length>0&&this.characterControls){const P=new a.Vector3(c,1e3,h);f=this.characterControls.getGroundInfoAtPosition(P,u).height,f<-50?(console.warn(`No ground found at XR spawn (${c}, ${h}), using Y=0`),f=0):console.log(`Ground height at XR spawn (${c}, ${h}): ${f.toFixed(2)}`)}const p=this.xrConfig.userHeight||1.6,b={x:c,y:f,z:h};this.actualReferenceOrigin={position:b,rotation:r,userHeight:p},this.characterPosition.set(b.x,b.y,b.z),this.setReferenceSpaceOrigin(b,r),console.log("XR reference space initialized at:",b),console.log("Character position (play space center):",this.characterPosition)}catch(o){console.error("Failed to request reference space:",o)}this.orbitControls&&(this.orbitControls.enabled=!1),this.hideNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!1),this.xrControllers&&this.xrControllers.enable(),this.xrHands&&this.xrHands.enable(),this.vrVelocity.set(0,0,0),this.worldOffset.set(0,0,0),this.yRotation=0,this.xRotation=0,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1}onSessionEnd(){console.log("XR session ended"),this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.actualReferenceOrigin=null,this.characterPosition.set(0,0,0),this.orbitControls&&(this.orbitControls.enabled=!0),this.showNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!0),this.xrControllers&&this.xrControllers.disable(),this.xrHands&&this.xrHands.disable(),this.teleportReticle.visible=!1}setReferenceSpaceOrigin(t,e){if(!this.localSpace)return;const i=t||{x:0,y:0,z:0},o=e||{y:0},s=new a.PerspectiveCamera;s.position.set(i.x,i.y,i.z),s.rotation.order="YXZ",s.rotation.y=o.y*(Math.PI/180),s.updateMatrixWorld();const n=s.quaternion,r=new XRRigidTransform({x:i.x,y:i.y,z:i.z},{x:n.x,y:n.y,z:n.z,w:n.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(r.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace),this.worldOffset.set(0,0,0)}updateReferenceSpaceByOffset(t){if(!this.currentReferenceSpace||!this.localSpace)return;this.worldOffset.add(t);const e=this.actualReferenceOrigin||this.xrConfig.referenceSpaceOrigin,i=e.position||{x:0,y:0,z:0},o=e.rotation||{y:0},s={x:i.x+this.worldOffset.x,y:i.y+this.worldOffset.y,z:i.z+this.worldOffset.z},n=new a.PerspectiveCamera;n.position.set(s.x,s.y,s.z),n.rotation.order="YXZ",n.rotation.y=o.y*(Math.PI/180)+this.yRotation,n.rotation.x=this.xRotation,n.updateMatrixWorld();const r=n.quaternion,c=new XRRigidTransform({x:s.x,y:s.y,z:s.z},{x:r.x,y:r.y,z:r.z,w:r.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(c.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace)}teleportTo(t){if(!this.isXRActive)return;const e=t.clone(),i=new a.Vector3().subVectors(e,this.characterPosition);this.characterPosition.copy(e),this.updateReferenceSpaceByOffset(i),console.log("Teleported to ground:",t,"character at feet:",e)}updateTeleportTarget(t){t?(this.teleportReticle.position.copy(t),this.teleportReticle.visible=!0,this.teleportTarget=t.clone()):(this.teleportReticle.visible=!1,this.teleportTarget=null)}executeTeleport(){this.teleportTarget&&(this.teleportTo(this.teleportTarget),this.teleportReticle.visible=!1,this.teleportTarget=null)}handleThumbstickMovement(t,e){if(!this.isXRActive||t.lengthSq()<.01)return;const i=this.renderer.xr.getCamera(),o=new a.Vector3(0,0,-1),s=new a.Vector3(1,0,0),n=Math.atan2(i.matrixWorld.elements[8],i.matrixWorld.elements[10]);o.applyAxisAngle(new a.Vector3(0,1,0),n),s.applyAxisAngle(new a.Vector3(0,1,0),n);const r=new a.Vector3().addScaledVector(o,-t.y).addScaledVector(s,t.x);r.y=0,r.normalize();const c=this.moveSpeed*(this.isRunning?this.runSpeedMultiplier:1);return r.multiplyScalar(c*e)}handleThumbstickRotation(t,e){if(!this.isXRActive||!t)return;const i=2,o=.15,s=Math.PI/2-.1;let n=!1;if(Math.abs(t.x)>o){const r=-t.x*i*e;this.yRotation+=r,n=!0}if(Math.abs(t.y)>o){const r=-t.y*i*e;this.xRotation+=r,this.xRotation=Math.max(-s,Math.min(s,this.xRotation)),n=!0}n&&this.updateReferenceSpaceByOffset(new a.Vector3)}updateVRPhysics(t,e){if(!this.isXRActive||!this.characterControls)return;const i=this.characterPosition.clone();let o=new a.Vector3;if(this.xrControllers){const r=this.xrControllers.getThumbstickAxes();r&&(o=this.handleThumbstickMovement(r,t)||new a.Vector3);const c=this.xrControllers.getRightThumbstickAxes();c&&this.handleThumbstickRotation(c,t)}const s=this.characterControls.updateVRPhysics(i,this.vrVelocity,o,t,e,this.isGrounded,this.airTime,this.jetpackActive,this.jetpackTransitionTimer);this.vrVelocity.copy(s.velocity),this.isGrounded=s.isGrounded,this.airTime=s.airTime,this.jetpackActive=s.jetpackActive,this.jetpackTransitionTimer=s.jetpackTransitionTimer;const n=new a.Vector3().subVectors(s.newPosition,i);n.lengthSq()>1e-4&&(this.characterPosition.copy(s.newPosition),this.updateReferenceSpaceByOffset(n),Math.random()<.01&&console.log("VR Physics:",{characterY:this.characterPosition.y.toFixed(2),deltaY:n.y.toFixed(3),isGrounded:s.isGrounded,velocity:this.vrVelocity.y.toFixed(2)}))}update(t,e){this.isXRActive&&(this.updateVRPhysics(t,e),this.xrControllers&&this.xrControllers.update(t),this.xrHands&&this.xrHands.update())}hideNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="none");const e=document.getElementById("camera-toggle");e&&(e.style.display="none");const i=document.getElementById("key-display");i&&(i.style.display="none")}showNonXRUI(){const t=document.getElementById("touch-controls-container");t&&(t.style.display="block");const e=document.getElementById("camera-toggle");e&&(e.style.display="block");const i=document.getElementById("key-display");i&&(i.style.display="block")}getIsXRActive(){return this.isXRActive}getXRCamera(){return this.isXRActive?this.renderer.xr.getCamera():null}onJumpPressed(){this.isGrounded&&(this.vrVelocity.y=this.characterControls.jumpForce,this.isGrounded=!1,this.airTime=0)}onJetpackPressed(t){this.airTime>.4&&(this.jetpackActive=t)}onRunToggle(){this.isRunning=!this.isRunning,console.log("Run mode:",this.isRunning?"ON":"OFF")}onResetPitch(){this.xRotation=0,console.log("Camera pitch reset to flat (0 degrees)"),this.updateReferenceSpaceByOffset(new a.Vector3)}dispose(){this.vrButton&&this.vrButton.parentNode&&this.vrButton.parentNode.removeChild(this.vrButton),this.teleportReticle&&(this.scene.remove(this.teleportReticle),this.teleportReticle.geometry.dispose(),this.teleportReticle.material.dispose()),this.renderer.xr.removeEventListener("sessionstart",this.onSessionStart),this.renderer.xr.removeEventListener("sessionend",this.onSessionEnd)}}class We{constructor(t,e,i){this.renderer=t,this.scene=e,this.xrManager=i,this.controller0=null,this.controller1=null,this.controllerGrip0=null,this.controllerGrip1=null,this.controllerModelFactory=new Te,this.rayLine0=null,this.rayLine1=null,this.leftThumbstickAxes=new a.Vector2,this.rightThumbstickAxes=new a.Vector2,this.thumbstickAxes=new a.Vector2,this.isSelectPressed=!1,this.isSqueezePressed=!1,this.squeezeHoldTime=0,this.buttonAPressed=!1,this.buttonBPressed=!1,this.rightStickPressed=!1,this.buttonACooldown=0,this.buttonBCooldown=0,this.rightStickCooldown=0,this.buttonCooldownDuration=.3,this.isPaintMode=!1,this.colorPalette=null,this.paletteColors=[{name:"Red",hex:16711680},{name:"Orange",hex:16746496},{name:"Yellow",hex:16776960},{name:"Green",hex:65280},{name:"Cyan",hex:65535},{name:"Blue",hex:255},{name:"Purple",hex:8913151},{name:"Magenta",hex:16711935},{name:"White",hex:16777215},{name:"Gray",hex:8421504},{name:"Black",hex:0},{name:"Brown",hex:9127187}],this.currentColorIndex=4,this.raycaster=new a.Raycaster,this.groundMeshes=[],this.isEnabled=!1}init(){this.controller0=this.renderer.xr.getController(0),this.controller0.addEventListener("selectstart",this.onSelectStart.bind(this,0)),this.controller0.addEventListener("selectend",this.onSelectEnd.bind(this,0)),this.controller0.addEventListener("squeezestart",this.onSqueezeStart.bind(this,0)),this.controller0.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,0)),this.scene.add(this.controller0),this.controller1=this.renderer.xr.getController(1),this.controller1.addEventListener("selectstart",this.onSelectStart.bind(this,1)),this.controller1.addEventListener("selectend",this.onSelectEnd.bind(this,1)),this.controller1.addEventListener("squeezestart",this.onSqueezeStart.bind(this,1)),this.controller1.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,1)),this.scene.add(this.controller1),this.controllerGrip0=this.renderer.xr.getControllerGrip(0),this.controllerGrip0.add(this.controllerModelFactory.createControllerModel(this.controllerGrip0)),this.scene.add(this.controllerGrip0),this.controllerGrip1=this.renderer.xr.getControllerGrip(1),this.controllerGrip1.add(this.controllerModelFactory.createControllerModel(this.controllerGrip1)),this.scene.add(this.controllerGrip1),this.rayLine0=this.createRayLine(),this.controller0.add(this.rayLine0),this.rayLine1=this.createRayLine(),this.controller1.add(this.rayLine1),console.log("XR Controllers initialized")}createRayLine(){const t=new a.BufferGeometry,e=new Float32Array([0,0,0,0,0,-5]);t.setAttribute("position",new a.BufferAttribute(e,3));const i=new a.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.6}),o=new a.Line(t,i);return o.visible=!1,o}enable(){this.isEnabled=!0,this.controller0||this.init()}disable(){this.isEnabled=!1,this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1)}onSelectStart(t,e){console.log(`Controller ${t} select start - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!0;const i=t===0?this.rayLine0:this.rayLine1;i&&(i.visible=!0,i.material.color.setHex(65280)),this.isPaintMode?(console.log("Paint mode active - setting isDragging to true"),this.isDragging=!0):console.log("NOT in paint mode - will teleport on release")}onSelectEnd(t,e){console.log(`Controller ${t} select end - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!1;const i=t===0?this.rayLine0:this.rayLine1;if(i&&(i.visible=!1),this.isPaintMode){if(console.log("Paint mode - checking color selection"),this.checkColorSelection(t)){console.log("Color selected from palette");return}console.log("Stopping paint (isDragging = false)"),this.isDragging=!1}else console.log("NOT in paint mode - executing teleport"),this.xrManager.executeTeleport()}onSqueezeStart(t,e){console.log(`Controller ${t} squeeze start`),this.isSqueezePressed=!0,this.squeezeHoldTime=0,this.xrManager.onJumpPressed()}onSqueezeEnd(t,e){console.log(`Controller ${t} squeeze end`),this.isSqueezePressed=!1,this.xrManager.onJetpackPressed(!1)}getThumbstickAxes(){const t=this.renderer.xr.getSession();if(!t)return null;this.leftThumbstickAxes.set(0,0),this.rightThumbstickAxes.set(0,0);for(const e of t.inputSources)if(e.gamepad&&e.handedness){const i=e.gamepad,o=e.handedness==="left";if(i.axes.length>=4){const s=i.axes[2],n=i.axes[3];o?this.leftThumbstickAxes.set(s,n):this.rightThumbstickAxes.set(s,n)}i.buttons.length>4&&i.buttons[4].pressed?!this.buttonAPressed&&this.buttonACooldown<=0&&(this.buttonAPressed=!0,this.buttonACooldown=this.buttonCooldownDuration,this.xrManager.onRunToggle()):this.buttonAPressed=!1,i.buttons.length>5&&i.buttons[5].pressed?!this.buttonBPressed&&this.buttonBCooldown<=0?(this.buttonBPressed=!0,this.buttonBCooldown=this.buttonCooldownDuration,console.log(`B/Y button pressed - toggling paint mode (cooldown: ${this.buttonCooldownDuration}s)`),this.togglePaintMode()):this.buttonBCooldown>0:this.buttonBPressed=!1,!o&&i.buttons.length>3&&i.buttons[3].pressed?!this.rightStickPressed&&this.rightStickCooldown<=0&&(this.rightStickPressed=!0,this.rightStickCooldown=this.buttonCooldownDuration,console.log("Right stick pressed - resetting camera pitch to flat"),this.xrManager.onResetPitch()):o||(this.rightStickPressed=!1)}return this.leftThumbstickAxes.lengthSq()>.01?(this.thumbstickAxes.copy(this.leftThumbstickAxes),this.thumbstickAxes):(this.thumbstickAxes.set(0,0),this.thumbstickAxes)}getRightThumbstickAxes(){return this.rightThumbstickAxes}togglePaintMode(){this.isPaintMode=!this.isPaintMode,this.isPaintMode?(console.log("VR Paint mode: ON"),this.showColorPalette(),this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1),this.xrManager.updateTeleportTarget(null)):(console.log("VR Paint mode: OFF"),this.hideColorPalette())}createColorPalette(){this.colorPalette=new a.Group;const t=new a.SphereGeometry(.03,16,16),e=.08;this.paletteColors.forEach((i,o)=>{const s=new a.MeshBasicMaterial({color:i.hex}),n=new a.Mesh(t,s),r=Math.floor(o/3),c=o%3;n.position.set(c*e-e,-r*e,0),n.userData={isColorPicker:!0,colorIndex:o,colorHex:i.hex,colorName:i.name},this.colorPalette.add(n)}),this.colorPalette.position.set(.15,0,-.3),this.colorPalette.visible=!1,this.controller1&&this.controller1.add(this.colorPalette),console.log("VR color palette created")}showColorPalette(){this.colorPalette||this.createColorPalette(),this.colorPalette&&(this.colorPalette.visible=!0)}hideColorPalette(){this.colorPalette&&(this.colorPalette.visible=!1)}checkColorSelection(t){if(!this.isPaintMode||!this.colorPalette||!this.colorPalette.visible)return!1;const e=t===0?this.controller0:this.controller1;if(!e)return!1;const i=new a.Matrix4;i.identity().extractRotation(e.matrixWorld),this.raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(i);const o=this.raycaster.intersectObjects(this.colorPalette.children,!1);if(o.length>0){const s=o[0].object;if(s.userData.isColorPicker)return this.currentColorIndex=s.userData.colorIndex,console.log(`Selected color: ${s.userData.colorName}`),s.scale.set(1.3,1.3,1.3),setTimeout(()=>{s.scale.set(1,1,1)},200),!0}return!1}getRayForPainting(t){if(!this.isPaintMode)return null;const e=t===0?this.controller0:this.controller1;if(!e)return null;const i=new a.Matrix4;i.identity().extractRotation(e.matrixWorld);const o=new a.Vector3;o.setFromMatrixPosition(e.matrixWorld);const s=new a.Vector3(0,0,-1);return s.applyMatrix4(i).normalize(),{origin:o,direction:s}}raycastForTeleport(t){if(!t||this.groundMeshes.length===0)return null;const e=new a.Matrix4;e.identity().extractRotation(t.matrixWorld);const i=this.raycaster;i.ray.origin.setFromMatrixPosition(t.matrixWorld),i.ray.direction.set(0,0,-1).applyMatrix4(e);const o=i.intersectObjects(this.groundMeshes,!1);return o.length>0?o[0].point:null}update(t){if(this.isEnabled){if(this.isSqueezePressed?(this.squeezeHoldTime+=t,this.squeezeHoldTime>.4&&this.xrManager.onJetpackPressed(!0)):this.squeezeHoldTime=0,this.buttonACooldown>0&&(this.buttonACooldown-=t),this.buttonBCooldown>0&&(this.buttonBCooldown-=t),this.rightStickCooldown>0&&(this.rightStickCooldown-=t),this.isSelectPressed&&!this.isPaintMode){const e=this.raycastForTeleport(this.controller0);this.xrManager.updateTeleportTarget(e),this.rayLine0&&this.rayLine0.material.color.setHex(e?65280:16711680)}else this.xrManager.updateTeleportTarget(null);this.getThumbstickAxes()}}setGroundMeshes(t){this.groundMeshes=t}dispose(){this.rayLine0&&(this.rayLine0.geometry.dispose(),this.rayLine0.material.dispose()),this.rayLine1&&(this.rayLine1.geometry.dispose(),this.rayLine1.material.dispose()),this.controller0&&(this.controller0.removeEventListener("selectstart",this.onSelectStart),this.controller0.removeEventListener("selectend",this.onSelectEnd),this.controller0.removeEventListener("squeezestart",this.onSqueezeStart),this.controller0.removeEventListener("squeezeend",this.onSqueezeEnd)),this.controller1&&(this.controller1.removeEventListener("selectstart",this.onSelectStart),this.controller1.removeEventListener("selectend",this.onSelectEnd),this.controller1.removeEventListener("squeezestart",this.onSqueezeStart),this.controller1.removeEventListener("squeezeend",this.onSqueezeEnd))}}class Ye{constructor(t,e,i){this.renderer=t,this.scene=e,this.characterModel=i,this.hand0=null,this.hand1=null,this.handModelFactory=new Ee,this.rightHandMesh=null,this.leftHandMesh=null,this.rightHandFallback=null,this.leftHandFallback=null,this.isEnabled=!1,this.handInputState={left:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null},right:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null}}}init(){this.hand0=this.renderer.xr.getHand(0),this.hand1=this.renderer.xr.getHand(1);try{this.rightHandMesh=this.handModelFactory.createHandModel(this.hand0,"mesh"),this.hand0.add(this.rightHandMesh),this.scene.add(this.hand0)}catch{console.warn("Hand tracking model 0 not available, using fallback")}try{this.leftHandMesh=this.handModelFactory.createHandModel(this.hand1,"mesh"),this.hand1.add(this.leftHandMesh),this.scene.add(this.hand1)}catch{console.warn("Hand tracking model 1 not available, using fallback")}this.createFallbackHands(),console.log("XR Hands initialized")}createFallbackHands(){const t=new a.Group,e=new a.SphereGeometry(.04,16,16),i=new a.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),o=new a.Mesh(e,i);t.add(o);const s=new a.CylinderGeometry(.01,.01,.08,8),n=new a.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),r=new a.Mesh(s,n);r.position.set(0,0,-.06),r.rotation.x=Math.PI/2,t.add(r);const c=new a.SphereGeometry(.012,8,8),h=new a.Mesh(c,n);h.position.set(0,0,-.1),t.add(h),this.rightHandFallback=t,this.rightHandFallback.visible=!1,this.scene.add(this.rightHandFallback);const u=t.clone();this.leftHandFallback=u,this.leftHandFallback.visible=!1,this.scene.add(this.leftHandFallback)}enable(){this.isEnabled=!0,this.hand0||this.init(),this.updateFallbackVisibility()}disable(){this.isEnabled=!1,this.rightHandFallback&&(this.rightHandFallback.visible=!1),this.leftHandFallback&&(this.leftHandFallback.visible=!1)}updateFallbackVisibility(){if(!this.isEnabled)return;const t=this.renderer.xr.getSession();if(!t)return;let e=!1;for(const i of t.inputSources)if(i.hand){e=!0;break}this.rightHandFallback&&(this.rightHandFallback.visible=this.isEnabled&&!e),this.leftHandFallback&&(this.leftHandFallback.visible=this.isEnabled&&!e)}update(){if(this.isEnabled){if(this.updateFallbackVisibility(),this.rightHandFallback&&this.rightHandFallback.visible){const t=this.renderer.xr.getController(0);t&&(this.rightHandFallback.position.copy(t.position),this.rightHandFallback.quaternion.copy(t.quaternion))}if(this.leftHandFallback&&this.leftHandFallback.visible){const t=this.renderer.xr.getController(1);t&&(this.leftHandFallback.position.copy(t.position),this.leftHandFallback.quaternion.copy(t.quaternion))}}}animateGrip(t,e){const i=t===0?this.rightHandFallback:this.leftHandFallback;if(!i||!i.visible)return;const o=i.children[1];o&&(o.scale.y=1-e*.3)}getJointPosition(t,e){if(!t)return null;const i=t.get(e);if(!i)return null;const o=this.renderer.xr.getFrame(),s=this.renderer.xr.getReferenceSpace();if(!o||!s)return null;const n=o.getJointPose(i,s);return n?new a.Vector3().setFromMatrixPosition(new a.Matrix4().fromArray(n.transform.matrix)):null}getPinchDistance(t){const e=this.getJointPosition(t,"thumb-tip"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:e.distanceTo(i)}getPointingDirection(t){const e=this.getJointPosition(t,"wrist"),i=this.getJointPosition(t,"index-finger-tip");return!e||!i?null:new a.Vector3().subVectors(i,e).normalize()}getPalmNormal(t){if(!t)return null;const e=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(!e||!i)return null;const o=t.get("wrist");if(!o)return null;const s=e.getJointPose(o,i);if(!s)return null;const n=new a.Matrix4().fromArray(s.transform.matrix),r=new a.Vector3(0,1,0);return r.applyMatrix4(n),r.sub(new a.Vector3().setFromMatrixPosition(n)),r.normalize()}resetGestureState(t){t!=="left"&&t!=="right"||(this.handInputState[t]={isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null})}resetAllGestureStates(){this.resetGestureState("left"),this.resetGestureState("right")}dispose(){this.resetAllGestureStates(),this.rightHandFallback&&(this.scene.remove(this.rightHandFallback),this.rightHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.leftHandFallback&&(this.scene.remove(this.leftHandFallback),this.leftHandFallback.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})),this.hand0&&this.scene.remove(this.hand0),this.hand1&&this.scene.remove(this.hand1)}}const Ue=.015,qe=300,_e=500,Ke=.003,jt=.3,Ze=.6,Qe=600,S={IDLE:"idle",PAINTING:"painting",MOVING:"moving",JETPACK:"jetpack",MOVING_JETPACK:"moving_jetpack",TELEPORTING:"teleporting"};class ti{constructor(t,e,i=null){this.xrHands=t,this.xrManager=e,this.wristPalette=i,this.mode=S.IDLE,this.activePainterHand=null,this.paintModeEnabled=!1,this.isTeleporting=!1,this.callbacks={onPaintStart:null,onPaintDrag:null,onPaintEnd:null,onMovementStart:null,onMovementUpdate:null,onMovementEnd:null,onJetpackStart:null,onJetpackEnd:null,onColorSelect:null,onTeleportStart:null,onTeleportUpdate:null,onTeleportEnd:null,onTogglePaintMode:null},this.selectedColorIndex=6,console.log("GestureDetector initialized with proven LDIPlayer patterns")}setWristPalette(t){this.wristPalette=t}update(t,e){if(t){for(const i of t.inputSources)if(i.hand){const o=i.hand,s=i.handedness;if(s!=="left"&&s!=="right")continue;this.updateHandGestures(o,s,e)}this.updateMode(e)}}updateHandGestures(t,e,i){const o=this.xrHands.handInputState[e],s=this.xrHands.getPinchDistance(t);if(s===null)return;const n=performance.now();if(s<Ue)if(o.isPinching)this.onPinchSustain(t,e,o,i);else{o.isPinching=!0,o.pinchStartTime=n;const r=this.xrHands.getJointPosition(t,"index-finger-tip");r&&(o.dragStartPosition={x:r.x,y:r.y,z:r.z}),this.onPinchStart(t,e,i)}else if(o.isPinching){const r=n-o.pinchStartTime;this.onPinchRelease(t,e,o,r,n),o.isPinching=!1,o.dragStartPosition=null}}onPinchStart(t,e,i){console.log(`${e} pinch start`),this.mode,S.IDLE}onPinchSustain(t,e,i,o){const s=this.xrHands.getJointPosition(t,"index-finger-tip");if(!s||!i.dragStartPosition)return;const n=s.x-i.dragStartPosition.x,r=s.y-i.dragStartPosition.y,c=s.z-i.dragStartPosition.z,h=Math.sqrt(n*n+r*r+c*c);if(e==="left"&&!this.paintModeEnabled){const u=this.xrHands.getJointPosition(t,"wrist");if(u&&s){const f=u.clone(),p=new a.Vector3().subVectors(s,u).normalize();this.isTeleporting?this.callbacks.onTeleportUpdate&&this.callbacks.onTeleportUpdate(f,p):(this.isTeleporting=!0,this.mode=S.TELEPORTING,console.log("LEFT hand teleportation started"),this.callbacks.onTeleportStart&&this.callbacks.onTeleportStart(f,p))}return}h>Ke&&(this.mode===S.IDLE&&this.paintModeEnabled&&this.activePainterHand===null&&this.startPainting(t,e),this.mode===S.PAINTING&&this.activePainterHand===e&&this.updatePainting(t,e))}onPinchRelease(t,e,i,o,s){if(console.log(`${e} pinch release (duration: ${o}ms)`),e==="left"&&this.isTeleporting){const n=this.xrHands.getJointPosition(t,"wrist"),r=this.xrHands.getJointPosition(t,"index-finger-tip");if(n&&r){const c=n.clone(),h=new a.Vector3().subVectors(r,n).normalize();console.log("LEFT hand teleportation executed"),this.callbacks.onTeleportEnd&&this.callbacks.onTeleportEnd(c,h)}this.isTeleporting=!1,this.mode=S.IDLE;return}o<qe?(s-i.lastTapTime<_e?(i.tapCount++,console.log(`${e} double-tap detected (count: ${i.tapCount})`),this.onDoubleTap(e)):(i.tapCount=1,console.log(`${e} tap 1/2`),this.onSingleTap(t,e)),i.lastTapTime=s):(console.log(`${e} hold/drag end (duration: ${o}ms)`),this.mode===S.PAINTING&&this.activePainterHand===e&&this.endPainting(e),this.mode===S.JETPACK&&e==="right"&&this.endJetpack(e))}onSingleTap(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),o=this.xrHands.getJointPosition(t,"index-finger-tip");if(!i||!o)return;const s=i.clone(),n=new a.Vector3().subVectors(o,i).normalize();if(this.wristPalette&&this.wristPalette.checkToggleButtonHover(s,n)){const r=this.wristPalette.togglePaintMode();this.paintModeEnabled=r,this.callbacks.onTogglePaintMode&&this.callbacks.onTogglePaintMode(r),console.log(`Paint mode toggled via wrist button: ${r?"ON":"OFF"}`);return}if(this.paintModeEnabled&&this.callbacks.onColorSelect){this.callbacks.onColorSelect(s,n);return}}onDoubleTap(t){console.log(`${t} double-tap action`)}startPainting(t,e){this.mode=S.PAINTING,this.activePainterHand=e;const i=this.xrHands.getJointPosition(t,"wrist"),o=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&o){const s=i.clone(),n=new a.Vector3().subVectors(o,i).normalize();console.log(`Painting started with ${e} hand`),this.callbacks.onPaintStart&&this.callbacks.onPaintStart(e,s,n)}}updatePainting(t,e){const i=this.xrHands.getJointPosition(t,"wrist"),o=this.xrHands.getJointPosition(t,"index-finger-tip");if(i&&o){const s=i.clone(),n=new a.Vector3().subVectors(o,i).normalize();this.callbacks.onPaintDrag&&this.callbacks.onPaintDrag(e,s,n)}}endPainting(t){console.log(`Painting ended with ${t} hand`),this.mode=S.IDLE,this.activePainterHand=null,this.callbacks.onPaintEnd&&this.callbacks.onPaintEnd(t)}startJetpack(t){this.mode===S.MOVING?this.mode=S.MOVING_JETPACK:this.mode=S.JETPACK,console.log(`Jetpack started with ${t} hand`),this.callbacks.onJetpackStart&&this.callbacks.onJetpackStart(t)}endJetpack(t){console.log(`Jetpack ended with ${t} hand`),this.mode===S.MOVING_JETPACK?this.mode=S.MOVING:this.mode=S.IDLE,this.callbacks.onJetpackEnd&&this.callbacks.onJetpackEnd(t)}updateMode(t){this.mode!==S.PAINTING&&this.checkMovementGesture(t),this.mode!==S.PAINTING&&this.checkJetpackGesture()}checkMovementGesture(t){const e=this.xrManager.renderer.xr.getSession();if(!e){console.log("[Movement] No XR session");return}let i=null;for(const r of e.inputSources)if(r.hand&&r.handedness==="left"){i=r.hand;break}if(!i){console.log("[Movement] No left hand found");return}const o=this.xrHands.getJointPosition(i,"wrist"),s=this.xrHands.getJointPosition(i,"index-finger-tip");if(!o||!s||!t){console.log("[Movement] Missing joint positions - wrist:",!!o,"indexTip:",!!s,"camera:",!!t);return}const n=o.distanceTo(t);if(console.log(`[Movement] Extension distance: ${n.toFixed(3)}m (min: ${jt}m)`),n>=jt){const r=new a.Vector3().subVectors(s,o).normalize();r.y=0,r.normalize();const c=Math.min((n-jt)/(Ze-jt),1);if(console.log(`[Movement] Hand extended! Speed: ${c.toFixed(2)}, Mode: ${this.mode}`),this.mode===S.IDLE||this.mode===S.JETPACK){const h=this.mode===S.JETPACK?S.MOVING_JETPACK:S.MOVING;this.mode=h,console.log(`[Movement] Started - New mode: ${h}`),this.callbacks.onMovementStart&&this.callbacks.onMovementStart(r,c)}else(this.mode===S.MOVING||this.mode===S.MOVING_JETPACK)&&this.callbacks.onMovementUpdate&&this.callbacks.onMovementUpdate(r,c)}else console.log("[Movement] Hand not extended enough"),this.mode===S.MOVING?(this.mode=S.IDLE,console.log("[Movement] Ended - Mode: IDLE"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd()):this.mode===S.MOVING_JETPACK&&(this.mode=S.JETPACK,console.log("[Movement] Ended - Mode: JETPACK"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd())}checkJetpackGesture(){const t=this.xrHands.handInputState.right,e=performance.now();if(!(this.mode===S.TELEPORTING||this.mode===S.PAINTING)&&t.isPinching){const i=e-t.pinchStartTime;i>=Qe&&this.mode!==S.JETPACK&&this.mode!==S.MOVING_JETPACK&&(console.log(`RIGHT hand jetpack activated (hold duration: ${i}ms)`),this.startJetpack("right"))}}isLeftPalmFacingUser(t){const e=this.xrManager.renderer.xr.getSession();if(!e)return!1;let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i)return!1;const o=this.xrHands.getPalmNormal(i),s=this.xrHands.getJointPosition(i,"wrist");if(!o||!s||!t)return!1;const n=new a.Vector3().subVectors(t,s).normalize();return o.dot(n)>.5}reset(){this.mode=S.IDLE,this.activePainterHand=null,this.xrHands.resetAllGestureStates(),console.log("GestureDetector reset")}on(t,e){this.callbacks.hasOwnProperty("on"+t.charAt(0).toUpperCase()+t.slice(1))&&(this.callbacks["on"+t.charAt(0).toUpperCase()+t.slice(1)]=e)}}class ei{constructor(t,e){this.scene=t,this.xrHands=e,this.colors=[{hex:16711680,name:"Red"},{hex:16746496,name:"Orange"},{hex:16776960,name:"Yellow"},{hex:65280,name:"Green"},{hex:65535,name:"Cyan"},{hex:255,name:"Blue"},{hex:8913151,name:"Purple"},{hex:16711935,name:"Magenta"},{hex:16777215,name:"White"},{hex:8947848,name:"Gray"},{hex:0,name:"Black"},{hex:8930304,name:"Brown"}],this.spheres=[],this.selectedIndex=6,this.hoveredIndex=-1,this.toggleButton=null,this.toggleButtonHovered=!1,this.paintModeEnabled=!1,this.paletteGroup=null,this.isVisible=!1,this.sphereRadius=.015,this.arcRadius=.12,this.arcSpan=Math.PI/2,this.rows=3,this.cols=4,this.createPalette()}createPalette(){this.paletteGroup=new a.Group,this.paletteGroup.visible=!1;let t=0;for(let r=0;r<this.rows;r++)for(let c=0;c<this.cols&&!(t>=this.colors.length);c++){const h=this.colors[t],u=new a.SphereGeometry(this.sphereRadius,16,16),f=new a.MeshStandardMaterial({color:h.hex,roughness:.3,metalness:.1,emissive:h.hex,emissiveIntensity:.2}),p=new a.Mesh(u,f),b=(c/(this.cols-1)-.5)*this.arcSpan,P=(r-(this.rows-1)/2)*(this.sphereRadius*3);p.position.x=Math.sin(b)*this.arcRadius,p.position.y=P,p.position.z=-Math.cos(b)*this.arcRadius,p.userData.colorIndex=t,p.userData.colorHex=h.hex,p.userData.colorName=h.name,this.spheres.push(p),this.paletteGroup.add(p),t++}const e=new a.RingGeometry(this.sphereRadius*1.2,this.sphereRadius*1.5,32),i=new a.MeshBasicMaterial({color:16777215,side:a.DoubleSide,transparent:!0,opacity:.8});this.selectionRing=new a.Mesh(e,i),this.selectionRing.visible=!1,this.paletteGroup.add(this.selectionRing);const o=this.sphereRadius*2.5,s=new a.SphereGeometry(o,16,16),n=new a.MeshStandardMaterial({color:16711680,roughness:.3,metalness:.1,emissive:16711680,emissiveIntensity:.3});this.toggleButton=new a.Mesh(s,n),this.toggleButton.position.set(0,this.sphereRadius*6,0),this.toggleButton.userData.isToggleButton=!0,this.paletteGroup.add(this.toggleButton),this.scene.add(this.paletteGroup),console.log("WristPalette created with",this.colors.length,"colors and toggle button")}update(t){const e=this.xrHands.renderer.xr.getSession();if(!e){this.hide();return}let i=null;for(const c of e.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i){this.hide();return}const o=this.xrHands.getJointPosition(i,"wrist"),s=this.xrHands.getPalmNormal(i);if(!o||!s||!t){this.hide();return}const n=new a.Vector3().subVectors(t,o).normalize();if(s.dot(n)>.5){this.show(),this.paletteGroup.position.copy(o),this.paletteGroup.lookAt(t);const c=new a.Vector3().subVectors(t,o).normalize();this.paletteGroup.position.add(c.multiplyScalar(.05))}else this.hide()}checkHover(t,e){if(!this.isVisible)return null;const o=new a.Raycaster(t,e).intersectObjects(this.spheres);if(o.length>0){const s=o[0].object.userData.colorIndex;return this.setHovered(s),s}else return this.setHovered(-1),null}checkToggleButtonHover(t,e){if(!this.isVisible||!this.toggleButton)return!1;const s=new a.Raycaster(t,e).intersectObject(this.toggleButton).length>0;return s!==this.toggleButtonHovered&&(this.toggleButtonHovered=s,this.toggleButton&&(s?(this.toggleButton.scale.set(1.2,1.2,1.2),this.toggleButton.material.emissiveIntensity=.6):(this.toggleButton.scale.set(1,1,1),this.toggleButton.material.emissiveIntensity=.3))),s}togglePaintMode(){if(this.paintModeEnabled=!this.paintModeEnabled,this.toggleButton){const t=this.paintModeEnabled?65280:16711680;this.toggleButton.material.color.setHex(t),this.toggleButton.material.emissive.setHex(t),this.toggleButton.scale.set(1.4,1.4,1.4),setTimeout(()=>{this.toggleButton.scale.set(1,1,1)},100)}return console.log(`Paint mode toggled: ${this.paintModeEnabled?"ON":"OFF"}`),this.paintModeEnabled}getPaintModeEnabled(){return this.paintModeEnabled}setHovered(t){if(this.hoveredIndex!==t){if(this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1,1,1),e.material.emissiveIntensity=.2}if(this.hoveredIndex=t,this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const e=this.spheres[this.hoveredIndex];e.scale.set(1.3,1.3,1.3),e.material.emissiveIntensity=.6}}}selectColor(t){if(t<0||t>=this.colors.length)return;this.selectedIndex=t,console.log("Selected color:",this.colors[t].name);const e=this.spheres[t];this.selectionRing.position.copy(e.position),this.selectionRing.lookAt(this.paletteGroup.position),this.selectionRing.visible=this.isVisible;const i=e.scale.clone();e.scale.set(1.5,1.5,1.5),setTimeout(()=>{e.scale.copy(i)},100)}getSelectedColor(){return this.colors[this.selectedIndex]}show(){if(!this.isVisible&&(this.paletteGroup.visible=!0,this.selectionRing.visible=!0,this.isVisible=!0,this.selectedIndex>=0&&this.selectedIndex<this.spheres.length)){const t=this.spheres[this.selectedIndex];this.selectionRing.position.copy(t.position),this.selectionRing.lookAt(this.paletteGroup.position)}}hide(){this.isVisible&&(this.paletteGroup.visible=!1,this.selectionRing.visible=!1,this.isVisible=!1,this.setHovered(-1))}dispose(){this.spheres.forEach(t=>{t.geometry.dispose(),t.material.dispose()}),this.selectionRing&&(this.selectionRing.geometry.dispose(),this.selectionRing.material.dispose()),this.toggleButton&&(this.toggleButton.geometry.dispose(),this.toggleButton.material.dispose()),this.paletteGroup&&this.scene.remove(this.paletteGroup)}}class ii{constructor(t){this.scene=t,this.paintRays={left:null,right:null},this.movementArrow=null,this.jetpackGlows={left:null,right:null},this.createVisuals()}createVisuals(){this.createPaintRays(),this.createMovementArrow(),this.createJetpackGlows()}createPaintRays(){const t=()=>{const e=new a.BufferGeometry,i=new Float32Array([0,0,0,0,0,-5]);e.setAttribute("position",new a.BufferAttribute(i,3));const o=new a.LineBasicMaterial({color:65280,transparent:!0,opacity:.6,linewidth:2}),s=new a.Line(e,o);return s.visible=!1,this.scene.add(s),s};this.paintRays.left=t(),this.paintRays.right=t()}createMovementArrow(){const t=new a.Group,e=new a.CylinderGeometry(.02,.02,.4,8),i=new a.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),o=new a.Mesh(e,i);o.rotation.z=-Math.PI/2,t.add(o);const s=new a.ConeGeometry(.05,.1,8),n=new a.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),r=new a.Mesh(s,n);r.rotation.z=-Math.PI/2,r.position.x=.25,t.add(r),t.visible=!1,this.scene.add(t),this.movementArrow=t}createJetpackGlows(){const t=()=>{const e=new a.SphereGeometry(.06,16,16),i=new a.MeshBasicMaterial({color:65280,transparent:!0,opacity:.5}),o=new a.Mesh(e,i);return o.visible=!1,this.scene.add(o),o};this.jetpackGlows.left=t(),this.jetpackGlows.right=t()}updatePaintRay(t,e,i,o=!0){const s=this.paintRays[t];if(s)if(o&&e&&i){s.visible=!0,s.position.copy(e);const n=new a.Vector3().copy(e).add(i.clone().multiplyScalar(5));s.lookAt(n);const r=s.geometry.attributes.position.array;r[3]=0,r[4]=0,r[5]=-5,s.geometry.attributes.position.needsUpdate=!0}else s.visible=!1}updateMovementArrow(t,e,i,o=!0){if(this.movementArrow)if(o&&t&&e&&i>0){this.movementArrow.visible=!0,this.movementArrow.position.copy(t),this.movementArrow.position.y=t.y-1.3;const s=new a.Vector3().copy(t).add(e);s.y=this.movementArrow.position.y,this.movementArrow.lookAt(s);const n=.5+i*.5;this.movementArrow.scale.set(n,n,n),this.movementArrow.children.forEach(r=>{r.material&&(r.material.opacity=.4+i*.3)})}else this.movementArrow.visible=!1}updateJetpackGlow(t,e,i=!0){const o=this.jetpackGlows[t];if(o)if(i&&e){o.visible=!0,o.position.copy(e);const s=performance.now()*.005,n=.8+Math.sin(s)*.2;o.scale.set(n,n,n),o.material.opacity=.3+Math.sin(s*2)*.2}else o.visible=!1}hidePaintRays(){this.paintRays.left.visible=!1,this.paintRays.right.visible=!1}hideMovementArrow(){this.movementArrow&&(this.movementArrow.visible=!1)}hideJetpackGlows(){this.jetpackGlows.left.visible=!1,this.jetpackGlows.right.visible=!1}hideAll(){this.hidePaintRays(),this.hideMovementArrow(),this.hideJetpackGlows()}dispose(){Object.values(this.paintRays).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))}),this.movementArrow&&(this.movementArrow.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.scene.remove(this.movementArrow)),Object.values(this.jetpackGlows).forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose(),this.scene.remove(t))})}}class oi{constructor(t,e,i,o=30){this.splatMesh=t,this.camera=e,this.renderer=i,this.targetFPS=o,this.boundingBox=null,this.splatExtent=1,this.currentLODLevel=0,this.frameCount=0,this.lastTime=performance.now(),this.fps=60,this.fpsHistory=[],this.manualMode=!1,this.lodConfigs=[{name:"Ultra",distMult:10,skipFactor:1,pixelRatio:2},{name:"High",distMult:3,skipFactor:1,pixelRatio:1.5},{name:"Medium",distMult:2,skipFactor:2,pixelRatio:1.5},{name:"Low",distMult:1.5,skipFactor:2,pixelRatio:1},{name:"Potato",distMult:1,skipFactor:4,pixelRatio:1}],this.maxDistanceUniform=new x.DynoFloat({value:1e3}),this.skipFactorUniform=new x.DynoInt({value:1}),this.originalPixelRatio=this.renderer.getPixelRatio(),this.splatMesh.addEventListener("initialized",()=>{this.calculateExtent(),this.setupModifier(),console.log(`[DistanceBasedLOD] Initialized - Extent: ${this.splatExtent.toFixed(2)} units, Starting at ${this.getCurrentLODName()}`)})}calculateExtent(){this.boundingBox=this.splatMesh.getBoundingBox(!0);const t=new a.Vector3;this.boundingBox.getSize(t),this.splatExtent=t.length(),console.log(`[DistanceBasedLOD] Splat extent: ${this.splatExtent.toFixed(2)} units`),this.updateLODLevel(this.currentLODLevel)}setupModifier(){this.splatMesh.worldModifier=x.dynoBlock({gsplat:x.Gsplat},{gsplat:x.Gsplat},({gsplat:t})=>(t=new x.Dyno({inTypes:{gsplat:x.Gsplat,maxDist:"float",skipFactor:"int",cameraPos:"vec3"},outTypes:{gsplat:x.Gsplat},statements:({inputs:i,outputs:o})=>{const{gsplat:s,maxDist:n,skipFactor:r,cameraPos:c}=i,{gsplat:h}=o;return x.unindentLines(`
                            ${h} = ${s};

                            // Distance-based culling (world-space)
                            float distance = length(${h}.center - ${c});
                            if (distance > ${n}) {
                                ${h}.flags = 0u; // Mark as inactive (culled)
                            }

                            // Index-based subsampling for additional decimation
                            // Skip every N splats to reduce render load
                            if (${r} > 1 && ${s}.index % ${r} != 0) {
                                ${h}.flags = 0u;
                            }
                        `)}}).apply({gsplat:t,maxDist:this.maxDistanceUniform,skipFactor:this.skipFactorUniform,cameraPos:x.dynoUniform("vec3","cameraPosition")}).gsplat,{gsplat:t})),console.log("[DistanceBasedLOD] Distance-based worldModifier shader installed")}update(){this.frameCount++;const t=performance.now();if(t>=this.lastTime+1e3){this.fps=Math.round(this.frameCount*1e3/(t-this.lastTime)),this.frameCount=0,this.lastTime=t,this.fpsHistory.push(this.fps),this.fpsHistory.length>3&&this.fpsHistory.shift();const e=this.fpsHistory.reduce((i,o)=>i+o,0)/this.fpsHistory.length;this.manualMode||this.adjustLOD(e)}}adjustLOD(t){this.currentLODLevel,t<this.targetFPS-5&&this.currentLODLevel<this.lodConfigs.length-1&&(this.currentLODLevel++,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] â†“ Reduced to: ${this.getCurrentLODName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`)),t>this.targetFPS+5*2&&this.currentLODLevel>0&&(this.currentLODLevel--,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] â†‘ Increased to: ${this.getCurrentLODName()} (FPS: ${t.toFixed(1)} / Target: ${this.targetFPS})`))}updateLODLevel(t){this.currentLODLevel=Math.max(0,Math.min(this.lodConfigs.length-1,t));const e=this.lodConfigs[this.currentLODLevel];this.maxDistanceUniform.value=this.splatExtent*e.distMult,this.skipFactorUniform.value=e.skipFactor;const i=Math.min(this.originalPixelRatio,e.pixelRatio);this.renderer.setPixelRatio(i),console.log(`[DistanceBasedLOD] LOD: ${e.name}, Distance: ${this.maxDistanceUniform.value.toFixed(2)} units, Skip: ${e.skipFactor}, PixelRatio: ${i.toFixed(1)}`)}increaseLOD(){this.currentLODLevel>0&&(this.manualMode=!0,this.currentLODLevel--,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] Manual increase to: ${this.getCurrentLODName()} (Adaptive DISABLED)`))}decreaseLOD(){this.currentLODLevel<this.lodConfigs.length-1&&(this.manualMode=!0,this.currentLODLevel++,this.updateLODLevel(this.currentLODLevel),console.log(`[DistanceBasedLOD] Manual decrease to: ${this.getCurrentLODName()} (Adaptive DISABLED)`))}resumeAdaptive(){this.manualMode=!1,console.log("[DistanceBasedLOD] Resumed adaptive LOD adjustment"),console.log(`[DistanceBasedLOD] Current LOD: ${this.getCurrentLODName()} (will adjust based on FPS)`)}setTargetFPS(t){if(t!==this.targetFPS){const e=this.targetFPS;this.targetFPS=t,this.fpsHistory=[],console.log(`[DistanceBasedLOD] Target FPS changed: ${e} â†’ ${t}`)}}getFPS(){return this.fps}getCurrentLODName(){return this.lodConfigs[this.currentLODLevel].name}getCurrentLODLevel(){return this.currentLODLevel}getLODConfigs(){return this.lodConfigs.map(t=>t.name)}isManualMode(){return this.manualMode}getSplatExtent(){return this.splatExtent}getStats(){const t=this.lodConfigs[this.currentLODLevel];return{fps:this.fps,lodName:t.name,lodLevel:this.currentLODLevel,maxDistance:this.maxDistanceUniform.value.toFixed(2),skipFactor:t.skipFactor,pixelRatio:this.renderer.getPixelRatio().toFixed(1),targetFPS:this.targetFPS,splatExtent:this.splatExtent.toFixed(2)}}}class si{constructor(){this.currentSiteId=null,this.urlParams=new URLSearchParams(window.location.search)}hasSiteParameter(){return this.urlParams.has("site")}getSiteFromURL(){return this.urlParams.get("site")}isValidSite(t,e){return!t||!e?!1:e.some(i=>i.id===t)}shouldShowGlobe(t){const e=this.getSiteFromURL();return e?this.isValidSite(e,t)?(this.currentSiteId=e,!1):(console.warn(`Invalid site parameter: ${e}. Showing globe.`),!0):!0}navigateToSite(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.location.href=i}navigateToGlobe(){window.location.href=window.location.pathname}getCurrentSiteId(){return this.currentSiteId||this.getSiteFromURL()}updateURLWithoutReload(t){const e=new URLSearchParams(window.location.search);e.set("site",t);const i=`${window.location.pathname}?${e.toString()}`;window.history.pushState({siteId:t},"",i)}}class ni{constructor(t,e){this.container=t,this.onSiteSelected=e,this.scene=null,this.camera=null,this.renderer=null,this.labelRenderer=null,this.controls=null,this.earth=null,this.atmosphere=null,this.markers=[],this.raycaster=new a.Raycaster,this.mouse=new a.Vector2,this.hoveredMarker=null,this.animationId=null,this.isInitialized=!1}latLongToVector3(t,e,i){const o=(90-t)*(Math.PI/180),s=(e+180)*(Math.PI/180);return new a.Vector3(-i*Math.sin(o)*Math.cos(s),i*Math.cos(o),i*Math.sin(o)*Math.sin(s))}async init(t){if(this.isInitialized)return;this.scene=new a.Scene,this.scene.background=new a.Color(1296);const e=window.innerWidth/window.innerHeight;this.camera=new a.PerspectiveCamera(45,e,.1,1e3);const n=this.latLongToVector3(45,10,12);this.camera.position.copy(n),this.camera.lookAt(0,0,0),this.renderer=new a.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.labelRenderer=new Le,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0",this.labelRenderer.domElement.style.pointerEvents="none",this.container.appendChild(this.labelRenderer.domElement);const r=new a.AmbientLight(16777215,.4);this.scene.add(r);const c=new a.DirectionalLight(16777215,.8);c.position.set(5,3,5),this.scene.add(c),await this.createEarth(),this.createAtmosphere(),this.createSiteMarkers(t),this.controls=new Re(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.minDistance=7,this.controls.maxDistance=20,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.addEventListeners(),this.isInitialized=!0,this.animate()}async createEarth(){const t=new a.SphereGeometry(5,64,64),e=new a.TextureLoader,i=await new Promise((s,n)=>{e.load("models/textures/earth_day.jpg",s,void 0,n)}),o=new a.MeshStandardMaterial({map:i,roughness:.9,metalness:.1});this.earth=new a.Mesh(t,o),this.scene.add(this.earth)}createAtmosphere(){const t=new a.SphereGeometry(5.2,64,64),e=new a.ShaderMaterial({vertexShader:`
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
                }
            `,blending:a.AdditiveBlending,side:a.BackSide,transparent:!0});this.atmosphere=new a.Mesh(t,e),this.scene.add(this.atmosphere)}positionLabelsWithCollisionAvoidance(t,e=8,i=1.5){const o=t.map(r=>this.latLongToVector3(r.latitude,r.longitude,e)),s=50,n=.5;for(let r=0;r<s;r++){let c=!1;for(let h=0;h<o.length;h++)for(let u=h+1;u<o.length;u++){const f=o[h].distanceTo(o[u]);if(f<i){const p=new a.Vector3().subVectors(o[h],o[u]).normalize(),b=(i-f)*n;o[h].add(p.clone().multiplyScalar(b)),o[u].sub(p.clone().multiplyScalar(b)),c=!0}}if(o.forEach(h=>{h.normalize().multiplyScalar(e)}),!c){console.log(`Label positioning converged in ${r+1} iterations`);break}}return o}createConnectingLine(t,e){const i=[t,e],o=new a.BufferGeometry().setFromPoints(i),s=new a.LineBasicMaterial({color:16777215,opacity:.5,transparent:!0,linewidth:1});return new a.Line(o,s)}createSiteMarkers(t){const o=this.positionLabelsWithCollisionAvoidance(t,6.5);t.forEach((s,n)=>{const r=this.latLongToVector3(s.latitude,s.longitude,5.05),c=o[n],h=new a.SphereGeometry(.15,16,16),u=new a.MeshBasicMaterial({color:16737792,transparent:!0,opacity:0}),f=new a.Mesh(h,u);f.position.copy(r),f.userData={siteId:s.id,siteName:s.name},this.scene.add(f);const p=this.createLabelElement(s),b=new De(p);b.position.copy(c),b.userData={siteId:s.id},this.scene.add(b);const P=this.createConnectingLine(r,c);this.scene.add(P),this.markers.push({mesh:f,label:b,line:P,site:s,sitePosition:r.clone(),labelPosition:c.clone()})})}createLabelElement(t){const e=document.createElement("div");e.className="globe-site-marker",e.style.pointerEvents="auto";const i=document.createElement("div");i.className="globe-thumbnail-container",i.style.width="80px",i.style.height="80px",i.style.borderRadius="50%",i.style.border="3px solid #ff6600",i.style.marginBottom="8px",i.style.overflow="hidden",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.boxShadow="0 0 20px rgba(255, 102, 0, 0.6)",i.style.transition="border-color 0.2s ease, box-shadow 0.2s ease";const o=document.createElement("img");o.src=t.thumbnail||"models/thumbnails/placeholder.jpg",o.alt=t.name,o.style.width="120px",o.style.height="120px",o.style.objectFit="cover",o.style.display="block",i.appendChild(o);const s=document.createElement("span");return s.textContent=t.name,s.style.color="#ffffff",s.style.fontSize="14px",s.style.fontWeight="bold",s.style.textShadow="0 0 10px rgba(0, 0, 0, 0.8)",s.style.display="block",s.style.textAlign="center",e.appendChild(i),e.appendChild(s),e.style.cursor="pointer",e.style.transition="transform 0.2s ease",e.dataset.siteId=t.id,e}addEventListeners(){window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("click",this.onClick.bind(this)),window.addEventListener("touchend",this.onTouch.bind(this)),window.addEventListener("resize",this.onWindowResize.bind(this))}onMouseMove(t){var o,s;this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-(t.clientY/window.innerHeight)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(n=>n.mesh),i=this.raycaster.intersectObjects(e);if(this.hoveredMarker){const n=(o=this.markers.find(r=>r.mesh===this.hoveredMarker))==null?void 0:o.label;n&&(n.element.style.transform="scale(1)"),this.hoveredMarker=null}if(i.length>0){this.hoveredMarker=i[0].object;const n=(s=this.markers.find(r=>r.mesh===this.hoveredMarker))==null?void 0:s.label;n&&(n.element.style.transform="scale(1.2)"),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onTouch(t){const e=t.changedTouches[0],i=document.elementFromPoint(e.clientX,e.clientY);if(i&&i.closest(".globe-site-marker")){const s=i.closest(".globe-site-marker").dataset.siteId;s&&this.onSiteSelected&&(console.log("Touch site selected:",s),this.onSiteSelected(s),t.preventDefault())}}onClick(t){if(t.target.closest(".globe-site-marker")){const s=t.target.closest(".globe-site-marker").dataset.siteId;s&&this.onSiteSelected&&this.onSiteSelected(s);return}this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.markers.map(o=>o.mesh),i=this.raycaster.intersectObjects(e);if(i.length>0){const o=i[0].object.userData.siteId;o&&this.onSiteSelected&&this.onSiteSelected(o)}}onWindowResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.labelRenderer.setSize(t,e)}animate(){this.animationId=requestAnimationFrame(this.animate.bind(this)),this.controls&&this.controls.update(),this.updateConnectingLines(),this.renderer&&this.scene&&this.camera&&(this.renderer.render(this.scene,this.camera),this.labelRenderer.render(this.scene,this.camera))}updateConnectingLines(){this.markers&&this.markers.forEach(t=>{if(t.line&&t.mesh&&t.label){const e=new a.Vector3;t.mesh.getWorldPosition(e);const i=t.label.position,o=t.line.geometry.attributes.position.array;o[0]=e.x,o[1]=e.y,o[2]=e.z,o[3]=i.x,o[4]=i.y,o[5]=i.z,t.line.geometry.attributes.position.needsUpdate=!0}})}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),window.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("click",this.onClick.bind(this)),window.removeEventListener("touchend",this.onTouch.bind(this)),window.removeEventListener("resize",this.onWindowResize.bind(this)),this.controls&&this.controls.dispose(),this.markers&&(this.markers.forEach(t=>{t.line&&(t.line.geometry&&t.line.geometry.dispose(),t.line.material&&t.line.material.dispose()),t.mesh&&(t.mesh.geometry&&t.mesh.geometry.dispose(),t.mesh.material&&t.mesh.material.dispose())}),this.markers=[]),this.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.renderer&&this.container.removeChild(this.renderer.domElement),this.labelRenderer&&this.container.removeChild(this.labelRenderer.domElement),this.isInitialized=!1}show(){this.container.style.display="block",setTimeout(()=>{this.container.classList.add("visible")},50)}hide(){this.container.classList.remove("visible"),setTimeout(()=>{this.container.style.display="none"},500)}}let wt=null,d=null,kt=null,ft=null,Qt=null,W,M,R,ot,T,v,B,D=null,U=null,It=null,z=null,rt=null,q=null,Pt=null,Ct=0,k,X,g=null,pt=1,_=null,ct=0,ie=2500,F=null,K=null,Tt=213,Et=37,Vt=180,zt=0,Bt=0,Rt=0,Lt=0,H=0,st=0,nt=0,at=0;const ai=new a.Clock;let he=60;const Zt=x.dynoFloat(0);let qt=0;const y={enabled:x.dynoBool(!1),brushRadius:x.dynoFloat(.05),brushDepth:x.dynoFloat(10),brushOrigin:x.dynoVec3(new a.Vector3(0,0,0)),brushDirection:x.dynoVec3(new a.Vector3(0,0,0)),brushColor:x.dynoVec3(new a.Vector3(1,0,1)),useSurface:x.dynoBool(!1),surfacePoint:x.dynoVec3(new a.Vector3(0,0,0)),surfaceRadius:x.dynoFloat(.2)},ri=.01,li=.25,ci=.1,hi=100;let J=!1,te=!1,Z=null,oe=!1;const O=function(){const l="ontouchstart"in window||navigator.maxTouchPoints>0,t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),e=l||t;return console.log("Mobile detection:",{touch:l,userAgent:t,isMobile:e}),e}(),Dt={},se=new Ie(O);let $=null,et="third-person",tt=0,Q=0,ne=!1;const de=.002,ue=.005,_t=Math.PI/2-.1;function re(l){for(;l>Math.PI;)l-=Math.PI*2;for(;l<-Math.PI;)l+=Math.PI*2;return l}let gt=!1,ut=0;const di=.5;let Wt=new a.Vector3,Mt=new a.Vector3,Yt=new a.Quaternion,Kt=new a.Quaternion,lt="third-person",Xt=0;const fe=.2;let ge=!1,xe=!1,Ot=!1,Gt=!1,bt=null,Jt=!1,j=null;function ui(){var i,o;W=new a.Scene;const l=((i=d==null?void 0:d.scene)==null?void 0:i.backgroundColor)||"#a8def0";W.background=new a.Color(l);const t=(d==null?void 0:d.camera)||{};M=new a.PerspectiveCamera(t.fov||60,window.innerWidth/window.innerHeight,t.near||.1,t.far||1e3),M.position.set(0,5,10),R=new a.WebGLRenderer({antialias:!1,powerPreference:"high-performance"}),R.setSize(window.innerWidth,window.innerHeight),R.setPixelRatio(O?1:Math.min(window.devicePixelRatio,2)),R.shadowMap.enabled=!0,R.shadowMap.type=a.PCFSoftShadowMap,document.body.appendChild(R.domElement),ot=new ke({renderer:R,maxStdDev:Math.sqrt(O?5:7),minPixelRadius:O?.5:.3,maxPixelRadius:O?256:384,minAlpha:O?1/255:.7/255,clipXY:O?1.6:2,falloff:O?.8:.95}),W.add(ot),O&&(ot.defaultView.sortDistance=.05,ot.defaultView.sortCoorient=.97,console.log("Mobile sorting optimizations applied")),Z=new a.Raycaster,fi();const e=((o=d==null?void 0:d.camera)==null?void 0:o.orbitControls)||{};T=new Fe(M,R.domElement),T.enableDamping=e.enableDamping!==void 0?e.enableDamping:!0,T.minDistance=e.minDistance||1,T.maxDistance=e.maxDistance||5,T.enablePan=e.enablePan!==void 0?e.enablePan:!1,T.maxPolarAngle=Math.PI*(e.maxPolarAngle||.55),T.update(),O&&($=new Ve(Dt,T),$.setFirstPersonCallback(Di),$.setPaintCallback(Pi),$.setPaintEndCallback(Ci),console.log("Touch controls initialized early (before character load)")),console.log("Scene initialized")}function fi(){var r,c;const l=((r=d==null?void 0:d.lighting)==null?void 0:r.ambient)||{};W.add(new a.AmbientLight(l.color||16777215,l.intensity!==void 0?l.intensity:.7));const t=((c=d==null?void 0:d.lighting)==null?void 0:c.directional)||{};K=new a.DirectionalLight(t.color||16777215,t.intensity!==void 0?t.intensity:1),K.castShadow=t.castShadow!==void 0?t.castShadow:!0;const e=t.shadowCamera||{};K.shadow.camera.top=e.top||50,K.shadow.camera.bottom=e.bottom||-50,K.shadow.camera.left=e.left||-50,K.shadow.camera.right=e.right||50,K.shadow.camera.near=e.near||.1,K.shadow.camera.far=e.far||200;const i=t.shadowMapSize,o=typeof i=="number"?i:2048,s=(i==null?void 0:i.width)||o,n=(i==null?void 0:i.height)||o;K.shadow.mapSize.width=s,K.shadow.mapSize.height=n,W.add(K),Ut()}function gi(){var e;const l=new be,t=((e=d==null?void 0:d.assets)==null?void 0:e.collisionFile)||"models/StoneHenge-collision.glb";l.load(t,i=>{var it,V,mt,Ht;let o;if(i.scene.traverse(N=>{N instanceof a.Mesh&&!o&&(o=N)}),!o){console.error("No mesh found in collision GLB file");return}const s=o,n=new a.MeshStandardMaterial({color:8421504,roughness:.8,metalness:.2,side:a.DoubleSide}),r=s.geometry;k=new a.Mesh(r,n),k.position.copy(s.position),k.rotation.copy(s.rotation),k.scale.copy(s.scale),k.applyMatrix4(i.scene.matrix),k.scale.multiplyScalar(pt),k.rotation.x+=Vt*(Math.PI/180),k.rotation.y+=zt*(Math.PI/180),k.rotation.z+=Bt*(Math.PI/180),k.position.y=0,k.receiveShadow=!0,k.castShadow=!0,k.visible=!1,W.add(k);try{r.boundingBox||r.computeBoundingBox();const N=r.boundingBox.clone();N.min.multiplyScalar(pt),N.max.multiplyScalar(pt);const yt=new a.Vector3(N.min.x,-N.max.y,N.min.z),Ft=new a.Vector3(N.max.x,-N.min.y,N.max.z);ct=Ft.y,console.log(`[Collision Mesh] World bounding box (at Y=0): min.y=${yt.y.toFixed(2)}, max.y=${Ft.y.toFixed(2)}`),console.log(`[Collision Mesh] maxTerrainHeight = ${ct.toFixed(2)} (highest walkable point after all transforms)`),nt=yt.y<0?-yt.y:0,at=Ft.y>0?-Ft.y:0,console.log(`[Height Offset Bounds] Calculated from worldBBox: min.y=${yt.y.toFixed(2)}, max.y=${Ft.y.toFixed(2)}`),console.log(`[Height Offset Bounds] Range: ${at.toFixed(2)} to ${nt.toFixed(2)} (scaled units)`)}catch(N){console.error("[Collision Mesh] Failed to calculate bounds:",N),ct=100,nt=0,at=-100}st==="max"?(H=nt,console.log(`[Height Offset] Resolved "max" to ${H.toFixed(2)}`)):st==="min"&&(H=at,console.log(`[Height Offset] Resolved "min" to ${H.toFixed(2)}`)),Bi(),k.position.y=H;const c=new a.PlaneGeometry(1e4,1e4),h=new a.TextureLoader,u=((V=(it=d==null?void 0:d.assets)==null?void 0:it.textures)==null?void 0:V.floor)||{},f=h.load(u.color||"textures/sand/Sand 002_COLOR.jpg"),p=h.load(u.normal||"textures/sand/Sand 002_NRM.jpg"),b=h.load(u.displacement||"textures/sand/Sand 002_DISP.jpg"),P=h.load(u.ao||"textures/sand/Sand 002_OCC.jpg"),w=1e3;[f,p,b,P].forEach(N=>{N.wrapS=a.RepeatWrapping,N.wrapT=a.RepeatWrapping,N.repeat.set(w,w)});const C=new a.MeshStandardMaterial({map:f,normalMap:p,displacementMap:b,displacementScale:0,aoMap:P,aoMapIntensity:1,roughness:.9,metalness:0,side:a.DoubleSide});X=new a.Mesh(c,C),X.rotation.x=-Math.PI/2,X.position.y=0,X.receiveShadow=!0,X.visible=((Ht=(mt=d==null?void 0:d.scene)==null?void 0:mt.infiniteFloor)==null?void 0:Ht.visible)!==!1,W.add(X);const G=new a.WireframeGeometry(r),I=new a.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.8});j=new a.LineSegments(G,I),j.position.copy(k.position),j.rotation.copy(k.rotation),j.scale.copy(k.scale),j.visible=!1,W.add(j),console.log("Collision mesh loaded successfully (invisible, use for physics only)"),console.log("Press G to toggle collision wireframe, H to toggle Gaussian splat, R to reset Magic effect, F to toggle infinite floor, L to toggle leveling controls"),console.log("Press M to toggle background music, N to toggle movement sounds"),St(),Ot=!0;const E=document.getElementById("collision-progress-bar"),L=document.getElementById("collision-progress-text"),A=document.getElementById("start-collision-bar"),Y=document.getElementById("start-collision-text");E&&L&&(E.style.width="100%",L.textContent="100%"),A&&Y&&(A.style.width="100%",Y.textContent="100%"),le(),yi(),xi()},i=>{const o=i.total>0?Math.min(100,Math.round(i.loaded/i.total*100)):0;console.log("Collision mesh: "+o+"% loaded");const s=document.getElementById("collision-progress-bar"),n=document.getElementById("collision-progress-text"),r=document.getElementById("start-collision-bar"),c=document.getElementById("start-collision-text");s&&n&&(s.style.width=o+"%",n.textContent=o+"%"),r&&c&&(r.style.width=o+"%",c.textContent=o+"%")},i=>{console.error("Error loading collision mesh:",i)})}function St(){const l=Vt*(Math.PI/180),t=zt*(Math.PI/180),e=Bt*(Math.PI/180),i=Rt*(Math.PI/180),o=Lt*(Math.PI/180),s=H;k&&(k.position.y=s,k.rotation.x=l,k.rotation.y=t,k.rotation.z=e,k.rotation.x+=i,k.rotation.z+=o),g&&(g.position.y=s,g.rotation.x=l,g.rotation.y=t,g.rotation.z=e,g.rotation.x+=i,g.rotation.z+=o),j&&(j.position.y=s,j.rotation.x=l,j.rotation.y=t,j.rotation.z=e,j.rotation.x+=i,j.rotation.z+=o),console.log(`Leveling applied: X=${Rt.toFixed(1)}Â°, Z=${Lt.toFixed(1)}Â°, Height=${H.toFixed(2)}`)}function Ut(){if(!K)return;const l=Tt*Math.PI/180,t=Et*Math.PI/180,e=100,i=e*Math.cos(t)*Math.sin(l),o=e*Math.sin(t),s=e*Math.cos(t)*Math.cos(l);K.position.set(i,o,s),console.log(`Light orientation: Azimuth=${Tt}Â°, Elevation=${Et}Â°, Position=(${i.toFixed(1)}, ${o.toFixed(1)}, ${s.toFixed(1)})`)}function pi(){var i;const l=((i=d==null?void 0:d.scene)==null?void 0:i.magicEffect)||{},t=l.expansionRadius??ie,e=l.duration||2;return console.log(`Creating magic modifier: radius=${t.toFixed(1)}, duration=${e.toFixed(1)}s ${l.expansionRadius?"(from config)":"(auto-calculated)"}`),x.dynoBlock({gsplat:x.Gsplat},{gsplat:x.Gsplat},({gsplat:o})=>(o=new x.Dyno({inTypes:{gsplat:x.Gsplat,t:"float"},outTypes:{gsplat:x.Gsplat},globals:()=>[x.unindent(`
            // Pseudo-random hash function for noise generation
            vec3 hash(vec3 p) {
              p = fract(p * 0.3183099 + 0.1);
              p *= 17.0;
              return fract(vec3(p.x * p.y * p.z, p.x + p.y * p.z, p.x * p.y + p.z));
            }

            // 3D Perlin-style noise function
            vec3 noise(vec3 p) {
              vec3 i = floor(p);
              vec3 f = fract(p);
              f = f * f * (3.0 - 2.0 * f);

              vec3 n000 = hash(i + vec3(0,0,0));
              vec3 n100 = hash(i + vec3(1,0,0));
              vec3 n010 = hash(i + vec3(0,1,0));
              vec3 n110 = hash(i + vec3(1,1,0));
              vec3 n001 = hash(i + vec3(0,0,1));
              vec3 n101 = hash(i + vec3(1,0,1));
              vec3 n011 = hash(i + vec3(0,1,1));
              vec3 n111 = hash(i + vec3(1,1,1));

              vec3 x0 = mix(n000, n100, f.x);
              vec3 x1 = mix(n010, n110, f.x);
              vec3 x2 = mix(n001, n101, f.x);
              vec3 x3 = mix(n011, n111, f.x);

              vec3 y0 = mix(x0, x1, f.y);
              vec3 y1 = mix(x2, x3, f.y);

              return mix(y0, y1, f.z);
            }
          `)],statements:({inputs:n,outputs:r})=>x.unindentLines(`
          ${r.gsplat} = ${n.gsplat};
          float t = ${n.t};
          float s = smoothstep(0., ${e.toFixed(1)}, t) * ${t.toFixed(1)};
          vec3 scales = ${n.gsplat}.scales;
          vec3 localPos = ${n.gsplat}.center;
          float l = length(localPos.xz);

          // Magic Effect: Complex twister with noise and radial reveal (${t} unit radius in ${e} seconds)
          float border = abs(s-l-.5);
          localPos *= 1.-.2*exp(-20.*border);
          vec3 finalScales = mix(scales,vec3(0.002),smoothstep(s-.5,s,l+.5));
          ${r.gsplat}.center = localPos + .1*noise(localPos.xyz*2.+t*.5)*smoothstep(s-.5,s,l+.5);
          ${r.gsplat}.scales = finalScales;
          float at = atan(localPos.x,localPos.z)/3.1416;
          ${r.gsplat}.rgba *= step(at,t-3.1416);
          ${r.gsplat}.rgba += exp(-20.*border) + exp(-50.*abs(t-at-3.1416))*.5;
        `)}).apply({gsplat:o,t:Zt}).gsplat,{gsplat:o}))}function mi(l,t,e,i,o,s,n,r,c){return x.dynoBlock({gsplat:x.Gsplat},{gsplat:x.Gsplat},({gsplat:h})=>{if(!h)throw new Error("No gsplat input");let{center:u,rgb:f}=x.splitGsplat(h).outputs;const p=x.dot(o,x.sub(u,i)),b=x.add(i,x.mul(o,p)),P=x.length(x.sub(b,u)),w=x.lessThan(P,t),C=x.length(x.sub(b,r)),G=x.lessThan(C,c),I=x.and(x.greaterThan(p,x.dynoFloat(0)),x.lessThan(p,e)),E=x.select(n,G,I),L=x.and(w,E),A=x.select(l,x.select(L,s,f),f);return h=x.combineGsplat({gsplat:h,rgb:A}),{gsplat:h}})}async function yi(){var l,t,e,i;console.log("Loading Gaussian splat...");try{const o=document.getElementById("splat-progress-bar"),s=document.getElementById("splat-progress-text"),n=document.getElementById("start-splat-bar"),r=document.getElementById("start-splat-text");o&&s&&(o.style.width="10%",s.textContent="10%"),n&&r&&(n.style.width="10%",r.textContent="10%");const c=((l=d==null?void 0:d.assets)==null?void 0:l.splatFile)||"models/StoneHenge.sog";g=new Pe({url:c}),console.log("SplatMesh created, waiting for initialization..."),o&&s&&(o.style.width="50%",s.textContent="50%"),n&&r&&(n.style.width="50%",r.textContent="50%"),await g.initialized,console.log("SplatMesh initialized successfully");const h=g.getBoundingBox(!1),u=new a.Vector3;h.getSize(u);const f=Math.max(u.x,u.y,u.z),p=u.length()/2;console.log("Splat bounding box (local space):"),console.log("  min:",h.min),console.log("  max:",h.max),console.log("  extent:",u),console.log("  max dimension:",f.toFixed(2)),console.log("  radius (center to corner):",p.toFixed(2));const b=p*pt*1.5,P=((t=d==null?void 0:d.camera)==null?void 0:t.far)||1e3,w=Math.max(b,P);M&&(M.far=w,M.updateProjectionMatrix(),console.log(`Camera far plane: config=${P}, auto=${b.toFixed(0)}, using=${w.toFixed(0)}`)),ie=Math.sqrt(u.x*u.x+u.z*u.z)/2*1.1,console.log(`Magic effect expansion radius: auto=${ie.toFixed(1)} (in splat space)`);const G=(e=d==null?void 0:d.character)==null?void 0:e.maxHeight;if(console.log(`[Height Cap Config] configMaxHeight="${G}", maxTerrainHeight=${ct.toFixed(2)}, heightOffset=${H.toFixed(2)}`),G==="auto"){const V=ct+H;_=V*2,console.log(`[Height Cap] Set to ${_.toFixed(2)} (auto: 2Ã— actual terrain height ${V.toFixed(2)} = 2Ã— (${ct.toFixed(2)} + ${H.toFixed(2)}))`)}else if(typeof G=="number")G<0?(_=null,console.log(`[Height Cap] Set to NONE (unlimited) - config value: ${G}`)):(_=G,console.log(`[Height Cap] Set to ${_.toFixed(2)} (absolute from config)`));else{const V=ct+H;_=V*2,console.log(`[Height Cap] Set to ${_.toFixed(2)} (default auto: 2Ã— actual terrain height ${V.toFixed(2)} = 2Ã— (${ct.toFixed(2)} + ${H.toFixed(2)}))`)}console.log(`[Height Cap Final] maxCharacterHeight = ${_===null?"null (unlimited)":_.toFixed(2)}`),v&&(v.maxHeight=_,console.log(`[Height Cap] Updated existing CharacterControls.maxHeight to ${_===null?"null (unlimited)":_.toFixed(2)}`)),o&&s&&(o.style.width="100%",s.textContent="100%"),n&&r&&(n.style.width="100%",r.textContent="100%"),g.scale.multiplyScalar(pt),g.rotation.x+=Vt*(Math.PI/180),g.rotation.y+=zt*(Math.PI/180),g.rotation.z+=Bt*(Math.PI/180),g.position.y=H,ot.add(g),g.visible=!1,St(),Gt=!0,D&&(D.gaussianSplat=g,console.log("Gaussian splat reference set in XRManager"));const I=30,E=20,L=50,A=O?E:I;window.lodTargetFPS={desktop:I,mobile:E,vr:L,initial:A},console.log("LOD target FPS stored, will initialize after splat loads");const Y=((i=d==null?void 0:d.scene)==null?void 0:i.magicEffect)||{},it=Y.enabled!==!1&&(!O||Y.mobileEnabled===!0);if(console.log("Magic effect config check:",{enabled:Y.enabled,mobileEnabled:Y.mobileEnabled,isMobile:O,shouldEnableEffect:it}),it)try{g.objectModifier=pi(),g.updateGenerator(),console.log(`Gaussian splat loaded with Magic effect (${O?"mobile":"desktop"}) - awaiting user interaction`),console.log("Magic effect modifier attached:",!!g.objectModifier)}catch(V){console.error("Error applying Magic effect modifier:",V),console.log("Gaussian splat loaded without Magic effect (shader compilation failed)")}else console.log(`Gaussian splat loaded without Magic effect (${O?"mobile not enabled in config":"disabled in config"})`);try{const V=O?2:0;F=new oi(g,M,R,window.lodTargetFPS.initial),F.desktopTargetFPS=window.lodTargetFPS.desktop,F.mobileTargetFPS=window.lodTargetFPS.mobile,F.vrTargetFPS=window.lodTargetFPS.vr,console.log("Distance-based LOD system initialized")}catch(V){console.error("Error initializing LOD system:",V)}try{const V=g.worldModifier,mt=mi(y.enabled,y.brushRadius,y.brushDepth,y.brushOrigin,y.brushDirection,y.brushColor,y.useSurface,y.surfacePoint,y.surfaceRadius);V&&mt?g.worldModifier=x.dynoBlock({gsplat:x.Gsplat},{gsplat:x.Gsplat},({gsplat:Ht})=>{const{gsplat:N}=V({gsplat:Ht}),{gsplat:yt}=mt({gsplat:N});return{gsplat:yt}}):g.worldModifier=mt,g.updateGenerator(),console.log("Combined LOD + Brush modifiers applied to Gaussian splat")}catch(V){console.error("Error applying brush modifier:",V)}le()}catch(o){console.error("Error loading Gaussian splat:",o)}}async function le(){if(Jt)return;const l=document.getElementById("start-loading-bars"),t=document.getElementById("start-button");l&&(Ot&&Gt?(Jt=!0,bt&&(clearTimeout(bt),bt=null),console.log("All assets loaded, showing buttons..."),setTimeout(async()=>{l.style.display="none",t&&(t.style.display="inline-block"),console.log("Assets loaded, start button shown")},500)):bt||(console.log("Assets not fully loaded, setting fallback timeout..."),bt=setTimeout(async()=>{Ot&&Gt&&!Jt?(Jt=!0,console.log("Loading timeout: assets confirmed loaded, showing buttons"),l.style.display="none",t&&(t.style.display="inline-block")):(!Ot||!Gt)&&(console.warn("Loading timeout: assets STILL not loaded, waiting longer..."),bt=null,setTimeout(()=>le(),2e3))},1e4)))}function bi(){var l;if(ge){console.log("Magic reveal already started");return}if(ge=!0,g&&(g.visible=!0),g&&g.objectModifier?(qt=0,Zt.value=0,console.log("Magic reveal animation started by user interaction")):console.log("Gaussian splat not ready for animation, skipping magic effect"),B&&(B.startBackgroundMusic(),console.log("Background music started")),B){const e=(((l=d==null?void 0:d.scene)==null?void 0:l.magicEffect)||{}).soundDelay||0;B.playMagicReveal(e),console.log(`Magic reveal sound will play in ${e}s`)}}function xi(){var e;const l=new be,t=((e=d==null?void 0:d.assets)==null?void 0:e.characterFile)||"models/Soldier.glb";l.load(t,i=>{var G,I,E,L;const o=i.scene;o.traverse(A=>{A.isMesh&&(A.castShadow=!0)}),W.add(o);const s=i.animations,n=new a.AnimationMixer(o),r=new Map;s.forEach(A=>{r.set(A.name,n.clipAction(A))});const c=((G=d==null?void 0:d.camera)==null?void 0:G.offsetFromCharacter)||{x:0,y:2,z:5},h=((E=(I=d==null?void 0:d.camera)==null?void 0:I.targetOffset)==null?void 0:E.y)||1;v=new Ae(o,n,r,T,M,"Idle",[k,X],_,h);const u=((L=d==null?void 0:d.character)==null?void 0:L.spawn)||{},f=u.position||{x:0,y:"auto",z:40},p=u.rotation||{y:0};o.position.x=f.x,o.position.z=f.z,o.rotation.y=p.y*(Math.PI/180),f.y==="auto"?(o.position.y=1e3,console.log(`Auto-detecting ground height at spawn position (${f.x}, ${f.z})...`),v.placeOnGround()):(o.position.y=f.y,console.log(`Character spawned at specified position (${f.x}, ${f.y}, ${f.z})`));const P=new a.Vector3(c.x,c.y,c.z).clone().applyQuaternion(o.quaternion);M.position.set(o.position.x+P.x,o.position.y+P.y,o.position.z+P.z);const C=new a.Vector3(0,h,0).clone().applyQuaternion(o.quaternion);T.target.set(o.position.x+C.x,o.position.y+C.y,o.position.z+C.z),T.syncFromCamera(),T.update(),console.log("Character loaded successfully at position:",o.position),console.log("Camera positioned at:",M.position),console.log("Character facing east (rotation Y:",o.rotation.y,")"),console.log("Available animations:",Array.from(r.keys())),O&&(v.toggleRun=!0,console.log("Mobile: run mode enabled by default")),vi()},i=>{console.log(i.loaded/i.total*100+"% loaded")},i=>{console.error("Error loading character:",i)})}function vi(){D=new Je(R,M,W,d),U=new We(R,W,D),U.setGroundMeshes([k,X]),It=new Ye(R,W,v==null?void 0:v.model),rt=new ei(W,It),z=new ti(It,D,rt),q=new ii(W),z.callbacks.onPaintStart=(l,t,e)=>{console.log(`Gesture paint start (${l})`),g&&(y.brushOrigin.value.copy(t),y.brushDirection.value.copy(e),y.enabled.value=!0),q&&q.updatePaintRay(l,t,e,!0)},z.callbacks.onPaintDrag=(l,t,e)=>{if(!g)return;y.brushOrigin.value.copy(t),y.brushDirection.value.copy(e),y.enabled.value=!0;const i=rt?rt.getSelectedColor():{hex:8913151},o=new a.Color(i.hex).convertLinearToSRGB();y.brushColor.value.x=o.r,y.brushColor.value.y=o.g,y.brushColor.value.z=o.b;const n=new a.Raycaster(t,e).intersectObjects([k,X],!0);n.length>0?(y.useSurface.value=!0,y.surfacePoint.value.copy(n[0].point)):y.useSurface.value=!1;const r=!g.splatRgba;g.splatRgba=ot.getRgba({generator:g,rgba:g.splatRgba}),r?g.updateGenerator():g.updateVersion(),q&&q.updatePaintRay(l,t,e,!0)},z.callbacks.onPaintEnd=l=>{console.log(`Gesture paint end (${l})`),y.enabled.value=!1,q&&q.updatePaintRay(l,null,null,!1)},z.callbacks.onMovementStart=(l,t)=>{console.log(`Movement gesture started: speed=${t.toFixed(2)}`),Pt=l.clone(),Ct=t},z.callbacks.onMovementUpdate=(l,t)=>{Pt=l.clone(),Ct=t},z.callbacks.onMovementEnd=()=>{console.log("Movement gesture ended"),Pt=null,Ct=0},z.callbacks.onJetpackStart=l=>{console.log(`Jetpack gesture started (${l})`),v&&v.activateJetpack()},z.callbacks.onJetpackEnd=l=>{console.log(`Jetpack gesture ended (${l})`),v&&v.deactivateJetpack()},z.callbacks.onColorSelect=(l,t)=>{if(rt){const e=rt.checkHover(l,t);e!==null&&(rt.selectColor(e),z.selectedColorIndex=e,console.log(`Color selected: index ${e}`))}},z.callbacks.onTeleportStart=(l,t)=>{if(console.log("Teleport started (LEFT hand)"),D){const i=new a.Raycaster(l,t).intersectObjects([k,X],!0);i.length>0?D.updateTeleportTarget(i[0].point):D.updateTeleportTarget(null)}},z.callbacks.onTeleportUpdate=(l,t)=>{if(D){const i=new a.Raycaster(l,t).intersectObjects([k,X],!0);i.length>0?D.updateTeleportTarget(i[0].point):D.updateTeleportTarget(null)}},z.callbacks.onTeleportEnd=(l,t)=>{console.log("Teleport executed (LEFT hand released)"),D&&D.executeTeleport()},z.callbacks.onTogglePaintMode=l=>{console.log(`Paint mode toggled via gesture: ${l?"ON":"OFF"}`),U&&(U.isPaintMode=l),g&&(y.enabled.value=l)},D.characterControls=v,D.orbitControls=T,D.xrControllers=U,D.xrHands=It,D.gestureDetector=z,console.log("WebXR system initialized with gesture detection")}function wi(){var t,e;const l=((e=(t=d==null?void 0:d.assets)==null?void 0:t.audio)==null?void 0:e.jetpack)||"sounds/thrusters_loopwav-14699.mp3";B=new Xe({backgroundMusic:"sounds/happy-relaxing-loop-275536.mp3",walkingSound:"sounds/walking-on-gravel-version-2-308744.mp3",runningSound:"sounds/running-on-gravel-301880.mp3",jetpackSound:l,magicReveal:"sounds/a-magical-intro-395716.mp3"},O),console.log("Audio system initialized - will start on user clicking start button")}function Mi(){const l=document.getElementById("camera-icon-3rd"),t=document.getElementById("camera-icon-1st");et==="first-person"?(l&&(l.style.display="none"),t&&(t.style.display="block")):(l&&(l.style.display="block"),t&&(t.style.display="none"))}function ae(){var l,t,e;if(!v){console.log("Character not loaded yet");return}if(!gt)if(et==="third-person"){const i=v.model,o=new a.Euler;o.setFromQuaternion(i.quaternion,"YXZ"),Q=re(o.y),tt=0,Wt.copy(M.position),Yt.copy(M.quaternion),Mt.set(i.position.x,i.position.y+v.firstPersonHeadHeight,i.position.z),M.rotation.order="YXZ";const s=new a.Euler(tt,Q,0,"YXZ");Kt.setFromEuler(s),gt=!0,ut=0,lt="first-person",console.log("Starting transition to first-person mode")}else{const i=v.model;if(i){const o=((l=d==null?void 0:d.camera)==null?void 0:l.offsetFromCharacter)||{x:0,y:2,z:5},s=((e=(t=d==null?void 0:d.camera)==null?void 0:t.targetOffset)==null?void 0:e.y)||1,n=Q,r=new a.Quaternion;r.setFromAxisAngle(new a.Vector3(0,1,0),n),i.quaternion.copy(r);const h=new a.Vector3(o.x,o.y,o.z).clone().applyQuaternion(i.quaternion);Wt.copy(M.position),Yt.copy(M.quaternion),Mt.set(i.position.x+h.x,i.position.y+h.y,i.position.z+h.z);const f=new a.Vector3(0,s,0).clone().applyQuaternion(r);T.target.set(i.position.x+f.x,i.position.y+f.y,i.position.z+f.z);const p=Mt.distanceTo(T.target);console.log("Transition target distance:",p.toFixed(3)),console.log("WorldOffset:",h),console.log("TargetOffsetY:",s),gt=!0,ut=0,lt="third-person",console.log("Starting transition to third-person mode"),console.log("Start pos:",Wt),console.log("Start quat:",Yt),console.log("Target pos (OrbitControls final):",Mt),console.log("Target quat (OrbitControls final):",Kt)}}}function Si(){const l=document.getElementById("camera-toggle-button");l&&(l.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ae()}),O&&l.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),ae()},{passive:!1}),console.log("Camera toggle button initialized"))}function ki(){const l=document.getElementById("paint-toggle-button");l&&O&&(l.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),pe()}),l.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),pe()},{passive:!1}),console.log("Paint toggle button initialized"))}function pe(){J=!J;const l=document.getElementById("paint-toggle-button");l&&(J?l.classList.add("active"):l.classList.remove("active")),$&&$.setPaintMode(J),console.log(`Mobile paint mode: ${J?"ON":"OFF"}`)}function Pi(l,t){if(!J||!g||!Z)return;const e=new a.Vector3(1,0,1),i=R.domElement.getBoundingClientRect(),o=new a.Vector2;o.x=(l-i.left)/i.width*2-1,o.y=-((t-i.top)/i.height)*2+1,Z.setFromCamera(o,M),y.brushOrigin.value.copy(Z.ray.origin),y.brushDirection.value.copy(Z.ray.direction),y.brushColor.value.copy(e);const s=Z.intersectObjects([k,X],!0);s.length>0?(y.useSurface.value=!0,y.surfacePoint.value.copy(s[0].point)):y.useSurface.value=!1,y.enabled.value=!0;const n=!g.splatRgba;g.splatRgba=ot.getRgba({generator:g,rgba:g.splatRgba}),n?g.updateGenerator():g.updateVersion()}function Ci(){y&&y.enabled&&(y.enabled.value=!1)}function Ti(){const l=document.getElementById("jump-jetpack-button");if(l&&O){let t=null;const e=400;l.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),Dt[" "]=!0,setTimeout(()=>{(!$||!$.jetpackActive)&&(Dt[" "]=!1)},50),t=setTimeout(()=>{$&&($.activateJetpack(),l.classList.add("jetpack-active"))},e)},{passive:!1}),l.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),t&&(clearTimeout(t),t=null),$&&$.jetpackActive&&($.deactivateJetpack(),l.classList.remove("jetpack-active"))},{passive:!1}),l.addEventListener("touchcancel",i=>{t&&(clearTimeout(t),t=null),$&&$.jetpackActive&&($.deactivateJetpack(),l.classList.remove("jetpack-active"))},{passive:!1}),console.log("Jump/jetpack button initialized")}}function Ei(l){et==="first-person"&&ne&&(Q-=l.movementX*de,Q=re(Q),tt-=l.movementY*de,tt=Math.max(-_t,Math.min(_t,tt)),v&&v.setFirstPersonRotation(tt,Q))}function Ri(){ne=document.pointerLockElement===R.domElement,console.log(`Pointer lock: ${ne?"LOCKED":"UNLOCKED"}`)}function Li(){console.error("Pointer lock failed")}function ve(){et==="first-person"&&!O&&!J&&R.domElement.requestPointerLock()}function we(){document.pointerLockElement===R.domElement&&document.exitPointerLock()}function Di(l,t){et==="first-person"&&(Q-=l*ue,Q=re(Q),tt-=t*ue,tt=Math.max(-_t,Math.min(_t,tt)),v&&v.setFirstPersonRotation(tt,Q))}function Fi(){J=!J,y.enabled.value=J,g&&(g.needsUpdate=!0);const l=document.getElementById("paint-controls");l&&(J?l.classList.add("visible"):l.classList.remove("visible")),J?R.domElement.classList.add("paint-mode"):R.domElement.classList.remove("paint-mode"),J?(we(),et==="third-person"&&(T.enabled=!1),console.log("Paint mode: ON - LEFT-click drag or CTRL+move to paint, camera rotation disabled")):(et==="first-person"?ve():et==="third-person"&&(T.enabled=!0),console.log("Paint mode: OFF"))}function me(l){const t=y.brushRadius.value,e=Math.max(ri,Math.min(li,t+l));y.brushRadius.value=e,console.log(`Brush radius: ${e.toFixed(3)}`),ce()}function ye(l){const t=y.brushDepth.value,e=Math.max(ci,Math.min(hi,t+l));y.brushDepth.value=e,console.log(`Brush depth: ${e.toFixed(1)}`),ce()}function ce(){const l=document.getElementById("brush-size-display");l&&(l.textContent=`Radius: ${y.brushRadius.value.toFixed(3)} | Depth: ${y.brushDepth.value.toFixed(1)}`)}function Ii(){const l=document.getElementById("color-picker");l&&(l.addEventListener("input",t=>{const e=t.target.value,i=new a.Color(e).convertLinearToSRGB();y.brushColor.value.x=i.r,y.brushColor.value.y=i.g,y.brushColor.value.z=i.b,console.log(`Brush color changed to: ${e}`,i)}),console.log("Color picker initialized")),ce()}function Ai(){R.domElement.addEventListener("pointermove",l=>{if(!J||!g||!Z)return;const t=new a.Vector2(l.clientX/window.innerWidth*2-1,-(l.clientY/window.innerHeight)*2+1);Z.setFromCamera(t,M);const e=Z.ray.direction.normalize();if(y.brushDirection.value.x=e.x,y.brushDirection.value.y=e.y,y.brushDirection.value.z=e.z,y.brushOrigin.value.x=Z.ray.origin.x,y.brushOrigin.value.y=Z.ray.origin.y,y.brushOrigin.value.z=Z.ray.origin.z,k){const i=Z.intersectObject(k,!1);if(i.length>0){const o=i[0].point;y.useSurface.value=!0,y.surfacePoint.value.x=o.x,y.surfacePoint.value.y=o.y,y.surfacePoint.value.z=o.z}else y.useSurface.value=!1}else y.useSurface.value=!1;if(g&&(g.needsUpdate=!0),(te||oe)&&g){const i=!g.splatRgba;g.splatRgba=ot.getRgba({generator:g,rgba:g.splatRgba}),i?g.updateGenerator():g.updateVersion()}}),R.domElement.addEventListener("pointerdown",l=>{if(!J||!g||l.button!==0)return;l.preventDefault(),te=!0;const t=!g.splatRgba;g.splatRgba=ot.getRgba({generator:g,rgba:g.splatRgba}),t?g.updateGenerator():g.updateVersion()}),R.domElement.addEventListener("pointerup",l=>{!J||l.button!==0||(te=!1)}),console.log("Paint controls initialized")}function Oi(){let l=!1;const t=()=>{!l&&B&&(B.startBackgroundMusic(),l=!0,console.log("Background music started on touch interaction (fallback)"),document.removeEventListener("touchstart",t))};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",e=>{var o;const i=e.key.toLowerCase();if(e.key==="Control"&&(oe=!0),Dt[i]=!0,se.down(i),!l&&B&&(B.startBackgroundMusic(),l=!0,console.log("Background music started on keyboard interaction (fallback)")),i==="shift"&&v&&v.switchRunToggle(),i==="g"&&j&&(j.visible=!j.visible,console.log(`Collision mesh wireframe: ${j.visible?"ON":"OFF"}`)),i==="h"&&g&&(g.visible=!g.visible,console.log(`Gaussian splat: ${g.visible?"ON":"OFF"}`)),i==="r"&&g){if(qt=0,Zt.value=0,B){const n=(((o=d==null?void 0:d.scene)==null?void 0:o.magicEffect)||{}).soundDelay||0;B.playMagicReveal(n)}console.log("Magic effect reset")}if(i==="f"&&X&&(X.visible=!X.visible,console.log(`Infinite floor: ${X.visible?"ON":"OFF"}`)),i==="l"){const s=document.getElementById("leveling-controls");if(s){s.classList.toggle("visible");const n=s.classList.contains("visible");console.log(`Leveling controls: ${n?"ON":"OFF"}`)}}i==="m"&&B&&B.toggleBackgroundMusic(),i==="n"&&B&&B.toggleMovementSounds(),i==="v"&&ae(),i==="p"&&Fi(),i==="q"&&F&&F.increaseLOD(),i==="e"&&F&&F.decreaseLOD(),i==="t"&&F&&F.resumeAdaptive(),(i==="="||i==="+")&&me(.01),(i==="-"||i==="_")&&me(-.01),i==="["&&ye(-1),i==="]"&&ye(1)}),document.addEventListener("keyup",e=>{const i=e.key.toLowerCase();e.key==="Control"&&(oe=!1),Dt[i]=!1,se.up(i)}),console.log("Keyboard controls initialized")}async function Gi(){const l=document.getElementById("start-button"),t=document.getElementById("start-overlay"),e=i=>{if(i.preventDefault(),i.stopPropagation(),!Ot||!Gt){console.warn("Assets not fully loaded yet, cannot start experience"),alert("Please wait for assets to finish loading...");return}console.log("Start button triggered - entering experience"),xe=!0,t.classList.remove("visible"),bi(),B&&B.unlockAudio().then(()=>{console.log("Audio unlocked successfully in background")}).catch(o=>{console.error("Audio unlock failed:",o)})};l&&(l.addEventListener("click",e),O&&l.addEventListener("touchstart",e,{passive:!1})),console.log("Start button initialized")}function Vi(){M.aspect=window.innerWidth/window.innerHeight,M.updateProjectionMatrix(),R.setSize(window.innerWidth,window.innerHeight),se.updatePosition()}function zi(){var e,i,o,s;const l=ai.getDelta();if(F){F.update(),he=F.getFPS();const n=document.getElementById("debug-fps");n&&(n.textContent=he);const r=document.getElementById("debug-quality");if(r){const h=F.getCurrentLODName(),u=F.isManualMode()?"MANUAL":"Auto";r.textContent=`${h} (${u})`}const c=document.getElementById("debug-decimation");if(c){const h=F.getCurrentLODLevel(),u=F.getLODConfigs();c.textContent=`${h}/${u.length-1}`}}if(g&&xe&&(qt+=1/60,Zt.value=qt,g.updateVersion()),gt){if(ut+=l/di,lt==="third-person"){const c=M.position.distanceTo(T.target);console.log(`[Transition ${(ut*100).toFixed(1)}%] Pos: (${M.position.x.toFixed(3)}, ${M.position.y.toFixed(3)}, ${M.position.z.toFixed(3)}) Distance: ${c.toFixed(6)}`)}if(ut>=1){if(ut=1,M.position.copy(Mt),lt==="first-person"?M.quaternion.copy(Kt):M.lookAt(T.target),gt=!1,lt==="third-person"&&(Xt=fe),et=lt,et==="first-person")T.enabled=!1,v.model&&(v.model.visible=!1,v.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1,c.material.transparent=!1)})),v.setCameraMode("first-person"),v.setFirstPersonRotation(tt,Q),$&&$.setCameraMode("first-person"),ve(),console.log("Transition to first-person complete");else{v.model&&(v.model.visible=!0,v.model.traverse(f=>{f.isMesh&&f.material&&(f.material.opacity=1,f.material.transparent=!1)})),v.setCameraMode("third-person"),$&&$.setCameraMode("third-person"),we();const c=v.model,h=((i=(e=d==null?void 0:d.camera)==null?void 0:e.targetOffset)==null?void 0:i.y)||1;if(c){const p=new a.Vector3(0,h,0).clone().applyQuaternion(c.quaternion);T.target.set(c.position.x+p.x,c.position.y+p.y,c.position.z+p.z),console.log("Re-synced OrbitControls target to character position:",T.target)}T.enabled=!0,T.syncFromCamera(),T.update();const u=M.position.distanceTo(T.target);console.log("Transition to third-person complete"),console.log("Final camera pos:",M.position),console.log("Final distance to target:",u.toFixed(3)),console.log("OrbitControls target:",T.target)}Mi()}const n=ut,r=n<.5?2*n*n:-1+(4-2*n)*n;M.position.lerpVectors(Wt,Mt,r),lt==="first-person"?M.quaternion.slerpQuaternions(Yt,Kt,r):M.lookAt(T.target),v&&v.model&&(lt==="first-person"?r<.7?(v.model.visible=!0,v.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1-r,c.material.transparent=!0)})):v.model.visible=!1:(v.model.visible=!0,v.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=r,c.material.transparent=!0)})))}const t=D&&D.getIsXRActive();if(F){const n=F.targetFPS===F.vrTargetFPS;if(t&&!n)F.setTargetFPS(F.vrTargetFPS);else if(!t&&n){const r=O?F.mobileTargetFPS:F.desktopTargetFPS;F.setTargetFPS(r)}}if(t){if(D.update(l,[k,X]),z){const n=R.xr.getSession();z.update(n,M.position)}if(rt&&rt.update(M.position),Pt&&Ct>0&&D){const n=((o=d==null?void 0:d.controls)==null?void 0:o.walkSpeed)||1.5,r=((s=d==null?void 0:d.controls)==null?void 0:s.runSpeed)||3,c=n+(r-n)*Ct,h=Pt.clone().multiplyScalar(c*l);D.updateReferenceSpaceByOffset(h),q&&q.updateMovementArrow(M.position,Pt,Ct,!0)}else q&&q.hideMovementArrow();if(q&&z)if(z.mode==="jetpack"||z.mode==="moving_jetpack"){const r=R.xr.getSession();if(r){for(const c of r.inputSources)if(c.hand&&c.handedness==="right"){const h=It.getJointPosition(c.hand,"wrist");h&&q.updateJetpackGlow("right",h,!0);break}}}else q.hideJetpackGlows();if(U&&U.isPaintMode&&g)for(let n=0;n<2;n++){const r=U.getRayForPainting(n);if(r){console.log(`VR Paint: controller ${n} painting - isDragging: ${U.isDragging}`),y.brushOrigin.value.copy(r.origin),y.brushDirection.value.copy(r.direction);const c=U.paletteColors[U.currentColorIndex],h=new a.Color(c.hex).convertLinearToSRGB();if(y.brushColor.value.x=h.r,y.brushColor.value.y=h.g,y.brushColor.value.z=h.b,y.enabled.value=!0,U.isDragging){console.log("VR Paint: Baking paint to texture");const u=!g.splatRgba;g.splatRgba=ot.getRgba({generator:g,rgba:g.splatRgba}),u?g.updateGenerator():g.updateVersion()}break}}else U&&!U.isPaintMode&&(y.enabled.value=!1);if(v){const n=document.getElementById("debug-state"),r=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),h=document.getElementById("debug-ground-dist");if(n&&r&&c&&h){const u=D.isGrounded,f=D.jetpackActive;n.textContent=u?"GROUNDED":"IN AIR",n.className=u?"grounded":"in-air",r.textContent="VR Mode",c.textContent=f?"ACTIVE":"OFF",c.className=f?"jetpack-active":"",h.textContent="N/A (VR)"}}}else if(v){gt||v.update(l,Dt);const n=document.getElementById("debug-state"),r=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),h=document.getElementById("debug-ground-dist"),u=document.getElementById("debug-position");if(n&&r&&c&&h&&u){const f=v.getGroundedState(),p=v.getCurrentAction(),b=v.getJetpackActive(),P=v.getGroundDistance(),w=v.getPosition();n.textContent=f?"GROUNDED":"IN AIR",n.className=f?"grounded":"in-air",r.textContent=p,c.textContent=b?"ACTIVE":"OFF",c.className=b?"jetpack-active":"",h.textContent=P.toFixed(1)+"m",u.textContent=`(${w.x.toFixed(1)}|${w.y.toFixed(1)}|${w.z.toFixed(1)})`}if(B){const f=v.getMovementState();B.updateMovementSounds(f)}}if(B&&B.update(l),Xt>0){Xt-=l;const n=M.position.distanceTo(T.target);console.log(`[Post-transition ${((fe-Xt)*1e3).toFixed(0)}ms] Pos: (${M.position.x.toFixed(3)}, ${M.position.y.toFixed(3)}, ${M.position.z.toFixed(3)}) Distance: ${n.toFixed(6)} OrbitEnabled: ${T.enabled}`)}!gt&&!t&&et==="third-person"&&T.update(),R.render(W,M)}function Bi(){const l=document.getElementById("level-height-slider"),t=document.getElementById("level-height-value");l&&t&&(l.min=at.toFixed(2),l.max=nt.toFixed(2),l.value=H.toString(),t.textContent=`${H.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`,console.log(`[UI] Height slider bounds updated: [${at.toFixed(2)} to ${nt.toFixed(2)}]`))}function Hi(){const l=document.getElementById("level-x-slider"),t=document.getElementById("level-z-slider"),e=document.getElementById("level-height-slider"),i=document.getElementById("light-azimuth-slider"),o=document.getElementById("light-elevation-slider"),s=document.getElementById("level-x-value"),n=document.getElementById("level-z-value"),r=document.getElementById("level-height-value"),c=document.getElementById("light-azimuth-value"),h=document.getElementById("light-elevation-value"),u=document.getElementById("leveling-reset");e&&r&&(e.value=H.toString(),r.textContent=`${H.toFixed(2)} [calculating...]`),l&&l.addEventListener("input",f=>{Rt=parseFloat(f.target.value),s.textContent=Rt.toFixed(1)+"Â°",St()}),t&&t.addEventListener("input",f=>{Lt=parseFloat(f.target.value),n.textContent=Lt.toFixed(1)+"Â°",St()}),e&&e.addEventListener("input",f=>{H=parseFloat(f.target.value),r.textContent=`${H.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`,St()}),i&&i.addEventListener("input",f=>{Tt=parseFloat(f.target.value),c.textContent=Tt.toFixed(0)+"Â°",Ut()}),o&&o.addEventListener("input",f=>{Et=parseFloat(f.target.value),h.textContent=Et.toFixed(0)+"Â°",Ut()}),u&&u.addEventListener("click",()=>{var C,G,I,E,L,A,Y,it;const f=((G=(C=d==null?void 0:d.transform)==null?void 0:C.defaultLeveling)==null?void 0:G.x)||0,p=((E=(I=d==null?void 0:d.transform)==null?void 0:I.defaultLeveling)==null?void 0:E.z)||0;let b=0;st==="max"?b=nt:st==="min"?b=at:typeof st=="number"&&(b=st),Rt=f,Lt=p,H=b,l.value=f,t.value=p,e.value=b,s.textContent=f.toFixed(1)+"Â°",n.textContent=p.toFixed(1)+"Â°",r.textContent=`${b.toFixed(2)} [${at.toFixed(2)} to ${nt.toFixed(2)}]`;const P=((A=(L=d==null?void 0:d.lighting)==null?void 0:L.directional)==null?void 0:A.azimuth)||213,w=((it=(Y=d==null?void 0:d.lighting)==null?void 0:Y.directional)==null?void 0:it.elevation)||37;Tt=P,Et=w,i.value=P,o.value=w,c.textContent=P.toFixed(0)+"Â°",h.textContent=w.toFixed(0)+"Â°",St(),Ut(),console.log("All controls reset to defaults")}),console.log("Leveling controls initialized")}async function $i(){try{wt=await ze();const l=ee(wt),t=document.getElementById("scene-dropdown"),e=document.getElementById("start-scene-dropdown");t.innerHTML="",e&&(e.innerHTML=""),l.forEach(o=>{const s=document.createElement("option");if(s.value=o.id,s.textContent=o.name,t.appendChild(s),e){const n=document.createElement("option");n.value=o.id,n.textContent=o.name,e.appendChild(n)}});const i=$e(wt);t.value=i,e&&(e.value=i),t.addEventListener("change",async o=>{const s=o.target.value;s!==kt&&(console.log(`Switching to scene: ${s}`),ft.navigateToSite(s))}),e&&e.addEventListener("change",async o=>{const s=o.target.value;if(s!==kt){console.log(`Switching to scene: ${s}`),t.value=s;const r=ee(wt).find(c=>c.id===s);if(r){const c=document.getElementById("start-title"),h=document.getElementById("start-description");c&&(c.textContent=r.name),h&&(h.textContent=r.description||"Prepare for an amazing journey")}ft.navigateToSite(s)}}),console.log("Scene selectors initialized")}catch(l){console.error("Failed to initialize scene selector:",l)}}function Ni(){sessionStorage.setItem("currentScene",kt),d.transform.scale!==void 0&&(pt=d.transform.scale,console.log("Applied scale from config:",pt)),d.transform.rotation&&(Vt=d.transform.rotation.x!==void 0?d.transform.rotation.x:180,zt=d.transform.rotation.y!==void 0?d.transform.rotation.y:0,Bt=d.transform.rotation.z!==void 0?d.transform.rotation.z:0,console.log("Applied rotation from config:",Vt,zt,Bt)),d.transform.defaultLeveling&&(Rt=d.transform.defaultLeveling.x||0,Lt=d.transform.defaultLeveling.z||0),d.transform.heightOffset!==void 0&&(st=d.transform.heightOffset,typeof st=="number"&&(H=st),console.log(`[Config] heightOffset config value: ${st}`)),d.lighting.directional&&(Tt=d.lighting.directional.azimuth,Et=d.lighting.directional.elevation),console.log("Scene configuration applied to global state")}async function ji(l){console.log("Initializing globe view...");const t=document.getElementById("start-overlay");t&&(t.classList.remove("visible"),t.style.display="none");const e=document.getElementById("globe-overlay");if(!e){console.error("Globe container not found");return}Qt=new ni(e,i=>{console.log("Site selected:",i),ft.navigateToSite(i)}),await Qt.init(l),Qt.show(),console.log("Globe view initialized successfully")}async function Xi(){console.log("Initializing F1000..."),await $i(),ft=new si;const l=ee(wt);if(ft.shouldShowGlobe(l)){console.log("No valid site parameter - showing globe"),await ji(l);return}console.log("Valid site parameter found - loading site:",ft.getCurrentSiteId());let t=ft.getCurrentSiteId();const e=Ne(wt,t);d=await Be(e),kt=t,Ni();const i=document.getElementById("scene-dropdown");i&&(i.value=kt);const o=document.getElementById("start-scene-dropdown");o&&(o.value=kt);const s=document.getElementById("start-title"),n=document.getElementById("start-description");d&&s&&n&&(s.textContent=d.name||"Unknown Location",n.textContent=d.description||"Prepare for an amazing journey"),ui(),wi(),gi(),Oi(),Ai(),Ii(),Hi(),Gi(),Si(),ki(),Ti(),window.addEventListener("resize",Vi),document.addEventListener("mousemove",Ei),document.addEventListener("pointerlockchange",Ri),document.addEventListener("pointerlockerror",Li),R.setAnimationLoop(zi),console.log("F1000 initialized successfully")}Xi();
