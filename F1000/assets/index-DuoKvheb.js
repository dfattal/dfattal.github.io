var zt=Object.defineProperty;var Dt=(a,e,t)=>e in a?zt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var g=(a,e,t)=>Dt(a,typeof e!="symbol"?e+"":e,t);import*as r from"three";import{GLTFLoader as bt}from"three/addons/loaders/GLTFLoader.js";import{dyno as v,SparkRenderer as Ot,SplatMesh as Gt}from"@sparkjsdev/spark";import{VRButton as Vt}from"three/addons/webxr/VRButton.js";import{XRControllerModelFactory as Bt}from"three/addons/webxr/XRControllerModelFactory.js";import{XRHandModelFactory as $t}from"three/addons/webxr/XRHandModelFactory.js";import{OrbitControls as Ht}from"three/addons/controls/OrbitControls.js";import{CSS2DRenderer as Nt,CSS2DObject as jt}from"three/addons/renderers/CSS2DRenderer.js";import{io as Xt}from"socket.io-client";import*as qt from"three/addons/utils/SkeletonUtils.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class Jt{constructor(e,t){this.camera=e,this.domElement=t,this.target=new r.Vector3,this.yaw=0,this.pitch=0,this.distance=5,this.minDistance=1,this.maxDistance=10,this.enableDamping=!0,this.dampingFactor=.1,this.targetYaw=0,this.targetPitch=0,this.targetDistance=5,this.maxPolarAngle=Math.PI,this.minPolarAngle=0,this.enablePan=!1,this.enabled=!0,this.isRotating=!1,this.isZooming=!1,this.mouseStart=new r.Vector2,this.mouseCurrent=new r.Vector2,this.rotateSpeed=1,this.zoomSpeed=1,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onWheel=this.onWheel.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.domElement.addEventListener("mousedown",this.onMouseDown),this.domElement.addEventListener("wheel",this.onWheel),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.syncFromCamera()}syncFromCamera(){const e=new r.Vector3().subVectors(this.camera.position,this.target);this.distance=e.length(),this.targetDistance=this.distance;const t=Math.sqrt(e.x*e.x+e.z*e.z);this.yaw=Math.atan2(e.x,e.z),this.pitch=Math.atan2(t,e.y),this.targetYaw=this.yaw,this.targetPitch=this.pitch}rotateLeft(e){this.targetYaw+=e}rotateUp(e){this.targetPitch-=e,this.targetPitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this.targetPitch))}dolly(e){e<0?this.targetDistance/=Math.pow(.95,this.zoomSpeed):e>0&&(this.targetDistance*=Math.pow(.95,this.zoomSpeed)),this.targetDistance=Math.max(this.minDistance,Math.min(this.maxDistance,this.targetDistance))}onMouseDown(e){this.enabled&&e.button===0&&(this.isRotating=!0,this.mouseStart.set(e.clientX,e.clientY),this.mouseCurrent.set(e.clientX,e.clientY),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp))}onMouseMove(e){if(this.isRotating){this.mouseCurrent.set(e.clientX,e.clientY);const t=this.mouseCurrent.x-this.mouseStart.x,i=this.mouseCurrent.y-this.mouseStart.y,s=2*Math.PI*t/this.domElement.clientHeight*this.rotateSpeed,o=2*Math.PI*i/this.domElement.clientHeight*this.rotateSpeed;this.rotateLeft(-s),this.rotateUp(-o),this.mouseStart.copy(this.mouseCurrent)}}onMouseUp(e){e.button===0&&(this.isRotating=!1,document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp))}onWheel(e){this.enabled&&(e.preventDefault(),this.dolly(e.deltaY))}onContextMenu(e){e.preventDefault()}update(){this.enableDamping?(this.yaw+=(this.targetYaw-this.yaw)*this.dampingFactor,this.pitch+=(this.targetPitch-this.pitch)*this.dampingFactor,this.distance+=(this.targetDistance-this.distance)*this.dampingFactor):(this.yaw=this.targetYaw,this.pitch=this.targetPitch,this.distance=this.targetDistance);const e=new r.Vector3(this.distance*Math.sin(this.pitch)*Math.sin(this.yaw),this.distance*Math.cos(this.pitch),this.distance*Math.sin(this.pitch)*Math.cos(this.yaw));return this.camera.position.copy(this.target).add(e),this.camera.lookAt(this.target),!0}getAzimuthalAngle(){return this.yaw}getPolarAngle(){return this.pitch}dispose(){this.domElement.removeEventListener("mousedown",this.onMouseDown),this.domElement.removeEventListener("wheel",this.onWheel),this.domElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}reset(){this.yaw=0,this.pitch=Math.PI/4,this.distance=5,this.targetYaw=this.yaw,this.targetPitch=this.pitch,this.targetDistance=this.distance}saveState(){this.savedYaw=this.yaw,this.savedPitch=this.pitch,this.savedDistance=this.distance}}const ke="w",ye="a",Ce="s",be="d",Qe="shift",He=" ",We="p";class Yt{constructor(e=!1){g(this,"map",new Map);console.log("KeyDisplay: isMobile =",e);const t=this.createKeyDiv(ke,e),i=this.createKeyDiv(ye,e),s=this.createKeyDiv(Ce,e),o=this.createKeyDiv(be,e),n=this.createKeyDiv(Qe,e),l=this.createKeyDiv("SPACE",e),c=this.createKeyDiv(We,e);this.map.set(ke,t),this.map.set(ye,i),this.map.set(Ce,s),this.map.set(be,o),this.map.set(Qe,n),this.map.set(He,l),this.map.set(We,c),document.body.appendChild(t),document.body.appendChild(i),document.body.appendChild(s),document.body.appendChild(o),document.body.appendChild(n),document.body.appendChild(l),document.body.appendChild(c),this.updatePosition()}createKeyDiv(e,t=!1){const i=document.createElement("div");return i.style.position="absolute",i.style.padding="8px 12px",i.style.minWidth="40px",i.style.textAlign="center",i.style.fontFamily="'Courier New', monospace",i.style.fontSize="16px",i.style.fontWeight="bold",i.style.color="#333",i.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",i.style.border="1px solid #999",i.style.borderRadius="4px",i.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",i.style.transition="all 0.1s ease",i.style.userSelect="none",i.style.opacity="0.6",i.textContent=e.toUpperCase(),t&&(i.style.display="none"),i}updatePosition(){this.map.get(ke).style.top=`${window.innerHeight-80-45}px`,this.map.get(ke).style.left="168px",this.map.get(ye).style.top=`${window.innerHeight-80}px`,this.map.get(ye).style.left="100px",this.map.get(Ce).style.top=`${window.innerHeight-80}px`,this.map.get(Ce).style.left="168px",this.map.get(be).style.top=`${window.innerHeight-80}px`,this.map.get(be).style.left=`${100+68*2}px`,this.map.get(Qe).style.top=`${window.innerHeight-80}px`,this.map.get(Qe).style.left="21px",this.map.get(He).style.top=`${window.innerHeight-80}px`,this.map.get(He).style.left=`${100+68*3+15}px`,this.map.get(We).style.top=`${window.innerHeight-80}px`,this.map.get(We).style.left=`${100+68*4+15*2}px`}down(e){const t=this.map.get(e.toLowerCase());t&&(t.style.background="linear-gradient(180deg, #00ff00, #00cc00)",t.style.color="#000",t.style.boxShadow="0 1px 2px rgba(0,0,0,0.3), inset 0 2px 4px rgba(0,0,0,0.2)",t.style.transform="translateY(2px)",t.style.opacity="1")}up(e){const t=this.map.get(e.toLowerCase());t&&(t.style.background="linear-gradient(180deg, #f0f0f0, #d0d0d0)",t.style.color="#333",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.5)",t.style.transform="translateY(0)",t.style.opacity="0.6")}}class _t{constructor(e,t,i,s,o,n,l,c=null,d=1){g(this,"currentAction");g(this,"toggleRun",!0);g(this,"walkVelocity",2);g(this,"runVelocity",5);g(this,"jumpForce",8);g(this,"gravity",-20);g(this,"maxFallSpeed",-50);g(this,"jumpCooldownDuration",.3);g(this,"characterHeightOffset",0);g(this,"maxHeight",null);g(this,"verticalVelocity",0);g(this,"isGrounded",!0);g(this,"jumpCooldown",0);g(this,"timeInAir",0);g(this,"airTimeThreshold",.4);g(this,"isJetpackActive",!1);g(this,"jetpackThrust",25);g(this,"jetpackTransitionDuration",.3);g(this,"jetpackTransitionTimer",0);g(this,"inertiaVelocityX",0);g(this,"inertiaVelocityZ",0);g(this,"hasInertia",!1);g(this,"raycaster",new r.Raycaster);g(this,"groundMeshes",[]);g(this,"rayOrigin",new r.Vector3);g(this,"rayDirection",new r.Vector3(0,-1,0));g(this,"forwardRaycaster",new r.Raycaster);g(this,"ceilingRaycaster",new r.Raycaster);g(this,"forwardGroundRaycaster",new r.Raycaster);g(this,"forwardCollisionDistance",.5);g(this,"ceilingCollisionDistance",2.5);g(this,"maxSlopeAngle",Math.PI/3);g(this,"maxStepHeight",.5);g(this,"tempCollisionVector",new r.Vector3);g(this,"tempCollisionNormal",new r.Vector3);g(this,"tempSlideVector",new r.Vector3);g(this,"walkDirection",new r.Vector3);g(this,"rotateAngle",new r.Vector3(0,1,0));g(this,"rotateQuaternion",new r.Quaternion);g(this,"fadeDuration",.2);g(this,"updateCameraTargetOffset",new r.Vector3);g(this,"cameraMode","third-person");g(this,"firstPersonPitch",0);g(this,"firstPersonYaw",0);g(this,"firstPersonHeadHeight",1.6);g(this,"targetOffsetY",1);this.model=e,this.mixer=t,this.animationsMap=i,this.orbitControl=s,this.camera=o,this.currentAction=n,l&&(this.groundMeshes=Array.isArray(l)?l:[l]),this.maxHeight=c,console.log(`[CharacterControls] maxHeight set to: ${this.maxHeight===null?"null (unlimited)":this.maxHeight.toFixed(2)}`),this.targetOffsetY=d,this.animationsMap.forEach((u,f)=>{f===n&&u.play()})}switchRunToggle(){this.toggleRun=!this.toggleRun}getGroundedState(){return this.isGrounded}getCurrentAction(){return this.currentAction}getJetpackActive(){return this.isJetpackActive}getGroundDistance(){const e=this.getGroundInfo();return Math.max(0,this.model.position.y-e.height)}getPosition(){return{x:this.model.position.x,y:this.model.position.y,z:this.model.position.z}}getMovementState(){return this.isJetpackActive&&!this.isGrounded?"jetpack":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?"idle":this.currentAction==="Run"?"run":this.currentAction==="Walk"?"walk":"idle"}setCameraMode(e){this.cameraMode=e,console.log(`CharacterControls: Camera mode set to ${e}`)}setFirstPersonRotation(e,t){this.firstPersonPitch=e,this.firstPersonYaw=t}placeOnGround(){const e=this.getGroundInfo();this.model.position.y=e.height+this.characterHeightOffset,console.log(`Character placed on ground at Y: ${this.model.position.y.toFixed(2)}`)}getGroundInfo(){if(this.groundMeshes.length===0)return{height:0,normal:null};this.rayOrigin.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.raycaster.set(this.rayOrigin,this.rayDirection);const e=this.raycaster.intersectObjects(this.groundMeshes,!0);if(e.length>0){const t=e[0];let i=null;if(t.face&&t.object){i=t.face.normal.clone();const s=new r.Matrix3().getNormalMatrix(t.object.matrixWorld);i.applyMatrix3(s).normalize()}return{height:t.point.y,normal:i}}return{height:-100,normal:null}}checkForwardCollision(e){if(this.groundMeshes.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y+1,this.model.position.z),this.forwardRaycaster.set(this.tempCollisionVector,e),this.forwardRaycaster.far=this.forwardCollisionDistance;const t=this.forwardRaycaster.intersectObjects(this.groundMeshes,!0);if(t.length>0){const i=t[0],s=i.face?i.face.normal.clone():new r.Vector3(0,1,0);if(i.object&&i.face){const l=new r.Matrix3().getNormalMatrix(i.object.matrixWorld);s.applyMatrix3(l).normalize()}const o=s.dot(new r.Vector3(0,1,0)),n=o>=.5;return{hit:!0,point:i.point,normal:s,distance:i.distance,isWalkable:n,surfaceAngle:Math.acos(Math.abs(o))*(180/Math.PI)}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}checkCeilingCollision(){if(this.groundMeshes.length===0)return{hit:!1,height:1/0,distance:1/0};this.tempCollisionVector.set(this.model.position.x,this.model.position.y,this.model.position.z);const e=new r.Vector3(0,1,0);this.ceilingRaycaster.set(this.tempCollisionVector,e),this.ceilingRaycaster.far=this.ceilingCollisionDistance;const t=this.ceilingRaycaster.intersectObjects(this.groundMeshes,!0);if(t.length>0){const i=t[0];return{hit:!0,height:i.point.y,distance:i.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardGround(e,t){if(this.groundMeshes.length===0)return{exists:!1,height:-100,normal:null,isWalkable:!1};const i=this.model.position.x+e.x*t,s=this.model.position.z+e.z*t;this.tempCollisionVector.set(i,this.model.position.y+10,s);const o=new r.Vector3(0,-1,0);this.forwardGroundRaycaster.set(this.tempCollisionVector,o);const n=this.forwardGroundRaycaster.intersectObjects(this.groundMeshes,!0);if(n.length>0){const l=n[0],c=l.point.y,d=l.face?l.face.normal:new r.Vector3(0,1,0),u=this.getGroundInfo().height,f=c-u,p=Math.acos(Math.abs(d.y)),b=p<=this.maxSlopeAngle||Math.abs(f)<=this.maxStepHeight;return{exists:!0,height:c,normal:d,isWalkable:b,slopeAngle:p,heightDifference:f}}return{exists:!1,height:-100,normal:null,isWalkable:!1}}update(e,t){if(this.jumpCooldown>0&&(this.jumpCooldown-=e),t[He]&&this.isGrounded&&this.jumpCooldown<=0&&(this.verticalVelocity=this.jumpForce,this.isGrounded=!1,this.jumpCooldown=this.jumpCooldownDuration),t[He]&&!this.isGrounded&&this.timeInAir>this.airTimeThreshold?(this.isJetpackActive||(this.isJetpackActive=!0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0),this.verticalVelocity+=this.jetpackThrust*e):this.isJetpackActive&&(this.isJetpackActive=!1,this.jetpackTransitionTimer=this.jetpackTransitionDuration,(this.inertiaVelocityX!==0||this.inertiaVelocityZ!==0)&&(this.hasInertia=!0)),this.jetpackTransitionTimer>0){const p=this.jetpackTransitionTimer/this.jetpackTransitionDuration;this.verticalVelocity+=this.jetpackThrust*p*e,this.jetpackTransitionTimer-=e}this.verticalVelocity+=this.gravity*e,this.verticalVelocity<this.maxFallSpeed&&(this.verticalVelocity=this.maxFallSpeed);const i=this.getGroundInfo(),s=i.height,o=this.model.position.y;if(this.model.position.y+=this.verticalVelocity*e,this.verticalVelocity>0){const p=this.checkCeilingCollision();if(p.hit){const b=p.height-this.characterHeightOffset;this.model.position.y>b&&(this.model.position.y=b,this.verticalVelocity=0)}}this.maxHeight!==null&&this.model.position.y>this.maxHeight&&(console.log(`[Height Cap] Enforcing ceiling: position.y=${this.model.position.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),this.model.position.y=this.maxHeight,this.verticalVelocity=0);const l=this.model.position.y-this.characterHeightOffset-s;let c=!0;if(i.normal&&(c=i.normal.dot(new r.Vector3(0,1,0))>=.5),l<=0&&c?(this.model.position.y=s+this.characterHeightOffset,this.verticalVelocity=0,this.isGrounded=!0,this.timeInAir=0,this.isJetpackActive&&(this.isJetpackActive=!1),this.jetpackTransitionTimer=0,this.hasInertia=!1,this.inertiaVelocityX=0,this.inertiaVelocityZ=0):(this.isGrounded=!1,this.timeInAir+=e),this.cameraMode==="first-person")this.camera.position.y=this.model.position.y+this.firstPersonHeadHeight;else{const p=this.model.position.y-o;this.camera.position.y+=p}const d=Qt.some(p=>t[p]===!0);let u="";if(this.isJetpackActive&&!this.isGrounded?u="TPose":!this.isGrounded&&this.timeInAir>this.airTimeThreshold?u="Idle":d&&this.toggleRun?u="Run":d?u="Walk":u="Idle",this.currentAction!==u){const p=this.animationsMap.get(u),b=this.animationsMap.get(this.currentAction);b&&p&&(b.fadeOut(this.fadeDuration),p.reset().fadeIn(this.fadeDuration).play(),this.currentAction=u)}this.mixer.update(e);const f=this.isGrounded||this.timeInAir<=this.airTimeThreshold;if(this.isJetpackActive&&!d&&(this.inertiaVelocityX=0,this.inertiaVelocityZ=0),d&&(f||this.isJetpackActive)){let p;this.cameraMode==="first-person"?p=this.firstPersonYaw:p=Math.atan2(this.camera.position.x-this.model.position.x,this.camera.position.z-this.model.position.z);const b=this.directionOffset(t);this.rotateQuaternion.setFromAxisAngle(this.rotateAngle,p+b),this.model.quaternion.rotateTowards(this.rotateQuaternion,.2),this.camera.getWorldDirection(this.walkDirection),this.walkDirection.y=0,this.walkDirection.normalize(),this.walkDirection.applyAxisAngle(this.rotateAngle,b);const k=this.toggleRun?this.runVelocity:this.walkVelocity;let w=this.walkDirection.x*k*e,C=this.walkDirection.z*k*e;this.isGrounded||(this.inertiaVelocityX=this.walkDirection.x*k,this.inertiaVelocityZ=this.walkDirection.z*k,this.hasInertia=!0);let O=!1,L=null;if(this.isGrounded){const I=Math.sqrt(w*w+C*C),z=this.checkForwardGround(this.walkDirection,I);z.isWalkable||(O=!0,z.normal?L=z.normal.clone():L=new r.Vector3(-this.walkDirection.x,0,-this.walkDirection.z).normalize())}const T=this.checkForwardCollision(this.walkDirection);if(T.hit||O){let I;T.hit?I=T.normal.clone():I=L.clone(),T.hit&&!T.isWalkable&&(I.y=0,I.normalize());const ie=this.tempSlideVector.set(w,0,C).dot(I);if(ie<0){const ee=w-ie*I.x,xe=C-ie*I.z;w=ee,C=xe}}this.model.position.x+=w,this.model.position.z+=C,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=w,this.camera.position.z+=C)}else if(this.hasInertia&&!this.isGrounded&&!this.isJetpackActive){let p=this.inertiaVelocityX*e,b=this.inertiaVelocityZ*e;const k=new r.Vector3(this.inertiaVelocityX,0,this.inertiaVelocityZ).normalize(),w=this.checkForwardCollision(k);if(w.hit){const C=w.normal.clone();w.isWalkable||(C.y=0,C.normalize());const L=this.tempSlideVector.set(p,0,b).dot(C);if(L<0){const T=p-L*C.x,I=b-L*C.z;p=T,b=I}}this.model.position.x+=p,this.model.position.z+=b,this.cameraMode==="first-person"?(this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z):(this.camera.position.x+=p,this.camera.position.z+=b)}if(this.cameraMode==="first-person"){this.camera.position.x=this.model.position.x,this.camera.position.z=this.model.position.z,this.model.rotation.y=this.firstPersonYaw,this.camera.rotation.order="YXZ",this.camera.rotation.y=this.firstPersonYaw,this.camera.rotation.x=this.firstPersonPitch,this.camera.rotation.z=0;const p=new r.Vector3;this.camera.getWorldDirection(p),this.updateCameraTargetOffset.copy(this.camera.position).add(p),this.orbitControl.target.copy(this.updateCameraTargetOffset)}else{const b=new r.Vector3(0,this.targetOffsetY,0).clone().applyQuaternion(this.model.quaternion);this.updateCameraTargetOffset.x=this.model.position.x+b.x,this.updateCameraTargetOffset.y=this.model.position.y+b.y,this.updateCameraTargetOffset.z=this.model.position.z+b.z,this.orbitControl.target.copy(this.updateCameraTargetOffset)}}directionOffset(e){let t=0;return e[ke]?e[ye]?t=Math.PI/4:e[be]&&(t=-Math.PI/4):e[Ce]?e[ye]?t=Math.PI/4+Math.PI/2:e[be]?t=-Math.PI/4-Math.PI/2:t=Math.PI:e[ye]?t=Math.PI/2:e[be]&&(t=-Math.PI/2),t}updateVRPhysics(e,t,i,s,o,n,l,c,d){const u=e.clone();if(c&&(t.y+=this.jetpackThrust*s),d>0){const w=d/this.jetpackTransitionDuration;t.y+=this.jetpackThrust*w*s,d-=s}if(t.y+=this.gravity*s,t.y<this.maxFallSpeed&&(t.y=this.maxFallSpeed),u.y+=t.y*s,t.y>0){const w=this.checkCeilingCollisionAtPosition(u,o);if(w.hit){const C=w.height;u.y>C&&(u.y=C,t.y=0)}}this.maxHeight!==null&&u.y>this.maxHeight&&(console.log(`[Height Cap VR] Enforcing ceiling: position.y=${u.y.toFixed(2)} > maxHeight=${this.maxHeight.toFixed(2)}`),u.y=this.maxHeight,t.y=0);const f=this.getGroundInfoAtPosition(u,o),p=f.height;let b=!0;if(f.normal&&(b=f.normal.dot(new r.Vector3(0,1,0))>=.5),u.y-p<=0&&b?(u.y=p,t.y=0,n=!0,l=0,c&&(c=!1),d=0):(n=!1,l+=s),i&&i.lengthSq()>0){let w=i.x,C=i.z;const O=i.clone().normalize(),L=this.checkForwardCollisionAtPosition(u,O,o);if(L.hit){const T=L.normal.clone();L.isWalkable||(T.y=0,T.normalize());const z=new r.Vector3(w,0,C).dot(T);z<0&&(w=w-z*T.x,C=C-z*T.z)}u.x+=w,u.z+=C}return{newPosition:u,velocity:t,isGrounded:n,airTime:l,jetpackActive:c,jetpackTransitionTimer:d}}getGroundInfoAtPosition(e,t){if(!t||t.length===0)return{height:0,normal:null};const i=Math.max(e.y+10,100),s=new r.Vector3(e.x,i,e.z),o=new r.Vector3(0,-1,0),n=new r.Raycaster;n.set(s,o);const l=n.intersectObjects(t,!0);if(l.length>0){const c=l[0];let d=null;if(c.face&&c.object){d=c.face.normal.clone();const u=new r.Matrix3().getNormalMatrix(c.object.matrixWorld);d.applyMatrix3(u).normalize()}return{height:c.point.y,normal:d}}return{height:-100,normal:null}}checkCeilingCollisionAtPosition(e,t){if(!t||t.length===0)return{hit:!1,height:1/0,distance:1/0};const i=new r.Vector3(e.x,e.y+1,e.z),s=new r.Vector3(0,1,0),o=new r.Raycaster;o.set(i,s),o.far=this.ceilingCollisionDistance;const n=o.intersectObjects(t,!0);if(n.length>0){const l=n[0];return{hit:!0,height:l.point.y,distance:l.distance}}return{hit:!1,height:1/0,distance:1/0}}checkForwardCollisionAtPosition(e,t,i){if(!i||i.length===0)return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0};const s=new r.Vector3(e.x,e.y+1,e.z),o=new r.Raycaster;o.set(s,t),o.far=this.forwardCollisionDistance;const n=o.intersectObjects(i,!0);if(n.length>0){const l=n[0],c=l.face?l.face.normal.clone():new r.Vector3(0,1,0);if(l.object&&l.face){const f=new r.Matrix3().getNormalMatrix(l.object.matrixWorld);c.applyMatrix3(f).normalize()}const u=c.dot(new r.Vector3(0,1,0))>=.5;return{hit:!0,point:l.point,normal:c,distance:l.distance,isWalkable:u}}return{hit:!1,point:null,normal:null,distance:1/0,isWalkable:!0}}}const Qt=[ke,ye,Ce,be];class Wt{constructor(){this.base=null,this.thumb=null,this.active=!1,this.originX=0,this.originY=0,this.currentX=0,this.currentY=0,this.maxDistance=40,this.deadzone=.15,this.createElements()}createElements(){this.base=document.createElement("div"),this.base.id="joystick-base",this.base.style.display="none",document.body.appendChild(this.base),this.thumb=document.createElement("div"),this.thumb.id="joystick-thumb",this.base.appendChild(this.thumb)}show(e,t){this.active=!0,this.originX=e,this.originY=t,this.currentX=e,this.currentY=t,this.base.style.left=`${e}px`,this.base.style.top=`${t}px`,this.base.style.display="block",this.thumb.style.transform="translate(0px, 0px)",requestAnimationFrame(()=>{this.base.style.opacity="1"})}update(e,t){if(!this.active)return;this.currentX=e,this.currentY=t;let i=e-this.originX,s=t-this.originY;if(Math.sqrt(i*i+s*s)>this.maxDistance){const n=Math.atan2(s,i);i=Math.cos(n)*this.maxDistance,s=Math.sin(n)*this.maxDistance}this.thumb.style.transform=`translate(${i}px, ${s}px)`}hide(){this.active=!1,this.base.style.opacity="0",setTimeout(()=>{this.active||(this.base.style.display="none")},200)}getDirection(){if(!this.active)return{angle:0,magnitude:0};const e=this.currentX-this.originX,t=this.currentY-this.originY,i=Math.sqrt(e*e+t*t),s=Math.min(i/this.maxDistance,1);return s<this.deadzone?{angle:0,magnitude:0}:{angle:Math.atan2(t,e),magnitude:s}}getKeys(){const{angle:e,magnitude:t}=this.getDirection();if(t===0)return{w:!1,a:!1,s:!1,d:!1};let i=e*180/Math.PI;i<0&&(i+=360);const s={w:!1,a:!1,s:!1,d:!1};return i>=337.5||i<22.5?s.d=!0:i>=22.5&&i<67.5?(s.d=!0,s.w=!0):i>=67.5&&i<112.5?s.s=!0:i>=112.5&&i<157.5?(s.a=!0,s.s=!0):i>=157.5&&i<202.5?s.a=!0:i>=202.5&&i<247.5?(s.a=!0,s.w=!0):i>=247.5&&i<292.5?s.w=!0:i>=292.5&&i<337.5&&(s.d=!0,s.w=!0),s}isActive(){return this.active}}class Ut{constructor(e,t){this.keysPressed=e,this.orbitControls=t,this.joystick=new Wt,this.activeTouchId=null,this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.touchLastX=0,this.touchLastY=0,this.touchHasMoved=!1,this.longPressThreshold=400,this.movementThreshold=10,this.jetpackActive=!1,this.orbitControlsEnabled=!0,this.cameraMode="third-person",this.firstPersonCallback=null,this.isPaintMode=!1,this.paintCallback=null,this.paintEndCallback=null,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.setupEventListeners(),this.startUpdateLoop()}setupEventListeners(){document.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),document.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1}),document.addEventListener("contextmenu",this.handleContextMenu,{passive:!1})}handleTouchStart(e){const t=e.target;if(t&&(t.tagName==="BUTTON"||t.tagName==="SELECT"||t.tagName==="INPUT"||t.tagName==="A"||t.closest("button")||t.closest("select")||t.closest("input")))return;const i=e.changedTouches[0],s=Date.now();this.activeTouchId!==null||this.joystick.isActive()||(this.activeTouchId=i.identifier,this.touchStartTime=s,this.touchStartX=i.clientX,this.touchStartY=i.clientY,this.touchLastX=i.clientX,this.touchLastY=i.clientY,this.touchHasMoved=!1,e.preventDefault())}handleTouchMove(e){let t=null;for(let n=0;n<e.changedTouches.length;n++)if(e.changedTouches[n].identifier===this.activeTouchId){t=e.changedTouches[n];break}if(!t)return;if(e.preventDefault(),this.joystick.isActive()){this.joystick.update(t.clientX,t.clientY);return}const i=t.clientX-this.touchStartX,s=t.clientY-this.touchStartY;if(Math.sqrt(i*i+s*s)>this.movementThreshold&&(this.touchHasMoved=!0),this.touchHasMoved){const n=t.clientX-this.touchLastX,l=t.clientY-this.touchLastY;this.isPaintMode&&this.paintCallback?this.paintCallback(t.clientX,t.clientY):this.handleCameraRotation(n,l)}this.touchLastX=t.clientX,this.touchLastY=t.clientY}handleTouchEnd(e){for(let t=0;t<e.changedTouches.length;t++)if(e.changedTouches[t].identifier===this.activeTouchId){this.joystick.isActive()&&this.deactivateJoystick(),this.isPaintMode&&this.paintEndCallback&&this.paintEndCallback(),this.activeTouchId=null,this.touchHasMoved=!1;break}}handleCameraRotation(e,t){this.cameraMode==="first-person"?this.firstPersonCallback&&this.firstPersonCallback(e,t):this.orbitControls&&(this.orbitControls.rotateLeft(-e*.005),this.orbitControls.rotateUp(-t*.005),this.orbitControls.update())}activateJoystick(e,t){this.joystick.show(e,t),this.orbitControls&&(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1),console.log("Virtual joystick activated")}deactivateJoystick(){this.joystick.hide(),this.keysPressed.w=!1,this.keysPressed.a=!1,this.keysPressed.s=!1,this.keysPressed.d=!1,this.orbitControls&&this.orbitControlsEnabled&&(this.orbitControls.enabled=!0),console.log("Virtual joystick deactivated")}activateJetpack(){this.jetpackActive=!0,this.keysPressed[" "]=!0,console.log("Jetpack mode activated")}deactivateJetpack(){this.jetpackActive=!1,this.keysPressed[" "]=!1,console.log("Jetpack mode deactivated")}startUpdateLoop(){const e=()=>{if(this.joystick.isActive()){const t=this.joystick.getKeys();this.keysPressed.w=t.w,this.keysPressed.a=t.a,this.keysPressed.s=t.s,this.keysPressed.d=t.d}this.activeTouchId!==null&&!this.joystick.isActive()&&!this.touchHasMoved&&Date.now()-this.touchStartTime>=this.longPressThreshold&&this.activateJoystick(this.touchStartX,this.touchStartY),requestAnimationFrame(e)};e()}setCameraMode(e){this.cameraMode=e,console.log(`TouchControls: Camera mode set to ${e}`)}setFirstPersonCallback(e){this.firstPersonCallback=e}setPaintMode(e){this.isPaintMode=e,this.orbitControls&&(e?(this.orbitControlsEnabled=this.orbitControls.enabled,this.orbitControls.enabled=!1):this.orbitControls.enabled=this.orbitControlsEnabled),console.log(`TouchControls: Paint mode ${e?"ON":"OFF"}`)}setPaintCallback(e){this.paintCallback=e}setPaintEndCallback(e){this.paintEndCallback=e}handleContextMenu(e){return e.preventDefault(),!1}disable(){document.removeEventListener("touchstart",this.handleTouchStart),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("touchcancel",this.handleTouchEnd),document.removeEventListener("contextmenu",this.handleContextMenu),this.joystick.isActive()&&this.deactivateJoystick(),console.log("Touch controls disabled")}}async function Kt(){try{const a=await fetch("models/scenes.json");if(!a.ok)throw new Error(`Failed to load scenes manifest: ${a.statusText}`);const e=await a.json();return console.log("Scenes manifest loaded:",e),e}catch(a){throw console.error("Error loading scenes manifest:",a),a}}async function Zt(a){try{const e=await fetch(a);if(!e.ok)throw new Error(`Failed to load scene config from ${a}: ${e.statusText}`);const t=await e.json();return ei(t),console.log(`Scene config loaded: ${t.name}`,t),t}catch(e){throw console.error(`Error loading scene config from ${a}:`,e),e}}function ei(a){const e=["name","assets","transform","character","camera","lighting","scene"];for(const t of e)if(!(t in a))throw new Error(`Scene config missing required field: ${t}`);if(!a.assets.splatFile||!a.assets.collisionFile||!a.assets.characterFile)throw new Error("Scene config missing required asset files");if(typeof a.transform.scale!="number")throw new Error("Scene config: transform.scale must be a number");console.log("Scene config validation passed")}function dt(a){return a.scenes.map(e=>({id:e.id,name:e.name,description:e.description||"",latitude:e.latitude||0,longitude:e.longitude||0,thumbnail:e.thumbnail||"models/thumbnails/placeholder.jpg"}))}function ti(a){var e;return a.defaultScene||((e=a.scenes[0])==null?void 0:e.id)||"StoneHenge"}function ii(a,e){const t=a.scenes.find(i=>i.id===e);return t?t.config:null}class si{constructor(e,t,i={}){this.context=e,this.destination=t,this.buffer=null,this.source=null,this.gainNode=this.context.createGain(),this.gainNode.gain.value=i.initialGain!==void 0?i.initialGain:0,this.gainNode.connect(this.destination),this.isPlaying=!1}setBuffer(e){this.buffer=e}start(){if(!(this.isPlaying||!this.buffer)){this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.gainNode);try{this.source.start(),this.isPlaying=!0}catch(e){console.warn("LoopedTrack start failed:",e)}}}stop(){if(this.isPlaying){try{this.source.stop()}catch{}try{this.source.disconnect()}catch{}this.source=null,this.isPlaying=!1}}dispose(){this.stop();try{this.gainNode.disconnect()}catch{}this.gainNode=null}}class oi{constructor(e={},t=!1){g(this,"isMobile",!1);g(this,"audioContext",null);g(this,"masterGain",null);g(this,"oneShotGain",null);g(this,"tracks",{background:null,walking:null,running:null,jetpack:null});g(this,"buffers",{background:null,walking:null,running:null,jetpack:null,magicReveal:null});g(this,"backgroundMusicEnabled",!0);g(this,"movementSoundsEnabled",!0);g(this,"backgroundMusicVolume",.3);g(this,"walkingSoundVolume",.25);g(this,"runningSoundVolume",.15);g(this,"jetpackVolume",.5);g(this,"magicRevealVolume",.6);g(this,"fadeSpeed",2);g(this,"backgroundMusicTarget",0);g(this,"walkingSoundTarget",0);g(this,"runningSoundTarget",0);g(this,"jetpackTarget",0);g(this,"currentMovementState","idle");g(this,"previousMovementState","idle");g(this,"audioUnlocked",!1);g(this,"loopedSoundsStarted",!1);g(this,"preloadPromise",null);this.config=e,this.isMobile=t,this.ensureContext(),this.setupGraph(),this.preloadPromise=this.preloadAll().then(()=>{console.log("Audio buffers preloaded")}).catch(i=>{console.warn("Audio preload failed:",i)}),console.log("AudioManager (Web Audio) initialized with config:",e,"mobile:",t)}ensureContext(){if(this.audioContext)return this.audioContext;const e=window.AudioContext||window.webkitAudioContext;return this.audioContext=new e,this.audioContext}setupGraph(){if(this.masterGain)return;const e=this.ensureContext();this.masterGain=e.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(e.destination),this.oneShotGain=e.createGain(),this.oneShotGain.gain.value=this.magicRevealVolume,this.oneShotGain.connect(this.masterGain)}async preloadAll(){const e=[];this.config.backgroundMusic&&!this.buffers.background&&e.push(this.loadBuffer(this.config.backgroundMusic,"background").then(t=>this.buffers.background=t).catch(t=>console.warn("Failed to load background:",t))),this.config.runningSound&&!this.buffers.running&&e.push(this.loadBuffer(this.config.runningSound,"running").then(t=>this.buffers.running=t).catch(t=>console.warn("Failed to load running:",t))),this.config.jetpackSound&&!this.buffers.jetpack&&e.push(this.loadBuffer(this.config.jetpackSound,"jetpack").then(t=>this.buffers.jetpack=t).catch(t=>console.warn("Failed to load jetpack:",t))),!this.isMobile&&this.config.walkingSound&&!this.buffers.walking&&e.push(this.loadBuffer(this.config.walkingSound,"walking").then(t=>this.buffers.walking=t).catch(t=>console.warn("Failed to load walking:",t))),this.config.magicReveal&&!this.buffers.magicReveal&&e.push(this.loadBuffer(this.config.magicReveal,"magicReveal").then(t=>this.buffers.magicReveal=t).catch(t=>console.warn("Failed to load magicReveal:",t))),e.length>0?(console.log(`Loading ${e.length} audio buffers...`),await Promise.allSettled(e),console.log("Audio preload complete (some may have failed)")):console.log("All audio buffers already loaded")}async loadBuffer(e){const t=this.ensureContext(),s=await(await fetch(e)).arrayBuffer();return await new Promise((o,n)=>{try{const l=t.decodeAudioData(s);l&&typeof l.then=="function"?l.then(o).catch(c=>{try{t.decodeAudioData(s,o,n)}catch(d){n(d)}}):t.decodeAudioData(s,o,n)}catch{try{t.decodeAudioData(s,o,n)}catch(c){n(c)}}})}async unlockAudio(){if(this.audioUnlocked){console.log("Audio already unlocked");return}if(this.isMobile){try{if(this.audioContext&&this.audioContext.state!=="closed")try{await this.audioContext.close()}catch{}}catch{}const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,this.masterGain=null,this.oneShotGain=null,this.tracks={background:null,walking:null,running:null,jetpack:null},this.setupGraph()}const e=this.ensureContext();try{await e.resume()}catch(t){console.warn("AudioContext resume failed:",t)}try{await this.preloadAll()}catch(t){console.warn("Continuing without all audio buffers:",t)}this.startOrCreateTrack("background",this.buffers.background),this.isMobile||this.startOrCreateTrack("walking",this.buffers.walking),this.startOrCreateTrack("running",this.buffers.running),this.startOrCreateTrack("jetpack",this.buffers.jetpack),this.audioUnlocked=!0,this.loopedSoundsStarted=!0,console.log("âœ“ Web Audio unlocked, looped tracks running at gain 0")}startOrCreateTrack(e,t){t&&(this.tracks[e]||(this.tracks[e]=new si(this.audioContext,this.masterGain,{initialGain:0}),this.tracks[e].setBuffer(t)),this.tracks[e].start())}playMagicReveal(e=0){if(!this.buffers.magicReveal)return;const t=()=>{try{const i=this.audioContext.createBufferSource(),s=this.audioContext.createGain();s.gain.value=this.magicRevealVolume,i.buffer=this.buffers.magicReveal,i.connect(s).connect(this.masterGain),i.start(),i.onended=()=>{try{i.disconnect()}catch{}try{s.disconnect()}catch{}}}catch(i){console.warn("Magic reveal play failed:",i)}};e>0?setTimeout(t,e*1e3):t()}startBackgroundMusic(){this.backgroundMusicEnabled&&(this.backgroundMusicTarget=this.backgroundMusicVolume,console.log("Background music fading in"))}stopBackgroundMusic(){this.backgroundMusicTarget=0,console.log("Background music fading out")}updateMovementSounds(e){if(this.previousMovementState=this.currentMovementState,this.currentMovementState=e,this.previousMovementState!==this.currentMovementState&&console.log(`Movement state changed: ${this.previousMovementState} -> ${e}`),!this.movementSoundsEnabled){this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0;return}e==="walk"?(this.isMobile?this.walkingSoundTarget=0:this.walkingSoundTarget=this.walkingSoundVolume,this.runningSoundTarget=0,this.jetpackTarget=0):e==="run"?(this.walkingSoundTarget=0,this.runningSoundTarget=this.runningSoundVolume,this.jetpackTarget=0):e==="jetpack"?(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=this.jetpackVolume):(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0)}update(e){this.rampGainTo("background",this.backgroundMusicTarget,e),this.isMobile||this.rampGainTo("walking",this.walkingSoundTarget,e),this.rampGainTo("running",this.runningSoundTarget,e),this.rampGainTo("jetpack",this.jetpackTarget,e)}rampGainTo(e,t,i){const s=this.tracks[e];if(!s||!s.gainNode)return;const o=s.gainNode.gain.value;if(o===t)return;const n=this.fadeSpeed*i,l=o<t?Math.min(t,o+n):Math.max(t,o-n),c=this.audioContext.currentTime;try{s.gainNode.gain.cancelScheduledValues(c),s.gainNode.gain.setValueAtTime(o,c),s.gainNode.gain.linearRampToValueAtTime(l,c+.05)}catch{s.gainNode.gain.value=l}}toggleBackgroundMusic(){this.backgroundMusicEnabled=!this.backgroundMusicEnabled,this.backgroundMusicEnabled?this.startBackgroundMusic():this.stopBackgroundMusic(),console.log("Background music:",this.backgroundMusicEnabled?"ON":"OFF")}toggleMovementSounds(){this.movementSoundsEnabled=!this.movementSoundsEnabled,this.movementSoundsEnabled||(this.walkingSoundTarget=0,this.runningSoundTarget=0,this.jetpackTarget=0),console.log("Movement sounds:",this.movementSoundsEnabled?"ON":"OFF")}setMasterVolume(e){const t=Math.max(0,Math.min(1,e));this.backgroundMusicVolume=t*.3,this.walkingSoundVolume=t*.25,this.runningSoundVolume=t*.15,this.jetpackVolume=t*.5,this.oneShotGain&&(this.oneShotGain.gain.value=this.magicRevealVolume*t),console.log("Master volume set to:",t)}dispose(){Object.values(this.tracks).forEach(e=>{e&&e.dispose()}),this.tracks={background:null,walking:null,running:null,jetpack:null};try{this.oneShotGain&&this.oneShotGain.disconnect()}catch{}try{this.masterGain&&this.masterGain.disconnect()}catch{}try{this.audioContext.suspend()}catch{}console.log("AudioManager (Web Audio) disposed")}}class ni{constructor(e,t,i,s){this.renderer=e,this.camera=t,this.scene=i,this.sceneConfig=s,this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.xrConfig=(s==null?void 0:s.xr)||{enabled:!0,referenceSpaceType:"local-floor",referenceSpaceOrigin:{position:{x:0,y:0,z:0},rotation:{y:0}},userHeight:1.6},this.vrVelocity=new r.Vector3,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1,this.jetpackTransitionTimer=0,this.moveSpeed=5,this.runSpeedMultiplier=2,this.isRunning=!1,this.teleportTarget=null,this.teleportReticle=null,this.isTeleporting=!1,this.characterControls=null,this.orbitControls=null,this.xrControllers=null,this.xrHands=null,this.gaussianSplat=null,this.worldOffset=new r.Vector3,this.yRotation=0,this.xRotation=0,this.actualReferenceOrigin=null,this.characterPosition=new r.Vector3,this.init()}async init(){if(!this.xrConfig.enabled){console.log("XR disabled in scene config");return}this.renderer.xr.enabled=!0,await this.createVRButton(),this.renderer.xr.addEventListener("sessionstart",this.onSessionStart.bind(this)),this.renderer.xr.addEventListener("sessionend",this.onSessionEnd.bind(this)),this.createTeleportReticle(),console.log("XRManager initialized",this.xrConfig)}async createVRButton(){if(!navigator.xr){console.log("WebXR not available, VR button hidden");return}try{if(!await navigator.xr.isSessionSupported("immersive-vr")){console.log("immersive-vr not supported, VR button hidden");return}const t=Vt.createButton(this.renderer);t.style.position="fixed",t.style.bottom="90px",t.style.right="30px",t.style.zIndex="1000",document.body.appendChild(t),this.vrButton=t,console.log("WebXR available, VR button shown")}catch(e){console.warn("Error checking WebXR support:",e)}}createTeleportReticle(){const e=new r.RingGeometry(.2,.25,32),t=new r.MeshBasicMaterial({color:65280,side:r.DoubleSide,transparent:!0,opacity:.8});this.teleportReticle=new r.Mesh(e,t),this.teleportReticle.rotation.x=-Math.PI/2,this.teleportReticle.visible=!1,this.scene.add(this.teleportReticle)}async onSessionStart(){var e,t,i;if(console.log("XR session starting..."),this.session=this.renderer.xr.getSession(),this.isXRActive=!0,this.gaussianSplat){this.gaussianSplat.visible=!0,console.log("Gaussian splat visibility ensured for VR mode:",this.gaussianSplat.visible);let s=this.gaussianSplat.parent,o=0;for(;s&&o<5;)console.log(`  Parent ${o}:`,s.type||s.constructor.name),s=s.parent,o++}else console.warn("Gaussian splat reference not set in XRManager");try{const s=this.xrConfig.referenceSpaceType||"local-floor";try{this.localSpace=await this.session.requestReferenceSpace(s),console.log(`XR reference space type: ${s}`)}catch{console.warn(`${s} not supported, falling back to 'local'`),this.localSpace=await this.session.requestReferenceSpace("local")}const o=((t=(e=this.sceneConfig)==null?void 0:e.character)==null?void 0:t.spawn)||{},n=o.position||{x:0,y:"auto",z:40},l=o.rotation||{y:0},c=n.x,d=n.z,u=((i=this.characterControls)==null?void 0:i.groundMeshes)||[];let f=0;if(u.length>0&&this.characterControls){const k=new r.Vector3(c,1e3,d);f=this.characterControls.getGroundInfoAtPosition(k,u).height,f<-50?(console.warn(`No ground found at XR spawn (${c}, ${d}), using Y=0`),f=0):console.log(`Ground height at XR spawn (${c}, ${d}): ${f.toFixed(2)}`)}const p=this.xrConfig.userHeight||1.6,b={x:c,y:f,z:d};this.actualReferenceOrigin={position:b,rotation:l,userHeight:p},this.characterPosition.set(b.x,b.y,b.z),this.setReferenceSpaceOrigin(b,l),console.log("XR reference space initialized at:",b),console.log("Character position (play space center):",this.characterPosition)}catch(s){console.error("Failed to request reference space:",s)}this.orbitControls&&(this.orbitControls.enabled=!1),this.hideNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!1),this.xrControllers&&this.xrControllers.enable(),this.xrHands&&this.xrHands.enable(),this.vrVelocity.set(0,0,0),this.worldOffset.set(0,0,0),this.yRotation=0,this.xRotation=0,this.isGrounded=!1,this.airTime=0,this.jetpackActive=!1}onSessionEnd(){console.log("XR session ended"),this.session=null,this.isXRActive=!1,this.localSpace=null,this.currentReferenceSpace=null,this.actualReferenceOrigin=null,this.characterPosition.set(0,0,0),this.orbitControls&&(this.orbitControls.enabled=!0),this.showNonXRUI(),this.characterControls&&this.characterControls.model&&(this.characterControls.model.visible=!0),this.xrControllers&&this.xrControllers.disable(),this.xrHands&&this.xrHands.disable(),this.teleportReticle.visible=!1}setReferenceSpaceOrigin(e,t){if(!this.localSpace)return;const i=e||{x:0,y:0,z:0},s=t||{y:0},o=new r.PerspectiveCamera;o.position.set(i.x,i.y,i.z),o.rotation.order="YXZ",o.rotation.y=s.y*(Math.PI/180),o.updateMatrixWorld();const n=o.quaternion,l=new XRRigidTransform({x:i.x,y:i.y,z:i.z},{x:n.x,y:n.y,z:n.z,w:n.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(l.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace),this.worldOffset.set(0,0,0)}updateReferenceSpaceByOffset(e){if(!this.currentReferenceSpace||!this.localSpace)return;this.worldOffset.add(e);const t=this.actualReferenceOrigin||this.xrConfig.referenceSpaceOrigin,i=t.position||{x:0,y:0,z:0},s=t.rotation||{y:0},o={x:i.x+this.worldOffset.x,y:i.y+this.worldOffset.y,z:i.z+this.worldOffset.z},n=new r.PerspectiveCamera;n.position.set(o.x,o.y,o.z),n.rotation.order="YXZ",n.rotation.y=s.y*(Math.PI/180)+this.yRotation,n.rotation.x=this.xRotation,n.updateMatrixWorld();const l=n.quaternion,c=new XRRigidTransform({x:o.x,y:o.y,z:o.z},{x:l.x,y:l.y,z:l.z,w:l.w});this.currentReferenceSpace=this.localSpace.getOffsetReferenceSpace(c.inverse),this.renderer.xr.setReferenceSpace(this.currentReferenceSpace)}teleportTo(e){if(!this.isXRActive)return;const t=e.clone(),i=new r.Vector3().subVectors(t,this.characterPosition);this.characterPosition.copy(t),this.updateReferenceSpaceByOffset(i),console.log("Teleported to ground:",e,"character at feet:",t)}updateTeleportTarget(e){e?(this.teleportReticle.position.copy(e),this.teleportReticle.visible=!0,this.teleportTarget=e.clone()):(this.teleportReticle.visible=!1,this.teleportTarget=null)}executeTeleport(){this.teleportTarget&&(this.teleportTo(this.teleportTarget),this.teleportReticle.visible=!1,this.teleportTarget=null)}handleThumbstickMovement(e,t){if(!this.isXRActive||e.lengthSq()<.01)return;const i=this.renderer.xr.getCamera(),s=new r.Vector3(0,0,-1),o=new r.Vector3(1,0,0),n=Math.atan2(i.matrixWorld.elements[8],i.matrixWorld.elements[10]);s.applyAxisAngle(new r.Vector3(0,1,0),n),o.applyAxisAngle(new r.Vector3(0,1,0),n);const l=new r.Vector3().addScaledVector(s,-e.y).addScaledVector(o,e.x);l.y=0,l.normalize();const c=this.moveSpeed*(this.isRunning?this.runSpeedMultiplier:1);return l.multiplyScalar(c*t)}handleThumbstickRotation(e,t){if(!this.isXRActive||!e)return;const i=2,s=.15,o=Math.PI/2-.1;let n=!1;if(Math.abs(e.x)>s){const l=-e.x*i*t;this.yRotation+=l,n=!0}if(Math.abs(e.y)>s){const l=-e.y*i*t;this.xRotation+=l,this.xRotation=Math.max(-o,Math.min(o,this.xRotation)),n=!0}n&&this.updateReferenceSpaceByOffset(new r.Vector3)}updateVRPhysics(e,t){if(!this.isXRActive||!this.characterControls)return;const i=this.characterPosition.clone();let s=new r.Vector3;if(this.xrControllers){const l=this.xrControllers.getThumbstickAxes();l&&(s=this.handleThumbstickMovement(l,e)||new r.Vector3);const c=this.xrControllers.getRightThumbstickAxes();c&&this.handleThumbstickRotation(c,e)}const o=this.characterControls.updateVRPhysics(i,this.vrVelocity,s,e,t,this.isGrounded,this.airTime,this.jetpackActive,this.jetpackTransitionTimer);this.vrVelocity.copy(o.velocity),this.isGrounded=o.isGrounded,this.airTime=o.airTime,this.jetpackActive=o.jetpackActive,this.jetpackTransitionTimer=o.jetpackTransitionTimer;const n=new r.Vector3().subVectors(o.newPosition,i);n.lengthSq()>1e-4&&(this.characterPosition.copy(o.newPosition),this.updateReferenceSpaceByOffset(n),Math.random()<.01&&console.log("VR Physics:",{characterY:this.characterPosition.y.toFixed(2),deltaY:n.y.toFixed(3),isGrounded:o.isGrounded,velocity:this.vrVelocity.y.toFixed(2)}))}update(e,t){this.isXRActive&&(this.updateVRPhysics(e,t),this.xrControllers&&this.xrControllers.update(e),this.xrHands&&this.xrHands.update())}hideNonXRUI(){const e=document.getElementById("touch-controls-container");e&&(e.style.display="none");const t=document.getElementById("camera-toggle");t&&(t.style.display="none");const i=document.getElementById("key-display");i&&(i.style.display="none")}showNonXRUI(){const e=document.getElementById("touch-controls-container");e&&(e.style.display="block");const t=document.getElementById("camera-toggle");t&&(t.style.display="block");const i=document.getElementById("key-display");i&&(i.style.display="block")}getIsXRActive(){return this.isXRActive}getXRCamera(){return this.isXRActive?this.renderer.xr.getCamera():null}onJumpPressed(){this.isGrounded&&(this.vrVelocity.y=this.characterControls.jumpForce,this.isGrounded=!1,this.airTime=0)}onJetpackPressed(e){this.airTime>.4&&(this.jetpackActive=e)}onRunToggle(){this.isRunning=!this.isRunning,console.log("Run mode:",this.isRunning?"ON":"OFF")}onResetPitch(){this.xRotation=0,console.log("Camera pitch reset to flat (0 degrees)"),this.updateReferenceSpaceByOffset(new r.Vector3)}dispose(){this.vrButton&&this.vrButton.parentNode&&this.vrButton.parentNode.removeChild(this.vrButton),this.teleportReticle&&(this.scene.remove(this.teleportReticle),this.teleportReticle.geometry.dispose(),this.teleportReticle.material.dispose()),this.renderer.xr.removeEventListener("sessionstart",this.onSessionStart),this.renderer.xr.removeEventListener("sessionend",this.onSessionEnd)}}class ai{constructor(e,t,i){this.renderer=e,this.scene=t,this.xrManager=i,this.controller0=null,this.controller1=null,this.controllerGrip0=null,this.controllerGrip1=null,this.controllerModelFactory=new Bt,this.rayLine0=null,this.rayLine1=null,this.leftThumbstickAxes=new r.Vector2,this.rightThumbstickAxes=new r.Vector2,this.thumbstickAxes=new r.Vector2,this.isSelectPressed=!1,this.isSqueezePressed=!1,this.squeezeHoldTime=0,this.buttonAPressed=!1,this.buttonBPressed=!1,this.rightStickPressed=!1,this.buttonACooldown=0,this.buttonBCooldown=0,this.rightStickCooldown=0,this.buttonCooldownDuration=.3,this.isPaintMode=!1,this.colorPalette=null,this.paletteColors=[{name:"Red",hex:16711680},{name:"Orange",hex:16746496},{name:"Yellow",hex:16776960},{name:"Green",hex:65280},{name:"Cyan",hex:65535},{name:"Blue",hex:255},{name:"Purple",hex:8913151},{name:"Magenta",hex:16711935},{name:"White",hex:16777215},{name:"Gray",hex:8421504},{name:"Black",hex:0},{name:"Brown",hex:9127187}],this.currentColorIndex=4,this.raycaster=new r.Raycaster,this.groundMeshes=[],this.isEnabled=!1}init(){this.controller0=this.renderer.xr.getController(0),this.controller0.addEventListener("selectstart",this.onSelectStart.bind(this,0)),this.controller0.addEventListener("selectend",this.onSelectEnd.bind(this,0)),this.controller0.addEventListener("squeezestart",this.onSqueezeStart.bind(this,0)),this.controller0.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,0)),this.scene.add(this.controller0),this.controller1=this.renderer.xr.getController(1),this.controller1.addEventListener("selectstart",this.onSelectStart.bind(this,1)),this.controller1.addEventListener("selectend",this.onSelectEnd.bind(this,1)),this.controller1.addEventListener("squeezestart",this.onSqueezeStart.bind(this,1)),this.controller1.addEventListener("squeezeend",this.onSqueezeEnd.bind(this,1)),this.scene.add(this.controller1),this.controllerGrip0=this.renderer.xr.getControllerGrip(0),this.controllerGrip0.add(this.controllerModelFactory.createControllerModel(this.controllerGrip0)),this.scene.add(this.controllerGrip0),this.controllerGrip1=this.renderer.xr.getControllerGrip(1),this.controllerGrip1.add(this.controllerModelFactory.createControllerModel(this.controllerGrip1)),this.scene.add(this.controllerGrip1),this.rayLine0=this.createRayLine(),this.controller0.add(this.rayLine0),this.rayLine1=this.createRayLine(),this.controller1.add(this.rayLine1),console.log("XR Controllers initialized")}createRayLine(){const e=new r.BufferGeometry,t=new Float32Array([0,0,0,0,0,-5]);e.setAttribute("position",new r.BufferAttribute(t,3));const i=new r.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.6}),s=new r.Line(e,i);return s.visible=!1,s}enable(){this.isEnabled=!0,this.controller0||this.init()}disable(){this.isEnabled=!1,this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1)}onSelectStart(e,t){console.log(`Controller ${e} select start - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!0;const i=e===0?this.rayLine0:this.rayLine1;i&&(i.visible=!0,i.material.color.setHex(65280)),this.isPaintMode?(console.log("Paint mode active - setting isDragging to true"),this.isDragging=!0):console.log("NOT in paint mode - will teleport on release")}onSelectEnd(e,t){console.log(`Controller ${e} select end - isPaintMode: ${this.isPaintMode}`),this.isSelectPressed=!1;const i=e===0?this.rayLine0:this.rayLine1;if(i&&(i.visible=!1),this.isPaintMode){if(console.log("Paint mode - checking color selection"),this.checkColorSelection(e)){console.log("Color selected from palette");return}console.log("Stopping paint (isDragging = false)"),this.isDragging=!1}else console.log("NOT in paint mode - executing teleport"),this.xrManager.executeTeleport()}onSqueezeStart(e,t){console.log(`Controller ${e} squeeze start`),this.isSqueezePressed=!0,this.squeezeHoldTime=0,this.xrManager.onJumpPressed()}onSqueezeEnd(e,t){console.log(`Controller ${e} squeeze end`),this.isSqueezePressed=!1,this.xrManager.onJetpackPressed(!1)}getThumbstickAxes(){const e=this.renderer.xr.getSession();if(!e)return null;this.leftThumbstickAxes.set(0,0),this.rightThumbstickAxes.set(0,0);for(const t of e.inputSources)if(t.gamepad&&t.handedness){const i=t.gamepad,s=t.handedness==="left";if(i.axes.length>=4){const o=i.axes[2],n=i.axes[3];s?this.leftThumbstickAxes.set(o,n):this.rightThumbstickAxes.set(o,n)}i.buttons.length>4&&i.buttons[4].pressed?!this.buttonAPressed&&this.buttonACooldown<=0&&(this.buttonAPressed=!0,this.buttonACooldown=this.buttonCooldownDuration,this.xrManager.onRunToggle()):this.buttonAPressed=!1,i.buttons.length>5&&i.buttons[5].pressed?!this.buttonBPressed&&this.buttonBCooldown<=0?(this.buttonBPressed=!0,this.buttonBCooldown=this.buttonCooldownDuration,console.log(`B/Y button pressed - toggling paint mode (cooldown: ${this.buttonCooldownDuration}s)`),this.togglePaintMode()):this.buttonBCooldown>0:this.buttonBPressed=!1,!s&&i.buttons.length>3&&i.buttons[3].pressed?!this.rightStickPressed&&this.rightStickCooldown<=0&&(this.rightStickPressed=!0,this.rightStickCooldown=this.buttonCooldownDuration,console.log("Right stick pressed - resetting camera pitch to flat"),this.xrManager.onResetPitch()):s||(this.rightStickPressed=!1)}return this.leftThumbstickAxes.lengthSq()>.01?(this.thumbstickAxes.copy(this.leftThumbstickAxes),this.thumbstickAxes):(this.thumbstickAxes.set(0,0),this.thumbstickAxes)}getRightThumbstickAxes(){return this.rightThumbstickAxes}togglePaintMode(){this.isPaintMode=!this.isPaintMode,this.isPaintMode?(console.log("VR Paint mode: ON"),this.showColorPalette(),this.rayLine0&&(this.rayLine0.visible=!1),this.rayLine1&&(this.rayLine1.visible=!1),this.xrManager.updateTeleportTarget(null)):(console.log("VR Paint mode: OFF"),this.hideColorPalette())}createColorPalette(){this.colorPalette=new r.Group;const e=new r.SphereGeometry(.03,16,16),t=.08;this.paletteColors.forEach((i,s)=>{const o=new r.MeshBasicMaterial({color:i.hex}),n=new r.Mesh(e,o),l=Math.floor(s/3),c=s%3;n.position.set(c*t-t,-l*t,0),n.userData={isColorPicker:!0,colorIndex:s,colorHex:i.hex,colorName:i.name},this.colorPalette.add(n)}),this.colorPalette.position.set(.15,0,-.3),this.colorPalette.visible=!1,this.controller1&&this.controller1.add(this.colorPalette),console.log("VR color palette created")}showColorPalette(){this.colorPalette||this.createColorPalette(),this.colorPalette&&(this.colorPalette.visible=!0)}hideColorPalette(){this.colorPalette&&(this.colorPalette.visible=!1)}checkColorSelection(e){if(!this.isPaintMode||!this.colorPalette||!this.colorPalette.visible)return!1;const t=e===0?this.controller0:this.controller1;if(!t)return!1;const i=new r.Matrix4;i.identity().extractRotation(t.matrixWorld),this.raycaster.ray.origin.setFromMatrixPosition(t.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(i);const s=this.raycaster.intersectObjects(this.colorPalette.children,!1);if(s.length>0){const o=s[0].object;if(o.userData.isColorPicker)return this.currentColorIndex=o.userData.colorIndex,console.log(`Selected color: ${o.userData.colorName}`),o.scale.set(1.3,1.3,1.3),setTimeout(()=>{o.scale.set(1,1,1)},200),!0}return!1}getRayForPainting(e){if(!this.isPaintMode)return null;const t=e===0?this.controller0:this.controller1;if(!t)return null;const i=new r.Matrix4;i.identity().extractRotation(t.matrixWorld);const s=new r.Vector3;s.setFromMatrixPosition(t.matrixWorld);const o=new r.Vector3(0,0,-1);return o.applyMatrix4(i).normalize(),{origin:s,direction:o}}raycastForTeleport(e){if(!e||this.groundMeshes.length===0)return null;const t=new r.Matrix4;t.identity().extractRotation(e.matrixWorld);const i=this.raycaster;i.ray.origin.setFromMatrixPosition(e.matrixWorld),i.ray.direction.set(0,0,-1).applyMatrix4(t);const s=i.intersectObjects(this.groundMeshes,!1);return s.length>0?s[0].point:null}update(e){if(this.isEnabled){if(this.isSqueezePressed?(this.squeezeHoldTime+=e,this.squeezeHoldTime>.4&&this.xrManager.onJetpackPressed(!0)):this.squeezeHoldTime=0,this.buttonACooldown>0&&(this.buttonACooldown-=e),this.buttonBCooldown>0&&(this.buttonBCooldown-=e),this.rightStickCooldown>0&&(this.rightStickCooldown-=e),this.isSelectPressed&&!this.isPaintMode){const t=this.raycastForTeleport(this.controller0);this.xrManager.updateTeleportTarget(t),this.rayLine0&&this.rayLine0.material.color.setHex(t?65280:16711680)}else this.xrManager.updateTeleportTarget(null);this.getThumbstickAxes()}}setGroundMeshes(e){this.groundMeshes=e}dispose(){this.rayLine0&&(this.rayLine0.geometry.dispose(),this.rayLine0.material.dispose()),this.rayLine1&&(this.rayLine1.geometry.dispose(),this.rayLine1.material.dispose()),this.controller0&&(this.controller0.removeEventListener("selectstart",this.onSelectStart),this.controller0.removeEventListener("selectend",this.onSelectEnd),this.controller0.removeEventListener("squeezestart",this.onSqueezeStart),this.controller0.removeEventListener("squeezeend",this.onSqueezeEnd)),this.controller1&&(this.controller1.removeEventListener("selectstart",this.onSelectStart),this.controller1.removeEventListener("selectend",this.onSelectEnd),this.controller1.removeEventListener("squeezestart",this.onSqueezeStart),this.controller1.removeEventListener("squeezeend",this.onSqueezeEnd))}}class ri{constructor(e,t,i){this.renderer=e,this.scene=t,this.characterModel=i,this.hand0=null,this.hand1=null,this.handModelFactory=new $t,this.rightHandMesh=null,this.leftHandMesh=null,this.rightHandFallback=null,this.leftHandFallback=null,this.isEnabled=!1,this.handInputState={left:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null},right:{isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null}}}init(){this.hand0=this.renderer.xr.getHand(0),this.hand1=this.renderer.xr.getHand(1);try{this.rightHandMesh=this.handModelFactory.createHandModel(this.hand0,"mesh"),this.hand0.add(this.rightHandMesh),this.scene.add(this.hand0)}catch{console.warn("Hand tracking model 0 not available, using fallback")}try{this.leftHandMesh=this.handModelFactory.createHandModel(this.hand1,"mesh"),this.hand1.add(this.leftHandMesh),this.scene.add(this.hand1)}catch{console.warn("Hand tracking model 1 not available, using fallback")}this.createFallbackHands(),console.log("XR Hands initialized")}createFallbackHands(){const e=new r.Group,t=new r.SphereGeometry(.04,16,16),i=new r.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),s=new r.Mesh(t,i);e.add(s);const o=new r.CylinderGeometry(.01,.01,.08,8),n=new r.MeshStandardMaterial({color:16767916,roughness:.8,metalness:.1}),l=new r.Mesh(o,n);l.position.set(0,0,-.06),l.rotation.x=Math.PI/2,e.add(l);const c=new r.SphereGeometry(.012,8,8),d=new r.Mesh(c,n);d.position.set(0,0,-.1),e.add(d),this.rightHandFallback=e,this.rightHandFallback.visible=!1,this.scene.add(this.rightHandFallback);const u=e.clone();this.leftHandFallback=u,this.leftHandFallback.visible=!1,this.scene.add(this.leftHandFallback)}enable(){this.isEnabled=!0,this.hand0||this.init(),this.updateFallbackVisibility()}disable(){this.isEnabled=!1,this.rightHandFallback&&(this.rightHandFallback.visible=!1),this.leftHandFallback&&(this.leftHandFallback.visible=!1)}updateFallbackVisibility(){if(!this.isEnabled)return;const e=this.renderer.xr.getSession();if(!e)return;let t=!1;for(const i of e.inputSources)if(i.hand){t=!0;break}this.rightHandFallback&&(this.rightHandFallback.visible=this.isEnabled&&!t),this.leftHandFallback&&(this.leftHandFallback.visible=this.isEnabled&&!t)}update(){if(this.isEnabled){if(this.updateFallbackVisibility(),this.rightHandFallback&&this.rightHandFallback.visible){const e=this.renderer.xr.getController(0);e&&(this.rightHandFallback.position.copy(e.position),this.rightHandFallback.quaternion.copy(e.quaternion))}if(this.leftHandFallback&&this.leftHandFallback.visible){const e=this.renderer.xr.getController(1);e&&(this.leftHandFallback.position.copy(e.position),this.leftHandFallback.quaternion.copy(e.quaternion))}}}animateGrip(e,t){const i=e===0?this.rightHandFallback:this.leftHandFallback;if(!i||!i.visible)return;const s=i.children[1];s&&(s.scale.y=1-t*.3)}getJointPosition(e,t){if(!e)return null;const i=e.get(t);if(!i)return null;const s=this.renderer.xr.getFrame(),o=this.renderer.xr.getReferenceSpace();if(!s||!o)return null;const n=s.getJointPose(i,o);return n?new r.Vector3().setFromMatrixPosition(new r.Matrix4().fromArray(n.transform.matrix)):null}getPinchDistance(e){const t=this.getJointPosition(e,"thumb-tip"),i=this.getJointPosition(e,"index-finger-tip");return!t||!i?null:t.distanceTo(i)}getPointingDirection(e){const t=this.getJointPosition(e,"wrist"),i=this.getJointPosition(e,"index-finger-tip");return!t||!i?null:new r.Vector3().subVectors(i,t).normalize()}getPalmNormal(e){if(!e)return null;const t=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(!t||!i)return null;const s=e.get("wrist");if(!s)return null;const o=t.getJointPose(s,i);if(!o)return null;const n=new r.Matrix4().fromArray(o.transform.matrix),l=new r.Vector3(0,1,0);return l.applyMatrix4(n),l.sub(new r.Vector3().setFromMatrixPosition(n)),l.normalize()}resetGestureState(e){e!=="left"&&e!=="right"||(this.handInputState[e]={isPinching:!1,pinchStartTime:0,lastTapTime:0,tapCount:0,dragStartPosition:null})}resetAllGestureStates(){this.resetGestureState("left"),this.resetGestureState("right")}dispose(){this.resetAllGestureStates(),this.rightHandFallback&&(this.scene.remove(this.rightHandFallback),this.rightHandFallback.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})),this.leftHandFallback&&(this.scene.remove(this.leftHandFallback),this.leftHandFallback.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})),this.hand0&&this.scene.remove(this.hand0),this.hand1&&this.scene.remove(this.hand1)}}const li=.015,ci=300,hi=500,di=.003,Ue=.3,ui=.6,mi=600,S={IDLE:"idle",PAINTING:"painting",MOVING:"moving",JETPACK:"jetpack",MOVING_JETPACK:"moving_jetpack",TELEPORTING:"teleporting"};class fi{constructor(e,t,i=null){this.xrHands=e,this.xrManager=t,this.wristPalette=i,this.mode=S.IDLE,this.activePainterHand=null,this.paintModeEnabled=!1,this.isTeleporting=!1,this.callbacks={onPaintStart:null,onPaintDrag:null,onPaintEnd:null,onMovementStart:null,onMovementUpdate:null,onMovementEnd:null,onJetpackStart:null,onJetpackEnd:null,onColorSelect:null,onTeleportStart:null,onTeleportUpdate:null,onTeleportEnd:null,onTogglePaintMode:null},this.selectedColorIndex=6,console.log("GestureDetector initialized with proven LDIPlayer patterns")}setWristPalette(e){this.wristPalette=e}update(e,t){if(e){for(const i of e.inputSources)if(i.hand){const s=i.hand,o=i.handedness;if(o!=="left"&&o!=="right")continue;this.updateHandGestures(s,o,t)}this.updateMode(t)}}updateHandGestures(e,t,i){const s=this.xrHands.handInputState[t],o=this.xrHands.getPinchDistance(e);if(o===null)return;const n=performance.now();if(o<li)if(s.isPinching)this.onPinchSustain(e,t,s,i);else{s.isPinching=!0,s.pinchStartTime=n;const l=this.xrHands.getJointPosition(e,"index-finger-tip");l&&(s.dragStartPosition={x:l.x,y:l.y,z:l.z}),this.onPinchStart(e,t,i)}else if(s.isPinching){const l=n-s.pinchStartTime;this.onPinchRelease(e,t,s,l,n),s.isPinching=!1,s.dragStartPosition=null}}onPinchStart(e,t,i){console.log(`${t} pinch start`),this.mode,S.IDLE}onPinchSustain(e,t,i,s){const o=this.xrHands.getJointPosition(e,"index-finger-tip");if(!o||!i.dragStartPosition)return;const n=o.x-i.dragStartPosition.x,l=o.y-i.dragStartPosition.y,c=o.z-i.dragStartPosition.z,d=Math.sqrt(n*n+l*l+c*c);if(t==="left"&&!this.paintModeEnabled){const u=this.xrHands.getJointPosition(e,"wrist");if(u&&o){const f=u.clone(),p=new r.Vector3().subVectors(o,u).normalize();this.isTeleporting?this.callbacks.onTeleportUpdate&&this.callbacks.onTeleportUpdate(f,p):(this.isTeleporting=!0,this.mode=S.TELEPORTING,console.log("LEFT hand teleportation started"),this.callbacks.onTeleportStart&&this.callbacks.onTeleportStart(f,p))}return}d>di&&(this.mode===S.IDLE&&this.paintModeEnabled&&this.activePainterHand===null&&this.startPainting(e,t),this.mode===S.PAINTING&&this.activePainterHand===t&&this.updatePainting(e,t))}onPinchRelease(e,t,i,s,o){if(console.log(`${t} pinch release (duration: ${s}ms)`),t==="left"&&this.isTeleporting){const n=this.xrHands.getJointPosition(e,"wrist"),l=this.xrHands.getJointPosition(e,"index-finger-tip");if(n&&l){const c=n.clone(),d=new r.Vector3().subVectors(l,n).normalize();console.log("LEFT hand teleportation executed"),this.callbacks.onTeleportEnd&&this.callbacks.onTeleportEnd(c,d)}this.isTeleporting=!1,this.mode=S.IDLE;return}s<ci?(o-i.lastTapTime<hi?(i.tapCount++,console.log(`${t} double-tap detected (count: ${i.tapCount})`),this.onDoubleTap(t)):(i.tapCount=1,console.log(`${t} tap 1/2`),this.onSingleTap(e,t)),i.lastTapTime=o):(console.log(`${t} hold/drag end (duration: ${s}ms)`),this.mode===S.PAINTING&&this.activePainterHand===t&&this.endPainting(t),this.mode===S.JETPACK&&t==="right"&&this.endJetpack(t))}onSingleTap(e,t){const i=this.xrHands.getJointPosition(e,"wrist"),s=this.xrHands.getJointPosition(e,"index-finger-tip");if(!i||!s)return;const o=i.clone(),n=new r.Vector3().subVectors(s,i).normalize();if(this.wristPalette&&this.wristPalette.checkToggleButtonHover(o,n)){const l=this.wristPalette.togglePaintMode();this.paintModeEnabled=l,this.callbacks.onTogglePaintMode&&this.callbacks.onTogglePaintMode(l),console.log(`Paint mode toggled via wrist button: ${l?"ON":"OFF"}`);return}if(this.paintModeEnabled&&this.callbacks.onColorSelect){this.callbacks.onColorSelect(o,n);return}}onDoubleTap(e){console.log(`${e} double-tap action`)}startPainting(e,t){this.mode=S.PAINTING,this.activePainterHand=t;const i=this.xrHands.getJointPosition(e,"wrist"),s=this.xrHands.getJointPosition(e,"index-finger-tip");if(i&&s){const o=i.clone(),n=new r.Vector3().subVectors(s,i).normalize();console.log(`Painting started with ${t} hand`),this.callbacks.onPaintStart&&this.callbacks.onPaintStart(t,o,n)}}updatePainting(e,t){const i=this.xrHands.getJointPosition(e,"wrist"),s=this.xrHands.getJointPosition(e,"index-finger-tip");if(i&&s){const o=i.clone(),n=new r.Vector3().subVectors(s,i).normalize();this.callbacks.onPaintDrag&&this.callbacks.onPaintDrag(t,o,n)}}endPainting(e){console.log(`Painting ended with ${e} hand`),this.mode=S.IDLE,this.activePainterHand=null,this.callbacks.onPaintEnd&&this.callbacks.onPaintEnd(e)}startJetpack(e){this.mode===S.MOVING?this.mode=S.MOVING_JETPACK:this.mode=S.JETPACK,console.log(`Jetpack started with ${e} hand`),this.callbacks.onJetpackStart&&this.callbacks.onJetpackStart(e)}endJetpack(e){console.log(`Jetpack ended with ${e} hand`),this.mode===S.MOVING_JETPACK?this.mode=S.MOVING:this.mode=S.IDLE,this.callbacks.onJetpackEnd&&this.callbacks.onJetpackEnd(e)}updateMode(e){this.mode!==S.PAINTING&&this.checkMovementGesture(e),this.mode!==S.PAINTING&&this.checkJetpackGesture()}checkMovementGesture(e){const t=this.xrManager.renderer.xr.getSession();if(!t){console.log("[Movement] No XR session");return}let i=null;for(const l of t.inputSources)if(l.hand&&l.handedness==="left"){i=l.hand;break}if(!i){console.log("[Movement] No left hand found");return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getJointPosition(i,"index-finger-tip");if(!s||!o||!e){console.log("[Movement] Missing joint positions - wrist:",!!s,"indexTip:",!!o,"camera:",!!e);return}const n=s.distanceTo(e);if(console.log(`[Movement] Extension distance: ${n.toFixed(3)}m (min: ${Ue}m)`),n>=Ue){const l=new r.Vector3().subVectors(o,s).normalize();l.y=0,l.normalize();const c=Math.min((n-Ue)/(ui-Ue),1);if(console.log(`[Movement] Hand extended! Speed: ${c.toFixed(2)}, Mode: ${this.mode}`),this.mode===S.IDLE||this.mode===S.JETPACK){const d=this.mode===S.JETPACK?S.MOVING_JETPACK:S.MOVING;this.mode=d,console.log(`[Movement] Started - New mode: ${d}`),this.callbacks.onMovementStart&&this.callbacks.onMovementStart(l,c)}else(this.mode===S.MOVING||this.mode===S.MOVING_JETPACK)&&this.callbacks.onMovementUpdate&&this.callbacks.onMovementUpdate(l,c)}else console.log("[Movement] Hand not extended enough"),this.mode===S.MOVING?(this.mode=S.IDLE,console.log("[Movement] Ended - Mode: IDLE"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd()):this.mode===S.MOVING_JETPACK&&(this.mode=S.JETPACK,console.log("[Movement] Ended - Mode: JETPACK"),this.callbacks.onMovementEnd&&this.callbacks.onMovementEnd())}checkJetpackGesture(){const e=this.xrHands.handInputState.right,t=performance.now();if(!(this.mode===S.TELEPORTING||this.mode===S.PAINTING)&&e.isPinching){const i=t-e.pinchStartTime;i>=mi&&this.mode!==S.JETPACK&&this.mode!==S.MOVING_JETPACK&&(console.log(`RIGHT hand jetpack activated (hold duration: ${i}ms)`),this.startJetpack("right"))}}isLeftPalmFacingUser(e){const t=this.xrManager.renderer.xr.getSession();if(!t)return!1;let i=null;for(const c of t.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i)return!1;const s=this.xrHands.getPalmNormal(i),o=this.xrHands.getJointPosition(i,"wrist");if(!s||!o||!e)return!1;const n=new r.Vector3().subVectors(e,o).normalize();return s.dot(n)>.5}reset(){this.mode=S.IDLE,this.activePainterHand=null,this.xrHands.resetAllGestureStates(),console.log("GestureDetector reset")}on(e,t){this.callbacks.hasOwnProperty("on"+e.charAt(0).toUpperCase()+e.slice(1))&&(this.callbacks["on"+e.charAt(0).toUpperCase()+e.slice(1)]=t)}}class pi{constructor(e,t){this.scene=e,this.xrHands=t,this.colors=[{hex:16711680,name:"Red"},{hex:16746496,name:"Orange"},{hex:16776960,name:"Yellow"},{hex:65280,name:"Green"},{hex:65535,name:"Cyan"},{hex:255,name:"Blue"},{hex:8913151,name:"Purple"},{hex:16711935,name:"Magenta"},{hex:16777215,name:"White"},{hex:8947848,name:"Gray"},{hex:0,name:"Black"},{hex:8930304,name:"Brown"}],this.spheres=[],this.selectedIndex=6,this.hoveredIndex=-1,this.toggleButton=null,this.toggleButtonHovered=!1,this.paintModeEnabled=!1,this.paletteGroup=null,this.isVisible=!1,this.sphereRadius=.015,this.arcRadius=.12,this.arcSpan=Math.PI/2,this.rows=3,this.cols=4,this.createPalette()}createPalette(){this.paletteGroup=new r.Group,this.paletteGroup.visible=!1;let e=0;for(let l=0;l<this.rows;l++)for(let c=0;c<this.cols&&!(e>=this.colors.length);c++){const d=this.colors[e],u=new r.SphereGeometry(this.sphereRadius,16,16),f=new r.MeshStandardMaterial({color:d.hex,roughness:.3,metalness:.1,emissive:d.hex,emissiveIntensity:.2}),p=new r.Mesh(u,f),b=(c/(this.cols-1)-.5)*this.arcSpan,k=(l-(this.rows-1)/2)*(this.sphereRadius*3);p.position.x=Math.sin(b)*this.arcRadius,p.position.y=k,p.position.z=-Math.cos(b)*this.arcRadius,p.userData.colorIndex=e,p.userData.colorHex=d.hex,p.userData.colorName=d.name,this.spheres.push(p),this.paletteGroup.add(p),e++}const t=new r.RingGeometry(this.sphereRadius*1.2,this.sphereRadius*1.5,32),i=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,opacity:.8});this.selectionRing=new r.Mesh(t,i),this.selectionRing.visible=!1,this.paletteGroup.add(this.selectionRing);const s=this.sphereRadius*2.5,o=new r.SphereGeometry(s,16,16),n=new r.MeshStandardMaterial({color:16711680,roughness:.3,metalness:.1,emissive:16711680,emissiveIntensity:.3});this.toggleButton=new r.Mesh(o,n),this.toggleButton.position.set(0,this.sphereRadius*6,0),this.toggleButton.userData.isToggleButton=!0,this.paletteGroup.add(this.toggleButton),this.scene.add(this.paletteGroup),console.log("WristPalette created with",this.colors.length,"colors and toggle button")}update(e){const t=this.xrHands.renderer.xr.getSession();if(!t){this.hide();return}let i=null;for(const c of t.inputSources)if(c.hand&&c.handedness==="left"){i=c.hand;break}if(!i){this.hide();return}const s=this.xrHands.getJointPosition(i,"wrist"),o=this.xrHands.getPalmNormal(i);if(!s||!o||!e){this.hide();return}const n=new r.Vector3().subVectors(e,s).normalize();if(o.dot(n)>.5){this.show(),this.paletteGroup.position.copy(s),this.paletteGroup.lookAt(e);const c=new r.Vector3().subVectors(e,s).normalize();this.paletteGroup.position.add(c.multiplyScalar(.05))}else this.hide()}checkHover(e,t){if(!this.isVisible)return null;const s=new r.Raycaster(e,t).intersectObjects(this.spheres);if(s.length>0){const o=s[0].object.userData.colorIndex;return this.setHovered(o),o}else return this.setHovered(-1),null}checkToggleButtonHover(e,t){if(!this.isVisible||!this.toggleButton)return!1;const o=new r.Raycaster(e,t).intersectObject(this.toggleButton).length>0;return o!==this.toggleButtonHovered&&(this.toggleButtonHovered=o,this.toggleButton&&(o?(this.toggleButton.scale.set(1.2,1.2,1.2),this.toggleButton.material.emissiveIntensity=.6):(this.toggleButton.scale.set(1,1,1),this.toggleButton.material.emissiveIntensity=.3))),o}togglePaintMode(){if(this.paintModeEnabled=!this.paintModeEnabled,this.toggleButton){const e=this.paintModeEnabled?65280:16711680;this.toggleButton.material.color.setHex(e),this.toggleButton.material.emissive.setHex(e),this.toggleButton.scale.set(1.4,1.4,1.4),setTimeout(()=>{this.toggleButton.scale.set(1,1,1)},100)}return console.log(`Paint mode toggled: ${this.paintModeEnabled?"ON":"OFF"}`),this.paintModeEnabled}getPaintModeEnabled(){return this.paintModeEnabled}setHovered(e){if(this.hoveredIndex!==e){if(this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const t=this.spheres[this.hoveredIndex];t.scale.set(1,1,1),t.material.emissiveIntensity=.2}if(this.hoveredIndex=e,this.hoveredIndex>=0&&this.hoveredIndex<this.spheres.length){const t=this.spheres[this.hoveredIndex];t.scale.set(1.3,1.3,1.3),t.material.emissiveIntensity=.6}}}selectColor(e){if(e<0||e>=this.colors.length)return;this.selectedIndex=e,console.log("Selected color:",this.colors[e].name);const t=this.spheres[e];this.selectionRing.position.copy(t.position),this.selectionRing.lookAt(this.paletteGroup.position),this.selectionRing.visible=this.isVisible;const i=t.scale.clone();t.scale.set(1.5,1.5,1.5),setTimeout(()=>{t.scale.copy(i)},100)}getSelectedColor(){return this.colors[this.selectedIndex]}show(){if(!this.isVisible&&(this.paletteGroup.visible=!0,this.selectionRing.visible=!0,this.isVisible=!0,this.selectedIndex>=0&&this.selectedIndex<this.spheres.length)){const e=this.spheres[this.selectedIndex];this.selectionRing.position.copy(e.position),this.selectionRing.lookAt(this.paletteGroup.position)}}hide(){this.isVisible&&(this.paletteGroup.visible=!1,this.selectionRing.visible=!1,this.isVisible=!1,this.setHovered(-1))}dispose(){this.spheres.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this.selectionRing&&(this.selectionRing.geometry.dispose(),this.selectionRing.material.dispose()),this.toggleButton&&(this.toggleButton.geometry.dispose(),this.toggleButton.material.dispose()),this.paletteGroup&&this.scene.remove(this.paletteGroup)}}class gi{constructor(e){this.scene=e,this.paintRays={left:null,right:null},this.movementArrow=null,this.jetpackGlows={left:null,right:null},this.createVisuals()}createVisuals(){this.createPaintRays(),this.createMovementArrow(),this.createJetpackGlows()}createPaintRays(){const e=()=>{const t=new r.BufferGeometry,i=new Float32Array([0,0,0,0,0,-5]);t.setAttribute("position",new r.BufferAttribute(i,3));const s=new r.LineBasicMaterial({color:65280,transparent:!0,opacity:.6,linewidth:2}),o=new r.Line(t,s);return o.visible=!1,this.scene.add(o),o};this.paintRays.left=e(),this.paintRays.right=e()}createMovementArrow(){const e=new r.Group,t=new r.CylinderGeometry(.02,.02,.4,8),i=new r.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),s=new r.Mesh(t,i);s.rotation.z=-Math.PI/2,e.add(s);const o=new r.ConeGeometry(.05,.1,8),n=new r.MeshBasicMaterial({color:43775,transparent:!0,opacity:.7}),l=new r.Mesh(o,n);l.rotation.z=-Math.PI/2,l.position.x=.25,e.add(l),e.visible=!1,this.scene.add(e),this.movementArrow=e}createJetpackGlows(){const e=()=>{const t=new r.SphereGeometry(.06,16,16),i=new r.MeshBasicMaterial({color:65280,transparent:!0,opacity:.5}),s=new r.Mesh(t,i);return s.visible=!1,this.scene.add(s),s};this.jetpackGlows.left=e(),this.jetpackGlows.right=e()}updatePaintRay(e,t,i,s=!0){const o=this.paintRays[e];if(o)if(s&&t&&i){o.visible=!0,o.position.copy(t);const n=new r.Vector3().copy(t).add(i.clone().multiplyScalar(5));o.lookAt(n);const l=o.geometry.attributes.position.array;l[3]=0,l[4]=0,l[5]=-5,o.geometry.attributes.position.needsUpdate=!0}else o.visible=!1}updateMovementArrow(e,t,i,s=!0){if(this.movementArrow)if(s&&e&&t&&i>0){this.movementArrow.visible=!0,this.movementArrow.position.copy(e),this.movementArrow.position.y=e.y-1.3;const o=new r.Vector3().copy(e).add(t);o.y=this.movementArrow.position.y,this.movementArrow.lookAt(o);const n=.5+i*.5;this.movementArrow.scale.set(n,n,n),this.movementArrow.children.forEach(l=>{l.material&&(l.material.opacity=.4+i*.3)})}else this.movementArrow.visible=!1}updateJetpackGlow(e,t,i=!0){const s=this.jetpackGlows[e];if(s)if(i&&t){s.visible=!0,s.position.copy(t);const o=performance.now()*.005,n=.8+Math.sin(o)*.2;s.scale.set(n,n,n),s.material.opacity=.3+Math.sin(o*2)*.2}else s.visible=!1}hidePaintRays(){this.paintRays.left.visible=!1,this.paintRays.right.visible=!1}hideMovementArrow(){this.movementArrow&&(this.movementArrow.visible=!1)}hideJetpackGlows(){this.jetpackGlows.left.visible=!1,this.jetpackGlows.right.visible=!1}hideAll(){this.hidePaintRays(),this.hideMovementArrow(),this.hideJetpackGlows()}dispose(){Object.values(this.paintRays).forEach(e=>{e&&(e.geometry.dispose(),e.material.dispose(),this.scene.remove(e))}),this.movementArrow&&(this.movementArrow.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.scene.remove(this.movementArrow)),Object.values(this.jetpackGlows).forEach(e=>{e&&(e.geometry.dispose(),e.material.dispose(),this.scene.remove(e))})}}class yi{constructor(e,t,i=20,s=0){this.spark=e,this.renderer=t,this.targetFPS=i,this.initialTargetFPS=i,this.frameCount=0,this.lastTime=performance.now(),this.fps=60,this.fpsHistory=[],this.qualityPresets=[{name:"Ultra",maxStdDev:Math.sqrt(8),minPixelRadius:0,maxPixelRadius:512,minAlpha:.5/255,clipXY:2,falloff:1,stochastic:!1,sortDistance:.01,sortCoorient:.99,pixelRatio:2},{name:"High",maxStdDev:Math.sqrt(7),minPixelRadius:.3,maxPixelRadius:384,minAlpha:.7/255,clipXY:1.8,falloff:.95,stochastic:!1,sortDistance:.02,sortCoorient:.99,pixelRatio:1.5},{name:"Medium",maxStdDev:Math.sqrt(6),minPixelRadius:.5,maxPixelRadius:256,minAlpha:1/255,clipXY:1.6,falloff:.85,stochastic:!1,sortDistance:.05,sortCoorient:.97,pixelRatio:1.5},{name:"Low",maxStdDev:Math.sqrt(5),minPixelRadius:.8,maxPixelRadius:192,minAlpha:1.8/255,clipXY:1.4,falloff:.7,stochastic:!1,sortDistance:.08,sortCoorient:.96,pixelRatio:1},{name:"Potato",maxStdDev:Math.sqrt(4.5),minPixelRadius:1.2,maxPixelRadius:128,minAlpha:2.5/255,clipXY:1.2,falloff:.6,stochastic:!1,sortDistance:.15,sortCoorient:.93,pixelRatio:1}],this.currentQualityIndex=Math.min(s,this.qualityPresets.length-1),this.manualMode=!1,this.originalPixelRatio=this.renderer.getPixelRatio(),this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Initialized - Starting at ${this.getCurrentQualityName()} quality (target: ${this.targetFPS} FPS)`)}update(){this.frameCount++;const e=performance.now();if(e>=this.lastTime+1e3){this.fps=Math.round(this.frameCount*1e3/(e-this.lastTime)),this.frameCount=0,this.lastTime=e,this.fpsHistory.push(this.fps),this.fpsHistory.length>3&&this.fpsHistory.shift();const t=this.fpsHistory.reduce((i,s)=>i+s,0)/this.fpsHistory.length;this.manualMode||this.adjustQuality(t)}}adjustQuality(e){this.currentQualityIndex,e<this.targetFPS-5&&this.currentQualityIndex<this.qualityPresets.length-1&&(this.currentQualityIndex++,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] â†“ Reduced to: ${this.getCurrentQualityName()} (FPS: ${e.toFixed(1)} / Target: ${this.targetFPS})`)),e>this.targetFPS+5*2&&this.currentQualityIndex>0&&(this.currentQualityIndex--,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] â†‘ Increased to: ${this.getCurrentQualityName()} (FPS: ${e.toFixed(1)} / Target: ${this.targetFPS})`))}applyQualityPreset(e){const t=this.qualityPresets[e];this.spark.maxStdDev=t.maxStdDev,this.spark.minPixelRadius=t.minPixelRadius,this.spark.maxPixelRadius=t.maxPixelRadius,this.spark.minAlpha=t.minAlpha,this.spark.clipXY=t.clipXY,this.spark.falloff=t.falloff,this.spark.defaultView.stochastic=t.stochastic,this.spark.defaultView.sortDistance=t.sortDistance,this.spark.defaultView.sortCoorient=t.sortCoorient;const i=Math.min(this.originalPixelRatio,t.pixelRatio);this.renderer.setPixelRatio(i),console.log(`[AdaptiveQuality] Applied preset: ${t.name}`,{maxStdDev:t.maxStdDev.toFixed(2),minPixelRadius:t.minPixelRadius,stochastic:t.stochastic,pixelRatio:i.toFixed(1)})}increaseQuality(){this.currentQualityIndex>0&&(this.manualMode=!0,this.currentQualityIndex--,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Manual increase to: ${this.getCurrentQualityName()} (Adaptive DISABLED)`))}decreaseQuality(){this.currentQualityIndex<this.qualityPresets.length-1&&(this.manualMode=!0,this.currentQualityIndex++,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Manual decrease to: ${this.getCurrentQualityName()} (Adaptive DISABLED)`))}setQualityByName(e){const t=this.qualityPresets.findIndex(i=>i.name.toLowerCase()===e.toLowerCase());t!==-1&&(this.currentQualityIndex=t,this.applyQualityPreset(this.currentQualityIndex),console.log(`[AdaptiveQuality] Set to: ${this.getCurrentQualityName()}`))}resumeAdaptive(){this.manualMode=!1,console.log("[AdaptiveQuality] Resumed adaptive quality adjustment"),console.log(`[AdaptiveQuality] Current quality: ${this.getCurrentQualityName()} (will adjust based on FPS)`)}setTargetFPS(e){if(e!==this.targetFPS){const t=this.targetFPS;this.targetFPS=e,this.fpsHistory=[],console.log(`[AdaptiveQuality] Target FPS changed: ${t} â†’ ${e}`)}}getFPS(){return this.fps}getCurrentQualityName(){return this.qualityPresets[this.currentQualityIndex].name}getCurrentQualityIndex(){return this.currentQualityIndex}getQualityPresets(){return this.qualityPresets.map(e=>e.name)}isManualMode(){return this.manualMode}getStats(){const e=this.qualityPresets[this.currentQualityIndex];return{fps:this.fps,qualityName:e.name,qualityIndex:this.currentQualityIndex,maxStdDev:e.maxStdDev.toFixed(2),minPixelRadius:e.minPixelRadius,stochastic:e.stochastic,pixelRatio:this.renderer.getPixelRatio().toFixed(1),targetFPS:this.targetFPS}}}class bi{constructor(){this.currentSiteId=null,this.urlParams=new URLSearchParams(window.location.search)}hasSiteParameter(){return this.urlParams.has("site")}getSiteFromURL(){return this.urlParams.get("site")}isValidSite(e,t){return!e||!t?!1:t.some(i=>i.id===e)}shouldShowGlobe(e){const t=this.getSiteFromURL();return t?this.isValidSite(t,e)?(this.currentSiteId=t,!1):(console.warn(`Invalid site parameter: ${t}. Showing globe.`),!0):!0}navigateToSite(e){const t=new URLSearchParams(window.location.search);t.set("site",e);const i=`${window.location.pathname}?${t.toString()}`;window.location.href=i}navigateToGlobe(){window.location.href=window.location.pathname}getCurrentSiteId(){return this.currentSiteId||this.getSiteFromURL()}updateURLWithoutReload(e){const t=new URLSearchParams(window.location.search);t.set("site",e);const i=`${window.location.pathname}?${t.toString()}`;window.history.pushState({siteId:e},"",i)}}class xi{constructor(e,t){this.container=e,this.onSiteSelected=t,this.scene=null,this.camera=null,this.renderer=null,this.labelRenderer=null,this.controls=null,this.earth=null,this.atmosphere=null,this.markers=[],this.raycaster=new r.Raycaster,this.mouse=new r.Vector2,this.hoveredMarker=null,this.animationId=null,this.isInitialized=!1}latLongToVector3(e,t,i){const s=(90-e)*(Math.PI/180),o=(t+180)*(Math.PI/180);return new r.Vector3(-i*Math.sin(s)*Math.cos(o),i*Math.cos(s),i*Math.sin(s)*Math.sin(o))}async init(e){if(this.isInitialized)return;this.scene=new r.Scene,this.scene.background=new r.Color(1296);const t=window.innerWidth/window.innerHeight;this.camera=new r.PerspectiveCamera(45,t,.1,1e3);const n=this.latLongToVector3(45,10,12);this.camera.position.copy(n),this.camera.lookAt(0,0,0),this.renderer=new r.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.labelRenderer=new Nt,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0",this.labelRenderer.domElement.style.pointerEvents="none",this.container.appendChild(this.labelRenderer.domElement);const l=new r.AmbientLight(16777215,.4);this.scene.add(l);const c=new r.DirectionalLight(16777215,.8);c.position.set(5,3,5),this.scene.add(c),await this.createEarth(),this.createAtmosphere(),this.createSiteMarkers(e),this.controls=new Ht(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.minDistance=7,this.controls.maxDistance=20,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.addEventListeners(),this.isInitialized=!0,this.animate()}async createEarth(){const e=new r.SphereGeometry(5,64,64),t=new r.TextureLoader,i=await new Promise((o,n)=>{t.load("models/textures/earth_day.jpg",o,void 0,n)}),s=new r.MeshStandardMaterial({map:i,roughness:.9,metalness:.1});this.earth=new r.Mesh(e,s),this.scene.add(this.earth)}createAtmosphere(){const e=new r.SphereGeometry(5.2,64,64),t=new r.ShaderMaterial({vertexShader:`
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
                }
            `,blending:r.AdditiveBlending,side:r.BackSide,transparent:!0});this.atmosphere=new r.Mesh(e,t),this.scene.add(this.atmosphere)}positionLabelsWithCollisionAvoidance(e,t=8,i=1.5){const s=e.map(l=>this.latLongToVector3(l.latitude,l.longitude,t)),o=50,n=.5;for(let l=0;l<o;l++){let c=!1;for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++){const f=s[d].distanceTo(s[u]);if(f<i){const p=new r.Vector3().subVectors(s[d],s[u]).normalize(),b=(i-f)*n;s[d].add(p.clone().multiplyScalar(b)),s[u].sub(p.clone().multiplyScalar(b)),c=!0}}if(s.forEach(d=>{d.normalize().multiplyScalar(t)}),!c){console.log(`Label positioning converged in ${l+1} iterations`);break}}return s}createConnectingLine(e,t){const i=[e,t],s=new r.BufferGeometry().setFromPoints(i),o=new r.LineBasicMaterial({color:16777215,opacity:.5,transparent:!0,linewidth:1});return new r.Line(s,o)}createSiteMarkers(e){const s=this.positionLabelsWithCollisionAvoidance(e,6.5);e.forEach((o,n)=>{const l=this.latLongToVector3(o.latitude,o.longitude,5.05),c=s[n],d=new r.SphereGeometry(.15,16,16),u=new r.MeshBasicMaterial({color:16737792,transparent:!0,opacity:0}),f=new r.Mesh(d,u);f.position.copy(l),f.userData={siteId:o.id,siteName:o.name},this.scene.add(f);const p=this.createLabelElement(o),b=new jt(p);b.position.copy(c),b.userData={siteId:o.id},this.scene.add(b);const k=this.createConnectingLine(l,c);this.scene.add(k),this.markers.push({mesh:f,label:b,line:k,site:o,sitePosition:l.clone(),labelPosition:c.clone()})})}createLabelElement(e){const t=document.createElement("div");t.className="globe-site-marker",t.style.pointerEvents="auto";const i=document.createElement("div");i.className="globe-thumbnail-container",i.style.width="80px",i.style.height="80px",i.style.borderRadius="50%",i.style.border="3px solid #ff6600",i.style.marginBottom="8px",i.style.overflow="hidden",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.boxShadow="0 0 20px rgba(255, 102, 0, 0.6)",i.style.transition="border-color 0.2s ease, box-shadow 0.2s ease";const s=document.createElement("img");s.src=e.thumbnail||"models/thumbnails/placeholder.jpg",s.alt=e.name,s.style.width="120px",s.style.height="120px",s.style.objectFit="cover",s.style.display="block",i.appendChild(s);const o=document.createElement("span");return o.textContent=e.name,o.style.color="#ffffff",o.style.fontSize="14px",o.style.fontWeight="bold",o.style.textShadow="0 0 10px rgba(0, 0, 0, 0.8)",o.style.display="block",o.style.textAlign="center",t.appendChild(i),t.appendChild(o),t.style.cursor="pointer",t.style.transition="transform 0.2s ease",t.dataset.siteId=e.id,t}addEventListeners(){window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("click",this.onClick.bind(this)),window.addEventListener("touchend",this.onTouch.bind(this)),window.addEventListener("resize",this.onWindowResize.bind(this))}onMouseMove(e){var s,o;this.mouse.x=e.clientX/window.innerWidth*2-1,this.mouse.y=-(e.clientY/window.innerHeight)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const t=this.markers.map(n=>n.mesh),i=this.raycaster.intersectObjects(t);if(this.hoveredMarker){const n=(s=this.markers.find(l=>l.mesh===this.hoveredMarker))==null?void 0:s.label;n&&(n.element.style.transform="scale(1)"),this.hoveredMarker=null}if(i.length>0){this.hoveredMarker=i[0].object;const n=(o=this.markers.find(l=>l.mesh===this.hoveredMarker))==null?void 0:o.label;n&&(n.element.style.transform="scale(1.2)"),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onTouch(e){const t=e.changedTouches[0],i=document.elementFromPoint(t.clientX,t.clientY);if(i&&i.closest(".globe-site-marker")){const o=i.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&(console.log("Touch site selected:",o),this.onSiteSelected(o),e.preventDefault())}}onClick(e){if(e.target.closest(".globe-site-marker")){const o=e.target.closest(".globe-site-marker").dataset.siteId;o&&this.onSiteSelected&&this.onSiteSelected(o);return}this.raycaster.setFromCamera(this.mouse,this.camera);const t=this.markers.map(s=>s.mesh),i=this.raycaster.intersectObjects(t);if(i.length>0){const s=i[0].object.userData.siteId;s&&this.onSiteSelected&&this.onSiteSelected(s)}}onWindowResize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.labelRenderer.setSize(e,t)}animate(){this.animationId=requestAnimationFrame(this.animate.bind(this)),this.controls&&this.controls.update(),this.updateConnectingLines(),this.renderer&&this.scene&&this.camera&&(this.renderer.render(this.scene,this.camera),this.labelRenderer.render(this.scene,this.camera))}updateConnectingLines(){this.markers&&this.markers.forEach(e=>{if(e.line&&e.mesh&&e.label){const t=new r.Vector3;e.mesh.getWorldPosition(t);const i=e.label.position,s=e.line.geometry.attributes.position.array;s[0]=t.x,s[1]=t.y,s[2]=t.z,s[3]=i.x,s[4]=i.y,s[5]=i.z,e.line.geometry.attributes.position.needsUpdate=!0}})}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),window.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("click",this.onClick.bind(this)),window.removeEventListener("touchend",this.onTouch.bind(this)),window.removeEventListener("resize",this.onWindowResize.bind(this)),this.controls&&this.controls.dispose(),this.markers&&(this.markers.forEach(e=>{e.line&&(e.line.geometry&&e.line.geometry.dispose(),e.line.material&&e.line.material.dispose()),e.mesh&&(e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose())}),this.markers=[]),this.scene.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this.renderer&&this.container.removeChild(this.renderer.domElement),this.labelRenderer&&this.container.removeChild(this.labelRenderer.domElement),this.isInitialized=!1}show(){this.container.style.display="block",setTimeout(()=>{this.container.classList.add("visible")},50)}hide(){this.container.classList.remove("visible"),setTimeout(()=>{this.container.style.display="none"},500)}}const re={JOIN_ROOM:"join_room",LEAVE_ROOM:"leave_room",PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left",PLAYER_STATE:"player_state",FULL_STATE:"full_state",PAINT_STROKE:"paint_stroke",ERROR:"error"};class vi{constructor(e){this.socket=null,this.serverUrl=e,this.connected=!1,this.connecting=!1,this.roomId=null,this.playerId=null,this.playerName=null,this.onPlayerJoined=null,this.onPlayerLeft=null,this.onPlayerState=null,this.onFullState=null,this.onPaintStroke=null,this.onConnectionChange=null,this.onError=null,this.lastStateSend=0,this.stateUpdateInterval=50,this.reconnectAttempts=0,this.maxReconnectAttempts=5}connect(){return this.connected||this.connecting?Promise.resolve(this.playerId):(this.connecting=!0,new Promise((e,t)=>{console.log(`[MP] Connecting to ${this.serverUrl}...`),this.socket=Xt(this.serverUrl,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:2e4}),this.socket.on("connect",()=>{this.connected=!0,this.connecting=!1,this.playerId=this.socket.id,this.reconnectAttempts=0,console.log(`[MP] Connected! Player ID: ${this.playerId}`),this.onConnectionChange&&this.onConnectionChange(!0),e(this.playerId)}),this.socket.on("connect_error",i=>{console.error("[MP] Connection error:",i.message),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&(this.connecting=!1,t(new Error(`Failed to connect after ${this.maxReconnectAttempts} attempts`)))}),this.socket.on("disconnect",i=>{console.log(`[MP] Disconnected: ${i}`),this.connected=!1,this.onConnectionChange&&this.onConnectionChange(!1),i==="io server disconnect"&&(this.roomId=null)}),this.socket.on("reconnect",i=>{console.log(`[MP] Reconnected after ${i} attempts`),this.connected=!0,this.playerId=this.socket.id,this.onConnectionChange&&this.onConnectionChange(!0),this.roomId&&this.joinRoom(this.roomId,this.playerName)}),this.setupMessageHandlers()}))}setupMessageHandlers(){this.socket.on(re.PLAYER_JOINED,e=>{console.log(`[MP] Player joined: ${e.name} (${e.playerId})`),this.onPlayerJoined&&this.onPlayerJoined(e)}),this.socket.on(re.PLAYER_LEFT,e=>{console.log(`[MP] Player left: ${e.playerId}`),this.onPlayerLeft&&this.onPlayerLeft(e)}),this.socket.on(re.PLAYER_STATE,e=>{this.onPlayerState&&this.onPlayerState(e)}),this.socket.on(re.FULL_STATE,e=>{console.log(`[MP] Received full state: ${Object.keys(e.players||{}).length} players, ${(e.paintHistory||[]).length} paint actions`),this.playerName=e.playerName,this.onFullState&&this.onFullState(e)}),this.socket.on(re.PAINT_STROKE,e=>{this.onPaintStroke&&this.onPaintStroke(e)}),this.socket.on(re.ERROR,e=>{console.error("[MP] Server error:",e.message),this.onError&&this.onError(e)})}joinRoom(e,t=null){if(!this.connected){console.warn("[MP] Cannot join room: not connected");return}this.roomId=e,this.playerName=t,console.log(`[MP] Joining room: ${e}`),this.socket.emit(re.JOIN_ROOM,{sceneId:e,playerName:t})}leaveRoom(){!this.connected||!this.roomId||(console.log(`[MP] Leaving room: ${this.roomId}`),this.socket.emit(re.LEAVE_ROOM),this.roomId=null)}sendPlayerState(e){if(!this.connected||!this.roomId)return;const t=Date.now();t-this.lastStateSend<this.stateUpdateInterval||(this.lastStateSend=t,this.socket.emit(re.PLAYER_STATE,e))}sendPaintStroke(e){!this.connected||!this.roomId||this.socket.emit(re.PAINT_STROKE,e)}disconnect(){this.socket&&(console.log("[MP] Disconnecting..."),this.socket.disconnect(),this.socket=null,this.connected=!1,this.connecting=!1,this.roomId=null,this.playerId=null)}isConnected(){return this.connected}getRoomId(){return this.roomId}getPlayerId(){return this.playerId}}class wi{constructor(e,t,i){this.id=e,this.name=t,this.scene=i,this.model=null,this.mixer=null,this.animationsMap=new Map,this.currentAction="Idle",this.loaded=!1,this.targetPosition=new r.Vector3,this.targetQuaternion=new r.Quaternion,this.stateBuffer=[],this.interpolationDelay=100,this.nameLabel=null,this.positionLerpFactor=.15,this.rotationSlerpFactor=.15}async load(e){const t=new bt;return new Promise((i,s)=>{t.load(e,o=>{this.model=qt.clone(o.scene),this.model.traverse(l=>{l.isMesh&&(l.castShadow=!0,l.receiveShadow=!0,l.material&&(l.material=l.material.clone(),l.material.color.multiplyScalar(.85)))}),this.scene.add(this.model),this.mixer=new r.AnimationMixer(this.model),o.animations.forEach(l=>{const c=l.clone(),d=this.mixer.clipAction(c);this.animationsMap.set(l.name,d)});const n=this.animationsMap.get("Idle");n&&n.play(),this.createNameLabel(),this.loaded=!0,console.log(`[MP] Remote player model loaded: ${this.name} (animations: ${this.animationsMap.size})`),i(this)},void 0,o=>{console.error("[MP] Failed to load remote player model:",o),s(o)})})}createNameLabel(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=256,e.height=64,t.fillStyle="rgba(0, 0, 0, 0.6)",t.roundRect(10,10,236,44,8),t.fill(),t.font="Bold 24px Arial",t.fillStyle="#ffffff",t.textAlign="center",t.textBaseline="middle",t.fillText(this.name,128,32);const i=new r.CanvasTexture(e);i.minFilter=r.LinearFilter;const s=new r.SpriteMaterial({map:i,transparent:!0,depthTest:!1});this.nameLabel=new r.Sprite(s),this.nameLabel.scale.set(2,.5,1),this.nameLabel.renderOrder=999,this.scene.add(this.nameLabel)}updateState(e,t){const i=new r.Vector3(e.position.x,e.position.y,e.position.z),s=new r.Quaternion(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w);for(this.stateBuffer.push({timestamp:t,position:i,quaternion:s,animationState:e.animationState});this.stateBuffer.length>30;)this.stateBuffer.shift()}update(e){if(!this.model||!this.loaded)return;const t=Date.now()-this.interpolationDelay;let i=null,s=null;for(let o=0;o<this.stateBuffer.length-1;o++)if(this.stateBuffer[o].timestamp<=t&&this.stateBuffer[o+1].timestamp>=t){i=this.stateBuffer[o],s=this.stateBuffer[o+1];break}if(i&&s){const o=(t-i.timestamp)/(s.timestamp-i.timestamp),n=Math.max(0,Math.min(1,o));this.model.position.lerpVectors(i.position,s.position,n),this.model.quaternion.slerpQuaternions(i.quaternion,s.quaternion,n),this.updateAnimation(s.animationState)}else if(this.stateBuffer.length>0){const o=this.stateBuffer[this.stateBuffer.length-1];this.model.position.lerp(o.position,this.positionLerpFactor),this.model.quaternion.slerp(o.quaternion,this.rotationSlerpFactor),this.updateAnimation(o.animationState)}this.model.updateMatrixWorld(!0),this.nameLabel&&(this.nameLabel.position.copy(this.model.position),this.nameLabel.position.y+=2.5),this.mixer&&this.mixer.update(e)}updateAnimation(e){if(!e)return;let t="Idle";if(e.isJetpackActive&&!e.isGrounded?t="TPose":!e.isGrounded&&e.timeInAir>.4?t="Idle":e.directionPressed&&e.toggleRun?t="Run":e.directionPressed&&(t="Walk"),t!==this.currentAction){const i=this.animationsMap.get(this.currentAction),s=this.animationsMap.get(t);i&&s&&(i.fadeOut(.2),s.reset().fadeIn(.2).play(),this.currentAction=t)}}setInitialState(e){!this.model||!e||(this.model.position.set(e.position.x,e.position.y,e.position.z),this.model.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w),this.nameLabel&&(this.nameLabel.position.copy(this.model.position),this.nameLabel.position.y+=2.5))}dispose(){console.log(`[MP] Disposing remote player: ${this.name}`),this.model&&(this.scene.remove(this.model),this.model.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this.model=null),this.nameLabel&&(this.scene.remove(this.nameLabel),this.nameLabel.material.map&&this.nameLabel.material.map.dispose(),this.nameLabel.material.dispose(),this.nameLabel=null),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null),this.animationsMap.clear(),this.stateBuffer=[],this.loaded=!1}}class Pi{constructor(e,t){this.scene=e,this.characterModelPath=t,this.remotePlayers=new Map,this.pendingPlayers=new Map,this.pendingStates=new Map}async addPlayer(e,t,i=null){if(this.remotePlayers.has(e))return console.warn(`[MP] Player ${e} already exists`),this.remotePlayers.get(e);if(this.pendingPlayers.has(e))return this.pendingPlayers.get(e);console.log(`[MP] Adding remote player: ${t} (${e})`);const s=new wi(e,t,this.scene),o=s.load(this.characterModelPath).then(()=>{i&&s.setInitialState(i),this.remotePlayers.set(e,s),this.pendingPlayers.delete(e);const n=this.pendingStates.get(e);return n&&(s.updateState(n.state,n.timestamp),s.setInitialState(n.state),this.pendingStates.delete(e),console.log(`[MP] Applied pending state for ${t}`)),console.log(`[MP] Remote player ready: ${t} (total: ${this.remotePlayers.size})`),s}).catch(n=>{throw console.error(`[MP] Failed to add remote player ${t}:`,n),this.pendingPlayers.delete(e),this.pendingStates.delete(e),n});return this.pendingPlayers.set(e,o),o}removePlayer(e){const t=this.remotePlayers.get(e);t&&(t.dispose(),this.remotePlayers.delete(e),console.log(`[MP] Remote player removed: ${e} (remaining: ${this.remotePlayers.size})`)),this.pendingPlayers.delete(e),this.pendingStates.delete(e)}updatePlayerState(e,t,i){const s=this.remotePlayers.get(e);s&&s.loaded?s.updateState(t,i):this.pendingPlayers.has(e)&&this.pendingStates.set(e,{state:t,timestamp:i})}hasPlayer(e){return this.remotePlayers.has(e)||this.pendingPlayers.has(e)}getPlayer(e){return this.remotePlayers.get(e)}update(e){this.remotePlayers.forEach(t=>{t.update(e)})}getPlayerCount(){return this.remotePlayers.size}getPlayerIds(){return Array.from(this.remotePlayers.keys())}clear(){console.log(`[MP] Clearing all remote players (${this.remotePlayers.size})`),this.remotePlayers.forEach(e=>{e.dispose()}),this.remotePlayers.clear(),this.pendingPlayers.clear(),this.pendingStates.clear()}dispose(){this.clear(),this.scene=null,this.characterModelPath=null}}class It{constructor(e,t,i){this.gaussianSplat=e,this.spark=t,this.brushParams=i,this.appliedPaintIds=new Set,this.isReadyForPaint=!1,this.pendingPaintQueue=[],this.pendingLocalPlayerId=null}setReadyForPaint(){console.log("[MP] PaintSync now ready for paint operations"),this.isReadyForPaint=!0,this.processPendingQueue()}processPendingQueue(){if(this.pendingPaintQueue.length===0)return;console.log(`[MP] Processing ${this.pendingPaintQueue.length} queued paint events`);const e=this.pendingPaintQueue,t=this.pendingLocalPlayerId;this.pendingPaintQueue=[],this.pendingLocalPlayerId=null,e.forEach(i=>{this.applyRemotePaint(i,t)})}applyRemotePaint(e,t){if(console.log(`[MP] applyRemotePaint called - paintData.id: ${e.id}, paintData.playerId: ${e.playerId}, localPlayerId: ${t}, isReadyForPaint: ${this.isReadyForPaint}`),this.appliedPaintIds.has(e.id)){console.log(`[MP] Skipping paint ${e.id} - already applied`);return}if(e.playerId===t){console.log(`[MP] Skipping paint ${e.id} - this is our own paint`),this.appliedPaintIds.add(e.id);return}if(!this.isReadyForPaint){console.log(`[MP] Queuing paint ${e.id} - splat not ready yet`),this.pendingPaintQueue.push(e),this.pendingLocalPlayerId=t;return}console.log(`[MP] Applying remote paint from ${e.playerId}, brush params:`,{radius:e.brushRadius,color:e.brushColor,origin:e.rayOrigin,direction:e.rayDirection,useSurface:e.useSurface}),this.appliedPaintIds.add(e.id);const i={enabled:this.brushParams.enabled.value,radius:this.brushParams.brushRadius.value,depth:this.brushParams.brushDepth.value,color:this.brushParams.brushColor.value.clone(),origin:this.brushParams.brushOrigin.value.clone(),direction:this.brushParams.brushDirection.value.clone(),useSurface:this.brushParams.useSurface.value,surfacePoint:this.brushParams.surfacePoint.value.clone()};this.brushParams.enabled.value=!0,this.brushParams.brushRadius.value=e.brushRadius,this.brushParams.brushDepth.value=e.brushDepth,this.brushParams.brushColor.value.set(e.brushColor.r,e.brushColor.g,e.brushColor.b),this.brushParams.brushOrigin.value.set(e.rayOrigin.x,e.rayOrigin.y,e.rayOrigin.z),this.brushParams.brushDirection.value.set(e.rayDirection.x,e.rayDirection.y,e.rayDirection.z),console.log("[MP] After setting brush params:",{origin:{x:this.brushParams.brushOrigin.value.x,y:this.brushParams.brushOrigin.value.y,z:this.brushParams.brushOrigin.value.z},direction:{x:this.brushParams.brushDirection.value.x,y:this.brushParams.brushDirection.value.y,z:this.brushParams.brushDirection.value.z},enabled:this.brushParams.enabled.value}),this.brushParams.useSurface.value=e.useSurface,e.surfacePoint&&this.brushParams.surfacePoint.value.set(e.surfacePoint.x,e.surfacePoint.y,e.surfacePoint.z),requestAnimationFrame(()=>{console.log("[MP] Inside requestAnimationFrame - about to bake. Brush state:",{origin:{x:this.brushParams.brushOrigin.value.x,y:this.brushParams.brushOrigin.value.y,z:this.brushParams.brushOrigin.value.z},direction:{x:this.brushParams.brushDirection.value.x,y:this.brushParams.brushDirection.value.y,z:this.brushParams.brushDirection.value.z},enabled:this.brushParams.enabled.value}),this.bakePaint(),this.brushParams.enabled.value=i.enabled,this.brushParams.brushRadius.value=i.radius,this.brushParams.brushDepth.value=i.depth,this.brushParams.brushColor.value.copy(i.color),this.brushParams.brushOrigin.value.copy(i.origin),this.brushParams.brushDirection.value.copy(i.direction),this.brushParams.useSurface.value=i.useSurface,this.brushParams.surfacePoint.value.copy(i.surfacePoint)})}applyPaintHistory(e,t){!e||e.length===0||(console.log(`[MP] Applying paint history: ${e.length} actions`),e.forEach(i=>{this.applyRemotePaint(i,t)}))}bakePaint(){var e,t;if(!this.gaussianSplat||!this.spark){console.warn("[MP] Cannot bake paint: missing gaussianSplat or spark");return}try{console.log(`[MP] bakePaint called - splatRgba exists: ${!!this.gaussianSplat.splatRgba}, enabled: ${this.brushParams.enabled.value}`),console.log("[MP] Current brush state:",{enabled:this.brushParams.enabled.value,radius:this.brushParams.brushRadius.value,origin:{x:this.brushParams.brushOrigin.value.x,y:this.brushParams.brushOrigin.value.y,z:this.brushParams.brushOrigin.value.z},direction:{x:this.brushParams.brushDirection.value.x,y:this.brushParams.brushDirection.value.y,z:this.brushParams.brushDirection.value.z},color:{r:this.brushParams.brushColor.value.x,g:this.brushParams.brushColor.value.y,b:this.brushParams.brushColor.value.z}}),console.log(`[MP] gaussianSplat.worldModifier exists: ${!!this.gaussianSplat.worldModifier}`),console.log("[MP] DEBUG: brushParams.brushOrigin === window.BRUSH_PARAMS?.brushOrigin:",this.brushParams.brushOrigin===((e=window.BRUSH_PARAMS)==null?void 0:e.brushOrigin)),console.log("[MP] DEBUG: brushParams reference check - enabled.value:",this.brushParams.enabled.value);const i=!this.gaussianSplat.splatRgba;console.log("[MP] Calling spark.getRgba with generator:",this.gaussianSplat);const s=this.spark.getRgba({generator:this.gaussianSplat,rgba:this.gaussianSplat.splatRgba});console.log("[MP] getRgba returned:",s),console.log("[MP] newRgba type:",typeof s,(t=s==null?void 0:s.constructor)==null?void 0:t.name),this.gaussianSplat.splatRgba=s,i?(console.log("[MP] First paint - calling updateGenerator()"),this.gaussianSplat.updateGenerator()):(console.log("[MP] Subsequent paint - calling updateVersion()"),this.gaussianSplat.updateVersion()),console.log("[MP] bakePaint completed successfully"),console.log(`[MP] gaussianSplat.visible: ${this.gaussianSplat.visible}, gaussianSplat in scene: ${this.gaussianSplat.parent?"yes":"no"}`)}catch(i){console.error("[MP] Error baking paint:",i)}}isReady(){return this.gaussianSplat&&this.gaussianSplat.worldModifier&&this.gaussianSplat.parent!==null&&this.spark}clearAppliedPaints(){this.appliedPaintIds.clear(),this.pendingPaintQueue=[],this.pendingLocalPlayerId=null,this.isReadyForPaint=!1}updateReferences(e,t){this.gaussianSplat=e,this.spark=t,this.clearAppliedPaints()}dispose(){this.appliedPaintIds.clear(),this.gaussianSplat=null,this.spark=null,this.brushParams=null}}function Si(a){const e=a.model,t=a.currentAction,i=t==="Walk"||t==="Run";return{position:{x:e.position.x,y:e.position.y,z:e.position.z},quaternion:{x:e.quaternion.x,y:e.quaternion.y,z:e.quaternion.z,w:e.quaternion.w},animationState:{isGrounded:a.isGrounded,timeInAir:a.timeInAir,isJetpackActive:a.isJetpackActive,directionPressed:i,toggleRun:a.toggleRun}}}function Mi(a,e){return{brushRadius:a.brushRadius.value,brushDepth:a.brushDepth.value,brushColor:{r:a.brushColor.value.x,g:a.brushColor.value.y,b:a.brushColor.value.z},rayOrigin:{x:a.brushOrigin.value.x,y:a.brushOrigin.value.y,z:a.brushOrigin.value.z},rayDirection:{x:a.brushDirection.value.x,y:a.brushDirection.value.y,z:a.brushDirection.value.z},useSurface:a.useSurface.value,surfacePoint:e?{x:e.x,y:e.y,z:e.z}:null}}let Re=null,h=null,me=null,Pe=null,ct=null,J,P,E,W,R,x,V,A=null,_=null,Be=null,G=null,de=null,Q=null,Ae=null,Fe=0;const ki="https://multiplayer-server-production-6351.up.railway.app",$e="f1000_username";let H=null,ve=null,oe=null,ue=[],se=null,M,X,y=null,Se=1,U=null,pe=0,ut=2500,F=null,K=null,Le=213,ze=37,Xe=180,qe=0,Je=0,De=0,Oe=0,B=0,le=0,ce=0,he=0;const Ci=new r.Clock;let St=60;const lt=v.dynoFloat(0);let Te=0;const m={enabled:v.dynoBool(!1),brushRadius:v.dynoFloat(.05),brushDepth:v.dynoFloat(10),brushOrigin:v.dynoVec3(new r.Vector3(0,0,0)),brushDirection:v.dynoVec3(new r.Vector3(0,0,0)),brushColor:v.dynoVec3(new r.Vector3(1,0,1)),useSurface:v.dynoBool(!1),surfacePoint:v.dynoVec3(new r.Vector3(0,0,0)),surfaceRadius:v.dynoFloat(.2)},Ri=.01,Ti=.25,Ei=.1,Ii=100;let q=!1,ht=!1,Z=null,mt=!1;const D=function(){const a="ontouchstart"in window||navigator.maxTouchPoints>0,e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),t=a||e;return console.log("Mobile detection:",{touch:a,userAgent:e,isMobile:t}),t}(),Ge={},ft=new Yt(D);let $=null,ae="third-person",ne=0,te=0,pt=!1;const Mt=.002,kt=.005,st=Math.PI/2-.1;function xt(a){for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;return a}let ge=!1,we=0;const Ai=.5;let et=new r.Vector3,Ee=new r.Vector3,tt=new r.Quaternion,ot=new r.Quaternion,fe="third-person",Ke=0;const Ct=.2;let gt=!1,Ye=!1,nt=2,at=!1,Ne=!1,je=!1,Me=null,Ze=!1,j=null;function Fi(){var i,s;J=new r.Scene;const a=((i=h==null?void 0:h.scene)==null?void 0:i.backgroundColor)||"#a8def0";J.background=new r.Color(a);const e=(h==null?void 0:h.camera)||{};P=new r.PerspectiveCamera(e.fov||60,window.innerWidth/window.innerHeight,e.near||.1,e.far||1e3),P.position.set(0,5,10),E=new r.WebGLRenderer({antialias:!1,powerPreference:"high-performance"}),E.setSize(window.innerWidth,window.innerHeight),E.setPixelRatio(D?1:Math.min(window.devicePixelRatio,2)),E.shadowMap.enabled=!0,E.shadowMap.type=r.PCFSoftShadowMap,document.body.appendChild(E.domElement),W=new Ot({renderer:E,maxStdDev:Math.sqrt(D?5:7),minPixelRadius:D?.5:.3,maxPixelRadius:D?256:384,minAlpha:D?1/255:.7/255,clipXY:D?1.6:2,falloff:D?.8:.95}),J.add(W),D&&(W.defaultView.sortDistance=.05,W.defaultView.sortCoorient=.97,console.log("Mobile sorting optimizations applied")),Z=new r.Raycaster,Li();const t=((s=h==null?void 0:h.camera)==null?void 0:s.orbitControls)||{};R=new Jt(P,E.domElement),R.enableDamping=t.enableDamping!==void 0?t.enableDamping:!0,R.minDistance=t.minDistance||1,R.maxDistance=t.maxDistance||5,R.enablePan=t.enablePan!==void 0?t.enablePan:!1,R.maxPolarAngle=Math.PI*(t.maxPolarAngle||.55),R.update(),D&&($=new Ut(Ge,R),$.setFirstPersonCallback(es),$.setPaintCallback(_i),$.setPaintEndCallback(Qi),console.log("Touch controls initialized early (before character load)")),console.log("Scene initialized")}function Li(){var l,c;const a=((l=h==null?void 0:h.lighting)==null?void 0:l.ambient)||{};J.add(new r.AmbientLight(a.color||16777215,a.intensity!==void 0?a.intensity:.7));const e=((c=h==null?void 0:h.lighting)==null?void 0:c.directional)||{};K=new r.DirectionalLight(e.color||16777215,e.intensity!==void 0?e.intensity:1),K.castShadow=e.castShadow!==void 0?e.castShadow:!0;const t=e.shadowCamera||{};K.shadow.camera.top=t.top||50,K.shadow.camera.bottom=t.bottom||-50,K.shadow.camera.left=t.left||-50,K.shadow.camera.right=t.right||50,K.shadow.camera.near=t.near||.1,K.shadow.camera.far=t.far||200;const i=e.shadowMapSize,s=typeof i=="number"?i:2048,o=(i==null?void 0:i.width)||s,n=(i==null?void 0:i.height)||s;K.shadow.mapSize.width=o,K.shadow.mapSize.height=n,J.add(K),it()}function zi(){var t;const a=new bt,e=((t=h==null?void 0:h.assets)==null?void 0:t.collisionFile)||"models/StoneHenge-collision.glb";a.load(e,i=>{var ee,xe,Y,Pt;let s;if(i.scene.traverse(N=>{N instanceof r.Mesh&&!s&&(s=N)}),!s){console.error("No mesh found in collision GLB file");return}const o=s,n=new r.MeshStandardMaterial({color:8421504,roughness:.8,metalness:.2,side:r.DoubleSide}),l=o.geometry;M=new r.Mesh(l,n),M.position.copy(o.position),M.rotation.copy(o.rotation),M.scale.copy(o.scale),M.applyMatrix4(i.scene.matrix),M.scale.multiplyScalar(Se),M.rotation.x+=Xe*(Math.PI/180),M.rotation.y+=qe*(Math.PI/180),M.rotation.z+=Je*(Math.PI/180),M.position.y=0,M.receiveShadow=!0,M.castShadow=!0,M.visible=!1,J.add(M);try{l.boundingBox||l.computeBoundingBox();const N=l.boundingBox.clone();N.min.multiplyScalar(Se),N.max.multiplyScalar(Se);const _e=new r.Vector3(N.min.x,-N.max.y,N.min.z),Ve=new r.Vector3(N.max.x,-N.min.y,N.max.z);pe=Ve.y,console.log(`[Collision Mesh] World bounding box (at Y=0): min.y=${_e.y.toFixed(2)}, max.y=${Ve.y.toFixed(2)}`),console.log(`[Collision Mesh] maxTerrainHeight = ${pe.toFixed(2)} (highest walkable point after all transforms)`),ce=_e.y<0?-_e.y:0,he=Ve.y>0?-Ve.y:0,console.log(`[Height Offset Bounds] Calculated from worldBBox: min.y=${_e.y.toFixed(2)}, max.y=${Ve.y.toFixed(2)}`),console.log(`[Height Offset Bounds] Range: ${he.toFixed(2)} to ${ce.toFixed(2)} (scaled units)`)}catch(N){console.error("[Collision Mesh] Failed to calculate bounds:",N),pe=100,ce=0,he=-100}le==="max"?(B=ce,console.log(`[Height Offset] Resolved "max" to ${B.toFixed(2)}`)):le==="min"&&(B=he,console.log(`[Height Offset] Resolved "min" to ${B.toFixed(2)}`)),ls(),M.position.y=B;const c=new r.PlaneGeometry(1e4,1e4),d=new r.TextureLoader,u=((xe=(ee=h==null?void 0:h.assets)==null?void 0:ee.textures)==null?void 0:xe.floor)||{},f=d.load(u.color||"textures/sand/Sand 002_COLOR.jpg"),p=d.load(u.normal||"textures/sand/Sand 002_NRM.jpg"),b=d.load(u.displacement||"textures/sand/Sand 002_DISP.jpg"),k=d.load(u.ao||"textures/sand/Sand 002_OCC.jpg"),w=1e3;[f,p,b,k].forEach(N=>{N.wrapS=r.RepeatWrapping,N.wrapT=r.RepeatWrapping,N.repeat.set(w,w)});const C=new r.MeshStandardMaterial({map:f,normalMap:p,displacementMap:b,displacementScale:0,aoMap:k,aoMapIntensity:1,roughness:.9,metalness:0,side:r.DoubleSide});X=new r.Mesh(c,C),X.rotation.x=-Math.PI/2,X.position.y=0,X.receiveShadow=!0,X.visible=((Pt=(Y=h==null?void 0:h.scene)==null?void 0:Y.infiniteFloor)==null?void 0:Pt.visible)!==!1,J.add(X);const O=new r.WireframeGeometry(l),L=new r.LineBasicMaterial({color:65280,linewidth:2,transparent:!0,opacity:.8});j=new r.LineSegments(O,L),j.position.copy(M.position),j.rotation.copy(M.rotation),j.scale.copy(M.scale),j.visible=!1,J.add(j),console.log("Collision mesh loaded successfully (invisible, use for physics only)"),console.log("Press G to toggle collision wireframe, H to toggle Gaussian splat, R to reset Magic effect, F to toggle infinite floor, L to toggle leveling controls"),console.log("Press M to toggle background music, N to toggle movement sounds"),Ie(),Ne=!0;const T=document.getElementById("collision-progress-bar"),I=document.getElementById("collision-progress-text"),z=document.getElementById("start-collision-bar"),ie=document.getElementById("start-collision-text");T&&I&&(T.style.width="100%",I.textContent="100%"),z&&ie&&(z.style.width="100%",ie.textContent="100%"),vt(),Gi(),Bi()},i=>{const s=i.total>0?Math.min(100,Math.round(i.loaded/i.total*100)):0;console.log("Collision mesh: "+s+"% loaded");const o=document.getElementById("collision-progress-bar"),n=document.getElementById("collision-progress-text"),l=document.getElementById("start-collision-bar"),c=document.getElementById("start-collision-text");o&&n&&(o.style.width=s+"%",n.textContent=s+"%"),l&&c&&(l.style.width=s+"%",c.textContent=s+"%")},i=>{console.error("Error loading collision mesh:",i)})}function Ie(){const a=Xe*(Math.PI/180),e=qe*(Math.PI/180),t=Je*(Math.PI/180),i=De*(Math.PI/180),s=Oe*(Math.PI/180),o=B;M&&(M.position.y=o,M.rotation.x=a,M.rotation.y=e,M.rotation.z=t,M.rotation.x+=i,M.rotation.z+=s),y&&(y.position.y=o,y.rotation.x=a,y.rotation.y=e,y.rotation.z=t,y.rotation.x+=i,y.rotation.z+=s),j&&(j.position.y=o,j.rotation.x=a,j.rotation.y=e,j.rotation.z=t,j.rotation.x+=i,j.rotation.z+=s),console.log(`Leveling applied: X=${De.toFixed(1)}Â°, Z=${Oe.toFixed(1)}Â°, Height=${B.toFixed(2)}`)}function it(){if(!K)return;const a=Le*Math.PI/180,e=ze*Math.PI/180,t=100,i=t*Math.cos(e)*Math.sin(a),s=t*Math.sin(e),o=t*Math.cos(e)*Math.cos(a);K.position.set(i,s,o),console.log(`Light orientation: Azimuth=${Le}Â°, Elevation=${ze}Â°, Position=(${i.toFixed(1)}, ${s.toFixed(1)}, ${o.toFixed(1)})`)}function Di(){var i;const a=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},e=a.expansionRadius??ut,t=a.duration||2;return console.log(`Creating magic modifier: radius=${e.toFixed(1)}, duration=${t.toFixed(1)}s ${a.expansionRadius?"(from config)":"(auto-calculated)"}`),v.dynoBlock({gsplat:v.Gsplat},{gsplat:v.Gsplat},({gsplat:s})=>(s=new v.Dyno({inTypes:{gsplat:v.Gsplat,t:"float"},outTypes:{gsplat:v.Gsplat},globals:()=>[v.unindent(`
            // Pseudo-random hash function for noise generation
            vec3 hash(vec3 p) {
              p = fract(p * 0.3183099 + 0.1);
              p *= 17.0;
              return fract(vec3(p.x * p.y * p.z, p.x + p.y * p.z, p.x * p.y + p.z));
            }

            // 3D Perlin-style noise function
            vec3 noise(vec3 p) {
              vec3 i = floor(p);
              vec3 f = fract(p);
              f = f * f * (3.0 - 2.0 * f);

              vec3 n000 = hash(i + vec3(0,0,0));
              vec3 n100 = hash(i + vec3(1,0,0));
              vec3 n010 = hash(i + vec3(0,1,0));
              vec3 n110 = hash(i + vec3(1,1,0));
              vec3 n001 = hash(i + vec3(0,0,1));
              vec3 n101 = hash(i + vec3(1,0,1));
              vec3 n011 = hash(i + vec3(0,1,1));
              vec3 n111 = hash(i + vec3(1,1,1));

              vec3 x0 = mix(n000, n100, f.x);
              vec3 x1 = mix(n010, n110, f.x);
              vec3 x2 = mix(n001, n101, f.x);
              vec3 x3 = mix(n011, n111, f.x);

              vec3 y0 = mix(x0, x1, f.y);
              vec3 y1 = mix(x2, x3, f.y);

              return mix(y0, y1, f.z);
            }
          `)],statements:({inputs:n,outputs:l})=>v.unindentLines(`
          ${l.gsplat} = ${n.gsplat};
          float t = ${n.t};
          float s = smoothstep(0., ${t.toFixed(1)}, t) * ${e.toFixed(1)};
          vec3 scales = ${n.gsplat}.scales;
          vec3 localPos = ${n.gsplat}.center;
          float l = length(localPos.xz);

          // Magic Effect: Complex twister with noise and radial reveal (${e} unit radius in ${t} seconds)
          float border = abs(s-l-.5);
          localPos *= 1.-.2*exp(-20.*border);
          vec3 finalScales = mix(scales,vec3(0.002),smoothstep(s-.5,s,l+.5));
          ${l.gsplat}.center = localPos + .1*noise(localPos.xyz*2.+t*.5)*smoothstep(s-.5,s,l+.5);
          ${l.gsplat}.scales = finalScales;
          float at = atan(localPos.x,localPos.z)/3.1416;
          ${l.gsplat}.rgba *= step(at,t-3.1416);
          ${l.gsplat}.rgba += exp(-20.*border) + exp(-50.*abs(t-at-3.1416))*.5;
        `)}).apply({gsplat:s,t:lt}).gsplat,{gsplat:s}))}function Oi(a,e,t,i,s,o,n,l,c){return v.dynoBlock({gsplat:v.Gsplat},{gsplat:v.Gsplat},({gsplat:d})=>{if(!d)throw new Error("No gsplat input");let{center:u,rgb:f}=v.splitGsplat(d).outputs;const p=v.dot(s,v.sub(u,i)),b=v.add(i,v.mul(s,p)),k=v.length(v.sub(b,u)),w=v.lessThan(k,e),C=v.length(v.sub(b,l)),O=v.lessThan(C,c),L=v.and(v.greaterThan(p,v.dynoFloat(0)),v.lessThan(p,t)),T=v.select(n,O,L),I=v.and(w,T),z=v.select(a,v.select(I,o,f),f);return d=v.combineGsplat({gsplat:d,rgb:z}),{gsplat:d}})}async function Gi(){var a,e,t,i;console.log("Loading Gaussian splat...");try{const s=document.getElementById("splat-progress-bar"),o=document.getElementById("splat-progress-text"),n=document.getElementById("start-splat-bar"),l=document.getElementById("start-splat-text");s&&o&&(s.style.width="10%",o.textContent="10%"),n&&l&&(n.style.width="10%",l.textContent="10%");const c=((a=h==null?void 0:h.assets)==null?void 0:a.splatFile)||"models/StoneHenge.sog";y=new Gt({url:c}),console.log("SplatMesh created, waiting for initialization..."),s&&o&&(s.style.width="50%",o.textContent="50%"),n&&l&&(n.style.width="50%",l.textContent="50%"),await y.initialized,console.log("SplatMesh initialized successfully");const d=y.getBoundingBox(!1),u=new r.Vector3;d.getSize(u);const f=Math.max(u.x,u.y,u.z),p=u.length()/2;console.log("Splat bounding box (local space):"),console.log("  min:",d.min),console.log("  max:",d.max),console.log("  extent:",u),console.log("  max dimension:",f.toFixed(2)),console.log("  radius (center to corner):",p.toFixed(2));const b=p*Se*1.5,k=((e=h==null?void 0:h.camera)==null?void 0:e.far)||1e3,w=Math.max(b,k);P&&(P.far=w,P.updateProjectionMatrix(),console.log(`Camera far plane: config=${k}, auto=${b.toFixed(0)}, using=${w.toFixed(0)}`)),ut=Math.sqrt(u.x*u.x+u.z*u.z)/2*1.1,console.log(`Magic effect expansion radius: auto=${ut.toFixed(1)} (in splat space)`);const O=(t=h==null?void 0:h.character)==null?void 0:t.maxHeight;if(console.log(`[Height Cap Config] configMaxHeight="${O}", maxTerrainHeight=${pe.toFixed(2)}, heightOffset=${B.toFixed(2)}`),O==="auto"){const Y=pe+B;U=Y*2,console.log(`[Height Cap] Set to ${U.toFixed(2)} (auto: 2Ã— actual terrain height ${Y.toFixed(2)} = 2Ã— (${pe.toFixed(2)} + ${B.toFixed(2)}))`)}else if(typeof O=="number")O<0?(U=null,console.log(`[Height Cap] Set to NONE (unlimited) - config value: ${O}`)):(U=O,console.log(`[Height Cap] Set to ${U.toFixed(2)} (absolute from config)`));else{const Y=pe+B;U=Y*2,console.log(`[Height Cap] Set to ${U.toFixed(2)} (default auto: 2Ã— actual terrain height ${Y.toFixed(2)} = 2Ã— (${pe.toFixed(2)} + ${B.toFixed(2)}))`)}console.log(`[Height Cap Final] maxCharacterHeight = ${U===null?"null (unlimited)":U.toFixed(2)}`),x&&(x.maxHeight=U,console.log(`[Height Cap] Updated existing CharacterControls.maxHeight to ${U===null?"null (unlimited)":U.toFixed(2)}`)),s&&o&&(s.style.width="100%",o.textContent="100%"),n&&l&&(n.style.width="100%",l.textContent="100%"),y.scale.multiplyScalar(Se),y.rotation.x+=Xe*(Math.PI/180),y.rotation.y+=qe*(Math.PI/180),y.rotation.z+=Je*(Math.PI/180),y.position.y=B,W.add(y),y.visible=!1,Ie(),je=!0,A&&(A.gaussianSplat=y,console.log("Gaussian splat reference set in XRManager"));const L=30,T=20,I=50,z=D?T:L,ie=D?2:0;F=new yi(W,E,z,ie),F.vrTargetFPS=I,F.desktopTargetFPS=L,F.mobileTargetFPS=T,console.log("Adaptive quality system initialized");const ee=((i=h==null?void 0:h.scene)==null?void 0:i.magicEffect)||{},xe=ee.enabled!==!1&&(!D||ee.mobileEnabled===!0);if(console.log("Magic effect config check:",{enabled:ee.enabled,mobileEnabled:ee.mobileEnabled,isMobile:D,shouldEnableEffect:xe}),xe)try{y.objectModifier=Di(),y.updateGenerator(),console.log(`Gaussian splat loaded with Magic effect (${D?"mobile":"desktop"}) - awaiting user interaction`),console.log("Magic effect modifier attached:",!!y.objectModifier)}catch(Y){console.error("Error applying Magic effect modifier:",Y),console.log("Gaussian splat loaded without Magic effect (shader compilation failed)")}else console.log(`Gaussian splat loaded without Magic effect (${D?"mobile not enabled in config":"disabled in config"})`);try{y.worldModifier=Oi(m.enabled,m.brushRadius,m.brushDepth,m.brushOrigin,m.brushDirection,m.brushColor,m.useSurface,m.surfacePoint,m.surfaceRadius),y.updateGenerator(),console.log("Brush modifier applied to Gaussian splat"),ji()}catch(Y){console.error("Error applying brush modifier:",Y)}vt()}catch(s){console.error("Error loading Gaussian splat:",s)}}async function vt(){if(Ze)return;const a=document.getElementById("start-loading-bars"),e=document.getElementById("start-button");a&&(Ne&&je?(Ze=!0,Me&&(clearTimeout(Me),Me=null),console.log("All assets loaded, showing buttons..."),setTimeout(async()=>{a.style.display="none";const t=document.getElementById("username-container"),i=document.getElementById("username-input");if(t&&i){const s=localStorage.getItem($e);if(s)i.value=s,se=s;else{const o=`Player_${Math.random().toString(36).substring(2,6).toUpperCase()}`;i.value=o,se=o}t.style.display="block",i.addEventListener("input",()=>{const o=i.value.trim();o&&(se=o,localStorage.setItem($e,o))})}e&&(e.style.display="inline-block"),console.log("Assets loaded, start button shown")},500)):Me||(console.log("Assets not fully loaded, setting fallback timeout..."),Me=setTimeout(async()=>{if(Ne&&je&&!Ze){Ze=!0,console.log("Loading timeout: assets confirmed loaded, showing buttons"),a.style.display="none";const t=document.getElementById("username-container"),i=document.getElementById("username-input");if(t&&i){const s=localStorage.getItem($e);if(s)i.value=s,se=s;else{const o=`Player_${Math.random().toString(36).substring(2,6).toUpperCase()}`;i.value=o,se=o}t.style.display="block",i.addEventListener("input",()=>{const o=i.value.trim();o&&(se=o,localStorage.setItem($e,o))})}e&&(e.style.display="inline-block")}else(!Ne||!je)&&(console.warn("Loading timeout: assets STILL not loaded, waiting longer..."),Me=null,setTimeout(()=>vt(),2e3))},1e4)))}function Vi(){var e,t;if(gt){console.log("Magic reveal already started");return}if(gt=!0,Ye=!1,nt=(((e=h==null?void 0:h.scene)==null?void 0:e.magicEffect)||{}).duration||2,y&&(y.visible=!0),y&&y.objectModifier?(Te=0,lt.value=0,console.log(`Magic reveal animation started (duration: ${nt}s)`)):(console.log("Gaussian splat not ready for animation, skipping magic effect"),Ye=!0,At()),V&&(V.startBackgroundMusic(),console.log("Background music started")),V){const s=(((t=h==null?void 0:h.scene)==null?void 0:t.magicEffect)||{}).soundDelay||0;V.playMagicReveal(s),console.log(`Magic reveal sound will play in ${s}s`)}}function Bi(){var t;const a=new bt,e=((t=h==null?void 0:h.assets)==null?void 0:t.characterFile)||"models/Soldier.glb";a.load(e,i=>{var O,L,T,I;const s=i.scene;s.traverse(z=>{z.isMesh&&(z.castShadow=!0)}),J.add(s);const o=i.animations,n=new r.AnimationMixer(s),l=new Map;o.forEach(z=>{l.set(z.name,n.clipAction(z))});const c=((O=h==null?void 0:h.camera)==null?void 0:O.offsetFromCharacter)||{x:0,y:2,z:5},d=((T=(L=h==null?void 0:h.camera)==null?void 0:L.targetOffset)==null?void 0:T.y)||1;x=new _t(s,n,l,R,P,"Idle",[M,X],U,d);const u=((I=h==null?void 0:h.character)==null?void 0:I.spawn)||{},f=u.position||{x:0,y:"auto",z:40},p=u.rotation||{y:0};s.position.x=f.x,s.position.z=f.z,s.rotation.y=p.y*(Math.PI/180),f.y==="auto"?(s.position.y=1e3,console.log(`Auto-detecting ground height at spawn position (${f.x}, ${f.z})...`),x.placeOnGround()):(s.position.y=f.y,console.log(`Character spawned at specified position (${f.x}, ${f.y}, ${f.z})`));const k=new r.Vector3(c.x,c.y,c.z).clone().applyQuaternion(s.quaternion);P.position.set(s.position.x+k.x,s.position.y+k.y,s.position.z+k.z);const C=new r.Vector3(0,d,0).clone().applyQuaternion(s.quaternion);R.target.set(s.position.x+C.x,s.position.y+C.y,s.position.z+C.z),R.syncFromCamera(),R.update(),console.log("Character loaded successfully at position:",s.position),console.log("Camera positioned at:",P.position),console.log("Character facing east (rotation Y:",s.rotation.y,")"),console.log("Available animations:",Array.from(l.keys())),D&&(x.toggleRun=!0,console.log("Mobile: run mode enabled by default")),$i(),Hi(e)},i=>{console.log(i.loaded/i.total*100+"% loaded")},i=>{console.error("Error loading character:",i)})}function $i(){A=new ni(E,P,J,h),_=new ai(E,J,A),_.setGroundMeshes([M,X]),Be=new ri(E,J,x==null?void 0:x.model),de=new pi(J,Be),G=new fi(Be,A,de),Q=new gi(J),G.callbacks.onPaintStart=(a,e,t)=>{console.log(`Gesture paint start (${a})`),y&&(m.brushOrigin.value.copy(e),m.brushDirection.value.copy(t),m.enabled.value=!0),Q&&Q.updatePaintRay(a,e,t,!0)},G.callbacks.onPaintDrag=(a,e,t)=>{if(!y)return;m.brushOrigin.value.copy(e),m.brushDirection.value.copy(t),m.enabled.value=!0;const i=de?de.getSelectedColor():{hex:8913151},s=new r.Color(i.hex).convertLinearToSRGB();m.brushColor.value.x=s.r,m.brushColor.value.y=s.g,m.brushColor.value.z=s.b;const n=new r.Raycaster(e,t).intersectObjects([M,X],!0);n.length>0?(m.useSurface.value=!0,m.surfacePoint.value.copy(n[0].point)):m.useSurface.value=!1;const l=!y.splatRgba;y.splatRgba=W.getRgba({generator:y,rgba:y.splatRgba}),l?y.updateGenerator():y.updateVersion(),Q&&Q.updatePaintRay(a,e,t,!0)},G.callbacks.onPaintEnd=a=>{console.log(`Gesture paint end (${a})`),m.enabled.value=!1,Q&&Q.updatePaintRay(a,null,null,!1)},G.callbacks.onMovementStart=(a,e)=>{console.log(`Movement gesture started: speed=${e.toFixed(2)}`),Ae=a.clone(),Fe=e},G.callbacks.onMovementUpdate=(a,e)=>{Ae=a.clone(),Fe=e},G.callbacks.onMovementEnd=()=>{console.log("Movement gesture ended"),Ae=null,Fe=0},G.callbacks.onJetpackStart=a=>{console.log(`Jetpack gesture started (${a})`),x&&x.activateJetpack()},G.callbacks.onJetpackEnd=a=>{console.log(`Jetpack gesture ended (${a})`),x&&x.deactivateJetpack()},G.callbacks.onColorSelect=(a,e)=>{if(de){const t=de.checkHover(a,e);t!==null&&(de.selectColor(t),G.selectedColorIndex=t,console.log(`Color selected: index ${t}`))}},G.callbacks.onTeleportStart=(a,e)=>{if(console.log("Teleport started (LEFT hand)"),A){const i=new r.Raycaster(a,e).intersectObjects([M,X],!0);i.length>0?A.updateTeleportTarget(i[0].point):A.updateTeleportTarget(null)}},G.callbacks.onTeleportUpdate=(a,e)=>{if(A){const i=new r.Raycaster(a,e).intersectObjects([M,X],!0);i.length>0?A.updateTeleportTarget(i[0].point):A.updateTeleportTarget(null)}},G.callbacks.onTeleportEnd=(a,e)=>{console.log("Teleport executed (LEFT hand released)"),A&&A.executeTeleport()},G.callbacks.onTogglePaintMode=a=>{console.log(`Paint mode toggled via gesture: ${a?"ON":"OFF"}`),_&&(_.isPaintMode=a),y&&(m.enabled.value=a)},A.characterControls=x,A.orbitControls=R,A.xrControllers=_,A.xrHands=Be,A.gestureDetector=G,console.log("WebXR system initialized with gesture detection")}async function Hi(a){console.log("[MP] Initializing multiplayer..."),H=new vi(ki),ve=new Pi(J,a),y&&W&&(oe=new It(y,W,m)),H.onPlayerJoined=async e=>{console.log(`[MP] Player joined: ${e.name}`);try{await ve.addPlayer(e.playerId,e.name)}catch(t){console.error("[MP] Failed to add remote player:",t)}},H.onPlayerLeft=e=>{console.log(`[MP] Player left: ${e.playerId}`),ve.removePlayer(e.playerId)},H.onPlayerState=e=>{ve.updatePlayerState(e.playerId,e.state,e.timestamp)},H.onFullState=async e=>{console.log(`[MP] Received full state with ${Object.keys(e.players||{}).length} players`);for(const[t,i]of Object.entries(e.players||{}))try{const s=await ve.addPlayer(t,i.name,i.state);s&&i.state&&s.setInitialState(i.state)}catch(s){console.error(`[MP] Failed to add existing player ${t}:`,s)}e.paintHistory&&e.paintHistory.length>0&&(console.log(`[MP] Queuing ${e.paintHistory.length} paint history actions (will apply after magic reveal)`),ue.push(...e.paintHistory))},H.onPaintStroke=e=>{console.log("[MP] Received paint_stroke event:",e),Ye?oe&&oe.isReady()?(console.log(`[MP] paintSync is ready, applying remote paint from ${e.playerId}`),oe.applyRemotePaint(e,H.getPlayerId())):(ue.push(e),console.log(`[MP] Queued paint event (paintSync not ready yet), queue size: ${ue.length}`)):(ue.push(e),console.log(`[MP] Queued paint event (magic reveal in progress), queue size: ${ue.length}`))},H.onConnectionChange=e=>{console.log(`[MP] Connection status: ${e?"connected":"disconnected"}`)};try{await H.connect(),console.log("[MP] Connected to multiplayer server (will join room when experience starts)")}catch(e){console.error("[MP] Failed to connect to multiplayer server:",e)}}function Ni(){!H||!H.connected||me&&(console.log(`[MP] Joining room ${me} as "${se}"`),H.joinRoom(me,se))}function At(){if(!oe||!oe.isReady()||!H){console.log("[MP] Cannot apply pending paint - paintSync not ready");return}if(oe.setReadyForPaint(),ue.length===0){console.log("[MP] No pending paint events in main.js queue");return}console.log(`[MP] Applying ${ue.length} pending paint events from main.js queue`);const a=H.getPlayerId();ue.forEach(e=>{oe.applyRemotePaint(e,a)}),ue=[],console.log("[MP] All pending paint events applied")}function ji(){y&&W&&(oe?oe.updateReferences(y,W):(oe=new It(y,W,m),console.log("[MP] PaintSync initialized")))}function Xi(){var e,t;const a=((t=(e=h==null?void 0:h.assets)==null?void 0:e.audio)==null?void 0:t.jetpack)||"sounds/thrusters_loopwav-14699.mp3";V=new oi({backgroundMusic:"sounds/happy-relaxing-loop-275536.mp3",walkingSound:"sounds/walking-on-gravel-version-2-308744.mp3",runningSound:"sounds/running-on-gravel-301880.mp3",jetpackSound:a,magicReveal:"sounds/a-magical-intro-395716.mp3"},D),console.log("Audio system initialized - will start on user clicking start button")}function qi(){const a=document.getElementById("camera-icon-3rd"),e=document.getElementById("camera-icon-1st");ae==="first-person"?(a&&(a.style.display="none"),e&&(e.style.display="block")):(a&&(a.style.display="block"),e&&(e.style.display="none"))}function yt(){var a,e,t;if(!x){console.log("Character not loaded yet");return}if(!ge)if(ae==="third-person"){const i=x.model,s=new r.Euler;s.setFromQuaternion(i.quaternion,"YXZ"),te=xt(s.y),ne=0,et.copy(P.position),tt.copy(P.quaternion),Ee.set(i.position.x,i.position.y+x.firstPersonHeadHeight,i.position.z),P.rotation.order="YXZ";const o=new r.Euler(ne,te,0,"YXZ");ot.setFromEuler(o),ge=!0,we=0,fe="first-person",console.log("Starting transition to first-person mode")}else{const i=x.model;if(i){const s=((a=h==null?void 0:h.camera)==null?void 0:a.offsetFromCharacter)||{x:0,y:2,z:5},o=((t=(e=h==null?void 0:h.camera)==null?void 0:e.targetOffset)==null?void 0:t.y)||1,n=te,l=new r.Quaternion;l.setFromAxisAngle(new r.Vector3(0,1,0),n),i.quaternion.copy(l);const d=new r.Vector3(s.x,s.y,s.z).clone().applyQuaternion(i.quaternion);et.copy(P.position),tt.copy(P.quaternion),Ee.set(i.position.x+d.x,i.position.y+d.y,i.position.z+d.z);const f=new r.Vector3(0,o,0).clone().applyQuaternion(l);R.target.set(i.position.x+f.x,i.position.y+f.y,i.position.z+f.z);const p=Ee.distanceTo(R.target);console.log("Transition target distance:",p.toFixed(3)),console.log("WorldOffset:",d),console.log("TargetOffsetY:",o),ge=!0,we=0,fe="third-person",console.log("Starting transition to third-person mode"),console.log("Start pos:",et),console.log("Start quat:",tt),console.log("Target pos (OrbitControls final):",Ee),console.log("Target quat (OrbitControls final):",ot)}}}function Ji(){const a=document.getElementById("camera-toggle-button");a&&(a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),yt()}),D&&a.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),yt()},{passive:!1}),console.log("Camera toggle button initialized"))}function Yi(){const a=document.getElementById("paint-toggle-button");a&&D&&(a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Rt()}),a.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),Rt()},{passive:!1}),console.log("Paint toggle button initialized"))}function Rt(){q=!q;const a=document.getElementById("paint-toggle-button");a&&(q?a.classList.add("active"):a.classList.remove("active")),$&&$.setPaintMode(q),console.log(`Mobile paint mode: ${q?"ON":"OFF"}`)}function _i(a,e){if(!q||!y||!Z)return;const t=new r.Vector3(1,0,1),i=E.domElement.getBoundingClientRect(),s=new r.Vector2;s.x=(a-i.left)/i.width*2-1,s.y=-((e-i.top)/i.height)*2+1,Z.setFromCamera(s,P),m.brushOrigin.value.copy(Z.ray.origin),m.brushDirection.value.copy(Z.ray.direction),m.brushColor.value.copy(t);const o=Z.intersectObjects([M,X],!0);o.length>0?(m.useSurface.value=!0,m.surfacePoint.value.copy(o[0].point)):m.useSurface.value=!1,m.enabled.value=!0;const n=o.length>0?o[0].point:null;rt(n)}function Qi(){m&&m.enabled&&(m.enabled.value=!1)}function Wi(){const a=document.getElementById("jump-jetpack-button");if(a&&D){let e=null;const t=400;a.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),Ge[" "]=!0,setTimeout(()=>{(!$||!$.jetpackActive)&&(Ge[" "]=!1)},50),e=setTimeout(()=>{$&&($.activateJetpack(),a.classList.add("jetpack-active"))},t)},{passive:!1}),a.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),e&&(clearTimeout(e),e=null),$&&$.jetpackActive&&($.deactivateJetpack(),a.classList.remove("jetpack-active"))},{passive:!1}),a.addEventListener("touchcancel",i=>{e&&(clearTimeout(e),e=null),$&&$.jetpackActive&&($.deactivateJetpack(),a.classList.remove("jetpack-active"))},{passive:!1}),console.log("Jump/jetpack button initialized")}}function Ui(a){ae==="first-person"&&pt&&(te-=a.movementX*Mt,te=xt(te),ne-=a.movementY*Mt,ne=Math.max(-st,Math.min(st,ne)),x&&x.setFirstPersonRotation(ne,te))}function Ki(){pt=document.pointerLockElement===E.domElement,console.log(`Pointer lock: ${pt?"LOCKED":"UNLOCKED"}`)}function Zi(){console.error("Pointer lock failed")}function Ft(){ae==="first-person"&&!D&&!q&&E.domElement.requestPointerLock()}function Lt(){document.pointerLockElement===E.domElement&&document.exitPointerLock()}function es(a,e){ae==="first-person"&&(te-=a*kt,te=xt(te),ne-=e*kt,ne=Math.max(-st,Math.min(st,ne)),x&&x.setFirstPersonRotation(ne,te))}function ts(){q=!q,m.enabled.value=q,y&&(y.needsUpdate=!0);const a=document.getElementById("paint-controls");a&&(q?a.classList.add("visible"):a.classList.remove("visible")),q?E.domElement.classList.add("paint-mode"):E.domElement.classList.remove("paint-mode"),q?(Lt(),ae==="third-person"&&(R.enabled=!1),console.log("Paint mode: ON - LEFT-click drag or CTRL+move to paint, camera rotation disabled")):(ae==="first-person"?Ft():ae==="third-person"&&(R.enabled=!0),console.log("Paint mode: OFF"))}function Tt(a){const e=m.brushRadius.value,t=Math.max(Ri,Math.min(Ti,e+a));m.brushRadius.value=t,console.log(`Brush radius: ${t.toFixed(3)}`),wt()}function Et(a){const e=m.brushDepth.value,t=Math.max(Ei,Math.min(Ii,e+a));m.brushDepth.value=t,console.log(`Brush depth: ${t.toFixed(1)}`),wt()}function wt(){const a=document.getElementById("brush-size-display");a&&(a.textContent=`Radius: ${m.brushRadius.value.toFixed(3)} | Depth: ${m.brushDepth.value.toFixed(1)}`)}function rt(a=null){if(!y||!W)return;console.log("[MP] bakePaintAndBroadcast - brush params BEFORE getRgba:",{origin:{x:m.brushOrigin.value.x,y:m.brushOrigin.value.y,z:m.brushOrigin.value.z},direction:{x:m.brushDirection.value.x,y:m.brushDirection.value.y,z:m.brushDirection.value.z},enabled:m.enabled.value});const e=!y.splatRgba;if(y.splatRgba=W.getRgba({generator:y,rgba:y.splatRgba}),e?y.updateGenerator():y.updateVersion(),console.log("[MP] bakePaintAndBroadcast - brush params AFTER getRgba:",{origin:{x:m.brushOrigin.value.x,y:m.brushOrigin.value.y,z:m.brushOrigin.value.z},direction:{x:m.brushDirection.value.x,y:m.brushDirection.value.y,z:m.brushDirection.value.z},enabled:m.enabled.value}),H&&H.isConnected()){const t=Mi(m,a);console.log("[MP] Sending paint stroke:",t),H.sendPaintStroke(t)}}function is(){const a=document.getElementById("color-picker");a&&(a.addEventListener("input",e=>{const t=e.target.value,i=new r.Color(t).convertLinearToSRGB();m.brushColor.value.x=i.r,m.brushColor.value.y=i.g,m.brushColor.value.z=i.b,console.log(`Brush color changed to: ${t}`,i)}),console.log("Color picker initialized")),wt()}function ss(){E.domElement.addEventListener("pointermove",a=>{if(!q||!y||!Z)return;const e=new r.Vector2(a.clientX/window.innerWidth*2-1,-(a.clientY/window.innerHeight)*2+1);Z.setFromCamera(e,P);const t=Z.ray.direction.normalize();if(m.brushDirection.value.x=t.x,m.brushDirection.value.y=t.y,m.brushDirection.value.z=t.z,m.brushOrigin.value.x=Z.ray.origin.x,m.brushOrigin.value.y=Z.ray.origin.y,m.brushOrigin.value.z=Z.ray.origin.z,M){const i=Z.intersectObject(M,!1);if(i.length>0){const s=i[0].point;m.useSurface.value=!0,m.surfacePoint.value.x=s.x,m.surfacePoint.value.y=s.y,m.surfacePoint.value.z=s.z}else m.useSurface.value=!1}else m.useSurface.value=!1;if(y&&(y.needsUpdate=!0),(ht||mt)&&y){const i=m.useSurface.value?m.surfacePoint.value.clone():null;rt(i)}}),E.domElement.addEventListener("pointerdown",a=>{if(!q||!y||a.button!==0)return;a.preventDefault(),ht=!0;const e=m.useSurface.value?m.surfacePoint.value.clone():null;rt(e)}),E.domElement.addEventListener("pointerup",a=>{!q||a.button!==0||(ht=!1)}),console.log("Paint controls initialized")}function os(){let a=!1;const e=()=>{!a&&V&&(V.startBackgroundMusic(),a=!0,console.log("Background music started on touch interaction (fallback)"),document.removeEventListener("touchstart",e))};document.addEventListener("touchstart",e,{once:!0}),document.addEventListener("keydown",t=>{var s;if(!at)return;const i=t.key.toLowerCase();if(t.key==="Control"&&(mt=!0),Ge[i]=!0,ft.down(i),!a&&V&&(V.startBackgroundMusic(),a=!0,console.log("Background music started on keyboard interaction (fallback)")),i==="shift"&&x&&x.switchRunToggle(),i==="g"&&j&&(j.visible=!j.visible,console.log(`Collision mesh wireframe: ${j.visible?"ON":"OFF"}`)),i==="h"&&y&&(y.visible=!y.visible,console.log(`Gaussian splat: ${y.visible?"ON":"OFF"}`)),i==="r"&&y){if(Te=0,lt.value=0,V){const n=(((s=h==null?void 0:h.scene)==null?void 0:s.magicEffect)||{}).soundDelay||0;V.playMagicReveal(n)}console.log("Magic effect reset")}if(i==="f"&&X&&(X.visible=!X.visible,console.log(`Infinite floor: ${X.visible?"ON":"OFF"}`)),i==="l"){const o=document.getElementById("leveling-controls");if(o){o.classList.toggle("visible");const n=o.classList.contains("visible");console.log(`Leveling controls: ${n?"ON":"OFF"}`)}}i==="m"&&V&&V.toggleBackgroundMusic(),i==="n"&&V&&V.toggleMovementSounds(),i==="v"&&yt(),i==="p"&&ts(),i==="q"&&F&&F.increaseQuality(),i==="e"&&F&&F.decreaseQuality(),i==="t"&&F&&F.resumeAdaptive(),(i==="="||i==="+")&&Tt(.01),(i==="-"||i==="_")&&Tt(-.01),i==="["&&Et(-1),i==="]"&&Et(1)}),document.addEventListener("keyup",t=>{if(!at)return;const i=t.key.toLowerCase();t.key==="Control"&&(mt=!1),Ge[i]=!1,ft.up(i)}),console.log("Keyboard controls initialized")}async function ns(){const a=document.getElementById("start-button"),e=document.getElementById("start-overlay"),t=i=>{if(i.preventDefault(),i.stopPropagation(),!Ne||!je){console.warn("Assets not fully loaded yet, cannot start experience"),alert("Please wait for assets to finish loading...");return}console.log("Start button triggered - entering experience");const s=document.getElementById("username-input");s&&s.value.trim()&&(se=s.value.trim(),localStorage.setItem($e,se),console.log(`[MP] Using username: ${se}`)),Ni(),at=!0,e.classList.remove("visible"),Vi(),V&&V.unlockAudio().then(()=>{console.log("Audio unlocked successfully in background")}).catch(o=>{console.error("Audio unlock failed:",o)})};a&&(a.addEventListener("click",t),D&&a.addEventListener("touchstart",t,{passive:!1})),console.log("Start button initialized")}function as(){P.aspect=window.innerWidth/window.innerHeight,P.updateProjectionMatrix(),E.setSize(window.innerWidth,window.innerHeight),ft.updatePosition()}function rs(){var t,i,s,o;const a=Ci.getDelta();if(F){F.update(),St=F.getFPS();const n=document.getElementById("debug-fps");n&&(n.textContent=St);const l=document.getElementById("debug-quality");if(l){const d=F.getCurrentQualityName(),u=F.isManualMode()?"MANUAL":"Auto";l.textContent=`${d} (${u})`}const c=document.getElementById("debug-decimation");if(c){const d=F.getCurrentQualityIndex(),u=F.getQualityPresets();c.textContent=`${d}/${u.length-1}`}}if(y&&at&&(Te+=1/60,lt.value=Te,y.updateVersion(),gt&&!Ye&&Te>=nt&&(Ye=!0,console.log(`Magic reveal complete (baseTime: ${Te.toFixed(2)} >= duration: ${nt})`),At())),ge){if(we+=a/Ai,fe==="third-person"){const c=P.position.distanceTo(R.target);console.log(`[Transition ${(we*100).toFixed(1)}%] Pos: (${P.position.x.toFixed(3)}, ${P.position.y.toFixed(3)}, ${P.position.z.toFixed(3)}) Distance: ${c.toFixed(6)}`)}if(we>=1){if(we=1,P.position.copy(Ee),fe==="first-person"?P.quaternion.copy(ot):P.lookAt(R.target),ge=!1,fe==="third-person"&&(Ke=Ct),ae=fe,ae==="first-person")R.enabled=!1,x.model&&(x.model.visible=!1,x.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1,c.material.transparent=!1)})),x.setCameraMode("first-person"),x.setFirstPersonRotation(ne,te),$&&$.setCameraMode("first-person"),Ft(),console.log("Transition to first-person complete");else{x.model&&(x.model.visible=!0,x.model.traverse(f=>{f.isMesh&&f.material&&(f.material.opacity=1,f.material.transparent=!1)})),x.setCameraMode("third-person"),$&&$.setCameraMode("third-person"),Lt();const c=x.model,d=((i=(t=h==null?void 0:h.camera)==null?void 0:t.targetOffset)==null?void 0:i.y)||1;if(c){const p=new r.Vector3(0,d,0).clone().applyQuaternion(c.quaternion);R.target.set(c.position.x+p.x,c.position.y+p.y,c.position.z+p.z),console.log("Re-synced OrbitControls target to character position:",R.target)}R.enabled=!0,R.syncFromCamera(),R.update();const u=P.position.distanceTo(R.target);console.log("Transition to third-person complete"),console.log("Final camera pos:",P.position),console.log("Final distance to target:",u.toFixed(3)),console.log("OrbitControls target:",R.target)}qi()}const n=we,l=n<.5?2*n*n:-1+(4-2*n)*n;P.position.lerpVectors(et,Ee,l),fe==="first-person"?P.quaternion.slerpQuaternions(tt,ot,l):P.lookAt(R.target),x&&x.model&&(fe==="first-person"?l<.7?(x.model.visible=!0,x.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=1-l,c.material.transparent=!0)})):x.model.visible=!1:(x.model.visible=!0,x.model.traverse(c=>{c.isMesh&&c.material&&(c.material.opacity=l,c.material.transparent=!0)})))}const e=A&&A.getIsXRActive();if(F){const n=F.targetFPS===F.vrTargetFPS;if(e&&!n)F.setTargetFPS(F.vrTargetFPS);else if(!e&&n){const l=D?F.mobileTargetFPS:F.desktopTargetFPS;F.setTargetFPS(l)}}if(e){if(A.update(a,[M,X]),G){const n=E.xr.getSession();G.update(n,P.position)}if(de&&de.update(P.position),Ae&&Fe>0&&A){const n=((s=h==null?void 0:h.controls)==null?void 0:s.walkSpeed)||1.5,l=((o=h==null?void 0:h.controls)==null?void 0:o.runSpeed)||3,c=n+(l-n)*Fe,d=Ae.clone().multiplyScalar(c*a);A.updateReferenceSpaceByOffset(d),Q&&Q.updateMovementArrow(P.position,Ae,Fe,!0)}else Q&&Q.hideMovementArrow();if(Q&&G)if(G.mode==="jetpack"||G.mode==="moving_jetpack"){const l=E.xr.getSession();if(l){for(const c of l.inputSources)if(c.hand&&c.handedness==="right"){const d=Be.getJointPosition(c.hand,"wrist");d&&Q.updateJetpackGlow("right",d,!0);break}}}else Q.hideJetpackGlows();if(_&&_.isPaintMode&&y)for(let n=0;n<2;n++){const l=_.getRayForPainting(n);if(l){console.log(`VR Paint: controller ${n} painting - isDragging: ${_.isDragging}`),m.brushOrigin.value.copy(l.origin),m.brushDirection.value.copy(l.direction);const c=_.paletteColors[_.currentColorIndex],d=new r.Color(c.hex).convertLinearToSRGB();if(m.brushColor.value.x=d.r,m.brushColor.value.y=d.g,m.brushColor.value.z=d.b,m.enabled.value=!0,_.isDragging){console.log("VR Paint: Baking paint to texture");const u=m.useSurface.value?m.surfacePoint.value.clone():null;rt(u)}break}}else _&&!_.isPaintMode&&(m.enabled.value=!1);if(x){const n=document.getElementById("debug-state"),l=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist");if(n&&l&&c&&d){const u=A.isGrounded,f=A.jetpackActive;n.textContent=u?"GROUNDED":"IN AIR",n.className=u?"grounded":"in-air",l.textContent="VR Mode",c.textContent=f?"ACTIVE":"OFF",c.className=f?"jetpack-active":"",d.textContent="N/A (VR)"}}}else if(x){ge||x.update(a,Ge);const n=document.getElementById("debug-state"),l=document.getElementById("debug-animation"),c=document.getElementById("debug-jetpack"),d=document.getElementById("debug-ground-dist"),u=document.getElementById("debug-position");if(n&&l&&c&&d&&u){const f=x.getGroundedState(),p=x.getCurrentAction(),b=x.getJetpackActive(),k=x.getGroundDistance(),w=x.getPosition();n.textContent=f?"GROUNDED":"IN AIR",n.className=f?"grounded":"in-air",l.textContent=p,c.textContent=b?"ACTIVE":"OFF",c.className=b?"jetpack-active":"",d.textContent=k.toFixed(1)+"m",u.textContent=`(${w.x.toFixed(1)}|${w.y.toFixed(1)}|${w.z.toFixed(1)})`}if(V){const f=x.getMovementState();V.updateMovementSounds(f)}}if(V&&V.update(a),H&&H.isConnected()&&(x&&!ge&&H.sendPlayerState(Si(x)),ve&&ve.update(a)),Ke>0){Ke-=a;const n=P.position.distanceTo(R.target);console.log(`[Post-transition ${((Ct-Ke)*1e3).toFixed(0)}ms] Pos: (${P.position.x.toFixed(3)}, ${P.position.y.toFixed(3)}, ${P.position.z.toFixed(3)}) Distance: ${n.toFixed(6)} OrbitEnabled: ${R.enabled}`)}!ge&&!e&&ae==="third-person"&&R.update(),E.render(J,P)}function ls(){const a=document.getElementById("level-height-slider"),e=document.getElementById("level-height-value");a&&e&&(a.min=he.toFixed(2),a.max=ce.toFixed(2),a.value=B.toString(),e.textContent=`${B.toFixed(2)} [${he.toFixed(2)} to ${ce.toFixed(2)}]`,console.log(`[UI] Height slider bounds updated: [${he.toFixed(2)} to ${ce.toFixed(2)}]`))}function cs(){const a=document.getElementById("level-x-slider"),e=document.getElementById("level-z-slider"),t=document.getElementById("level-height-slider"),i=document.getElementById("light-azimuth-slider"),s=document.getElementById("light-elevation-slider"),o=document.getElementById("level-x-value"),n=document.getElementById("level-z-value"),l=document.getElementById("level-height-value"),c=document.getElementById("light-azimuth-value"),d=document.getElementById("light-elevation-value"),u=document.getElementById("leveling-reset");t&&l&&(t.value=B.toString(),l.textContent=`${B.toFixed(2)} [calculating...]`),a&&a.addEventListener("input",f=>{De=parseFloat(f.target.value),o.textContent=De.toFixed(1)+"Â°",Ie()}),e&&e.addEventListener("input",f=>{Oe=parseFloat(f.target.value),n.textContent=Oe.toFixed(1)+"Â°",Ie()}),t&&t.addEventListener("input",f=>{B=parseFloat(f.target.value),l.textContent=`${B.toFixed(2)} [${he.toFixed(2)} to ${ce.toFixed(2)}]`,Ie()}),i&&i.addEventListener("input",f=>{Le=parseFloat(f.target.value),c.textContent=Le.toFixed(0)+"Â°",it()}),s&&s.addEventListener("input",f=>{ze=parseFloat(f.target.value),d.textContent=ze.toFixed(0)+"Â°",it()}),u&&u.addEventListener("click",()=>{var C,O,L,T,I,z,ie,ee;const f=((O=(C=h==null?void 0:h.transform)==null?void 0:C.defaultLeveling)==null?void 0:O.x)||0,p=((T=(L=h==null?void 0:h.transform)==null?void 0:L.defaultLeveling)==null?void 0:T.z)||0;let b=0;le==="max"?b=ce:le==="min"?b=he:typeof le=="number"&&(b=le),De=f,Oe=p,B=b,a.value=f,e.value=p,t.value=b,o.textContent=f.toFixed(1)+"Â°",n.textContent=p.toFixed(1)+"Â°",l.textContent=`${b.toFixed(2)} [${he.toFixed(2)} to ${ce.toFixed(2)}]`;const k=((z=(I=h==null?void 0:h.lighting)==null?void 0:I.directional)==null?void 0:z.azimuth)||213,w=((ee=(ie=h==null?void 0:h.lighting)==null?void 0:ie.directional)==null?void 0:ee.elevation)||37;Le=k,ze=w,i.value=k,s.value=w,c.textContent=k.toFixed(0)+"Â°",d.textContent=w.toFixed(0)+"Â°",Ie(),it(),console.log("All controls reset to defaults")}),console.log("Leveling controls initialized")}async function hs(){try{Re=await Kt();const a=dt(Re),e=document.getElementById("scene-dropdown"),t=document.getElementById("start-scene-dropdown");e.innerHTML="",t&&(t.innerHTML=""),a.forEach(s=>{const o=document.createElement("option");if(o.value=s.id,o.textContent=s.name,e.appendChild(o),t){const n=document.createElement("option");n.value=s.id,n.textContent=s.name,t.appendChild(n)}});const i=ti(Re);e.value=i,t&&(t.value=i),e.addEventListener("change",async s=>{const o=s.target.value;o!==me&&(console.log(`Switching to scene: ${o}`),Pe.navigateToSite(o))}),t&&t.addEventListener("change",async s=>{const o=s.target.value;if(o!==me){console.log(`Switching to scene: ${o}`),e.value=o;const l=dt(Re).find(c=>c.id===o);if(l){const c=document.getElementById("start-title"),d=document.getElementById("start-description");c&&(c.textContent=l.name),d&&(d.textContent=l.description||"Prepare for an amazing journey")}Pe.navigateToSite(o)}}),console.log("Scene selectors initialized")}catch(a){console.error("Failed to initialize scene selector:",a)}}function ds(){sessionStorage.setItem("currentScene",me),h.transform.scale!==void 0&&(Se=h.transform.scale,console.log("Applied scale from config:",Se)),h.transform.rotation&&(Xe=h.transform.rotation.x!==void 0?h.transform.rotation.x:180,qe=h.transform.rotation.y!==void 0?h.transform.rotation.y:0,Je=h.transform.rotation.z!==void 0?h.transform.rotation.z:0,console.log("Applied rotation from config:",Xe,qe,Je)),h.transform.defaultLeveling&&(De=h.transform.defaultLeveling.x||0,Oe=h.transform.defaultLeveling.z||0),h.transform.heightOffset!==void 0&&(le=h.transform.heightOffset,typeof le=="number"&&(B=le),console.log(`[Config] heightOffset config value: ${le}`)),h.lighting.directional&&(Le=h.lighting.directional.azimuth,ze=h.lighting.directional.elevation),console.log("Scene configuration applied to global state")}async function us(a){console.log("Initializing globe view...");const e=document.getElementById("start-overlay");e&&(e.classList.remove("visible"),e.style.display="none");const t=document.getElementById("globe-overlay");if(!t){console.error("Globe container not found");return}ct=new xi(t,i=>{console.log("Site selected:",i),Pe.navigateToSite(i)}),await ct.init(a),ct.show(),console.log("Globe view initialized successfully")}async function ms(){console.log("Initializing F1000..."),await hs(),Pe=new bi;const a=dt(Re);if(Pe.shouldShowGlobe(a)){console.log("No valid site parameter - showing globe"),await us(a);return}console.log("Valid site parameter found - loading site:",Pe.getCurrentSiteId());let e=Pe.getCurrentSiteId();const t=ii(Re,e);h=await Zt(t),me=e,ds();const i=document.getElementById("scene-dropdown");i&&(i.value=me);const s=document.getElementById("start-scene-dropdown");s&&(s.value=me);const o=document.getElementById("start-title"),n=document.getElementById("start-description");h&&o&&n&&(o.textContent=h.name||"Unknown Location",n.textContent=h.description||"Prepare for an amazing journey"),Fi(),Xi(),zi(),os(),ss(),is(),cs(),ns(),Ji(),Yi(),Wi(),window.addEventListener("resize",as),document.addEventListener("mousemove",Ui),document.addEventListener("pointerlockchange",Ki),document.addEventListener("pointerlockerror",Zi),E.setAnimationLoop(rs),console.log("F1000 initialized successfully")}ms();
