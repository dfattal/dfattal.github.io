<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR-OpenXR Bridge Settings Panel</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #2c3e50;
            margin-top: 0;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .setting-label {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
        }

        .setting-value {
            width: 60px;
            text-align: right;
            font-family: monospace;
            color: #666;
        }

        .slider {
            flex: 2;
            margin: 0 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #2196F3;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .status-panel {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }

        .status-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-family: monospace;
            font-size: 1.1em;
            color: #2c3e50;
        }

        #resetSettingsButton:hover {
            background-color: #d32f2f;
        }

        .log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.error {
            background-color: #ffebee;
            color: #c62828;
        }

        .log-entry.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            body {
                padding: 10px;
            }

            .panel {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <h1>WebXR-OpenXR Bridge Settings Panel</h1>

    <div class="container">
        <div class="panel">
            <h2>Session Settings</h2>
            <div class="settings-group">
                <div class="setting-row">
                    <span class="setting-label">IPD Scale</span>
                    <input type="range" class="slider" id="ipdScale" min="0" max="2" step="0.001" value="1">
                    <span class="setting-value" id="ipdScaleValue">1.000</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Scene Scale</span>
                    <input type="range" class="slider" id="sceneScale" min="0" max="2" step="0.001" value="1">
                    <span class="setting-value" id="sceneScaleValue">1.000</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Parallax Strength</span>
                    <input type="range" class="slider" id="parallaxStrength" min="0" max="2" step="0.001" value="1">
                    <span class="setting-value" id="parallaxStrengthValue">1.000</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Convergence</span>
                    <input type="range" class="slider" id="convergence" min="0" max="2" step="0.001" value="1">
                    <span class="setting-value" id="convergenceValue">1.000</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Perspective Factor</span>
                    <input type="range" class="slider" id="perspectiveFactor" min="0" max="2" step="0.001" value="1">
                    <span class="setting-value" id="perspectiveFactorValue">1.000</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Projection Method</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="projectionMethod">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="setting-value" id="projectionMethodValue">Display Centric</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Control Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="controlMode">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="setting-value" id="controlModeValue">First Person</span>
                </div>

                <div class="setting-row">
                    <button id="resetSettingsButton"
                        style="width: 100%; padding: 10px; margin-top: 15px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Reset
                        Settings</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Head Pose Control</h2>
            <div class="settings-group">
                <div class="setting-row">
                    <span class="setting-label">Display Height</span>
                    <input type="range" class="slider" id="displayHeight" min="0" max="2" step="0.01" value="1.75">
                    <span class="setting-value" id="displayHeightValue">1.75m</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Display Yaw</span>
                    <input type="range" class="slider" id="displayYaw" min="0" max="360" step="1" value="0">
                    <span class="setting-value" id="displayYawValue">0°</span>
                </div>

                <div class="setting-row">
                    <button id="resetPoseButton"
                        style="width: 100%; padding: 10px; margin-top: 15px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Reset
                        Pose</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Head Pose Monitor</h2>
            <div class="status-grid" id="headPoseMonitor">
                <!-- Head pose values will be populated here -->
            </div>
        </div>

        <div class="panel">
            <h2>Live Settings</h2>
            <div class="status-grid" id="liveSettings">
                <!-- Live settings will be populated here -->
            </div>
        </div>
    </div>

    <div class="log" id="logPanel">
        <div>Event Log:</div>
    </div>

    <script>
        // Helper function to log messages
        function logMessage(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Helper function to update live settings display
        function updateLiveSettings(settings) {
            const liveSettings = document.getElementById('liveSettings');
            liveSettings.innerHTML = '';

            for (const [key, value] of Object.entries(settings)) {
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item';

                const label = document.createElement('div');
                label.className = 'status-label';
                label.textContent = key;

                const valueDiv = document.createElement('div');
                valueDiv.className = 'status-value';
                valueDiv.textContent = typeof value === 'number' ? value.toFixed(3) : value;

                statusItem.appendChild(label);
                statusItem.appendChild(valueDiv);
                liveSettings.appendChild(statusItem);
            }
        }

        // Helper function to update head pose monitor
        function updateHeadPoseMonitor(headPose) {
            const headPoseMonitor = document.getElementById('headPoseMonitor');
            headPoseMonitor.innerHTML = '';

            if (headPose && headPose.position && headPose.orientation) {
                const poseData = {
                    'Position X': headPose.position.x,
                    'Position Y': headPose.position.y,
                    'Position Z': headPose.position.z,
                    'Orientation X': headPose.orientation.x,
                    'Orientation Y': headPose.orientation.y,
                    'Orientation Z': headPose.orientation.z,
                    'Orientation W': headPose.orientation.w
                };

                for (const [key, value] of Object.entries(poseData)) {
                    const statusItem = document.createElement('div');
                    statusItem.className = 'status-item';

                    const label = document.createElement('div');
                    label.className = 'status-label';
                    label.textContent = key;

                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'status-value';
                    valueDiv.textContent = typeof value === 'number' ? value.toFixed(3) : value;

                    statusItem.appendChild(label);
                    statusItem.appendChild(valueDiv);
                    headPoseMonitor.appendChild(statusItem);
                }
            }
        }

        // Function to convert yaw angle to quaternion
        function yawToQuaternion(yawDegrees) {
            const yawRadians = yawDegrees * Math.PI / 180.0;
            const halfYaw = yawRadians * 0.5;

            return {
                x: 0,
                y: Math.sin(halfYaw), // Rotation around Y axis (up) in OpenXR coordinates
                z: 0,
                w: Math.cos(halfYaw)
            };
        }

        // Function to set head pose based on UI controls
        function setHeadPoseFromUI() {
            if (!window.WebXROpenXRBridge) return;

            const height = parseFloat(document.getElementById('displayHeight').value);
            const yaw = parseFloat(document.getElementById('displayYaw').value);

            const headPose = {
                position: {
                    x: 0.0,
                    y: height, // Height in OpenXR coordinates (Y is up)
                    z: 0.0
                },
                orientation: yawToQuaternion(yaw)
            };

            try {
                window.WebXROpenXRBridge.setHeadPose(headPose);
                logMessage(`Head pose set - Height: ${height}m, Yaw: ${yaw}°`, 'success');
            } catch (error) {
                logMessage(`Error setting head pose: ${error}`, 'error');
            }
        }

        // Function to get and display current head pose
        async function updateHeadPoseFromRuntime() {
            if (!window.WebXROpenXRBridge) return;

            try {
                const headPose = await window.WebXROpenXRBridge.getHeadPose();
                updateHeadPoseMonitor(headPose);
            } catch (error) {
                logMessage(`Error getting head pose: ${error}`, 'error');
            }
        }

        // Helper function to debounce slider input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to update all settings
        async function updateAllSettings() {
            if (!window.WebXROpenXRBridge) return;

            try {
                const settings = {
                    'IPD Scale': await window.WebXROpenXRBridge.getIPDScale(),
                    'Scene Scale': await window.WebXROpenXRBridge.getSceneScale(),
                    'Parallax Strength': await window.WebXROpenXRBridge.getParallaxStrength(),
                    'Convergence': await window.WebXROpenXRBridge.getConvergence(),
                    'Perspective Factor': await window.WebXROpenXRBridge.getPerspectiveFactor(),
                    'Projection Method': (await window.WebXROpenXRBridge.getProjectionMethod()) === 1 ? 'Display Centric' : 'Camera Centric',
                    'Control Mode': (await window.WebXROpenXRBridge.getControlMode()) === 0 ? 'First Person' : 'Fly'
                };

                updateLiveSettings(settings);

                // Update UI controls to match current values
                document.getElementById('ipdScale').value = settings['IPD Scale'];
                document.getElementById('ipdScaleValue').textContent = settings['IPD Scale'].toFixed(3);
                document.getElementById('sceneScale').value = settings['Scene Scale'];
                document.getElementById('sceneScaleValue').textContent = settings['Scene Scale'].toFixed(3);
                document.getElementById('parallaxStrength').value = settings['Parallax Strength'];
                document.getElementById('parallaxStrengthValue').textContent = settings['Parallax Strength'].toFixed(3);
                document.getElementById('convergence').value = settings['Convergence'];
                document.getElementById('convergenceValue').textContent = settings['Convergence'].toFixed(3);
                document.getElementById('perspectiveFactor').value = settings['Perspective Factor'];
                document.getElementById('perspectiveFactorValue').textContent = settings['Perspective Factor'].toFixed(3);
                document.getElementById('projectionMethod').checked = settings['Projection Method'] === 'Camera Centric';
                document.getElementById('projectionMethodValue').textContent = settings['Projection Method'];
                document.getElementById('controlMode').checked = settings['Control Mode'] === 'Fly';
                document.getElementById('controlModeValue').textContent = settings['Control Mode'];
            } catch (error) {
                logMessage(`Error updating settings: ${error}`, 'error');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ipdScale').addEventListener('input', function () {
                document.getElementById('ipdScaleValue').textContent = this.value;
                window.WebXROpenXRBridge.setIPDScale(parseFloat(this.value))
            });
            document.getElementById('sceneScale').addEventListener('input', function () {
                document.getElementById('sceneScaleValue').textContent = this.value;
                window.WebXROpenXRBridge.setSceneScale(parseFloat(this.value))
            });
            document.getElementById('parallaxStrength').addEventListener('input', function () {
                document.getElementById('parallaxStrengthValue').textContent = this.value;
                window.WebXROpenXRBridge.setParallaxStrength(parseFloat(this.value))
            });
            document.getElementById('convergence').addEventListener('input', function () {
                document.getElementById('convergenceValue').textContent = this.value;
                window.WebXROpenXRBridge.setConvergence(parseFloat(this.value))
            });
            document.getElementById('perspectiveFactor').addEventListener('input', function () {
                document.getElementById('perspectiveFactorValue').textContent = this.value;
                window.WebXROpenXRBridge.setSessionPerspectiveFactor(parseFloat(this.value))
            });

            // Set up toggle event listeners
            document.getElementById('projectionMethod').addEventListener('change', (e) => {
                try {
                    const newMethod = e.target.checked ? 0 : 1;
                    window.WebXROpenXRBridge.setProjectionMethod(newMethod);
                    const method = newMethod === 1 ? 'Display Centric' : 'Camera Centric';
                    document.getElementById('projectionMethodValue').textContent = method;
                    logMessage(`Projection Method set to ${method}`, 'success');
                } catch (error) {
                    logMessage(`Error setting Projection Method: ${error}`, 'error');
                }
            });

            document.getElementById('controlMode').addEventListener('change', (e) => {
                try {
                    const newMode = e.target.checked ? 1 : 0;
                    window.WebXROpenXRBridge.setControlMode(newMode);
                    const mode = newMode === 0 ? 'First Person' : 'Fly';
                    document.getElementById('controlModeValue').textContent = mode;
                    logMessage(`Control Mode set to ${mode}`, 'success');
                } catch (error) {
                    logMessage(`Error setting Control Mode: ${error}`, 'error');
                }
            });

            // Add reset settings button
            document.getElementById('resetSettingsButton').addEventListener('click', () => {
                window.WebXROpenXRBridge.resetSettings(1.0);
                logMessage('All settings reset to default', 'success');

                // Update the UI after a short delay to allow the reset to apply
                setTimeout(updateAllSettings, 500);
            });

            // Head pose control event listeners
            document.getElementById('displayHeight').addEventListener('input', function () {
                document.getElementById('displayHeightValue').textContent = this.value + 'm';
                setHeadPoseFromUI();
            });

            document.getElementById('displayYaw').addEventListener('input', function () {
                document.getElementById('displayYawValue').textContent = this.value + '°';
                setHeadPoseFromUI();
            });

            document.getElementById('resetPoseButton').addEventListener('click', () => {
                // Reset to default pose (1.75m height, 0° yaw)
                document.getElementById('displayHeight').value = 1.75;
                document.getElementById('displayHeightValue').textContent = '1.75m';
                document.getElementById('displayYaw').value = 0;
                document.getElementById('displayYawValue').textContent = '0°';

                setHeadPoseFromUI();
                logMessage('Head pose reset to default', 'success');
            });

            // Update settings every second
            setInterval(updateAllSettings, 1000);

            // Update head pose monitor every 500ms
            setInterval(updateHeadPoseFromRuntime, 500);

            // Initial updates
            updateAllSettings();
            updateHeadPoseFromRuntime();
        });
    </script>
</body>

</html>