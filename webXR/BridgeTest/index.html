<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR-OpenXR Bridge Connectivity Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1,
        h2 {
            color: #333;
        }

        .test-panel {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .warning {
            background-color: #fcf8e3;
            color: #8a6d3b;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
        }

        .info {
            background-color: #d9edf7;
            color: #31708f;
        }

        .log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            background-color: #f9f9f9;
        }
    </style>
</head>

<body>
    <h1>WebXR-OpenXR Bridge Connectivity Test</h1>
    <p>This page tests each component of the WebXR-OpenXR Bridge to help identify connection issues.</p>

    <div class="test-panel">
        <h2>Extension Connectivity Tests</h2>

        <div id="extensionStatus" class="status info">
            Checking for WebXR-OpenXR Bridge extension...
        </div>

        <div id="testControls">
            <button id="testExtension">Test Extension Presence</button>
            <button id="testNativeHost">Test Native Messaging Host</button>
            <button id="testRuntime">Test OpenXR Runtime</button>
            <div style="margin: 15px 0;">
                <label for="ipdSlider">IPD Scale (0-1): <span id="ipdValue">0.5</span></label>
                <div style="display: flex; align-items: center;">
                    <input type="range" id="ipdSlider" min="0" max="1" step="0.01" value="0.5" style="flex-grow: 1;">
                </div>
            </div>
            <button id="runAllTests">Run All Tests</button>
        </div>

        <div id="testResults">
            <!-- Test results will appear here -->
        </div>
    </div>

    <div class="log" id="logPanel">
        <div>Diagnostic Log:</div>
    </div>

    <script>
        // Helper function to log messages
        function logMessage(message, isError = false) {
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                logEntry.style.color = 'red';
            }
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Helper function to update status display
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Helper function to display test results
        function displayTestResult(test, result, details = "") {
            const testResults = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${result ? 'success' : 'error'}`;
            resultDiv.textContent = `${test}: ${result ? 'PASSED' : 'FAILED'}`;
            if (details) {
                const detailsP = document.createElement('p');
                detailsP.textContent = details;
                detailsP.style.fontSize = '0.9em';
                resultDiv.appendChild(detailsP);
            }
            testResults.appendChild(resultDiv);
        }

        // Test for extension presence
        function testExtensionPresence() {
            logMessage("Testing extension presence...");
            return new Promise((resolve) => {
                // Check if the bridge object is injected by the extension
                if (window.WebXROpenXRBridge) {
                    logMessage("Extension found: WebXROpenXRBridge API is available");
                    resolve({
                        success: true,
                        details: "WebXROpenXRBridge API found with methods: " +
                            Object.keys(window.WebXROpenXRBridge).join(", ")
                    });
                } else {
                    // Wait a short time to see if it loads asynchronously
                    setTimeout(() => {
                        if (window.WebXROpenXRBridge) {
                            logMessage("Extension found after delay");
                            resolve({
                                success: true,
                                details: "WebXROpenXRBridge API found with methods: " +
                                    Object.keys(window.WebXROpenXRBridge).join(", ")
                            });
                        } else {
                            logMessage("Extension not found", true);
                            resolve({
                                success: false,
                                details: "WebXROpenXRBridge API is not available. Check if the extension is installed and enabled."
                            });
                        }
                    }, 1000);
                }
            });
        }

        // Test native messaging host connectivity
        function testNativeHost() {
            logMessage("Testing native messaging host connectivity...");
            return new Promise((resolve) => {
                if (!window.WebXROpenXRBridge) {
                    logMessage("Cannot test native host: Extension not found", true);
                    resolve({
                        success: false,
                        details: "Cannot test native messaging host because the extension is not available."
                    });
                    return;
                }

                // Create a simple ping message to test the connection
                // We're not expecting real OpenXR functionality, just checking if messages go through
                const requestId = Date.now().toString();

                // Set a timeout for the response
                const timeoutId = setTimeout(() => {
                    // Clean up the message listener
                    window.removeEventListener('message', messageListener);

                    logMessage("Native messaging host didn't respond (timeout)", true);
                    resolve({
                        success: false,
                        details: "No response from native messaging host. Check if it's installed properly and the browser has permission to run it."
                    });
                }, 3000);

                // Listen for the response
                const messageListener = (event) => {
                    if (event.data &&
                        event.data.type === 'webxr-openxr-bridge-response' &&
                        event.data.ping === 'pong') {

                        // Clean up
                        clearTimeout(timeoutId);
                        window.removeEventListener('message', messageListener);

                        logMessage("Native messaging host responded successfully");
                        resolve({
                            success: true,
                            details: "Native messaging host is connected and responding."
                        });
                    }
                };
                window.addEventListener('message', messageListener);

                // Send a ping message
                logMessage("Sending ping to native messaging host...");
                window.postMessage({
                    type: 'webxr-openxr-bridge',
                    requestId: requestId,
                    ping: 'ping'
                }, '*');
            });
        }

        // Test OpenXR runtime connectivity
        function testRuntime() {
            logMessage("Testing OpenXR runtime connectivity...");
            return new Promise((resolve) => {
                if (!window.WebXROpenXRBridge) {
                    logMessage("Cannot test runtime: Extension not found", true);
                    resolve({
                        success: false,
                        details: "Cannot test OpenXR runtime because the extension is not available."
                    });
                    return;
                }

                // Try to get a simple setting - we don't care about the actual value,
                // just whether the IPC connection to the runtime works
                const timeoutId = setTimeout(() => {
                    logMessage("OpenXR runtime didn't respond (timeout)", true);
                    resolve({
                        success: false,
                        details: "No response from OpenXR runtime. Check if the SRHydra OpenXR Runtime is installed and running."
                    });
                }, 3000);

                // Try to get IPD Scale as a test
                window.WebXROpenXRBridge.getIPDScale()
                    .then(value => {
                        clearTimeout(timeoutId);

                        // Check if value is -1.0, which indicates fallback mode
                        if (value === -1.0) {
                            logMessage("Detected fallback mode: IPD scale is -1.0");
                            resolve({
                                success: true,
                                isFallback: true,
                                details: "The native messaging host is connected but cannot connect to the OpenXR runtime. Check if the SRHydra OpenXR Runtime is installed and running."
                            });
                        } else {
                            logMessage(`OpenXR runtime responded with IPD scale: ${value}`);
                            resolve({
                                success: true,
                                details: `OpenXR runtime is connected. Current IPD scale is ${value}.`
                            });
                        }
                    })
                    .catch(err => {
                        clearTimeout(timeoutId);
                        logMessage(`Error connecting to OpenXR runtime: ${err}`, true);
                        resolve({
                            success: false,
                            details: `Failed to connect to OpenXR runtime: ${err}`
                        });
                    });
            });
        }

        // Test setting IPD scale to 0.5
        function setIPDScale(value) {
            logMessage(`Setting IPD scale to ${value}...`);
            return new Promise((resolve) => {
                if (!window.WebXROpenXRBridge) {
                    logMessage("Cannot set IPD scale: Extension not found", true);
                    resolve({
                        success: false,
                        details: "Cannot set IPD scale because the extension is not available."
                    });
                    return;
                }

                const timeoutId = setTimeout(() => {
                    logMessage("OpenXR runtime didn't respond to IPD scale change (timeout)", true);
                    resolve({
                        success: false,
                        details: "No response when setting IPD scale. Check if the SRHydra OpenXR Runtime is installed and running."
                    });
                }, 3000);

                // Set IPD Scale to the provided value
                window.WebXROpenXRBridge.setIPDScale(value)
                    .then(() => {
                        clearTimeout(timeoutId);
                        logMessage(`IPD scale successfully set to ${value}`);

                        // Get the current value to confirm it was set
                        return window.WebXROpenXRBridge.getIPDScale();
                    })
                    .then(actualValue => {
                        logMessage(`Current IPD scale is now: ${actualValue}`);
                        const isClose = Math.abs(actualValue - value) < 0.01; // Allow small floating point difference

                        resolve({
                            success: isClose,
                            details: isClose
                                ? `IPD scale successfully set to ${actualValue}`
                                : `IPD scale value (${actualValue}) doesn't match requested value (${value})`
                        });
                    })
                    .catch(err => {
                        clearTimeout(timeoutId);
                        logMessage(`Error setting IPD scale: ${err}`, true);
                        resolve({
                            success: false,
                            details: `Failed to set IPD scale: ${err}`
                        });
                    });
            });
        }

        // Run all tests sequentially
        async function runAllTests() {
            logMessage("Running all connectivity tests...");
            document.getElementById('testResults').innerHTML = '';

            // Test extension
            const extensionResult = await testExtensionPresence();
            displayTestResult("Extension Presence", extensionResult.success, extensionResult.details);

            // Only proceed if extension is available
            if (extensionResult.success) {
                // Test native host
                const nativeHostResult = await testNativeHost();
                displayTestResult("Native Messaging Host", nativeHostResult.success, nativeHostResult.details);

                // Only test runtime if native host is available
                if (nativeHostResult.success) {
                    const runtimeResult = await testRuntime();
                    if (runtimeResult.success && runtimeResult.isFallback) {
                        // If in fallback mode, display a warning rather than success
                        const resultDiv = document.createElement('div');
                        resultDiv.className = "status warning";
                        resultDiv.textContent = "OpenXR Runtime: FALLBACK MODE";
                        const detailsP = document.createElement('p');
                        detailsP.textContent = runtimeResult.details;
                        detailsP.style.fontSize = '0.9em';
                        resultDiv.appendChild(detailsP);
                        document.getElementById('testResults').appendChild(resultDiv);
                    } else {
                        displayTestResult("OpenXR Runtime", runtimeResult.success, runtimeResult.details);
                    }
                }
            }

            logMessage("All tests completed");
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            logMessage("Diagnostic page loaded");

            // Set up button event listeners
            document.getElementById('testExtension').addEventListener('click', async () => {
                const result = await testExtensionPresence();
                displayTestResult("Extension Presence", result.success, result.details);
            });

            document.getElementById('testNativeHost').addEventListener('click', async () => {
                const result = await testNativeHost();
                displayTestResult("Native Messaging Host", result.success, result.details);
            });

            document.getElementById('testRuntime').addEventListener('click', async () => {
                const result = await testRuntime();
                if (result.success && result.isFallback) {
                    // If in fallback mode, display a warning rather than success
                    const resultDiv = document.createElement('div');
                    resultDiv.className = "status warning";
                    resultDiv.textContent = "OpenXR Runtime: FALLBACK MODE";
                    const detailsP = document.createElement('p');
                    detailsP.textContent = result.details;
                    detailsP.style.fontSize = '0.9em';
                    resultDiv.appendChild(detailsP);
                    document.getElementById('testResults').appendChild(resultDiv);
                } else {
                    displayTestResult("OpenXR Runtime", result.success, result.details);
                }
            });

            // Update the displayed value when slider is moved and apply the change when slider is released
            document.getElementById('ipdSlider').addEventListener('input', () => {
                const value = document.getElementById('ipdSlider').value;
                document.getElementById('ipdValue').textContent = value;
            });

            document.getElementById('ipdSlider').addEventListener('change', async () => {
                const sliderValue = parseFloat(document.getElementById('ipdSlider').value);
                logMessage(`Applying IPD Scale: ${sliderValue}`);
                const result = await setIPDScale(sliderValue);
                displayTestResult(`Set IPD Scale to ${sliderValue}`, result.success, result.details);
            });

            document.getElementById('runAllTests').addEventListener('click', runAllTests);

            // Run the first test automatically
            testExtensionPresence().then(result => {
                if (result.success) {
                    updateStatus('extensionStatus', 'Extension found! Click "Run All Tests" to check the complete connection.', 'success');
                } else {
                    updateStatus('extensionStatus', 'Extension not detected. Make sure the WebXR-OpenXR Bridge extension is installed.', 'error');
                }
            });
        });
    </script>
</body>

</html>