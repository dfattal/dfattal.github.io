<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenXR Window Overlay Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .demo-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .target-element {
            border: 3px dashed #007acc;
            background: linear-gradient(45deg, #f0f8ff, #e6f3ff);
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .target-element:hover {
            border-color: #0056b3;
            background: linear-gradient(45deg, #e6f3ff, #cce7ff);
            transform: scale(1.02);
        }

        .target-element h3 {
            margin: 0 0 10px 0;
            color: #007acc;
        }

        .target-element p {
            margin: 5px 0;
            color: #666;
            text-align: center;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="number"] {
            width: 80px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            background: #e8f5e8;
            border: 1px solid #28a745;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            color: #0c5460;
        }

        .current-rect {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }

        .instructions {
            background: #f0f8ff;
            border-left: 4px solid #007acc;
            padding: 15px;
            margin: 20px 0;
        }

        .instructions h3 {
            margin-top: 0;
            color: #007acc;
        }

        .overlay-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸŽ® OpenXR Window Overlay Demo</h1>

        <div class="instructions">
            <h3>How to use:</h3>
            <ol>
                <li>Make sure the OpenXR runtime is running</li>
                <li>Click on any target element below to overlay the OpenXR window on top of it</li>
                <li>Use the manual controls to set custom positions and sizes</li>
                <li>The OpenXR window will automatically exit fullscreen when positioned</li>
            </ol>
        </div>

        <div class="demo-area">
            <div class="target-element" id="target1">
                <span class="overlay-indicator">OpenXR Here!</span>
                <h3>ðŸŽ¯ Target Area 1</h3>
                <p>Video Player Region</p>
                <p>Click to overlay OpenXR window here</p>
                <p id="target1-info"></p>
            </div>

            <div class="target-element" id="target2">
                <span class="overlay-indicator">OpenXR Here!</span>
                <h3>ðŸŽ¯ Target Area 2</h3>
                <p>3D Content Region</p>
                <p>Click to overlay OpenXR window here</p>
                <p id="target2-info"></p>
            </div>

            <div class="target-element" id="target3">
                <span class="overlay-indicator">OpenXR Here!</span>
                <h3>ðŸŽ¯ Target Area 3</h3>
                <p>Game Display Region</p>
                <p>Click to overlay OpenXR window here</p>
                <p id="target3-info"></p>
            </div>

            <div class="target-element" id="target4">
                <span class="overlay-indicator">OpenXR Here!</span>
                <h3>ðŸŽ¯ Target Area 4</h3>
                <p>Media Preview Region</p>
                <p>Click to overlay OpenXR window here</p>
                <p id="target4-info"></p>
            </div>
        </div>

        <div class="controls">
            <h3>Manual Window Controls</h3>

            <div class="control-group">
                <label>Position:</label>
                <div class="control-row">
                    <span>X:</span>
                    <input type="number" id="posX" value="100" min="0" max="3000">
                    <span>Y:</span>
                    <input type="number" id="posY" value="100" min="0" max="3000">
                </div>
            </div>

            <div class="control-group">
                <label>Size:</label>
                <div class="control-row">
                    <span>Width:</span>
                    <input type="number" id="width" value="800" min="100" max="3000">
                    <span>Height:</span>
                    <input type="number" id="height" value="600" min="100" max="3000">
                </div>
            </div>

            <div class="control-group">
                <button onclick="setCustomWindowRect()">Set Custom Position</button>
                <button onclick="getCurrentWindowRect()">Get Current Position</button>
                <button onclick="centerWindow()">Center Window</button>
                <button onclick="resetToCorner()">Reset to Corner</button>
            </div>
        </div>

        <div id="status" class="status"></div>
        <div id="currentRect" class="current-rect" style="display: none;"></div>
    </div>

    <script>
        let currentOverlayTarget = null;

        // Check if extension is available and wait for it to load
        function checkExtensionAvailability() {
            if (typeof WebXROpenXRBridge === 'undefined') {
                showStatus('Waiting for WebXR OpenXR Bridge extension...', 'info');
                return false;
            } else {
                showStatus('WebXR OpenXR Bridge detected and ready!', 'success');
                return true;
            }
        }

        // Initialize target elements
        document.addEventListener('DOMContentLoaded', function () {
            updateTargetInfo();

            // Check extension availability immediately
            checkExtensionAvailability();

            // Recheck extension status every 2 seconds for the first 10 seconds
            // This handles cases where the extension loads after the page
            let recheckCount = 0;
            const recheckInterval = setInterval(() => {
                if (checkExtensionAvailability()) {
                    clearInterval(recheckInterval);
                    // Extension is now available, get current window rect
                    getCurrentWindowRect();
                } else {
                    recheckCount++;
                    if (recheckCount >= 5) {
                        clearInterval(recheckInterval);
                        showStatus('WebXR OpenXR Bridge extension not detected. Make sure the extension is installed and the runtime is running.', 'error');
                    }
                }
            }, 2000);

            // Add click handlers for target elements
            document.querySelectorAll('.target-element').forEach(element => {
                element.addEventListener('click', function () {
                    overlayWindowOnElement(this);
                });
            });

            // Update target info when window resizes
            window.addEventListener('resize', updateTargetInfo);
        });

        function updateTargetInfo() {
            document.querySelectorAll('.target-element').forEach(element => {
                const rect = element.getBoundingClientRect();
                const info = element.querySelector('[id$="-info"]');
                if (info) {
                    info.textContent = `${Math.round(rect.width)}Ã—${Math.round(rect.height)} at (${Math.round(rect.left)}, ${Math.round(rect.top)})`;
                }
            });
        }

        async function overlayWindowOnElement(element) {
            if (typeof WebXROpenXRBridge === 'undefined') {
                showStatus('WebXR OpenXR Bridge not available. Make sure the extension is installed.', 'error');
                return;
            }

            try {
                showStatus('Positioning OpenXR window...', 'info');

                // Clear previous overlay indicators
                document.querySelectorAll('.overlay-indicator').forEach(indicator => {
                    indicator.style.display = 'none';
                });

                // Get element position and size
                const rect = element.getBoundingClientRect();

                // Account for scroll position
                const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
                const scrollY = window.pageYOffset || document.documentElement.scrollTop;

                const windowRect = {
                    x: Math.round(rect.left + scrollX),
                    y: Math.round(rect.top + scrollY),
                    width: Math.round(rect.width),
                    height: Math.round(rect.height)
                };

                // Update input fields
                document.getElementById('posX').value = windowRect.x;
                document.getElementById('posY').value = windowRect.y;
                document.getElementById('width').value = windowRect.width;
                document.getElementById('height').value = windowRect.height;

                // Set the OpenXR window position
                await WebXROpenXRBridge.setWindowRect(windowRect);

                // Show overlay indicator
                element.querySelector('.overlay-indicator').style.display = 'block';
                currentOverlayTarget = element;

                showStatus(`OpenXR window overlaid on ${element.querySelector('h3').textContent}`, 'success');
                updateCurrentRectDisplay(windowRect);

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error overlaying window:', error);
            }
        }

        async function setCustomWindowRect() {
            if (typeof WebXROpenXRBridge === 'undefined') {
                showStatus('WebXR OpenXR Bridge not available. Make sure the extension is installed.', 'error');
                return;
            }

            try {
                const rect = {
                    x: parseInt(document.getElementById('posX').value),
                    y: parseInt(document.getElementById('posY').value),
                    width: parseInt(document.getElementById('width').value),
                    height: parseInt(document.getElementById('height').value)
                };

                showStatus('Setting custom window position...', 'info');
                await WebXROpenXRBridge.setWindowRect(rect);

                // Clear overlay indicators since this is a custom position
                document.querySelectorAll('.overlay-indicator').forEach(indicator => {
                    indicator.style.display = 'none';
                });
                currentOverlayTarget = null;

                showStatus(`Window positioned at (${rect.x}, ${rect.y}) with size ${rect.width}Ã—${rect.height}`, 'success');
                updateCurrentRectDisplay(rect);

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error setting window rect:', error);
            }
        }

        async function getCurrentWindowRect() {
            if (typeof WebXROpenXRBridge === 'undefined') {
                showStatus('WebXR OpenXR Bridge not available. Make sure the extension is installed.', 'error');
                return;
            }

            try {
                showStatus('Getting current window position...', 'info');
                const rect = await WebXROpenXRBridge.getWindowRect();

                // Update input fields
                document.getElementById('posX').value = Math.round(rect.x);
                document.getElementById('posY').value = Math.round(rect.y);
                document.getElementById('width').value = Math.round(rect.width);
                document.getElementById('height').value = Math.round(rect.height);

                showStatus('Current window position retrieved', 'success');
                updateCurrentRectDisplay(rect);

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error getting window rect:', error);
            }
        }

        async function centerWindow() {
            if (typeof WebXROpenXRBridge === 'undefined') {
                showStatus('WebXR OpenXR Bridge not available. Make sure the extension is installed.', 'error');
                return;
            }

            try {
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                const windowWidth = 800;
                const windowHeight = 600;

                const rect = {
                    x: Math.round((screenWidth - windowWidth) / 2),
                    y: Math.round((screenHeight - windowHeight) / 2),
                    width: windowWidth,
                    height: windowHeight
                };

                document.getElementById('posX').value = rect.x;
                document.getElementById('posY').value = rect.y;
                document.getElementById('width').value = rect.width;
                document.getElementById('height').value = rect.height;

                await setCustomWindowRect();

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error centering window:', error);
            }
        }

        async function resetToCorner() {
            if (typeof WebXROpenXRBridge === 'undefined') {
                showStatus('WebXR OpenXR Bridge not available. Make sure the extension is installed.', 'error');
                return;
            }

            try {
                const rect = {
                    x: 100,
                    y: 100,
                    width: 800,
                    height: 600
                };

                document.getElementById('posX').value = rect.x;
                document.getElementById('posY').value = rect.y;
                document.getElementById('width').value = rect.width;
                document.getElementById('height').value = rect.height;

                await setCustomWindowRect();

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error resetting window:', error);
            }
        }

        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';

            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        function updateCurrentRectDisplay(rect) {
            const currentRectElement = document.getElementById('currentRect');
            currentRectElement.innerHTML = `
                <strong>Current Window Position:</strong><br>
                Position: (${rect.x}, ${rect.y})<br>
                Size: ${rect.width} Ã— ${rect.height} pixels
            `;
            currentRectElement.style.display = 'block';
        }


    </script>
</body>

</html>