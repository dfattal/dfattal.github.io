<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Display Tuning (WebGL)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #1b1c20;
      color: #f0f0f0;
      overflow: hidden;
    }

    #container {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #glContainer {
      flex: 3;
      position: relative;
      background: #000;
    }

    #glcanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #viewportGrid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }

    .viewport-cell {
      border: 1px solid rgba(100, 100, 100, 0.4);
      box-sizing: border-box;
      position: relative;
    }

    .viewport-label {
      position: absolute;
      top: 4px;
      left: 6px;
      padding: 4px 6px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.9);
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 3px;
      text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      line-height: 1.3;
    }

    .viewer-name {
      font-weight: 600;
      font-size: 12px;
    }

    .viewer-pos {
      font-size: 10px;
      color: rgba(200, 200, 200, 0.7);
    }

    #controls {
      flex: 1;
      padding: 16px 18px;
      box-sizing: border-box;
      background: #20222a;
      border-left: 1px solid #333;
      overflow-y: auto;
    }

    h1 {
      font-size: 18px;
      margin: 0 0 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #versionToggle {
      font-size: 11px;
      padding: 4px 8px;
      background: #2a2c34;
      border: 1px solid #555;
      color: #f0f0f0;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #versionToggle:hover {
      background: #353742;
    }

    #versionToggle:active {
      background: #1f2028;
    }

    h2 {
      font-size: 14px;
      margin: 14px 0 6px 0;
      color: #ddd;
      border-bottom: 1px solid #333;
      padding-bottom: 2px;
    }

    .row {
      margin-bottom: 10px;
    }

    label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }

    input[type="range"] {
      width: 100%;
    }

    input[type="number"] {
      width: 60px;
      margin-left: 6px;
      background: #2a2c34;
      border: 1px solid #555;
      color: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .viewer-block {
      margin-bottom: 10px;
      padding: 6px 8px;
      border-radius: 4px;
      background: #262834;
      border: 1px solid #333;
    }

    .viewer-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #f5f5f5;
    }

    .small-value {
      font-size: 11px;
      color: #bbb;
      float: right;
    }

    .inline-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inline-row label {
      flex: 1;
      margin: 0;
    }

    .inline-row input[type="number"] {
      flex: 0 0 60px;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: #888;
      margin-top: 2px;
      padding: 0 2px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="glContainer">
      <canvas id="glcanvas"></canvas>
      <div id="viewportGrid"></div>
    </div>

    <div id="controls">
      <h1>
        <span>3D Display Tuning</span>
        <span id="fpsDisplay" style="font-size: 12px; color: #999; margin-left: auto; margin-right: 10px;">FPS: --</span>
        <button id="versionToggle">Switch to WebGPU</button>
      </h1>

      <div class="row inline-row">
        <label for="numViewers">Number of viewers</label>
        <input id="numViewers" type="number" min="1" max="4" value="2">
      </div>

      <h2>Viewer Weighting</h2>

      <div class="row">
        <label for="weightingPolicy">Weighting Policy</label>
        <select id="weightingPolicy" style="width: 100%; padding: 4px; background: #2a2c34; border: 1px solid #555; color: #f0f0f0; border-radius: 3px; font-size: 12px;">
          <option value="equal">Equal (all viewers weighted 1.0)</option>
          <option value="cascade">Priority Cascade (1000, 100, 10, 1)</option>
          <option value="proximity">Proximity-based (exponential falloff)</option>
        </select>
      </div>

      <h2>Image Source</h2>

      <div class="row">
        <label for="sbsImage" style="cursor: pointer; display: inline-block; padding: 6px 12px; background: #2a2c34; border: 1px solid #555; border-radius: 3px; font-size: 12px;">
          Load SBS Image
          <input id="sbsImage" type="file" accept="image/*" style="display: none;">
        </label>
        <button id="clearImage" style="margin-left: 10px; padding: 6px 12px; background: #2a2c34; border: 1px solid #555; color: #f0f0f0; border-radius: 3px; cursor: pointer; font-size: 12px;">Clear Image</button>
      </div>

      <div class="row" style="font-size: 11px; color: #999; margin-top: 4px;">
        <span id="imageStatus">Using test pattern (red/blue)</span>
      </div>

      <h2>Viewer Positions</h2>

      <div id="sceneVisualization" style="margin-bottom: 16px;">
        <canvas id="sceneCanvas"
                width="800"
                height="600"
                style="width: 100%;
                       background: #1a1b1f;
                       border: 1px solid #333;
                       border-radius: 4px;
                       cursor: default;
                       display: block;">
        </canvas>
      </div>

      <!-- Proximity parameters (hidden by default, shown below scene when proximity policy selected) -->
      <div id="proximityControls" style="display: none; margin-bottom: 16px;">
        <div class="row">
          <label for="proximityC">Proximity C (z-axis falloff)
            <span class="small-value" id="proximityCValue"></span>
          </label>
          <input id="proximityC" type="range" min="0" max="5" step="0.1" value="1.0">
        </div>

        <div class="row" style="font-size: 11px; color: #999; margin-top: 4px;">
          Weight = exp(-(x/1000)² - (y/1000)² - c*(z/1000)²)
        </div>
      </div>

      <h2>Global Parameters</h2>

      <div class="row">
        <label for="fov">Field of View (deg)
          <span class="small-value" id="fovValue"></span>
        </label>
        <input id="fov" type="range" min="10" max="90" value="40">
      </div>

      <div class="row">
        <label for="numViews">N – sub-views per pixel
          <span class="small-value" id="numViewsValue"></span>
        </label>
        <input id="numViews" type="range" min="8" max="128" value="64">
      </div>

      <div class="row">
        <label for="slant">Slant (SL)
          <span class="small-value" id="slantValue"></span>
        </label>
        <input id="slant" type="range" min="-0.5" max="0.5" step="0.01" value="0.333">
      </div>

      <h2>Screen Configuration</h2>

      <div class="row inline-row">
        <label for="screenDiagonal">Screen diagonal (inches)</label>
        <input id="screenDiagonal" type="number" min="20" max="200" step="1" value="65">
      </div>

      <div class="row inline-row">
        <label for="resolutionH">Horizontal resolution (px)</label>
        <input id="resolutionH" type="number" min="640" max="16384" step="1" value="1600">
      </div>

      <div class="row">
        <span style="font-size:11px;color:#999;">
          Screen: <span id="screenDimensions">1439 × 809 mm</span> |
          Resolution: <span id="resolutionDisplay">3840 × 2160 px</span>
        </span>
      </div>

      <div class="row">
        <span style="font-size:11px;color:#999;">
          Assumptions: IPD = 60&nbsp;mm, eyes along x axis, aspect ratio = 16:9.
        </span>
      </div>
    </div>
  </div>

  <script>
    // Version switcher logic
    const STORAGE_KEY = 'renderVersion';
    const STATE_KEY = 'appState';
    const currentVersion = localStorage.getItem(STORAGE_KEY) || 'webgl';
    const toggleButton = document.getElementById('versionToggle');

    // Update button text
    if (currentVersion === 'webgl') {
      toggleButton.textContent = 'Switch to WebGPU';
    } else {
      toggleButton.textContent = 'Switch to WebGL';
    }

    // Restore state if available (except numViewers which always defaults to 2)
    const savedState = localStorage.getItem(STATE_KEY);
    if (savedState) {
      try {
        const state = JSON.parse(savedState);
        // Restore input values (keeping numViewers at default 2)
        document.getElementById('fov').value = state.fov || 40;
        document.getElementById('numViews').value = state.numViews || 64;
        document.getElementById('slant').value = state.slant || 0.333;
        document.getElementById('screenDiagonal').value = state.screenDiagonal || 65;
        document.getElementById('resolutionH').value = state.resolutionH || 1600;

        // Restore weighting policy
        if (state.weightingPolicy) {
          document.getElementById('weightingPolicy').value = state.weightingPolicy;
          // Show/hide proximity controls based on policy
          document.getElementById('proximityControls').style.display =
            (state.weightingPolicy === 'proximity') ? 'block' : 'none';
        }

        // Restore proximity parameter
        if (state.proximityParams) {
          document.getElementById('proximityC').value = state.proximityParams.c || 1.0;
        }

        // Store saved image for app to restore
        if (state.sbsImageData) {
          window.savedSBSImage = state.sbsImageData;
          window.savedSBSImageName = state.sbsImageName;
        }
      } catch (e) {
        console.error('Failed to restore state:', e);
      }
    }

    // Load appropriate script
    const script = document.createElement('script');
    script.src = currentVersion === 'webgl' ? 'app.js' : 'app-webgpu.js';
    document.body.appendChild(script);

    // Handle toggle - save state before reload
    toggleButton.addEventListener('click', () => {
      // Save current state
      const state = {
        numViewers: document.getElementById('numViewers').value,
        fov: document.getElementById('fov').value,
        numViews: document.getElementById('numViews').value,
        slant: document.getElementById('slant').value,
        screenDiagonal: document.getElementById('screenDiagonal').value,
        resolutionH: document.getElementById('resolutionH').value,
        viewerPositions: window.currentViewerPositions || [],
        sbsImageData: window.currentSBSImage || null,
        sbsImageName: window.currentSBSImageName || null,
        weightingPolicy: document.getElementById('weightingPolicy').value,
        proximityParams: {
          c: document.getElementById('proximityC').value
        }
      };
      localStorage.setItem(STATE_KEY, JSON.stringify(state));

      const newVersion = currentVersion === 'webgl' ? 'webgpu' : 'webgl';
      localStorage.setItem(STORAGE_KEY, newVersion);
      location.reload();
    });
  </script>
</body>
</html>